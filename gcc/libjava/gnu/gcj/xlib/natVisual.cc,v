head	1.1;
branch	1.1.101;
access;
symbols
	MIRBSD_10_BASE:1.1.101.1
	MIRBSD_9_BASE:1.1.101.1
	gcc-3_4_6:1.1.101.1
	MIRBSD_8:1.1.101.1.0.2
	MIRBSD_8_BASE:1.1.101.1
	gcc-3_4-20051206:1.1.101.1
	gcc-3_4-20051115:1.1.101.1
	gcc-3_4-20050823:1.1.101.1
	FSF:1.1.101;
locks; strict;
comment	@// @;


1.1
date	2005.03.21.12.07.40;	author tg;	state Exp;
branches
	1.1.101.1;
next	;

1.1.101.1
date	2005.03.21.12.07.40;	author tg;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@/* Copyright (C) 2000  Free Software Foundation

   This file is part of libgcj.

This software is copyrighted work licensed under the terms of the
Libgcj License.  Please consult the file "LIBGCJ_LICENSE" for
details.  */

#include <X11/Xlib.h>
#include <X11/Xutil.h>

#include <gcj/cni.h>
#include <gnu/gcj/xlib/Visual.h>
#include <gnu/gcj/xlib/Screen.h>
#include <gnu/gcj/xlib/Display.h>
#include <gnu/gcj/xlib/XException.h>
#include <gnu/gcj/RawData.h>

using namespace gnu::gcj;

void gnu::gcj::xlib::Visual::init(RawData* visual, jint depth)
{
  XVisualInfo* info = new XVisualInfo;
  xVisualInfo = reinterpret_cast<gnu::gcj::RawData*>(info);
  infoMask = 0;
    
  if (visual != 0)
    {
      ::Visual* visualStructure = (::Visual*) visual;
      info->visual = visualStructure;
      info->visualid = XVisualIDFromVisual(visualStructure);
      infoMask |= MASK_ID | MASK_VISUAL_STRUCTURE;
    }

  if (depth  != 0)
    {
      info->depth = depth;
      infoMask |= MASK_DEPTH;
    }
}

void gnu::gcj::xlib::Visual::finalize()
{
  if (xVisualInfo != 0)
    {
      delete xVisualInfo;
      xVisualInfo = 0;
    }
}

RawData* gnu::gcj::xlib::Visual::getVisualStructure()
{
    ensureXVisualInfo(MASK_ALL); // Make sure structure is set
    XVisualInfo* info = (XVisualInfo*) xVisualInfo;
    return reinterpret_cast<gnu::gcj::RawData*>(info->visual);
}

jint gnu::gcj::xlib::Visual::getRedMask()
{
  ensureXVisualInfo(MASK_RED);
  XVisualInfo* info = (XVisualInfo*) xVisualInfo;
  return info->red_mask;
}

jint gnu::gcj::xlib::Visual::getGreenMask()
{
  ensureXVisualInfo(MASK_GREEN);
  XVisualInfo* info = (XVisualInfo*) xVisualInfo;
  return info->green_mask;
}

jint gnu::gcj::xlib::Visual::getBlueMask()
{
  ensureXVisualInfo(MASK_BLUE);
  XVisualInfo* info = (XVisualInfo*) xVisualInfo;
  return info->blue_mask;
}

jint gnu::gcj::xlib::Visual::getScreenNumber()
{
  if (screen != 0)
    return screen->getScreenNumber();

  ensureXVisualInfo(MASK_SCREEN);
  XVisualInfo* info = (XVisualInfo*) xVisualInfo;
  return info->screen;
}

jint gnu::gcj::xlib::Visual::getDepth()
{
  ensureXVisualInfo(MASK_DEPTH);
  
  XVisualInfo* info = (XVisualInfo*) xVisualInfo;
  return info->depth;
}

jint gnu::gcj::xlib::Visual::getVisualClass()
{
  ensureXVisualInfo(MASK_CLASS);
  ::XVisualInfo* info = (::XVisualInfo*) xVisualInfo;
  return info->c_class;
}

void gnu::gcj::xlib::Visual::ensureXVisualInfo(jint requiredMask)
{
  int missingInformation = ~infoMask;
  if ((missingInformation & requiredMask) == 0)
    return;
  
  // We need more info...

  XVisualInfo* info = (XVisualInfo*) xVisualInfo;

  // Store everything we know into template
  if (screen != 0)
    {
      info->screen = screen->getScreenNumber();
      infoMask |= MASK_SCREEN;
    }
  
  // Aquire info using the current info as template for matching
  ::Display* dpy = (::Display*) display->display;
  int visualInfoCount;

  long mask = infoMask & MASK_ALL & (~MASK_VISUAL_STRUCTURE);
  XVisualInfo* matches = XGetVisualInfo(dpy, mask,
					  info, &visualInfoCount);
  if (matches != 0)
    {
      (*info) = matches[0];

      // redundant?
      xVisualInfo = reinterpret_cast<gnu::gcj::RawData*>(info);

      infoMask = ~0; // ALL
      XFree(matches);
    } 
  else 
    {
      char msg[] = 
	"XGetVisualInfo failed to find any matching visuals. The template "
	"describes a combination of properties that does not exist on "
	"this X server.";
      throw new XException(JvNewStringLatin1(msg));
    }
}
@


1.1.101.1
log
@Import the GNU Compiler Collection 3.4-stable
from gcc-3.4-20050318.tar.bz2 after having
* all top-level non-directories (files)
  - except config.if
and these directories completely:
* INSTALL
* boehm-gc/Mac_files
* boehm-gc/cord
* boehm-gc/doc
* boehm-gc/tests
* contrib
  - except texi2pod.pl
* gcc/f
* gcc/po
* gcc/testsuite
* gcc/treelang
* include
* intl
* libf2c
* libffi/testsuite
* libiberty
* libjava/testsuite
* libstdc++-v3/docs
* libstdc++-v3/po
* libstdc++-v3/scripts
* libstdc++-v3/testsuite
* maintainer-scripts
* zlib
removed before importing.
@
text
@@
