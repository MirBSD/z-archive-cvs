head	1.16;
access;
symbols;
locks; strict;
comment	@# @;


1.16
date	2009.12.01.19.28.45;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004B156E6039BC875C;

1.15
date	2009.11.28.21.06.18;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004B1190D6324DB16A;

1.14
date	2009.05.24.20.20.26;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004A19AC1C7CF3000C;

1.13
date	2009.05.24.20.19.22;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004A19ABDE73192529;

1.12
date	2009.03.07.22.20.24;	author tg;	state Exp;
branches;
next	1.11;
commitid	10049B2F31D6582B1EC;

1.11
date	2008.07.03.16.56.26;	author tg;	state Exp;
branches;
next	1.10;
commitid	100486D04C7460B750E;

1.10
date	2008.07.02.19.31.45;	author tg;	state Exp;
branches;
next	1.9;
commitid	100486BD7B16F4BBC31;

1.9
date	2008.07.01.01.57.17;	author tg;	state Exp;
branches;
next	1.8;
commitid	10048698F067BC75DF7;

1.8
date	2008.06.30.22.40.04;	author tg;	state Exp;
branches;
next	1.7;
commitid	100486960A966A96932;

1.7
date	2008.06.30.22.36.41;	author tg;	state Exp;
branches;
next	1.6;
commitid	10048695FDC71845802;

1.6
date	2008.06.30.22.34.41;	author tg;	state Exp;
branches;
next	1.5;
commitid	10048695F9353977E12;

1.5
date	2008.06.30.22.19.49;	author tg;	state Exp;
branches;
next	1.4;
commitid	10048695C084DCB9673;

1.4
date	2008.06.30.22.17.23;	author tg;	state Exp;
branches;
next	1.3;
commitid	10048695B6A50C94E83;

1.3
date	2008.06.30.21.54.31;	author tg;	state Exp;
branches;
next	1.2;
commitid	100486956274F0291C4;

1.2
date	2008.06.30.21.28.44;	author tg;	state Exp;
branches;
next	1.1;
commitid	10048694FE2606FD5CF;

1.1
date	2008.06.26.13.01.20;	author tg;	state Exp;
branches;
next	;
commitid	1004863931F3CCD766F;


desc
@@


1.16
log
@use the vistable; add appropriate mksh version check
@
text
@#!/usr/bin/env mksh
# $MirOS: contrib/code/Snippets/mpcabber,v 1.15 2009/11/28 21:06:18 tg Exp $
#-
# Copyright (c) 2008, 2009
#	Thorsten Glaser <tg@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.
#-
# mpg123-0.59r-MirPorts-6 to mcabber-0.9.7 FIFO gateway
# mplayer and mppdec-static SV7 1.95e also work
# Requires mksh R34 or above
#
# User Tunes strings are courtesy of Jonathan Schleifer (my personal
# XEP to German gateway ☺)

# Configuration
integer usestate=1	# use Away Status
integer usetunes=1	# use User Tunes (XEP #0118)


x=0
if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)+([0-9])\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then
	set -A x -- ${KSH_VERSION#* R}
	(( x[0] < 39 )) && x=0
	(( x[0] == 39 )) && [[ ${x[1]} < "2009/12/01" ]] && x=0
fi
(( x )) || { echo mksh too old; exit 1; }

set -U
set -A vistable -- [0xEF7F]=-1 \
    0x20AC 0x278A 0x201A 0x0192 0x201E 0x2026 0x2020 0x2021 \
    0x02C6 0x2030 0x0160 0x2039 0x0152 0x278B 0x017D 0x278C \
    0x278D 0x2018 0x2019 0x201C 0x201D 0x2022 0x2013 0x2014 \
    0x02DC 0x2122 0x0161 0x203A 0x0153 0x278E 0x017E 0x0178 \
    0x00A0 0x00A1 0x00A2 0x00A3 0x00A4 0x00A5 0x00A6 0x00A7 \
    0x00A8 0x00A9 0x00AA 0x00AB 0x00AC 0x00AD 0x00AE 0x00AF \
    0x00B0 0x00B1 0x00B2 0x00B3 0x00B4 0x00B5 0x00B6 0x00B7 \
    0x00B8 0x00B9 0x00BA 0x00BB 0x00BC 0x00BD 0x00BE 0x00BF \
    0x00C0 0x00C1 0x00C2 0x00C3 0x00C4 0x00C5 0x00C6 0x00C7 \
    0x00C8 0x00C9 0x00CA 0x00CB 0x00CC 0x00CD 0x00CE 0x00CF \
    0x00D0 0x00D1 0x00D2 0x00D3 0x00D4 0x00D5 0x00D6 0x00D7 \
    0x00D8 0x00D9 0x00DA 0x00DB 0x00DC 0x00DD 0x00DE 0x00DF \
    0x00E0 0x00E1 0x00E2 0x00E3 0x00E4 0x00E5 0x00E6 0x00E7 \
    0x00E8 0x00E9 0x00EA 0x00EB 0x00EC 0x00ED 0x00EE 0x00EF \
    0x00F0 0x00F1 0x00F2 0x00F3 0x00F4 0x00F5 0x00F6 0x00F7 \
    0x00F8 0x00F9 0x00FA 0x00FB 0x00FC 0x00FD 0x00FE 0x00FF
typeset -i1 vistable
function toutf8 {
	local intext="$*" outtext=''
	typeset -i i=0 n=${#intext}
	typeset -i1 c
	typeset -Uui16 -Z5 x

	while (( i < n )); do
		c=1#${intext:(i++):1}
		if (( (c & 0xFF80) == 0xEF80 )); then
			outtext=${outtext}${vistable[c]#1#}
		elif (( c < 32 || c == 1#% )); then
			let x=c
			outtext=${outtext}%${x#16#}
		elif (( c > 0x7E && c < 0xA0 )); then
			outtext=${outtext}�
		else
			outtext=${outtext}${c#1#}
		fi
	done

	print -nr -- "$outtext"
}

function settitle {
	typeset title=$(toutf8 "$*")

	# Debugging
	#print -ru2 -- "setting title: $title"

	if [[ -n $title ]]; then
		titlemsg="♫ $title"
		titlexml="<title>$(sed \
		    -e "s/&/\&#38;/g" \
		    -e "s/</\&#60;/g" \
		    -e "s/>/\&#62;/g" \
		    -e "s/'/\&#39;/g" \
		    <<<"$title")</title>"
	else
		titlemsg=∅
		titlexml=
	fi

	# Is mcabber running and listening on the FIFO?
	[[ -p ~/.etc/mcabber/mcabber.fifo ]] || return

	# Away Status
	(( usestate )) && print -r -- "/status message $titlemsg" \
	    >~/.etc/mcabber/mcabber.fifo

	# Give the mcabber FIFO some rest, will ya?
	if (( usestate && usetunes )); then
		sleep 1
		# Is mcabber _still_ running and listening on the FIFO?
		[[ -p ~/.etc/mcabber/mcabber.fifo ]] || return
	fi

	# User Tunes
	(( usetunes )) && print -r -- '/rawxml send <iq type="set"><pubsub' \
	    'xmlns="http://jabber.org/protocol/pubsub"><publish' \
	    'node="http://jabber.org/protocol/tune"><item id="0"><tune' \
	    'xmlns="http://jabber.org/protocol/tune">'"${titlexml}</tune></item></publish></pubsub></iq>" \
	    >~/.etc/mcabber/mcabber.fifo
}


integer rv gotintr=0
curdir=

trap 'gotintr=1' INT

exec 3>&1
exec 0>&3
if [[ $1 = - ]]; then
	shift
	"$@@" <&3 |&
else
	"$@@" <&3 2>&1 |&
fi
subpid=$!

while :; do
	IFS= read -pr line
	rv=$?
	if (( gotintr )); then
		gotintr=0
		kill -INT $subpid
		continue
	fi
	(( rv )) && break
	print -r -- "$line"
	case $line {
	(@@(ICY metadata:)*)
		curdir=
		title=${line/*StreamTitle=\'}
		title=${title/@@(\';StreamUrl=)*}
		title=${title%%?(\');}
		;;
	(@@(Directory: http://)*)
		curdir=${line#Directory: }
		continue
		;;
	(@@(Playing MPEG stream from )*)
		title=$(sed -e 's/^Playing MPEG stream from \(.*\) ...$/\1/' \
		    <<<"$line")
		[[ $title = $line ]] && continue	# sanity
		[[ -n $curdir ]] && title=$curdir$title
		curdir=
		;;
	(@@(decoding of file )*)
		title=${line##decoding of file ?(\')}
		title=${title%\'}
		curdir=
		;;
	(@@(Playing )*.)
		title=${line#Playing }
		title=${title%.}
		curdir=
		;;
	(*)
		continue
		;;
	}
	title=${title##+([	 ])}
	title=${title##[Nn]?(ow )[Pp]?(laying):}
	title=${title##+([	 ])}
	title=${title%%+([	 ])}
	[[ $title = *://* ]] || title=${title%%.@@([Mm][Pp][234CcPp]|[Mm]4[Aa]|[Aa][Vv][Ii]|[Mm][Kk][Vv]|[Ff][Ll][Aa][Cc]|[Ff][Ll][Vv]|[Oo][Gg][Gg]|[Ww][Aa][Vv])}
	title=${title%%+([	 ])}
	[[ -n $title ]] || continue
	settitle "$title" &
done

settitle # empty
exit 0
@


1.15
log
@employ mksh’s automatic anyencoding-to-utf8 conversion
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.14 2009/05/24 20:20:26 tg Exp $
d34 8
d43 18
d70 2
a71 3
			(( c &= 0xFF ))
		fi
		if (( c < 32 || c == 1#% )); then
@


1.14
log
@add wav and ogg containers for good measure
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.13 2009/05/24 20:19:22 tg Exp $
d34 25
d60 1
a60 1
	typeset title=$1
@


1.13
log
@mplayer does .m4a too
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.12 2009/03/07 22:20:24 tg Exp $
d137 1
a137 1
	[[ $title = *://* ]] || title=${title%%.@@([Mm][Pp][234CcPp]|[Mm]4[Aa]|[Aa][Vv][Ii]|[Mm][Kk][Vv]|[Ff][Ll][Aa][Cc]|[Ff][Ll][Vv])}
@


1.12
log
@• mention that mppdec-static also works (for .mpc (Musepack) files)
• do not strip .mp3 file extensions on streams, only on files
• bump © year
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.11 2008/07/03 16:56:26 tg Exp $
d23 1
a23 1
# mppdec-static SV7 1.95e also works
d137 1
a137 1
	[[ $title = *://* ]] || title=${title%%.@@([Mm][Pp][234CcPp]|[Aa][Vv][Ii]|[Mm][Kk][Vv]|[Ff][Ll][Aa][Cc]|[Ff][Ll][Vv])}
@


1.11
log
@the FIFO may vanish between the two writes, cope
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.10 2008/07/02 19:31:45 tg Exp $
d4 1
a4 1
# Copyright (c) 2008
d23 1
d137 1
a137 1
	title=${title%%.@@([Mm][Pp][234CcPp]|[Aa][Vv][Ii]|[Mm][Kk][Vv]|[Ff][Ll][Aa][Cc]|[Ff][Ll][Vv])}
@


1.10
log
@s/continue/return/ oops refactoro
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.9 2008/07/01 01:57:17 tg Exp $
d60 5
a64 1
	(( usestate && usetunes )) && sleep 1
@


1.9
log
@meh, need to “create” fd#3 first, apparently… mc did this for me
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.8 2008/06/30 22:40:04 tg Exp $
d53 1
a53 1
	[[ -p ~/.etc/mcabber/mcabber.fifo ]] || continue
@


1.8
log
@even better: no option processing, no -p, no default player, just prepend
mpcabber to the name of your player; a single dash (‘-’) is now used if a
player whose standard error contains interactive stuff is employed
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.5 2008/06/30 22:19:49 tg Exp $
d76 1
@


1.7
log
@run the settitle function asynchronously, as it sometimes implies a one-
second delay (between setting the away status and the user tunes), which
delays forwarding the co-process’ output to the terminal
@
text
@a32 7
function usage {
	print -u2 "usage: mpcabber [-[Pp] player] file ..."
	print -u2 "\tdefault player is mpg123"
	print -u2 "\tif -P is used, stderr is passed as-is"
	exit 1
}

a73 15
# command line processing
integer redir2=1
player=mpg123

if [[ $1 = -h ]]; then
	usage
elif [[ $1 = -[Pp] ]]; then
	[[ $1 = -P ]] && redir2=0
	[[ $# -gt 1 ]] || usage
	player=$2
	shift
	shift
fi


d77 3
a79 2
if (( redir2 )); then
	"$player" "$@@" <&3 2>&1 |&
d81 1
a81 1
	"$player" "$@@" <&3 |&
@


1.6
log
@refactor code
@
text
@d155 1
a155 1
	settitle "$title"
@


1.5
log
@go away from using getopts: “mpcabber -P mplayer -quiet %f” won’t work
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.3 2008/06/30 21:54:31 tg Exp $
d40 38
d155 1
a155 20

	# Debugging
	#print -ru2 -- "setting title: $title"

	# Is mcabber running and listening on the FIFO?
	[[ -p ~/.etc/mcabber/mcabber.fifo ]] || continue

	# Away Status
	(( usestate )) && print -r -- "/status message ♫ $title" >~/.etc/mcabber/mcabber.fifo

	# Give the mcabber FIFO some rest, will ya?
	(( usestate && usetunes )) && sleep 1

	# User Tunes
	(( usetunes )) && print -r -- '/rawxml send <iq type="set"><pubsub xmlns="http://jabber.org/protocol/pubsub"><publish node="http://jabber.org/protocol/tune"><item id="0"><tune xmlns="http://jabber.org/protocol/tune"><title>'"$(sed \
	    -e "s/&/\&#38;/g" \
	    -e "s/</\&#60;/g" \
	    -e "s/>/\&#62;/g" \
	    -e "s/'/\&#39;/g" \
	    <<<"$title")"'</title></tune></item></publish></pubsub></iq>' >~/.etc/mcabber/mcabber.fifo
d158 1
a158 9
if [[ -p ~/.etc/mcabber/mcabber.fifo ]]; then
	# Away Status
	(( usestate )) && print '/status message ∅' >~/.etc/mcabber/mcabber.fifo
	# Give the mcabber FIFO some rest
	(( usestate && usetunes )) && sleep 1
	# User Tunes
	(( usetunes )) && print '/rawxml send <iq type="set"><pubsub xmlns="http://jabber.org/protocol/pubsub"><publish node="http://jabber.org/protocol/tune"><item id="0"><tune xmlns="http://jabber.org/protocol/tune" /></item></publish></pubsub></iq>' >~/.etc/mcabber/mcabber.fifo
fi

@


1.4
log
@new option -P for retaining stderr, e.g. for mplayer
… if mplayer were to put its status line to stdout, which they don’t…
@
text
@d47 9
a55 9
while getopts "hP:p:" ch; do
	case $ch {
	(P)	redir2=0
		player=$OPTARG ;;
	(p)	player=$OPTARG ;;
	(*)	usage ;;
	}
done
shift $((OPTIND - 1))
@


1.3
log
@retain standard input (e.g. for mplayer)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.2 2008/06/30 21:28:44 tg Exp $
d33 7
d42 15
a56 5
if [[ $1 = -p ]]; then
	shift
	player=$1
	shift
fi
d61 5
a65 1
${player:-mpg123} "$@@" <&3 2>&1 |&
@


1.2
log
@• new option -p following player name
• support mppdec-static (Musepack) and mplayer output formats
• strip .mp4 .mpc/mpp (Musepack) .avi .mkv .flac .flv (XXX more) extensions
@
text
@d2 1
a2 1
# $MirOS: contrib/code/Snippets/mpcabber,v 1.1 2008/06/26 13:01:20 tg Exp $
d43 2
a44 1
${player:-mpg123} "$@@" 2>&1 |&
@


1.1
log
@add mpg123 wrapper which, Adium-like, injects tunes info into Jabber
XXX do similar things with centericq?
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
d35 5
d43 1
a43 1
mpg123 "$@@" 2>&1 |&
d74 10
d92 1
a92 1
	title=${title%%.[Mm][Pp][23]}
@

