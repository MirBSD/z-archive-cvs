head	1.6;
access;
symbols;
locks; strict;
comment	@ * @;


1.6
date	2013.10.31.20.05.41;	author tg;	state Exp;
branches;
next	1.5;
commitid	1005272B7081B0E5655;

1.5
date	2011.11.20.04.57.08;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004EC8880406A80564;

1.4
date	2008.08.08.12.34.21;	author tg;	state Exp;
branches;
next	1.3;
commitid	100489C3D5B1454A111;

1.3
date	2008.05.03.01.09.24;	author tg;	state Exp;
branches;
next	1.2;
commitid	100481BBB3B66CD6DBA;

1.2
date	2008.04.05.21.53.57;	author tg;	state Exp;
branches;
next	1.1;
commitid	10047F7F4F0613A5C38;

1.1
date	2008.04.05.21.26.17;	author tg;	state Exp;
branches;
next	;
commitid	10047F7EE6E0E8D01ED;


desc
@@


1.6
log
@adapt most __attribute__((…)) occurrences to new KNF style(9)
@
text
@#if 0 /* this line is a comment in mirmake */
# @@mgcc: ignore from here
#-
# Copyright © 2008, 2011, 2013
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un‐
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.
#-
# libposixtz.so: LD_PRELOAD shared object for POSIX time zone compatibility
#-
# This is actually both a .c source file and a Makefile.
# You can build the “libposixtz.so” file by issuing:
# $ make -f posixtz.c
# Pretty cool idea of mine, eh?

.include <bsd.own.mk>

LIB=		posixtz
SRCS=		posixtz.c

CPPFLAGS+=	-I${BSDSRCDIR}/lib/libc/include
CPPFLAGS+=	-I${BSDSRCDIR}/lib/libc/time

_LIBS_STATIC=	no
SHLIB_VERSION=	-
SHLIB_SONAME=	libposixtz.so
CLEANFILES+=	libposixtz.so

.include <bsd.lib.mk>

# @@mirmake: ignore from here
.if "0" == "1"
# @@mgcc: end ignore
#endif /* this line is a comment in mirmake */

#include <sys/param.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include <time.h>

#ifndef SYSKERN_MIRTIME_H
/* MirOS #10 API */
#include <sys/taitime.h>
#endif

__RCSID("$MirOS: contrib/code/Snippets/posixtz.c,v 1.5 2011/11/20 04:57:08 tg Exp $");

#ifndef SYSKERN_MIRTIME_H
/* import libc private interface – XXX subject to change without notice! */
extern tai64_t _leaps[];
extern bool _leaps_initialised;

void switch_to_posix(void) __attribute__((__constructor__));

void
switch_to_posix(void)
{
	_leaps[0] = 0;
	_leaps_initialised = true;
}
#endif

#undef SKIP_LEAPSECS
#undef SKIPPED_LEAPSECS
#define SKIP_LEAPSECS 1
#include "localtime.c"
#ifndef SKIPPED_LEAPSECS
# error your ${BSDSRCDIR}/lib/libc/time/localtime.c is too old
#endif

#if 0
# @@mirmake: end ignore
.endif
#endif

# /* EOF for mirmake and mgcc */
@


1.5
log
@first steps toward a new time API
• no DJB code (actual code) any more, only reimplementation of algorithms
  whose code is placed in USA PD
• no struct returns any more
• skip the extra tai_t step
• no _t suffix for types I define
• try to be a bit more elegant – I learned a lot since then, after all

the old ABI is still provided until we bump libc major
‣ the new API might wander off libc into libmbfun then, _too_

goal is functional equivalence (after all, it’s been proven correct)
@
text
@d4 1
a4 3
# $MirOS: src/share/misc/licence.template,v 1.28 2008/11/14 15:33:44 tg Rel $
#-
# Copyright © 2008, 2011
d60 1
a60 1
__RCSID("$MirOS: contrib/code/Snippets/posixtz.c,v 1.4 2008/08/08 12:34:21 tg Exp $");
d67 1
a67 1
void switch_to_posix(void) __attribute__((constructor));
@


1.4
log
@also here, set SHLIB_VERSION
@
text
@d4 1
a4 1
# $MirOS: contrib/code/Snippets/posixtz.c,v 1.3 2008/05/03 01:09:24 tg Exp $
d6 2
a7 2
# Copyright (c) 2008
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.de>
d11 1
a11 1
# is granted to deal in this work without restriction, including un-
a51 1
#include <sys/taitime.h>
d57 4
a60 1
__RCSID("$MirOS: contrib/code/Snippets/posixtz.c,v 1.3 2008/05/03 01:09:24 tg Exp $");
d62 3
d77 1
@


1.3
log
@remove advertising clause for all of contrib/ except
‣ heartbeat server/client, for now
‣ stuff in jupp that’ll be regenerated before next release anyway
@
text
@d4 1
a4 1
# $MirOS: contrib/code/Snippets/posixtz.c,v 1.2 2008/04/05 21:53:57 tg Exp $
d40 1
d58 1
a58 1
__RCSID("$MirOS: contrib/code/Snippets/posixtz.c,v 1.2 2008/04/05 21:53:57 tg Exp $");
@


1.2
log
@add a version check (if the two files actually can do it together)
@
text
@d4 1
a4 1
# $MirOS: contrib/code/Snippets/posixtz.c,v 1.1 2008/04/05 21:26:17 tg Exp $
a14 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
d57 1
a57 1
__RCSID("$MirOS: contrib/code/Snippets/posixtz.c,v 1.1 2008/04/05 21:26:17 tg Exp $");
@


1.1
log
@sometimes, 23 second offsets in regression tests annoy me
provide a way around it (POSIX sucks and is illegal in Germany,
so this is not the default, nor is there a way to enable it by default)
@
text
@d4 1
a4 1
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d61 1
a61 1
__RCSID("$MirOS$");
d77 1
d80 3
@

