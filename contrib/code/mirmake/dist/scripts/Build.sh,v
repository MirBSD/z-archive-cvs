head	1.139;
access;
symbols
	tg-mirmake-dev_BASE:1.86
	tg-mirmake-dev:1.85.0.2
	mirbsd:1.1.7;
locks; strict;
comment	@# @;


1.139
date	2014.12.20.22.32.59;	author tg;	state Exp;
branches;
next	1.138;
commitid	1005495F92C5497A12B;

1.138
date	2013.10.31.20.05.45;	author tg;	state Exp;
branches;
next	1.137;
commitid	1005272B7081B0E5655;

1.137
date	2011.01.24.21.26.19;	author tg;	state Exp;
branches;
next	1.136;
commitid	1004D3DEE92351DB51C;

1.136
date	2010.06.05.22.27.17;	author tg;	state Exp;
branches;
next	1.135;
commitid	1004C0ACF1E03D87B98;

1.135
date	2010.01.10.13.34.07;	author tg;	state Exp;
branches;
next	1.134;
commitid	1004B49D765124387D1;

1.134
date	2009.11.28.20.07.15;	author tg;	state Exp;
branches;
next	1.133;
commitid	1004B1182F9705E22AF;

1.133
date	2009.11.17.19.10.29;	author tg;	state Exp;
branches;
next	1.132;
commitid	1004B02F5110E928B38;

1.132
date	2009.11.09.22.40.59;	author tg;	state Exp;
branches;
next	1.131;
commitid	1004AF89A832AF9327C;

1.131
date	2009.11.09.21.36.36;	author tg;	state Exp;
branches;
next	1.130;
commitid	1004AF88B6210E6BBB3;

1.130
date	2009.11.09.17.59.22;	author tg;	state Exp;
branches;
next	1.129;
commitid	1004AF8587043AB5C67;

1.129
date	2009.05.20.10.23.16;	author tg;	state Exp;
branches;
next	1.128;
commitid	1004A13DA264808A599;

1.128
date	2009.03.29.13.04.12;	author tg;	state Exp;
branches;
next	1.127;
commitid	10049CF71B654F9EF54;

1.127
date	2008.12.29.20.15.14;	author tg;	state Exp;
branches;
next	1.126;
commitid	10049592FDA06C9CAD8;

1.126
date	2008.10.13.20.20.21;	author tg;	state Exp;
branches;
next	1.125;
commitid	10048F3AD976B3F18FA;

1.125
date	2008.10.13.20.14.22;	author tg;	state Exp;
branches;
next	1.124;
commitid	10048F3AC3073C98924;

1.124
date	2008.10.12.18.45.21;	author tg;	state Exp;
branches;
next	1.123;
commitid	10048F245C87AC92012;

1.123
date	2008.10.12.18.10.15;	author tg;	state Exp;
branches;
next	1.122;
commitid	10048F23D9E765DB2FA;

1.122
date	2008.10.12.18.04.28;	author tg;	state Exp;
branches;
next	1.121;
commitid	10048F23C3813584639;

1.121
date	2008.10.12.17.56.25;	author tg;	state Exp;
branches;
next	1.120;
commitid	10048F23A5D008A2D9A;

1.120
date	2008.10.05.16.32.50;	author tg;	state Exp;
branches;
next	1.119;
commitid	10048E8EC3E31621378;

1.119
date	2008.07.11.11.34.27;	author tg;	state Exp;
branches;
next	1.118;
commitid	100487745536D7BF2C3;

1.118
date	2008.05.07.13.34.38;	author tg;	state Exp;
branches;
next	1.117;
commitid	1004821AFFA1190D23D;

1.117
date	2008.05.03.01.09.29;	author tg;	state Exp;
branches;
next	1.116;
commitid	100481BBB3B66CD6DBA;

1.116
date	2008.04.07.00.01.00;	author tg;	state Exp;
branches;
next	1.115;
commitid	10047F9644A24A3D662;

1.115
date	2008.04.06.23.20.21;	author tg;	state Exp;
branches;
next	1.114;
commitid	10047F95AC71DA674A9;

1.114
date	2008.04.06.23.09.43;	author tg;	state Exp;
branches;
next	1.113;
commitid	10047F958455B782800;

1.113
date	2008.04.06.22.42.55;	author tg;	state Exp;
branches;
next	1.112;
commitid	10047F951F63D3ABAF6;

1.112
date	2008.04.06.22.41.52;	author tg;	state Exp;
branches;
next	1.111;
commitid	10047F951B7748A8EBA;

1.111
date	2008.04.06.22.40.22;	author tg;	state Exp;
branches;
next	1.110;
commitid	10047F9516350F3210A;

1.110
date	2008.04.06.22.25.16;	author tg;	state Exp;
branches;
next	1.109;
commitid	10047F94DE00FF3A3D4;

1.109
date	2008.04.06.22.00.14;	author tg;	state Exp;
branches;
next	1.108;
commitid	10047F947FD77F16E47;

1.108
date	2008.03.27.17.42.43;	author tg;	state Exp;
branches;
next	1.107;
commitid	10047EBDC9C02851476;

1.107
date	2008.03.14.14.51.41;	author tg;	state Exp;
branches;
next	1.106;
commitid	10047DA91115FB74F0D;

1.106
date	2008.03.14.14.37.38;	author tg;	state Exp;
branches;
next	1.105;
commitid	10047DA8DC156ED2241;

1.105
date	2008.03.14.14.28.19;	author tg;	state Exp;
branches;
next	1.104;
commitid	10047DA8B8177CFB7DA;

1.104
date	2008.03.09.16.38.28;	author tg;	state Exp;
branches;
next	1.103;
commitid	10047D4129B48ECB1C4;

1.103
date	2008.03.09.16.32.04;	author tg;	state Exp;
branches;
next	1.102;
commitid	10047D411183484A270;

1.102
date	2008.03.09.16.20.35;	author tg;	state Exp;
branches;
next	1.101;
commitid	10047D40E6335523EE8;

1.101
date	2008.03.09.16.19.49;	author tg;	state Exp;
branches;
next	1.100;
commitid	10047D40E2B529F06C5;

1.100
date	2008.03.09.14.16.07;	author tg;	state Exp;
branches;
next	1.99;
commitid	10047D3F13463609C08;

1.99
date	2008.03.09.13.55.47;	author tg;	state Exp;
branches;
next	1.98;
commitid	10047D3EC5502FAF957;

1.98
date	2008.03.09.13.42.52;	author tg;	state Exp;
branches;
next	1.97;
commitid	10047D3E95307755B9E;

1.97
date	2008.02.24.12.37.11;	author tg;	state Exp;
branches;
next	1.96;
commitid	10047C164E62DF1061A;

1.96
date	2008.02.22.21.38.37;	author tg;	state Exp;
branches;
next	1.95;
commitid	10047BF40F344D13ED4;

1.95
date	2008.02.17.15.42.16;	author bsiegert;	state Exp;
branches;
next	1.94;
commitid	10047B855F000009936;

1.94
date	2007.10.25.16.01.21;	author tg;	state Exp;
branches;
next	1.93;
commitid	1004720BDDA6285B35A;

1.93
date	2007.06.19.19.21.20;	author tg;	state Exp;
branches;
next	1.92;
commitid	10046782CBF3111CBD4;

1.92
date	2006.12.28.17.32.52;	author tg;	state Exp;
branches;
next	1.91;
commitid	1004593FFC84B90031B;

1.91
date	2006.11.07.00.38.17;	author tg;	state Exp;
branches;
next	1.90;
commitid	100454FD58763CF2147;

1.90
date	2006.11.07.00.18.57;	author tg;	state Exp;
branches;
next	1.89;
commitid	100454FD0B67736DD24;

1.89
date	2006.10.28.19.52.50;	author tg;	state Exp;
branches;
next	1.88;
commitid	1004543B4F81120B887;

1.88
date	2006.10.13.16.41.47;	author tg;	state Exp;
branches;
next	1.87;
commitid	100452FC1E1409E7210;

1.87
date	2006.10.13.16.39.52;	author tg;	state Exp;
branches;
next	1.86;
commitid	100452FC168589F78ED;

1.86
date	2006.10.13.12.44.42;	author tg;	state Exp;
branches;
next	1.85;
commitid	100452F8A391A35EBD2;

1.85
date	2006.08.27.01.06.10;	author tg;	state Exp;
branches;
next	1.84;
commitid	10044F0EFD96E3327F9;

1.84
date	2006.08.27.00.53.32;	author tg;	state Exp;
branches;
next	1.83;
commitid	10044F0ED1E69DC1871;

1.83
date	2006.08.27.00.49.09;	author tg;	state Exp;
branches;
next	1.82;
commitid	10044F0EC1752495239;

1.82
date	2006.08.27.00.39.32;	author tg;	state Exp;
branches;
next	1.81;
commitid	10044F0E9D87A847F54;

1.81
date	2006.08.27.00.32.46;	author tg;	state Exp;
branches;
next	1.80;
commitid	10044F0E83676B1C0DA;

1.80
date	2006.08.26.23.31.24;	author tg;	state Exp;
branches;
next	1.79;
commitid	10044F0D9D373A097BF;

1.79
date	2006.08.26.23.10.37;	author tg;	state Exp;
branches;
next	1.78;
commitid	10044F0D4FF10EDBDDE;

1.78
date	2006.08.26.22.57.01;	author tg;	state Exp;
branches;
next	1.77;
commitid	10044F0D1CF322F0967;

1.77
date	2006.08.26.22.50.50;	author tg;	state Exp;
branches;
next	1.76;
commitid	10044F0D05C43C91F8F;

1.76
date	2006.08.26.22.46.43;	author tg;	state Exp;
branches;
next	1.75;
commitid	10044F0CF6A4E28F290;

1.75
date	2006.08.26.19.35.06;	author tg;	state Exp;
branches;
next	1.74;
commitid	10044F0A2711ED9F71A;

1.74
date	2006.08.26.16.45.27;	author tg;	state Exp;
branches;
next	1.73;
commitid	10044F07A98434B547D;

1.73
date	2006.08.26.15.47.46;	author tg;	state Exp;
branches;
next	1.72;
commitid	10044F06D2C632D9EF0;

1.72
date	2006.08.26.15.40.13;	author tg;	state Exp;
branches;
next	1.71;
commitid	10044F06B6749F109F1;

1.71
date	2005.12.20.18.54.13;	author tg;	state Exp;
branches;
next	1.70;
commitid	10043A853626076DB0E;

1.70
date	2005.12.17.05.46.09;	author tg;	state Exp;
branches;
next	1.69;
commitid	10043A3A3E65E20A413;

1.69
date	2005.11.24.20.18.20;	author tg;	state Exp;
branches;
next	1.68;
commitid	1e7c4386201a1ab8;

1.68
date	2005.11.24.20.17.04;	author tg;	state Exp;
branches;
next	1.67;
commitid	168543861fd3cf0f;

1.67
date	2005.11.24.20.13.50;	author tg;	state Exp;
branches;
next	1.66;
commitid	3a3e43861f060f94;

1.66
date	2005.11.24.19.28.12;	author tg;	state Exp;
branches;
next	1.65;
commitid	491b4386144e547e;

1.65
date	2005.11.24.14.13.28;	author tg;	state Exp;
branches;
next	1.64;
commitid	62704385ca9838b1;

1.64
date	2005.11.24.14.08.41;	author tg;	state Exp;
branches;
next	1.63;
commitid	4a784385c97df95a;

1.63
date	2005.11.24.14.06.24;	author tg;	state Exp;
branches;
next	1.62;
commitid	72404385c8f3e46f;

1.62
date	2005.11.24.14.03.18;	author tg;	state Exp;
branches;
next	1.61;
commitid	2fc04385c8374a8b;

1.61
date	2005.11.24.14.01.26;	author tg;	state Exp;
branches;
next	1.60;
commitid	3b804385c7c93124;

1.60
date	2005.11.24.13.56.51;	author tg;	state Exp;
branches;
next	1.59;
commitid	37554385c6aceded;

1.59
date	2005.11.24.13.40.07;	author tg;	state Exp;
branches;
next	1.58;
commitid	33a14385c2c69cba;

1.58
date	2005.11.24.13.32.53;	author tg;	state Exp;
branches;
next	1.57;
commitid	9214385c115b7f8;

1.57
date	2005.11.24.12.08.56;	author tg;	state Exp;
branches;
next	1.56;
commitid	84c4385ad62a3c1;

1.56
date	2005.11.24.11.41.33;	author tg;	state Exp;
branches;
next	1.55;
commitid	210c4385a6fda971;

1.55
date	2005.11.24.11.36.27;	author tg;	state Exp;
branches;
next	1.54;
commitid	714a4385a5b30f90;

1.54
date	2005.11.24.11.06.46;	author tg;	state Exp;
branches;
next	1.53;
commitid	46d443859ec9ddf2;

1.53
date	2005.09.19.18.52.24;	author tg;	state Exp;
branches;
next	1.52;
commitid	6fb432f08e8c1ec;

1.52
date	2005.09.19.18.50.21;	author tg;	state Exp;
branches;
next	1.51;
commitid	7176432f087dc8cf;

1.51
date	2005.09.19.18.44.45;	author tg;	state Exp;
branches;
next	1.50;
commitid	1874432f071d834a;

1.50
date	2005.09.18.21.10.29;	author tg;	state Exp;
branches;
next	1.49;
commitid	1c8a432dd7d44f3f;

1.49
date	2005.09.18.20.19.13;	author tg;	state Exp;
branches;
next	1.48;
commitid	6b6432dcbcbe367;

1.48
date	2005.09.12.22.24.58;	author tg;	state Exp;
branches;
next	1.47;
commitid	42a743260045a8d0;

1.47
date	2005.09.01.22.27.33;	author tg;	state Exp;
branches;
next	1.46;
commitid	328243178058062c;

1.46
date	2005.08.21.12.15.22;	author tg;	state Exp;
branches;
next	1.45;
commitid	6bde430870682464;

1.45
date	2005.08.21.11.56.04;	author tg;	state Exp;
branches;
next	1.44;
commitid	6d4f43086bd9e545;

1.44
date	2005.08.21.11.28.07;	author tg;	state Exp;
branches;
next	1.43;
commitid	6af643086553c055;

1.43
date	2005.06.09.22.14.32;	author tg;	state Exp;
branches;
next	1.42;
commitid	21f742a8bf59d1c2;

1.42
date	2005.06.09.22.07.31;	author tg;	state Exp;
branches;
next	1.41;
commitid	29e142a8bdb28bf1;

1.41
date	2005.06.09.21.57.46;	author tg;	state Exp;
branches;
next	1.40;
commitid	6e3942a8bb6aa9de;

1.40
date	2005.06.09.21.51.15;	author tg;	state Exp;
branches;
next	1.39;
commitid	6a8e42a8b9e5ac6f;

1.39
date	2005.06.09.21.50.36;	author tg;	state Exp;
branches;
next	1.38;
commitid	2d2942a8b998eccd;

1.38
date	2005.06.09.21.45.14;	author tg;	state Exp;
branches;
next	1.37;
commitid	782842a8b86fa06c;

1.37
date	2005.06.08.10.03.24;	author tg;	state Exp;
branches;
next	1.36;
commitid	513b42a6c2301292;

1.36
date	2005.06.02.23.35.08;	author tg;	state Exp;
branches;
next	1.35;
commitid	499a429f97bad456;

1.35
date	2005.06.02.23.30.51;	author tg;	state Exp;
branches;
next	1.34;
commitid	3b0b429f96b5ed27;

1.34
date	2005.06.02.23.13.45;	author tg;	state Exp;
branches;
next	1.33;
commitid	3453429f92bc70ee;

1.33
date	2005.06.02.23.11.27;	author tg;	state Exp;
branches;
next	1.32;
commitid	616a429f92313881;

1.32
date	2005.06.02.23.08.03;	author tg;	state Exp;
branches;
next	1.31;
commitid	2da2429f91672c5c;

1.31
date	2005.06.02.23.05.03;	author tg;	state Exp;
branches;
next	1.30;
commitid	1998429f90a4f1ed;

1.30
date	2005.06.02.22.58.18;	author tg;	state Exp;
branches;
next	1.29;
commitid	7b16429f8f0a160a;

1.29
date	2005.05.25.23.50.31;	author tg;	state Exp;
branches;
next	1.28;
commitid	715c42950f4ccef2;

1.28
date	2005.05.21.17.03.52;	author tg;	state Exp;
branches;
next	1.27;
commitid	4755428f69a27ba8;

1.27
date	2005.05.21.15.46.39;	author tg;	state Exp;
branches;
next	1.26;
commitid	7972428f57f04577;

1.26
date	2005.05.21.15.38.52;	author tg;	state Exp;
branches;
next	1.25;
commitid	38ce428f5605ec09;

1.25
date	2005.05.21.15.24.00;	author tg;	state Exp;
branches;
next	1.24;
commitid	b4f428f529ec845;

1.24
date	2005.05.21.15.03.01;	author tg;	state Exp;
branches;
next	1.23;
commitid	3620428f4da24d0b;

1.23
date	2005.05.21.14.56.47;	author tg;	state Exp;
branches;
next	1.22;
commitid	6d1d428f4c14e450;

1.22
date	2005.05.20.23.18.34;	author tg;	state Exp;
branches;
next	1.21;
commitid	2c1e428e704d6564;

1.21
date	2005.05.20.22.50.41;	author tg;	state Exp;
branches;
next	1.20;
commitid	152d428e69d0f634;

1.20
date	2005.04.13.19.08.13;	author tg;	state Exp;
branches;
next	1.19;

1.19
date	2005.04.12.20.31.51;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2005.04.12.19.10.37;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2005.04.12.17.11.56;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2005.04.12.10.56.17;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2005.04.12.10.29.12;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2005.04.12.10.18.44;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2005.04.12.10.17.51;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2005.04.12.10.15.29;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2005.04.11.15.44.49;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2005.02.28.21.56.30;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2005.02.28.21.52.31;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2005.02.28.21.46.22;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2005.02.28.21.43.15;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2005.02.26.14.04.59;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2005.02.26.13.53.24;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2005.02.26.13.38.25;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.02.23.21.40.55;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.02.23.21.35.09;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.02.36.15;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.1.7.1
date	2005.02.05.02.36.15;	author tg;	state Exp;
branches;
next	;


desc
@@


1.139
log
@adjust for miscdata.c move
@
text
@# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.138 2013/10/31 20:05:45 tg Exp $
#-
# Copyright (c) 2006, 2008, 2011, 2013
#	Thorsten Glaser <tg@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.


# Functions

# Call: testfunc 'proto' 'call' 'opt_include' 'opt_decl;'
# Return: 1 if found, 0 otherwise (inverse logic)
function testfunc {
	rv=0
	mkdir $d_build/testfunc
	cat >$d_build/testfunc/Makefile <<-'EOF'
		PROG=	testfunc
		.include <bsd.prog.mk>
	EOF
	cat >$d_build/testfunc/testfunc.c <<-EOF
		#include <sys/param.h>
		$3
		$1;
		int main(int argc, char *argv[]) {
			$4
			$2;
			return 0;
		}
	EOF
	( cd $d_build/testfunc && ${d_build}/bmake -m ${d_build}/mk \
	    NOMAN=yes NOOBJ=yes ) 2>&1 | sed 's!^![ !'
	[[ -x $d_build/testfunc/testfunc ]] && rv=1
	rm -rf $d_build/testfunc
	return $rv
}

# Get parameters
new_ostype=$1
new_prefix=$2		# /usr/local
new_manpth=$3		# man/cat
new_exenam=$4		# bmake
new_machin=$5		# MACHINE
new_macarc=$6		# MACHINE_ARCH
new_machos=$7		# MACHINE_OS
new_mirksh=$8
new_binids=$9

if [ -z "$new_mirksh" ]; then
	echo "Use ../../Build.sh instead!" >&2
	exit 255
fi

export SHELL=$new_mirksh
unset MAKE

[[ -n $BASH_VERSION ]] && shopt -s extglob

# Directories
top=$(cd $(dirname $0)/../..; pwd)
d_script=$top/dist/scripts
d_src=$top/dist/src
d_build=$top/build
dt_bin=$new_prefix/bin
dt_man=$new_prefix/${new_manpth}1
dt_mk=$new_prefix/share/${new_exenam}

if [[ $new_manpth = *@@(cat)* ]]; then
	is_catman=1
else
	is_catman=0
fi

case "$new_machos:$new_machin:$new_macarc" in
Darwin:*:powerpc)
	;;
Darwin:*:i686)
	new_machin=i686
	new_macarc=i386
	;;
Darwin:*:[Xx]86[-_]64 | Darwin:*:[Aa][Mm][Dd]64)
	new_machin=amd64
	new_macarc=amd64
	;;
Darwin:*:*)
	new_macarc=$(uname -p)
	[[ $new_macarc = *86 ]] && new_machin=i686
	[[ $new_macarc = *86 ]] && new_macarc=i386
	;;
Interix:*:*)
	[[ -z $new_binids ]] && new_binids=-
	[[ $new_macarc = i[3456789x]86 ]] && new_macarc=i386
	/usr/bin/install -c -m 555 $d_script/../contrib/mktemp.sh \
	    /usr/bin/mktemp
	;;
*:*:[Ii][3456789Xx]86)
	new_macarc=i386
	;;
*:*:[Xx]86[-_]64 | *:*:[Aa][Mm][Dd]64)
	new_macarc=amd64
	;;
esac

dunused=
case $new_machos in
Darwin)
	_obfm=Mach-O
	_rtld=dyld
	CPPFLAGS="$CPPFLAGS -DHAVE_STRLCPY -DHAVE_STRLCAT -D_DARWIN_C_SOURCE"
	;;
*Interix)
	_obfm=PE
	_rtld=GNU
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
	;;
BSD)
	# MirOS BSD
	_obfm=ELF
	_rtld=BSD

	# OpenBSD
	if fgrep ELF_TOOLCHAIN /usr/share/mk/bsd.own.mk >/dev/null 2>&1; then
		if ! T=$(mktemp /tmp/mmake.XXXXXXXXXX); then
			print -u2 Error: cannot mktemp
			exit 1
		fi
		print '.include <bsd.own.mk>' >$T
		print 'all:' >>$T
		print '\t@@echo ${ELF_TOOLCHAIN:L}' >>$T
		if X=$($OLDMAKE -f $T all); then
			[[ $X = no ]] && _obfm=a.out
		fi
		rm -f $T
	fi

	# XXX what about NetBSD? They have ELF a.out PE coff ...
	;;
GNU)
	_obfm=ELF
	_rtld=GNU
	# XXX noone sane uses Linux with a.out libc4 these days?

	# these guys apparently do not care about honouring earlier
	# namespace uses; just make sure __unused is not used in code
	# we intend to port, otherwise it may break on GNU/Linux
	dunused='-D__unused=__unused '
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
	;;
esac

export CC=${CC:-gcc}
export COPTS="${CFLAGS:--O2 -fno-strict-aliasing}"
export CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F -isystem $d_build/F/ni ${dunused}-include $d_build/F/mirmake.h"
export CFLAGS="$COPTS $CPPFLAGS"
eval export "NROFF=\"${NROFF:-nroff}\""

echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && NROFF="$NROFF -c"

. $d_script/Version.sh

if [[ -z $new_binids ]]; then
	binown=root
	bingrp=bin
	confgrp=0
elif [[ $new_binids = *:* ]]; then
	binown=${new_binids%:*}
	bingrp=${new_binids#*:}
	confgrp=$bingrp
else
	binown=$new_binids
	bingrp=$new_binids
	confgrp=$bingrp
fi
if [[ $binown = - ]]; then
	ug=
else
	ug="\"-o $binown -g $bingrp\""
fi

if ! gnuos=$($SHELL $top/dist/contrib/gnu/config/config.guess); then
	print -u2 Please report also to the MirMake maintainers.
	exit 1
fi

rm -rf $d_build
mkdir -p $d_build/mk $d_build/F/ni

sed_exp="-e 's#@@@@machine@@@@#${new_machin}#g' \
	 -e 's#@@@@march@@@@#${new_macarc}#g' \
	 -e 's#@@@@machos@@@@#${new_machos}#g' \
	 -e 's#@@@@mksh@@@@#${new_mirksh}#g' \
	 -e 's#@@@@ostype@@@@#${new_ostype}#g' \
	 -e 's#@@@@shmk@@@@#${dt_mk}#g' \
	 -e 's#@@@@binmk@@@@#${dt_bin}#g' \
	 -e 's#@@@@ccom@@@@#${CC}#g' \
	 -e 's#@@@@nroff@@@@#${NROFF}#g' \
	 -e 's#@@@@gnuos@@@@#${gnuos}#g' \
	 -e 's#@@@@vers@@@@#${version}#g' \
	 -e 's#@@@@obfm@@@@#${_obfm}#g' \
	 -e 's#@@@@rtld@@@@#${_rtld}#g' \
	 -e 's#@@@@bmake@@@@#${new_exenam}#g'"


# Copy sources
(cd $d_src/usr.bin/make; find . | cpio -pdlu $d_build)
(cd $d_src/lib/libc; find ohash | cpio -pdlu $d_build)
cp $d_src/lib/libc/stdlib/getopt_long.c $d_src/kern/c/strlfun.c \
    $d_src/include/*.h $d_src/usr.bin/mkdep/mkdep.sh $d_build/
cp $d_src/share/mk/*.mk $d_build/mk/
cp $d_src/include/{getopt,adler32,md4,md5,rmd160,sfv,sha1,sha2,suma,tiger,whirlpool}.h \
    $d_script/../contrib/mirmake.h $d_build/F/
cp $d_src/kern/include/libckern.h $d_build/F/ni/
ed -s $d_build/strlfun.c <<-'EOF'
	0a
		#define L_strlcpy
		#define L_strlcat
		#include <wchar.h>
		#ifndef __predict_true
		#define __predict_true(exp)	((exp) != 0)
		#endif
		#ifndef __predict_false
		#define __predict_false(exp)	((exp) != 0)
		#endif
	.
	wq
EOF

# Patch sources
for ps in make.1 mk/{bsd.own.mk,bsd.prog.mk,bsd.sys.mk,sys.mk} mkdep.sh; do
	mv $d_build/$ps $d_build/$ps.tmp
	ed -s $d_build/$ps.tmp <$d_script/$(basename $ps).ed
	if eval sed $sed_exp <$d_build/$ps.tmp >$d_build/$ps; then
		rm $d_build/$ps.tmp
	else
		echo "Error in $d_build/$ps.tmp" >&2
		exit 1
	fi
done
cd $d_build
rm -f _t.*
cat >_t.c <<-'EOF'
	#include <string.h>
	#undef __attribute__
	int xcopy(const void *, void *, size_t)
	    __attribute__((__bounded__(__buffer__, 1, 3)))
	    __attribute__((__bounded__(__buffer__, 2, 3)));
	int main(int ac, char *av[]) { return (xcopy(av[0], av[--ac], 1)); }
	int xcopy(const void *s, void *d, size_t n) {
		memmove(d, s, n); return (n);
	}
EOF
$CC $CFLAGS -o _t.exe _t.c -Werror || rm -f _t.exe
[[ -x _t.exe ]] || perl -pi -e \
    's/__attribute__\s*\(\(\s*_*bounded_*\s*\([^)]*\)\s*\)\)//' \
    $(find . -name \*.[ch])
rm -f _t.*

if [[ $binown = - ]]; then
	binown=$(id -un)
	[[ $binown = *@@( )* ]] && binown=$(id -u)
	bingrp=$(id -gn)
	[[ $bingrp = *@@( )* ]] && bingrp=$(id -g)
	confgrp=$bingrp
fi
ed -s $d_build/mk/bsd.own.mk <<-EOF
	/^BINOWN/s/root/$binown/p
	/^BINGRP/s/bin/$bingrp/p
	/^CONFGRP/s/wheel/$confgrp/p
	wq
EOF
ed -s $d_build/mk/sys.mk <<-EOF
	,g/@@@@dunused@@@@/s//${dunused}/g
	wq
EOF

# Build bmake
cd $d_build
cp $d_script/../contrib/fgetln.c .
if ! $OLDMAKE -f Makefile.boot bmake CC="$CC" MACHINE="${new_machin}" \
    MACHINE_ARCH="${new_macarc}" MACHINE_OS="${new_machos}" \
    MKSH="${new_mirksh}"; then
	echo "Error: build failure" >&2
	exit 1
fi

[[ -e ${d_build}/bmake ]] || exit 1

# Build the paper
cd $d_build
pic <PSD.doc/tutorial.ms >PSD12.make.ms.tbl 2>/dev/null \
    || cp PSD.doc/tutorial.ms PSD12.make.ms.tbl
tbl <PSD12.make.ms.tbl >PSD12.make.ms 2>/dev/null \
    || cp PSD12.make.ms.tbl PSD12.make.ms
$NROFF -ms PSD12.make.ms >PSD12.make.txt 2>/dev/null \
    || rm PSD12.make.txt

# Generate installer
cd $top
cat >Install.sh <<EOF
#!${new_mirksh}

i=\${1:-${d_build}/xinstall/xinstall}
ug=$ug
set -x
mkdir -p \$DESTDIR$dt_bin \$DESTDIR$dt_man \$DESTDIR$dt_mk
\$i -c -s \$ug -m 555 ${d_build}/make \$DESTDIR${dt_bin}/${new_exenam}
\$i -c \$ug -m 555 ${d_build}/mkdep.sh \$DESTDIR${dt_bin}/mkdep
\$i -c \$ug -m 555 $d_src/usr.bin/lorder/lorder.sh \$DESTDIR${dt_bin}/lorder
\$i -c \$ug -m 444 $d_build/F/*.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/sysexits.h \$DESTDIR${dt_mk}/
EOF
for f in ${d_build}/mk/*.mk; do
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $f \$DESTDIR${dt_mk}/
EOF
done
# build make manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc make.1 >make.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/make.1 \$DESTDIR${dt_man}/${new_exenam}.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/make.cat1 \$DESTDIR${dt_man}/${new_exenam}.0
EOF
fi
# build mkdep manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc $d_src/usr.bin/mkdep/mkdep.1 >mkdep.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_src/usr.bin/mkdep/mkdep.1 \$DESTDIR${dt_man}/mkdep.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/mkdep.cat1 \$DESTDIR${dt_man}/mkdep.0
EOF
fi
# build lorder manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc $d_src/usr.bin/lorder/lorder.1 >lorder.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_src/usr.bin/lorder/lorder.1 \$DESTDIR${dt_man}/lorder.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/lorder.cat1 \$DESTDIR${dt_man}/lorder.0
EOF
fi
mkdir ${d_build}/lorder
cp $d_src/usr.bin/lorder/lorder.sh ${d_build}/lorder/lorder
chmod 555 ${d_build}/lorder/lorder
export PATH=${d_build}/lorder:$PATH
# build make documentation
if [[ -e $d_build/PSD12.make.txt ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_build/PSD12.make.txt \$DESTDIR${dt_mk}/
EOF
fi

# check for fgetln, strlcpy/strlcat, arc4random
# note: testfunc rv uses inverse logic!
add_fgetln=
if testfunc 'char *fgetln(FILE *, size_t *)' 'fgetln(stdin, &x)' \
    '#include <stdio.h>' 'size_t x;'; then
	add_fgetln=$d_build/fgetln.o
fi
add_strlfun=
if testfunc 'size_t strlcpy(char *, const char *, size_t)' \
    'strlcpy(dst, src, 1)' '' 'char src[3] = "Hi", dst[3];'; then
	add_strlfun=$d_build/strlfun.c
fi
add_arcfour=
if testfunc 'u_int32_t arc4random(void)' \
    'return ((int)arc4random())'; then
	add_arcfour=$top/dist/contrib/code/Snippets/arc4random.c
elif testfunc 'void arc4random_stir(void)' \
    'arc4random_stir()'; then
	add_arcfour=$top/dist/contrib/code/Snippets/arc4random.c
elif testfunc 'void arc4random_addrandom(unsigned char *, int)' \
    'arc4random_addrandom((void *)argv[0], argc)'; then
	add_arcfour=$top/dist/contrib/code/Snippets/arc4random.c
fi
add_libohash=
if testfunc 'u_int32_t ohash_interval(const char *, const char **)' \
    'return ohash_interval((void *)0, (void *)0);'; then
	add_libohash=$d_build/ohash/libohash.a
fi

# build tsort
rm -rf $d_build/tsort
cd $d_src/usr.bin; find tsort | cpio -pdlu $d_build
cd $d_build/tsort
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    INCS="-I $d_build" LIBS="$d_build/ohash/libohash.a $add_fgetln" || exit 1
export PATH=${d_build}/tsort:$PATH
cd $top
cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/tsort/tsort \$DESTDIR${dt_bin}/
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/tsort
	if ! $NROFF -mandoc tsort.1 >tsort.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/tsort/tsort.1 \$DESTDIR${dt_man}/tsort.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/tsort/tsort.cat1 \$DESTDIR${dt_man}/tsort.0
EOF
fi

# build binstall
rm -rf $d_build/xinstall
cd $d_src/usr.bin; find xinstall | cpio -pdlu $d_build
cd $d_build/xinstall
cp $d_src/bin/mksh/setmode.c .
ed -s install.1 <<-'EOF'
	/Nm install/s//Nm binstall/
	wq
EOF
CPPFLAGS="$CPPFLAGS -I$d_src/include" \
    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes || exit 1
cd $top
cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/xinstall/xinstall \$DESTDIR${dt_bin}/binstall
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/xinstall
	if ! $NROFF -mandoc install.1 >install.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.1 \$DESTDIR${dt_man}/binstall.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.cat1 \$DESTDIR${dt_man}/binstall.0
EOF
fi

# build libmirmake (hash stuff and necessities)
rm -rf $d_build/libmirmake
mkdir $d_build/libmirmake
cd $d_build/libmirmake
sed -e 's/hashinc/adler32.h/g' -e 's/HASH/ADLER32/g' \
    $d_src/lib/libc/hash/helper.c >adler32hl.c
sed -e 's/hashinc/md4.h/g' -e 's/HASH/MD4/g' \
    $d_src/lib/libc/hash/helper.c >md4hl.c
sed -e 's/hashinc/md5.h/g' -e 's/HASH/MD5/g' \
    $d_src/lib/libc/hash/helper.c >md5hl.c
sed -e 's/hashinc/rmd160.h/g' -e 's/HASH/RMD160/g' \
    $d_src/lib/libc/hash/helper.c >rmd160hl.c
sed -e 's/hashinc/sfv.h/g' -e 's/HASH/SFV/g' \
    $d_src/lib/libc/hash/helper.c >sfvhl.c
sed -e 's/hashinc/sha1.h/g' -e 's/HASH/SHA1/g' \
    $d_src/lib/libc/hash/helper.c >sha1hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA256_/g' \
    $d_src/lib/libc/hash/helper.c >sha256hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA384_/g' \
    $d_src/lib/libc/hash/helper.c >sha384hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA512_/g' \
    $d_src/lib/libc/hash/helper.c >sha512hl.c
sed -e 's/hashinc/suma.h/g' -e 's/HASH/SUMA/g' \
    $d_src/lib/libc/hash/helper.c >sumahl.c
sed -e 's/hashinc/tiger.h/g' -e 's/HASH/TIGER/g' \
    $d_src/lib/libc/hash/helper.c >tigerhl.c
sed -e 's/hashinc/whirlpool.h/g' -e 's/HASH/WHIRLPOOL/g' \
    $d_src/lib/libc/hash/helper.c >whirlpoolhl.c
cp  $d_src/lib/libc/hash/{adh32,md4,md5,rmd160,sfv,sha1,sha2,suma,tiger,whirlpool}.c \
    $d_src/kern/c/miscdata.c \
    $d_src/lib/libc/hash/suma-i386.S \
    $d_src/lib/libc/stdlib/{getopt_long,strtoll}.c \
    $d_src/lib/libc/stdio/{{,v}asprintf,mktemp}.c .
SRCS="${add_fgetln%.[co]}.c $add_strlfun $add_arcfour" \
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes clean
SRCS="${add_fgetln%.[co]}.c $add_strlfun $add_arcfour" \
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes || \
    exit 1
cd $top
if [[ -s $d_build/libmirmake/libmirmake.a ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 600 $d_build/libmirmake/libmirmake.a \$DESTDIR${dt_mk}/
ranlib \$DESTDIR${dt_mk}/libmirmake.a
chmod 444 \$DESTDIR${dt_mk}/libmirmake.a
EOF
fi

# build lndir
rm -rf $d_build/lndir
cd $d_src/usr.bin; find lndir | cpio -pdlu $d_build
cd $d_build/lndir
CPPFLAGS="$CPPFLAGS -I$d_src/include" LDADD=$d_build/libmirmake/libmirmake.a \
    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes || exit 1
cd $top
cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/lndir/lndir \$DESTDIR${dt_bin}/
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/lndir
	if ! $NROFF -mandoc lndir.1 >lndir.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/lndir/lndir.1 \$DESTDIR${dt_man}/lndir.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/lndir/lndir.cat1 \$DESTDIR${dt_man}/lndir.0
EOF
fi

# re-build bmake
cd ${d_build}
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\" \
    LDADD="$add_libohash $d_build/libmirmake/libmirmake.a" clean
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\" \
    MKDEP_SH="${new_mirksh} ${d_build}/mkdep.sh" \
    LDADD="$add_libohash $d_build/libmirmake/libmirmake.a" depend
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\" \
    LDADD="$add_libohash $d_build/libmirmake/libmirmake.a" make

[[ -e ${d_build}/make ]] || exit 1

chmod 555 $top/Install.sh

echo "Call $top/Install.sh to install ${new_exenam}!"
exit 0
@


1.138
log
@adapt most __attribute__((…)) occurrences to new KNF style(9)
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.137 2011/01/24 21:26:19 tg Exp $
d513 2
a514 1
cp  $d_src/lib/libc/hash/{adh32,md4,md5,rmd160,sfv,sha1,sha2,suma,tiger,whirlpool,hashpad,digits}.c \
@


1.137
log
@define _{ALL,DARWIN_C,GNU}_SOURCE to fight strict standardicy
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.136 2010/06/05 22:27:17 tg Exp $
d3 1
a3 1
# Copyright (c) 2006, 2008, 2011
d257 2
a258 2
	    __attribute__((bounded (buffer, 1, 3)))
	    __attribute__((bounded (buffer, 2, 3)));
@


1.136
log
@OSX/amd64 is weird (uname displays i386) and needs special, manual handling
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.135 2010/01/10 13:34:07 tg Exp $
d3 2
a4 2
# Copyright (c) 2006, 2008
#	Thorsten Glaser <tg@@mirbsd.de>
a103 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d121 1
a121 1
	CPPFLAGS="$CPPFLAGS -DHAVE_STRLCPY -DHAVE_STRLCAT"
d126 1
d159 1
@


1.135
log
@grml… forgot
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.134 2009/11/28 20:07:15 tg Exp $
d93 4
d112 1
a112 1
*:*:[Xx]86_64 | *:*:[Aa][Mm][Dd]64)
@


1.134
log
@fix another inverse logic error (I’m too stupid to remember to read
comments which specify the API)
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.133 2009/11/17 19:10:29 tg Exp $
d508 1
a508 1
cp  $d_src/lib/libc/hash/{adh32,md4,md5,rmd160,sfv,sha1,sha2,suma,tiger,whirlpool,hashpad}.c \
@


1.133
log
@hack: define __unused to __unused to prevent mirmake.h from
defining it on GNU/Linux

XXX should do the defines per-compiler better (eg. pcc's)
XXX should wrap the system headers instead
XXX should use mirtoconf instead
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.132 2009/11/09 22:40:59 tg Exp $
d390 1
d402 1
a402 1
if ! testfunc 'u_int32_t arc4random(void)' \
d405 1
a405 1
elif ! testfunc 'void arc4random_stir(void)' \
d408 1
a408 1
elif ! testfunc 'void arc4random_addrandom(unsigned char *, int)' \
@


1.132
log
@use Snippets/arc4random.c here, too (but don’t expose uniform/buf FNs)
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.131 2009/11/09 21:36:36 tg Exp $
d113 1
d150 5
d160 1
a160 1
export CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F -isystem $d_build/F/ni -include $d_build/F/mirmake.h"
d278 4
@


1.131
log
@bump libc minor, to be able to pull in OAAT hash helper functions,
as well as globalise the hashpad things; sync mirmake and kernel
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.130 2009/11/09 17:59:22 tg Exp $
d393 1
a393 1
	add_arcfour=$top/dist/contrib/arc4random.c
d396 1
a396 1
	add_arcfour=$top/dist/contrib/arc4random.c
d399 1
a399 1
	add_arcfour=$top/dist/contrib/arc4random.c
@


1.130
log
@do not provide arc4random_push{,b,k} any more, since nothing in
e.g. mirmake-20091020.cpio.gz uses it; fix tests to check for all
three potentially used functions
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.129 2009/05/20 10:23:16 tg Exp $
d497 1
a497 1
cp  $d_src/lib/libc/hash/{adh32,md4,md5,rmd160,sfv,sha1,sha2,suma,tiger,whirlpool}.c \
@


1.129
log
@use the one version of fgetln.c
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.128 2009/03/29 13:04:12 tg Exp $
d37 1
a37 1
		int main() {
d379 1
a379 1
# check for fgetln, strlcpy/strlcat, arc4random, arc4random_pushb
d391 8
a398 2
if testfunc 'uint32_t arc4random_pushb(const void *, size_t)' \
    'return arc4random_pushb(main, 1)'; then
a399 4
	if ! testfunc 'u_int32_t arc4random(void)' \
	    'return ((int)arc4random())'; then
		CPPFLAGS="$CPPFLAGS -D_ARC4RANDOM_WRAP"
	fi
@


1.128
log
@• take care of dbins
• #!/bin/mksh shebang, in most places
• rcsid while here
@
text
@d1 1
a1 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.127 2008/12/29 20:15:14 tg Exp $
d275 1
@


1.127
log
@and sync with the real libckern.h and <sys/cdefs.h>
@
text
@d1 1
a1 2
#!/usr/bin/env mksh
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.126 2008/10/13 20:20:21 tg Exp $
@


1.126
log
@do not install libckern.h
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.125 2008/10/13 20:14:22 tg Exp $
a214 9
ed -s $d_build/F/ni/libckern.h <<-'EOF'
	/defined.*_WCHAR_H_/,/endif.*_WCHAR_H_/d
	i
		#ifndef restrict
		#define restrict /* nothing */
		#endif
	.
	wq
EOF
@


1.125
log
@portability
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.124 2008/10/12 18:45:21 tg Exp $
d155 1
a155 1
export CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F -include $d_build/F/mirmake.h"
d188 1
a188 1
mkdir -p $d_build/mk $d_build/F
d213 3
a215 2
    $d_script/../contrib/mirmake.h $d_src/kern/include/libckern.h $d_build/F/
ed -s $d_build/F/libckern.h <<-'EOF'
@


1.124
log
@also patch strlfun.c to build everything
XXX to be redone in MirMake II
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.123 2008/10/12 18:10:15 tg Exp $
d217 1
a217 1
		#include <wchar.h>
d219 1
d227 2
d230 2
d233 1
@


1.123
log
@portability
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.122 2008/10/12 18:04:28 tg Exp $
d222 9
d390 1
a390 1
	add_strlfun=$d_src/kern/c/strlfun.c
@


1.122
log
@we need libckern.h now, too
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.121 2008/10/12 17:56:25 tg Exp $
d214 8
@


1.121
log
@strlfun.c has moved
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.120 2008/10/05 16:32:50 tg Exp $
d213 1
a213 1
    $d_script/../contrib/mirmake.h $d_build/F/
@


1.120
log
@switch MACHINE_OS over: Linux → GNU
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.119 2008/07/11 11:34:27 tg Exp $
d209 1
a209 1
cp $d_src/lib/libc/stdlib/getopt_long.c $d_src/lib/libc/string/strlfun.c \
d373 1
a373 1
	add_strlfun=$d_src/lib/libc/string/strlfun.c
@


1.119
log
@no need to build'n'bundle readlink(1) any more
@
text
@d1 2
a2 2
#!/bin/mksh
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.118 2008/05/07 13:34:38 tg Exp $
d146 1
a146 1
Linux)
@


1.118
log
@prepare for improved portability
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.117 2008/05/03 01:09:29 tg Exp $
a389 28
# build readlink
rm -rf $d_build/readlink
cd $d_src/usr.bin; find readlink | cpio -pdlu $d_build
cd $d_build/readlink
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes
export PATH=${d_build}/readlink:$PATH
cd $top
cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/readlink/readlink \$DESTDIR${dt_bin}/
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/readlink
	if ! $NROFF -mandoc readlink.1 >readlink.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/readlink/readlink.1 \$DESTDIR${dt_man}/readlink.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/readlink/readlink.cat1 \$DESTDIR${dt_man}/readlink.0
EOF
fi

@


1.117
log
@remove advertising clause for all of contrib/ except
‣ heartbeat server/client, for now
‣ stuff in jupp that’ll be regenerated before next release anyway
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
a60 1
[[ -z $OLDMAKE ]] && OLDMAKE=make
d68 1
@


1.116
log
@build lndir with libmirmake: strlcpy(3)…
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.115 2008/04/06 23:20:21 tg Exp $
d5 1
a5 1
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.de>
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d13 8
a20 12
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
@


1.115
log
@copy over setmode.c
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.114 2008/04/06 23:09:43 tg Exp $
d535 1
a535 1
CPPFLAGS="$CPPFLAGS -I$d_src/include" \
@


1.114
log
@yeah, I never get evals done right in bourne shell
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.113 2008/04/06 22:42:55 tg Exp $
d456 1
@


1.113
log
@NULL isn't always declared in a non-SUSv3 way
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.112 2008/04/06 22:41:52 tg Exp $
d162 1
a162 1
eval export NROFF="${NROFF:-nroff}"
@


1.112
log
@fix proto for arc4random during maktoconf (to be replaced by mirtoconf RSN)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.111 2008/04/06 22:40:22 tg Exp $
d391 1
a391 1
    'return ohash_interval(NULL, NULL);'; then
@


1.111
log
@expand ${MACROS} etc. if they should already be in $NROFF
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.110 2008/04/06 22:25:16 tg Exp $
d384 2
a385 2
	if ! testfunc 'int arc4random(void)' \
	    'return arc4random()'; then
@


1.110
log
@oversight in r1.108
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.109 2008/04/06 22:00:14 tg Exp $
d162 1
a162 1
export NROFF=${NROFF:-nroff}
@


1.109
log
@more amd64, and upper/lowercase, just in case
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.108 2008/03/27 17:42:43 tg Exp $
d289 1
a289 1
i=\${1:-${d_build}/xinstall/install}
@


1.108
log
@it's not good to name a programme “install” if we have a phony install tgt…
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.107 2008/03/14 14:51:41 tg Exp $
d111 1
a111 1
*:*:i[3456789x]86)
d114 3
@


1.107
log
@build lndir now
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.106 2008/03/14 14:37:38 tg Exp $
d461 1
a461 1
\$i -c -s \$ug -m 555 ${d_build}/xinstall/install \$DESTDIR${dt_bin}/binstall
@


1.106
log
@use the install we just built by default for installing
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.105 2008/03/14 14:28:19 tg Exp $
d527 28
@


1.105
log
@always build our install(1), not just on Interix – this is to unify
the ports/devel/mirmake PLIST, as we’ll add lndir(1) too now
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.104 2008/03/09 16:38:28 tg Exp $
d286 1
a286 1
i=\${1:-install}
@


1.104
log
@fix
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.103 2008/03/09 16:32:04 tg Exp $
d449 15
a463 4
if [[ $new_machos = Interix ]]; then
	# build xinstall
	rm -rf $d_build/xinstall
	cd $d_src/usr.bin; find xinstall | cpio -pdlu $d_build
d465 4
a468 2
	CPPFLAGS="$CPPFLAGS -I$d_src/include" \
	    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes || exit 1
d470 2
d473 1
a473 2
\$i -c -s \$ug -m 555 ${d_build}/xinstall/xinstall \$DESTDIR${dt_bin}/
mv \$DESTDIR${dt_bin}/xinstall \$DESTDIR${dt_bin}/install
d475 3
a477 15
	if [[ $is_catman = 1 ]]; then
		cd $d_build/xinstall
		if ! $NROFF -mandoc install.1 >install.cat1; then
			echo "Warning: manpage build failure." >&2
			is_catman=0
		fi
		cd $top
	fi
	if [[ $is_catman = 0 ]]; then
		cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.1 \$DESTDIR${dt_man}/install.1
EOF
	else
		cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.cat1 \$DESTDIR${dt_man}/install.0
a478 1
	fi
@


1.103
log
@cflags
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.102 2008/03/09 16:20:35 tg Exp $
d257 1
a257 1
	/^CONFGRP/s/bin/$confgrp/p
@


1.102
log
@clean up build area before starting
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.101 2008/03/09 16:19:49 tg Exp $
d241 1
a241 1
$CC -o _t.exe _t.c -Werror || rm -f _t.exe
@


1.101
log
@there is no longer a need to disable UNIX03 on Darwin
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.100 2008/03/09 14:16:07 tg Exp $
d189 1
@


1.100
log
@provide the other hashes too (sfv, suma, whirlpool)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.99 2008/03/09 13:55:47 tg Exp $
d120 1
a120 1
	CPPFLAGS="$CPPFLAGS -DHAVE_STRLCPY -DHAVE_STRLCAT -D__DARWIN_UNIX03=0"
@


1.99
log
@.oO(yeah, see me using perl…)
nuke all these __bounded__ warnings if the compiler doesn’t support it

XXX mirmake2 will use mirtoconf for sure! this is kludgy but works for now
XXX since we only support gcc anyway
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.98 2008/03/09 13:42:52 tg Exp $
d213 1
a213 1
cp $d_src/include/{getopt,md4,md5,rmd160,sha1,sha2,tiger}.h \
d483 2
d491 2
d501 2
d505 4
a508 1
cp  $d_src/lib/libc/hash/{md4,md5,rmd160,sha1,sha2,tiger}.c \
@


1.98
log
@fix the Darwin problem by disabling UNIX03 symbol mangling unconditionally;
now we can use our own trusted getopt(3) function suite again

tested on anakin, 10x gecko2@@
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.94 2007/10/25 16:01:21 tg Exp $
d4 2
a5 2
# Copyright (c) 2006
#	Thorsten Glaser <tg@@mirbsd.de>
d227 18
@


1.97
log
@unify getopt-incompat stuff
XXX this uses native getopt(3) on _all_ Darwin versions, which is NOT what
XXX I intended… we should™ use our own getopt whenever possible
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.96 2008/02/22 21:38:37 tg Exp $
a85 2
is_getopt_incompat=0

d120 1
a120 2
	CPPFLAGS="$CPPFLAGS -DHAVE_STRLCPY -DHAVE_STRLCAT"
	is_getopt_incompat=1
d210 1
a210 1
cp $d_src/lib/libc/string/strlfun.c \
d213 1
a213 1
cp $d_src/include/{md4,md5,rmd160,sha1,sha2,tiger}.h \
a214 4
if [[ $is_getopt_incompat = 0 ]]; then
	cp $d_src/lib/libc/stdlib/getopt_long.c $d_build/
	cp $d_src/include/getopt.h $d_build/F/
fi
a242 2
getopt_long_o=getopt_long.o
[[ $is_getopt_incompat = 0 ]] || getopt_long_o=
d246 1
a246 1
    MKSH="${new_mirksh}" getopt_long_o="${getopt_long_o}"; then
d482 1
a482 1
    $d_src/lib/libc/stdlib/strtoll.c \
a483 1
[[ $is_getopt_incompat = 1 ]] || cp $d_src/lib/libc/stdlib/getopt_long.c .
d487 2
a488 2
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes \
    getopt_long_o="${getopt_long_o}" || exit 1
@


1.96
log
@proper mksh style
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.95 2008/02/17 15:42:16 bsiegert Exp $
d86 1
a86 1
HAVE_GETOPT=no
d123 1
a123 1
	HAVE_GETOPT=yes
d218 1
a218 1
if [[ $HAVE_GETOPT != yes ]]; then
d251 1
a251 3
if [[ $HAVE_GETOPT = yes ]]; then
	getopt_long_o=
fi
d493 1
a493 3
if [[ $HAVE_GETOPT != yes ]]; then
	cp $d_src/lib/libc/stdlib/getopt_long.c .
fi
d497 2
a498 2
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes HAVE_GETOPT="$HAVE_GETOPT" || \
    exit 1
@


1.95
log
@Introduce HAVE_GETOPT and build libmirmake accordingly: don't include
getopt on Mac OS, use the native one
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.94 2007/10/25 16:01:21 tg Exp $
d86 1
a86 1
export HAVE_GETOPT=no
d218 2
a219 2
if [[ "x$HAVE_GETOPT" != "xyes" ]]; then
	cp  $d_src/lib/libc/stdlib/getopt_long.c $d_build/
d251 1
a251 1
if [[ "x$HAVE_GETOPT" = xyes ]]; then
d495 1
a495 1
if [[ "x$HAVE_GETOPT" != xyes ]]; then
@


1.94
log
@fix GNU groff -c option for nroff detection
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.93 2007/06/19 19:21:20 tg Exp $
d86 2
d123 1
d213 1
a213 1
cp $d_src/lib/libc/stdlib/getopt_long.c $d_src/lib/libc/string/strlfun.c \
d216 1
a216 1
cp $d_src/include/{getopt,md4,md5,rmd160,sha1,sha2,tiger}.h \
d218 4
d250 4
d257 1
a257 1
    MKSH="${new_mirksh}"; then
d493 1
a493 1
    $d_src/lib/libc/stdlib/{getopt_long,strtoll}.c \
d495 3
d501 1
a501 1
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes || \
@


1.93
log
@lorder(1) is needed later too, from FreeWRT
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.92 2006/12/28 17:32:52 tg Exp $
d161 1
a161 1
echo | $NROFF -v 2>&1 | grep GNU >&- 2>&- && NROFF="$NROFF -c"
@


1.92
log
@sprinkle a few more '|| exit 1'
XXX to be replaced by "set -e" sooner or later
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.91 2006/11/07 00:38:17 tg Exp $
d336 4
@


1.91
log
@break if we fail
XXX should check in more places; consider use set -e
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.90 2006/11/07 00:18:57 tg Exp $
d251 2
d402 1
a402 1
    INCS="-I $d_build" LIBS="$d_build/ohash/libohash.a $add_fgetln"
d432 1
a432 1
	    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes
d483 2
a484 1
    ${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes
@


1.90
log
@fixes
* arc4random_pushb mis-detection (we have mirmake.h there already…)
* arc4random.c missing for libmirmake
* libmirmake, libohash (if needed) not used for linking second make binary

unbreaks mirmake on inferiour operating systems (verified on gecko2's mac)
XXX tiger.o requires htole64() which seems to not be in on the Mac?
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.89 2006/10/28 19:52:50 tg Exp $
d504 2
@


1.89
log
@* add new CONFGRP?=wheel (mirmake: same as BINGRP, unless BINGRP is the
  default of 'bin', in which case, it defaults to '0')
* sort logically, not alphabetically
* INSTALL_STRIP libs (while here)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.88 2006/10/13 16:41:47 tg Exp $
d350 1
a350 1
	add_strlfun=strlfun.c
d353 1
a353 1
if testfunc 'int arc4random_pushb(const void *, size_t)' \
d355 1
a355 1
	add_arcfour=arc4random.c
d361 5
a475 1
    $d_src/lib/libc/string/strlfun.c \
d495 1
a495 1
    LIBS=$d_build/libmirmake/libmirmake.a clean
d499 1
a499 1
    LIBS=$d_build/libmirmake/libmirmake.a depend
d502 1
a502 1
    LIBS=$d_build/libmirmake/libmirmake.a make
@


1.88
log
@tiger
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.87 2006/10/13 16:39:52 tg Exp $
d168 1
d172 1
d176 1
d233 1
d235 6
a240 2
print "/^BINOWN/s/root/$binown/p\n/^BINGRP/s/bin/$bingrp/p\nwq" \
    | ed -s $d_build/mk/bsd.own.mk
@


1.87
log
@arc4random, stdbool
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.86 2006/10/13 12:44:42 tg Exp $
d210 1
a210 1
cp $d_src/include/{getopt,md4,md5,rmd160,sha1,sha2}.h \
d460 3
a462 1
cp  $d_src/lib/libc/hash/{md4,md5,rmd160,sha1,sha2}.c \
@


1.86
log
@bring back about mirmake 20060623 but with improved arc4random
(not yet enabled) and keep some of the current changes

doesn't build yet, needs work
@
text
@a0 1
XXX wir haben immer stdbool.h, via Copy.sh
d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.85 2006/08/27 01:06:10 tg Exp $
d40 1
d333 1
a333 1
# check for fgetln, strlcpy/strlcat, stdbool.h
d344 8
a351 4
stdboolh=
if ! testfunc 'void exit(int)' 'exit(t == false)' \
    '#include <stdbool.h>' 'bool t = true;'; then
	stdboolh=-DHAS_STDBOOL_H
d464 4
a467 4
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes \
    EXTRA_SRCS="${add_fgetln%.[co]}.c $add_strlfun" clean
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes \
    EXTRA_SRCS="${add_fgetln%.[co]}.c $add_strlfun"
a478 1
mkf="$stdboolh -D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\""
d480 1
a480 1
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
d483 1
a483 1
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
d487 1
a487 1
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
@


1.85
log
@linking is fine,
relinking is a pain

@@bsiegert: why do we relink, anyway, if we don't
link dynamically against a library we built? In
this case, e.g. tsort(1) is linked against a
static libmirmake even though it's installed as
a dylib (into LOCALBASE/share/mmake/ though; does
that work at all? with rpath?)
@
text
@d1 1
d3 1
a3 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.84 2006/08/27 00:53:32 tg Exp $
d28 26
a53 27
function scnfunc
{
	name=$1
	args=$2
	extra_hdrs=$3
	extra_defs=$4

	print ... ${5:-$name}
	typeset -u nameu=$name
	rm -f scn.c
	for header in $extra_hdrs; do
		print "#include <$header>" >>scn.c
	done
	print "int main(int argc, char *argv[]) {" >>scn.c
	print "$extra_defs" >>scn.c
	print "(void)$name($args);" >>scn.c
	print "return (0); }" >>scn.c
	$d_build/bmake -m $d_build/mk PROG=scn -f $d_build/mk/bsd.prog.mk
	if [[ -x scn ]]; then
		local res=yes
		eval HAVE_$nameu=1
	else
		local res=no
		eval HAVE_$nameu=0
	fi
	rm -f scn.c scn.o scn
	print "==> ${5:-$name}... $res"
d66 1
d73 1
a73 1
export SHELL=$new_mirksh MKSH=$new_mirksh
a75 15
[[ -z $OLDMAKE ]] && OLDMAKE=make

# Normalise certain variables
CPPFLAGS=${CPPFLAGS##*( )}
CPPFLAGS=${CPPFLAGS%%*( )}
COPTS=$(echo " ${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing} " | \
    sed -e "s# $CPPFLAGS # #g" \
    -e 's# -include[	 ][	 ]*/[^ ]*/mirmake.h # #g')
CPPFLAGS=$(echo " $CPPFLAGS " | sed \
    -e 's# -include[	 ][	 ]*/[^ ]*/mirmake.h # #g')
LDFLAGS=$(echo " $LDFLAGS " | sed -e 's# -lmirmake # #g')
COPTS=${COPTS##*( )}
COPTS=${COPTS%%*( )}
LDFLAGS=${LDFLAGS##*( )}
LDFLAGS=${LDFLAGS%%*( )}
a84 3
rm -rf $top/tmpx $d_build
mkdir -p $top/tmpx $d_build/{F,mk,libmirmake}
export PATH=$top/tmpx:$PATH
d92 1
a92 1
case $new_machos:$new_machin:$new_macarc in
d106 1
d108 2
a109 2
	cp $top/dist/contrib/mktemp.sh $top/tmpx/mktemp
	chmod 755 $top/tmpx/mktemp
d120 1
a124 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d132 1
a132 1
	if fgrep ELF_TOOLCHAIN /usr/share/mk/bsd.own.mk >&- 2>&-; then
d155 6
a160 4
: ${CC:=gcc} ${NROFF:=nroff}
CPPFLAGS="${CPPFLAGS##*( )} -D_MIRMAKE_DEFNS"
CPPFLAGS="$CPPFLAGS -I$d_build/F -include $d_build/F/mirmake.h"
CFLAGS="$COPTS $CPPFLAGS"
a161 2
export CC COPTS CPPFLAGS CFLAGS LDFLAGS NROFF NOMAN=yes NOOBJ=yes
unset LDADD DPADD LIBS
a176 4
	binown=$(id -un)
	[[ $binown = *@@( )* ]] && binown=$(id -u)
	bingrp=$(id -gn)
	[[ $bingrp = *@@( )* ]] && bingrp=$(id -g)
d181 1
a181 1
if ! gnuos=$($MKSH $top/dist/contrib/gnu/config/config.guess); then
d186 2
d191 1
a191 1
	 -e 's#@@@@mksh@@@@#${MKSH}#g' \
d203 1
d207 1
a207 2
(cd $d_src/usr.bin; find readlink tsort xinstall | cpio -pdlu $d_build)
cp  $d_src/lib/libc/stdlib/getopt_long.c $d_src/lib/libc/string/strlfun.c \
d209 3
a211 20
cp  $d_src/share/mk/*.mk $d_build/mk/
cp  $d_src/include/{getopt,md{4,5},ohash,rmd160,sha{1,2},stdbool,sysexits}.h \
    $top/dist/contrib/mirmake.h $d_build/F/
cp  $d_src/lib/libc/hash/{md4,md5,rmd160,sha1,sha2}.c \
    $d_src/lib/libc/string/strlfun.c \
    $d_src/lib/libc/stdlib/{getopt_long,strtoll}.c \
    $d_src/lib/libc/stdio/{{,v}asprintf,mktemp}.c \
    $top/dist/contrib/*.c $d_build/ohash/*.[ch] $d_build/libmirmake/
for lc in md4 md5 rmd160 sha1; do
	typeset -u uc=$lc
	sed -e "s/hashinc/$lc.h/g" -e "s/HASH/$uc/g" \
	    <$d_src/lib/libc/hash/helper.c >$d_build/libmirmake/${lc}hl.c
done
for lc in sha256 sha384 sha512; do
	typeset -u uc=$lc
	sed -e "s/hashinc/sha2.h/g" -e 's/HASH_\{0,1\}/'"$uc"_/g \
	    <$d_src/lib/libc/hash/helper.c >$d_build/libmirmake/${lc}hl.c
done
cp $d_script/Makefile.lib $d_build/libmirmake/Makefile
chmod -R u+w $d_build
a223 5
ed -s $d_build/mk/bsd.own.mk <<-EOF
	/^BINOWN/s/root/$binown/p
	/^BINGRP/s/bin/$bingrp/p
	wq
EOF
d225 8
a232 5
# Install shell-based helpers in temporary location (in our PATH)
cd $top/tmpx
cp $d_build/mkdep.sh mkdep
cp $d_src/usr.bin/lorder/lorder.sh lorder
chmod 755 mkdep lorder
d236 1
a236 1
$OLDMAKE -f Makefile.boot bmake CC="$CC" MACHINE="${new_machin}" \
d238 2
a239 2
    MKSH="$MKSH" && test -x bmake || {
	print -u2 "Error: build failure"
d241 1
a241 3
}
rm F/stdbool.h
unset CFLAGS
d243 1
a243 61
# Build libmirmake
cd $d_build/libmirmake
print Scanning for functions...
scnfunc strlcpy 'dst,src,1' 'stdlib.h' 'char src[] = "test", dst[4];'
scnfunc strlcat 'dst,src,1' 'stdlib.h' 'char src[] = "test", dst[4] = "";'
scnfunc fgetln 'stdin,&x' 'stdio.h' 'size_t x;'
scnfunc arc4random '' 'stdlib.h'
scnfunc arc4random_pushb 'buf,arc4random()' 'stdlib.h' 'char buf[] = "test";'
unset HAVE_EXIT
scnfunc exit 't==false' 'stdbool.h' 'bool t = true;' stdbool.h
test 1 = $HAVE_EXIT || cp $d_src/include/stdbool.h $d_build/F/
unset HAVE_EXIT
scnfunc ohash_delete 'NULL' 'stdlib.h' 'void ohash_delete(void *);'
scnfunc utimes 'NULL,NULL' 'stdlib.h sys/time.h' '#ifndef timespeccmp
#error timespeccmp not defined
#endif'
SRCS="md4hl.c md5hl.c rmd160hl.c sha1hl.c sha256hl.c sha384hl.c sha512hl.c"
SRCS="getopt_long.c md4.c md5.c rmd160.c sha1.c sha2.c $SRCS"
[[ $new_machos = Interix ]] && \
    SRCS="$SRCS asprintf.c mktemp.c strtoll.c vasprintf.c"
[[ $HAVE_STRLCPY$HAVE_STRLCAT = 11 ]] || SRCS="$SRCS strlfun.c"
[[ $HAVE_FGETLN = 1 ]] || SRCS="$SRCS fgetln.c"
[[ $HAVE_ARC4RANDOM = 1 ]] || CPPFLAGS="$CPPFLAGS -D_ARC4RANDOM_WRAP"
[[ $HAVE_ARC4RANDOM_PUSHB = 1 ]] || SRCS="$SRCS arc4random.c"
[[ $HAVE_OHASH_DELETE = 1 ]] || \
    SRCS="$SRCS ohash_create_entry.c ohash_delete.c ohash_do.c \
    ohash_entries.c ohash_enum.c ohash_init.c ohash_interval.c \
    ohash_lookup_interval.c ohash_lookup_memory.c ohash_qlookup.c \
    ohash_qlookupi.c"
print ... done
SRCS=$SRCS $d_build/bmake -m $d_build/mk libmirmake.a
rm -f $top/tmpx/libmirmake.a
cp libmirmake.a $top/tmpx/
export LDADD="-L$top/tmpx -lmirmake"
cd $top

# Build helper programmes
for prog in readlink tsort xinstall; do
	cd $d_build/$prog
	CPPFLAGS="$CPPFLAGS -I$d_src/include" $d_build/bmake -m $d_build/mk
	export PATH=$d_build/$prog:$PATH
done

# Rebuild bmake
cd $d_build
$d_build/bmake -m $d_build/mk MAKE_BOOTSTRAP=Yes \
    MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\" clean
[[ $HAVE_UTIMES = 1 ]] && CPPFLAGS="$CPPFLAGS -DUSE_TIMESPEC"
$d_build/bmake -m $d_build/mk MAKE_BOOTSTRAP=Yes \
    MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\" depend
$d_build/bmake -m $d_build/mk MAKE_BOOTSTRAP=Yes \
    MKFEATURES=-D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\"

# Rebuild libmirmake (this time shared)
unset LDADD
cd $d_build/libmirmake
SRCS=$SRCS $d_build/make -m $d_build/mk clean
SRCS=$SRCS $d_build/make -m $d_build/mk depend
SRCS=$SRCS $d_build/make -m $d_build/mk

# Build the make(1) paper and a variety of manual pages
d245 1
a245 1
pic <PSD.doc/tutorial.ms >PSD12.make.ms.tbl 2>&- \
d247 1
a247 1
tbl <PSD12.make.ms.tbl >PSD12.make.ms 2>&- \
d249 1
a249 1
$NROFF -ms PSD12.make.ms >PSD12.make.txt 2>&- \
a250 9
for mansrc in make.1 $d_src/usr.bin/mkdep/mkdep.1 \
    $d_src/usr.bin/lorder/lorder.1 $d_src/usr.bin/readlink/readlink.1 \
    $d_src/usr.bin/tsort/tsort.1 $d_src/usr.bin/xinstall/install.1; do
	mandst=$(basename $mansrc | sed 's/\./.cat/')
	[[ $is_catman = 1 ]] && if ! $NROFF -mandoc $mansrc >$mandst; then
		print -u2 Warning: manpage build failure.
		is_catman=0
	fi
done
d252 1
a252 1
# Finally, generate the installer
d255 1
a255 1
#!$MKSH
a257 1
s=\${INSTALL_STRIP:--s}
d261 41
a301 10
\$i -c \$s \$ug -m 555 $d_build/make \$DESTDIR$dt_bin/$new_exenam
\$i -c \$ug -m 555 $top/tmpx/mkdep $top/tmpx/lorder \$DESTDIR$dt_bin/
\$i -c \$ug -m 444 $d_build/F/*.h $d_build/mk/*.mk \$DESTDIR$dt_mk/
progs="readlink tsort"
sfu=:
EOF
[[ $new_machos = Interix ]] && cat >>Install.sh <<EOF
\$i -c \$ug -m 555 $top/tmpx/mktemp \$DESTDIR$dt_bin/
progs="\$progs xinstall"
sfu=
d303 3
a305 2
[[ -s $d_build/PSD12.make.txt ]] && cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_build/PSD12.make.txt \$DESTDIR$dt_mk/
d307 10
d319 1
a319 6
\$i -c \$ug -m 444 $d_build/make.1 \$DESTDIR$dt_man/$new_exenam.1
\$i -c \$ug -m 444 $d_src/usr.bin/mkdep/mkdep.1 \$DESTDIR$dt_man/mkdep.1
\$i -c \$ug -m 444 $d_src/usr.bin/lorder/lorder.1 \$DESTDIR$dt_man/lorder.1
\$i -c \$ug -m 444 $d_build/readlink/readlink.1 \$DESTDIR$dt_man/readlink.1
\$i -c \$ug -m 444 $d_build/tsort/tsort.1 \$DESTDIR$dt_man/tsort.1
\$sfu \$i -c \$ug -m 444 $d_build/xinstall/install.1 \$DESTDIR$dt_man/install.1
d323 7
a329 6
\$i -c \$ug -m 444 $d_build/make.cat1 \$DESTDIR$dt_man/$new_exenam.0
\$i -c \$ug -m 444 $d_build/mkdep.cat1 \$DESTDIR$dt_man/mkdep.0
\$i -c \$ug -m 444 $d_build/lorder.cat1 \$DESTDIR$dt_man/lorder.0
\$i -c \$ug -m 444 $d_build/readlink.cat1 \$DESTDIR$dt_man/readlink.0
\$i -c \$ug -m 444 $d_build/tsort.cat1 \$DESTDIR$dt_man/tsort.0
\$sfu \$i -c \$ug -m 444 $d_build/install.cat1 \$DESTDIR$dt_man/install.0
d332 25
d358 112
a469 8
(cd $d_build/libmirmake; SRCS="$SRCS" $d_build/make -m $d_build/mk \\
    NOOBJ=yes NOMAN=yes INSTALL_STRIP=\$s \\
    DESTDIR="\$DESTDIR" LIBDIR=$dt_mk install)
for prog in \$progs; do
	(cd $d_build/\$prog; $d_build/make -m $d_build/mk INSTALL_STRIP=\$s \\
	    NOOBJ=yes NOMAN=yes LDADD=\$DESTDIR$dt_mk/libmirmake.a \\
	    DESTDIR="\$DESTDIR" BINDIR=$dt_bin install)
done
d471 17
a488 1
chmod 755 Install.sh
@


1.84
log
@check for another macro we need
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.83 2006/08/27 00:49:09 tg Exp $
d373 1
a373 1
progs="libmirmake readlink tsort"
d404 3
d408 3
a410 3
	(cd $d_build/\$prog; $d_build/make -m $d_build/mk \\
	    NOOBJ=yes NOMAN=yes INSTALL_STRIP=\$s \\
	    DESTDIR="\$DESTDIR" BINDIR=$dt_bin LIBDIR=$dt_mk install)
@


1.83
log
@use -I not -isystem for local build
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.82 2006/08/27 00:39:32 tg Exp $
d295 3
a297 1
scnfunc utimes 'NULL,NULL' 'stdlib.h sys/time.h'
@


1.82
log
@scan for utimes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.81 2006/08/27 00:32:46 tg Exp $
d172 2
a173 2
CPPFLAGS="${CPPFLAGS##*( )} -D_MIRMAKE_DEFNS -isystem $d_build/F\
 -include $d_build/F/mirmake.h"
@


1.81
log
@* clean up environment (for build within mirports)
* add ohash to libmirmake (for macintosh)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.80 2006/08/26 23:31:24 tg Exp $
d295 1
d327 1
@


1.80
log
@next round of fixes...
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.79 2006/08/26 23:10:37 tg Exp $
d77 14
d172 1
a172 2
COPTS=${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing}
CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F\
a175 1
LDFLAGS=$(echo " $LDFLAGS "|sed -e 's/ -lmirmake //' -e 's/^ *//' -e 's/ *$//')
d228 1
a228 1
cp  $d_src/include/{getopt,md4,md5,rmd160,sha1,sha2,stdbool,sysexits}.h \
d234 1
a234 1
    $top/dist/contrib/*.c $d_build/libmirmake/
d279 2
a280 1
rm $d_build/F/stdbool.h
d294 1
d303 5
@


1.79
log
@next round of fixes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.78 2006/08/26 22:57:01 tg Exp $
d315 3
a317 3
$d_build/make -m $d_build/mk clean
$d_build/make -m $d_build/mk depend
$d_build/make -m $d_build/mk
@


1.78
log
@first round of fixes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.77 2006/08/26 22:50:50 tg Exp $
d53 1
a53 1
	print "==> $name... $res"
a78 2
mkdir $top/tmpx
export PATH=$top/tmpx:$PATH
d85 3
a209 2
rm -rf $d_build
mkdir -p $d_build/{F,mk,libmirmake}
d230 1
a230 1
	sed -e "s/hashinc/sha2.h/g" -e "s/HASH_\{0,1\}/$uc_/g" \
@


1.77
log
@move SRCS into Build.sh
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.76 2006/08/26 22:46:43 tg Exp $
d34 1
a34 1
	print ... $name
d163 1
a163 1
export CC COPTS CPPFLAGS CFLAGS LDFLAGS NROFF
d279 2
a280 7
scnfunc exit 't==false' 'stdbool.h' 'bool t = true;'
if 1 = $HAVE_EXIT; then
	HAS_STDBOOL_H=1
else
	HAS_STDBOOL_H=0
	cp $d_src/include/stdbool.h $d_build/F/
fi
a289 1
export SRCS NOMAN=yes NOOBJ=yes
d291 1
a291 1
$d_build/bmake -m $d_build/mk libmirmake.a
@


1.76
log
@modernize, rewrite
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d287 6
a292 3
EXTRA_SRCS=
[[ $HAVE_STRLCPY$HAVE_STRLCAT = 11 ]] || EXTRA_SRCS="$EXTRA_SRCS strlfun.c"
[[ $HAVE_FGETLN = 1 ]] || EXTRA_SRCS="$EXTRA_SRCS fgetln.c"
d294 2
a295 2
[[ $HAVE_ARC4RANDOM_PUSHB = 1 ]] || EXTRA_SRCS="$EXTRA_SRCS arc4random.c"
export EXTRA_SRCS NOMAN=yes NOOBJ=yes
@


1.75
log
@this needs to be rewritten
commit unfinished parts for now
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.74 2006/08/26 16:45:27 tg Exp $
d4 1
a4 1
# Copyright (c) 2004, 2005, 2006
a25 2
#-
# _Really_ build MirMake. Called from mirbsdksh.
d27 27
a53 26

# Functions

# Call: testfunc 'proto' 'call' 'opt_include' 'opt_decl;'
# Return: 1 if found, 0 otherwise (inverse logic)
function testfunc {
	rv=0
	mkdir $d_build/testfunc
	cat >$d_build/testfunc/Makefile <<-'EOF'
		PROG=	testfunc
		.include <bsd.prog.mk>
	EOF
	cat >$d_build/testfunc/testfunc.c <<-EOF
		$3
		$1;
		int main() {
			$4
			$2;
			return 0;
		}
	EOF
	( cd $d_build/testfunc && ${d_build}/bmake -m ${d_build}/mk \
	    NOMAN=yes NOOBJ=yes ) 2>&1 | sed 's!^![ !'
	[[ -x $d_build/testfunc/testfunc ]] && rv=1
	rm -rf $d_build/testfunc
	return $rv
d72 1
a72 1
export SHELL=$new_mirksh
a80 1
export LDFLAGS="$LDFLAGS -L$top/tmpx -lmirmake"
d109 2
a110 1
	/usr/bin/install -c -m 555 $top/dist/contrib/mktemp.sh $top/tmpx/mktemp
a120 1
	CPPFLAGS="$CPPFLAGS -DHAVE_STRLCPY -DHAVE_STRLCAT"
d133 1
a133 1
	if fgrep ELF_TOOLCHAIN /usr/share/mk/bsd.own.mk >/dev/null 2>&1; then
d158 2
a159 1
CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F -include $d_build/F/mirmake.h"
d162 3
a164 3
export CC COPTS CPPFLAGS CFLAGS NROFF

echo 'void dummy(void) { }' >$top/tmpx/dummy.c
d180 4
d188 1
a188 1
if ! gnuos=$($SHELL $top/dist/contrib/gnu/config/config.guess); then
a192 2
mkdir -p $d_build/mk $d_build/F

d196 1
a196 1
	 -e 's#@@@@mksh@@@@#${new_mirksh}#g' \
a207 1

d209 2
d213 2
a214 1
cp $d_src/lib/libc/stdlib/getopt_long.c $d_src/lib/libc/string/strlfun.c \
d216 20
a235 3
cp $d_src/share/mk/*.mk $d_build/mk/
cp $d_src/include/{getopt,md4,md5,rmd160,sha1,sha2}.h \
    $d_script/../contrib/mirmake.h $d_build/F/
d248 5
d254 1
a254 11
if [[ $binown = - ]]; then
	binown=$(id -un)
	[[ $binown = *@@( )* ]] && binown=$(id -u)
	bingrp=$(id -gn)
	[[ $bingrp = *@@( )* ]] && bingrp=$(id -g)
fi
print "/^BINOWN/s/root/$binown/p\n/^BINGRP/s/bin/$bingrp/p\nwq" \
    | ed -s $d_build/mk/bsd.own.mk

# Build dummy libmirmake
export LDFLAGS="$LDFLAGS -L$top/tmpx -lmirmake"
d256 3
a258 4
echo 'void dummy(void) { }' >dummy.c
$CC -c dummy.c
rm -f libmirmake.a
ar rcs libmirmake.a dummy.o
d262 1
a262 1
if ! $OLDMAKE -f Makefile.boot bmake CC="$CC" MACHINE="${new_machin}" \
d264 2
a265 2
    MKSH="${new_mirksh}"; then
	echo "Error: build failure" >&2
d267 18
d286 29
d316 6
a321 1
# Build libmirmake
d323 1
a323 1
# Build the paper
d325 1
a325 1
pic <PSD.doc/tutorial.ms >PSD12.make.ms.tbl 2>/dev/null \
d327 1
a327 1
tbl <PSD12.make.ms.tbl >PSD12.make.ms 2>/dev/null \
d329 1
a329 1
$NROFF -ms PSD12.make.ms >PSD12.make.txt 2>/dev/null \
d331 9
d341 1
a341 1
# Generate installer
d344 1
a344 1
#!${new_mirksh}
d347 1
d351 10
a360 59
\$i -c -s \$ug -m 555 ${d_build}/make \$DESTDIR${dt_bin}/${new_exenam}
\$i -c \$ug -m 555 ${d_build}/mkdep.sh \$DESTDIR${dt_bin}/mkdep
\$i -c \$ug -m 555 $d_src/usr.bin/lorder/lorder.sh \$DESTDIR${dt_bin}/lorder
\$i -c \$ug -m 444 $d_build/F/*.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/sysexits.h \$DESTDIR${dt_mk}/
EOF
for f in ${d_build}/mk/*.mk; do
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $f \$DESTDIR${dt_mk}/
EOF
done
# build make manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc make.1 >make.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/make.1 \$DESTDIR${dt_man}/${new_exenam}.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/make.cat1 \$DESTDIR${dt_man}/${new_exenam}.0
EOF
fi
# build mkdep manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc $d_src/usr.bin/mkdep/mkdep.1 >mkdep.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_src/usr.bin/mkdep/mkdep.1 \$DESTDIR${dt_man}/mkdep.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/mkdep.cat1 \$DESTDIR${dt_man}/mkdep.0
EOF
fi
# build lorder manpage
if [[ $is_catman = 1 ]]; then
	cd $d_build
	if ! $NROFF -mandoc $d_src/usr.bin/lorder/lorder.1 >lorder.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_src/usr.bin/lorder/lorder.1 \$DESTDIR${dt_man}/lorder.1
d362 2
a363 9
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/lorder.cat1 \$DESTDIR${dt_man}/lorder.0
EOF
fi
# build make documentation
if [[ -e $d_build/PSD12.make.txt ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_build/PSD12.make.txt \$DESTDIR${dt_mk}/
a364 38
fi

# check for fgetln, strlcpy/strlcat, stdbool.h
add_fgetln=
if testfunc 'char *fgetln(FILE *, size_t *)' 'fgetln(stdin, &x)' \
    '#include <stdio.h>' 'size_t x;'; then
	add_fgetln=$d_build/fgetln.o
fi
add_strlfun=
if testfunc 'size_t strlcpy(char *, const char *, size_t)' \
    'strlcpy(dst, src, 1)' '#include <stddef.h>' \
    'char src[3] = "Hi", dst[3];'; then
	add_strlfun=strlfun.c
fi
stdboolh=
if ! testfunc 'void exit(int)' 'exit(t == false)' \
    '#include <stdbool.h>' 'bool t = true;'; then
	stdboolh=-DHAS_STDBOOL_H
fi

# build readlink
rm -rf $d_build/readlink
cd $d_src/usr.bin; find readlink | cpio -pdlu $d_build
cd $d_build/readlink
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes
export PATH=${d_build}/readlink:$PATH
cd $top
cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/readlink/readlink \$DESTDIR${dt_bin}/
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/readlink
	if ! $NROFF -mandoc readlink.1 >readlink.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
d367 6
a372 1
\$i -c \$ug -m 444 ${d_build}/readlink/readlink.1 \$DESTDIR${dt_man}/readlink.1
d376 6
a381 1
\$i -c \$ug -m 444 ${d_build}/readlink/readlink.cat1 \$DESTDIR${dt_man}/readlink.0
a383 9

# build tsort
rm -rf $d_build/tsort
cd $d_src/usr.bin; find tsort | cpio -pdlu $d_build
cd $d_build/tsort
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    INCS="-I $d_build" LIBS="$d_build/ohash/libohash.a $add_fgetln"
export PATH=${d_build}/tsort:$PATH
cd $top
d385 5
a389 47
\$i -c -s \$ug -m 555 ${d_build}/tsort/tsort \$DESTDIR${dt_bin}/
EOF
if [[ $is_catman = 1 ]]; then
	cd $d_build/tsort
	if ! $NROFF -mandoc tsort.1 >tsort.cat1; then
		echo "Warning: manpage build failure." >&2
		is_catman=0
	fi
	cd $top
fi
if [[ $is_catman = 0 ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/tsort/tsort.1 \$DESTDIR${dt_man}/tsort.1
EOF
else
	cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/tsort/tsort.cat1 \$DESTDIR${dt_man}/tsort.0
EOF
fi

if [[ $new_machos = Interix ]]; then
	# build xinstall
	rm -rf $d_build/xinstall
	cd $d_src/usr.bin; find xinstall | cpio -pdlu $d_build
	cd $d_build/xinstall
	CPPFLAGS="$CPPFLAGS -I$d_src/include" \
	    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes
	cd $top
	cat >>Install.sh <<EOF
\$i -c -s \$ug -m 555 ${d_build}/xinstall/xinstall \$DESTDIR${dt_bin}/
mv \$DESTDIR${dt_bin}/xinstall \$DESTDIR${dt_bin}/install
EOF
	if [[ $is_catman = 1 ]]; then
		cd $d_build/xinstall
		if ! $NROFF -mandoc install.1 >install.cat1; then
			echo "Warning: manpage build failure." >&2
			is_catman=0
		fi
		cd $top
	fi
	if [[ $is_catman = 0 ]]; then
		cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.1 \$DESTDIR${dt_man}/install.1
EOF
	else
		cat >>Install.sh <<EOF
\$i -c \$ug -m 444 ${d_build}/xinstall/install.cat1 \$DESTDIR${dt_man}/install.0
a390 65
	fi
fi

# build libmirmake (hash stuff and necessities)
rm -rf $d_build/libmirmake
mkdir $d_build/libmirmake
cd $d_build/libmirmake
sed -e 's/hashinc/md4.h/g' -e 's/HASH/MD4/g' \
    $d_src/lib/libc/hash/helper.c >md4hl.c
sed -e 's/hashinc/md5.h/g' -e 's/HASH/MD5/g' \
    $d_src/lib/libc/hash/helper.c >md5hl.c
sed -e 's/hashinc/rmd160.h/g' -e 's/HASH/RMD160/g' \
    $d_src/lib/libc/hash/helper.c >rmd160hl.c
sed -e 's/hashinc/sha1.h/g' -e 's/HASH/SHA1/g' \
    $d_src/lib/libc/hash/helper.c >sha1hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA256_/g' \
    $d_src/lib/libc/hash/helper.c >sha256hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA384_/g' \
    $d_src/lib/libc/hash/helper.c >sha384hl.c
sed -e 's/hashinc/sha2.h/g' -e 's/HASH_\{0,1\}/SHA512_/g' \
    $d_src/lib/libc/hash/helper.c >sha512hl.c
cp  $d_src/lib/libc/hash/{md4,md5,rmd160,sha1,sha2}.c \
    $d_src/lib/libc/string/strlfun.c \
    $d_src/lib/libc/stdlib/{getopt_long,strtoll}.c \
    $d_src/lib/libc/stdio/{{,v}asprintf,mktemp}.c \
    $d_script/../contrib/*.c .
EXTRA_SRCS="${add_fgetln%.[co]}.c $add_strlfun"
if testfunc 'uint32_t arc4random_pushb(const void *, size_t)' \
    'arc4random_pushb(buf, 4)' '#include <stddef.h>' \
    'char buf[] = "test";'; then
	EXTRA_SRCS="$EXTRA_SRCS arc4random.c"
	if ! testfunc 'void arc4random_addrandom(unsigned char *, int)' \
	    'arc4random_addrandom(buf, 4)' '' \
	    'char buf[] = "test";'; then
		CPPFLAGS="$CPPFLAGS -D_ARC4RANDOM_WRAP"
	fi
fi
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes \
    EXTRA_SRCS="$EXTRA_SRCS" clean
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes \
    EXTRA_SRCS="$EXTRA_SRCS"
cd $top
if [[ -s $d_build/libmirmake/libmirmake.a ]]; then
	cat >>Install.sh <<EOF
\$i -c \$ug -m 600 $d_build/libmirmake/libmirmake.a \$DESTDIR${dt_mk}/
ranlib \$DESTDIR${dt_mk}/libmirmake.a
chmod 444 \$DESTDIR${dt_mk}/libmirmake.a
EOF
fi

# re-build bmake
cd ${d_build}
mkf="$stdboolh -D_PATH_DEFSYSPATH=\\\"${dt_mk}\\\""
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
    LIBS=$d_build/libmirmake/libmirmake.a clean
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
    MKDEP_SH="${new_mirksh} ${d_build}/mkdep.sh" \
    LIBS=$d_build/libmirmake/libmirmake.a depend
${d_build}/bmake -m ${d_build}/mk NOMAN=yes NOOBJ=yes \
    MAKE_BOOTSTRAP=Yes MKFEATURES="$mkf" \
    LIBS=$d_build/libmirmake/libmirmake.a make

chmod 555 $top/Install.sh
d392 1
@


1.74
log
@experimental:
* add arc4random(3) (all archs) and arc4random_pushb(3) (as wrapper)
  to libmirmake
* provide libmirmake as shared library (to be able to LDADD it)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.73 2006/08/26 15:47:46 tg Exp $
d82 1
d165 2
d238 8
d255 2
@


1.73
log
@a few lections from "portable shell",
and apply mksh(1)'s nroff for GNU fix
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.72 2006/08/26 15:40:13 tg Exp $
d342 2
a343 1
    'strlcpy(dst, src, 1)' '' 'char src[3] = "Hi", dst[3];'; then
d461 13
a473 1
    $d_src/lib/libc/stdio/{{,v}asprintf,mktemp}.c .
d475 1
a475 1
    EXTRA_SRCS="${add_fgetln%.[co]}.c $add_strlfun" clean
d477 1
a477 1
    EXTRA_SRCS="${add_fgetln%.[co]}.c $add_strlfun"
@


1.72
log
@don't pollute /usr/bin on Interix, sync style, licence
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d58 9
a66 10
new_ostype="$1"
new_prefix="$2"		# /usr/local
new_manpth="$3"		# man/cat
new_exenam="$4"		# bmake
new_machin="$5"		# MACHINE
new_macarc="$6"		# MACHINE_ARCH
new_machos="$7"		# MACHINE_OS
new_mirksh="$8"
new_binids="$9"
[[ -z $OLDMAKE ]] && OLDMAKE=make
d76 1
d95 1
a95 1
case "$new_machos:$new_machin:$new_macarc" in
d157 6
a162 5
export CC="${CC:-gcc}"
export COPTS="${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing}"
export CPPFLAGS="$CPPFLAGS -D_MIRMAKE_DEFNS -isystem $d_build/F -include $d_build/F/mirmake.h"
export CFLAGS="$COPTS $CPPFLAGS"
export NROFF="${NROFF:-nroff}"
@


1.71
log
@we need the full path in ${_MIRMAKE_EXE}
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.70 2005/12/17 05:46:09 tg Exp $
d4 2
a5 2
# Copyright (c) 2004, 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d14 2
a15 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d25 1
a25 1
# the possibility of such damage or existence of a nontrivial bug.
d80 2
a108 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d110 1
a110 2
	/usr/bin/install -c -m 555 $d_script/../contrib/mktemp.sh \
	    /usr/bin/mktemp
d126 1
@


1.70
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.69 2005/11/24 20:18:20 tg Exp $
d193 1
@


1.69
log
@allow user to specify the oldmake to use
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.68 2005/11/24 20:17:04 tg Exp $
d18 8
a25 7
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
@


1.68
log
@whoops, too early
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.67 2005/11/24 20:13:50 tg Exp $
d66 1
d140 1
a140 1
		if X=$(make -f $T all); then
d233 1
a233 1
if ! make -f Makefile.boot bmake CC="$CC" MACHINE="${new_machin}" \
@


1.67
log
@propagate binown/bingrp through to <bsd.own.mk>
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.66 2005/11/24 19:28:12 tg Exp $
a153 6
if [[ $binown = - ]]; then
	ug=
else
	ug="\"-o $binown -g $bingrp\""
fi

d172 5
@


1.66
log
@remove Makefile.boot.ed - we don't install the bmake built using
it anyway, and can pass the remainder of the parameters via cmdline
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.65 2005/11/24 14:13:28 tg Exp $
d104 1
d154 6
d222 5
a226 3
if [[ $new_machos = Interix ]]; then
	print "/^BINOWN/s/root/$(id -un)/p\n/^BINGRP/s/bin/$(id -gn \
	    | sed -e 's/ /\\ /g')/p\nwq" | ed -s $d_build/mk/bsd.own.mk
d228 2
a250 5
if [[ $binown = - ]]; then
	ug=
else
	ug="\"-o $binown -g $bingrp\""
fi
@


1.65
log
@make clean first for libmirmake, too ;)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.64 2005/11/24 14:08:41 tg Exp $
d204 1
a204 2
for ps in Makefile.boot mk/bsd.own.mk mk/bsd.prog.mk \
    mk/bsd.sys.mk make.1 mk/sys.mk mkdep.sh; do
d222 3
a224 1
if ! make -f Makefile.boot bmake CC="$CC"; then
@


1.64
log
@make mkdep succeed
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.63 2005/11/24 14:06:24 tg Exp $
d451 2
@


1.63
log
@more escapes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.62 2005/11/24 14:03:18 tg Exp $
d469 1
@


1.62
log
@do all detection in one piece
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.61 2005/11/24 14:01:26 tg Exp $
d463 1
a463 1
mkf="$stdboolh -D_PATH_DEFSYSPATH=\"${dt_mk}\""
@


1.61
log
@be nicer
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.60 2005/11/24 13:56:51 tg Exp $
d323 17
a367 7
# check for fgetln
add_fgetln=
if testfunc 'char *fgetln(FILE *, size_t *)' 'fgetln(stdin, &x)' \
    '#include <stdio.h>' 'size_t x;'; then
	add_fgetln=$d_build/fgetln.o
fi

a427 7
# check for strlcpy and strlcat
add_strlfun=
if testfunc 'size_t strlcpy(char *, const char *, size_t)' \
    'strlcpy(dst, src, 1)' '' 'char src[3] = "Hi", dst[3];'; then
	add_strlfun=strlfun.c
fi

d463 1
d465 2
a466 6
    MAKE_BOOTSTRAP=Yes clean
mkf="-D_PATH_DEFSYSPATH=\"${dt_mk}\""
if ! testfunc 'void exit(int)' 'exit(t == false)' \
    '#include <stdbool.h>' 'bool t = true;'; then
	mkf="$mkf -DHAS_STDBOOL_H"
fi
@


1.60
log
@add a make depend step
include already-built fgetln.o in tsort
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.59 2005/11/24 13:40:07 tg Exp $
d50 1
a50 1
	    NOMAN=yes NOOBJ=yes ) #>/dev/null 2>&1
@


1.59
log
@rebuild bmake with itself afterwards
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.58 2005/11/24 13:32:53 tg Exp $
d355 1
a355 1
	add_fgetln=$d_build/fgetln.c
d448 1
a448 1
    EXTRA_SRCS="$add_fgetln $add_strlfun"
d469 3
@


1.58
log
@use make's fgetln.c
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.57 2005/11/24 12:08:56 tg Exp $
d251 1
a251 1
\$i -c -s \$ug -m 555 ${d_build}/bmake \$DESTDIR${dt_bin}/${new_exenam}
d458 13
@


1.57
log
@convert testfunc to return logic
fix missing semicolon
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.56 2005/11/24 11:41:33 tg Exp $
d355 1
a355 8
	if testfunc 'ssize_t getline(char **, size_t *, FILE *)' \
	    'getline(&y, &x, stdin)' '#include <stdio.h>' \
	    'size_t x; char *y;'; then
		print -u2 Error: please supply an fgetln function.
		exit 1
	else
		add_fgetln=$d_script/../contrib/gfgetln.c
	fi
@


1.56
log
@convert strlfun.c to autodetected
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.55 2005/11/24 11:36:27 tg Exp $
d31 2
d34 1
d50 2
a51 6
	    NOMAN=yes NOOBJ=yes )
	if [[ -x $d_build/testfunc/testfunc ]]; then
		print yes
	else
		print no
	fi
d53 1
d353 3
a355 3
if [[ $(testfunc 'char *fgetln(FILE *, size_t *)' 'fgetln(stdin, &x)' \
    '#include <stdio.h>' 'size_t x;') = no ]]; then
	if [[ $(testfunc 'ssize_t getline(char **, size_t *, FILE *)' \
d357 1
a357 1
	    'size_t x; char *y') = no ]]; then
d427 2
a428 2
if [[ $(testfunc 'size_t strlcpy(char *, const char *, size_t)' \
    'strlcpy(dst, src, 1)' '' 'char src[3] = "Hi", dst[3];') = no ]]; then
@


1.55
log
@* add testfunc() to check for the existence of functions,
  autoconf-style instead of imake-style
* check for fgetln(3) and replace it with hand-made version
  using GNU getline(3)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.54 2005/11/24 11:06:46 tg Exp $
d425 7
d455 1
a455 1
    EXTRA_SRCS="$add_fgetln"
@


1.54
log
@use the readlink and tsort we just built
discovered while building on a
Linux MyLinuxSys.net 2.6.11 #2 SMP Wed Mar 2 11:48:51 CET 2005 i686 GNU/Linux
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.53 2005/09/19 18:52:24 tg Exp $
d29 27
d351 14
d370 1
a370 1
    INCS="-I $d_build" LIBS="$d_build/ohash/libohash.a"
d447 2
a448 1
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib NOOBJ=yes
@


1.53
log
@add HAVE_STRLCPY and HAVE_STRLCAT to CPPFLAGS during mirmake build time,
to avoid the dup sym warnings on bmake link time (Darwin only)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.52 2005/09/19 18:50:21 tg Exp $
d301 1
d330 1
@


1.52
log
@build all these with NOOBJ=yes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.51 2005/09/19 18:44:45 tg Exp $
d91 1
@


1.51
log
@build readlink with NOOBJ=yes to prevent <bsd.obj.mk> (using readlink)
from being pulled in (even if not used), yielding errors in cmd subst
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.50 2005/09/18 21:10:29 tg Exp $
d326 1
a326 1
${d_build}/bmake -m ${d_build}/mk NOMAN=yes \
d356 1
a356 1
	    ${d_build}/bmake -m ${d_build}/mk NOMAN=yes
d403 1
a403 1
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib
@


1.50
log
@no need to edit bsd.man.mk any more
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.49 2005/09/18 20:19:13 tg Exp $
d299 1
a299 1
${d_build}/bmake -m ${d_build}/mk NOMAN=yes
@


1.49
log
@these contributed files can now be pulled from base
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.48 2005/09/12 22:24:58 tg Exp $
d176 1
a176 1
for ps in Makefile.boot mk/bsd.man.mk mk/bsd.own.mk mk/bsd.prog.mk \
@


1.48
log
@only define protos for strlcpy and strlcat if _MIRMAKE_DEFNS
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.47 2005/09/01 22:27:33 tg Exp $
a384 1
cp $d_script/../contrib/*.c .
d399 4
a402 2
cp $d_src/lib/libc/hash/{md4,md5,rmd160,sha1,sha2}.c .
cp $d_src/lib/libc/string/strlfun.c $d_src/lib/libc/stdlib/getopt_long.c .
@


1.47
log
@* include GNU config.guess
* call GNU config.guess; provide appropriate ${OStriplet} default
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.46 2005/08/21 12:15:22 tg Exp $
d127 1
a127 1
export CPPFLAGS="$CPPFLAGS -isystem $d_build/F -include $d_build/F/mirmake.h"
@


1.46
log
@devise OBJECT_FMT and RTLD_TYPE better
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.45 2005/08/21 11:56:04 tg Exp $
d144 5
d159 1
@


1.45
log
@add mbcompat stuff from mirports pkgtools to libmirmake (on interix)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.44 2005/08/21 11:28:07 tg Exp $
d87 38
d155 2
@


1.44
log
@replace nroff by @@@@nroff@@@@ (make it variable)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.43 2005/06/09 22:14:32 tg Exp $
d339 1
d354 1
a354 2
( cd $d_src/lib/libc/hash; \
  cp md4.c md5.c rmd160.c sha1.c sha2.c $d_build/libmirmake/ )
a355 1
cp $d_script/../contrib/{,v}asprintf.c .
@


1.43
log
@bundle <sysexits.h> with mirmake too
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.42 2005/06/09 22:07:31 tg Exp $
d115 1
@


1.42
log
@move some conditional out  of Install.sh
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.41 2005/06/09 21:57:46 tg Exp $
d180 1
@


1.41
log
@distribute mirmake version alongside
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.40 2005/06/09 21:51:15 tg Exp $
d164 5
d173 1
a173 5
if [[ $binown = - ]]; then
	ug=
else
	ug="-o $binown -g $bingrp"
fi
@


1.40
log
@conditionalise nroff binary
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.39 2005/06/09 21:50:36 tg Exp $
d93 2
d115 1
@


1.39
log
@* be more bash friendly (except for interix, where we can use print)
* reduce number of cp(1) calls by consolidation
* errors to fd 2
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.38 2005/06/09 21:45:14 tg Exp $
d91 1
d156 1
a156 1
nroff -ms PSD12.make.ms >PSD12.make.txt 2>/dev/null \
d185 1
a185 1
	if ! nroff -mandoc make.1 >make.cat1; then
d203 1
a203 1
	if ! nroff -mandoc $d_src/usr.bin/mkdep/mkdep.1 >mkdep.cat1; then
d221 1
a221 1
	if ! nroff -mandoc $d_src/usr.bin/lorder/lorder.1 >lorder.cat1; then
d254 1
a254 1
	if ! nroff -mandoc readlink.1 >readlink.cat1; then
d282 1
a282 1
	if ! nroff -mandoc tsort.1 >tsort.cat1; then
d312 1
a312 1
		if ! nroff -mandoc install.1 >install.cat1; then
@


1.38
log
@provide support for bash's half-wit ksh emulation, in the hope it will suffice
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.37 2005/06/08 10:03:24 tg Exp $
d41 1
a41 1
	echo "Use ../../Build.sh instead!"
d64 1
a64 1
case "$new_machos:$new_machin:$new_macarc" {
d85 1
a85 1
}
d103 1
a103 1
mkdir -p $d_build/mk
d117 3
a120 6
cp $d_src/include/*.h $d_build/
(cd $d_src/lib/libc; find ohash | cpio -pdlu $d_build)
cp $d_src/lib/libc/stdlib/getopt_long.c $d_build/
cp $d_src/lib/libc/string/strlfun.c $d_build/
cp $d_src/usr.bin/mkdep/mkdep.sh $d_build/
mkdir -p $d_build/F
d132 1
a132 1
		echo "Error in $d_build/$ps.tmp"
d145 1
a145 1
	echo "Error: build failure"
d185 1
a185 1
		echo "Warning: manpage build failure."
d203 1
a203 1
		echo "Warning: manpage build failure."
d221 1
a221 1
		echo "Warning: manpage build failure."
d254 1
a254 1
		echo "Warning: manpage build failure."
d282 1
a282 1
		echo "Warning: manpage build failure."
d312 1
a312 1
			echo "Warning: manpage build failure."
@


1.37
log
@bundle and use {,v}asprintf in libmirmake - Interix only
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.36 2005/06/02 23:35:08 tg Exp $
d47 2
@


1.36
log
@no tab in front of here document closer
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.35 2005/06/02 23:30:51 tg Exp $
d350 1
@


1.35
log
@pass include path to xinstall so it gets <sysexits.h>
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.34 2005/06/02 23:13:45 tg Exp $
d309 1
a309 1
	EOF
d321 1
a321 1
	EOF
d325 1
a325 1
	EOF
@


1.34
log
@same for mkdep(1), oopsie
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.33 2005/06/02 23:11:27 tg Exp $
d303 2
a304 1
	${d_build}/bmake -m ${d_build}/mk NOMAN=yes
@


1.33
log
@missed lorder(1) man page
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.32 2005/06/02 23:08:03 tg Exp $
d182 1
d200 19
d236 1
@


1.32
log
@smaller
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.31 2005/06/02 23:05:03 tg Exp $
d199 17
@


1.31
log
@use cpio, not tar; use -l to speed up if possible
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.30 2005/06/02 22:58:18 tg Exp $
d77 2
a78 2
	cp $d_script/../contrib/mktemp.sh /usr/bin/
	chmod 555 /usr/bin/mktemp.sh && mv /usr/bin/mktemp.sh /usr/bin/mktemp
@


1.30
log
@add mktemp (from ports/infrastructure/install/) and xinstall
only used on Interix because their base is such a shit
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.29 2005/05/25 23:50:31 tg Exp $
d114 1
a114 1
(cd $d_src/usr.bin/make; tar cf - * ) | (cd $d_build; tar xf - )
d117 1
a117 1
(cd $d_src/lib/libc; tar cf - ohash ) | (cd $d_build; tar xf - )
d207 1
a207 1
mkdir $d_build/readlink
a208 1
(cd $d_src/usr.bin/readlink; tar cf - * ) | tar xf -
d234 1
a234 1
mkdir $d_build/tsort
a235 1
(cd $d_src/usr.bin/tsort; tar cf - * ) | tar xf -
d263 1
a263 1
	mkdir $d_build/xinstall
a264 1
	(cd $d_src/usr.bin/xinstall; tar cf - * ) | tar xf -
@


1.29
log
@mksh is pretty mature; switch most of contrib/ to it
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.28 2005/05/21 17:03:52 tg Exp $
d77 2
d262 31
@


1.28
log
@arc4random suffers from random pool depletion when being used
on systems with /dev/urandom with mksh (being used often)

this must be solved differently, by an arc4randomd
@
text
@d1 2
a2 2
#!/bin/ksh
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.27 2005/05/21 15:46:39 tg Exp $
@


1.27
log
@this sed needs a g
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.26 2005/05/21 15:38:52 tg Exp $
d280 1
a280 2
cp $d_src/lib/libc/string/strlfun.c $d_src/lib/libc/stdlib/getopt_long.c \
    $d_script/../contrib/arc4random.c .
@


1.26
log
@extend by arc4random() from ports/in*/pkgtools/mbcompat/bsd-arc4random.c
enhanced by arc4random_push() pseudo (which works)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.25 2005/05/21 15:24:00 tg Exp $
d101 8
a108 8
sed_exp="-e 's#@@@@machine@@@@#${new_machin}#' \
	 -e 's#@@@@march@@@@#${new_macarc}#' \
	 -e 's#@@@@machos@@@@#${new_machos}#' \
	 -e 's#@@@@mksh@@@@#${new_mirksh}#' \
	 -e 's#@@@@ostype@@@@#${new_ostype}#' \
	 -e 's#@@@@shmk@@@@#${dt_mk}#' \
	 -e 's#@@@@ccom@@@@#${CC}#' \
	 -e 's#@@@@bmake@@@@#${new_exenam}#'"
@


1.25
log
@fix building with a lot more includes
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.24 2005/05/21 15:03:01 tg Exp $
d280 2
a281 1
cp $d_src/lib/libc/string/strlfun.c $d_src/lib/libc/stdlib/getopt_long.c .
@


1.24
log
@* getopt_long.c (our compatible getopt) joins libmirmake
* the mirmake dir is now added to the include search path
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.23 2005/05/21 14:56:47 tg Exp $
d85 1
a85 2
export CPPFLAGS="$CPPFLAGS -isystem $d_script/../contrib \
    -include $d_script/../contrib/mirmake.h"
d119 3
d173 1
a202 5
cat >>Install.sh <<EOF
\$i -c \$ug -m 444 $d_script/../contrib/mirmake.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/getopt.h \$DESTDIR${dt_mk}/
EOF

d281 1
a281 2
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.lib \
    INCS="-I$d_src/include" libmirmake.a
a287 5
\$i -c \$ug -m 444 $d_src/include/md4.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/md5.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/rmd160.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/sha1.h \$DESTDIR${dt_mk}/
\$i -c \$ug -m 444 $d_src/include/sha2.h \$DESTDIR${dt_mk}/
@


1.23
log
@* libhash becomes libmirmake
* strlcpy and strlcat join libmirmake
* libmirmake is built using <bsd.lib.mk>

agreed bsiegert@@
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.22 2005/05/20 23:18:34 tg Exp $
d85 2
a86 1
export CPPFLAGS="$CPPFLAGS -include $d_script/../contrib/mirmake.h"
d202 1
d282 1
a282 1
cp $d_src/lib/libc/string/strlfun.c .
@


1.22
log
@we also need readlink(1), it's being used
extensively recently as realpath(3) frontend
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.21 2005/05/20 22:50:41 tg Exp $
a199 1
\$i -c \$ug -m 444 $d_src/lib/libc/string/strlfun.c \$DESTDIR${dt_mk}/
d260 4
a263 4
# build the hash stuff
rm -rf $d_build/hash
mkdir $d_build/hash
cd $d_build/hash
d279 4
a282 3
  cp md4.c md5.c rmd160.c sha1.c sha2.c $d_build/hash/ )
${d_build}/bmake -m ${d_build}/mk -f $d_script/Makefile.hash \
    INCS="-I$d_src/include" libhash.a
d284 1
a284 1
if [[ -s $d_build/hash/libhash.a ]]; then
d286 3
a288 3
\$i -c \$ug -m 600 $d_build/hash/libhash.a \$DESTDIR${dt_mk}/
ranlib \$DESTDIR${dt_mk}/libhash.a
chmod 444 \$DESTDIR${dt_mk}/libhash.a
@


1.21
log
@we need "lorder" at least on Interix
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.20 2005/04/13 19:08:13 tg Exp $
d204 28
@


1.20
log
@on Interix, replace root:bin by the user:group (alphabetically)
which is currently active
XXX groups with spaces in
XXX if I use numeric values, what if they ever change?
for now, escape spaces manually in there (by script)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.19 2005/04/12 20:31:51 tg Exp $
d169 1
@


1.19
log
@change Darwin/x86 machine=i686 machine_arch=i386
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.18 2005/04/12 19:10:37 tg Exp $
d133 5
@


1.18
log
@whoops, this needs to ranlib libhash.a (bsiegert@@ did you not notice?)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.17 2005/04/12 17:11:56 tg Exp $
d66 2
d71 2
a72 1
	[[ $new_macarc = *86 ]] && new_macarc=i686
@


1.17
log
@some more fixes and simplifications
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $
d249 3
a251 1
\$i -c \$ug -m 444 $d_build/hash/libhash.a \$DESTDIR${dt_mk}/
@


1.16
log
@if we're ever going to auto-install this on Interix,
we need to get rid of forced -o root -g bin at install
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.15 2005/04/12 10:29:12 tg Exp $
a61 4
# ... in case user specifies CC= CFLAGS= in ./Build.sh environment
export CC="${CC:-gcc}"
export COPTS="${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing}"

d80 2
@


1.15
log
@add -D_ALL_SOURCE on interix and handle CPPFLAGS
untested
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.14 2005/04/12 10:18:44 tg Exp $
d154 5
a158 1
ug="-o $binown -g $bingrp"
@


1.14
log
@strong binding of CC to system make
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.13 2005/04/12 10:17:51 tg Exp $
d64 1
a64 3
COPTS="${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing}"
export CFLAGS="${COPTS} -include $d_script/../contrib/mirmake.h"
export COPTS="$CFLAGS"
d75 4
d84 3
@


1.13
log
@use the mirmake just built to build libhash.a
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.12 2005/04/12 10:15:29 tg Exp $
d129 1
a129 1
if ! make -f Makefile.boot bmake; then
@


1.12
log
@* add strong defines of CC, CFLAGS
* add mirmake.h to CFLAGS, COPTS (for build)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.11 2005/04/11 15:44:49 tg Exp $
d237 2
a238 2
make -f $d_script/Makefile.hash libhash.a \
    INCS="-include $d_script/../contrib/mirmake.h -I$d_src/include"
@


1.11
log
@default ${CC} and ${HOSTCC} not to "cc"
but to the $CC given to Build.sh (or "gcc" if not given)
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.10 2005/02/28 21:56:30 tg Exp $
a46 8
# ... in case user specifies CC= CFLAGS= in ./Build.sh environment
if [[ -n $CFLAGS ]]; then
	export COPTS="$CFLAGS"
fi

# ... and if not
[[ -n $CC ]] || CC=gcc

d62 6
@


1.10
log
@fix location of ohash.h
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.9 2005/02/28 21:52:31 tg Exp $
d52 3
d103 1
@


1.9
log
@no surprise that '-I $d_build/ohash' doesn't work
s/'/"/
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.8 2005/02/28 21:46:22 tg Exp $
d192 1
a192 1
    INCS="-I $d_build/ohash" LIBS="$d_build/ohash/libohash.a"
@


1.8
log
@really add ohash
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.7 2005/02/28 21:43:15 tg Exp $
d192 1
a192 1
    INCS='-I $d_build/ohash' LIBS='$d_build/ohash/libohash.a'
@


1.7
log
@amend MirMake by tsort
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.6 2005/02/26 14:04:59 tg Exp $
d191 2
a192 1
${d_build}/bmake -m ${d_build}/mk NOMAN=yes
@


1.6
log
@implement using same stuff
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.5 2005/02/26 13:53:24 tg Exp $
d186 28
@


1.5
log
@experimental: copy the hashes, too
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.4 2005/02/26 13:38:25 tg Exp $
d206 2
a207 11
for f in *.c; do
	${CC:-cc} $CFLAGS -c -include $d_script/../contrib/mirmake.h \
	    -I$d_src/include $f || touch failure
done
if [[ ! -e failure ]]; then
	if ar rc libhash.a *.o; then
		ranlib libhash.a
	else
		rm -f libhash.a
	fi
fi
@


1.4
log
@cope better with manpage failures
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.3 2005/02/23 21:40:55 tg Exp $
d186 43
@


1.3
log
@allow installation as user
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.2 2005/02/23 21:35:09 tg Exp $
d4 1
a4 1
# Copyright (c) 2004
d158 8
a173 5
	cd $d_build
	if ! nroff -mandoc make.1 >make.cat1; then
		echo "Warning: manpage build failure."
	fi
	cd $top
@


1.2
log
@improve MACHINE_ARCH handling
@
text
@d2 1
a2 1
# $MirOS: contrib/code/mirmake/dist/scripts/Build.sh,v 1.1.7.1 2005/02/05 02:36:15 tg Exp $
d38 1
d81 11
d147 1
d150 2
a151 4
\$i -c -s -o root -g bin -m 555 ${d_build}/bmake \
    \$DESTDIR${dt_bin}/${new_exenam}
\$i -c -o root -g bin -m 555 ${d_build}/mkdep.sh \
    \$DESTDIR${dt_bin}/mkdep
d155 1
a155 1
\$i -c -o root -g bin -m 444 $f \$DESTDIR${dt_mk}/
d160 1
a160 2
\$i -c -o root -g bin -m 444 ${d_build}/make.1 \
    \$DESTDIR${dt_man}/${new_exenam}.1
d164 1
a164 2
\$i -c -o root -g bin -m 444 ${d_build}/make.cat1 \
    \$DESTDIR${dt_man}/${new_exenam}.0
d174 1
a174 1
\$i -c -o root -g bin -m 444 $d_build/PSD12.make.txt \$DESTDIR${dt_mk}/
d179 2
a180 4
\$i -c -o root -g bin -m 444 $d_src/lib/libc/string/strlfun.c \
    \$DESTDIR${dt_mk}/
\$i -c -o root -g bin -m 444 $d_script/../contrib/mirmake.h \
    \$DESTDIR${dt_mk}/
@


1.1
log
@Initial revision
@
text
@d2 1
a2 1
# $MirOS$
d66 14
@


1.1.7.1
log
@All the code in the contributed section
@
text
@@
