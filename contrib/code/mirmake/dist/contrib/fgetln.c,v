head	1.7;
access;
symbols;
locks; strict;
comment	@ * @;


1.7
date	2014.12.20.22.23.29;	author tg;	state Exp;
branches;
next	1.6;
commitid	1005495F6F637869BF8;

1.6
date	2009.11.21.14.50.27;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004B07FE38054E8FD5;

1.5
date	2009.05.20.10.40.28;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004A13DDFB73230F1E;

1.4
date	2009.05.20.10.22.33;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004A13D9DF49EA4B4F;

1.3
date	2008.04.06.22.35.24;	author tg;	state Exp;
branches;
next	1.2;
commitid	10047F9503D08FFB97C;

1.2
date	2007.03.31.00.04.54;	author tg;	state Exp;
branches;
next	1.1;
commitid	100460DA5A9372894D1;

1.1
date	2007.03.31.00.03.50;	author tg;	state Exp;
branches;
next	;
commitid	100460DA54E67884FE9;


desc
@@


1.7
log
@fix redefinition warning
@
text
@/*-
 * Copyright (c) 2007, 2009
 *	Thorsten Glaser <tg@@mirbsd.org>
 *
 * Provided that these terms and disclaimer and all copyright notices
 * are retained or reproduced in an accompanying document, permission
 * is granted to deal in this work without restriction, including un-
 * limited rights to use, publicly perform, distribute, sell, modify,
 * merge, give away, or sublicence.
 *
 * This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
 * the utmost extent permitted by applicable law, neither express nor
 * implied; without malicious intent or gross negligence. In no event
 * may a licensor, author or contributor be held liable for indirect,
 * direct, other damage, loss, or other issues arising in any way out
 * of dealing in the work, even if advised of the possibility of such
 * damage or existence of a defect, except proven that it results out
 * of said person's immediate fault when using the work as intended.
 *-
 * fgetln() wrapper for operating systems with getline() – glibc
 */

#undef _GNU_SOURCE
#define _GNU_SOURCE		/* for getline() */
#include <sys/types.h>
#include <stdio.h>
#include <string.h>

__RCSID("$MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.6 2009/11/21 14:50:27 tg Exp $");

#if defined(__GLIBC__)

#if !defined(_MIRMAKE_H) || !defined(_MIRMAKE_DEFNS)
char *fgetln(FILE *, size_t *);
#endif

char *
fgetln(FILE *stream, size_t *len)
{
	static char *lb = NULL;
	static size_t lbsz = 0;

	if ((*len = getline(&lb, &lbsz, stream)) != (size_t)-1)
		/* getdelim ensures *len is not 0 here */
		return (lb);

	/* not required by manpage, but reference implementation does this */
	*len = 0;

	/* not required to zero lb or lbsz: getdelim manages it */
	return (NULL);
}
#endif
@


1.6
log
@add a comment about getdelim/getline rv not 0 wrt. fgetln API guarantee
@
text
@d23 1
d29 1
a29 1
__RCSID("$MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.5 2009/05/20 10:40:28 tg Exp $");
@


1.5
log
@• set *len to 0 in the failure case – while not required by the manual
  page, the reference implementation (and the one in Debian libbsd)
  does it too
• Guillem Jover pointed out I leak memory; fix that (but, looking at
  eglibc source code, there is no requirement to touch lb or lbsz, ever)
@
text
@a0 2
/* $MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.4 2009/05/20 10:22:33 tg Exp $ */

d2 2
a3 2
 * Copyright (c) 2007
 *	Thorsten Glaser <tg@@mirbsd.de>
d28 1
a28 1
__RCSID("$MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.4 2009/05/20 10:22:33 tg Exp $");
d43 1
@


1.4
log
@use only one implementation of fgetln(3), which expands into an
object file exporting nothing unless (glibc) needed
@
text
@d1 1
a1 1
/* $MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.3 2008/04/06 22:35:24 tg Exp $ */
d30 1
a30 1
__RCSID("$MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.3 2008/04/06 22:35:24 tg Exp $");
d41 2
a42 2
	char *lb = NULL;
	size_t lbsz = 0;
d44 8
a51 2
	*len = getline(&lb, &lbsz, stream);
	return ((*len == (size_t)-1) ? NULL : lb);
@


1.3
log
@fgetln protos are needed on GNU/Linux
@
text
@d1 1
a1 1
/* $MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.2 2007/03/31 00:04:54 tg Exp $ */
d22 1
a22 1
 * fgetln() wrapper for operating systems with getline()
d30 3
a32 1
__RCSID("$MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.2 2007/03/31 00:04:54 tg Exp $");
d47 1
@


1.2
log
@this will be built with mirmake.h pre-included, so we can add an __RCSID()
@
text
@d1 1
a1 1
/* $MirOS: contrib/code/mirmake/dist/contrib/fgetln.c,v 1.1 2007/03/31 00:03:50 tg Exp $ */
d30 1
a30 1
__RCSID("$MirOS$");
d32 1
d34 1
@


1.1
log
@add from freewrt, without the #ifdef __GLIBC__ and with our rcsid because
freewrt uses subversion which is much inferiour than cvs and can't do that

$ svn log fgetln.c
------------------------------------------------------------------------
r2229 | tg | 2007-03-22 03:31:28 +0000 (Thu, 22 Mar 2007) | 8 lines

I originally intended to “just fix” the _GNU_SOURCE vs declaration stuff
when I pointed this file's existence out to Han Boetes, who is currently
porting BSD grep to Crux GNU/Linux, but found out this code is crazy and
can't ever have worked correctly.

This is a re-implementation directly from the specs – getline(3) manpage
from Debian (etch) testing, fgetln(3) manpage from MirOS #10-beta
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $ */
d30 2
@

