head	1.36;
access;
symbols
	FWCF_1_06:1.36
	FWCF_1_05:1.35
	FWCF_1_04:1.33
	FWCF_1_03:1.29
	FWCF_1_01:1.12
	FWCF_1_00:1.10;
locks; strict;
comment	@# @;


1.36
date	2009.10.19.20.43.48;	author tg;	state Exp;
branches;
next	1.35;
commitid	1004ADCCF9364982506;

1.35
date	2007.07.16.16.56.30;	author tg;	state Exp;
branches;
next	1.34;
commitid	100469BA34410F33EA9;

1.34
date	2007.07.16.15.29.31;	author tg;	state Exp;
branches;
next	1.33;
commitid	100469B8EC97E210D62;

1.33
date	2007.07.02.14.55.44;	author tg;	state Exp;
branches;
next	1.32;
commitid	1004689120169EA4559;

1.32
date	2007.06.11.12.47.21;	author tg;	state Exp;
branches;
next	1.31;
commitid	100466D4452325E437A;

1.31
date	2007.06.11.12.40.00;	author tg;	state Exp;
branches;
next	1.30;
commitid	100466D42A43BA39405;

1.30
date	2007.03.31.00.29.56;	author tg;	state Exp;
branches;
next	1.29;
commitid	100460DAB86633A37E8;

1.29
date	2007.03.13.18.31.07;	author tg;	state Exp;
branches;
next	1.28;
commitid	10045F6EDB57C43F78A;

1.28
date	2007.03.09.22.40.53;	author tg;	state Exp;
branches;
next	1.27;
commitid	10045F1E28A0D83B069;

1.27
date	2007.03.08.08.02.46;	author tg;	state Exp;
branches;
next	1.26;
commitid	10045EFC337667B4FBC;

1.26
date	2007.03.07.00.23.06;	author tg;	state Exp;
branches;
next	1.25;
commitid	10045EE05F0392C1728;

1.25
date	2007.03.02.05.42.28;	author tg;	state Exp;
branches;
next	1.24;
commitid	10045E7B93D1CADE911;

1.24
date	2007.03.02.05.35.47;	author tg;	state Exp;
branches;
next	1.23;
commitid	10045E7B7B755747A35;

1.23
date	2007.03.02.05.31.34;	author tg;	state Exp;
branches;
next	1.22;
commitid	10045E7B6BB4A007808;

1.22
date	2007.02.28.23.17.34;	author tg;	state Exp;
branches;
next	1.21;
commitid	10045E60D56391D0419;

1.21
date	2007.02.28.21.17.00;	author tg;	state Exp;
branches;
next	1.20;
commitid	10045E5F1440125E5FF;

1.20
date	2007.02.28.21.08.22;	author tg;	state Exp;
branches;
next	1.19;
commitid	10045E5ED86358E315E;

1.19
date	2007.02.20.21.16.27;	author tg;	state Exp;
branches;
next	1.18;
commitid	10045DB651A50337618;

1.18
date	2007.02.20.21.06.02;	author tg;	state Exp;
branches;
next	1.17;
commitid	10045DB62AF7E120DAE;

1.17
date	2007.02.20.21.00.31;	author tg;	state Exp;
branches;
next	1.16;
commitid	10045DB617A640DAB51;

1.16
date	2007.02.20.20.02.13;	author tg;	state Exp;
branches;
next	1.15;
commitid	10045DB539B044EFEAD;

1.15
date	2007.02.12.21.49.08;	author tg;	state Exp;
branches;
next	1.14;
commitid	10045D0E08B06107D21;

1.14
date	2007.02.12.20.47.47;	author tg;	state Exp;
branches;
next	1.13;
commitid	10045D0D2723985AB03;

1.13
date	2007.02.12.20.35.39;	author tg;	state Exp;
branches;
next	1.12;
commitid	10045D0CF4B6B5A7F4F;

1.12
date	2006.10.16.18.11.56;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004533CB106CD2A13B;

1.11
date	2006.10.07.18.52.32;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004527F75973234204;

1.10
date	2006.09.26.10.26.26;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004519006679672BA3;

1.9
date	2006.09.24.04.25.55;	author tg;	state Exp;
branches;
next	1.8;
commitid	100451608E36B7425E2;

1.8
date	2006.09.24.03.21.29;	author tg;	state Exp;
branches;
next	1.7;
commitid	1004515F9B7670A25D8;

1.7
date	2006.09.24.03.06.21;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004515F63C2E8FBE7E;

1.6
date	2006.09.24.03.01.10;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004515F4FE604AD8B3;

1.5
date	2006.09.24.02.05.07;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004515E7D9311C7E66;

1.4
date	2006.09.24.01.56.04;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004515E5C10DCB4D78;

1.3
date	2006.09.24.01.46.46;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004515E399714F04F8;

1.2
date	2006.09.24.01.26.35;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004515DECF01CBC527;

1.1
date	2006.09.23.22.54.34;	author tg;	state Exp;
branches;
next	;
commitid	1004515BB3506BA8EBE;


desc
@@


1.36
log
@ensure we have (*) cases
@
text
@#!/bin/mksh
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.35 2007/07/16 16:56:30 tg Exp $
#-
# Copyright (c) 2006, 2007, 2009
#	Thorsten Glaser <tg@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# Possible return values:
# 0 - everything ok
# 1 - syntax error
# 1 - no 'fwcf' mtd partition found
# 1 - fwcf erase: failed
# 1 - fwcf setup: already run
# 3 - fwcf setup: mount --bind problems
# 4 - fwcf setup: can't create or write to temporary filesystem
# 5 - fwcf setup: can't bind the tmpfs to /etc
# 6 - fwcf commit: cannot write to mtd
# 6 - fwcf restore: cannot write to mtd
# 7 - fwcf commit: won't write to flash because of unclean setup
# 8 - fwcf status: differences found
# 9 - fwcf status: old status file not found
# 10 - fwcf dump: failed
# 11 - fwcf commit: fwcf setup not yet run (use -f to force)
# 11 - fwcf status: fwcf setup not yet run
# 12 - fwcf restore: cannot read the backup
# 255 - fwcf erase: failed
# 255 - internal error

export PATH=/bin:/sbin:/usr/bin:/usr/sbin
wd=$(pwd)
cd /
what='FreeWRT Configuration Filesytem (fwcf), Version 1.05b
Copyright (c) 2006, 2007
	Thorsten Glaser <tg@@freewrt.org>
'

function usage {
	cat >&2 <<EOF
$what
Usage:
	{ halt | poweroff | reboot } [-Ffn] [-d delay]
	fwcf { commit | erase | setup | status | dump | restore } [flags]
EOF
	exit 1
}

case $0 {
(*fwcf*)	me=fwcf ;;
(*halt*)	me=halt ;;
(*poweroff*)	me=poweroff ;;
(*reboot*)	me=reboot ;;
(*)		usage ;;
}

if [[ $me != fwcf ]]; then
	integer dflag=0
	dval=
	integer fflag=0
	integer nofwcf=0
	integer nflag=0
	while getopts ":d:Ffn" ch; do
		case $ch {
		(d)	dflag=1; dval=$OPTARG ;;
		(F)	nofwcf=1 ;;
		(f)	fflag=1 ;;
		(n)	nflag=1 ;;
		(*)	usage ;;
		}
	done
	shift $((OPTIND - 1))

	(( nofwcf == 0 && fflag == 0 )) && if ! fwcf status -q; then
		print -u2 "error: will not $me: unsaved changes in /etc found!"
		print -u2 "Either run 'fwcf commit' before trying to $me"
		print -u2 "or retry with '$me -F${*+ }$*' to force a ${me}."
		print -u2 "Run 'fwcf status' to see which files are changed."
		exit 2
	fi

	(( fflag )) && me="$me -f"
	(( nflag )) && me="$me -n"
	(( dflag )) && me="$me -d '$dval'"
	eval exec busybox $me
fi

case $1 {
(commit|erase|setup|status|dump|restore) ;;
(*)	cat >&2 <<EOF
$what
Syntax:
	$0 commit [-f]
	$0 erase
	$0 setup [-N]
	$0 status [-rq]
	$0 { dump | restore } [<filename>]
EOF
	exit 1 ;;
}

part=/dev/mtd/$(fgrep '"fwcf"' /proc/mtd 2>/dev/null | sed 's/^mtd\([^:]*\):.*$/\1/')ro
if [[ ! -e $part ]]; then
	print -u2 'fwcf: fatal error: no "fwcf" mtd partition found!'
	exit 1
fi

if test $1 = erase; then
	dd if="$part" 2>&1 | md5sum 2>&1 >/dev/urandom
	fwcf.helper -Me | mtd -F write - fwcf
	exit $?
fi

if test $1 = setup; then
	if test -e /tmp/.fwcf; then
		print -u2 'fwcf: error: "fwcf setup" already run!'
		exit 1
	fi
	mkdir /tmp/.fwcf
	if test ! -d /tmp/.fwcf; then
		print -u2 'fwcf: error: cannot create temporary directory!'
		exit 4
	fi
	chown 0:0 /tmp/.fwcf
	chmod 700 /tmp/.fwcf
	mkdir /tmp/.fwcf/root
	mount --bind /etc /tmp/.fwcf/root
	mkdir /tmp/.fwcf/temp
	mount -t tmpfs fwcf /tmp/.fwcf/temp
	(cd /tmp/.fwcf/root; tar cf - .) | (cd /tmp/.fwcf/temp; tar xpf -)
	unclean=0
	if [[ $1 = -N ]]; then
		unclean=2
	else
		x=$(dd if="$part" bs=4 count=1 2>/dev/null)
		[[ $x = FWCF ]] || fwcf.helper -Me | mtd -F write - fwcf
		if ! fwcf.helper -U /tmp/.fwcf/temp <"$part"; then
			unclean=1
			print -u2 'fwcf: error: cannot extract'
			echo unclean startup | logger -t 'fwcf setup'
		fi
		if test -e /tmp/.fwcf/temp/.fwcf_deleted; then
			while IFS= read -r file; do
				rm -f "/tmp/.fwcf/temp/$file"
			done </tmp/.fwcf/temp/.fwcf_deleted
			rm -f /tmp/.fwcf/temp/.fwcf_deleted
		fi
	fi
	test $unclean = 0 || echo -n >/tmp/.fwcf/temp/.fwcf_unclean
	rm -f /tmp/.fwcf/temp/.fwcf_done
	if test -e /tmp/.fwcf/temp/.fwcf_done; then
		print -u2 'fwcf: fatal: this is not Kansas any more'
		umount /tmp/.fwcf/temp
		umount /tmp/.fwcf/root
		rm -rf /tmp/.fwcf
		exit 3
	fi
	echo -n >/tmp/.fwcf/temp/.fwcf_done
	if test ! -e /tmp/.fwcf/temp/.fwcf_done; then
		print -u2 'fwcf: fatal: cannot write to tmpfs'
		umount /tmp/.fwcf/temp
		umount /tmp/.fwcf/root
		rm -rf /tmp/.fwcf
		exit 4
	fi
	chmod 755 /tmp/.fwcf/temp
	mount --bind /tmp/.fwcf/temp /etc
	if test ! -e /etc/.fwcf_done; then
		umount /etc
		print -u2 'fwcf: fatal: binding to /etc failed'
		if test $unclean = 0; then
			print -u2 'fwcf: configuration is preserved' \
			    in /tmp/.fwcf/temp
		else
			umount /tmp/.fwcf/temp
		fi
		exit 5
	fi
	umount /tmp/.fwcf/temp
	echo complete, unclean=$unclean | logger -t 'fwcf setup'
	cd /etc
	rm -f .rnd
	find . -type f | grep -v -e '^./.fwcf' -e '^./.rnd$' | sort | \
	    xargs md5sum | sed 's!  ./! !' | \
	    fwcf.helper -Z - /tmp/.fwcf/status.asz
	exit 0
fi

if test $1 = commit; then
	umount /tmp/.fwcf/temp >/dev/null 2>&1
	if test ! -e /tmp/.fwcf; then
		cat >&2 <<-EOF
			fwcf: error: not yet initialised
			explanation: "fwcf setup" was not yet run
		EOF
		[[ $1 = -f ]] || exit 11
	fi
	if test -e /etc/.fwcf_unclean; then
		cat >&2 <<-EOF
			fwcf: error: unclean startup (or setup run with -N)!
			explanation: during boot, the FWCF filesystem could not
			    be extracted; saving the current /etc to flash will
			    result in data loss; to override this check, remove
			    the file /etc/.fwcf_unclean and try again.
		EOF
		[[ $1 = -f ]] || exit 7
	fi
	mount -t tmpfs swap /tmp/.fwcf/temp
	(cd /etc; tar cf - .) | (cd /tmp/.fwcf/temp; tar xpf -)
	cd /tmp/.fwcf/temp
	find . -type f | grep -v -e '^./.fwcf' -e '^./.rnd$' | sort | \
	    xargs md5sum | sed 's!  ./! !' | \
	    fwcf.helper -Z - /tmp/.fwcf/status.asz
	cd /tmp/.fwcf/root
	rm -f /tmp/.fwcf/temp/.fwcf_* /tmp/.fwcf/temp/.rnd
	find . -type f | while read f; do
		f=${f#./}
		if [[ ! -e /tmp/.fwcf/temp/$f ]]; then
			[[ $f = .rnd ]] && continue
			printf '%s\n' "$f" >>/tmp/.fwcf/temp/.fwcf_deleted
			continue
		fi
		x=$(md5sum "$f" 2>/dev/null)
		y=$(cd ../temp; md5sum "$f" 2>/dev/null)
		[[ $x = $y ]] && rm "../temp/$f"
	done
	rv=0
	if ! ( fwcf.helper -M /tmp/.fwcf/temp | mtd -F write - fwcf ); then
		print -u2 'fwcf: error: cannot write to mtd!'
		rv=6
	fi
	umount /tmp/.fwcf/temp
	exit $rv
fi

if test $1 = status; then
	if test ! -e /tmp/.fwcf; then
		cat >&2 <<-EOF
			fwcf: error: not yet initialised
			explanation: "fwcf setup" was not yet run
		EOF
		[[ $1 = -f ]] || exit 11
	fi
	rm -f /tmp/.fwcf/*_status /tmp/.fwcf/*_files
	rflag=0
	q=printf	# or : (true) if -q
	shift
	while getopts "rq" ch; do
		case $ch {
		(r)	rflag=1 ;;
		(+r)	rflag=0 ;;
		(q)	q=: ;;
		(+q)	q=printf ;;
		}
	done
	shift $((OPTIND - 1))
	if test $rflag = 1; then
		f=/tmp/.fwcf/rom_status
		cd /tmp/.fwcf/root
		find . -type f | grep -v -e '^./.fwcf' -e '^./.rnd$' | sort | \
		    xargs md5sum | sed 's!  ./! !' >$f
	else
		f=/tmp/.fwcf/status
		fwcf.helper -Zd $f.asz $f || rm -f $f
	fi
	if [[ ! -e $f ]]; then
		print -u2 'fwcf: error: old status file not found'
		exit 9
	fi
	cd /etc
	find . -type f | grep -v -e '^./.fwcf' -e '^./.rnd$' | sort | \
	    xargs md5sum | sed 's!  ./! !' >/tmp/.fwcf/cur_status || exit 255
	cd /tmp/.fwcf
	sed 's/^[0-9a-f]* //' <$f >old_files
	sed 's/^[0-9a-f]* //' <cur_status >cur_files
	# make *_status be of exactly the same length, for benefit of the
	# while ... read <old, read <new loop below, and sort it
	comm -23 old_files cur_files | while read name; do
		echo "<NULL> $name" >>cur_status
	done
	comm -13 old_files cur_files | while read name; do
		echo "<NULL> $name" >>$f
	done
	# this implementation of sort -o sucks: doesn't do in-place edits
	sort -k2 -o sold_status $f
	sort -k2 -o snew_status cur_status
	gotany=0
	while :; do
		IFS=' ' read oldsum oldname <&3 || break
		IFS=' ' read newsum newname <&4 || exit 255
		[[ $oldname = $newname ]] || exit 255
		[[ $oldsum = $newsum ]] && continue
		[[ $gotany = 0 ]] && $q '%-32s %-32s %s\n' \
		    'MD5 hash of old file' 'MD5 hash of new file' 'filename'
		gotany=8
		test $q = : && break
		$q '%32s %32s %s\n' "$oldsum" "$newsum" "$oldname"
	done 3<sold_status 4<snew_status
	rm -f /tmp/.fwcf/*_status /tmp/.fwcf/*_files
	exit $gotany
fi

if test $1 = dump; then
	fn=$2
	[[ -n $fn ]] || fn=-
	rm -rf /tmp/.fwcf.dump
	mkdir -m 0700 /tmp/.fwcf.dump
	cd /tmp/.fwcf.dump
	if ! cat "$part" | fwcf.helper -UD dump; then
		cd /
		rm -rf /tmp/.fwcf.dump
		exit 10
	fi
	dd if=/dev/urandom of=seed bs=256 count=1 >/dev/null 2>&1
	tar -cf - dump seed | (cd "$wd"; fwcf.helper -Z - $fn)
	cd /
	rm -rf /tmp/.fwcf.dump
	case $fn {
	(-)	print -u2 "fwcf: dump to standard output complete."
		;;
	(*)	print -u2 "fwcf: dump to '$fn' complete."
		ls -l "$fn" >&2
		;;
	}
	exit 0
fi

if test $1 = restore; then
	if test -e /tmp/.fwcf; then
		print -u2 'fwcf: warning: "fwcf setup" already run!'
		print -u2 'please reboot after restoring; in no event'
		print -u2 'run "fwcf commit" to prevent data loss'
		echo -n >/etc/.fwcf_unclean
	fi
	fn=$2
	[[ -n $fn ]] || fn=-
	rm -rf /tmp/.fwcf.restore
	mkdir -m 0700 /tmp/.fwcf.restore
	cd /tmp/.fwcf.restore
	if ! (cd "$wd"; fwcf.helper -Zd "$fn") | tar -xf -; then
		cd /
		rm -rf /tmp/.fwcf.restore
		exit 12
	fi
	dd if=seed of=/dev/urandom bs=256 count=1 >/dev/null 2>&1
	if test ! -e dump; then
		print -u2 'fwcf: error: invalid backup'
		cd /
		rm -rf /tmp/.fwcf.restore
		exit 12
	fi
	if ! ( fwcf.helper -MD dump | mtd -F write - fwcf ); then
		print -u2 'fwcf: error: cannot write to mtd!'
		exit 6
	fi
	cd /
	rm -rf /tmp/.fwcf.restore
	case $fn {
	(-)	print -u2 "fwcf: restore from standard output complete."
		;;
	(*)	print -u2 "fwcf: restore from '$fn' complete."
		ls -l "$fn" >&2
		;;
	}
	exit 0
fi

print -u2 'fwcf: cannot be reached...'
exit 255
@


1.35
log
@I knew it had to be buggy, but I think I tested this‚Ä¶ oops anyway
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.34 2007/07/16 15:29:31 tg Exp $
d4 2
a5 2
# Copyright (c) 2006, 2007
#	Thorsten Glaser <tg@@mirbsd.de>
d263 1
d265 1
@


1.34
log
@now that freewrt trunk has mksh, we can try to set an example for better
shell scripting (this still isn't perfect as it's been designed with ash
in mind and grown over time, but still more SECURE than before)

this is *NOT* possible to run on freewrt 1.0.x!
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.33 2007/07/02 14:55:44 tg Exp $
d46 1
a46 1
what='FreeWRT Configuration Filesytem (fwcf), Version 1.05
d86 1
a86 1
	(( nofwcf == fflag == 0 )) && if ! fwcf status -q; then
@


1.33
log
@bump to fwcf 1.04
@
text
@d1 2
a2 2
#!/bin/sh
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.32 2007/06/11 12:47:21 tg Exp $
d46 1
a46 1
what='FreeWRT Configuration Filesytem (fwcf), Version 1.04
d51 1
a51 2
usage()
{
d61 7
a67 7
case $0 in
*fwcf*)		me=fwcf ;;
*halt*)		me=halt ;;
*poweroff*)	me=poweroff ;;
*reboot*)	me=reboot ;;
*)		usage ;;
esac
d69 2
a70 2
if test $me != fwcf; then
	dflag=0
d72 11
a82 37
	fflag=0
	nofwcf=0
	nflag=0
	# parse arguments
	for i
	do
		if test 2 = $dflag; then
			dflag=1
			dval=$i
			continue
		fi
		ok=0
		case $i in
		-)
			usage ;;
		-*[!dFfn]*)
			usage ;;
		--)
			ok=2 ;;
		-*)
			ok=1 ;;
		esac
		test 2 = $ok && break
		test 1 = $ok || usage
		case $i in
		-*d)	dflag=2 ;;
		-*d*)	usage ;;
		esac
		case $i in
		-*F*)	nofwcf=1 ;;
		esac
		case $i in
		-*f*)	fflag=1 ;;
		esac
		case $i in
		-*n*)	nflag=1 ;;
		esac
d84 1
a84 1
	test 2 = $dflag && usage
d86 6
a91 8
	if test 0 = $nofwcf && test 0 = $fflag; then
		if ! fwcf status -q; then
			echo "error: will not $me: unsaved changes in /etc found!" >&2
			echo "Either run 'fwcf commit' before trying to $me" >&2
			echo "or retry with '$me -F${*+ }$*' to force a ${me}." >&2
			echo "Run 'fwcf status' to see which files are changed." >&2
			exit 2
		fi
d94 3
a96 3
	test 1 = $fflag && me="$me -f"
	test 1 = $nflag && me="$me -n"
	test 1 = $dflag && me="$me -d '$dval'"
d100 3
a102 3
case $1 in
commit|erase|setup|status|dump|restore) ;;
*)	cat >&2 <<EOF
d112 1
a112 1
esac
d115 2
a116 2
if ! test -e "$part"; then
	echo 'fwcf: fatal error: no "fwcf" mtd partition found!' >&2
d128 1
a128 1
		echo 'fwcf: error: "fwcf setup" already run!' >&2
d133 1
a133 1
		echo 'fwcf: error: cannot create temporary directory!' >&2
d144 1
a144 1
	if test x"$1" = x"-N"; then
d148 1
a148 1
		test x"$x" = x"FWCF" || fwcf.helper -Me | mtd -F write - fwcf
d151 1
a151 1
			echo 'fwcf: error: cannot extract' >&2
a154 1
			# this is safe even in ash (I hope)
d164 1
a164 1
		echo 'fwcf: fatal: this is not Kansas any more' >&2
d172 1
a172 1
		echo 'fwcf: fatal: cannot write to tmpfs' >&2
d182 1
a182 1
		echo 'fwcf: fatal: binding to /etc failed' >&2
d184 2
a185 2
			echo 'fwcf: configuration is preserved' \
			    'in /tmp/.fwcf/temp' >&2
d208 1
a208 1
		test x"$1" = x"-f" || exit 11
d218 1
a218 1
		test x"$1" = x"-f" || exit 7
d230 2
a231 2
		if ! test -e "/tmp/.fwcf/temp/$f"; then
			test x"$f" = x".rnd" && continue
d237 1
a237 1
		test x"$x" = x"$y" && rm "../temp/$f"
d241 1
a241 1
		echo 'fwcf: error: cannot write to mtd!' >&2
d254 1
a254 1
		test x"$1" = x"-f" || exit 11
a258 1
	# XXX if we had mksh 'getopts' this would look nicer
d260 5
a264 7
	for arg in "$@@"; do
		case $arg in
		-*r*)	rflag=1 ;;
		esac
		case $arg in
		-*q*)	q=: ;;
		esac
d266 1
d276 2
a277 2
	if ! test -e $f; then
		echo 'fwcf: error: old status file not found' >&2
d301 3
a303 3
		test x"$oldname" = x"$newname" || exit 255
		test x"$oldsum" = x"$newsum" && continue
		test $gotany = 0 && $q '%-32s %-32s %s\n' \
d315 1
a315 1
	test -n "$fn" || fn=-
d328 2
a329 2
	case $fn in
	-)	echo "fwcf: dump to standard output complete." >&2
d331 1
a331 1
	*)	echo "fwcf: dump to '$fn' complete." >&2
d334 1
a334 1
	esac
d340 3
a342 3
		echo 'fwcf: warning: "fwcf setup" already run!' >&2
		echo 'please reboot after restoring; in no event' >&2
		echo 'run "fwcf commit" to prevent data loss' >&2
d346 1
a346 1
	test -n "$fn" || fn=-
d357 1
a357 1
		echo 'fwcf: error: invalid backup' >&2
d363 1
a363 1
		echo 'fwcf: error: cannot write to mtd!' >&2
d368 2
a369 2
	case $fn in
	-)	echo "fwcf: restore from standard output complete." >&2
d371 1
a371 1
	*)	echo "fwcf: restore from '$fn' complete." >&2
d374 1
a374 1
	esac
d378 1
a378 1
echo 'fwcf: cannot be reached...' >&2
@


1.32
log
@integrate the functionality of package/fwcf/hook into fwcf.sh directly
XXX optimisation: don't fork for ‚Äúfwcf status -q‚Äù
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.31 2007/06/11 12:40:00 tg Exp $
d46 1
a46 1
what='FreeWRT Configuration Filesytem (fwcf), Version 1.03-current
@


1.31
log
@‚Ä¢ fix some pathname issues
‚Ä¢ it's always a good idea to ‚Äúcd /‚Äù at start ‚òª
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.30 2007/03/31 00:29:56 tg Exp $
d46 82
d132 1
a132 4
FreeWRT Configuration Filesytem (fwcf), Version 1.03-current
Copyright (c) 2006, 2007
	Thorsten Glaser <tg@@freewrt.org>

@


1.30
log
@/etc perms hack, cf. discussion at http://marc.info/?m=117525842916753
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.29 2007/03/13 18:31:07 tg Exp $
d44 2
d278 1
a278 1
	tar -cf - dump seed | fwcf.helper -Z - $fn
d303 1
a303 1
	if ! fwcf.helper -Zd "$fn" | tar -xf -; then
@


1.29
log
@release an 1.03 as per request of wbx@@
‚Ä¢ he's been using it on his freewrt 1.0 system for a while now without problems
‚Ä¢ if it won't be committed into trunk, nobody's going to test it

this release implies the ‚Äúreboot hook‚Äù changes in freewrt itself are done
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.28 2007/03/09 22:40:53 tg Exp $
d48 1
a48 1
FreeWRT Configuration Filesytem (fwcf), Version 1.03
d127 1
@


1.28
log
@change dump.tar.gz and status.gz to dump.tar.LZO1X-1.asz and status.LZO1X-1.asz
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.27 2007/03/08 08:02:46 tg Exp $
d48 1
a48 1
FreeWRT Configuration Filesytem (fwcf), Version 1.03-beta
@


1.27
log
@left align, by request of wbx@@
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.26 2007/03/07 00:23:06 tg Exp $
d144 2
a145 1
	    xargs md5sum | sed 's!  ./! !' | gzip -9 >/tmp/.fwcf/status.gz
d172 2
a173 1
	    xargs md5sum | sed 's!  ./! !' | gzip -9 >/tmp/.fwcf/status.gz
d224 1
a224 1
		gzip -d <$f.gz >$f || rm -f $f
d275 1
a275 1
	tar -czf "$fn" dump seed
d300 1
a300 1
	if ! tar -xzf "$fn"; then
@


1.26
log
@read entropy on ‚Äúfwcf erase‚Äù too
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.25 2007/03/02 05:42:28 tg Exp $
d251 1
a251 1
		test $gotany = 0 && $q '%32s %32s %s\n' \
@


1.25
log
@dÃ≤oÃ≤ store a little entropy seed with backups, and gzip them
no additional dependencies
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.24 2007/03/02 05:35:47 tg Exp $
d69 1
@


1.24
log
@if fwcf setup is {already | not yet} run, error out and give
warnings in the appropriate places
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.23 2007/03/02 05:31:34 tg Exp $
d39 1
d263 12
a274 1
	cat "$part" | fwcf.helper -UD $fn || exit 10
d294 16
a309 1
	if ! ( fwcf.helper -MD $fn | mtd -F write - fwcf ); then
d313 2
@


1.23
log
@don't store the preinit entropy seed in fwcf if it changes
it's ignored anyway
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.22 2007/02/28 23:17:34 tg Exp $
d37 2
d148 7
d193 7
d274 6
@


1.22
log
@‚Ä¢ fwcf.txt, fwcf.sh: ‚Äúfwcf dump‚Äù and ‚Äúfwcf restore‚Äù just now arrived,
  perusing the new -D option of the fwcf helper tool
  XXX should I pipe the output through gzip(1)?
  XXX on second thoughts, maybe not, maybe does the user want to do it
‚Ä¢ fwcf.txt: more unicodisation (resistance is futile)
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.21 2007/02/28 21:17:00 tg Exp $
d138 1
d162 1
a162 1
	rm -f /tmp/.fwcf/temp/.fwcf_*
d166 1
@


1.21
log
@since I botched (released fwcf 1.01-current versions as fwcf 1.02 without
the -beta appended), 1.02 is hereby renamed to 1.03; there will be no 1.02.
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.20 2007/02/28 21:08:22 tg Exp $
d32 1
d36 1
d43 1
a43 1
commit|erase|setup|status) ;;
d50 5
a54 1
	$0 [commit [-f] | erase | setup [-N] | status [-rq]]
d241 31
@


1.20
log
@* fwcf.sh: use >/dev/null instead of >&- since the latter may fail some tools
* fwcf.txt: use proper unicode characters to push the text into shape
* fwcf.sh, fwcf.txt: implement new ‚Äúfwcf setup -N‚Äù to be used manually during
  failsafe mode, to be able to ‚Äúfwcf commit‚Äù later without a working fwcf
  filesystem loaded: ‚Äúfwcf setup -N‚Äù does everything ‚Äúfwcf setup‚Äù does except
  reading, parsing and extracting the ‚Äúfwcf filesystem‚Äù, and forcefully sets
  the ‚Äúunclean‚Äù flag to prevent an accidental ‚Äúfwcf commit‚Äù induced data loss
* fwcf.sh, fwcf.txt: implement new ‚Äúfwcf commit -f‚Äù so that lazy users won't
  have to manually rm /etc/.fwcf_unclean to force commits‚Ä¶ I know you folks ‚òª
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.19 2007/02/20 21:16:27 tg Exp $
d43 1
a43 1
FreeWRT Configuration Filesytem (fwcf), Version 1.02-beta
@


1.19
log
@fscking ash (even mirbsd nbsh(1) which is ash-derived) doesn't do csh-like
brace expansion‚Ä¶ grr‚Ä¶
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.18 2007/02/20 21:06:02 tg Exp $
d43 1
a43 1
FreeWRT Configuration Filesytem (fwcf), Version 1.02
d48 1
a48 1
	$0 [commit | erase | setup | status [-rq]]
d53 1
a53 1
part=/dev/mtd/$(fgrep '"fwcf"' /proc/mtd 2>&- | sed 's/^mtd\([^:]*\):.*$/\1/')ro
d81 18
a98 13
	x=$(dd if="$part" bs=4 count=1 2>&-)
	test x"$x" = x"FWCF" || fwcf.helper -Me | mtd -F write - fwcf
	if ! fwcf.helper -U /tmp/.fwcf/temp <"$part"; then
		echo 'fwcf: error: cannot extract' >&2
		echo -n >/tmp/.fwcf/temp/.fwcf_unclean
		echo unclean startup | logger -t 'fwcf setup'
	fi
	if test -e /tmp/.fwcf/temp/.fwcf_deleted; then
		# this is safe even in ash (I hope)
		while IFS= read -r file; do
			rm -f "/tmp/.fwcf/temp/$file"
		done </tmp/.fwcf/temp/.fwcf_deleted
		rm -f /tmp/.fwcf/temp/.fwcf_deleted
d100 1
d121 1
a121 3
		if test -e /tmp/.fwcf/temp/.fwcf_unclean; then
			umount /tmp/.fwcf/temp
		else
d124 2
d130 1
a130 1
	echo complete | logger -t 'fwcf setup'
d138 1
a138 1
	umount /tmp/.fwcf/temp >&- 2>&-
d141 1
a141 1
			fwcf: error: unclean startup!
d147 1
a147 1
		exit 7
d155 1
a155 1
	rm -f /tmp/.fwcf/temp/.fwcf_deleted
d162 2
a163 2
		x=$(md5sum "$f" 2>&-)
		y=$(cd ../temp; md5sum "$f" 2>&-)
@


1.18
log
@fwcf commit must recreate the status file
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.17 2007/02/20 21:00:31 tg Exp $
d170 1
a170 1
	rm -f /tmp/.fwcf/*_{status,files}
d225 1
a225 1
	rm -f /tmp/.fwcf/*_{status,files}
@


1.17
log
@sort of implement 'fwcf status', feel free to find bugs and send diffs
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.16 2007/02/20 20:02:13 tg Exp $
d145 3
@


1.16
log
@‚Ä¢ create the status file on 'fwcf commit'
‚Ä¢ don't put it to /etc itself, it shouldn't be stored
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.15 2007/02/12 21:49:08 tg Exp $
d44 2
a45 1
Copyright © 2006 by Thorsten Glaser <tg@@freewrt.org>
d48 1
a48 1
	$0 [commit | erase | setup | status]
d166 60
@


1.15
log
@* fwcf.sh, fwcf.txt: add 'fwcf status' description and list of exit
  codes; amend the help
* fwcf.txt: convert to utf-8 (fwcf.sh stays at latin1 since there is
  no locale support on the target)
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.14 2007/02/12 20:47:47 tg Exp $
d124 3
@


1.14
log
@crude "delete files that exist in the underlying squashfs" hack:
store their names in /tmp/.fwcf/temp/.fwcf_deleted
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.13 2007/02/12 20:35:39 tg Exp $
d33 2
d41 1
a41 1
setup|commit|erase) ;;
d47 1
a47 1
	$0 [commit | erase | setup]
@


1.13
log
@* fwcf.txt, fwcf.sh: document and implement an "unclean startup" flag,
  to prevent a FreeWRT box from not coming up at all if the FWCF file-
  system cannot be read; it will come up with set-up (TRX filesystem)
  defaults instead and refuse to be committed
* fwcf.txt, fwcf.sh: bump to 1.02, which will include this change as
  well as a reboot hook and a check operation etc.
* fwcf.sh: document possible exit codes
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d85 7
d140 1
d142 8
a149 3
		x=$(md5sum "${f#./}" 2>&-)
		y=$(cd ../temp; md5sum "${f#./}" 2>&-)
		test x"$x" = x"$y" && rm "../temp/${f#./}"
@


1.12
log
@* bump to 1.01 (release requested by wbx@@)
* add a syslog message after completed setup, something I'd like to see
* bail out on tmpfs failure early
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.11 2006/10/07 18:52:32 tg Exp $
d4 1
a4 1
# Copyright (c) 2006
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d13 22
a34 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
d41 1
a41 1
FreeWRT Configuration Filesytem (fwcf), Version 1.01
d82 2
a83 4
		umount /tmp/.fwcf/temp
		umount /tmp/.fwcf/root
		rm -rf /tmp/.fwcf
		exit 2
d105 6
a110 1
		echo 'fwcf: configuration is preserved in /tmp/.fwcf/temp' >&2
d120 10
@


1.11
log
@for 1.01: cosmetics, make the mount(8) output look like this:
| fwcf on /etc type tmpfs (rw)
so that users aren't shocked (swap is mounted WHERE?).

requested by Lothar Gesslein <ulmen@@cryptomilch.de>
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.10 2006/09/26 10:26:26 tg Exp $
d28 1
a28 1
FreeWRT Configuration Filesytem (fwcf), Version 1.00
d54 4
d98 1
@


1.10
log
@fwcf 1.00
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.9 2006/09/24 04:25:55 tg Exp $
d59 1
a59 1
	mount -t tmpfs swap /tmp/.fwcf/temp
@


1.9
log
@handle corner cases more gracefully
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.8 2006/09/24 03:21:29 tg Exp $
d28 2
a29 2
FreeWRT Configuration Filesytem (fwcf), Version 0.99
Copyright (c) 2006 by Thorsten Glaser <tg@@freewrt.org>
@


1.8
log
@bump to spec 1.0, rev 0.99, use mtd -F
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.7 2006/09/24 03:06:21 tg Exp $
d65 3
d73 3
d81 3
d90 1
d103 2
a104 2
		x=$(md5sum "${f#./}")
		y=$(cd ../temp; md5sum "${f#./}")
@


1.7
log
@we use /tmp/.fwcf, ok wbx@@
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.6 2006/09/24 03:01:10 tg Exp $
d28 1
a28 1
FreeWRT Configuration Filesytem (fwcf), Version 0.96
d44 1
a44 1
	fwcf.helper -Me | mtd -f write - fwcf
d62 1
a62 1
	test x"$x" = x"FWCF" || fwcf.helper -Me | mtd -f write - fwcf
d98 1
a98 1
	if ! ( fwcf.helper -M /tmp/.fwcf/temp | mtd -f write - fwcf ); then
@


1.6
log
@there is no -c any more, it's automatic
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.5 2006/09/24 02:05:07 tg Exp $
d49 1
a49 1
	if test -e /tmp/fwcf; then
d53 8
a60 8
	mkdir /tmp/fwcf
	chown 0:0 /tmp/fwcf
	chmod 700 /tmp/fwcf
	mkdir /tmp/fwcf/root
	mount --bind /etc /tmp/fwcf/root
	mkdir /tmp/fwcf/temp
	mount -t tmpfs swap /tmp/fwcf/temp
	(cd /tmp/fwcf/root; tar cf - .) | (cd /tmp/fwcf/temp; tar xpf -)
d63 1
a63 1
	if ! fwcf.helper -U /tmp/fwcf/temp <"$part"; then
d67 2
a68 2
	rm -f /tmp/fwcf/temp/.fwcf_done
	if test -e /tmp/fwcf/temp/.fwcf_done; then
d72 2
a73 2
	echo -n >/tmp/fwcf/temp/.fwcf_done
	if test ! -e /tmp/fwcf/temp/.fwcf_done; then
d77 1
a77 1
	mount --bind /tmp/fwcf/temp /etc
d83 1
a83 1
	umount /tmp/fwcf/temp
d88 4
a91 4
	umount /tmp/fwcf/temp >&- 2>&-
	mount -t tmpfs swap /tmp/fwcf/temp
	(cd /etc; tar cf - .) | (cd /tmp/fwcf/temp; tar xpf -)
	cd /tmp/fwcf/root
d98 1
a98 1
	if ! ( fwcf.helper -M /tmp/fwcf/temp | mtd -f write - fwcf ); then
d102 1
a102 1
	umount /tmp/fwcf/temp
@


1.5
log
@implement md5summing the files and fixing them up
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.4 2006/09/24 01:56:04 tg Exp $
d98 1
a98 1
	if ! ( fwcf.helper -Mc /tmp/fwcf/temp | mtd -f write - fwcf ); then
@


1.4
log
@tmpfs, not mfs, on Linux
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.3 2006/09/24 01:46:46 tg Exp $
d91 6
@


1.3
log
@ash seems to be crazy about that
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.2 2006/09/24 01:26:35 tg Exp $
a21 2
#-
# FreeWRT Configuration Filesytem, Version 0.94
d28 1
a28 1
FreeWRT Configuration Filesytem (fwcf), Version 0.94
d59 1
a59 1
	mount -t mfs swap /tmp/fwcf/temp
@


1.2
log
@if, on 'setup', it's not yet FWCF, erase it initially
@
text
@d2 1
a2 1
# $MirOS: contrib/hosted/fwcf/fwcf.sh,v 1.1 2006/09/23 22:54:34 tg Exp $
d58 1
a58 1
	mkdir /tmp/fwcf/{root,temp}
d60 1
@


1.1
log
@rapidly prototype in shell
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d62 2
@

