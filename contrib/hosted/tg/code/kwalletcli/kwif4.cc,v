head	1.3;
access;
symbols
	kwalletcli-3_02:1.3
	kwalletcli-3_01:1.3
	kwalletcli-3_00:1.3
	kwalletcli-2_12:1.2
	kwalletcli-2_11:1.2
	kwalletcli-2_10:1.2
	kwalletcli-2_03:1.2
	kwalletcli-2_02:1.2
	kwalletcli-2_01:1.2
	kwalletcli-2_00:1.1;
locks; strict;
comment	@// @;


1.3
date	2016.08.30.17.37.58;	author tg;	state Exp;
branches;
next	1.2;
commitid	10057C5C48D23D151BB;

1.2
date	2010.01.11.15.34.31;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004B4B450C0B164C8E;

1.1
date	2009.09.28.07.36.30;	author tg;	state Exp;
branches;
next	;
commitid	1004AC067026B232169;


desc
@@


1.3
log
@governance
@
text
@/*-
 * Copyright © 2009, 2010
 *	mirabilos <m@@mirbsd.org>
 * Copyright © 2009
 *	Thomas Fischer <fischer@@unix-ag.uni-kl.de>
 *
 * Provided that these terms and disclaimer and all copyright notices
 * are retained or reproduced in an accompanying document, permission
 * is granted to deal in this work without restriction, including un‐
 * limited rights to use, publicly perform, distribute, sell, modify,
 * merge, give away, or sublicence.
 *
 * This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
 * the utmost extent permitted by applicable law, neither express nor
 * implied; without malicious intent or gross negligence. In no event
 * may a licensor, author or contributor be held liable for indirect,
 * direct, other damage, loss, or other issues arising in any way out
 * of dealing in the work, even if advised of the possibility of such
 * damage or existence of a defect, except proven that it results out
 * of said person’s immediate fault when using the work as intended.
 *-
 * KWallet interface file for Qt 4 and KDE 4
 */

#include <qstring.h>
#include <kaboutdata.h>
#include <kapplication.h>
#include <kcmdlineargs.h>
#include <kwallet.h>

#include "kwalletcli.h"

extern "C" char *getenv(const char *);
extern "C" char *strdup(const char *);

extern "C" const char __rcsid_kwif[] =
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif4.cc,v 1.2 2010/01/11 15:34:31 tg Exp $";

extern "C" int
kw_io(const char *fld, const char *ent, const char **pwp, const char *vers)
{
	int rv;
	QString localwallet, qfld, qent, qpw;
	KWallet::Wallet *wallet;
	char *env_DISPLAY;

	if (pwp == NULL)
		return (KWE_ABORT);

	/* very basic protection against kdeinit4 errors */
	if (!(env_DISPLAY = getenv("DISPLAY")) || !*env_DISPLAY)
		return (KWE_NOWALLET);

	qfld = QString::fromUtf8(fld);
	qent = QString::fromUtf8(ent);
	if (*pwp != NULL)
		qpw = QString::fromUtf8(*pwp);

	/* this is ridiculous */
	KAboutData aboutData("kwalletcli", 0, ki18n("KWallet CLI"), vers);
	KCmdLineArgs::init(&aboutData);
	KApplication app(false);

	localwallet = KWallet::Wallet::LocalWallet();
	wallet = KWallet::Wallet::openWallet(localwallet, 0);

	if (!wallet) {
		rv = KWE_NOWALLET;
		goto out;
	}

	if (!wallet->hasFolder(qfld)) {
		if (*pwp == NULL) {
			rv = KWE_NOFOLDER;
			goto out;
		}
		wallet->createFolder(qfld);
	}

	if (!wallet->setFolder(qfld)) {
		rv = KWE_ERRFOLDER;
		goto out;
	}

	if (*pwp == NULL) {
		if (!wallet->hasEntry(qent)) {
			rv = KWE_NOENTRY;
			goto out;
		}
		qpw = "";
		if (wallet->readPassword(qent, qpw)) {
			rv = KWE_ERRENTRY;
			goto out;
		}
		rv = KWE_OK_GET;
		*pwp = strdup((const char *)qpw.toUtf8().data());
	} else {
		if (wallet->writePassword(qent, qpw)) {
			rv = KWE_ERR_SET;
			goto out;
		}
		rv = KWE_OK_SET;
	}

 out:
	delete wallet;
	return (rv);
}
@


1.2
log
@try to catch errors due to missing $DISPLAY early, kdeinit4 misbehaves
@
text
@d3 1
a3 1
 *	Thorsten Glaser <t.glaser@@tarent.de>
d37 1
a37 1
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif4.cc,v 1.1 2009/09/28 07:36:30 tg Exp $";
@


1.1
log
@Add Qt 4 / KDE 4 bindings contributed by
	Thomas Fischer <fischer@@unix-ag.uni-kl.de>
Thanks a lot! Next missing binding would be the future common
keystore bindings the KDE and GNOME teams are trying to build
using DBUS, although I suspect libkwallet*.so will provide a,
or even the same, high-level API to it.

Untested, but Qt 3 / KDE 3 bindings on Kunterbunt 8.04 still compile…
@
text
@d2 2
a4 1
 *	Thorsten Glaser <t.glaser@@tarent.de>
d33 1
d37 1
a37 1
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif3.cc,v 1.3 2009/07/10 10:50:06 tg Exp $";
d45 1
d50 4
@

