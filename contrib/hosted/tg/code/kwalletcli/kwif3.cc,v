head	1.5;
access;
symbols
	kwalletcli-3_02:1.5
	kwalletcli-3_01:1.5
	kwalletcli-3_00:1.5
	kwalletcli-2_12:1.4
	kwalletcli-2_11:1.4
	kwalletcli-2_10:1.4
	kwalletcli-2_03:1.4
	kwalletcli-2_02:1.4
	kwalletcli-2_01:1.4
	kwalletcli-2_00:1.3
	kwalletcli-1_00:1.3;
locks; strict;
comment	@// @;


1.5
date	2016.08.30.17.37.58;	author tg;	state Exp;
branches;
next	1.4;
commitid	10057C5C48D23D151BB;

1.4
date	2010.01.11.15.34.30;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004B4B450C0B164C8E;

1.3
date	2009.07.10.10.50.06;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004A571CEA469B7664;

1.2
date	2009.07.09.20.00.47;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004A564C5D2C0B004A;

1.1
date	2009.06.10.18.28.32;	author tg;	state Exp;
branches;
next	;
commitid	1004A2FFAE4021E11CE;


desc
@@


1.5
log
@governance
@
text
@/*-
 * Copyright © 2009, 2010
 *	mirabilos <m@@mirbsd.org>
 *
 * Provided that these terms and disclaimer and all copyright notices
 * are retained or reproduced in an accompanying document, permission
 * is granted to deal in this work without restriction, including un‐
 * limited rights to use, publicly perform, distribute, sell, modify,
 * merge, give away, or sublicence.
 *
 * This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
 * the utmost extent permitted by applicable law, neither express nor
 * implied; without malicious intent or gross negligence. In no event
 * may a licensor, author or contributor be held liable for indirect,
 * direct, other damage, loss, or other issues arising in any way out
 * of dealing in the work, even if advised of the possibility of such
 * damage or existence of a defect, except proven that it results out
 * of said person’s immediate fault when using the work as intended.
 *-
 * KWallet interface file for Qt 3 and KDE 3
 */

#include <qstring.h>
#include <kaboutdata.h>
#include <kapplication.h>
#include <kcmdlineargs.h>
#include <kwallet.h>

#include "kwalletcli.h"

extern "C" char *getenv(const char *);
extern "C" char *strdup(const char *);

extern "C" const char __rcsid_kwif[] =
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif3.cc,v 1.4 2010/01/11 15:34:30 tg Exp $";

extern "C" int
kw_io(const char *fld, const char *ent, const char **pwp, const char *vers)
{
	int rv;
	QString localwallet, qfld, qent, qpw;
	KWallet::Wallet *wallet;
	char *env_DISPLAY;

	if (pwp == NULL)
		return (KWE_ABORT);

	/* very basic protection against kdeinit errors */
	if (!(env_DISPLAY = getenv("DISPLAY")) || !*env_DISPLAY)
		return (KWE_NOWALLET);

	qfld = QString::fromUtf8(fld);
	qent = QString::fromUtf8(ent);
	if (*pwp != NULL)
		qpw = QString::fromUtf8(*pwp);

	/* this is ridiculous */
	KAboutData aboutData("kwalletcli", I18N_NOOP("KWallet CLI"), vers);
	KCmdLineArgs::init(&aboutData);
	KApplication app(false, false);

	localwallet = KWallet::Wallet::LocalWallet();
	wallet = KWallet::Wallet::openWallet(localwallet);

	if (!wallet) {
		rv = KWE_NOWALLET;
		goto out;
	}

	if (!wallet->hasFolder(qfld)) {
		if (*pwp == NULL) {
			rv = KWE_NOFOLDER;
			goto out;
		}
		wallet->createFolder(qfld);
	}

	if (!wallet->setFolder(qfld)) {
		rv = KWE_ERRFOLDER;
		goto out;
	}

	if (*pwp == NULL) {
		if (!wallet->hasEntry(qent)) {
			rv = KWE_NOENTRY;
			goto out;
		}
		qpw = "";
		if (wallet->readPassword(qent, qpw)) {
			rv = KWE_ERRENTRY;
			goto out;
		}
		rv = KWE_OK_GET;
		*pwp = strdup((const char *)qpw.utf8());
	} else {
		if (wallet->writePassword(qent, qpw)) {
			rv = KWE_ERR_SET;
			goto out;
		}
		rv = KWE_OK_SET;
	}

 out:
	delete wallet;
	return (rv);
}
@


1.4
log
@try to catch errors due to missing $DISPLAY early, kdeinit4 misbehaves
@
text
@d3 1
a3 1
 *	Thorsten Glaser <t.glaser@@tarent.de>
d35 1
a35 1
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif3.cc,v 1.3 2009/07/10 10:50:06 tg Exp $";
@


1.3
log
@• rename kwif.cc to kwif3.cc (backwardsly valid)
• document entire kwif*.cc API in kwalletcli.h
@
text
@d2 1
a2 1
 * Copyright © 2009
d31 1
d35 1
a35 1
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif3.cc,v 1.2 2009/07/09 20:00:47 tg Exp $";
d43 1
d48 4
@


1.2
log
@document that this is one of the (possibly more) interface files to
the KWallet, and that this one is for Qt 3 and KDE 3

kabelaffe@@ confirmed we almost certainly need a kwif4.cc for KDE 4.
@
text
@d33 2
a34 2
extern "C" const char __rcsid_kwif_cc[] =
    "$MirOS: contrib/hosted/tg/code/kwalletcli/kwif.cc,v 1.1 2009/06/10 18:28:32 tg Exp $";
d36 1
a36 1
int
@


1.1
log
@First steps of a CLI to KWallet (for KDE 3, targetting KDE 3.5 on
Kubuntu Hardon Heroin) with additional programmes. Features:
• kwalletcli, CLI to KWallet (complete)
• kwalletcli_getpin, helper, CLI to pinentry (complete)
• kwalletaskpass, ssh-askpass using kwalletcli and kwalletcli_getpin
• pinentry-kwallet, wrapper around pinentry using kwalletcli on request

Part of this work is sponsored by tarent GmbH
@
text
@d19 2
d34 1
a34 1
    "$MirOS$";
@

