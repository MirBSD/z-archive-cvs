head	1.6;
access;
symbols
	tg-ntpd-sigusr1-branch:1.3.0.4
	MIRBSD_10:1.3.0.2
	MIRBSD_10_BASE:1.3
	MIRBSD_9_BASE:1.2
	MIRBSD_8:1.2.0.2
	MIRBSD_8_BASE:1.2
	cvs-200512032330:1.1.1.1
	cvs-200510270930:1.1.1.1
	cvs-200507211800:1.1.1.1
	cvs-200504291700:1.1.1.1
	cvs-200504141900:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.6
date	2011.11.21.20.49.38;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004ECAB97840AE2593;

1.5
date	2011.11.20.20.08.37;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004EC95E5D0694C164;

1.4
date	2008.11.08.23.04.56;	author tg;	state Exp;
branches;
next	1.3;
commitid	10049161AB22DF5DFC5;

1.3
date	2007.02.08.01.27.38;	author tg;	state Exp;
branches;
next	1.2;
commitid	10045CA7CA10FCBD22E;

1.2
date	2005.03.13.19.17.10;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.30.58;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.30.58;	author tg;	state Exp;
branches;
next	;


desc
@@


1.6
log
@refactoro
@
text
@/**	$MirOS: src/usr.sbin/ntpd/util.c,v 1.5 2011/11/20 20:08:37 tg Exp $ */
/*	$OpenBSD: util.c,v 1.10 2004/12/08 15:47:38 mickey Exp $ */

/*
 * Copyright (c) 2004, 2007, 2011
 *	Thorsten "mirabilos" Glaser <tg@@mirbsd.org>
 * Copyright (c) 2004 Alexander Guy <alexander.guy@@andern.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
 * IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
 * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sys/types.h>
#include <limits.h>

#include "ntpd.h"

__RCSID("$MirOS: src/usr.sbin/ntpd/util.c,v 1.5 2011/11/20 20:08:37 tg Exp $");

void
d_to_tv(double d, struct timeval *tv)
{
	tv->tv_sec = (long)d;
	tv->tv_usec = (d - tv->tv_sec) * 1000000;
}

double
lfp_to_d(struct l_fixedpt lfp)
{
	double	ret;

	lfp.int_partl = ntohl(lfp.int_partl);
	lfp.fractionl = ntohl(lfp.fractionl);

	ret = (double)(lfp.int_partl) + ((double)lfp.fractionl / UINT_MAX);

	return (ret);
}

struct l_fixedpt
d_to_lfp(double d)
{
	struct l_fixedpt	lfp;

	lfp.int_partl = htonl((u_int32_t)d);
	lfp.fractionl = htonl((u_int32_t)((d - (u_int32_t)d) * UINT_MAX));

	return (lfp);
}

double
sfp_to_d(struct s_fixedpt sfp)
{
	double	ret;

	sfp.int_parts = ntohs(sfp.int_parts);
	sfp.fractions = ntohs(sfp.fractions);

	ret = (double)(sfp.int_parts) + ((double)sfp.fractions / USHRT_MAX);

	return (ret);
}

struct s_fixedpt
d_to_sfp(double d)
{
	struct s_fixedpt	sfp;

	sfp.int_parts = htons((u_int16_t)d);
	sfp.fractions = htons((u_int16_t)((d - (u_int16_t)d) * USHRT_MAX));

	return (sfp);
}
@


1.5
log
@convert to MirTime API
@
text
@d1 1
a1 1
/**	$MirOS: src/usr.sbin/ntpd/util.c,v 1.4 2008/11/08 23:04:56 tg Exp $ */
d27 1
a27 15
__RCSID("$MirOS: src/usr.sbin/ntpd/util.c,v 1.4 2008/11/08 23:04:56 tg Exp $");

double
gettime(void)
{
	register double d;
	struct timeval tv;

	gettimeofday(&tv, NULL);
	d = tv.tv_usec;
	d /= 1000000;
	d += timet2posix(tv.tv_sec);
	return (d);
}

@


1.4
log
@more mass conversions, including ancient eMail addresses
@
text
@d1 1
a1 1
/**	$MirOS: src/usr.sbin/ntpd/util.c,v 1.3 2007/02/08 01:27:38 tg Exp $ */
d5 1
a5 1
 * Copyright (c) 2004, 2007
a22 1
#include <sys/taitime.h>
d27 1
a27 1
__RCSID("$MirOS: src/usr.sbin/ntpd/util.c,v 1.3 2007/02/08 01:27:38 tg Exp $");
d32 2
a33 1
	tai64na_t t;
d35 5
a39 2
	taina_time(&t);
	return (1.0E-09 * t.nano + tai2utc(t.secs) + JAN_1970);
@


1.3
log
@missing <sys/taitime.h>
@
text
@d1 1
a1 1
/**	$MirOS: src/usr.sbin/ntpd/util.c,v 1.2 2005/03/13 19:17:10 tg Exp $ */
d6 1
a6 1
 *	Thorsten "mirabilos" Glaser <tg@@66h.42h.de>
d28 1
a28 1
__RCSID("$MirOS: src/usr.sbin/ntpd/util.c,v 1.2 2005/03/13 19:17:10 tg Exp $");
@


1.2
log
@fast merge src/usr.sbin
@
text
@d1 1
a1 1
/**	$MirOS$ */
d5 2
a6 2
 * Copyright (c) 2004
 *	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d22 2
a23 1
#include <sys/time.h>
d28 1
a28 1
__RCSID("$MirOS$");
@


1.1
log
@Initial revision
@
text
@d1 1
d5 2
d27 2
d32 1
a32 4
	struct timeval	tv;

	if (gettimeofday(&tv, NULL) == -1)
		fatal("gettimeofday");
d34 2
a35 1
	return (tv.tv_sec + JAN_1970 + 1.0e-6 * tv.tv_usec);
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@
