head	1.131;
access;
symbols
	MIRBSD_10:1.78.0.2
	MIRBSD_10_BASE:1.78
	MIRBSD_9_BASE:1.23
	MIRBSD_8:1.13.0.2
	MIRBSD_8_BASE:1.13
	cvs-200507211800:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.131
date	2019.08.25.21.59.07;	author tg;	state Exp;
branches;
next	1.130;
commitid	1005D63030F790860AE;

1.130
date	2019.04.23.18.16.31;	author tg;	state Exp;
branches;
next	1.129;
commitid	1005CBF5691554B1356;

1.129
date	2018.12.19.14.26.37;	author tg;	state Exp;
branches;
next	1.128;
commitid	1005C1A552D327B579F;

1.128
date	2018.04.28.02.49.31;	author tg;	state Exp;
branches;
next	1.127;
commitid	1005AE3E1513E12382D;

1.127
date	2017.08.07.20.10.50;	author tg;	state Exp;
branches;
next	1.126;
commitid	1005988C69344442E37;

1.126
date	2017.04.03.20.11.54;	author tg;	state Exp;
branches;
next	1.125;
commitid	10058E2AC9E40515CAD;

1.125
date	2016.10.09.21.26.06;	author tg;	state Exp;
branches;
next	1.124;
commitid	10057FAB5FF6634B3B1;

1.124
date	2016.03.25.19.49.15;	author tg;	state Exp;
branches;
next	1.123;
commitid	10056F596401CDD6854;

1.123
date	2016.02.06.15.59.53;	author tg;	state Exp;
branches;
next	1.122;
commitid	10056B618702AED1A59;

1.122
date	2015.10.06.15.05.43;	author tg;	state Exp;
branches;
next	1.121;
commitid	1005613E34754F9CB63;

1.121
date	2014.10.16.20.01.34;	author tg;	state Exp;
branches;
next	1.120;
commitid	100544024314BAFA78D;

1.120
date	2014.10.16.19.49.39;	author tg;	state Exp;
branches;
next	1.119;
commitid	1005440214F3D479701;

1.119
date	2014.07.22.20.33.42;	author tg;	state Exp;
branches;
next	1.118;
commitid	10053CECAB6100F8299;

1.118
date	2013.09.28.19.55.18;	author tg;	state Exp;
branches;
next	1.117;
commitid	100524733DE1CEE6C8A;

1.117
date	2013.09.11.18.55.56;	author tg;	state Exp;
branches;
next	1.116;
commitid	1005230BCBE27390267;

1.116
date	2011.02.19.01.08.33;	author tg;	state Exp;
branches;
next	1.115;
commitid	1004D5F182836EC7DBD;

1.115
date	2011.02.18.23.06.06;	author tg;	state Exp;
branches;
next	1.114;
commitid	1004D5EFB713D2F7B5F;

1.114
date	2011.02.13.21.17.13;	author tg;	state Exp;
branches;
next	1.113;
commitid	1004D584A4933F94695;

1.113
date	2011.01.15.21.52.38;	author tg;	state Exp;
branches;
next	1.112;
commitid	1004D32173B08BB4E36;

1.112
date	2010.10.01.17.22.05;	author tg;	state Exp;
branches;
next	1.111;
commitid	1004CA618C678937BF6;

1.111
date	2010.07.11.17.35.09;	author tg;	state Exp;
branches;
next	1.110;
commitid	1004C3A00E31714D995;

1.110
date	2010.07.11.11.56.04;	author tg;	state Exp;
branches;
next	1.109;
commitid	1004C39B0F253C2A554;

1.109
date	2009.11.15.12.30.22;	author tg;	state Exp;
branches;
next	1.108;
commitid	1004AFFF46C0A3FB8F3;

1.108
date	2009.11.10.17.35.47;	author tg;	state Exp;
branches;
next	1.107;
commitid	1004AF9A4835FEA0FE6;

1.107
date	2009.11.02.18.48.59;	author tg;	state Exp;
branches;
next	1.106;
commitid	1004AEF298820F56021;

1.106
date	2009.11.02.16.13.23;	author tg;	state Exp;
branches;
next	1.105;
commitid	1004AEF05122B550356;

1.105
date	2009.09.12.14.32.53;	author tg;	state Exp;
branches;
next	1.104;
commitid	1004AABB1245E5625E8;

1.104
date	2009.09.12.14.22.18;	author tg;	state Exp;
branches;
next	1.103;
commitid	1004AABAEA8454DE015;

1.103
date	2009.09.05.17.10.49;	author tg;	state Exp;
branches;
next	1.102;
commitid	1004AA29B8A74C8C6BD;

1.102
date	2009.08.18.17.41.46;	author tg;	state Exp;
branches;
next	1.101;
commitid	1004A8AE7D551E9F589;

1.101
date	2009.08.13.17.47.57;	author tg;	state Exp;
branches;
next	1.100;
commitid	1004A8451CD3192079E;

1.100
date	2009.08.10.16.26.57;	author tg;	state Exp;
branches;
next	1.99;
commitid	1004A804A5A26C45441;

1.99
date	2009.07.18.14.09.06;	author tg;	state Exp;
branches;
next	1.98;
commitid	1004A61D73A7953CBB8;

1.98
date	2009.03.29.13.04.16;	author tg;	state Exp;
branches;
next	1.97;
commitid	10049CF71B654F9EF54;

1.97
date	2009.02.22.19.13.23;	author tg;	state Exp;
branches;
next	1.96;
commitid	10049A1A3D96F798FC8;

1.96
date	2009.02.11.16.19.54;	author tg;	state Exp;
branches;
next	1.95;
commitid	1004992FAB42BEE4519;

1.95
date	2009.01.13.21.11.21;	author tg;	state Exp;
branches;
next	1.94;
commitid	100496D03705A75BAB6;

1.94
date	2008.12.10.18.06.06;	author tg;	state Exp;
branches;
next	1.93;
commitid	100494005235071EEB4;

1.93
date	2008.12.04.16.27.18;	author tg;	state Exp;
branches;
next	1.92;
commitid	100493804D735530B4A;

1.92
date	2008.11.29.17.03.51;	author tg;	state Exp;
branches;
next	1.91;
commitid	100493175607A689D2F;

1.91
date	2008.11.13.03.30.55;	author tg;	state Exp;
branches;
next	1.90;
commitid	100491B9F726D255D72;

1.90
date	2008.10.20.19.29.21;	author tg;	state Exp;
branches;
next	1.89;
commitid	10048FCDBAF5C7D98EB;

1.89
date	2008.10.20.18.20.31;	author tg;	state Exp;
branches;
next	1.88;
commitid	10048FCCBF9283FF1EE;

1.88
date	2008.10.20.18.04.03;	author tg;	state Exp;
branches;
next	1.87;
commitid	10048FCC82109BFD47C;

1.87
date	2008.10.20.17.40.44;	author tg;	state Exp;
branches;
next	1.86;
commitid	10048FCC29E48F8DAED;

1.86
date	2008.08.31.18.05.59;	author tg;	state Exp;
branches;
next	1.85;
commitid	10048BADD906CFF6723;

1.85
date	2008.07.12.19.15.37;	author tg;	state Exp;
branches;
next	1.84;
commitid	100487902E224F5A208;

1.84
date	2008.06.27.21.14.44;	author tg;	state Exp;
branches;
next	1.83;
commitid	100486557AC6033F0F3;

1.83
date	2008.06.06.12.41.49;	author tg;	state Exp;
branches;
next	1.82;
commitid	1004849303D12E53138;

1.82
date	2008.03.27.14.03.31;	author tg;	state Exp;
branches;
next	1.81;
commitid	10047EBA93D10751020;

1.81
date	2008.03.27.13.49.53;	author tg;	state Exp;
branches;
next	1.80;
commitid	10047EBA6106F79EC93;

1.80
date	2008.03.27.13.48.27;	author tg;	state Exp;
branches;
next	1.79;
commitid	10047EBA5A25F1AA7E1;

1.79
date	2008.03.20.21.13.28;	author tg;	state Exp;
branches;
next	1.78;
commitid	10047E2D3864F588151;

1.78
date	2007.09.28.20.46.54;	author tg;	state Exp;
branches;
next	1.77;
commitid	10046FD684B204757B3;

1.77
date	2007.09.25.15.57.48;	author tg;	state Exp;
branches;
next	1.76;
commitid	10046F930084F5F78C2;

1.76
date	2007.09.02.16.43.52;	author tg;	state Exp;
branches;
next	1.75;
commitid	10046DAE841690ACB34;

1.75
date	2007.08.24.14.38.37;	author tg;	state Exp;
branches;
next	1.74;
commitid	10046CEED464A09B22D;

1.74
date	2007.07.18.23.12.33;	author tg;	state Exp;
branches;
next	1.73;
commitid	100469E9E4C47F1993A;

1.73
date	2007.07.07.23.47.33;	author tg;	state Exp;
branches;
next	1.72;
commitid	100469026295707EF3A;

1.72
date	2007.07.07.20.32.05;	author tg;	state Exp;
branches;
next	1.71;
commitid	100468FF6665289063C;

1.71
date	2007.06.30.02.47.41;	author tg;	state Exp;
branches;
next	1.70;
commitid	1004685C4315376C585;

1.70
date	2007.06.16.22.36.48;	author tg;	state Exp;
branches;
next	1.69;
commitid	10046746581272CFCA8;

1.69
date	2007.06.15.23.43.46;	author tg;	state Exp;
branches;
next	1.68;
commitid	1004673243117F9CB1F;

1.68
date	2007.06.11.21.23.14;	author tg;	state Exp;
branches;
next	1.67;
commitid	100466DBD51629C517F;

1.67
date	2007.06.09.15.00.57;	author tg;	state Exp;
branches;
next	1.66;
commitid	100466AC0AF449FC8BC;

1.66
date	2007.06.04.08.36.36;	author tg;	state Exp;
branches;
next	1.65;
commitid	1004663CEF86900A583;

1.65
date	2007.05.29.08.19.29;	author tg;	state Exp;
branches;
next	1.64;
commitid	100465BE20D49DF40AF;

1.64
date	2007.04.17.20.04.06;	author tg;	state Exp;
branches;
next	1.63;
commitid	100462527BF45B87F5C;

1.63
date	2007.03.19.22.14.14;	author tg;	state Exp;
branches;
next	1.62;
commitid	10045FF0B462158BAB9;

1.62
date	2007.03.09.13.41.48;	author tg;	state Exp;
branches;
next	1.61;
commitid	10045F164270A5425A7;

1.61
date	2007.03.09.13.36.53;	author tg;	state Exp;
branches;
next	1.60;
commitid	10045F1630224820CBF;

1.60
date	2007.03.09.13.05.10;	author tg;	state Exp;
branches;
next	1.59;
commitid	10045F15B4849447B32;

1.59
date	2007.02.13.15.03.01;	author tg;	state Exp;
branches;
next	1.58;
commitid	10045D1D3265383677D;

1.58
date	2007.02.08.21.53.08;	author tg;	state Exp;
branches;
next	1.57;
commitid	10045CB9BC50A8E7A5F;

1.57
date	2007.02.02.16.45.10;	author tg;	state Exp;
branches;
next	1.56;
commitid	10045C36A7B5DB2058E;

1.56
date	2007.01.18.23.55.00;	author tg;	state Exp;
branches;
next	1.55;
commitid	10045B008DE7D7A0132;

1.55
date	2006.10.08.00.24.42;	author tg;	state Exp;
branches;
next	1.54;
commitid	100452845255DA75FEF;

1.54
date	2006.10.07.23.29.13;	author tg;	state Exp;
branches;
next	1.53;
commitid	100452838586FBE9244;

1.53
date	2006.10.02.22.31.19;	author tg;	state Exp;
branches;
next	1.52;
commitid	10045219340310CD5F7;

1.52
date	2006.10.02.07.03.16;	author tg;	state Exp;
branches;
next	1.51;
commitid	1004520B9C458C2C177;

1.51
date	2006.09.13.01.23.28;	author tg;	state Exp;
branches;
next	1.50;
commitid	10045075D9C114D70C9;

1.50
date	2006.08.24.12.54.58;	author tg;	state Exp;
branches;
next	1.49;
commitid	10044EDA1A377104977;

1.49
date	2006.08.22.21.51.40;	author tg;	state Exp;
branches;
next	1.48;
commitid	10044EB7C746813A3BA;

1.48
date	2006.08.19.15.51.45;	author tg;	state Exp;
branches;
next	1.47;
commitid	10044E7338B699E2713;

1.47
date	2006.08.19.15.42.19;	author tg;	state Exp;
branches;
next	1.46;
commitid	10044E7316C4F3AD27F;

1.46
date	2006.08.19.00.59.15;	author tg;	state Exp;
branches;
next	1.45;
commitid	10044E6626E56D988B0;

1.45
date	2006.08.19.00.46.39;	author tg;	state Exp;
branches;
next	1.44;
commitid	10044E65F7F391E451A;

1.44
date	2006.08.18.21.55.55;	author tg;	state Exp;
branches;
next	1.43;
commitid	10044E637791FEE2E78;

1.43
date	2006.08.16.23.14.17;	author tg;	state Exp;
branches;
next	1.42;
commitid	10044E3A6D87F50F0AF;

1.42
date	2006.08.16.18.46.14;	author tg;	state Exp;
branches;
next	1.41;
commitid	10044E367FF357E2D31;

1.41
date	2006.08.14.20.32.44;	author tg;	state Exp;
branches;
next	1.40;
commitid	10044E0DDB73A5BD9FD;

1.40
date	2006.08.09.21.19.10;	author tg;	state Exp;
branches;
next	1.39;
commitid	10044DA5159209D2843;

1.39
date	2006.08.09.21.14.56;	author tg;	state Exp;
branches;
next	1.38;
commitid	10044DA50611BBE9D01;

1.38
date	2006.08.09.21.04.17;	author tg;	state Exp;
branches;
next	1.37;
commitid	10044DA4DE030B04732;

1.37
date	2006.08.09.21.02.03;	author tg;	state Exp;
branches;
next	1.36;
commitid	10044DA4D5B606ADA6C;

1.36
date	2006.08.09.20.59.10;	author tg;	state Exp;
branches;
next	1.35;
commitid	10044DA4CB545E22B8F;

1.35
date	2006.08.09.20.58.36;	author tg;	state Exp;
branches;
next	1.34;
commitid	10044DA4C9218D34FE0;

1.34
date	2006.08.09.20.55.46;	author tg;	state Exp;
branches;
next	1.33;
commitid	10044DA4BE302690D2D;

1.33
date	2006.08.09.20.54.49;	author tg;	state Exp;
branches;
next	1.32;
commitid	10044DA4BAC7A85289A;

1.32
date	2006.08.09.14.30.20;	author tg;	state Exp;
branches;
next	1.31;
commitid	10044D9F1880601FA23;

1.31
date	2006.08.09.14.25.06;	author tg;	state Exp;
branches;
next	1.30;
commitid	10044D9F04B2FE9D293;

1.30
date	2006.08.09.14.15.16;	author tg;	state Exp;
branches;
next	1.29;
commitid	10044D9EDFF20BE465A;

1.29
date	2006.08.09.14.11.56;	author tg;	state Exp;
branches;
next	1.28;
commitid	10044D9ED424762FA6D;

1.28
date	2006.08.09.14.08.29;	author tg;	state Exp;
branches;
next	1.27;
commitid	10044D9EC197052C6A4;

1.27
date	2006.08.09.13.31.38;	author tg;	state Exp;
branches;
next	1.26;
commitid	10044D9E3BA4406BDB4;

1.26
date	2006.08.09.12.46.50;	author tg;	state Exp;
branches;
next	1.25;
commitid	10044D9D93B675138D8;

1.25
date	2006.07.21.16.40.30;	author tg;	state Exp;
branches;
next	1.24;
commitid	10044C102C562C5A241;

1.24
date	2006.07.21.16.30.35;	author tg;	state Exp;
branches;
next	1.23;
commitid	10044C101073826DFD6;

1.23
date	2006.06.17.19.24.44;	author tg;	state Exp;
branches;
next	1.22;
commitid	10044945711281F6835;

1.22
date	2006.06.15.19.56.43;	author tg;	state Exp;
branches;
next	1.21;
commitid	1004491BB666BF1F1EC;

1.21
date	2006.06.11.23.52.25;	author tg;	state Exp;
branches;
next	1.20;
commitid	100448CACC91876CA79;

1.20
date	2006.06.11.23.41.26;	author tg;	state Exp;
branches;
next	1.19;
commitid	100448CAA3664F8102E;

1.19
date	2006.04.05.23.56.54;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004434595617B6355B;

1.18
date	2006.04.05.23.56.05;	author tg;	state Exp;
branches;
next	1.17;
commitid	100443459277C7152F8;

1.17
date	2006.03.27.09.49.58;	author tg;	state Exp;
branches;
next	1.16;
commitid	1004427B52C11E7C73D;

1.16
date	2006.01.31.09.49.22;	author tg;	state Exp;
branches;
next	1.15;
commitid	10043DF328E124DC048;

1.15
date	2006.01.30.15.09.49;	author tg;	state Exp;
branches;
next	1.14;
commitid	10043DE2C4665A6AE7E;

1.14
date	2006.01.24.21.43.16;	author tg;	state Exp;
branches;
next	1.13;
commitid	10043D69F1253AAA15D;

1.13
date	2005.12.04.14.40.45;	author tg;	state Exp;
branches;
next	1.12;
commitid	6ed8439300009e8c;

1.12
date	2005.10.27.12.59.24;	author tg;	state Exp;
branches;
next	1.11;
commitid	73b14360cf2c7d42;

1.11
date	2005.09.20.18.37.41;	author tg;	state Exp;
branches;
next	1.10;
commitid	5e54330570218a7;

1.10
date	2005.07.24.16.20.21;	author tg;	state Exp;
branches;
next	1.9;
commitid	171f42e3bfaf12bf;

1.9
date	2005.07.02.12.17.55;	author tg;	state Exp;
branches;
next	1.8;
commitid	373142c685fc2484;

1.8
date	2005.07.02.11.28.30;	author tg;	state Exp;
branches;
next	1.7;
commitid	432742c67a667b2b;

1.7
date	2005.07.01.15.21.33;	author tg;	state Exp;
branches;
next	1.6;
commitid	109c42c55f90ef2f;

1.6
date	2005.07.01.15.20.40;	author tg;	state Exp;
branches;
next	1.5;
commitid	91242c55f563d13;

1.5
date	2005.07.01.15.19.20;	author tg;	state Exp;
branches;
next	1.4;
commitid	c6e42c55f0a341e;

1.4
date	2005.05.04.11.14.20;	author tg;	state Exp;
branches;
next	1.3;
commitid	3aba4278ae97effe;

1.3
date	2005.04.15.17.17.58;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.06.19.05.54;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.22.11;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.22.11;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.07.21.20.45.37;	author tg;	state Exp;
branches;
next	;
commitid	560042e0092f571e;


desc
@@


1.131
log
@make restirring of entropy a bit more reliable:

• writing to wrandom [prandom] needs at most 128 octets to re-stir,
  but then waiting for at 1‥3 seconds is necessary (or a pid1 flush)
• reading (except from, currently, srandom and urandom) has been
  retrieving arandom data for a while already so skip prandom read
• writing arandom (as root) restirs… if it’s more than 0 octets ☺
  but no need to sleep afterwards
• stir as much as possible just before openssl genrsa
• handle unchecked result of read(2) in init(8)
• clean up output of installer, while here anyway
@
text
@# $MirSecuCron: etc_rc 0.0 0000/00/00 00:00:00 root Backup $
# $MirOS: src/etc/rc,v 1.129 2018/12/19 14:26:37 tg Exp $
# $OpenBSD: rc,v 1.277 2006/01/12 21:54:15 deraadt Exp $
#-
# System startup script run by init on autoboot or after single-user.
# Output and error are redirected to console by init, and the console
# is the controlling terminal. This is called with _PATH_BSHELL which
# must be an mksh(1).

export HOME=/ LC_ALL=C PATH=/sbin:/bin:/usr/sbin:/usr/bin
umask 022
cd /

# Subroutines (have to come first).

# strip comments (and leading/trailing whitespace if IFS is set) from
# any file(s) given as argument, or stdin if none, and spew to stdout
function stripcom {
	set -o noglob
	cat "$@@" | while read _line; do
		_line=${_line%%#*}
		[[ -n $_line ]] && print -r -- $_line
	done
}

# Update resource limits when sysctl changes
# Usage: update_limit -X loginconf_name
update_limit() {
	typeset _fl=$1	# ulimit flag
	typeset _lc=$2	# login.conf name
	typeset n s

	for s in "" -cur -max; do
		n=$(getcap -f /etc/login.conf -s $_lc$s daemon 2>/dev/null)
		if [[ -n $n ]]; then
			[[ $n = infinity ]] && n=unlimited
			case $s {
			(-cur)
				ulimit -S $_fl $n
				;;
			(-max)
				ulimit -H $_fl $n
				;;
			(*)
				ulimit $_fl $n
				return
				;;
			}
		fi
	done
}

sysctl_conf() {
	test -s /etc/sysctl.conf || return

	set -- $(stripcom /etc/sysctl.conf)
	while [ $# -ge 1 ]; do
		sysctl $1
		# update limits if needed
		case $1 {
		(kern.maxproc=*)
			update_limit -p maxproc
			;;
		(kern.maxfiles=*)
			update_limit -n openfiles
			;;
		}
		shift
	done
}

mixerctl_conf() {
	test -s /etc/mixerctl.conf || return

	set -- $(stripcom /etc/mixerctl.conf)
	while [ $# -ge 1 ]; do
		mixerctl $1
		shift
	done
}

wsconsctl_conf() {
	typeset dev res save_IFS=$IFS

	test -x /sbin/wsconsctl -a -s /etc/wsconsctl.conf || return
	IFS="
"
	set -- $(stripcom /etc/wsconsctl.conf)
	IFS=$save_IFS
	while [ $# -ge 1 ]; do
		for dev in /dev/wskbd*; do
			res=$(eval wsconsctl -k \$dev -w $1 2>/dev/null)
			[[ -z $res ]] || print -r -- "$dev: $res"
		done
		shift
	done
}

# Sort the "/etc/fstab" arrays:
# -> sorting is done on $_mp[] from 0 to ${#_mp[*]}-1
# -> swapping is done on $_dev[] $_mp[] $_fstype[] $_opt[]
function _fsswap {
	typeset dev mp fstype opt rest

	dev=${_dev[$1]}
	mp=${_mp[$1]}
	fstype=${_fstype[$1]}
	opt=${_opt[$1]}

	_dev[$1]=${_dev[$2]}
	_mp[$1]=${_mp[$2]}
	_fstype[$1]=${_fstype[$2]}
	_opt[$1]=${_opt[$2]}

	_dev[$2]=$dev
	_mp[$2]=$mp
	_fstype[$2]=$fstype
	_opt[$2]=$opt
}

function _fssort {
	typeset -i i=0
	while (( i < (${#_mp[*]} - 1) )); do
		typeset -i j=i k=i+1
		while (( k < ${#_mp[*]} )); do
			[[ ${_mp[k]} < ${_mp[j]} ]] && j=k
			let k++
		done
		(( i != j )) && _fsswap $i $j
		let i++
	done
}

# End subroutines

# Set shell to ignore SIGINT (2), but not children;
# shell catches SIGQUIT (3) and returns to single user after fsck.
trap : 2
trap : 3	# shouldn't be needed

# If we are about to shut down, execute this bunch of code,
# otherwise (startup), skip below
if [[ $1 = shutdown ]]; then
	[[ -x /usr/sbin/wsconfig ]] && /usr/sbin/wsconfig -s 1 2>/dev/null
	echo Received shutdown request.

	# empty lopool into compressor arcfour state
	dd if=/dev/arandom of=/dev/wrandom bs=128 count=1 2>/dev/null
	sync 2>/dev/null &	# why not?
	sleep 3			# wrandom push interval
	# cause the kernel to re-stir arc4random
	dd if=/var/db/host.random of=/dev/arandom 2>/dev/null
	# save a random seed
	rf=/var/db/host.random.new
	while [[ -e $rf ]]; do
		rf=/var/db/host.random.new.$$.$RANDOM
	done
	(
		exec >$rf
		chmod 600 $rf
		dd if=/dev/arandom count=3 2>/dev/null
		dd if=/dev/urandom count=8 2>/dev/null
	)
	[[ -x /usr/sbin/wsconfig ]] && /usr/sbin/wsconfig -s 1 2>/dev/null
	if [[ ! -e $rf ]]; then
		echo single user: not running /etc/rc.shutdown
		exit 0
	fi

	if [[ -s $rf ]]; then
		sync
		mv -f "$rf" /var/db/host.random
	else
		# might be out of space
		rm -f "$rf"
		sync
		dd if=/dev/arandom count=1 conv=notrunc \
		    of=/var/db/host.random 2>/dev/null
	fi

	if [[ -f /etc/rc.shutdown ]]; then
		echo /etc/rc.shutdown in progress...
		. /etc/rc.shutdown
		echo /etc/rc.shutdown complete.

		# bring carp interfaces down gracefully
		for hn in /etc/hostname.carp[0-9]*; do
			[[ -e $hn ]] || continue
			if=${hn#/etc/hostname.}
			[[ " $(ifconfig -l) " = *@@( $if )* ]] && \
			    ifconfig $if down
		done
	else
		powerdown=NO
	fi

	# re-stir again
	print -n $RANDOM >/dev/arandom
	# and append more entropy
	dd if=/dev/arandom count=1 >>/var/db/host.random 2>/dev/null
	sync

	[[ $powerdown = YES ]] && exit 2
	exit 0
fi

# Protect us from shooting ourselves into the foot
if dmesg | grep -q '^.w[0-9].*<VBOX[, >]'; then
	echo Sorry, WirrtualBox is not supported.
	echo To continue on your own risk: touch /etc/allow-vbox
	echo But remember that vbox is buggy and often broken!
	test -e /etc/allow-vbox || exit 1
fi

# early munge point (for baselive CD)

# Configure ccd devices.
[[ -f /etc/ccd.conf ]] && ccdconfig -C

# Configure raid devices.
for dev in 0 1 2 3 4 5 6 7; do
	[[ -f /etc/raid${dev}.conf ]] && \
	    raidctl -c /etc/raid${dev}.conf raid$dev
done

# Check parity on raid devices.
raidctl -P all

swapctl -A -t blk

consspeed=$(stty -f /dev/console speed)
print -u2 "console at $consspeed bps"

# pick up configuration options
. /etc/rc.conf

# Read /etc/fstab into arrays and sort by mountpoint
typeset -i i=0
set -A _dev _mp _fstype _opt
stripcom /etc/fstab |&
while read -p _fdev _fmp _ffstype _fopt _frest; do
	_dev[i]=$_fdev
	_mp[i]=$_fmp
	_fstype[i]=$_ffstype
	_opt[i]=${_fopt:-rw}
	let i++
done
_fssort

# Examine the filesystems whether there are IDE drives
if [[ $softdrives_ide = NO ]]; then
	# auto-detect from /etc/fstab
	softdrives_ide=
	i=0
	while (( i < ${#_mp[*]} )); do
		if [[ ${_dev[i]} = /dev/wd+([0-9])[a-p] ]]; then
			_fdev=${_dev[i]#/dev/}
			softdrives_ide="$softdrives_ide ${_fdev%[a-p]}"
		fi
		let i++
	done
fi

# Needed for softdep to work correctly (SCSI drives, too!)
if [[ -n $softdrives_ide ]]; then
	echo -n Disabling HDD hardware write caches...
	x=:
	for drv in $softdrives_ide; do
		[[ $x = *:$drv:* ]] && continue
		echo -n " $drv"
		atactl /dev/r${drv}c secfreeze >/dev/null 2>&1
		atactl /dev/r${drv}c writecachedisable >/dev/null 2>&1 || \
		    echo -n !
		x=$x$drv:
	done
	echo .
fi

# Check filesystems
if [[ -e /fastboot ]]; then
	echo Fast boot: skipping disk checks.
elif [[ $1 = autoboot ]]; then
	echo Automatic boot in progress: starting filesystem checks.
	fsck -p
	case $? {
	(0)
		;;
	(2)
		exit 1
		;;
	(4)
		echo Rebooting...
		reboot
		echo "Reboot failed; help!"
		exit 1
		;;
	(8)
		echo "Automatic filesystem check failed; help!"
		exit 1
		;;
	(12)
		echo Boot interrupted.
		exit 1
		;;
	(130)
		# interrupt before catcher installed
		exit 1
		;;
	(*)
		echo "Unknown error; help!"
		exit 1
		;;
	}
fi

trap "echo Boot interrupted.; exit 1" 3

umount -a >/dev/null 2>&1
i=0
while (( i < ${#_mp[*]} )); do
	if [[ ${_mp[i]} = / && ${_opt[i]}, != ro,* ]]; then
		if ! mount -uwo "${_opt[i]}" "${_dev[i]}" / >/dev/null 2>&1; \
		    then
			if [[ ,${_opt[i]}, != *,softdep,* ]]; then
				echo -n 'WARNING: Your root filesystem failed'
				echo -n ' to remount read-write! <forcing...>'
				echo 'The system is probably severely damaged'
			fi
			mount -ufwo "${_opt[i]}" "${_dev[i]}" /
		fi
	elif [[ ,${_opt[i]}, != *,noauto,* && ${_opt[i]}, != @@(sw|xx),* ]]; then
		if [[ ${_fstype[i]} = ffs ]]; then
			if ! mount -t ffs -o "${_opt[i]}" "${_dev[i]}" \
				"${_mp[i]}" >/dev/null 2>&1; then
				if [[ ,${_opt[i]}, != *,softdep,* ]]; then
					echo -n "Warning: force-mounting unch"
					echo -n "ecked ffs filesystem nosoft"
					echo "dep: ${_dev[i]} -> ${_mp[i]}"
				fi
				mount -f -t ffs -o "${_opt[i]}" \
				    "${_dev[i]}" "${_mp[i]}"
			fi
		elif [[ ${_fstype[i]} != nfs ]]; then
			# Ignore NFS this early in the boot process
			mount -t "${_fstype[i]}" -o "${_opt[i]}" \
			    "${_dev[i]}" "${_mp[i]}"
		fi
	fi
	let i++
done
mount -a -t nonfs
# root on nfs may require this
mount 2>/dev/null |&
x=
while read -p line; do
	[[ $line = *@@( on / )* ]] || continue
	x=$line
	break
done
while read -p line; do : consume until mount is finished; done
[[ -z $x || $x = *\(*read-only* ]] && mount -uw /
# root is now writable
rm -f /fastboot

# enable running applications from /usr for now
[[ -x /sbin/ldconfig && -d /var/run/. ]] && /sbin/ldconfig

# set flags on ttys.  (do early, in case they use tty for SLIP in netstart)
echo setting tty flags
ttyflags -a

if [[ $pf != NO ]]; then
	RULES="block all"
	RULES="$RULES\npass on lo0"
	RULES="$RULES\npass in proto tcp from any to any port 22 keep state"
	RULES="$RULES\npass out proto { tcp, udp } from any to any port 53 keep state"
	RULES="$RULES\npass out inet proto icmp all icmp-type echoreq keep state"
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type neighbrsol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type neighbradv"
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type routersol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type routeradv"
	fi
	RULES="$RULES\npass proto { pfsync, carp }"
	if [[ "$(sysctl vfs.mounts.nfs 2>/dev/null)" = *[1-9]* ]]; then
		# don't kill NFS
		RULES="scrub in all no-df\n$RULES"
		RULES="$RULES\npass in proto udp from any port { 111, 2049 } to any"
		RULES="$RULES\npass out proto udp from any to any port { 111, 2049 }"
	fi
	echo $RULES | pfctl -f -
	pfctl -e
fi

sysctl_conf

# configure wscons(4) early, in case someone needs to interrupt e.g. dhclient
wsconsctl_conf

# set hostname, turn on network
echo starting network
if [ -f /etc/resolv.conf.save ]; then
	mv /etc/resolv.conf.save /etc/resolv.conf
	touch /etc/resolv.conf
fi
[[ -e /etc/rc.netselect ]] && . /etc/rc.netselect
. /etc/netstart

[[ $pf != NO && -s $pf_rules ]] && pfctl -f "$pf_rules"

# ensure /usr and /var are mounted, even if marked noauto
i=0
while (( i < ${#_mp[*]} )); do
	if [[ ${_mp[i]} = /@@(usr|var) ]]; then
		x=$(mount 2>/dev/null | fgrep " on ${_mp[i]} " 2>/dev/null)
		[[ -z $x ]] && mount ${_mp[i]} >/dev/null 2>&1
	fi
	let i++
done

# on sparc, use the nvram to provide some additional entropy
[[ -x /usr/sbin/eeprom ]] && eeprom 2>&1 | cksum -ba sha512 >/dev/wrandom

# load arp tables
if [[ $arptables = YES && -s /etc/arp.conf ]]; then
	echo Setting static ARP table entries
	arp -f /etc/arp.conf
fi

# read old random seed; if there's no /var/db/host.random, make
# one through random(4); else reset seed file anyway so that if
# a shutdown-less reboot occurs the next seed is not a repeat -
# also reset arandom(4)
{
	cat /var/db/host.random >/dev/urandom
	rf=/var/db/host.random.new
	while [[ -e $rf ]]; do
		rf=/var/db/host.random.new.$$.$RANDOM
	done
	(
		exec >$rf
		chmod 600 $rf
		dd if=/dev/arandom count=3 2>/dev/null
		dd if=/dev/urandom count=5 2>/dev/null
	)
	sync
	mv -f $rf /var/db/host.random

	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>/dev/null | hexdump -ve '"%u"')
	typeset -i1 a=RANDOM b=RANDOM c=RANDOM d=RANDOM
	while (( (a & 0xFF) == 0 )); do let a=RANDOM; done
	print -nr -- "${a#1#}${b#1#}${c#1#}${d#1#}" >/dev/arandom
	unset a b c d

	dd if=/dev/arandom count=3 >>/var/db/host.random
	sync
	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>/dev/null | hexdump -ve '"%u"')
} >/dev/wrandom 2>&1

# clean up left-over files
rm -f /etc/nologin
rm -f /var/spool/lock/LCK.*
rm -f /var/spool/uucp/STST/*
rm -rf /var/{run,authpf}/*
install -c -m 664 -g utmp /dev/null /var/run/utmp

if [[ -f /sbin/ldconfig ]]; then
	echo creating runtime link editor directory cache.
	[[ -d /usr/local/lib ]] && shlib_dirs="/usr/local/lib $shlib_dirs"
	[[ -d /usr/X11R6/lib ]] && shlib_dirs="/usr/X11R6/lib $shlib_dirs"
	[[ -d /usr/mpkg/lib ]] && shlib_dirs="/usr/mpkg/lib $shlib_dirs"
	ldconfig $shlib_dirs
	PATH=/sbin:/bin:/usr/sbin:/usr/bin
fi

# save a copy of the boot messages
dmesg | tee /var/run/dmesg.boot | cksum -ba sha512 >/dev/wrandom

# Initialise anoncvs chroot /dev directory
i=0
grep ':/var/anoncvs[^:]*:/usr/libexec/anoncvssh$' /etc/master.passwd |&
while IFS=: read -p name pass rest; do
	[[ $pass = '*' ]] || i=1
done
(( i )) && if [[ -d /var/anoncvs/dev/. ]]; then
	mount_mfs -s 128 swap /var/anoncvs/dev
	(cd /dev; pax -rw -pe arandom wrandom null zero /var/anoncvs/dev/)
	syslogd_flags="$syslogd_flags -a /var/anoncvs/dev/log"
fi

echo starting system logger
rm -f /dev/log
if [[ $httpd_flags != NO && " $httpd_flags " != *@@( -u )* ]]; then
	rm -f /var/www/dev/log
	mkdir -p -m 0555 /var/www/dev
	syslogd_flags="$syslogd_flags -a /var/www/dev/log"
fi
if [[ $named_flags != NO && -d /var/named/dev/. ]]; then
	rm -f /var/named/dev/log
	syslogd_flags="$syslogd_flags -a /var/named/dev/log"
fi
if [[ -d /var/empty/. ]]; then
	rm -f /var/empty/dev/log
	mkdir -p -m 0555 /var/empty/dev
	syslogd_flags="$syslogd_flags -a /var/empty/dev/log"
fi
syslogd $syslogd_flags

[[ $pf != NO && $pflogd_flags != NO ]] && \
    ifconfig pflog0 up && pflogd $pflogd_flags

# $isakmpd_flags is imported from /etc/rc.conf;
# If $isakmpd_flags == NO, isakmpd isn't run.
if [[ $isakmpd_flags != NO ]]; then
	echo starting isakmpd;		isakmpd $isakmpd_flags
fi

echo -n starting initial daemons:

if [[ $tpmrng_flags != NO && -x /usr/libexec/tpmrng ]]; then
	echo -n ' tpmrng';		/usr/libexec/tpmrng $tpmrng_flags
fi

# $portmap is imported from /etc/rc.conf;
# if $portmap == YES, the portmapper is started.
if [[ $portmap = YES ]]; then
	echo -n ' portmap';		portmap
else
	nfs_server=NO
fi

# $nfs_server is imported from /etc/rc.conf;
# if $nfs_server == YES, the machine is setup for being an nfs server
if [[ $nfs_server = YES && -s /etc/exports && \
    $(stripcom /etc/exports | wc -l) -ne 0 ]]; then
	rm -f /var/db/mountdtab
	echo -n >/var/db/mountdtab
	echo -n ' mountd';		mountd $mountd_flags
	echo -n ' nfsd';		nfsd $nfsd_flags
	if [[ $lockd = YES ]]; then
		echo -n ' rpc.lockd';	rpc.lockd
	fi
fi

# run rdate before timed/ntpd
if [[ $rdate_flags != NO ]]; then
	echo -n ' rdate';		rdate -s $rdate_flags 2>&1 |&
	set -A rdate_flags
	i=0
	while read -p x; do
		rdate_flags[${#rdate_flags[*]}]=$x
	done
fi

# $timed_flags is imported from /etc/rc.conf;
# if $timed_flags == NO, timed isn't run.
if [[ $timed_flags != NO ]]; then
	echo -n ' timed';		timed $timed_flags
fi

if [[ $ntpd_flags != NO ]]; then
	echo -n ' ntpd';		ntpd $ntpd_flags
fi

echo .
[[ $rdate_flags = NO ]] || while (( i < ${#rdate_flags[*]} )); do
	print -r -- "${rdate_flags[i++]}"
done

mount -a -t nfs

swapctl -A -t noblk

# /var/crash should be a directory or a symbolic link
# to the crash directory if core dumps are to be saved.
[[ -d /var/crash ]] && savecore $savecore_flags /var/crash

if [[ $check_quotas = YES ]]; then
	echo -n 'checking quotas: '
	quotacheck -a
	echo done.
	quotaon -a
fi

# build ps databases
echo -n building ps databases:
[[ -e /var/db/kvm_bsd.new ]] && mv -f /var/db/kvm_bsd.new /var/db/kvm_bsd.db
if [[ $kvm_mkdb != NO ]]; then
	echo -n " kvm"
	kvm_mkdb
fi
echo -n " dev"
dev_mkdb
echo .

chmod 666 /dev/tty[pqrstuvwxyzPQRST]*
chown root:wheel /dev/tty[pqrstuvwxyzPQRST]*

# check the password temp/lock file
[[ -f /etc/ptmp ]] && logger -s -p auth.err \
    'password file may be incorrect -- /etc/ptmp exists'

echo clearing /tmp
x=$(mount 2>/dev/null | fgrep " on /tmp" 2>/dev/null)
if [[ -z $x ]]; then
	# clean up as usual on small systems
	rm -rf /tmp
	mkdir /tmp
	chown 0:0 /tmp
	chmod 01777 /tmp
elif [[ $x != *@@(type mfs)* ]]; then
	# prune quickly with one rm, then use find to clean up /tmp/[lq]*
	(cd /tmp && rm -rf [a-km-pr-zA-Z]* && \
	    find . ! -name . ! -name lost+found ! -name quota.user \
		! -name quota.group -execdir rm -rf -- {} \; -type d -prune)
fi

# create Unix sockets directories for X if needed and make sure they have
# correct permissions
if [[ -d /usr/X11R6/lib ]]; then
	for d in /tmp/.X11-unix /tmp/.ICE-unix; do
		[[ -e $d ]] || mkdir -p $d
		if [[ -d $d ]]; then
			[[ $(stat -f %u $d) = 0 ]] || chown 0 $d
			[[ $(stat -f %p $d) = 41777 ]] || chmod 1777 $d
		elif [[ -e $d ]]; then
			echo "Error: $d exists and isn't a directory."
		fi
	done
fi

[[ -f /etc/rc.securelevel ]] && . /etc/rc.securelevel
if [[ -n $securelevel ]]; then
	echo -n 'setting kernel security level: '
	sysctl kern.securelevel=$securelevel
fi

# patch /etc/motd
x=$(sysctl -n kern.version | sed 1q)
[[ -s /etc/motd && "$([[ "$(head -1 /etc/motd)" != $x ]] && \
    ed -s /etc/motd 2>&1 <<-EOF
	1,/^\$/d
	0a
		$x

	.
	wq
EOF)" = @@(?) ]] && rm -f /etc/motd
if [[ ! -s /etc/motd ]]; then
	install -c -o root -g wheel -m 664 /dev/null /etc/motd
	print -- "$x\n" >/etc/motd
fi

if [[ -f /var/account/acct ]]; then
	echo turning on accounting;	accton /var/account/acct
fi

if [[ -x /usr/libexec/vi.recover && -x /usr/bin/perl && \
    -d /var/tmp/vi.recover ]]; then
	echo preserving editor files;	/usr/libexec/vi.recover
fi

if [[ -e /etc/rc.once ]]; then
	print rc: running post-install hooks
	mksh /etc/rc.once
fi

# Generate all the RSA keys we might need
if [[ ! -s /etc/ssl/private/default.key && -s /etc/ssh/ssh_host_rsa_key ]]; then
	print "openssl: using old SSH host RSA key"
	rm -f /etc/ssl/{def{ault,lt-ca}.cer,private/default.key}
	cat /etc/ssh/ssh_host_rsa_key >/etc/ssl/private/default.key
	chown 0:ssl-cert /etc/ssl/private/default.key
	chmod 640 /etc/ssl/private/default.key
fi
if [[ ! -s /etc/ssl/private/default.key ]]; then
	print -n "openssl: generating new host RSA key... "
	rm -f /etc/ssl/{def{ault,lt-ca}.cer,private/default.key}
	# push wrandom pool to arandom (128 needed but 64 from dmesg)
	dd if=/dev/arandom of=/dev/wrandom bs=64 count=1 2>/dev/null
	sleep 3 # to enforce dequeue
	# stir arandom, too
	print -n $RANDOM >/dev/arandom
	if openssl genrsa -out /etc/ssl/private/default.key 4096 \
	    >/dev/wrandom 2>&1; then
		chown 0:ssl-cert /etc/ssl/private/default.key
		chmod 640 /etc/ssl/private/default.key
		rm -f /etc/ssh/ssh_host_rsa_key
		print done.
	else
		print failed.
	fi
fi
if [[ ! -s /etc/ssl/default.cer || ! -s /etc/ssl/deflt-ca.cer ]]; then
	print -n "openssl: generating new host X.509v3 certificate... "
	rm -f /etc/ssl/def{ault,lt-ca}.cer
	openssl req -batch -new -subj "/CN=$(hostname)/" \
	    -key /etc/ssl/private/default.key \
	    -x509 -out /etc/ssl/default.cer
	chmod 644 /etc/ssl/default.cer
	cp /etc/ssl/default.cer /etc/ssl/deflt-ca.cer
	print done
fi
if [[ ! -s /etc/ssh/ssh_host_rsa_key ]]; then
	print -n "ssh-keygen: installing host RSA key... "
	cp -f /etc/ssl/private/default.key /etc/ssh/ssh_host_rsa_key
	chown 0:0 /etc/ssh/ssh_host_rsa_key
	chmod 600 /etc/ssh/ssh_host_rsa_key
	rm -f /etc/ssh/ssh_host_rsa_key.pub
	print done.
fi
if [[ ! -s /etc/ssh/ssh_host_rsa_key.pub ]]; then
	print -n "ssh-keygen: installing host public key... "
	print -r -- $(ssh-keygen -yf /etc/ssh/ssh_host_rsa_key) \
	    $(hostname) host key >/etc/ssh/ssh_host_rsa_key.pub
	chmod 644 /etc/ssh/ssh_host_rsa_key.pub
	print done.
fi

echo -n starting network daemons:

# $sshd_flags are imported from /etc/rc.conf.
# If $sshd_flags == NO, sshd isn't run.
# Same for the other dæmons.

if [[ $sshd_flags != NO ]]; then
	echo -n ' sshd';		/usr/sbin/sshd $sshd_flags
fi

if [[ $routed_flags != NO ]]; then
	echo -n ' routed';		routed $routed_flags
fi

if [[ $mrouted_flags != NO ]]; then
	echo -n ' mrouted';		mrouted $mrouted_flags
fi

if [[ $ospfd_flags != NO && -x /usr/sbin/ospfd ]]; then
	echo -n ' ospfd';		/usr/sbin/ospfd $ospfd_flags
fi

if [[ $bgpd_flags != NO && -x /usr/sbin/bgpd ]]; then
	echo -n ' bgpd';		/usr/sbin/bgpd $bgpd_flags
fi

if [[ $dhcpd_flags != NO && -f /etc/dhcpd.conf ]]; then
	touch /var/db/dhcpd.leases
	[[ -f /etc/dhcpd.interfaces ]] && \
	    dhcpd_ifs=$(stripcom /etc/dhcpd.interfaces)
	echo -n ' dhcpd';		/usr/sbin/dhcpd $dhcpd_flags $dhcpd_ifs
fi

if ifconfig lo0 inet6 >/dev/null 2>&1; then
	fw=$(sysctl -n net.inet6.ip6.forwarding)
	if [[ $fw = 0 ]]; then
		if [[ $rtsold_flags != NO ]]; then
			echo -n ' rtsold'
			/usr/sbin/rtsold $rtsold_flags
		fi
	else
		if [[ $route6d_flags != NO ]]; then
			echo -n ' route6d'
			/usr/sbin/route6d $route6d_flags
		fi
		if [[ $rtadvd_flags != NO ]]; then
			echo -n ' rtadvd'
			/usr/sbin/rtadvd $rtadvd_flags
		fi
	fi
fi

# if $rwhod == YES, rwhod is run.
if [[ $rwhod = YES ]]; then
	echo -n ' rwhod';		rwhod
fi

if [[ $lpd_flags != NO ]]; then
	echo -n ' lpd';			lpd $lpd_flags
fi

# $sendmail_flags is imported from /etc/rc.conf;
# If $sendmail_flags == NO or /etc/mailer.conf doesn't exist, then
# sendmail isn't run.  We call sendmail with a full path so that
# SIGHUP works.  Note that /usr/sbin/sendmail may actually call a
# mailer other than sendmail, depending on /etc/mailer.conf.
if [[ $sendmail_flags != NO && -s /etc/mailer.conf ]]; then
	echo -n ' sendmail'
	( /usr/sbin/sendmail $sendmail_flags <>/dev/null >&0 2>&0 & )
fi

if [[ $httpd_flags != NO ]]; then
	# Clean up left-over httpd locks
	rm -f /var/www/logs/{ssl_mutex,httpd.lock,accept.lock}.*
	echo -n ' httpd';		/usr/sbin/httpd $httpd_flags
fi

if [[ $ftpd_flags != NO ]]; then
	echo -n ' ftpd';		/usr/libexec/ftpd $ftpd_flags
fi

if [[ $ftpproxy_flags != NO ]]; then
	echo -n ' ftp-proxy';		/usr/sbin/ftp-proxy $ftpproxy_flags
fi

if [[ $identd_flags != NO ]]; then
	echo -n ' identd';		/usr/libexec/identd $identd_flags
fi

if [[ $inetd = YES && -s /etc/inetd.conf ]]; then
	echo -n ' inetd';		inetd
fi

if [[ $spamd_flags != NO ]]; then
	[[ $spamd_black != NO ]] && spamd_flags="$spamd_flags -b"
	echo -n ' spamd';		eval /usr/libexec/spamd $spamd_flags
	/usr/libexec/spamd-setup
	if [[ $spamd_black = NO ]]; then
		echo -n ' spamlogd'
		/usr/libexec/spamlogd
	fi
fi

# If $rarpd_flags == NO or /etc/ethers doesn't exist, then
# rarpd isn't run.
if [[ $rarpd_flags != NO && -s /etc/ethers ]]; then
	echo -n ' rarpd';		rarpd $rarpd_flags
fi

# If $bootparamd_flags == NO or /etc/bootparams doesn't exist, then
# bootparamd isn't run.
if [[ $bootparamd_flags != NO && -s /etc/bootparams ]]; then
	echo -n ' rpc.bootparamd';	rpc.bootparamd $bootparamd_flags
fi

# If $rbootd_flags == NO or /etc/rbootd.conf doesn't exist, then
# rbootd isn't run.
if [[ $rbootd_flags != NO && -s /etc/rbootd.conf ]]; then
	echo -n ' rbootd';		rbootd $rbootd_flags
fi

if [[ $isdnd_flags != NO ]]; then
	echo -n ' isdnd';		/usr/sbin/isdnd $isdnd_flags
fi

echo .

mixerctl_conf

# if /etc/ttys does not include a console entry, remove it (borken)
grep -q '^console' /etc/ttys >/dev/null 2>&1 || rm -f /etc/ttys
# if /etc/ttys does not exist (or was broken), install a fresh copy
[[ -e /etc/ttys ]] || install -c -o 0 -g 0 -m 644 /etc/ttys.dist /etc/ttys
# if /etc/ttys indicates auto-setup of console speed, do that
grep -q '^console[	 ].*acs\.[0-9s]' /etc/ttys >/dev/null 2>&1 && \
    ed -s /etc/ttys >/dev/null 2>&1 <<-EOF
	/^console[	 ]/s/acs\.[0-9]*/acs.${consspeed}/
	wq
EOF

[[ -f /etc/rc.local ]] && . /etc/rc.local

# Only if it exists and is an unused ram disc array.
# Compare approximately like the kernel does, except
# we checksum the first 2 pages instead of a memcmp.
x=$(dd if=/dev/rrd0c count=16 2>/dev/wrandom | cksum -a adler32)
[[ $x = 1B32098C ]] && swapctl -ap0 /dev/rd0c

echo Setting up ssh-agent directories...
mkdir -m 0755 /var/run/ssh-agent
chown root:daemon /var/run/ssh-agent
for luser in . $sshagent_autostart; do
	[[ $luser = [1-9]*([0-9]) ]] || continue
	mkdir -m 0700 /var/run/ssh-agent/$luser
	chown $luser /var/run/ssh-agent/$luser
	rm -f /var/run/ssh-agent/$luser/agent
done

echo -n standard daemons:
# don't run daemon if $food_flags == NO or /usr/sbin/food doesn't exist

if [[ $apmd_flags != NO && -x /usr/sbin/apmd ]]; then
	echo -n ' apmd';	/usr/sbin/apmd $apmd_flags
fi

if [[ $acpid_flags != NO && -x /usr/sbin/acpid ]]; then
	echo -n ' acpid';	/usr/sbin/acpid $acpid_flags
fi

if [[ $sensorsd_flags != NO && -x /usr/sbin/sensorsd ]]; then
	echo -n ' sensorsd';	/usr/sbin/sensorsd $sensorsd_flags
fi

if [[ $hotplugd_flags != NO && -x /usr/sbin/hotplugd ]]; then
	echo -n ' hotplugd';	/usr/sbin/hotplugd $hotplugd_flags
fi

if [[ $watchdogd_flags != NO && -x /usr/sbin/watchdogd ]]; then
	echo -n ' watchdogd';	/usr/sbin/watchdogd $watchdogd_flags
fi

echo -n ' cron';		cron

if [[ $wsmoused_flags != NO && -x /usr/sbin/wsmoused ]]; then
	echo -n ' wsmoused';	/usr/sbin/wsmoused $wsmoused_flags
fi

echo .

date

# Alternatively, on some architectures, xdm may be started in /etc/ttys.
if [[ $xdm_flags != NO && -x /usr/X11R6/bin/xdm ]]; then
	echo starting xdm...;		/usr/X11R6/bin/xdm $xdm_flags
fi

exit 0
@


1.130
log
@do not auto-include root in sshagent_autostart (plus some fixups)
@
text
@d148 1
a148 1
	dd if=/dev/arandom of=/dev/wrandom count=1 2>/dev/null
d150 1
a150 1
	sleep 0.1
d193 3
d197 5
a201 6
		# re-stir again
		dd if=/dev/urandom of=/dev/arandom bs=4 count=1 2>/dev/null
		sleep 0.1
		# and append more entropy
		dd if=/dev/arandom count=1 >>/var/db/host.random 2>/dev/null
		sync
d203 1
a203 2
		[[ $powerdown = YES ]] && exit 2
	fi
d451 1
d477 1
a477 1
dmesg | tee /var/run/dmesg.boot | cksum -ba rmd160 >/dev/wrandom
d679 5
a683 1
	# XXX 6000-8000 is recommended... choose less to be nice to old boxen
@


1.129
log
@update ownership and permissions for the /etc/ss{h,l}/** files
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.126 2017/04/03 20:11:54 tg Exp $
a861 1
[[ $sshagent_autostart = NO ]] && sshagent_autostart=
d865 2
a866 1
for luser in 0 $sshagent_autostart; do
@


1.128
log
@start sshd slightly earlier
@
text
@d671 2
a672 1
	chmod 600 /etc/ssl/private/default.key
d680 2
a681 1
		chmod 600 /etc/ssl/private/default.key
d701 2
a709 1
	chmod 600 /etc/ssh/ssh_host_rsa_key
@


1.127
log
@filesystem
@
text
@d713 2
a714 2
# $routed_flags are imported from /etc/rc.conf.
# If $routed_flags == NO, routed isn't run.
d717 4
a803 4
if [[ $sshd_flags != NO ]]; then
	echo -n ' sshd';		/usr/sbin/sshd $sshd_flags
fi

@


1.126
log
@improve reliability
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.123 2016/02/06 15:59:53 tg Exp $
d282 1
a282 1
	echo Automatic boot in progress: starting file system checks.
d297 1
a297 1
		echo "Automatic file system check failed; help!"
@


1.125
log
@let randshuffle behave a bit more notrunc
@
text
@d207 1
a207 2
dmesg | while IFS= read -r line; do
	[[ $line = ?d[0-9]*@@('<VBOX'[, >])* ]] || continue
d212 1
a212 1
done
d479 1
a479 1
grep ':/var/anoncvs.*:/usr/libexec/anoncvssh$' /etc/master.passwd |&
d845 1
a845 1
grep -q '^console.*acs\.[0-9s]' /etc/ttys >/dev/null 2>&1 && \
d847 1
a847 1
	/^console/s/acs\.[0-9]*/acs.${consspeed}/
@


1.124
log
@prepare most scripts for locale tracking; drop some TZ=UTC; use modern mksh
@
text
@d171 1
d176 1
d199 1
d436 10
a445 3
	(dd if=/dev/arandom count=3; dd if=/dev/urandom count=5) | \
	    dd of=/var/db/host.random
	chmod 600 /var/db/host.random
d447 1
d455 1
@


1.123
log
@handle out of space during writing random seed better
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.122 2015/10/06 15:05:43 tg Exp $
d10 1
a10 1
export HOME=/ LC_CTYPE=en_US.UTF-8 PATH=/sbin:/bin:/usr/sbin:/usr/bin
d19 2
a20 1
	cat "$@@" | { set -o noglob; while read _line; do
d23 1
a23 1
	done; }
@


1.122
log
@pre-fill MirSecuCron in correct width, at least for all that could be
affected during a run (I think I got them all)
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.121 2014/10/16 20:01:34 tg Exp $
d169 8
a176 1
	mv -f "$rf" /var/db/host.random
@


1.121
log
@hm, this can’t be right
@
text
@d1 2
a2 2
# $MirSecuCron: etc_rc 0.0 2014/00/00 00:00:00 root Backup $
# $MirOS: src/etc/rc,v 1.119 2014/07/22 20:33:42 tg Exp $
@


1.120
log
@prevent fault at first boot

rc.once triggers cron.security which changes the MirSecuCron line,
so we better ship with one in the same size as we eventually have
@
text
@d143 1
a143 1
	[[ -x /usr/sbin/wsconfig ]] && /usr/sbin/wsconfig -s 1 2>&-
d153 19
a171 5
	(dd if=/dev/arandom count=3; dd if=/dev/urandom count=8) \
	    >/var/db/host.random 2>/dev/null
	chmod 600 /var/db/host.random
	[[ -x /usr/sbin/wsconfig ]] && /usr/sbin/wsconfig -s 1 2>&-
	if [ $? -eq 0 -a -f /etc/rc.shutdown ]; then
a190 2
	else
		echo single user: not running /etc/rc.shutdown
d430 1
a430 1
	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>&- | hexdump -ve '"%u"')
d436 1
a436 1
	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>&- | hexdump -ve '"%u"')
@


1.119
log
@avoid surprises when changing the ssl key
@
text
@d1 2
a2 2
# $MirSecuCron$
# $MirOS: src/etc/rc,v 1.118 2013/09/28 19:55:18 tg Exp $
@


1.118
log
@ITIMER_PROF is driven from hardintr, not rtcintr, what a shame!
with this cprng(8) brings virtually no entropy but at pretty high
CPU cost nevertheless (I never liked it much, anyway…) so rid it
(think about adding jytter later)

basically we’ll need something that signals us at stathz intervals
(or profhz), for this to work
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.117 2013/09/11 18:55:56 tg Exp $
d667 1
a667 2
	ln /etc/ssl/private/default.key /etc/ssh/ssh_host_rsa_key || \
	    cp /etc/ssl/private/default.key /etc/ssh/ssh_host_rsa_key
@


1.117
log
@allow the user to shoot themselves into their own foot and run vbox

by popular request, especially annoying was asarch
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.116 2011/02/19 01:08:33 tg Exp $
d192 1
a192 2
# Gather some system-local entropy rather early, if possible (/usr = /)
[[ -x /usr/libexec/cprng ]] && /usr/libexec/cprng -pr16 >/dev/urandom &
a341 4
# Gather some system-local entropy rather early if allowed and /usr now mounted
[[ $cprng_flags != NO && -x /usr/libexec/cprng ]] && \
    /usr/libexec/cprng -pr32 >/dev/urandom &

a486 4
if [[ $cprng_flags != NO ]]; then
	echo -n ' cprng';		/usr/libexec/cprng $cprng_flags
fi

@


1.116
log
@distribute the shutdown sleeps a bit
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.115 2011/02/18 23:06:06 tg Exp $
d187 3
a189 1
	exit 1
@


1.115
log
@apply a limited amount of preventing the user from shooting into his foot
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.114 2011/02/13 21:17:13 tg Exp $
a146 2
	#XXX send SIGTERM to _most_ processes here
	#XXX except SIGTERM does not usually ask them to arc4random_atexit()...
d149 1
a149 1
	sleep 3.2		# wait “long enough”
@


1.114
log
@tweak the sleep (now that it's guaranteed that we can use fractions)
and switch terminal twice, if needed; also, use |& correctly
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.113 2011/01/15 21:52:38 tg Exp $
d185 7
@


1.113
log
@Introduce /etc/ssh/root:config and /etc/ssh/root:known_hosts
and /etc/ssh/root:authorised_keys for the superuser if his
HOME directory is unset, empty or, not normalised, "/" (root).
十̲CVS: ----------------------------------------------------------------------
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.112 2010/10/01 17:22:05 tg Exp $
d147 2
d151 1
a151 1
	sleep 7			# wait “long enough”
d158 1
d174 1
a174 1
		sleep 1
d331 1
@


1.112
log
@rework shutdown sequence random seed handling
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.111 2010/07/11 17:35:09 tg Exp $
d827 9
a835 10
if [[ $sshagent_autostart != NO ]]; then
	echo Setting up ssh-agent directories...
	mkdir -m 0755 /var/run/ssh-agent
	chown root:daemon /var/run/ssh-agent
	for luser in $sshagent_autostart; do
		mkdir -m 0700 /var/run/ssh-agent/$luser
		chown $luser /var/run/ssh-agent/$luser
		rm -f /var/run/ssh-agent/$luser/agent
	done
fi
@


1.111
log
@hexdump -e without -v in a script is almost always wrong
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.110 2010/07/11 11:56:04 tg Exp $
d145 12
a156 6
	(
		dd if=/var/db/host.random of=/dev/urandom
		(dd if=/dev/arandom count=3; dd if=/dev/urandom count=8) | \
		    dd of=/var/db/host.random && \
		    chmod 600 /var/db/host.random
	) >/dev/wrandom 2>&1 && if [[ -f /etc/rc.shutdown ]]; then
d169 5
a173 5
		{
			dd if=/dev/urandom of=/dev/arandom bs=4 count=1
			sleep 1
			dd if=/dev/arandom count=1 >>/var/db/host.random
		} >/dev/null 2>&1
@


1.110
log
@remove calls to “set ±o arc4random” from all scripts
(and the arc4random_uniform implementation in shell from
rc.netselect.common – could be done with dd(1) but is too
expensive, and not really needed here anyway)

YOU *WILL* NEED TO UPGRADE /etc/rc WITH THIS VERSION BEFORE
UPGRADING /bin/{sh,mksh} TO THIS MONTH’S CODE!
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.109 2009/11/15 12:30:22 tg Exp $
d406 1
a406 1
	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>&- | hexdump -e '"%u"')
d412 1
a412 1
	let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>&- | hexdump -e '"%u"')
@


1.109
log
@if gnu10.ngz isn’t installed, don’t freak out
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.108 2009/11/10 17:35:47 tg Exp $
a406 1
	set -o arc4random
@


1.108
log
@more proper print-builtin usage
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.107 2009/11/02 18:48:59 tg Exp $
d618 2
a619 1
if [[ -x /usr/libexec/vi.recover && -d /var/tmp/vi.recover ]]; then
@


1.107
log
@* no sense in checking for pflog0; if it fails, we'll at least
  know (by pflogd's error message) why spamlogd further below
  bails out
* optimise out the now-unneeded second call to ifconfig
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.106 2009/11/02 16:13:23 tg Exp $
d611 1
a611 1
	print "$x\n" >/etc/motd
@


1.106
log
@fix pflogd (required by spamlogd), discovered while updating my employer’s
spamfilter to MirOS-current as recommended in the announcement; hence this
commit is sponsored by tarent GmbH ☺
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.105 2009/09/12 14:32:53 tg Exp $
d466 1
a466 4
    if ifconfig pflog0 >/dev/null 2>&1; then
	ifconfig pflog0 up
	pflogd $pflogd_flags
fi
@


1.105
log
@the last one worked, this one looks like it even
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.104 2009/09/12 14:22:18 tg Exp $
d465 2
a466 2
if [[ $pf != NO && $pflogd_flags != NO && \
    " $(ifconfig -l) " = *@@( pflog0 )* ]]; then
@


1.104
log
@another try at fixing the wsconsctl thingie
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.103 2009/09/05 17:10:49 tg Exp $
d82 1
a82 2
	typeset save_IFS=$IFS
	typeset wsdevs dev
a84 4
	for dev in /dev/wskbd*; do
		[[ $(wsconsctl -ak $dev 2>/dev/null) = *=* ]] && \
		    wsdevs="$wsdevs $dev"
	done
d90 4
a93 3
		for dev in $wsdevs; do
			print -r -- "$dev: $(eval wsconsctl -k \$dev -w $1)"
		done 2>/dev/null
@


1.103
log
@fix entropy pool seed file state loss on unclean reboots and make
dealing with the seed file much more robust; also set $RANDOM for
e.g. /etc/rc.netselect use
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.102 2009/08/18 17:41:46 tg Exp $
d87 2
a88 1
		wsconsctl -k $dev >/dev/null 2>&1 && wsdevs="$wsdevs $dev"
d96 2
a97 2
			eval wsconsctl -k \$dev -w $1
		done
@


1.102
log
@really apply wsconsctl.conf to *all* devices (that respond)
/dev/wskbd1 misses wskbd2 (USB keyboard used in addition to PS/2 one),
/dev/wskbd won't work on my SS5
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.101 2009/08/13 17:47:57 tg Exp $
d400 2
a401 1
# a shutdown-less reboot occurs the next seed is not a repeat
d404 1
a404 1
	(dd if=/dev/arandom count=5; dd if=/dev/urandom count=3) | \
d407 10
a437 7
# reset arandom(4)
let RANDOM=$(dd if=/dev/arandom bs=4 count=1 2>&- | hexdump -e '"%d"')
set -o arc4random
typeset -i1 a=RANDOM b=RANDOM c=RANDOM d=RANDOM
print -n "${a#1#}${b#1#}${c#1#}${d#1#}" >/dev/arandom
unset a b c d

d446 1
a446 1
	(cd /dev; pax -rw -pe arandom null zero /var/anoncvs/dev/)
@


1.101
log
@• rc, rc.conf: new mountd_flags with usage example
• rc.conf: unify capitalisation of comments
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.100 2009/08/10 16:26:57 tg Exp $
d83 1
d86 3
d94 3
a96 1
		eval wsconsctl -k /dev/wskbd -w $1
@


1.100
log
@provide /dev/log in the anoncvs, BIND, httpd chroots
prompted by similar change in OpenBSD
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.99 2009/07/18 14:09:06 tg Exp $
d494 1
a494 1
	echo -n ' mountd';		mountd
@


1.99
log
@prevent data corruption from /etc/security’s automated backup cronjob
by using “MirSecuCron” as RCS ID for these and preventing it from ex-
panding any of the default keywords

also, add RCS IDs to almost all configuration files and enhance the
default changelist file
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.98 2009/03/29 13:04:16 tg Exp $
d428 12
d442 10
a451 1
if [[ -d /var/empty ]]; then
a617 11
# Initialise anoncvs chroot /dev directory
i=0
grep ':/var/anoncvs.*:/usr/libexec/anoncvssh$' /etc/master.passwd |&
while IFS=: read -p name pass rest; do
	[[ $pass = '*' ]] || i=1
done
(( i )) && if [[ -d /var/anoncvs/dev/. ]]; then
	mount_mfs -s 128 swap /var/anoncvs/dev
	(cd /dev; pax -rw -pe arandom null zero /var/anoncvs/dev/)
fi

@


1.98
log
@• take care of dbins
• #!/bin/mksh shebang, in most places
• rcsid while here
@
text
@d1 2
a2 2
# $Id$
# $MirOS: src/etc/rc,v 1.97 2009/02/22 19:13:23 tg Exp $
@


1.97
log
@hook tpmrng(8), to be written, into the system and installer
(you can never have enough entropy)
@
text
@d1 2
a2 1
# $MirOS: src/etc/rc,v 1.96 2009/02/11 16:19:54 tg Exp $
d415 1
a415 1
	PATH=/usr/dsbin:/sbin:/usr/dbin:/bin:/usr/sbin:/usr/bin
@


1.96
log
@make softdrives_ide setting other than NO (autodetect) work correctly
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.95 2009/01/13 21:11:21 tg Exp $
d454 4
@


1.95
log
@stty in rc has no effect, in profile works even in uxterm and screen
status is what I want, but the others don’t seem to hurt
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.94 2008/12/10 18:06:06 tg Exp $
d209 12
a220 9
i=0
[[ $softdrives_ide = NO ]] && softdrives_ide=""
while (( i < ${#_mp[*]} )); do
	if [[ ${_dev[i]} = /dev/wd+([0-9])[a-p] ]]; then
		_fdev=${_dev[i]#/dev/}
		softdrives_ide="$softdrives_ide ${_fdev%[a-p]}"
	fi
	let i++
done
@


1.94
log
@use relative paths to mksh
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.93 2008/12/04 16:27:18 tg Exp $
a130 2
stty status '^T'

@


1.93
log
@make sure keyboard.encoding goes to the wsmux1 keyboard mux (cf. wsmux(4))
instead of only wskbd1 (the first wskbd(4))
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.92 2008/11/29 17:03:51 tg Exp $
d604 1
a604 1
	/bin/mksh /etc/rc.once
@


1.92
log
@move anoncvs stub from /var/anoncvs/anoncvs to /var/anoncvs,
shell from /var/anoncvs/anoncvssh to /usr/libexec/anoncvssh,
devices are now on mfs, fix some typos etc. while here

=> /var/anoncvs and its subdirectories can now be mounted
   with nodev and nosuid

condition on the mfs mount: at least one user must exist
whose home directory is /var/anoncvs (or one of its sub-
directories), whose shell is /usr/libexec/anoncvssh, and
whose password is not empty ('*'); /var/anoncvs/dev will
be filled with arandom, null and zero.

also enforce stricter perms on cvs and rsync binaries in
the chroot (0110 root:_anoncvs)

do not change anything pertaining to the MirOS mirrors
yet, as these will have to be changed to match the new
default values with some OS upgrade later
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.91 2008/11/13 03:30:55 tg Exp $
d89 1
a89 1
		eval wsconsctl -w $1
@


1.91
log
@run rc.once before generating the ssh keys

inspired by irc discussion with swishy
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.90 2008/10/20 19:29:21 tg Exp $
d591 10
a600 4
# Copy over /dev/{null,zero} into anoncvs chroot, it needs it
[[ -c /var/anoncvs/anoncvs/dev/null && -c /var/anoncvs/anoncvs/dev/zero ]] || \
    [[ ! -d /var/anoncvs/anoncvs || ! -s /var/anoncvs/anoncvssh ]] || \
    pax -rw -pe /dev/{null,zero} /var/anoncvs/anoncvs
d798 2
a799 2
dev=$(dd if=/dev/rrd0c count=16 2>/dev/wrandom | cksum -a adler32)
[[ $dev = 1B32098C ]] && swapctl -ap0 /dev/rd0c
@


1.90
log
@• change mksh to only then behave more POSuXish when called as /bin/sh or
  “-sh” if -DMKSH_BINSHREDUCED was passed during compilation, for example
  for Debian, but d̲e̲f̲i̲n̲i̲t̲i̲v̲e̲l̲y̲ n̲̲o̲̲t̲̲ for MirBSD™
• split up regression test to force this behaviour
• remove the gunk from our MirBSD™ startup scripts again
• mention arc4random.c changes on website, sync clog, warn packagers
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.89 2008/10/20 18:20:31 tg Exp $
d596 5
a646 5
if [[ -e /etc/rc.once ]]; then
	print rc: running post-install hooks
	/bin/mksh /etc/rc.once
fi

@


1.89
log
@better safe than sorry: fixup and cleanup initial state
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.88 2008/10/20 18:04:03 tg Exp $
a8 1
set +o posix -o braceexpand +o utf8-hack
@


1.88
log
@how was that again about mksh having more to offer? *g*
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.87 2008/10/20 17:40:44 tg Exp $
d9 3
a11 5
set +o posix -o braceexpand
LC_CTYPE=en_US.UTF-8
HOME=/
PATH=/sbin:/bin:/usr/sbin:/usr/bin
export LC_CTYPE HOME PATH
@


1.87
log
@ARGH! This is run from /bin/sh but needs an mksh... brace expansion
and stuff, even.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.86 2008/08/31 18:05:59 tg Exp $
d73 1
a73 2
mixerctl_conf()
{
d83 1
a83 2
wsconsctl_conf()
{
d158 1
a158 1
			# Strip off /etc/hostname. prefix
a159 2
			test "$if" = "carp[0-9]*" && continue

d185 2
a186 2
	[[ -f /etc/raid${dev}.conf ]] && raidctl \
	    -c /etc/raid${dev}.conf raid$dev
a227 1
	set -o noglob
a235 1
	set +o noglob
d282 2
a283 2
		if ! mount -uwo "${_opt[i]}" "${_dev[i]}" / >/dev/null \
		    2>&1; then
d396 1
a396 1
(
d401 1
a401 1
) >/dev/wrandom 2>&1
d425 2
a426 3
typeset -Uui16 a b c d
let 'a = RANDOM & 0xFF' 'b = RANDOM & 0xFF' 'c = RANDOM & 0xFF' 'd = RANDOM & 0xFF'
print -n "\x${a#16#}\x${b#16#}\x${c#16#}\x${d#16#}" >/dev/arandom
d438 2
a439 2
[[ $pf != NO && $pflogd_flags != NO ]] && \
    if [[ " $(ifconfig -l) " = *@@( pflog0 )* ]]; then
d467 1
a467 1
    $(sed -e '/^#/d' </etc/exports | wc -l) -ne 0 ]]; then
@


1.86
log
@copy, not hardlink, to make independent updates easier
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.85 2008/07/12 19:15:37 tg Exp $
d9 1
@


1.85
log
@quell error message if no wscons attached
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.84 2008/06/27 21:14:44 tg Exp $
d632 1
a632 1
	ln /etc/ssl/default.cer /etc/ssl/deflt-ca.cer
@


1.84
log
@after having a 0-byte /etc/ttys for the umptieth time (due to use of
softupdates and crashes early in the uptime… which SHOULD NOT HAPPEN
according to how I understood softupdates: either the file is in the
version before or after the call to ed(1) but it seems to not adhere
to te spec…) I got fed up with this:
• if /etc/ttys does not include a console entry (/^console/), copy a
  fresh /etc/ttys.dist file as new /etc/ttys
• if /etc/ttys then (the dist version does) indicates automatic con-
  sole speed setup (via /acs\.[0-9]*/), do that

this also enables users to more easily disable that
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.83 2008/06/06 12:41:49 tg Exp $
d145 1
a145 1
	[[ -x /usr/sbin/wsconfig ]] && /usr/sbin/wsconfig -s 1
@


1.83
log
@fix error inherited by openbsd: running single-user mode, then shutting
down while /var was R/W mounted, could trash the saved entropy state as
it was never read; fix, increase save state size, honour entropy added
during rc.shutdown and ifdown run time
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.82 2008/03/27 14:03:31 tg Exp $
d785 10
a794 2
print '/^console/s/std.[0-9]*"/std.'$consspeed'"/\nwq' | \
    ed -s /etc/ttys >/dev/null 2>&1
@


1.82
log
@run ldconfig earlier, do not use fgrep before we had a chance to
try ldconfig, optimise a little
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.81 2008/03/27 13:49:53 tg Exp $
d148 2
a149 1
		(dd if=/dev/arandom count=2; dd if=/dev/urandom count=8) | \
d167 6
@


1.81
log
@sync stripcom() with mksh dot.profile (speedup)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.80 2008/03/27 13:48:27 tg Exp $
d311 7
a317 1
x=$(mount 2>/dev/null | fgrep ' on / ' 2>/dev/null)
d326 3
d408 9
d421 6
a426 1
( typeset -i8 x='RANDOM & 255'; print -n "\0${x#8#}" >/dev/arandom )
a588 9
if [[ -f /sbin/ldconfig ]]; then
	echo creating runtime link editor directory cache.
	[[ -d /usr/local/lib ]] && shlib_dirs="/usr/local/lib $shlib_dirs"
	[[ -d /usr/X11R6/lib ]] && shlib_dirs="/usr/X11R6/lib $shlib_dirs"
	[[ -d /usr/mpkg/lib ]] && shlib_dirs="/usr/mpkg/lib $shlib_dirs"
	ldconfig $shlib_dirs
	PATH=/usr/dsbin:/sbin:/usr/dbin:/bin:/usr/sbin:/usr/bin
fi

@


1.80
log
@add /usr/dbin, /usr/dsbin to the path: usually before /bin and /sbin except
in the root+single user case (etc/root.profile, etc/profile + SINGLE)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.79 2008/03/20 21:13:28 tg Exp $
d20 1
a20 2
	cat "$@@" | while read _line; do
		set -o noglob
d23 1
a23 1
	done
@


1.79
log
@more “interesting” RSA key handling
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.78 2007/09/28 20:46:54 tg Exp $
d573 1
@


1.78
log
@reduce writes to /dev/arandom, do them where necessary only
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.77 2007/09/25 15:57:48 tg Exp $
d585 8
a592 3
if [[ ! -f /etc/ssl/private/default.key || \
    ! -f /etc/ssl/default.cer || ! -f /etc/ssl/deflt-ca.cer ]]; then
	echo -n "openssl: generating new host RSA key... "
d598 2
a599 6
		openssl req -batch -new -subj "/CN=$(hostname)/" \
		    -key /etc/ssl/private/default.key \
		    -x509 -out /etc/ssl/default.cer
		chmod 644 /etc/ssl/default.cer
		ln /etc/ssl/default.cer /etc/ssl/deflt-ca.cer
		echo done.
d601 1
a601 1
		echo failed.
d604 12
a615 2
if [[ ! -f /etc/ssh/ssh_host_rsa_key ]]; then
	echo -n "ssh-keygen: installing host RSA key... "
d618 6
a623 1
	print $(ssh-keygen -yf /etc/ssh/ssh_host_rsa_key) \
d625 3
a627 1
	echo done.
@


1.77
log
@don’t run cprng if user disabled it (and we know about that at that time)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.76 2007/09/02 16:43:52 tg Exp $
d148 5
a152 4
	(dd if=/dev/arandom count=2; dd if=/dev/urandom count=8) \
	    2>/dev/wrandom | dd of=/var/db/host.random >/dev/wrandom 2>&1 && \
	    chmod 600 /var/db/host.random >/dev/wrandom 2>&1 && \
	    if [[ -f /etc/rc.shutdown ]]; then
d384 8
a391 5
# one through /dev/arandom; else reset seed file anyway so that
# if a shutdown-less reboot occurs the next seed is not a repeat
cat /var/db/host.random >/dev/arandom 2>&1
( (dd if=/dev/arandom count=5; dd if=/dev/urandom count=3) 2>/dev/wrandom | \
  dd of=/var/db/host.random; chmod 600 /var/db/host.random) >/dev/wrandom 2>&1
d403 3
d580 2
a581 3
[[ -d /var/anoncvs/anoncvs && -s /var/anoncvs/anoncvssh \
    && ! ( -c /var/anoncvs/anoncvs/dev/null \
    && -c /var/anoncvs/anoncvs/dev/zero ) ]] && \
d585 2
a586 3
if [[ ! -f /etc/ssl/private/default.key \
    || ! -f /etc/ssl/default.cer \
    || ! -f /etc/ssl/deflt-ca.cer ]]; then
@


1.76
log
@run a one-off cprng(8) rather early, to provide better entropy earlier
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.75 2007/08/24 14:38:37 tg Exp $
d316 3
a318 2
# Gather some system-local entropy rather early, if /usr is now mounted
[[ -x /usr/libexec/cprng ]] && /usr/libexec/cprng -pr32 >/dev/urandom &
@


1.75
log
@feature request from wbx@@ – ask the user which size he prefers for his host
key (RSA) instead of choosing a default which is barely not too heavy for a
SPARCstation 20 @@75 MHz or having to hand-edit /etc/rc after installation
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.74 2007/07/18 23:12:33 tg Exp $
d173 3
d316 3
@


1.74
log
@meh, just use daemon(3) [inlined, for portability and return codes/msgs]
and default to the profile clock instead of the system clock
(implications not scientifically proven yet)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.73 2007/07/07 23:47:33 tg Exp $
d577 1
a577 1
	# XXX 6000-8000 is recommended... choose 4096 to be nice to old boxen
@


1.73
log
@correct start of cprng
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.72 2007/07/07 20:32:05 tg Exp $
d415 2
a416 2
if [[ $cprng = YES ]]; then
	echo -n ' cprng';		(/usr/libexec/cprng &)
@


1.72
log
@add cprng, a RNG feeding entropy generated from the oscillation differences
between the CPU clock and the mainboard/bus clock into /dev/urandom (by de-
fault and if run by root), or writing them to stdout (under quite high load
for the CPU), after whitening. The entropy is quite good (if you get enough
to feed ports/math/ent), only the χ² lets me worry.

Tested on my systems:
• nwt (80486DX-33): 7.3 bit per byte, but as bad as rand()
• demo (SPARCstaion 20): 7.4 bit per byte, not much better
• herc (Pentium 233 MMX): 7.6 bit per byte, quality sort of okay
• odem (Athlon XP 500): 7.8 bit per byte, quality very good
• odem (Athlon XP 1200): 7.8 bit per byte, no difference to clocked-down

Instead of adding more post-processing or other functions to improve output
especially on the slower systems (I know I could manage quite something) it
is just fed to the kernel random(9) subsystem; users shall get /dev/arandom
if they require entropy of good quality or /dev/urandom if a high entrophic
values (actual randomness per bit) is desired (almost only for generating a
key for asymmetric cryptography, and even then you want to mix in a few bit
from arcfour).

This dæmon runs by default on our installer, installed system and the base-
live CD; users should disable it on their system after installation if they
have enough entropy sources (for example, interactive input). Users of slow
non-interactively-used servers should combine cprng with hotbits or similar
(see the commented out entries in the default crontab) for quality.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.71 2007/06/30 02:47:41 tg Exp $
d416 1
a416 1
	echo -n ' cprng';		/usr/libexec/cprng
@


1.71
log
@next part of the master plan; automatically adjust to the console baud rate
even makes the baselive CD – except for the bootloader choice menu – usable
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.70 2007/06/16 22:36:48 tg Exp $
d415 4
@


1.70
log
@• rc: run post-install script earlier
• rc, post-install script, installer: run the script in the foreground,
  move the “newaliases” call into it and let the script fork its own
  background processes off
• cronrun: new, to be used to run daily/weekly/monthly with locking
• post-install, crontab: use cronrun
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.69 2007/06/15 23:43:46 tg Exp $
a560 6
consdev=$(sysctl machdep.console_device 2>/dev/null)
consdev=${consdev#machdep.console_device=}
print -- "$consdev at $consspeed" | logger -t 'console information'
[[ -e /dev/$consdev || $consdev = console ]] || consdev=nochg
print -u2 "parsed console information: $consspeed $consdev"

d730 3
@


1.69
log
@fixup for integer, typeset, local
(not regenerating MAKEDEVs because they use #!/bin/mksh but still, for style)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.68 2007/06/11 21:23:14 tg Exp $
d602 5
d611 1
a611 1
# Same for the other dmons.
a783 4
if [[ -e /etc/rc.once ]]; then
	echo -n ' postinstall';	/bin/mksh /etc/rc.once >/dev/null 2>&1 &
fi

@


1.68
log
@nah, better, make it active only after rebooting
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.67 2007/06/09 15:00:57 tg Exp $
d30 3
a32 3
	local _fl=$1	# ulimit flag
	local _lc=$2	# login.conf name
	local n s
d86 1
a86 1
	local save_IFS=$IFS
d103 1
a103 1
	local dev mp fstype opt rest
d122 1
a122 1
	integer i=0
d124 1
a124 1
		integer j=i k=i+1
d194 1
a194 1
integer i=0
@


1.67
log
@• arptables can only be loaded after /usr is mounted
• while here, use ifconfig -l when appropriate
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.66 2007/06/04 08:36:36 tg Exp $
d478 1
@


1.66
log
@/dev/arandom is seeded with only 256 octets of entropy for 400k octets of
output; while its entropy quality is better than that of /dev/urandom its
randomness is worse, so use more of /dev/urandom for /var/db/host.random.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.65 2007/05/29 08:19:29 tg Exp $
d162 2
a163 1
			ifconfig $if >/dev/null 2>&1 && ifconfig $if down
a353 6
# load arp tables
if [[ $arptables = YES && -s /etc/arp.conf ]]; then
	echo Setting static ARP table entries
	arp -f /etc/arp.conf
fi

d369 6
d401 2
a402 2
[[ $pf != NO && $pflogd_flags != NO ]] && if ifconfig pflog0 \
    >/dev/null 2>&1; then
@


1.65
log
@• chdir to / before shutdowning, to avoid umount failures…
• rcsids, __CRAZY=Yes cleanup, etc. while here
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.64 2007/04/17 20:04:06 tg Exp $
d148 4
a151 3
	dd if=/dev/arandom of=/var/db/host.random bs=1024 count=8 \
	    >/dev/wrandom 2>&1 && chmod 600 /var/db/host.random \
	    >/dev/wrandom 2>&1 && if [[ -f /etc/rc.shutdown ]]; then
d378 2
a379 2
dd if=/dev/arandom of=/var/db/host.random bs=1024 count=8 >/dev/wrandom 2>&1
chmod 600 /var/db/host.random >/dev/wrandom 2>&1
@


1.64
log
@change our coding style for shell:

we already do not 'function\nfoo\n{' for shell, like style(9) requires for
C programming, but 'function foo\n{' instead. however, we could treat the
function keyword as indentation initialiser and use 'function foo {' (on a
line for itself) – it looks different, unusual, but acceptable, and mksh's
own output (dumping with the “functions” builtin) does that too (although,
its indentation style sucks, but is legible enough)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.63 2007/03/19 22:14:14 tg Exp $
d13 1
@


1.63
log
@remove mksh./.nbsh hack
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.62 2007/03/09 13:41:48 tg Exp $
d18 1
a18 2
function stripcom
{
d101 1
a101 2
function _fsswap
{
d120 1
a120 2
function _fssort
{
@


1.62
log
@run /etc/{daily,weekly,monthly} once as postinstall script
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.60 2007/03/09 13:05:10 tg Exp $
d6 2
a7 1
# is the controlling terminal. This is called with _PATH_BSHELL.
a13 14
case $KSH_VERSION in
*MIRBSD?KSH*)	;;
*)	for x in mksh ksh; do
		case $($x -c 'echo $KSH_VERSION') in
		*MIRBSD?KSH*)
			exec $x "$0" "$@@"
			;;
		esac
	done
	echo "$0: FATAL: need a mirbsd korn shell!" >&2
	exit 1
	;;
esac

@


1.61
log
@wsmoused(8) is a standard dæmon ;)
@
text
@d791 4
@


1.60
log
@sync spamd upgrades and libpcap, and some /etc stuff; read
• http://undeadly.org/cgi?action=article&sid=20070304035922&mode=expanded
• http://www.openbsd.org/faq/current.html#20070226
for details. In short:
• change rc.conf[.local]
• spamd.conf now lies in /etc/mail/
• greylisting is on by default
• the database has a new format
• there's some database sync stuff
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.59 2007/02/13 15:03:01 tg Exp $
d787 4
a794 4
if [[ $wsmoused_flags != NO && -x /usr/sbin/wsmoused ]]; then
	echo starting wsmoused...;	/usr/sbin/wsmoused $wsmoused_flags
fi

@


1.59
log
@move ssh-agent stuff to /var/run where it's also cleaned at boot,
like /tmp, but not cleaned during cron.daily… *grr*
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.58 2007/02/08 21:53:08 tg Exp $
d708 1
a708 1
	[[ $spamd_grey != NO ]] && spamd_flags="$spamd_flags -g"
d711 1
a711 1
	if [[ $spamd_grey != NO ]]; then
@


1.58
log
@always export LC_CTYPE=en_US.UTF-8 since we don't can anything else
agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.57 2007/02/02 16:45:10 tg Exp $
d753 2
a754 2
	mkdir -m 0755 /tmp/ssh-agent
	chown root:daemon /tmp/ssh-agent
d756 3
a758 3
		mkdir -m 0700 /tmp/ssh-agent/$luser
		chown $luser /tmp/ssh-agent/$luser
		rm -f /tmp/ssh-agent/$luser/agent
@


1.57
log
@make /dev/wrandom as alias for /dev/prandom but allow it to
be written to - I plan to emulate our entropy suite on other
OSes where /dev/prandom may be read-only emulated by pipes
or similar means
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.56 2007/01/18 23:55:00 tg Exp $
d8 1
d11 1
a11 1
export HOME PATH
@


1.56
log
@revert most of the >&- stuff, some apps don't work correctly then
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.55 2006/10/08 00:24:42 tg Exp $
d163 2
a164 2
	    >/dev/prandom 2>&1 && chmod 600 /var/db/host.random \
	    >/dev/prandom 2>&1 && if [[ -f /etc/rc.shutdown ]]; then
d385 1
a385 1
[[ -x /usr/sbin/eeprom ]] && eeprom 2>&1 | cksum -ba sha512 >/dev/prandom
d391 2
a392 2
dd if=/dev/arandom of=/var/db/host.random bs=1024 count=8 >/dev/prandom 2>&1
chmod 600 /var/db/host.random >/dev/prandom 2>&1
d402 1
a402 1
dmesg | tee /var/run/dmesg.boot | cksum -ba rmd160 >/dev/prandom
d592 1
a592 1
	    >/dev/prandom 2>&1; then
d747 1
a747 1
dev=$(dd if=/dev/rrd0c count=16 2>/dev/prandom | cksum -a adler32)
@


1.55
log
@add a few more entropy sources, some suggested by Vutral, but don't
scan for /*/PUTTY.RND and /*/RANDSEED.BIN ;-) and remove a stupid one;
move dmesg.boot code for installer from install.sub into firstrun
code, and initialise a counter in rnd.c to zero which was previously not (oO)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.54 2006/10/07 23:29:13 tg Exp $
d44 1
a44 1
	local _new _suf
d46 5
a50 5
	for _suf in "" -cur -max; do
		_new=$(getcap -f /etc/login.conf -s $_lc$_suf daemon 2>&-)
		if [[ -n $_new ]]; then
			[[ $_new = infinity ]] && _new=unlimited
			case $_suf {
d52 1
a52 1
				ulimit -S $_fl $_new
d55 1
a55 1
				ulimit -H $_fl $_new
d58 1
a58 1
				ulimit $_fl $_new
d162 3
a164 3
	dd if=/dev/arandom of=/var/db/host.random bs=1024 count=8 >&- 2>&- && \
	    chmod 600 /var/db/host.random >&- 2>&- && \
	    if [[ -f /etc/rc.shutdown ]]; then
d175 1
a175 1
			ifconfig $if >&- 2>&- && ifconfig $if down
d237 3
a239 2
		atactl /dev/r${drv}c secfreeze >&- 2>&-
		atactl /dev/r${drv}c writecachedisable >&- 2>&- || echo -n !
d285 1
a285 1
umount -a >&- 2>&-
d289 2
a290 1
		if ! mount -uwo "${_opt[i]}" "${_dev[i]}" / >&- 2>&-; then
d301 1
a301 1
				"${_mp[i]}" >&- 2>&-; then
d320 1
a320 1
x=$(mount 2>&- | fgrep ' on / ' 2>&-)
d335 1
a335 1
	if ifconfig lo0 inet6 >&- 2>&-; then
d342 1
a342 1
	if [[ "$(sysctl vfs.mounts.nfs 2>&-)" = *[1-9]* ]]; then
d378 2
a379 2
		x=$(mount 2>&- | fgrep " on ${_mp[i]} " 2>&-)
		[[ -z $x ]] && mount ${_mp[i]} >&- 2>&-
d391 2
a392 2
dd if=/dev/arandom of=/var/db/host.random bs=1024 count=8 >&- 2>&-
chmod 600 /var/db/host.random >&- 2>&-
d413 2
a414 1
[[ $pf != NO && $pflogd_flags != NO ]] && if ifconfig pflog0 >&- 2>&-; then
d506 1
a506 1
x=$(mount 2>&- | fgrep " on /tmp" 2>&-)
d572 1
a572 1
consdev=$(sysctl machdep.console_device 2>&-)
d591 2
a592 1
	if openssl genrsa -out /etc/ssl/private/default.key 4096 >&- 2>&-; then
d642 1
a642 1
if ifconfig lo0 inet6 >&- 2>&-; then
d677 1
a677 1
	( /usr/sbin/sendmail $sendmail_flags >&- 2>&- & )
d747 1
a747 1
dev=$(dd if=/dev/rrd0c count=16 2>&- | cksum -a adler32)
@


1.54
log
@on sparc, use the nvram to provide some additional entropy
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.53 2006/10/02 22:31:19 tg Exp $
d400 1
a400 1
dmesg >/var/run/dmesg.boot
@


1.53
log
@improve handling of rdate's output once again
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.52 2006/10/02 07:03:16 tg Exp $
d382 3
@


1.52
log
@start bringing the live CD into shape
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.51 2006/09/13 01:23:28 tg Exp $
d444 6
a449 2
	echo -n ' rdate'
	rdate_flags=$(rdate -s $rdate_flags 2>&1 | grep rdate: 2>&-)
d463 3
a465 1
[[ $rdate_flags = NO ]] || print -r -- $rdate_flags
@


1.51
log
@remove the /etc/ttys adjustment code for #9-stable
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.50 2006/08/24 12:54:58 tg Exp $
d199 2
a200 5
# Try to find out what is our console device
x=$(sysctl machdep.console_device); consdev=${x#machdep.console_device=}
consinfo="$(stty -f /dev/console speed) $consdev"
#print -u2 console information: $consinfo
[[ -e /dev/$consdev || $consdev = console ]] || consdev=nochg
d560 5
a564 2
# for debugging purposes, this code is even in #9-stable
print "at $consinfo" | logger -t 'console information'
@


1.50
log
@if the console device is (0,0) set it to nochg too
XXX probably reset it to wscons? see sparc code
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.49 2006/08/22 21:51:40 tg Exp $
d199 1
a199 1
# Try to find out what is our console device (no grep yet...)
d202 1
a202 1
print -u2 console information: $consinfo
d563 1
a564 64
[[ -e /etc/ttys ]] && if [[ $consdev != nochg ]]; then
#	print -n adjusting /etc/ttys ...
	print -n 'adjusting /etc/ttys.gen (for now)...'
	[[ -e /etc/ttys.gen ]] || cp /etc/ttys /etc/ttys.gen
	x=$(uname -m)
	local speed=${consinfo%% *}
	if [[ $x = i386 ]]; then
		# clean up if we don't match
		if ! grep "^#AUTOCONS:$consdev,$speed." /etc/ttys.gen >&- 2>&-; then
			print -n ' cleanup (i386)'
			ed -s /etc/ttys.gen <<-EOF
				%g/^#AUTOCONS/d
				%g/	#AUTOADD\$/d
				%g/	#AUTODEL\$/s/^#*//
				%g/	#AUTODEL\$/s///
				wq
			EOF
		fi
	fi
	# if consdev=ttyC0: wscons, no change needed
	if [[ $consdev = ttyC0 ]]; then
		print -n ' wscons'
		# wscons, reset to default on sparc, no action on i386
		if [[ $x = sparc ]]; then
			print -n ' (sparc)'
			ed -s /etc/ttys.gen <<-EOF
				/console.*suncons/s/^#*//
				/console.*std/s/^#*/#/
				wq
			EOF
		fi
	else
		# serial console, disable wscons
		print -n " serial ($speed bps)"
		if [[ $x = sparc ]]; then
			# we just use /dev/console for both
			# XXX what is this ttyC0 entry?
			print -n ' (sparc)'
			ed -s /etc/ttys.gen <<-EOF
				/console.*suncons/s/^#*/#/
				/console.*std/s/^#*//
				/console.*std/s/std.[0-9]*/std.$speed/
				wq
			EOF
		fi
		if [[ $x = i386 ]]; then
			# keep wscons but enable tty0X dev
			print -n ' (i386)'
			if ! grep "^$consdev	.*std.$speed\".*	on" \
			    /etc/ttys.gen >&- 2>&-; then
				print -n ' -> adding'
				ed -s /etc/ttys.gen <<-EOF
					%g/^$consdev	/s/^.*\$/#&	#AUTODEL/
					wq
				EOF
				cat >>/etc/ttys.gen <<-EOF
					$consdev	"/usr/libexec/getty std.$speed"	vt100	on  secure	#AUTOADD
					#AUTOCONS:$consdev,$speed.
				EOF
			fi
		fi
	fi
	print ' done.'
fi
@


1.49
log
@use the machdep.console_device sysctl(3) instead
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.48 2006/08/19 15:51:45 tg Exp $
d203 1
a203 1
[[ -e /dev/$consdev ]] || consdev=nochg		# XXX correct?
@


1.48
log
@change consdev= to look more like rootdev= before it's too widespread
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.47 2006/08/19 15:42:19 tg Exp $
d200 2
a201 6
x=
dmesg |&
while read -p line; do
	[[ $line = consdev=* ]] && x=${line#consdev=}
done
consinfo="$(stty -f /dev/console speed) ${x:-NONE}"
d203 1
a203 10
[[ $x = NULL ]] && x=
consdev=nochg
[[ -n $x ]] && if [[ $x = INTERNAL* ]]; then
	# wscons, for all we know
	consdev=ttyC0
elif [[ $x = REMOTE* || $x = NORMAL* ]]; then
	# remote: serial console
	# normal: shouldn't happen, serial console too
	consdev=${x##* }
fi
d563 2
a564 2
print "dev $consdev ($consinfo)" | logger -t 'console information'
if [[ $consdev != nochg ]]; then
d569 1
d595 1
a595 1
	elif [[ $consdev = *,* ]]; then
a596 1
		speed=${consinfo%% *}
d610 1
a610 1
			# keep wscons but scan for the correct tty dev
d612 11
a622 21
			td=
			for tc in /dev/tty*; do
				if [[ $(stat -f %Hr,%Lr $tc) = $consdev ]]; then
					td=${tc#/dev/}
					break
				fi
			done
			if [[ -n $td ]]; then
				print -n " @@/dev/$td"
				if ! grep "^$td	.*std.$speed\".*	on" \
				    /etc/ttys.gen >&- 2>&-; then
					print -n ' -> adding'
					ed -s /etc/ttys.gen <<-EOF
						%g/^$td	/s/^.*\$/#&	#AUTODEL/
						wq
					EOF
					cat >>/etc/ttys.gen <<-EOF
						$td	"/usr/libexec/getty std.$speed"	vt100	on  secure	#AUTOADD
						#AUTOCONS:$consdev,$speed.
					EOF
				fi
@


1.47
log
@fix that stuff called whitespace
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.46 2006/08/19 00:59:15 tg Exp $
d203 1
a203 1
	[[ $line = @@(consdev:\ )* ]] && x=${line#consdev: }
@


1.46
log
@even better: use a file /etc/ttys.gen for live-testing the code
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.45 2006/08/19 00:46:39 tg Exp $
d475 1
a475 1
[[ $rdate_flags = NO ]] || print -nr -- $rdate_flags
d579 1
a579 1
	print -n 'adjusting /etc/ttys (to /etc/ttys.gen for now)...'
d649 1
@


1.45
log
@beta: scan for console device information
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.44 2006/08/18 21:55:55 tg Exp $
d199 1
a199 1
# Try to find out what is our console device
d578 3
a580 1
	print adjusting /etc/ttys
d584 9
a592 6
		if ! grep "^#AUTOCONS:$consdev,$speed." /etc/ttys >&- 2>&-; then
			print dummy editing actions on /etc/ttys
			print \\t'%g/^#AUTOCONS/d'
			print \\t'%g/\t#AUTOADD$/d'
			print \\t'%g/\t#AUTODEL$/s/^#*//'
			print \\t'%g/\t#AUTODEL$/s/\t#AUTODEL$//'
d597 1
d600 6
a605 3
			print dummy editing actions on /etc/ttys
			print \\t'/console.*suncons/s/^#*//'
			print \\t'/console.*std/s/^#*/#/'
d610 1
d613 8
a620 4
			print dummy editing actions on /etc/ttys
			print \\t'/console.*suncons/s/^#*/#/'
			print \\t'/console.*std/s/^#*//'
			print \\t"/console.*std/s/std.[0-9]*/std.$speed/"
d624 1
a631 2
			[[ -n $td ]] && grep "^$td	.*std.$speed\".*	on" \
				    /etc/ttys >&- 2>&- && td=
d633 13
a645 4
				print dummy editing actions on /etc/ttys
				print \\t"g/^$td\t/s/^.*$/#&\t#AUTODEL/'
				print \\t"$td\t\"/usr/libexec/getty std.$speed\"\tvt100\ton  secure\t#AUTOADD"
				print \\t"#AUTOCONS:$consdev,$speed."
@


1.44
log
@adjust people with verbose rdate(8) calls
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.43 2006/08/16 23:14:17 tg Exp $
d199 19
d576 53
@


1.43
log
@use wsconfig(8) to switch to VT1 on shutdown
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.42 2006/08/16 18:46:14 tg Exp $
d441 2
a442 1
	echo -n ' rdate';		rdate -s $rdate_flags
d456 1
@


1.42
log
@prefer arc4random and don't htonl() its return value
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.41 2006/08/14 20:32:44 tg Exp $
d160 1
@


1.41
log
@rewrite stripcom/Lstripcom function, making use of the 'last command
of a pipeline is executed in a subshell' trick, don't use co-process
(because that's verbose twice in an interactive shell profile), move
the noglob block into the while and rid the redundant +o and local.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.40 2006/08/09 21:19:10 tg Exp $
d161 1
a161 1
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=8 >&- 2>&- && \
d379 1
a379 1
# one through /dev/urandom; else reset seed file anyway so that
d382 1
a382 1
dd if=/dev/urandom of=/var/db/host.random bs=1024 count=8 >&- 2>&-
@


1.40
log
@nuke unused (speed up), fix match rules
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.39 2006/08/09 21:14:56 tg Exp $
d32 2
a33 4
	local _line
	set -o noglob
	cat "$@@" |&
	while read -p _line; do
a36 1
	set +o noglob
@


1.39
log
@advanced shell tricks ;)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.38 2006/08/09 21:04:17 tg Exp $
d116 1
a116 1
# -> swapping is done on $_dev[] $_mp[] $_fstype[] $_opt[] $_rest[]
a124 1
	rest=${_rest[$1]}
a129 1
	_rest[$1]=${_rest[$2]}
a134 1
	_rest[$2]=$rest
d206 1
a206 1
set -A _dev _mp _fstype _opt _rest
a212 1
	_rest[i]=$_frest
d286 1
a286 1
	if [[ ${_mp[i]} = / && ${_opt[i]} != ro* ]]; then
d288 1
a288 1
			if [[ ${_opt[i]} != *softdep* ]]; then
d295 1
a295 1
	elif [[ ${_opt[i]} != *noauto* && ${_opt[i]} != @@(sw|xx)* ]]; then
d299 1
a299 1
				if [[ ${_opt[i]} != *softdep* ]]; then
@


1.38
log
@some 'let' is actually superfluous; clean up
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.37 2006/08/09 21:02:03 tg Exp $
d209 1
d235 1
a235 1
	_flags=""
d238 5
a242 7
		if [[ $_flags != *$drv* ]]; then
			echo -n " $drv"
			atactl /dev/r${drv}c secfreeze >&- 2>&-
			atactl /dev/r${drv}c writecachedisable >&- 2>&- || \
			    echo -n !
			_flags="$_flags $drv"
		fi
d304 3
a306 4
					echo -n "Warning: force-mounti"
					echo -n "ng unchecked ffs file"
					echo -n "system: ${_dev[i]}"
					echo " -> ${_mp[i]}  nosoftdep"
d321 2
a322 2
_flags=$(mount 2>&- | fgrep ' on / ' 2>&-)
[[ -z $_flags || $_flags = *\(*read-only* ]] && mount -uw /
d379 2
a380 2
		_flags=$(mount 2>&- | fgrep " on ${_mp[i]} " 2>&-)
		[[ -z $_flags ]] && mount ${_mp[i]} >&- 2>&-
d495 2
a496 2
_flags=$(mount 2>&- | fgrep " on /tmp" 2>&-)
if [[ -z $_flags ]]; then
d502 1
a502 1
elif [[ $_flags != *@@(type mfs)* ]]; then
d530 2
a531 2
v=$(sysctl -n kern.version | sed 1q)
[[ -s /etc/motd && "$([[ "$(head -1 /etc/motd)" != $v ]] && \
d535 1
a535 1
		$v
d542 1
a542 1
	print "$v\n" >/etc/motd
a543 1
unset v
d621 1
a621 2
	_flags="$dhcpd_flags $dhcpd_ifs"
	echo -n ' dhcpd';		/usr/sbin/dhcpd $_flags
@


1.37
log
@don't use _fstab, use real array size instead
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.36 2006/08/09 20:59:10 tg Exp $
d142 1
a142 3
	integer i j k

	let i=0
d144 1
a144 2
		let j=i
		let k='i+1'
d146 1
a146 1
			[[ ${_mp[k]} < ${_mp[j]} ]] && let j=k
d208 1
a208 1
let _fstab=0
d211 6
a216 6
	_dev[_fstab]=$_fdev
	_mp[_fstab]=$_fmp
	_fstype[_fstab]=$_ffstype
	_opt[_fstab]=${_fopt:-rw}
	_rest[_fstab]=$_frest
	let _fstab++
d221 1
a221 1
let i=0
d223 1
a223 1
while [[ $i -lt ${#_mp[*]} ]]; do
d289 1
a289 1
let i=0
d378 1
a378 1
let i=0
@


1.36
log
@add comment
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.35 2006/08/09 20:58:36 tg Exp $
d226 1
a226 1
while [[ $i -lt $_fstab ]]; do
d293 1
a293 1
while (( i < _fstab )); do
d382 1
a382 1
while (( i < _fstab )); do
@


1.35
log
@fix sorting routine
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.34 2006/08/09 20:55:46 tg Exp $
d166 2
@


1.34
log
@move PATH, HOME defns to top
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.33 2006/08/09 20:54:49 tg Exp $
d115 1
a115 1
# -> sorting is done on $_mp[] from 0 to $_fstab - 1
d142 1
a142 1
	local i j k
d145 1
a145 1
	while (( i < (_fstab - 1) )); do
d148 2
a149 4
		while (( k < _fstab )); do
			if [[ ${_mp[k]} < ${_mp[j]} ]]; then
				let j=k
			fi
d152 1
a152 1
		_fsswap $i $j
@


1.33
log
@sync stripcom function
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.32 2006/08/09 14:30:20 tg Exp $
d8 4
d14 1
a14 1
*)	for x in /bin/mksh /bin/ksh; do
d21 1
a21 1
	/bin/echo "$0: FATAL: need a mirbsd korn shell!" >&2
a167 3
export HOME=/
export PATH=/sbin:/bin:/usr/sbin:/usr/bin

@


1.32
log
@bring back some absolute pathnames (for daemons, they might need it)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.31 2006/08/09 14:25:06 tg Exp $
d24 2
a25 2
# Strip comments (and leading/trailing whitespace if IFS is set)
# from one or more file(s) given (or stdin if none) and spew to stdout
a28 1

d33 1
a33 1
		[[ -n $_line ]] && echo $_line
@


1.31
log
@more redundant commentary
this needs a serious rewrite in parts
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.30 2006/08/09 14:15:16 tg Exp $
d616 1
a616 1
	echo -n ' ospfd';		ospfd $ospfd_flags
d620 1
a620 1
	echo -n ' bgpd';		bgpd $bgpd_flags
d628 1
a628 1
	echo -n ' dhcpd';		dhcpd $_flags
d636 1
a636 1
			rtsold $rtsold_flags
d641 1
a641 1
			route6d $route6d_flags
d645 1
a645 1
			rtadvd $rtadvd_flags
d672 1
a672 1
	echo -n ' httpd';		httpd $httpd_flags
d680 1
a680 1
	echo -n ' ftp-proxy';		ftp-proxy $ftpproxy_flags
d724 1
a724 1
	echo -n ' isdnd';		isdnd $isdnd_flags
d754 1
a754 1
	echo -n ' apmd';	apmd $apmd_flags
d758 1
a758 1
	echo -n ' acpid';	acpid $acpid_flags
d762 1
a762 1
	echo -n ' sensorsd';	sensorsd $sensorsd_flags
d766 1
a766 1
	echo -n ' hotplugd';	hotplugd $hotplugd_flags
d770 1
a770 1
	echo -n ' watchdogd';	watchdogd $watchdogd_flags
d780 1
a780 1
	echo starting wsmoused...;	wsmoused $wsmoused_flags
@


1.30
log
@remove redundant comment
make mixerctl not quiet (like sysctl and wsconsctl)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.29 2006/08/09 14:11:56 tg Exp $
a210 1
# Must use a co-process because pipes are executed in a subshell in pdksh
@


1.29
log
@spare the subshell
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.28 2006/08/09 14:08:29 tg Exp $
a68 1
	# delete comments and blank lines
a88 1
	# delete comments and blank lines
d91 1
a91 1
		mixerctl -q $1 >&- 2>&-
a100 1
	# delete comments and blank lines
@


1.28
log
@simplify further:
* make use of $PATH
* case foo in a) -> case foo { (a)
* case -> if, when possible
* >/dev/null -> >&- (idea from freewrt)

some of that code deserves more polishing though
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.27 2006/08/09 13:31:38 tg Exp $
d31 2
a32 1
	cat "$@@" | while read _line; do
@


1.27
log
@remove utter nonsense, simplify

first part, we run on MirOS usually, with a backup chance
second part, cf. *(autoconf-2.60.info)Shell Substitutions::
and change ${foo} into $foo when possible
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.26 2006/08/09 12:46:50 tg Exp $
d9 1
a9 1
*MIRBSD?KSH*) ;;
d13 2
a14 1
			exec $x "$0" "$@@" ;;
d46 1
a46 2
		_new=$(getcap -f /etc/login.conf -s $_lc$_suf \
		    daemon 2>/dev/null)
d50 1
a50 1
			-cur)
d53 1
a53 1
			-max)
d56 1
a56 1
			*)
d70 1
a70 1
	while [ $# -ge 1 ] ; do
d74 1
a74 1
		kern.maxproc=*)
d77 1
a77 1
		kern.maxfiles=*)
d91 2
a92 2
	while [ $# -ge 1 ] ; do
		mixerctl -q $1 >/dev/null 2>&1
d107 2
a108 2
	while [ $# -ge 1 ] ; do
		eval /sbin/wsconsctl -w $1
d172 3
a174 3
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=8 \
	    >/dev/null 2>&1 && chmod 600 /var/db/host.random \
	    >/dev/null 2>&1 && if [[ -f /etc/rc.shutdown ]]; then
d185 1
a185 1
			ifconfig $if >/dev/null 2>&1 && ifconfig $if down
d243 1
a243 4
		case $_flags {
		*$drv*)
			;;	# Already done
		*)
d245 3
a247 4
			/sbin/atactl /dev/r${drv}c secfreeze \
			    >/dev/null 2>&1
			/sbin/atactl /dev/r${drv}c writecachedisable \
			    >/dev/null 2>&1 || echo -n !
d249 1
a249 2
			;;
		}
d262 1
a262 1
	0)
d264 1
a264 1
	2)
d267 1
a267 1
	4)
d273 1
a273 1
	8)
d277 1
a277 1
	12)
d281 1
a281 1
	130)
d285 1
a285 1
	*)
d294 1
a294 1
umount -a >/dev/null 2>&1
d298 3
a300 5
		mount -uwo "${_opt[i]}" "${_dev[i]}" / >/dev/null 2>&1
		if [[ $? -ne 0 ]]; then
			case ${_opt[i]} {
			*softdep*)	;;
			*)	echo -n 'WARNING: Your root filesystem failed'
d303 1
a303 2
				;;
			}
d306 9
a314 23
	else
		case ${_opt[i]} {
		*noauto*)
			;;
		sw*)
			;;	# Swap
		xx*)
			;;	# ignore totally
		*)
			if [[ ${_fstype[i]} = ffs ]]; then
				mount -t ffs -o "${_opt[i]}" "${_dev[i]}" \
					"${_mp[i]}" >/dev/null 2>&1
				if [[ $? -ne 0 ]]; then
					case ${_opt[i]} {
					*softdep*)	;;
					*)	echo -n "Warning: force-mounti"
						echo -n "ng unchecked ffs file"
						echo -n "system: ${_dev[i]}"
						echo " -> ${_mp[i]}  nosoftdep"
						;;
					}
					mount -f -t ffs -o "${_opt[i]}" \
					    "${_dev[i]}" "${_mp[i]}"
d316 1
a316 4
			elif [[ ${_fstype[i]} = nfs ]]; then
				: # Ignore NFS this early in the boot process
			else
				mount -t "${_fstype[i]}" -o "${_opt[i]}" \
d319 5
a323 2
			;;
		}
d329 1
a329 1
_flags=$(mount 2>/dev/null | fgrep ' on / ' 2>/dev/null)
d344 1
a344 1
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
d351 1
a351 2
	case $(sysctl vfs.mounts.nfs 2>/dev/null) in
	*[1-9]*)
d356 1
a356 2
		;;
	esac
d378 1
a378 1
	/usr/sbin/arp -f /etc/arp.conf
d387 2
a388 2
		_flags=$(mount 2>/dev/null | fgrep " on ${_mp[i]} " 2>/dev/null)
		[[ -z $_flags ]] && mount ${_mp[i]} >/dev/null 2>&1
d397 2
a398 3
dd if=/dev/urandom of=/var/db/host.random bs=1024 count=8 \
    >/dev/null 2>&1
chmod 600 /var/db/host.random >/dev/null 2>&1
d419 1
a419 2
[[ $pf != NO && $pflogd_flags != NO ]] && if ifconfig pflog0 \
    >/dev/null 2>&1; then
d503 1
a503 1
_flags=$(mount 2>/dev/null | fgrep " on /tmp" 2>/dev/null)
d583 1
a583 2
	if /usr/sbin/openssl genrsa -out /etc/ssl/private/default.key 4096 \
	    >/dev/null 2>&1; then
d585 1
a585 1
		/usr/sbin/openssl req -batch -new -subj "/CN=$(hostname)/" \
d599 1
a599 1
	print $(/usr/bin/ssh-keygen -yf /etc/ssh/ssh_host_rsa_key) \
d619 1
a619 1
	echo -n ' ospfd';		/usr/sbin/ospfd $ospfd_flags
d623 1
a623 1
	echo -n ' bgpd';		/usr/sbin/bgpd $bgpd_flags
d631 1
a631 1
	echo -n ' dhcpd';		/usr/sbin/dhcpd $_flags
d634 1
a634 1
if ifconfig lo0 inet6 >/dev/null 2>&1; then
d639 1
a639 1
			/usr/sbin/rtsold $rtsold_flags
d644 1
a644 1
			/usr/sbin/route6d $route6d_flags
d648 1
a648 1
			/usr/sbin/rtadvd $rtadvd_flags
d669 1
a669 1
	( /usr/sbin/sendmail $sendmail_flags >/dev/null 2>&1 & )
d675 1
a675 1
	echo -n ' httpd';		/usr/sbin/httpd $httpd_flags
d683 1
a683 1
	echo -n ' ftp-proxy';		/usr/sbin/ftp-proxy $ftpproxy_flags
d727 1
a727 1
	echo -n ' isdnd';		/usr/sbin/isdnd $isdnd_flags
d739 1
a739 1
dev=$(dd if=/dev/rrd0c count=16 2>/dev/null | cksum -a adler32)
d757 1
a757 1
	echo -n ' apmd';	/usr/sbin/apmd $apmd_flags
d761 1
a761 1
	echo -n ' acpid';	/usr/sbin/acpid $acpid_flags
d765 1
a765 1
	echo -n ' sensorsd';	/usr/sbin/sensorsd $sensorsd_flags
d769 1
a769 1
	echo -n ' hotplugd';	/usr/sbin/hotplugd $hotplugd_flags
d773 1
a773 1
	echo -n ' watchdogd';	/usr/sbin/watchdogd $watchdogd_flags
d783 1
a783 1
	echo starting wsmoused...;	/usr/sbin/wsmoused $wsmoused_flags
@


1.26
log
@oops, missed this in commitid 10044D776701324514E
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.25 2006/07/21 16:40:30 tg Exp $
d8 10
a17 19
# Force a mirbsd korn shell
case x$KSH_VERSION in
*MIRBSD?KSH*)
	unset KSH_TRY
	;;
x)
	if test x"$KSH_TRY" = x"1"; then
		echo "$0: FATAL: need mirbsdksh!"
		exit 1
	fi
	KSH_TRY=1
	export KSH_TRY
	;;
*)
	if test x"$KSH_TRY" = x"1"; then
		unset KSH_TRY
	else
		export KSH_TRY=1
	fi
a19 5
test x"$KSH_TRY" = x"1" && for x in mksh pdksh ksh93 ksh ksh88 ash sh; do
	test -x /bin/$x && exec /bin/$x $0 "$@@"
done
[[ $KSH_VERSION = @@(@@\(#\)MIRBSD KSH R)* ]] || \
    echo "$0: WARNING: need mirbsdksh, not just any ksh!"
d40 2
a41 2
	local _fl="$1"	# ulimit flag
	local _lc="$2"	# login.conf name
d45 1
a45 1
		_new=$(getcap -f /etc/login.conf -s ${_lc}${_suf} \
d99 1
a99 1
	local save_IFS="$IFS"
d106 1
a106 1
	IFS="$save_IFS"
d120 17
a136 17
	dev="${_dev[$1]}"
	mp="${_mp[$1]}"
	fstype="${_fstype[$1]}"
	opt="${_opt[$1]}"
	rest="${_rest[$1]}"

	_dev[$1]="${_dev[$2]}"
	_mp[$1]="${_mp[$2]}"
	_fstype[$1]="${_fstype[$2]}"
	_opt[$1]="${_opt[$2]}"
	_rest[$1]="${_rest[$2]}"

	_dev[$2]="$dev"
	_mp[$2]="$mp"
	_fstype[$2]="$fstype"
	_opt[$2]="$opt"
	_rest[$2]="$rest"
d217 5
a221 5
	_dev[_fstab]="$_fdev"
	_mp[_fstab]="$_fmp"
	_fstype[_fstab]="$_ffstype"
	_opt[_fstab]="${_fopt:-rw}"
	_rest[_fstab]="$_frest"
d231 1
a231 1
		_fdev="${_dev[i]#/dev/}"
d244 1
a244 1
		*${drv}*)
d351 1
a351 1
_flags="$(mount 2>/dev/null | fgrep ' on / ' 2>/dev/null)"
d411 1
a411 2
		_flags="$(mount 2>/dev/null \
		    | fgrep " on ${_mp[i]} " 2>/dev/null)"
d502 1
a502 1
[[ -d /var/crash ]] && savecore ${savecore_flags} /var/crash
d529 1
a529 1
_flags="$(mount 2>/dev/null | fgrep " on /tmp" 2>/dev/null)"
d560 1
a560 1
	sysctl kern.securelevel=${securelevel}
d722 1
a722 1
	echo -n ' sshd';		/usr/sbin/sshd ${sshd_flags};
d726 2
a727 2
	[[ $spamd_grey != NO ]] && spamd_flags="${spamd_flags} -g"
	echo -n ' spamd';		eval /usr/libexec/spamd ${spamd_flags}
d792 1
a792 1
	echo -n ' sensorsd';	/usr/sbin/sensorsd ${sensorsd_flags}
d796 1
a796 1
	echo -n ' hotplugd';	/usr/sbin/hotplugd ${hotplugd_flags}
d800 1
a800 1
	echo -n ' watchdogd';	/usr/sbin/watchdogd ${watchdogd_flags}
@


1.25
log
@* move rc.local up a little
* move /dev/rd0c-as-swap logic to after rc.local
* scan the first two pages of /dev/rrd0c prior to using it automagically
  - first page may contain disklabel created earlier in the process
  - second page may already be used by UVM/swap

better safe than sorry, although this slightly reduces usability on
_very-low-memory_ machines (these better not use GENERIC then anyway,
besides we'd need to enable swap before fsck anyway then so it doesn't
really matter)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.24 2006/07/21 16:30:35 tg Exp $
d786 2
a787 2
	mkdir -m 0755 /tmp/.ssh-agent
	chown root:daemon /tmp/.ssh-agent
d789 3
a791 3
		mkdir -m 0700 /tmp/.ssh-agent/$luser
		chown $luser /tmp/.ssh-agent/$luser
		rm -f /tmp/.ssh-agent/$luser/agent
@


1.24
log
@refine /dev/rd0c-as-swap detection algorithm
in the kernel, use memcmp i.p.v. strncmp for comparing memory regions
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.23 2006/06/17 19:24:44 tg Exp $
a513 5
# Only if it exists and is an unused ram disc array.
# Compare approximately like the kernel does, except
# we checksum the first sector instead of memcmping.
dev=$(dd if=/dev/rrd0c count=1 2>/dev/null | cksum -a adler32)
[[ $dev = A261098C ]] && swapctl -ap0 /dev/rd0c
d776 8
a794 2
[[ -f /etc/rc.local ]] && . /etc/rc.local

@


1.23
log
@Ignore NFS this early in the boot process
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.22 2006/06/15 19:56:43 tg Exp $
d514 5
a518 1
[[ $(uname -vm 2>/dev/null) = GENERIC*i386 ]] && swapctl -ap0 /dev/rd0c
@


1.22
log
@pregenerate a kvm_bsd.db on kernel build;
allow the user to not run kvm_mkdb(8) on boot

this is for people (mostly) building (custom) kernels,
wanting to not load debugging symbols into (precious) RAM
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.21 2006/06/11 23:52:25 tg Exp $
d352 2
@


1.21
log
@optimise further (catch error case too)
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.20 2006/06/11 23:41:26 tg Exp $
d527 4
a530 2
echo -n " kvm"
kvm_mkdb
@


1.20
log
@more efficient motd patching
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.19 2006/04/05 23:56:54 tg Exp $
d577 10
a586 10
if [[ -s /etc/motd ]]; then
	[[ "$(head -1 /etc/motd)" != $v ]] && ed -s /etc/motd <<-EOF
		1,/^\$/d
		0a
			$v

		.
		wq
	EOF
else
d590 1
a590 1
unset y
@


1.19
log
@no quotes behind "case" necessary
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.18 2006/04/05 23:56:05 tg Exp $
d576 10
a585 7
[[ -f /etc/motd ]] || install -c -o root -g wheel -m 664 /dev/null /etc/motd
if T=$(mktemp /tmp/_motd.XXXXXXXXXX); then
	sysctl -n kern.version | sed 1q >$T
	echo >>$T
	sed '1,/^$/d' </etc/motd >>$T
	cmp -s $T /etc/motd || install -c -o root -g wheel -m 664 $T /etc/motd
	rm -f $T
d587 2
a588 1
	echo 'warning: mktemp(1) failed. Please check for possible reasons.'
d590 1
@


1.18
log
@support read-only root FSes
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.17 2006/03/27 09:49:58 tg Exp $
d9 1
a9 1
case "x$KSH_VERSION" in
d63 1
a63 1
			case "$_suf" {
d257 1
a257 1
		case "$_flags" {
d319 1
a319 1
			case "${_opt[i]}" {
d329 1
a329 1
		case "${_opt[i]}" {
d341 1
a341 1
					case "${_opt[i]}" {
@


1.17
log
@ordinarily, a 4 KiB /var/db/host.random should be enough,
because the kernel state is not larger anyway, but use 8K
to be on the safe side, and shrink the size of the output
of the shuffle script too (and let it reset prandom).
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.16 2006/01/31 09:49:22 tg Exp $
d316 1
a316 1
	if [[ ${_mp[i]} = / ]]; then
@


1.16
log
@* set up wscons(4) early
  From: Michael Knudsen <e@@molioner.dk>
  but not quite reverse's patch - do it after sysctl(8) setup
* sync with openbsd (set up mixers late)
@
text
@d1 1
a1 1
# $MirOS$
d186 1
a186 1
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
d434 1
a434 1
dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
@


1.15
log
@fix typo

surprisingly enough, this works while ssh-keygen(1) -E often doesn't
@
text
@d1 2
a2 2
# $MirOS: src/etc/rc,v 1.14 2006/01/24 21:43:16 tg Exp $
# $OpenBSD: rc,v 1.276 2005/11/30 16:04:33 tom Exp $
d399 2
a400 1
mixerctl_conf
d766 1
a766 1
wsconsctl_conf
@


1.14
log
@* Tonnerre Lombard says that Ron Rivest says that 6 to 8 Kilobits
  are currently recommended for new RSA keys; choose 4096 for the
  host RSA key (/etc/ssl/private/default.key) as a compromise for
  being nice to older boxen such as a Pentium I or SPARCstation.
* Use the same RSA host key as SSH host key - saves us generation
  of another RSA key by default
* Don't generate the ISAKMPD keys automatically any more
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.13 2005/12/04 14:40:45 tg Exp $
d632 1
a632 1
	print $(/usr/bin-ssh-keygen -yf /etc/ssh/ssh_host_rsa_key) \
@


1.13
log
@ftp-proxy
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.12 2005/10/27 12:59:24 tg Exp $
a601 10
if [[ ! -f /etc/ssh/ssh_host_rsa_key ]]; then
	echo -n "ssh-keygen: generating new RSA host key... "
	if /usr/bin/ssh-keygen -q -t rsa -f /etc/ssh/ssh_host_rsa_key \
	    -N ''; then
		echo done.
	else
		echo failed.
	fi
fi

d614 2
a615 2
	# XXX 1024 is *weak*, even 2048 is less than minimum
	if /usr/sbin/openssl genrsa -out /etc/ssl/private/default.key 1024 \
d628 7
a634 12

if [[ ! -f /etc/isakmpd/private/local.key ]]; then
	echo -n "openssl: generating new isakmpd RSA key... "
	if /usr/sbin/openssl genrsa -out /etc/isakmpd/private/local.key 1024 \
	    >/dev/null 2>&1; then
		chmod 600 /etc/isakmpd/private/local.key
		/usr/sbin/openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout >/dev/null 2>&1
		echo done.
	else
		echo failed.
	fi
@


1.12
log
@if GENERIC#nnn i386 kernel, add /dev/rd0c to swap devices (quite late tho)
@
text
@d1 2
a2 2
# $MirOS: src/etc/rc,v 1.11 2005/09/20 18:37:41 tg Exp $
# $OpenBSD: rc,v 1.270 2005/06/19 16:55:10 deraadt Exp $
d468 1
a468 1
echo -n starting rpc daemons:
d707 1
a707 1
	echo -n ' printer';		lpd $lpd_flags
d730 4
d814 4
@


1.11
log
@add /usr/mpkg/lib to default shlib_dirs
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.10 2005/07/24 16:20:21 tg Exp $
d511 1
@


1.10
log
@* merge
* obsolete /etc/kbdtype (reads: it is no longer used)
* fix some permissions on temp dirs, use stat(1), etc.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.9 2005/07/02 12:17:55 tg Exp $
d593 1
@


1.9
log
@rather than patching init(8) cope with being called by _PATH_BSHELL instead.
@
text
@d1 1
a1 1
# $MirOS: src/etc/rc,v 1.8 2005/07/02 11:28:30 tg Exp $
d59 2
a60 1
		_new=$(getcap -f /etc/login.conf -s ${_lc}${_suf} daemon 2>/dev/null)
a371 6
if [[ -x /sbin/kbd && -s /etc/kbdtype ]]; then
	[[ -f /etc/wsconsctl.conf ]] && \
	    echo warning: better use wsconsctl.conf instead of /etc/kbdtype!
	kbd $(</etc/kbdtype)
fi

d557 1
d559 2
a560 6
			if [[ $(ls -ld $d | cut -d' ' -f4) != root ]]; then
				chown root $d
			fi
			if [[ $(ls -ld $d | cut -d' ' -f1) != drwxrwxrwt ]]; then
				chmod 1777 $d
			fi
a562 2
		else
			mkdir -p -m 1777 $d
@


1.8
log
@* them -> then (bugfix)
* nuke some ifs
* style
* make more use of mksh
@
text
@d1 1
a1 2
#!/bin/mksh
# $MirOS: src/etc/rc,v 1.7 2005/07/01 15:21:33 tg Exp $
d6 28
a33 2
# is the controlling terminal.
# This script must be run with the korn shell as /bin/sh.
@


1.7
log
@rc.netselect plug
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.6 2005/07/01 15:20:40 tg Exp $
d36 2
a37 4
			if [[ $_new = infinity ]]; then
				_new=unlimited
			fi
			case "$_suf" in
d48 1
a48 1
			esac
d61 1
a61 1
		case $1 in
d68 1
a68 1
		esac
d126 1
d132 1
a132 1
	while [[ $i -lt $((_fstab-1)) ]]; do
d135 1
a135 1
		while [[ $k -lt $_fstab ]]; do
d139 1
a139 1
			let k='k+1'
d142 1
a142 1
		let i='i+1'
d158 1
a158 1
if [[ $1 == shutdown ]]; then
d161 2
a162 3
	    >/dev/null 2>&1
	chmod 600 /var/db/host.random >/dev/null 2>&1
	if [[ $? -eq 0 && -f /etc/rc.shutdown ]]; then
d173 1
a173 4
			ifconfig $if >/dev/null 2>&1
			if [[ $? != 0 ]]; then
				ifconfig $if down
			fi
d176 1
a176 4
		if [[ $powerdown == YES ]]; then
			exit 2
		fi

d184 1
a184 3
if [[ -f /etc/ccd.conf ]]; then
	ccdconfig -C
fi
d188 2
a189 3
	if [[ -f /etc/raid${dev}.conf ]]; then
		raidctl -c /etc/raid${dev}.conf raid$dev
	fi
d210 1
a210 1
	let _fstab='_fstab+1'
d218 1
a218 1
	if [[ ${_dev[i]} = /dev/wd+([0-9])[a-p] ]]; them
d227 1
a227 1
	echo -n "Disabling HDD hardware write caches..."
d250 3
a252 3
	echo "Fast boot: skipping disk checks."
elif [[ $1 == autoboot ]]; then
	echo "Automatic boot in progress: starting file system checks."
d261 1
a261 1
		echo "Rebooting..."
d271 1
a271 1
		echo "Boot interrupted."
d285 1
a285 1
trap "echo 'Boot interrupted.'; exit 1" 3
d289 2
a290 2
while [[ $i -lt $_fstab ]]; do
	if [[ ${_mp[i]} == / ]]; then
d311 1
a311 1
			if [[ ${_fstype[i]} == ffs ]]; then
d336 4
d343 1
a343 1
echo 'setting tty flags'
d346 1
a346 1
if [[ -f /sbin/kbd && -f /etc/kbdtype ]]; then
d348 1
a348 1
	    echo "warning: better use wsconsctl.conf instead of /etc/kbdtype!"
d382 1
a382 1
echo 'starting network'
d391 2
a392 2
if [[ $arptables == YES && -e /etc/arp.conf ]]; then
	echo 'Setting static ARP table entries'
d396 9
a404 3
if [[ $pf != NO ]]; then
	if [[ -f $pf_rules ]]; then
		pfctl -f "$pf_rules"
d406 2
a407 4
fi

mount /usr >/dev/null 2>&1
mount /var >/dev/null 2>&1
d421 2
a422 2
(cd /var/run && { rm -rf -- *; install -c -m 664 -g utmp /dev/null utmp; })
(cd /var/authpf && rm -rf -- *)
d427 1
a427 1
echo 'starting system logger'
d445 1
a445 1
	echo 'starting isakmpd';	isakmpd $isakmpd_flags
d448 1
a448 1
echo -n 'starting rpc daemons:'
d452 1
a452 1
if [[ $portmap == YES ]]; then
d460 1
a460 1
if [[ $nfs_server == YES && -s /etc/exports && \
d466 1
a466 1
	if [[ $lockd == YES ]]; then
d486 1
a486 1
echo '.'
d494 1
a494 3
if [[ -d /var/crash ]]; then
	savecore ${savecore_flags} /var/crash
fi
d496 2
a497 2
if [[ $check_quotas == YES ]]; then
	echo -n 'checking quotas:'
d499 1
a499 1
	echo ' done.'
d504 1
a504 1
echo -n 'building ps databases:'
d509 1
a509 1
echo "."
d515 2
a516 4
if [[ -f /etc/ptmp ]]; then
	logger -s -p auth.err \
	'password file may be incorrect -- /etc/ptmp exists'
fi
d519 2
a520 8

if mount 2>&1 | grep -F " on /tmp" >/dev/null 2>&1; then
	# prune quickly with one rm, then use find to clean up /tmp/[lq]*
	# (not needed with mfs /tmp, but doesn't hurt there...)
	(cd /tmp && rm -rf [a-km-pr-zA-Z]* &&
	    find . ! -name . ! -name lost+found ! -name quota.user \
		! -name quota.group -execdir rm -rf -- {} \; -type d -prune)
else
d526 5
d547 1
a547 1
			mkdir -m 1777 $d
d559 2
a560 5
if [[ ! -f /etc/motd ]]; then
	install -c -o root -g wheel -m 664 /dev/null /etc/motd
fi
T=$(mktemp /tmp/_motd.XXXXXXXXXX)
if [[ $? -eq 0 ]]; then
d562 1
a562 1
	echo "" >>$T
d564 1
a564 1
	cmp -s $T /etc/motd || cp $T /etc/motd
d571 1
a571 1
	echo 'turning on accounting';	accton /var/account/acct
d575 3
a577 7
	echo 'creating runtime link editor directory cache.'
	if [[ -d /usr/local/lib ]]; then
		shlib_dirs="/usr/local/lib $shlib_dirs"
	fi
	if [[ -d /usr/X11R6/lib ]]; then
		shlib_dirs="/usr/X11R6/lib $shlib_dirs"
	fi
d581 2
a582 2
if [[ -x /usr/libexec/vi.recover && -e /var/tmp/vi.recover ]]; then
	echo 'preserving editor files';	/usr/libexec/vi.recover
d595 5
a599 8
if [[ -d /var/anoncvs/anoncvs && -f /var/anoncvs/anoncvssh ]]; then
	# Copy over /dev/{null,zero} into anoncvs chroot, it needs it
	if [[ ! -c /var/anoncvs/anoncvs/dev/null \
	    || ! -c /var/anoncvs/anoncvs/dev/zero ]]; then
		(cd /dev; tar cf - null zero) \
		    | (cd /var/anoncvs/anoncvs/dev; tar xpf -)
	fi
fi
d601 1
d607 1
d639 2
a644 2
# $mrouted_flags is imported from /etc/rc.conf;
# If $mrouted_flags == NO, then mrouted isn't run.
a656 2
# $dhcpd_flags is imported from /etc/rc.conf
# If $dhcpd_flags == NO or /etc/dhcpd.conf doesn't exist, then dhcpd isn't run.
d659 2
a660 3
	if [[ -f /etc/dhcpd.interfaces ]]; then
		dhcpd_ifs=$(stripcom /etc/dhcpd.interfaces)
	fi
d667 1
a667 3
	if [[ $fw == 0 ]]; then
		# $rtsold_flags is imported from /etc/rc.conf;
		# If $rtsold_flags == NO, then rtsold isn't run.
a672 2
		# $route6d_flags is imported from /etc/rc.conf;
		# If $route6d_flags == NO, then route6d isn't run.
a676 2
		# $rtadvd_flags is imported from /etc/rc.conf;
		# If $rtadvd_flags == NO, then rtadvd isn't run.
a683 1
# $rwhod is imported from /etc/rc.conf;
d685 1
a685 1
if [[ $rwhod == YES ]]; then
a688 1

d717 1
a717 1
if [[ $inetd == YES && -e /etc/inetd.conf ]]; then
d726 1
a726 3
	if [[ $spamd_grey != NO ]]; then
		spamd_flags="${spamd_flags} -g"
	fi
a734 1
# $rarpd_flags is imported from /etc/rc.conf;
a740 1
# $bootparamd_flags is imported from /etc/rc.conf;
a746 1
# $rbootd_flags is imported from /etc/rc.conf;
d757 1
a757 1
echo '.'
d762 1
a762 1
	echo 'Setting up ssh-agent directories...'
d775 1
a776 2
# $apmd_flags is imported from /etc/rc.conf;
# don't run daemon if $apmd_flags == NO or /usr/sbin/apmd doesn't exist
d795 1
a795 1
echo '.'
d800 1
a800 1
	echo 'starting wsmoused...';	/usr/sbin/wsmoused $wsmoused_flags
d805 1
a805 1
	echo 'starting xdm...';		/usr/X11R6/bin/xdm $xdm_flags
@


1.6
log
@protect some dmon invocations by their existence
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.5 2005/07/01 15:19:20 tg Exp $
d394 1
@


1.5
log
@sync w/ obsd-current
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.4 2005/05/04 11:14:20 tg Exp $
d664 1
a664 1
if [[ $ospfd_flags != NO ]]; then
d668 1
a668 1
if [[ $bgpd_flags != NO ]]; then
d817 1
a817 1
if [[ $sensorsd_flags != NO ]]; then
d836 1
a836 1
if [[ $xdm_flags != NO ]]; then
@


1.4
log
@/dev/zero is now required in the anoncvs stuff
@
text
@d1 3
a3 21
#!/bin/ksh
# $MirOS: src/etc/rc,v 1.3 2005/04/15 17:17:58 tg Exp $
# $OpenBSD: rc,v 1.258 2004/10/22 00:59:09 itojun Exp $
#-
# Copyright (c) 2003, 2004, 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
d26 77
d160 1
d229 1
a229 2
	case "${_dev[i]}" {
	  /dev/wd+([0-9])[a-p])
d232 2
a233 4
		;;
	  *)	;;
	}
	let i='i+1'
d243 10
a252 10
			*${drv}*)
				;;	# Already done
			*)
				echo -n " $drv"
				/sbin/atactl /dev/r${drv}c secfreeze \
				    >/dev/null 2>&1
				/sbin/atactl /dev/r${drv}c writecachedisable \
				    >/dev/null 2>&1 || echo -n !
				_flags="$_flags $drv"
				;;
d262 1
a262 1
  elif [[ $1 == autoboot ]]; then
d266 1
a266 1
	  0)
d268 1
a268 1
	  2)
d271 1
a271 1
	  4)
d277 1
a277 1
	  8)
d281 1
a281 1
	  12)
d285 1
a285 1
	  130)
d289 1
a289 1
	  *)
d305 2
a306 2
			  *softdep*)	;;
			  *)	echo -n 'WARNING: Your root filesystem failed'
d313 1
a313 1
	  else
d315 8
a322 4
		  *noauto*)	;;
		  sw*)		;;	# Swap
		  xx*)		;;	# ignore totally
		  *)	if [[ ${_fstype[i]} == ffs ]]; then
d327 2
a328 2
					  *softdep*)	;;
					  *)	echo -n "Warning: force-mounti"
d337 1
a337 1
			  else
d344 1
a344 1
	let i='i+1'
d380 2
a381 1
	echo $RULES | pfctl -f - -e
d384 3
a386 10
if [[ -f /etc/sysctl.conf ]]; then
(
	# delete comments and blank lines
	set -- $(stripcom /etc/sysctl.conf)
	while [[ $# -ge 1 ]]; do
		sysctl $1
		shift
	done
)
fi
d390 4
d411 4
a414 4
# read in old random seed; if there's no /var/db/host.random, make
# one through /dev/urandom; else reset seed file anyways, so that
# if a shutdown-less reboot occurs, the next seed is not a repeat
[[ -f /var/db/host.random ]] && cat /var/db/host.random >/dev/arandom
d438 2
a439 1
if [[ $pf != NO && $pflogd_flags != NO ]]; then
d456 1
a456 1
  else
a483 1
# run ntpd if asked for; set time once (at startup) via settimeofday(2)
d485 1
a485 1
	echo -n ' ntpd';		ntpd -s $ntpd_flags
d526 1
a526 1
if mount 2>&1 | grep -F "on /tmp" >/dev/null 2>&1; then
d532 1
a532 1
  else
d551 1
a551 1
		  elif [[ -e $d ]]; then
d553 1
a553 1
		  else
d576 1
a576 1
  else
d604 1
a604 1
	  else
d664 4
d692 1
a692 1
	  else
d790 2
a802 15
if [[ -x /sbin/wsconsctl && -f /etc/wsconsctl.conf ]]; then
(
	# delete comments and blank lines
	save_IFS="$IFS"
	IFS="
"
	set -- $(stripcom /etc/wsconsctl.conf)
	IFS="$save_IFS"
	while [[ $# -ge 1 ]]; do
		eval /sbin/wsconsctl -w $1
		shift
	done
)
fi

d813 4
@


1.3
log
@atactl secfreeze on all wd(4) discs on startup
idea from hubertf@@netbsd.org's blog, who in turn
got it from a german computer magazine
@
text
@d2 1
a2 1
# $MirOS: src/etc/rc,v 1.2 2005/03/06 19:05:54 tg Exp $
d550 7
a556 4
if [[ -d /var/anoncvs/anoncvs && -f /var/anoncvs/anoncvssh \
    && ! -e /var/anoncvs/anoncvs/dev/null ]]; then
	# Copy over /dev/null into anoncvs chroot, it needs it
	(cd /dev; tar cf - null) | (cd /var/anoncvs/anoncvs/dev; tar xpf -)
@


1.2
log
@merge src/etc minus generated files
@
text
@d2 1
a2 1
# $MirOS$
d5 1
a5 1
# Copyright (c) 2003, 2004
d21 1
a21 1
# of covered work, even if advised of the possibility of such damage.
d190 2
@


1.1
log
@Initial revision
@
text
@d1 26
a26 6
#	$OpenBSD: rc,v 1.246 2004/05/16 04:31:01 mcbride Exp $

# System startup script run by init on autoboot
# or after single-user.
# Output and error are redirected to console by init,
# and the console is the controlling terminal.
d31 3
a33 3
# from a file and spew to stdout
stripcom() {
	local _file="$1"
d36 46
a81 5
	{
		while read _line ; do
			_line=${_line%%#*}		# strip comments
			test -z "$_line" && continue
			echo $_line
d83 3
a85 1
	} < $_file
d97 2
a98 3
HOME=/; export HOME
PATH=/sbin:/bin:/usr/sbin:/usr/bin
export PATH
d100 3
a102 2
if [ $1x = shutdownx ]; then
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 >/dev/null 2>&1
d104 1
a104 1
	if [ $? -eq 0 -a -f /etc/rc.shutdown ]; then
d115 2
a116 2
			ifconfig $if > /dev/null 2>&1
			if [ "$?" != "0" ]; then
d121 1
a121 1
		if [ "X${powerdown}" = X"YES" ]; then
d132 1
a132 1
if [ -f /etc/ccd.conf ]; then
d137 3
a139 3
for dev in 0 1 2 3; do
	if [ -f /etc/raid$dev.conf ]; then
		raidctl -c /etc/raid$dev.conf raid$dev
d148 54
a201 1
if [ -e /fastboot ]; then
d203 1
a203 1
elif [ $1x = autobootx ]; then
d206 2
a207 2
	case $? in
	0)
d209 1
a209 1
	2)
d212 1
a212 1
	4)
d218 1
a218 1
	8)
d222 1
a222 1
	12)
d226 1
a226 1
	130)
d230 1
a230 1
	*)
d234 1
a234 1
	esac
d240 43
d284 1
a284 5
mount -uw /		# root on nfs requires this, others aren't hurt
rm -f /fastboot		# XXX (root now writeable)

# pick up option configuration
. /etc/rc.conf
d290 7
a296 1
if [ "X${pf}" != X"NO" ]; then
d302 6
d309 1
a309 1
	case `sysctl vfs.mounts.nfs 2>/dev/null` in
d320 1
a320 1
if [ -f /etc/sysctl.conf ]; then
d323 2
a324 2
	set -- `stripcom /etc/sysctl.conf`
	while [ $# -ge 1 ] ; do
d335 9
a343 3
if [ "X${pf}" != X"NO" ]; then
	if [ -f ${pf_rules} ]; then
		pfctl -f ${pf_rules}
d350 4
a353 14
# if there's no /var/db/host.random, make one through /dev/urandom
if [ ! -f /var/db/host.random ]; then
	dd if=/dev/urandom of=/var/db/host.random bs=1024 count=64 \
		>/dev/null 2>&1
	chmod 600 /var/db/host.random >/dev/null 2>&1
else
	dd if=/var/db/host.random of=/dev/urandom bs=1024 count=64 \
	    > /dev/null 2>&1
	dd if=/var/db/host.random of=/dev/arandom bs=1024 count=64 \
	    > /dev/null 2>&1
fi

# reset seed file, so that if a shutdown-less reboot occurs,
# the next seed is not a repeat
d355 2
a356 1
    > /dev/null 2>&1
d362 1
a362 1
(cd /var/run && { test -r dhclient.pid && dhclient_pid=`cat dhclient.pid`; rm -rf -- *; install -c -m 664 -g utmp /dev/null utmp; test -n "$dhclient_pid" && echo "$dhclient_pid" > dhclient.pid; })
a364 1

d370 1
a370 5
if [ "X${named_flags}" != X"NO" ]; then
	rm -f /var/named/dev/log
	syslogd_flags="${syslogd_flags} -a /var/named/dev/log"
fi
if [ -d /var/empty ]; then
d373 1
a373 1
	syslogd_flags="${syslogd_flags} -a /var/empty/dev/log"
d375 1
a375 1
syslogd ${syslogd_flags}
d377 1
a377 1
if [ X"${pf}" != X"NO" -a X"${pflogd_flags}" != X"NO" ]; then
d379 1
a379 17
	pflogd ${pflogd_flags}
fi

# $named_flags is imported from /etc/rc.conf;
# if $named_flags != NO, named is run.
if [ "X${named_flags}" != X"NO" ]; then
	if ! cmp -s /etc/rndc.key /var/named/etc/rndc.key ; then
		echo -n "rndc-confgen: generating new shared secret... "
		if /usr/sbin/rndc-confgen -a -t /var/named >/dev/null 2>&1; then
			chmod 0640 /var/named/etc/rndc.key >/dev/null 2>&1
			echo done.
		else
			echo failed.
		fi
	fi

	echo 'starting named';		named $named_flags
d383 3
a385 4
# If $isakmpd_flags == NO or /etc/isakmpd/isakmpd.policy doesn't exist, then
# isakmpd isn't run.
if [ "X${isakmpd_flags}" != X"NO" -a -e /etc/isakmpd/isakmpd.policy ]; then
	echo 'starting isakmpd';	isakmpd ${isakmpd_flags}
d392 1
a392 1
if [ X"${portmap}" = X"YES" ]; then
d394 2
a395 29
fi

if [ -d /var/yp/binding -a X`domainname` != X ]; then
	if [ -d /var/yp/`domainname` ]; then
		# yp server capabilities needed...
		echo -n ' ypserv';		ypserv ${ypserv_flags}
		#echo -n ' ypxfrd';		ypxfrd
	fi

	echo -n ' ypbind';		ypbind

	if [ X"${yppasswdd_flags}" != X"NO" -a -d /var/yp/`domainname` ]; then
		# if we are the master server, run rpc.yppasswdd
		_host1=`ypwhich -m passwd 2> /dev/null`
		_host2=`hostname`
		if [ `grep '^lookup' /etc/resolv.conf | grep yp | wc -c` -ne 0 ]; then
			_host1=`ypmatch $_host1 hosts | cut -d'	' -f2`
			_host2=`ypmatch $_host2 hosts | cut -d'	' -f2 | head -1`
		else
			_host1=`nslookup $_host1 | grep '^Name: ' | \
			    sed -e 's/^Name:    //'`
			_host2=`nslookup $_host2 | grep '^Name: ' | \
			    sed -e 's/^Name:    //'`
		fi
		if [ "$_host2" = "$_host1" ]; then
			echo -n ' rpc.yppasswdd'
			rpc.yppasswdd ${yppasswdd_flags}
		fi
	fi
d400 2
a401 2
if [ X${nfs_server} = X"YES" -a -s /etc/exports -a \
    `sed -e '/^#/d' < /etc/exports | wc -l` -ne 0 ]; then
d403 1
a403 1
	echo -n > /var/db/mountdtab
d405 2
a406 2
	echo -n ' nfsd';		nfsd ${nfsd_flags}
	if [ X${lockd} = X"YES" ]; then
d411 3
a413 4
if [ X${amd} = X"YES" -a -e ${amd_master} ]; then
	echo -n ' amd'
	(cd /etc/amd; amd -l syslog -x error,noinfo,nostats -p \
	    -a ${amd_dir} `cat ${amd_master}` > /var/run/amd.pid )
d416 4
a419 3
# run rdate before timed
if [ X"${rdate_flags}" != X"NO" ]; then
	echo -n ' rdate';	rdate -s ${rdate_flags}
d422 3
a424 4
# $timed_flags is imported from /etc/rc.conf;
# if $timed_flags == NO, timed isn't run.
if [ "X${timed_flags}" != X"NO" ]; then
	echo -n ' timed'; timed $timed_flags
d426 1
d435 1
a435 1
if [ -d /var/crash ]; then
d439 1
a439 9
if [ "X${afs}" = X"YES" -a -c /dev/xfs0 ]; then
	echo -n 'mounting afs:'
	mkdir -p -m 0755 /afs
	mount -t xfs /dev/xfs0 /afs
	/usr/libexec/afsd ${afsd_flags}
	echo ' done.'
fi

if [ "X${check_quotas}" = X"YES" ]; then
d458 1
a458 1
if [ -f /etc/ptmp ]; then
d465 13
a477 5
# prune quickly with one rm, then use find to clean up /tmp/[lq]*
# (not needed with mfs /tmp, but doesn't hurt there...)
(cd /tmp && rm -rf [a-km-pr-zA-Z]* &&
    find . ! -name . ! -name lost+found ! -name quota.user \
	! -name quota.group -execdir rm -rf -- {} \; -type d -prune)
d479 1
a479 1
# create Unix sockets directories  for X if needed and make sure they have
d481 4
a484 4
if [ -d /usr/X11R6/lib ]; then
	for d in /tmp/.X11-unix /tmp/.ICE-unix ; do
		if [ -d $d ]; then
			if [ `ls -ld $d | cut -d' ' -f4` != root ]; then
d487 1
a487 1
			if [ `ls -ld $d | cut -d' ' -f1` != drwxrwxrwt ]; then
d490 1
a490 1
		elif [ -e $d ]; then
d492 1
a492 1
		else
d498 2
a499 2
[ -f /etc/rc.securelevel ] && . /etc/rc.securelevel
if [ X${securelevel} != X"" ]; then
d505 1
a505 1
if [ ! -f /etc/motd ]; then
d508 5
a512 5
T=`mktemp /tmp/_motd.XXXXXXXXXX`
if [ $? -eq 0 ]; then
	sysctl -n kern.version | sed 1q > $T
	echo "" >> $T
	sed '1,/^$/d' < /etc/motd >> $T
d515 2
d519 1
a519 1
if [ -f /var/account/acct ]; then
d523 1
a523 1
if [ -f /sbin/ldconfig ]; then
d525 1
a525 1
	if [ -d /usr/local/lib ]; then
d528 1
a528 1
	if [ -d /usr/X11R6/lib ]; then
d534 1
a534 1
if [ -x /usr/libexec/vi.recover ]; then
d538 1
a538 9
if [ ! -f /etc/ssh/ssh_host_dsa_key ]; then
	echo -n "ssh-keygen: generating new DSA host key... "
	if /usr/bin/ssh-keygen -q -t dsa -f /etc/ssh/ssh_host_dsa_key -N ''; then
		echo done.
	else
		echo failed.
	fi
fi
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
d540 2
a541 1
	if /usr/bin/ssh-keygen -q -t rsa -f /etc/ssh/ssh_host_rsa_key -N ''; then
d543 1
a543 1
	else
d547 20
a566 3
if [ ! -f /etc/ssh/ssh_host_key ]; then
	echo -n "ssh-keygen: generating new RSA1 host key... "
	if /usr/bin/ssh-keygen -q -t rsa1 -f /etc/ssh/ssh_host_key -N ''; then
d573 1
a573 1
if [ ! -f /etc/isakmpd/private/local.key ]; then
d576 1
a576 1
	    > /dev/null 2>&1; then
d578 2
a579 2
		openssl rsa -out /etc/isakmpd/private/local.pub \
		    -in /etc/isakmpd/private/local.key -pubout > /dev/null 2>&1
d590 1
a590 1
if [ "X${routed_flags}" != X"NO" ]; then
d596 1
a596 1
if [ "X${mrouted_flags}" != X"NO" ]; then
d600 1
a600 1
if [ "X${bgpd_flags}" != X"NO" ]; then
d606 1
a606 1
if [ "X${dhcpd_flags}" != X"NO" -a -f /etc/dhcpd.conf ]; then
d608 2
a609 2
	if [ -f /etc/dhcpd.interfaces ]; then
		dhcpd_ifs=`stripcom /etc/dhcpd.interfaces`
d611 2
a612 1
	echo -n ' dhcpd';	/usr/sbin/dhcpd ${dhcpd_flags} ${dhcpd_ifs}
d616 2
a617 2
	fw=`sysctl -n net.inet6.ip6.forwarding`
	if [ "X${fw}" == X"0" ]; then
d620 1
a620 1
		if [ "X${rtsold_flags}" != X"NO" ]; then
d622 1
a622 1
			/usr/sbin/rtsold ${rtsold_flags}
d624 1
a624 1
	else
d627 1
a627 1
		if [ "X${route6d_flags}" != X"NO" ]; then
d629 1
a629 1
			/usr/sbin/route6d ${route6d_flags}
d633 1
a633 1
		if [ "X${rtadvd_flags}" != X"NO" ]; then
d635 1
a635 1
			/usr/sbin/rtadvd ${rtadvd_flags}
d642 1
a642 1
if [ X${rwhod} = X"YES" ]; then
d647 2
a648 2
if [ "X${lpd_flags}" != X"NO" ]; then
	echo -n ' printer';		lpd ${lpd_flags}
d656 3
a658 2
if [ "X${sendmail_flags}" != X"NO" -a -s /etc/mailer.conf ]; then
	echo -n ' sendmail';		( /usr/sbin/sendmail ${sendmail_flags} >/dev/null 2>&1 & )
d661 1
a661 1
if [ "X${httpd_flags}" != X"NO"  ]; then
d664 1
a664 1
	echo -n ' httpd';		/usr/sbin/httpd ${httpd_flags}
d667 2
a668 2
if [ "X${ftpd_flags}" != X"NO" ]; then
	echo -n ' ftpd';		/usr/libexec/ftpd ${ftpd_flags}
d671 2
a672 2
if [ "X${identd_flags}" != X"NO" ]; then
	echo -n ' identd';		/usr/libexec/identd ${identd_flags}
d675 1
a675 1
if [ X${inetd} = X"YES" -a -e /etc/inetd.conf ]; then
d679 1
a679 1
if [ X"${sshd_flags}" != X"NO" ]; then
d683 2
a684 2
if [ "X${spamd_flags}" != X"NO" ]; then
	if [ "X${spamd_grey}" != X"NO" ]; then
d689 1
a689 1
	if [ "X${spamd_grey}" != X"NO" ]; then
d698 2
a699 2
if [ "X${rarpd_flags}" != X"NO" -a -s /etc/ethers ]; then
	echo -n ' rarpd';		rarpd ${rarpd_flags}
d705 2
a706 2
if [ "X${bootparamd_flags}" != X"NO" -a -s /etc/bootparams ]; then
	echo -n ' rpc.bootparamd';	rpc.bootparamd ${bootparamd_flags}
d712 2
a713 2
if [ "X${rbootd_flags}" != X"NO" -a -s /etc/rbootd.conf ]; then
	echo -n ' rbootd';		rbootd ${rbootd_flags}
d716 2
a717 5
# $mopd_flags is imported from /etc/rc.conf;
# If $mopd_flags == NO or /tftpboot/mop doesn't exist, then
# mopd isn't run.
if [ "X${mopd_flags}" != X"NO" -a -d /tftpboot/mop ]; then
	echo -n ' mopd';		mopd ${mopd_flags}
d722 12
a733 1
if [ -x /sbin/wsconsctl -a -f /etc/wsconsctl.conf ]; then
d739 1
a739 1
	set -- `stripcom /etc/wsconsctl.conf`
d741 1
a741 1
	while [ $# -ge 1 ] ; do
d748 1
a748 20
if [ -f /sbin/kbd -a -f /etc/kbdtype ]; then
	kbd `cat /etc/kbdtype`
fi

# KerberosV master KDC
if [ X${krb5_master_kdc} = X"YES" ]; then
	echo 'KerberosV master KDC'
	/usr/libexec/kdc &
	/usr/libexec/kadmind &
	/usr/libexec/kpasswdd &
fi

# KerberosV slave KDC
if [ X${krb5_slave_kdc} = X"YES" ]; then
	echo 'KerberosV slave KDC'
	/usr/libexec/kdc &
	# Remember to enable hpropd in inetd.conf
fi

[ -f /etc/rc.local ] && . /etc/rc.local
d754 2
a755 2
if [ "X${apmd_flags}" != X"NO" -a -x /usr/sbin/apmd ]; then
	echo -n ' apmd';	/usr/sbin/apmd ${apmd_flags}
d758 1
a758 1
if [ X"${sensorsd_flags}" != X"NO" ]; then
d762 4
d772 2
a773 2
if [ "X${wsmoused_flags}" != X"NO" -a -x /usr/sbin/wsmoused ]; then
	echo 'starting wsmoused...';	/usr/sbin/wsmoused ${wsmoused_flags}
d777 2
a778 2
if [ "X${xdm_flags}" != X"NO" ]; then
	echo 'starting xdm...';		/usr/X11R6/bin/xdm ${xdm_flags}
a781 1

@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@Import almost everything (no ancontrol, ifconfig, pfctl, wicontrol)
of (the undeleted parts of) OpenBSD-current's userland of about 3 hours ago.
Warning: this introduces major breakage!
@
text
@d1 1
a1 1
#	$OpenBSD: rc,v 1.270 2005/06/19 16:55:10 deraadt Exp $
a24 77
# Update resource limits when sysctl changes
# Usage: update_limit -X loginconf_name
update_limit() {
	local _fl="$1"	# ulimit flag
	local _lc="$2"	# login.conf name
	local _new _suf

	for _suf in "" -cur -max; do
		_new=`getcap -f /etc/login.conf -s ${_lc}${_suf} daemon 2>/dev/null`
		if [ X"$_new" != X"" ]; then
			if [ X"$_new" = X"infinity" ]; then
				_new=unlimited
			fi
			case "$_suf" in
			-cur)
				ulimit -S $_fl $_new
				;;
			-max)
				ulimit -H $_fl $_new
				;;
			*)
				ulimit $_fl $_new
				return
				;;
			esac
		fi
	done
}

sysctl_conf() {
	test -s /etc/sysctl.conf || return

	# delete comments and blank lines
	set -- `stripcom /etc/sysctl.conf`
	while [ $# -ge 1 ] ; do
		sysctl $1
		# update limits if needed
		case $1 in
		kern.maxproc=*)
			update_limit -p maxproc
			;;
		kern.maxfiles=*)
			update_limit -n openfiles
			;;
		esac
		shift
	done
}

mixerctl_conf()
{
	test -s /etc/mixerctl.conf || return

	# delete comments and blank lines
	set -- `stripcom /etc/mixerctl.conf`
	while [ $# -ge 1 ] ; do
		mixerctl -q $1 > /dev/null 2>&1
		shift
	done
}

wsconsctl_conf()
{
	local save_IFS="$IFS"

	test -x /sbin/wsconsctl -a -s /etc/wsconsctl.conf || return
	# delete comments and blank lines
	IFS="
"
	set -- `stripcom /etc/wsconsctl.conf`
	IFS="$save_IFS"
	while [ $# -ge 1 ] ; do
		eval /sbin/wsconsctl -w $1
		shift
	done
}

d38 1
a38 1
if [ X"$1" = X"shutdown" ]; then
d53 1
a53 1
			if [ $? -ne 0 ]; then
d58 1
a58 1
		if [ X"${powerdown}" = X"YES" ]; then
d87 1
a87 1
elif [ X"$1" = X"autoboot" ]; then
d135 1
a135 5
if [ -f /sbin/kbd -a -f /etc/kbdtype ]; then
	kbd `cat /etc/kbdtype`
fi

if [ X"${pf}" != X"NO" ]; then
a140 6
	if ifconfig lo0 inet6 >/dev/null 2>&1; then
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type neighbrsol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type neighbradv"
		RULES="$RULES\npass out inet6 proto icmp6 all icmp6-type routersol"
		RULES="$RULES\npass in inet6 proto icmp6 all icmp6-type routeradv"
	fi
d150 1
a150 2
	echo $RULES | pfctl -f -
	pfctl -e
d153 10
a162 3
sysctl_conf

mixerctl_conf
a165 4
if [ -f /etc/resolv.conf.save ]; then
	mv /etc/resolv.conf.save /etc/resolv.conf
	touch /etc/resolv.conf
fi
d168 1
a168 1
if [ X"${pf}" != X"NO" ]; then
d198 1
a198 1
(cd /var/run && { rm -rf -- *; install -c -m 664 -g utmp /dev/null utmp; })
d201 1
d207 1
a207 1
if [ X"${named_flags}" != X"NO" ]; then
d219 2
a220 4
	if ifconfig pflog0 >/dev/null 2>&1; then
		ifconfig pflog0 up
		pflogd ${pflogd_flags}
	fi
d225 1
a225 1
if [ X"${named_flags}" != X"NO" ]; then
d240 3
a242 2
# If $isakmpd_flags == NO, isakmpd isn't run.
if [ X"${isakmpd_flags}" != X"NO" ]; then
d271 1
a271 1
			_host1=`echo $_host1 | nslookup | grep '^Name: ' | \
d273 1
a273 1
			_host2=`echo $_host2 | nslookup | grep '^Name: ' | \
d285 1
a285 1
if [ X"${nfs_server}" = X"YES" -a -s /etc/exports -a \
d291 1
a291 1
	if [ X"${lockd}" = X"YES" ]; then
d296 1
a296 1
if [ X"${amd}" = X"YES" -a -e ${amd_master} ]; then
d302 1
a302 1
# run rdate before timed/ntpd
d309 1
a309 1
if [ X"${timed_flags}" != X"NO" ]; then
a311 4

if [ X"${ntpd_flags}" != X"NO" ]; then
	echo -n ' ntpd'; ntpd $ntpd_flags
fi
d324 1
a324 1
if [ X"${afs}" = X"YES" -a -c /dev/xfs0 ]; then
d332 1
a332 1
if [ X"${check_quotas}" = X"YES" ]; then
d364 1
a364 1
# create Unix sockets directories for X if needed and make sure they have
d384 1
a384 1
if [ X"${securelevel}" != X"" ]; then
d463 1
a463 1
if [ X"${routed_flags}" != X"NO" ]; then
d469 1
a469 1
if [ X"${mrouted_flags}" != X"NO" ]; then
d473 1
a473 5
if [ X"${ospfd_flags}" != X"NO" ]; then
	echo -n ' ospfd';		/usr/sbin/ospfd $ospfd_flags
fi

if [ X"${bgpd_flags}" != X"NO" ]; then
d479 1
a479 1
if [ X"${dhcpd_flags}" != X"NO" -a -f /etc/dhcpd.conf ]; then
d489 1
a489 1
	if [ X"${fw}" = X"0" ]; then
d492 1
a492 1
		if [ X"${rtsold_flags}" != X"NO" ]; then
d499 1
a499 1
		if [ X"${route6d_flags}" != X"NO" ]; then
d505 1
a505 1
		if [ X"${rtadvd_flags}" != X"NO" ]; then
d514 1
a514 1
if [ X"${rwhod}" = X"YES" ]; then
d519 1
a519 1
if [ X"${lpd_flags}" != X"NO" ]; then
d528 1
a528 1
if [ X"${sendmail_flags}" != X"NO" -a -s /etc/mailer.conf ]; then
d532 1
a532 1
if [ X"${httpd_flags}" != X"NO" ]; then
d538 1
a538 1
if [ X"${ftpd_flags}" != X"NO" ]; then
d542 1
a542 1
if [ X"${identd_flags}" != X"NO" ]; then
d546 1
a546 1
if [ X"${inetd}" = X"YES" -a -e /etc/inetd.conf ]; then
d554 2
a555 2
if [ X"${spamd_flags}" != X"NO" ]; then
	if [ X"${spamd_grey}" != X"NO" ]; then
d560 1
a560 1
	if [ X"${spamd_grey}" != X"NO" ]; then
d562 1
a562 1
		/usr/libexec/spamlogd ${spamlogd_flags}
d569 1
a569 1
if [ X"${rarpd_flags}" != X"NO" -a -s /etc/ethers ]; then
d576 1
a576 1
if [ X"${bootparamd_flags}" != X"NO" -a -s /etc/bootparams ]; then
d583 1
a583 1
if [ X"${rbootd_flags}" != X"NO" -a -s /etc/rbootd.conf ]; then
d590 1
a590 1
if [ X"${mopd_flags}" != X"NO" -a -d /tftpboot/mop ]; then
d596 18
a613 1
wsconsctl_conf
d616 1
a616 1
if [ X"${krb5_master_kdc}" = X"YES" ]; then
d624 1
a624 1
if [ X"${krb5_slave_kdc}" = X"YES" ]; then
d636 1
a636 1
if [ X"${apmd_flags}" != X"NO" -a -x /usr/sbin/apmd ]; then
a639 4
if [ X"${acpid_flags}" != X"NO" -a -x /usr/sbin/acpid ]; then
	echo -n ' acpid';	/usr/sbin/acpid ${acpid_flags}
fi

a643 4
if [ X"${hotplugd_flags}" != X"NO" -a -x /usr/sbin/hotplugd ]; then
	echo -n ' hotplugd';	/usr/sbin/hotplugd ${hotplugd_flags}
fi

d650 1
a650 1
if [ X"${wsmoused_flags}" != X"NO" -a -x /usr/sbin/wsmoused ]; then
d655 1
a655 1
if [ X"${xdm_flags}" != X"NO" ]; then
@

