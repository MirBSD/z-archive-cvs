head	1.12;
access;
symbols
	MIRBSD_10:1.8.0.2
	MIRBSD_10_BASE:1.8
	cvs-200611210330:1.1.1.4
	cvs-200606301800:1.1.1.4
	MIRBSD_9_BASE:1.5
	MIRBSD_8:1.5.0.2
	MIRBSD_8_BASE:1.5
	cvs-200511231542:1.1.1.3
	cvs-200507211800:1.1.1.2
	cvs-200504170300:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.12
date	2008.10.16.14.43.23;	author tg;	state Exp;
branches;
next	1.11;
commitid	10048F7532112FE4D78;

1.11
date	2008.10.16.14.32.16;	author tg;	state Exp;
branches;
next	1.10;
commitid	10048F7507B4040C637;

1.10
date	2008.10.16.14.19.01;	author tg;	state Exp;
branches;
next	1.9;
commitid	10048F74D5E4F1BB3EA;

1.9
date	2008.10.16.13.31.20;	author tg;	state Exp;
branches;
next	1.8;
commitid	10048F742164012C987;

1.8
date	2007.04.18.20.59.02;	author tg;	state Exp;
branches;
next	1.7;
commitid	100462686AD0748A4FB;

1.7
date	2006.06.30.18.15.28;	author tg;	state Exp;
branches;
next	1.6;
commitid	10044A56A4875F87B93;

1.6
date	2006.06.30.18.11.00;	author tg;	state Exp;
branches;
next	1.5;
commitid	10044A5693745E9F1D6;

1.5
date	2005.11.23.16.06.31;	author tg;	state Exp;
branches;
next	1.4;
commitid	61014384938d440a;

1.4
date	2005.11.23.16.03.59;	author tg;	state Exp;
branches;
next	1.3;
commitid	71034384930296dc;

1.3
date	2005.04.17.04.24.09;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.06.19.24.01;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.26.20;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.26.20;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.04.17.03.33.19;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2005.11.23.15.47.34;	author tg;	state Exp;
branches;
next	1.1.1.4;
commitid	26ae43848f1e303f;

1.1.1.4
date	2006.06.30.18.01.52;	author tg;	state Exp;
branches;
next	;
commitid	10044A567215DFA780B;


desc
@@


1.12
log
@better
@
text
@# $MirOS: src/libexec/ld.so/Makefile,v 1.11 2008/10/16 14:32:16 tg Exp $
# $OpenBSD: Makefile,v 1.34 2006/05/11 22:03:22 deraadt Exp $

SUBDIR=		ldconfig ldd
#SUBDIR+=	prebind
LIBCSRCDIR?=	${.CURDIR}/../../lib/libc
VPATH=		${LIBCSRCDIR}/string

SRCS=	ldasm.S loader.c resolve.c dlfcn.c dl_printf.c rtld_machine.c
SRCS+=	util.c sod.c strsep.c strtol.c dir.c library_subr.c dl_prebind.c
.if (${MACHINE_ARCH} == "i386")
SRCS+=	library_mquery.c
.else
SRCS+=	library.c
.endif

SRCS+=		ssp.c
CFLAGS_ssp.o=	-fno-stack-protector

PROG=		ld.so
DPADD+=		${LIBMDSUP}
LDADD+=		-lmdsup_pic

.include "Makefile.inc"
.include "${.CURDIR}/${MACHINE_ARCH}/Makefile.inc"
.PATH:	${.CURDIR}/${MACHINE_ARCH}

COPTS+=		-Wall
CPPFLAGS+=	-I${.CURDIR}/${MACHINE_ARCH} -Dstrsep=_dl_strsep
INSTALL_STRIP=

ELF_LDFLAGS+=	--shared -Bsymbolic --no-undefined

CLEANFILES+=	${PROG}~
${PROG}:
	${LD} -r -o ${PROG}~ ${OBJS}
	objcopy --redefine-sym memcpy=_dl_memcpy ${PROG}~
	${LD} -x -e _dl_start ${ELF_LDFLAGS} -o ${PROG} ${PROG}~ ${LDADD}

.include <bsd.prog.mk>
@


1.11
log
@prevent symbol leakage of gcc auto-generated memcpy() call
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.10 2008/10/16 14:19:01 tg Exp $
d18 1
a18 1
CFLAGS_ssp.o=	-fno-stack-protector -fno-stack-protector-all
a38 2
#$(PROG):
#	$(LD) -x -e _dl_start $(ELF_LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
@


1.10
log
@add stack protection carnary randomisation to ld.so “because we can”
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.9 2008/10/16 13:31:20 tg Exp $
d34 7
a40 2
$(PROG):
	$(LD) -x -e _dl_start $(ELF_LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
@


1.9
log
@fix sparc ld.so(8) which depended on some libc interna (for softfloat,
soft integer divmul, etc. mostly) by installing a new libmdsup and linking
against it
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.8 2007/04/18 20:59:02 tg Exp $
d17 3
@


1.8
log
@more include path woes
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.7 2006/06/30 18:15:28 tg Exp $
d4 4
a7 3
SUBDIR=	ldconfig ldd
#SUBDIR+=prebind
VPATH=	${.CURDIR}/../../lib/libc/string
d17 3
a19 1
PROG=	ld.so
@


1.7
log
@move the <bsd.own.mk> inclusion further above
to prevent COPTS from being overwritten
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.6 2006/06/30 18:11:00 tg Exp $
d18 1
a18 2
.include <bsd.own.mk>

@


1.6
log
@sync; welcome to the world of dynamic arches, sparc
thanks http://mail-index.netbsd.org/port-sparc/1994/12/03/0002.html
@
text
@d1 1
a1 1
# $MirOS$
d18 2
a22 2
.include <bsd.own.mk>

@


1.5
log
@I'm quite positive we don't need -fno-stack-protector-all any more
(especially since it's no longer on by default)
@
text
@d1 2
a2 4
# $MirOS: src/libexec/ld.so/Makefile,v 1.4 2005/11/23 16:03:59 tg Exp $
# $OpenBSD: Makefile,v 1.30 2005/09/28 16:20:01 drahn Exp $

.include "Makefile.inc"
d5 1
a7 2
PROG=	ld.so
MAN=	ld.so.1
d9 2
a10 2
SRCS+=	util.c sod.c strsep.c strtol.c dir.c library_subr.c
.if ${MACHINE_ARCH} == "i386"
d16 2
d21 3
d27 1
a27 1
ELF_LDFLAGS+=	--shared -Bsymbolic
d29 2
a30 2
${PROG}:
	${LD} -x -e _dl_start ${ELF_LDFLAGS} -o ${PROG} ${OBJS} ${LDADD}
@


1.4
log
@fastmerge
@
text
@d1 1
a1 1
# $MirOS: src/libexec/ld.so/Makefile,v 1.3 2005/04/17 04:24:09 tg Exp $
a22 1
CFLAGS_loader.o=-fno-stack-protector-all	# gcc mis-compiles
@


1.3
log
@merge all but httpd
@
text
@d1 2
a2 2
# $MirOS: src/libexec/ld.so/Makefile,v 1.2 2005/03/06 19:24:01 tg Exp $
# $OpenBSD: Makefile,v 1.25 2005/03/23 19:48:05 drahn Exp $
@


1.2
log
@merge src/libexec
@
text
@d1 2
a2 2
# $MirOS$
# $OpenBSD: Makefile,v 1.24 2004/05/26 19:16:30 mickey Exp $
d12 1
a12 1
SRCS+=	util.c sod.c strsep.c strtol.c dir.c
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile,v 1.24 2004/05/26 19:16:30 mickey Exp $
d4 1
a4 2
SUBDIR=ldconfig ldd
VPATH=${.CURDIR}/../../lib/libc/string
d6 5
d13 1
a13 1
.if (${MACHINE_ARCH} == "i386")
a18 3
PROG=	ld.so
MAN=	ld.so.1

d22 2
a23 3
CFLAGS += -Wall
CFLAGS += -I${.CURDIR} -I${.CURDIR}/${MACHINE_ARCH} \
	-Dstrsep=_dl_strsep
d26 1
a26 1
ELF_LDFLAGS+=--shared -Bsymbolic
d28 2
a29 2
$(PROG):
	$(LD) -x -e _dl_start $(ELF_LDFLAGS) -o $(PROG) $(OBJS) $(LDADD)
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@some more updates/fixes from obsd
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.25 2005/03/23 19:48:05 drahn Exp $
d7 1
a7 1
SRCS+=	util.c sod.c strsep.c strtol.c dir.c library_subr.c
@


1.1.1.3
log
@Import current OpenBSD src/libexec to gain (among others) ld.so fixes
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.30 2005/09/28 16:20:01 drahn Exp $
d20 1
a20 1
CFLAGS += -Wall -Werror
@


1.1.1.4
log
@Import OpenBSD's current ld.so
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.34 2006/05/11 22:03:22 deraadt Exp $
a3 1
#SUBDIR+=prebind
d7 1
a7 1
SRCS+=	util.c sod.c strsep.c strtol.c dir.c library_subr.c dl_prebind.c
d25 1
a25 1
ELF_LDFLAGS+=--shared -Bsymbolic --no-undefined
@


