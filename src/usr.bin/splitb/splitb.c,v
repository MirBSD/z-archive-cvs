head	1.7;
access;
symbols
	MIRBSD_10:1.5.0.4
	MIRBSD_10_BASE:1.5
	MIRBSD_9_BASE:1.5
	MIRBSD_8:1.5.0.2
	MIRBSD_8_BASE:1.5;
locks; strict;
comment	@ * @;


1.7
date	2013.10.31.20.07.10;	author tg;	state Exp;
branches;
next	1.6;
commitid	1005272B7081B0E5655;

1.6
date	2008.11.08.23.04.55;	author tg;	state Exp;
branches;
next	1.5;
commitid	10049161AB22DF5DFC5;

1.5
date	2005.12.17.05.46.29;	author tg;	state Exp;
branches;
next	1.4;
commitid	10043A3A3E65E20A413;

1.4
date	2005.03.17.09.27.37;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.17.09.25.33;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.17.09.17.09;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.15.21.23.05;	author tg;	state Exp;
branches;
next	;


desc
@@


1.7
log
@adapt most __attribute__((…)) occurrences to new KNF style(9)
@
text
@/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.6 2008/11/08 23:04:55 tg Exp $ */

/*-
 * Copyright © 2005, 2013
 *	Thorsten Glaser <tg@@mirbsd.org>
 *
 * Provided that these terms and disclaimer and all copyright notices
 * are retained or reproduced in an accompanying document, permission
 * is granted to deal in this work without restriction, including un‐
 * limited rights to use, publicly perform, distribute, sell, modify,
 * merge, give away, or sublicence.
 *
 * This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
 * the utmost extent permitted by applicable law, neither express nor
 * implied; without malicious intent or gross negligence. In no event
 * may a licensor, author or contributor be held liable for indirect,
 * direct, other damage, loss, or other issues arising in any way out
 * of dealing in the work, even if advised of the possibility of such
 * damage or existence of a defect, except proven that it results out
 * of said person’s immediate fault when using the work as intended.
 *-
 * Inspired by work done for Telefax 400, Deutsche Telekom AG.
 */

#ifdef linux
#define	_FILE_OFFSET_BITS	64
#ifndef __dead
#define	__dead			__attribute__((__noreturn__))
#endif
#endif

#include <sys/param.h>
#include <err.h>
#include <fcntl.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int main(int, char **);
__dead void usage(int);

int
main(int argc, char **argv)
{
	int i, ifd, ofd, ch, pfl = 3;
	long l = 1, lw = 0, bufsiz = 1024 * 1024;
	ssize_t k;
	bool quiet = false, dec = false;
	char *ft = strdup("split"), fn[PATH_MAX], *buf;
	int64_t sum = 0;

	while ((ch = getopt(argc, argv, "B:b:dhkqt:w:")) != -1) {
		switch (ch) {
		case 'h':
			usage(1);
			break;
		case 'B':
			if ((bufsiz = strtol(optarg, NULL, 0)) <=0)
				errx(1, "bufsize cannot be negative");
			else if ((bufsiz == 1) && !quiet)
				warnx("bufsize 1 provides low performance");
			else if (bufsiz > 1024 * 1024 * 1024)
				errx(1, "bufsize > 1 GiB makes no sense");
			break;
		case 'b':
			if ((l = strtol(optarg, NULL, 0)) <= 0)
				usage(0);
			break;
		case 'd':
			dec = !dec;
			break;
		case 'k':
			bufsiz = 1024;
			break;
		case 'q':
			quiet = true;
			break;
		case 't':
			ft = strdup(optarg);
			break;
		case 'w':
			if ((pfl = (int)strtol(optarg, NULL, 0)) < 1)
				usage(0);
			break;
		default:
			usage(0);
			break;
		}
	}
	argc -= optind;
	argv += optind;

	if ((size_t)pfl > (PATH_MAX - 2 - strlen(ft)))
		usage(0);

	if (argc) {
		if ((ifd = open(*argv, O_RDONLY)) == -1)
			err(1, "cannot open input file");
	} else
		ifd = STDIN_FILENO;

	if ((buf = malloc((size_t)bufsiz)) == NULL)
		err(1, "cannot allocate memory");

	i = 0;
	ofd = -1;
	while ((k = read(ifd, buf, (size_t)bufsiz)) > 0) {
		sum += k;
		if (ofd == -1) {
			snprintf(fn, sizeof(fn),
			    dec ? "%s.%0*d" : "%s.%0*X",
			    ft, pfl, i);
			if ((ofd = open(fn, O_WRONLY | O_CREAT | O_TRUNC,
			    0666)) == -1)
				err(1, "cannot open output file");
			lw = 0;
			if (!quiet)
				printf("Writing to %s...", fn);
			fflush(stdout);
		}
		if (write(ofd, buf, (size_t)k) != k)
			err(1, "cannot write to output file");
		if (k != bufsiz) {
			close(ofd);
			break;
		}
		if (++lw == l) {
			close(ofd);
			ofd = -1;
			if (!quiet)
				printf("done\n");
			fflush(stdout);
			++i;
		}
	}
	if (ofd != -1) {
		close(ofd);
		if (!quiet)
			printf("done\n");
		++i;
	}
	printf("%lld bytes written to %d output files.\n", sum, i);
	return 0;
}

__dead void
usage(int loud)
{
	extern const char *__progname;

	printf("Usage: %s [-dhkq] [-B bufsiz] [-b blocks] [-t template]\n"
	    "    [-w width] [inputfile]\n%s",
	    __progname, loud ?
	    "A buffer consists of bufsiz Bytes, or 1 KiB (1024 Bytes)\n"
	    "if -k is given, or 1 MiB (1048576 Bytes) if neither -B\n"
	    "nor -k is used on the command line. Default width for\n"
	    "the file postfix is 3; stdin is the default inputfile.\n"
	    : "");
	exit(loud ? 0 : 1);
}
@


1.6
log
@more mass conversions, including ancient eMail addresses
@
text
@d1 1
a1 1
/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.5 2005/12/17 05:46:29 tg Exp $ */
d4 2
a5 2
 * Copyright (c) 2005
 *	Thorsten "mirabilos" Glaser <tg@@mirbsd.org>
d7 5
a11 6
 * Licensee is hereby permitted to deal in this work without restric-
 * tion, including unlimited rights to use, publicly perform, modify,
 * merge, distribute, sell, give away or sublicence, provided all co-
 * pyright notices above, these terms and the disclaimer are retained
 * in all redistributions or reproduced in accompanying documentation
 * or other materials provided with binary redistributions.
d13 8
a20 8
 * Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
 * express, or implied, to the maximum extent permitted by applicable
 * law, without malicious intent or gross negligence; in no event may
 * licensor, an author or contributor be held liable for any indirect
 * or other damage, or direct damage except proven a consequence of a
 * direct error of said person and intended use of this work, loss or
 * other issues arising in any way out of its use, even if advised of
 * the possibility of such damage or existence of a nontrivial bug.
d28 1
a28 1
#define	__dead			__attribute__((noreturn))
@


1.5
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d1 1
a1 1
/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.4 2005/03/17 09:27:37 tg Exp $ */
d5 1
a5 1
 *	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
@


1.4
log
@for BSD, default to 1 buffer worth of data as blocks,
not 1024 (thus, default splitfile size is 1 MiB).
@
text
@d1 1
a1 1
/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.3 2005/03/17 09:25:33 tg Exp $ */
d14 8
a21 7
 * Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
 * any kind, expressed or implied, to the maximum extent permitted by
 * applicable law, but with the warranty of being written without ma-
 * licious intent or gross negligence; in no event shall licensor, an
 * author or contributor be held liable for any damage, direct, indi-
 * rect or other, however caused, arising in any way out of the usage
 * of this work, even if advised of the possibility of such damage.
@


1.3
log
@sync usage
@
text
@d1 1
a1 1
/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.2 2005/03/17 09:17:09 tg Exp $ */
d48 1
a48 1
	long l = 1024, lw = 0, bufsiz = 1024 * 1024;
a155 1
	    "If -b is not given, blocks defaults to 1024 buffers.\n"
@


1.2
log
@customer demands decimal filename postfices, so be it
defaults to off for BSD, though
@
text
@d1 1
a1 1
/* $MirOS: src/usr.bin/splitb/splitb.c,v 1.1 2005/03/15 21:23:05 tg Exp $ */
d153 1
a153 1
	printf("Usage: %s [-hkq] [-B bufsiz] [-b blocks] [-t template]\n"
@


1.1
log
@add file splitting tool, have fun
and it passes -Wall -Wextra -Wunused -Wdeclaration-after-statement -Wundef -Wendif-labels -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-qual -Wcast-align -Wwrite-strings -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wno-unreachable-code -Winline -pedantic -std=c99
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $ */
d50 1
a50 1
	bool quiet = false;
d54 1
a54 1
	while ((ch = getopt(argc, argv, "B:b:hkqt:w:")) != -1) {
d71 3
d112 2
a113 1
			snprintf(fn, sizeof(fn), "%s.%0*X",
@

