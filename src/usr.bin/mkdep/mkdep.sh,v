head	1.10;
access;
symbols
	MIRBSD_10:1.7.0.2
	MIRBSD_10_BASE:1.7
	MIRBSD_9_BASE:1.5
	MIRBSD_8:1.5.0.2
	MIRBSD_8_BASE:1.5;
locks; strict;
comment	@# @;


1.10
date	2009.10.19.20.34.48;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004ADCCC7177D3231E;

1.9
date	2008.10.05.16.39.14;	author tg;	state Exp;
branches;
next	1.8;
commitid	10048E8EDC159F683CF;

1.8
date	2008.10.05.15.40.39;	author tg;	state Exp;
branches;
next	1.7;
commitid	10048E8E00E16D1B4BC;

1.7
date	2007.06.12.18.43.01;	author tg;	state Exp;
branches;
next	1.6;
commitid	100466EE93B66CF9F3F;

1.6
date	2006.09.20.22.24.51;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004511BFAD3427E1F6;

1.5
date	2005.12.17.05.46.28;	author tg;	state Exp;
branches;
next	1.4;
commitid	10043A3A3E65E20A413;

1.4
date	2005.09.22.20.48.20;	author tg;	state Exp;
branches;
next	1.3;
commitid	1fa6433318a28664;

1.3
date	2005.05.25.23.50.27;	author tg;	state Exp;
branches;
next	1.2;
commitid	715c42950f4ccef2;

1.2
date	2005.02.23.20.58.30;	author tg;	state Exp;
branches;
next	;


desc
@@


1.10
log
@this is an absolutely annoying property, and I cannot even fix this
proper because mkdep.sh has to work with old mksh (and possibly few
other pdksh versions and derivates) as well as new mksh

	while getopts "..." c; do
		case $c {
		(\?) break ;;
		}
	done
	shift $((OPTIND - 1))

this is the indicator that something is wrong, because OPTIND is now,
consistently with ksh93, increased EVEN FOR WRONG OPTIONS! if you want
to preserve it (without using -- as delimiter), you'd change this to

	while getopts "..." c; do
		case $c {
		(\?) let OPTIND--; break ;;
		}
	done
	shift $((OPTIND - 1))

which fails with pdksh, oksh and mksh older than a few days...

ADDITIONALLY, for each x in 'getopts "...x..." c', $c can not
only be 'x' but also '+x' so a (*) usage;; case is ALWAYS a
good idea (here, we make it the same as (\?) though, because
we'd just pass the non-mkdep options to gcc in mkdep as special
case of getopts use)
@
text
@#!/usr/bin/env mksh
# $MirOS: src/usr.bin/mkdep/mkdep.sh,v 1.9 2008/10/05 16:39:14 tg Exp $
#-
# Copyright (c) 2004, 2005, 2007, 2008, 2009
#	Thorsten Glaser <tg@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# This is loosely based upon material provided by: the University of
# California, Berkeley, and its contributors.


function die
{
	print -u2 mkdep: "$@@"
	exit 1
}

# select a suitable C compiler
cc=${CC:-cc}
cc=${cc##@@(?(+([! ])/)ccache+([	 ]))}
[[ -x $cc || -x ${cc%% *} ]] || cc=$(whence -p $cc) || \
    cc=$(whence -p ${cc%% *}) || cc=$(whence -p cc)
[[ -x $cc || -x ${cc%% *} ]] || die no compiler found.
CC=$cc; export CC

# default values
df=.depend
of=
flag_a=0
flag_p=0

# parse mkdep(1) options
oi=$OPTIND
while getopts ":af:p" opt; do
	case $opt {
	a)	flag_a=1 ;;
	f)	df="${OPTARG:-.depend}" ;;
	p)	flag_p=1 ;;
	\?)	break ;;
	*)	break ;;	# e.g. '+a'
	}
	# This is needed because we 'break' in the case \? above,
	# where OPTIND varies between *ksh versions due to a bug,
	# inherited from pdksh via oksh, in mksh < 39.9.20091015
	oi=$OPTIND
done
shift $((oi - 1))

# check if files given
if (( $# == 0 )); then
	print 'usage: mkdep [-ap] [-f .depend] [cc_flags] file ...'
	exit 1
fi

# check if output file given
set -A parms -- "$@@"
let i=0
while (( i < ${#parms[*]} )); do
	if [[ ${parms[i]} = -o ]]; then
		of="${parms[++i]}"
	elif [[ ${parms[i]} = -o* ]]; then
		of="${parms[i]#-o}"
	fi
	let i++
done

# set up temporary work environment
tmp=$(mktemp /tmp/mkdep.XXXXXXXXXX) || exit 1
trap 'rm -f $tmp; trap 2; kill -2 $$' 1 2 3 5 13 15

# process
export CCACHE_DISABLE=1
if [[ -z $of ]]; then
	$CC -D__IN_MKDEP -M "$@@"
else
	$CC -D__IN_MKDEP -M "$@@" && cat "$of"
fi | if (( flag_p == 0 )); then
	sed -e 's; \./; ;g' >$tmp
else
	sed -e 's;\.o[ ]*:; :;' -e 's; \./; ;g' >$tmp
fi

if [ $? != 0 ]; then
	rm -f $tmp
	die compile failed.
fi

if (( flag_a == 1 )); then
	if ! cat $tmp >>"$df"; then
		rm -f $tmp
		die append failed.
	fi
else
	if ! mv -f $tmp "$df"; then
		rm -f $tmp
		die rename failed.
	fi
fi

rm -f $tmp
exit 0
@


1.9
log
@be even more friendly to ccache
@
text
@d2 1
a2 1
# $MirOS: src/usr.bin/mkdep/mkdep.sh,v 1.8 2008/10/05 15:40:39 tg Exp $
d4 1
a4 1
# Copyright (c) 2004, 2005, 2007, 2008
d47 1
d54 1
d56 4
d61 1
a61 1
shift $((OPTIND - 1))
@


1.8
log
@• add CCACHE_DISABLE=1 to prevent “unsupported compiler option”
• modernise and remove adv. clause while here
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
d34 3
a36 1
[[ -x $cc || -x ${cc%% *} ]] || cc=$(whence -p $cc) || cc=$(whence -p cc)
@


1.7
log
@fix for the CC=compiler+arg case
@
text
@d1 2
a2 2
#!/bin/mksh
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d4 2
a5 2
# Copyright (c) 2004, 2005, 2007
#	Thorsten Glaser <tg@@mirbsd.de>
a12 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
d78 1
@


1.6
log
@catch signal 5 too, idea from original lynx "oldlynx" sample script, thanks TD
while here, update licences where I can
@
text
@d2 1
a2 1
# $MirOS: src/usr.bin/mkdep/mkdep.sh,v 1.5 2005/12/17 05:46:28 tg Exp $
d4 2
a5 2
# Copyright (c) 2004, 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d17 8
a24 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
d37 4
a40 2
CC=$(whence -p ${CC:-cc} 2>/dev/null) || CC=$(whence -p cc)
[[ -x $CC ]] || die no compiler found.
@


1.5
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d2 1
a2 1
# $MirOS: src/usr.bin/mkdep/mkdep.sh,v 1.4 2005/09/22 20:48:20 tg Exp $
d14 2
a15 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d25 1
a25 1
# the possibility of such damage or existence of a nontrivial bug.
d78 1
a78 1
trap 'rm -f $tmp; trap 2; kill -2 $$' 1 2 3 13 15
@


1.4
log
@define __IN_MKDEP during make depend *sigh*
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $
d18 8
a25 7
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
@


1.3
log
@mksh is pretty mature; switch most of contrib/ to it
@
text
@d2 1
a2 1
# $MirOS: src/usr.bin/mkdep/mkdep.sh,v 1.2 2005/02/23 20:58:30 tg Exp $
d14 4
d81 1
a81 1
	$CC -M "$@@"
d83 1
a83 1
	$CC -M "$@@" && cat "$of"
@


1.2
log
@merge mkdep from ncvs 1, optimise
@
text
@d1 2
a2 2
#!/bin/ksh
# $MirOS: src/share/misc/licence.template,v 1.1 2005/02/11 14:23:55 tg Rel $
@
