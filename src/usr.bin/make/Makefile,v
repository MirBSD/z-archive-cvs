head	1.17;
access;
symbols
	MIRBSD_10:1.17.0.2
	MIRBSD_10_BASE:1.17
	cvs-200706211400:1.1.1.2
	MIRBSD_9_BASE:1.13
	MIRBSD_8:1.12.0.2
	MIRBSD_8_BASE:1.12
	cvs-200507211800:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.17
date	2007.06.21.14.17.06;	author tg;	state Exp;
branches;
next	1.16;
commitid	100467A885746F6DDD6;

1.16
date	2006.08.27.00.39.07;	author tg;	state Exp;
branches;
next	1.15;
commitid	10044F0E9AF4CCCB3C0;

1.15
date	2006.08.26.21.37.11;	author tg;	state Exp;
branches;
next	1.14;
commitid	10044F0BF1B7B7B853A;

1.14
date	2006.08.26.21.29.00;	author tg;	state Exp;
branches;
next	1.13;
commitid	10044F0BD2E041DFC42;

1.13
date	2006.06.16.20.25.01;	author tg;	state Exp;
branches;
next	1.12;
commitid	100449313AD07072656;

1.12
date	2005.11.24.14.12.28;	author tg;	state Exp;
branches;
next	1.11;
commitid	2e8c4385ca5f66bd;

1.11
date	2005.11.24.14.00.33;	author tg;	state Exp;
branches;
next	1.10;
commitid	14154385c7944e69;

1.10
date	2005.11.24.13.51.53;	author tg;	state Exp;
branches;
next	1.9;
commitid	2d6a4385c58c23e7;

1.9
date	2005.11.24.13.32.32;	author tg;	state Exp;
branches;
next	1.8;
commitid	1a704385c10334ce;

1.8
date	2005.11.24.13.32.07;	author tg;	state Exp;
branches;
next	1.7;
commitid	4e414385c0d8a6cd;

1.7
date	2005.11.24.13.26.56;	author tg;	state Exp;
branches;
next	1.6;
commitid	2a364385bfb152d3;

1.6
date	2005.11.24.12.49.37;	author tg;	state Exp;
branches;
next	1.5;
commitid	383d4385b6e7b63d;

1.5
date	2005.11.24.12.37.43;	author tg;	state Exp;
branches;
next	1.4;
commitid	2fda4385b415ddd6;

1.4
date	2005.09.01.23.48.20;	author tg;	state Exp;
branches;
next	1.3;
commitid	c514317933134ea;

1.3
date	2005.03.06.22.28.37;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.02.23.20.36.53;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.29.42;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.29.42;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2007.06.21.14.00.57;	author tg;	state Exp;
branches;
next	;
commitid	100467A84A665BF4A08;


desc
@@


1.17
log
@• merge
• make const-clean(er) again *sigh*
@
text
@# $MirOS: src/usr.bin/make/Makefile,v 1.16 2006/08/27 00:39:07 tg Exp $
# $OpenBSD: Makefile,v 1.40 2007/03/18 15:37:06 mickey Exp $

.include <bsd.own.mk>

PROG=		make
CDIAGFLAGS+=	-Wall -W -Wno-char-subscripts -Wstrict-prototypes -pedantic \
		-Wmissing-prototypes -Werror -Wno-cast-qual
#CPPFLAGS+=	-DHAS_STATS	# Throw out statistics after running
CPPFLAGS+=	-DMACHINE=\"${MACHINE}\" -DMACHINE_ARCH=\"${MACHINE_ARCH}\"
CPPFLAGS+=	-I. -I${.CURDIR}

SRCS=	arch.c buf.c cmd_exec.c compat.c cond.c dir.c error.c for.c \
	init.c job.c lowparse.c main.c make.c memory.c parse.c \
	parsevar.c str.c stats.c suff.c targ.c timestamp.c \
	var.c varmodifiers.c varname.c
SRCS+=	lstAddNew.c lstAppend.c lstConcat.c lstConcatDestroy.c \
	lstDeQueue.c lstDestroy.c lstDupl.c lstFindFrom.c lstForEachFrom.c \
	lstInsert.c lstMember.c lstRemove.c lstReplace.c lstSucc.c
.PATH:	${.CURDIR}/lst.lib

.ifdef MAKE_BOOTSTRAP
MKFEATURES?=	-D_PATH_DEFSYSPATH=\"/usr/share/mk\"
CPPFLAGS+=	-DMACHINE_OS=\"${MACHINE_OS}\" -DMAKE_BOOTSTRAP
.else
MKFEATURES?=	-DUSE_TIMESPEC
.endif
CPPFLAGS+=	${MKFEATURES} -D_PATH_MIRBSDKSH=\"${MKSH}\" -DIN_MIRMAKE

.if !exists(${MKSH})
.BEGIN:
	@@echo 'You know, $${MKSH} (${MKSH}) should exist!'
	@@exit 1
.endif

make.1: ${.CURDIR}/make.1
	sed -e 's#@@@@MKSH@@@@#${MKSH}#g' <$> >$@@

CLEANFILES+=	${LIBOBJS} check condhashconsts.h generate.o generate \
		hashconsts.h libohash.a regress.o varhashconsts.h
.if ${.OBJDIR} != ${.CURDIR}
CLEANFILES+=	make.1
.endif

beforedepend: varhashconsts.h condhashconsts.h
# may need tweaking if you add variable synonyms or change the hash function
MAGICVARSLOTS=	82
MAGICCONDSLOTS=	65

varhashconsts.h: generate
	${.OBJDIR}/generate 1 ${MAGICVARSLOTS} >$@@

condhashconsts.h: generate
	${.OBJDIR}/generate 2 ${MAGICCONDSLOTS} >$@@

generate: generate.c stats.c memory.c ${OHASH_SRCS}
	${HOSTCC} ${LDSTATIC} -o $@@ ${HOSTCFLAGS} ${CPPFLAGS} $> ${LDADD}

check: regress.o str.o memory.o buf.o
	${CC} -o $@@ ${CFLAGS} $> ${LDADD}

regress: check
	${.OBJDIR}/check

.if make(install)
SUBDIR+= PSD.doc
.endif

.PHONY: regress

.include <bsd.prog.mk>
@


1.16
log
@simplify in-mirmake bootstrap build, now that
we have libohash in libmirmake
@
text
@d1 2
a2 2
# $MirOS: src/usr.bin/make/Makefile,v 1.15 2006/08/26 21:37:11 tg Exp $
# $OpenBSD: Makefile,v 1.38 2004/01/28 02:50:28 espie Exp $
d7 1
a7 1
CDIAGFLAGS=	-Wall -W -Wno-char-subscripts -Wstrict-prototypes -pedantic \
d10 2
a11 1
CPPFLAGS+=	-I. -DMACHINE=\"${MACHINE}\" -DMACHINE_ARCH=\"${MACHINE_ARCH}\"
@


1.15
log
@no longer needed
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.14 2006/08/26 21:29:00 tg Exp $
d23 1
a23 7
CPPFLAGS+=	-Iohash -DMACHINE_OS=\"${MACHINE_OS}\" -DMAKE_BOOTSTRAP
OHASH_SRCS=	ohash_create_entry.c ohash_delete.c ohash_do.c \
		ohash_entries.c ohash_enum.c ohash_init.c ohash_interval.c \
		ohash_lookup_interval.c ohash_lookup_memory.c \
		ohash_qlookup.c ohash_qlookupi.c
.PATH:		${.CURDIR}/ohash
SRCS+=		${OHASH_SRCS}
@


1.14
log
@assume a working <stdbool.h>
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.13 2006/06/16 20:25:01 tg Exp $
a29 1
LDADD+=		${LIBS}
@


1.13
log
@don't mix host and target flags
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.12 2005/11/24 14:12:28 tg Exp $
d22 1
a22 1
MKFEATURES?=	-DHAS_STDBOOL_H -D_PATH_DEFSYSPATH=\"/usr/share/mk\"
@


1.12
log
@add ${LIBS}
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.11 2005/11/24 14:00:33 tg Exp $
d63 1
a63 1
	${HOSTCC} ${LDSTATIC} -o $@@ ${CFLAGS} ${CPPFLAGS} $> ${LDADD}
@


1.11
log
@generate needs libohash
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.10 2005/11/24 13:51:53 tg Exp $
d30 1
@


1.10
log
@but include defines.h
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.9 2005/11/24 13:32:32 tg Exp $
d24 1
a24 1
SRCS+=		ohash_create_entry.c ohash_delete.c ohash_do.c \
d29 1
d61 1
a61 1
generate: generate.c stats.c memory.c
@


1.9
log
@this was for testing only
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.8 2005/11/24 13:32:07 tg Exp $
d32 1
a32 1
CPPFLAGS+=	${MKFEATURES} -D_PATH_MIRBSDKSH=\"${MKSH}\"
@


1.8
log
@assume we're re-building with ourselves on 'MAKE_BOOTSTRAP'
and let the user provide fgetln(3) (via libmirmake)
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.7 2005/11/24 13:26:56 tg Exp $
a33 2
CFLAGS_fgetln.o=-Wno-redundant-decls

@


1.7
log
@make fgetln into a file of its own
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.6 2005/11/24 12:49:37 tg Exp $
a22 1
SRCS_FGETLN?=	fgetln.c
d27 1
a27 1
		ohash_qlookup.c ohash_qlookupi.c ${SRCS_FGETLN}
@


1.6
log
@* Makefile.boot: remove copy-libc, mirmake does this now
* Makefile: integrate stubs for building MirMake
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.5 2005/11/24 12:37:43 tg Exp $
d22 2
a23 2
MKFEATURES?=	-DNEED_FGETLN -D_PATH_DEFSYSPATH=\"/usr/share/mk\" \
		-DHAS_STDBOOL_H # -DNEED_VSNPRINTF # -DNO_REGEX
d28 1
a28 1
		ohash_qlookup.c ohash_qlookupi.c
d35 2
@


1.5
log
@* make it easier for later makes to build it portably
* start __CRAZY cleanup, but with -Wno-cast-qual (and checking)
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.4 2005/09/01 23:48:20 tg Exp $
a6 1
CPPFLAGS+=	-I.
a8 1
CPPFLAGS+=	-DUSE_TIMESPEC -D_PATH_MIRBSDKSH=\"${MKSH}\"
d10 1
a10 1
CPPFLAGS+=	-DMACHINE=\"${MACHINE}\" -DMACHINE_ARCH=\"${MACHINE_ARCH}\"
d21 14
@


1.4
log
@don't hardcode MACHINE_OS on build depending on build environment
for MirOS make(1) - let it divine according to CPP defines instead
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.3 2005/03/06 22:28:37 tg Exp $
d9 1
a9 1
		-Wmissing-prototypes -Werror
a10 1
CPPFLAGS+=	-DHAS_BOOL_H -DHAS_PATHS_H -DHAS_EXTENDED_GETCWD
@


1.3
log
@improve passing of CPPFLAGS
@
text
@d1 1
a1 1
# $MirOS: src/usr.bin/make/Makefile,v 1.2 2005/02/23 20:36:53 tg Exp $
a13 3
.if defined(MACHINE_OS) && !empty(MACHINE_OS)
CPPFLAGS+=	-DMACHINE_OS=\"${MACHINE_OS}\"
.endif
@


1.2
log
@* merge make from ncvs 1
* reduce diff in the amount of whitespace to facilitate
  easier future merges of OpenBSD, in the hope they'll
  ever fix that in their CVS *sigh*
* sane MACHINE{,_ARCH,_OS} handling
@
text
@d1 1
a1 1
# $MirOS$
d10 2
a11 4
CPPFLAGS+=	-DUSE_TIMESPEC
CPPFLAGS+=	-DHAS_BOOL_H
CPPFLAGS+=	-DHAS_PATHS_H
CPPFLAGS+=	-DHAS_EXTENDED_GETCWD
d13 4
a16 2
CPPFLAGS+=	-DMACHINE=\"${MACHINE}\" -DMACHINE_ARCH=\"${MACHINE_ARCH}\" \
		-DMACHINE_OS=\"${MACHINE_OS}\" -D_PATH_MIRBSDKSH=\"${MKSH}\"
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile,v 1.38 2004/01/28 02:50:28 espie Exp $
d4 13
a16 10
PROG=	make
CFLAGS+= -I${.OBJDIR} -I${.CURDIR}
CDIAGFLAGS=-Wall -W -Wno-char-subscripts -Wstrict-prototypes -pedantic \
	-Wmissing-prototypes

CFLAGS+=-DUSE_TIMESPEC
CFLAGS+=-DHAS_BOOL_H
CFLAGS+=-DHAS_PATHS_H
CFLAGS+=-DHAS_EXTENDED_GETCWD
#CFLAGS+=-DHAS_STATS
d27 5
d33 2
a34 1
CLEANFILES+=generate hashconsts.h generate.o regress.o check
d36 5
a40 2
CLEANFILES+=${LIBOBJS} libohash.a
CLEANFILES+= varhashconsts.h condhashconsts.h generate.o generate
d44 2
a45 2
MAGICVARSLOTS=77
MAGICCONDSLOTS=65
d48 1
a48 1
	${.OBJDIR}/generate 1 ${MAGICVARSLOTS} >${.TARGET}
d51 1
a51 1
	${.OBJDIR}/generate 2 ${MAGICCONDSLOTS} >${.TARGET}
d54 1
a54 1
	${HOSTCC} ${LDSTATIC} -o ${.TARGET} ${CFLAGS} ${.ALLSRC} ${LDADD}
d57 1
a57 1
	${CC} -o ${.TARGET} ${CFLAGS} ${.ALLSRC} ${LDADD}
d60 1
a60 5
	${.OBJDIR}/check 

# kludge for people who forget to make depend
var.o: varhashconsts.h
cond.o: condhashconsts.h
d66 1
a66 1
.PHONY:		regress
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@Import OtherBSD's make(1) improvements
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.40 2007/03/18 15:37:06 mickey Exp $
a4 1
HOSTCFLAGS+= -I${.OBJDIR} -I${.CURDIR}
d8 5
a12 8
CDEFS+=-DUSE_TIMESPEC
CDEFS+=-DHAS_BOOL_H
CDEFS+=-DHAS_PATHS_H
CDEFS+=-DHAS_EXTENDED_GETCWD
#CDEFS+=-DHAS_STATS

CFLAGS+=${CDEFS}
HOSTCFLAGS+=${CDEFS}
d41 1
a41 1
	${HOSTCC} ${LDSTATIC} -o ${.TARGET} ${HOSTCFLAGS} ${.ALLSRC} ${LDADD}
a51 2
var.ln: varhashconsts.h
cond.ln: condhashconsts.h
@

