head	1.14;
access;
symbols
	MIRBSD_10:1.9.0.2
	MIRBSD_10_BASE:1.9;
locks; strict;
comment	@# @;


1.14
date	2018.12.15.05.32.57;	author tg;	state Exp;
branches;
next	1.13;
commitid	1005C14921E15F4B7BE;

1.13
date	2008.10.21.21.03.34;	author tg;	state Exp;
branches;
next	1.12;
commitid	10048FE43B158335A05;

1.12
date	2008.09.06.15.07.52;	author tg;	state Exp;
branches;
next	1.11;
commitid	10048C29C7F22578445;

1.11
date	2008.07.07.13.57.15;	author tg;	state Exp;
branches;
next	1.10;
commitid	100487220B36BA627AC;

1.10
date	2008.05.13.12.14.29;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004829863225D9AA36;

1.9
date	2007.06.22.20.37.17;	author tg;	state Exp;
branches;
next	1.8;
commitid	100467C32F947D6FB80;

1.8
date	2007.05.28.13.52.54;	author tg;	state Exp;
branches;
next	1.7;
commitid	100465ADEB968B06118;

1.7
date	2006.10.29.16.57.44;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004544DD9E2E5B2AAB;

1.6
date	2006.10.04.08.59.02;	author tg;	state Exp;
branches;
next	1.5;
commitid	100452377D03C6A754B;

1.5
date	2006.09.30.20.59.01;	author tg;	state Exp;
branches;
next	1.4;
commitid	100451EDAA579D5615D;

1.4
date	2006.09.30.20.50.12;	author tg;	state Exp;
branches;
next	1.3;
commitid	100451ED85276EBDBEC;

1.3
date	2006.09.30.20.42.03;	author tg;	state Exp;
branches;
next	1.2;
commitid	100451ED68F0064C96C;

1.2
date	2006.08.18.22.18.25;	author tg;	state Exp;
branches;
next	1.1;
commitid	10044E63CC77F985A26;

1.1
date	2006.08.17.19.58.02;	author tg;	state Exp;
branches;
next	;
commitid	10044E4CA2D0E8EFBD4;


desc
@@


1.14
log
@consistency
@
text
@# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.12 2008/09/06 15:07:52 tg Exp $
#-
# Copyright (c) 2006, 2007, 2008, 2018
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.

. /etc/rc.netselect.common

# Stuff to come *before* the shell escape possibility
do_before
print
print Welcome to the MirBSD/i386 baseLive CD
print ======================================
show_info
get_passwd

# The menu
print
print "Select the MirOS/i386 Live CD 'modus operandi'"
print "=============================================="
x=
while [[ $x != @@(1|2|3|4|5) ]]; do
	print '1) manual/no network, no graphics'
	print '2) automatic network (dhcp), no graphics'
	print '3) automatic network, XFree86 (vesa 800x600@@16bpp) xdm/twm'
	print '4) automatic network, XFree86 (vesa 1024x768@@24bpp) xdm/twm'
	print '5) automatic network, XFree86 (vesa 1280x1024@@24bpp) xdm/twm'
	print '9) temporarily escape into a shell (type "exit" to return)'
	if [[ $x =  ]]; then
		print
		print If you need to plug in any network devices, do it now.
	fi
	print -n "Your choice? "
	read x
	[[ $x = 9 ]] && do_shell
done

case $x {
(1)	# no network to configure
	do_netconf none
	;;
(2)	# configure the network
	ask_netconfig
	;;
(3)	# configure network and X (with lower resolution)
	print xdm_flags= >>/etc/rc.conf.local
	print '/DefaultDepth/s/24/16/\nwq' | ed -s /etc/X11/XF86Config
	ask_netconfig
	;;
(4)	# configure network and X
	print xdm_flags= >>/etc/rc.conf.local
	ask_netconfig
	;;
(5)	# configure network and X (with higher resolution)
	print xdm_flags= >>/etc/rc.conf.local
	print '/"1024x768/s//"1280x1024" &/\nwq' | ed -s /etc/X11/XF86Config
	ask_netconfig
	;;
}
print

# Stuff to clean up
set_hostname
do_after
@


1.13
log
@modernise, simplify
commit before testing (as backup)
@
text
@d3 2
a4 2
# Copyright (c) 2006, 2007, 2008
#	Thorsten Glaser <tg@@mirbsd.de>
d70 1
a70 2
	ed -s /etc/X11/XF86Config <<<'/"1024x768/s//"1280x1024" &/
	    wq'
@


1.12
log
@add my new “you wanna shell? gimme root pw!” code to /etc/rc.netselect on
the baselive CD… for the archives (as my personal /etc/rc.netselect is not
publically versioned)

/etc/ttys on a live cd _should_ have a secure console, so it won’t trigger
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.11 2008/07/07 13:57:15 tg Exp $
d3 1
a3 1
# Copyright (c) 2006, 2007
d36 1
a36 1
while [[ $x != @@(1|2|3|4) ]]; do
d39 3
a41 3
	print '3) automatic network, XFree86 (vesa 1024x768@@24bpp) xdm/twm'
	print '4) automatic network, XFree86 (vesa 800x600@@16bpp) xdm/twm'
	#print '5) automatic network, XFree86 (vesa 640x480@@8bpp) xdm/twm'
d59 1
a59 1
(3)	# configure network and X
d61 1
d64 1
a64 1
(4)	# configure network and X (with lower resolution)
a65 1
	print '/DefaultDepth/s/24/16/\nwq' | ed -s /etc/X11/XF86Config
d68 1
a68 1
(5)	# configure network and X (with lower resolution)
d70 2
a71 1
	print '/DefaultDepth/s/24/8/\nwq' | ed -s /etc/X11/XF86Config
@


1.11
log
@nuke more advertising clauses from me; also remove mine and TNF's original
one (not all the other nbsd related) from the list
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.10 2008/05/13 12:14:29 tg Exp $
d49 1
a49 4
	if [[ $x = 9 ]]; then
		HOME=/ /bin/mksh -l
		print
	fi
@


1.10
log
@nah, get rid of /dev/.root as root home directory entirely
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.9 2007/06/22 20:37:17 tg Exp $
a11 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
@


1.9
log
@ugh, that error message was a good one… didn't know at first…
but ‘i’ is obviously an integer… so don't assign ^A to it…
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.8 2007/05/28 13:52:54 tg Exp $
d54 1
a54 1
		HOME=/dev/.root /bin/mksh -l
@


1.8
log
@re-display the “modus operandi choice” menu after shell escaping,
noticed by bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d39 2
a40 2
i=
while [[ $i != @@(1|2|3|4) ]]; do
d47 1
a47 1
	if [[ $i =  ]]; then
d52 2
a53 2
	read i
	if [[ $i = 9 ]]; then
d59 1
a59 1
case $i {
@


1.7
log
@simplify
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.6 2006/10/04 08:59:02 tg Exp $
d3 1
a3 1
# Copyright (c) 2006
d6 5
a10 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d16 8
a23 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
d39 1
a39 9
print '1) manual/no network, no graphics'
print '2) automatic network (dhcp), no graphics'
print '3) automatic network, XFree86 (vesa 1024x768@@24bpp) xdm/twm'
print '4) automatic network, XFree86 (vesa 800x600@@16bpp) xdm/twm'
#print '5) automatic network, XFree86 (vesa 640x480@@8bpp) xdm/twm'
print '9) temporarily escape into a shell (type "exit" to return)'
print
print If you need to plug in any network devices, do it now.
i=
d41 10
d53 4
a56 1
	[[ $i = 9 ]] && HOME=/dev/.root /bin/mksh -l
@


1.6
log
@640x480x8 segfaults (sig11) in qemu for me, disable it for now
will be re-enabled if it works for at least someone
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.5 2006/09/30 20:59:01 tg Exp $
d30 5
a57 3
	show_info
	get_passwd
	set_hostname
a60 3
	show_info
	get_passwd
	set_hostname
d63 1
a64 4
	show_info
	print xdm_flags= >>/etc/rc.conf.local
	get_passwd
	set_hostname
a66 2
	ask_netconfig
	show_info
d69 1
a69 2
	get_passwd
	set_hostname
a71 2
	ask_netconfig
	show_info
d74 1
a74 2
	get_passwd
	set_hostname
d80 1
@


1.5
log
@simplify; commonise
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.4 2006/09/30 20:50:12 tg Exp $
d39 1
a39 1
print '5) automatic network, XFree86 (vesa 640x480@@8bpp) xdm/twm'
d44 1
a44 1
while [[ $i != @@(1|2|3|4|5) ]]; do
@


1.4
log
@* sanitise quoting
* use $RANDOM instead of dd and hexdump on /dev/arandom
  to generate entrophic hostname, saves a lot of forks
  AND is smaller code AND gets better result (because of
  the rounding to 36^5 instead 2^32 - must use 36^5 and
  not 36^6 because 36^6>2^31 and $RANDOM is 31-bit only)
* add 640x480 @@8bpp video mode while here, it's cheap
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.3 2006/09/30 20:42:03 tg Exp $
d26 1
a26 92
function show_info
{
	print
	print 'To get support, use lynx(1) with the following resources:'
	print 'online man pages: http://www.mirbsd.org/cman/'
	print 'interactive help: http://www.mirbsd.org/?irc'
}

function get_passwd
{
	print
	print "To login to the MirOS Live CD, a user 'live' has been added."
	print 'Please enter a password to login with now (default: "live").'
	print Note: it is highly suggested to change the password, because
	print 'sshd(8) is started by default.'
	passwd live
}

function set_hostname
{
	typeset -Uui36 rndval=$(date +%s)
	rndpfx=${rndval#36#}
	while (( ${#rndpfx} < 36 )); do
		typeset -Uui36 'rndval=(RANDOM % 60466176)' # 36^5
		rndpfx=${rndval#36#}$rndpfx
	done
	while (( ${#rndpfx} > 36 )); do
		rndpfx=${rndpfx#?}
	done
	# yes, the "livecd." comes first, trust me on this
	print livecd.$rndpfx.invalid.mirbsd.org >/etc/myname
	print ::1 livecd livecd.$rndpfx.invalid.mirbsd.org >>/etc/hosts
	print 127.0.0.1 livecd livecd.$rndpfx.invalid.mirbsd.org >>/etc/hosts
}

function get_net_ifnames
{
	local foo
	integer i

	set -A foo -- $(ifconfig -l)
	i=${#foo[*]}
	while (( i-- > 0 )); do
		[[ ${foo[i]} = @@(lo|bridge|enc|gif|gre|tun|vlan|irip|pflog|pfsync|plip|sl)+([0-9]) ]] && \
		    unset foo[i]
	done
	print ${foo[*]}
}

function ask_netconfig
{
	set -A all_ifnames -- $(get_net_ifnames)
	default_ifname=${all_ifnames[0]}
	if [[ -z $default_ifname ]]; then
		print
		print No network interface found, skipping.
		do_netconf none
		return
	fi
	print
	print "Available network interfaces: ${all_ifnames[*]}"
	if=
	while [[ -z $if ]]; do
		print -n Interface to run a DHCP client on \
		    "(or none/done) [$default_ifname]? "
		read ifname
		[[ $ifname = @@(d|n)one ]] && break
		[[ -z $ifname ]] && ifname=$default_ifname
		let i=0
		while (( i < ${#all_ifnames[*]} )); do
			[[ ${all_ifnames[i]} = $ifname ]] && \
			    if=${all_ifnames[i]}
			let ++i
		done
	done
	do_netconf ${if:-none}
}

function do_netconf
{
	if [[ $1 = none ]]; then
		:
		#XXX this is actually a bad idea, maybe the network
		#XXX is manually configured later; for now, just do
		#XXX not add the run of rdate (ntpd is run with -S)
		#print ntpd_flags=NO >>/etc/rc.conf.local
	else
		print dhcp >/etc/hostname.$1
		print rdate_flags=\"-nv ntp.mirbsd.org\" >>/etc/rc.conf.local
		print rtsold_flags=-am >>/etc/rc.conf.local
	fi
}
d29 1
a29 1
rm -f /etc/hosts
d90 1
a90 1
rm -f /etc/hostname.done
@


1.3
log
@offer 800x600 (@@16bpp) vesa xdm(1) video mode too (helps qemu);
change 1024x768 to 24bpp (sorta standard these days)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/i386/rc.netselect,v 1.2 2006/08/18 22:18:25 tg Exp $
d29 3
a31 3
	print To get support, use lynx\(1\) with the following resources:
	print online man pages: http://www.mirbsd.org/cman/
	print interactive help: http://www.mirbsd.org/?irc
d37 2
a38 2
	print To login to the MirOS Live CD, a user \'live\' has been added.
	print Please enter a password to login with now \(default: \"live\"\).
d40 1
a40 1
	print sshd\(8\) is started by default.
d49 1
a49 2
		typeset -Uui36 rndval=0x$(dd if=/dev/arandom bs=4 count=1 \
		    2>/dev/null | hexdump -e '4/1 "%02X"')
d89 1
a89 1
		print -n "Interface to run a DHCP client on" \
d124 8
a131 7
print Select the MirOS/i386 Live CD \'modus operandi\'
print ==============================================
print 1\) manual/no network, no graphics
print 2\) automatic network \(dhcp\), no graphics
print 3\) automatic network, XFree86 \(vesa 1024x768@@24bpp\) xdm/twm
print 4\) automatic network, XFree86 \(vesa 800x600@@16bpp\) xdm/twm
print 9\) temporarily escape into a shell \(type \"exit\" to return\)
d135 1
a135 1
while [[ $i != @@(1|2|3|4) ]]; do
d161 1
a161 1
(4)	# configure network and X
d169 8
@


1.2
log
@start sanitising
@
text
@d1 1
a1 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d129 2
a130 1
print 3\) automatic network, XFree86 \(vesa 1024x768@@16bpp\) xdm/twm
d135 1
a135 1
while [[ $i != @@(1|2|3) ]]; do
d161 8
@


1.1
log
@* new Makefile structure
* move i386/livecd into baselive/ and sub-directory-structure appropriately
* rid unneeded files
* ifdef out build of rescue tools not needed on certain arches
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/livecd/rc.netselect,v 1.18 2006/06/15 19:18:46 tg Exp $
d13 2
a14 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d24 1
a24 1
# the possibility of such damage or existence of a nontrivial bug.
d28 4
a31 4
#	print
#	print To get support, use lynx\(1\) with the following resources:
#	print online man pages: http://mirbsd.mirsolutions.de/cman/
#	print interactive help: http://mirbsd.mirsolutions.de/?irc
a59 4
	print 172.23.42.1 livecd >>/etc/hosts
	print 172.23.42.10 bpclnt10 >>/etc/hosts
	print 172.23.42.11 bpclnt11 >>/etc/hosts
	print 172.23.42.12 bpclnt12 >>/etc/hosts
d64 8
a71 5
	ifconfig -a | grep '^[a-z]' | while IFS=: read if rest; do
		case $if {
		(lo*|enc*|gif*|irip*|pflog*|pfsync*|plip*|tun*) ;;
		(*)	print $if ;;
		}
d73 1
d78 1
a78 1
	set -A all_ifnames -- $(get_net_ifnames | sort)
a116 1
		print -n >/tmp/try_rnd
d125 2
a126 2
print Select the MirOS Live CD \'modus operandi\'
print =========================================
@

