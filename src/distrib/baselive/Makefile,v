head	1.73;
access;
symbols
	MIRBSD_10:1.24.0.2
	MIRBSD_10_BASE:1.24;
locks; strict;
comment	@# @;


1.73
date	2019.01.05.13.30.49;	author tg;	state Exp;
branches;
next	1.72;
commitid	1005C30B1A05E192EA5;

1.72
date	2018.09.26.16.03.27;	author tg;	state Exp;
branches;
next	1.71;
commitid	1005BABADDB7C925D10;

1.71
date	2018.04.28.05.22.15;	author tg;	state Exp;
branches;
next	1.70;
commitid	1005AE4051D07D1F35F;

1.70
date	2018.01.07.23.27.30;	author tg;	state Exp;
branches;
next	1.69;
commitid	1005A52ACF9654215C5;

1.69
date	2017.01.29.00.51.02;	author tg;	state Exp;
branches;
next	1.68;
commitid	100588D3C8F09DC1F20;

1.68
date	2016.01.02.20.05.04;	author tg;	state Exp;
branches;
next	1.67;
commitid	10056882D871C1C3E41;

1.67
date	2015.01.02.13.54.15;	author tg;	state Exp;
branches;
next	1.66;
commitid	10054A6A31E3A41516F;

1.66
date	2014.01.04.20.24.56;	author tg;	state Exp;
branches;
next	1.65;
commitid	10052C86E2F00C31DB5;

1.65
date	2013.01.01.17.31.01;	author tg;	state Exp;
branches;
next	1.64;
commitid	10050E31D6B7FB977FF;

1.64
date	2012.01.05.09.49.04;	author bsiegert;	state Exp;
branches;
next	1.63;
commitid	1004F0571662752892F;

1.63
date	2011.01.03.17.49.39;	author tg;	state Exp;
branches;
next	1.62;
commitid	1004D220C4445D53F23;

1.62
date	2010.08.06.15.40.00;	author tg;	state Exp;
branches;
next	1.61;
commitid	1004C5C2C6D79827EDA;

1.61
date	2010.01.06.18.52.23;	author tg;	state Exp;
branches;
next	1.60;
commitid	1004B44DBF909E317C9;

1.60
date	2009.12.27.14.48.11;	author tg;	state Exp;
branches;
next	1.59;
commitid	1004B3773B95A83521F;

1.59
date	2009.08.15.18.18.40;	author tg;	state Exp;
branches;
next	1.58;
commitid	1004A86FC100387DED3;

1.58
date	2009.08.02.16.20.49;	author tg;	state Exp;
branches;
next	1.57;
commitid	1004A75BCF719A58787;

1.57
date	2009.08.01.13.24.29;	author tg;	state Exp;
branches;
next	1.56;
commitid	1004A7441CB0219F74C;

1.56
date	2009.06.29.19.43.32;	author tg;	state Exp;
branches;
next	1.55;
commitid	1004A49196E0A8C7E20;

1.55
date	2009.06.29.17.35.01;	author tg;	state Exp;
branches;
next	1.54;
commitid	1004A48FB5739C9768E;

1.54
date	2009.06.29.17.08.28;	author tg;	state Exp;
branches;
next	1.53;
commitid	1004A48F4DB6BC02B75;

1.53
date	2009.06.29.16.46.36;	author tg;	state Exp;
branches;
next	1.52;
commitid	1004A48EFD57EB34069;

1.52
date	2009.06.07.13.13.17;	author tg;	state Exp;
branches;
next	1.51;
commitid	1004A2BBCF702DB98DA;

1.51
date	2009.04.16.13.20.22;	author tg;	state Exp;
branches;
next	1.50;
commitid	10049E73089575F8D71;

1.50
date	2009.02.02.22.58.12;	author tg;	state Exp;
branches;
next	1.49;
commitid	10049877A9758C83F47;

1.49
date	2009.02.02.10.45.58;	author tg;	state Exp;
branches;
next	1.48;
commitid	1004986CEFE5319F70B;

1.48
date	2009.01.18.19.26.35;	author tg;	state Exp;
branches;
next	1.47;
commitid	1004973827E46A96FE3;

1.47
date	2009.01.18.19.24.36;	author tg;	state Exp;
branches;
next	1.46;
commitid	1004973820B70B58A2F;

1.46
date	2009.01.17.12.21.00;	author tg;	state Exp;
branches;
next	1.45;
commitid	1004971CD4344697E68;

1.45
date	2009.01.17.12.18.23;	author tg;	state Exp;
branches;
next	1.44;
commitid	1004971CC9C6D611754;

1.44
date	2009.01.17.12.04.25;	author tg;	state Exp;
branches;
next	1.43;
commitid	1004971C95B717A11AE;

1.43
date	2009.01.17.11.58.37;	author tg;	state Exp;
branches;
next	1.42;
commitid	1004971C8027649B710;

1.42
date	2008.11.06.23.03.02;	author tg;	state Exp;
branches;
next	1.41;
commitid	1004913776C3F0BFE85;

1.41
date	2008.11.01.02.07.46;	author tg;	state Exp;
branches;
next	1.40;
commitid	100490BB9FC06892FFE;

1.40
date	2008.10.31.23.43.44;	author tg;	state Exp;
branches;
next	1.39;
commitid	100490B97B834F774AE;

1.39
date	2008.10.30.17.47.32;	author tg;	state Exp;
branches;
next	1.38;
commitid	1004909F292493E4BFA;

1.38
date	2008.10.21.21.45.19;	author tg;	state Exp;
branches;
next	1.37;
commitid	10048FE4D687ED889C5;

1.37
date	2008.10.21.21.05.12;	author tg;	state Exp;
branches;
next	1.36;
commitid	10048FE441B3F1C47B9;

1.36
date	2008.10.21.21.03.32;	author tg;	state Exp;
branches;
next	1.35;
commitid	10048FE43B158335A05;

1.35
date	2008.10.05.16.26.16;	author tg;	state Exp;
branches;
next	1.34;
commitid	10048E8EA7D6EAD401E;

1.34
date	2008.07.22.22.36.05;	author tg;	state Exp;
branches;
next	1.33;
commitid	100488660E72743F7A8;

1.33
date	2008.07.22.21.56.12;	author tg;	state Exp;
branches;
next	1.32;
commitid	1004886578F0CF7AF44;

1.32
date	2008.07.22.21.44.48;	author tg;	state Exp;
branches;
next	1.31;
commitid	100488654E32FAAF7A9;

1.31
date	2008.07.22.21.31.38;	author tg;	state Exp;
branches;
next	1.30;
commitid	100488651CC4AAA9022;

1.30
date	2008.07.19.22.34.02;	author tg;	state Exp;
branches;
next	1.29;
commitid	10048826BEB6A73E1B1;

1.29
date	2008.07.12.21.39.52;	author tg;	state Exp;
branches;
next	1.28;
commitid	1004879249A724183F4;

1.28
date	2008.07.10.01.33.15;	author tg;	state Exp;
branches;
next	1.27;
commitid	100487566D945691CD6;

1.27
date	2008.07.09.23.57.21;	author tg;	state Exp;
branches;
next	1.26;
commitid	10048755076220C9CF5;

1.26
date	2008.06.13.19.58.34;	author tg;	state Exp;
branches;
next	1.25;
commitid	1004852D17E14CD3B73;

1.25
date	2008.03.21.04.48.21;	author tg;	state Exp;
branches;
next	1.24;
commitid	10047E33E296D387558;

1.24
date	2007.07.18.09.04.11;	author tg;	state Exp;
branches;
next	1.23;
commitid	100469DD7687BA1D07D;

1.23
date	2007.07.15.20.48.38;	author tg;	state Exp;
branches;
next	1.22;
commitid	100469A882D6D2D33A5;

1.22
date	2007.07.11.16.08.55;	author tg;	state Exp;
branches;
next	1.21;
commitid	100469500AD4B8A39C9;

1.21
date	2007.07.09.00.24.55;	author tg;	state Exp;
branches;
next	1.20;
commitid	1004691806679D5D403;

1.20
date	2007.06.08.11.40.20;	author tg;	state Exp;
branches;
next	1.19;
commitid	100466940363363406D;

1.19
date	2007.06.07.02.40.36;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004667702A05ACA3A7;

1.18
date	2007.05.25.23.08.56;	author tg;	state Exp;
branches;
next	1.17;
commitid	10046576C8D33E14024;

1.17
date	2007.03.09.11.31.49;	author tg;	state Exp;
branches;
next	1.16;
commitid	10045F145644159D152;

1.16
date	2007.02.20.00.26.35;	author tg;	state Exp;
branches;
next	1.15;
commitid	10045DA40527A039975;

1.15
date	2007.01.30.22.42.05;	author tg;	state Exp;
branches;
next	1.14;
commitid	10045BFC9D207524C68;

1.14
date	2006.12.20.17.58.28;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004589799B48029B22;

1.13
date	2006.11.17.03.05.13;	author tg;	state Exp;
branches;
next	1.12;
commitid	100455D26C30F732046;

1.12
date	2006.10.29.16.49.21;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004544DBA1435EA341;

1.11
date	2006.10.16.19.27.50;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004533DC876B9D0CC0;

1.10
date	2006.10.14.23.18.30;	author tg;	state Exp;
branches;
next	1.9;
commitid	100453170564A69BE96;

1.9
date	2006.10.13.19.18.02;	author tg;	state Exp;
branches;
next	1.8;
commitid	100452FE67757921301;

1.8
date	2006.10.02.22.38.13;	author tg;	state Exp;
branches;
next	1.7;
commitid	100452194D0378AE099;

1.7
date	2006.10.02.07.08.10;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004520BAEE13A45088;

1.6
date	2006.10.02.07.03.16;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004520B9C458C2C177;

1.5
date	2006.08.19.19.06.04;	author tg;	state Exp;
branches;
next	1.4;
commitid	10044E7612775A7059F;

1.4
date	2006.08.18.22.39.54;	author tg;	state Exp;
branches;
next	1.3;
commitid	10044E641C13B3155E5;

1.3
date	2006.08.18.22.32.40;	author tg;	state Exp;
branches;
next	1.2;
commitid	10044E640156829EAEB;

1.2
date	2006.08.18.22.18.24;	author tg;	state Exp;
branches;
next	1.1;
commitid	10044E63CC77F985A26;

1.1
date	2006.08.17.19.58.00;	author tg;	state Exp;
branches;
next	;
commitid	10044E4CA2D0E8EFBD4;


desc
@@


1.73
log
@2019
@
text
@# $MirOS: src/distrib/baselive/Makefile,v 1.72 2018/09/26 16:03:27 tg Exp $

.include <bsd.own.mk>

# common variables
REALOBJDIR!=	realpath ${.OBJDIR}
TOPDIR?=	${.CURDIR}/..

DUALIVE?=	No
BATCH?=		No
GRML?=		No

.if ${GRML:L} != "no"
BATCH=		No
.endif

.if ${DUALIVE:L} == "no"
STUFFDIR=	${BSDRELDIR}/rel
.else
STUFFDIR=	${DUALIVE}/i386
.endif

.MAIN: all

KERNEL_PREP=	print 'rootdev 6 0\nquit' | config -ef bsd.tmp
.if exists(${REALOBJDIR}/../../sys/arch/i386/stand/liveboot/.)
BOOT=		${REALOBJDIR}/../../sys/arch/i386/stand/liveboot/boot
DO_LIVEBOOT=	#defined
.endif
CDROM_OPTS+=	bootimage=i386\;b_torito.ldr
CDROM_OPTS+=	no-emul-boot

CHAINSECTOR?=	24

# temporary mounts
WRKDIR=		${REALOBJDIR}/tmpdata
TMPMOUNT=	${REALOBJDIR}/tmpmnt
VND?=		svnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
RAWLABEL?=	-r

RDSETROOT?=	${REALOBJDIR}/../common/elfrdsetroot

IMAGE?=		mrdev${OSrev}.fs
IMAGESIZE?=	8192
IMAGEOPTS?=	minfree=0,optimization=space,bsize=4096,fsize=512,density=2048
IMAGETYPE?=	ipldisc
IMAGE_PREP?=	@@:
KERNEL_PREP?=	@@:

BOOT?=		${WRKDIR}/v${OSrev}/i386/boot

CDROM?=		livecd${OSrev}.iso
CDROM_OPTS+=	applicationid=NetBSD_makefs
CDROM_OPTS+=	hide-rr-moved
.if ${DUALIVE:L} != "no"
CDROM_OPTS+=	label=MirOS~v${OSrev}~BSD~DuaLive~CD
.else
CDROM_OPTS+=	label=MirOS~v${OSrev}~BSD/i386~Live~CD
.endif
CDROM_OPTS+=	no-trailing-padding
CDROM_OPTS+=	preparer=MirBSD_and_contributors
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2019_MirBSD
CDROM_OPTS+=	rockridge
.if ${DUALIVE:L} != "no"
.  if ${GRML:L} != "no"
CDROM_OPTS+=	volumeid=$$(uname -sl | tr -- '- \#' :_):Triforce
.  else
CDROM_OPTS+=	volumeid=$$(uname -sl | tr -- '- \#' :_):DuaLive
.  endif
.else
CDROM_OPTS+=	volumeid=$$(uname -slm | tr -- '- \#' :_):BaseLive
.endif
#CDROM_OPTS+=	v=1

.if ${DUALIVE:L} != "no"
LIVEBOOT_ARGS+=	DUALIVE=Yes
.endif
.if ${GRML:L} != "no"
LIVEBOOT_ARGS+=	GRML=Yes
.endif

BOOTCFG_SRCS=	${TOPDIR}/common/boot.cfg.i386
.if ${GRML:L} != "no"
BOOTCFG_SRCS+=	${.CURDIR}/boot.cfg.grml
.endif
.if ${DUALIVE:L} != "no"
BOOTCFG_SRCS+=	${.CURDIR}/boot.cfg.dual
.endif
BOOTCFG_SRCS+=	${.CURDIR}/boot.cfg.tail

all install:

do-cdrom: unpack addcontrib prepimg nukefiles makeimg

it: do-cdrom

unpack:
	test ! -e ${TMPMOUNT} || (cd ${.CURDIR}; ${MAKE} unconfig)
	${SUDO} rm -rf ${WRKDIR}
	mkdir -p ${WRKDIR}/v${OSrev}/i386
	# ensure they are releatively upfront on the CD
.if ${DUALIVE:L} != "no"
	touch ${WRKDIR}/{b_i386,b_sparc}.ldr
.else
	touch ${WRKDIR}/b_i386.ldr
.endif
.if ${GRML:L} != "no"
	mkdir -p ${WRKDIR}/boot/grml
.endif
	# needed for the installer of MirOS-current snapshots
	ln -s v${OSrev} ${WRKDIR}/current
	# unpack the dist sets
.for _i in base dev etc gnu xbase xetc xfont xserv
	cd ${WRKDIR} && ${SUDO} tar -M lncp -xzphf ${STUFFDIR}/${_i}${OSrev}.ngz
.endfor
	cd ${STUFFDIR} && pax -rw . ${WRKDIR}/v${OSrev}/i386/
.if ${DUALIVE:L} != "no"
	cd ${DUALIVE} && pax -rw sparc ${WRKDIR}/v${OSrev}/
.endif
	${SUDO} chown -R 0:0 ${WRKDIR}/v${OSrev}
	cp ${TOPDIR}/common/{00-README,01-3RDPTY} ${WRKDIR}/
	cat ${BOOTCFG_SRCS} | sudo dd of=${WRKDIR}/boot.cfg
	${SUDO} cp ${.CURDIR}/i386/boot.* ${WRKDIR}/
.if ${GRML:L} == "no"
	${SUDO} rm -f ${WRKDIR}/boot.9
.endif
	${SUDO} mkdir -p ${WRKDIR}/boot/grub
	${SUDO} cp ${.CURDIR}/i386/loopback.* ${WRKDIR}/boot/grub/

${IMAGE}:
	test ! -e ${TMPMOUNT} || (cd ${.CURDIR}; ${MAKE} unconfig)
	${SUDO} mkdir -p ${TMPMOUNT}
	${SUDO} chown 0:0 ${TMPMOUNT}
	${SUDO} cp ${WRKDIR}/dev/MAKEDEV ${TMPMOUNT}/
	cd ${TMPMOUNT} && ${SUDO} ${MKSH} MAKEDEV all
	-${SUDO} dd if=/dev/arandom bs=512 count=4 of=${TMPMOUNT}/.rs
	${SUDO} makefs -s ${IMAGESIZE}b -o ${IMAGEOPTS} ${IMAGE} ${TMPMOUNT}
	${SUDO} dd if=/dev/arandom bs=512 count=1 of=$@@ conv=notrunc
	sync
	${SUDO} vnconfig -v -c ${VND} ${IMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${IMAGETYPE}
	${SUDO} mount -r ${VND_DEV} ${TMPMOUNT}
	${IMAGE_PREP}
	@@echo ""
	@@df -i ${TMPMOUNT}
	@@echo ""
	${SUDO} umount ${TMPMOUNT}
	${SUDO} fsck -fy ${VND_RDEV}
	${SUDO} vnconfig -v -u ${VND}
	${SUDO} rm -rf ${TMPMOUNT}

addcontrib:
	@@if [[ ! -s ${BSDSRCDIR}/contrib/code/jupp/jupprc ]]; then \
		print -u2 Aborted: your checkout is not complete; \
		exit 1; \
	fi
	@@if [[ ! -s ${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c ]]; then \
		print -u2 Aborted: your checkout is not complete; \
		exit 1; \
	fi
	mkdir -p tempdir
	set -e; set -o pipefail; (cd ${BSDSRCDIR} && find contrib/ -type f | \
	    fgrep -v /CVS/ | \
	    fgrep -e contrib/code/jupp/ -e contrib/code/Snippets/tinyirc.c | \
	    cpio -oC512 -Hustar -Mdist) | gzip -n9 >tempdir/contrib.tgz
	${SUDO} install -o 0 -g 0 -m 644 tempdir/contrib.tgz \
	    ${WRKDIR}/usr/share/doc/baselive-contrib-src.tgz
	cd tempdir; CC=${CC:Q} CFLAGS=${CFLAGS:Q}\ ${COPTS:Q}\ -Ddefutf8 \
	    ${MKSH} ${BSDSRCDIR}/contrib/code/jupp/configure --disable-termidx \
	    --sysconfdir=/etc --disable-dependency-tracking --prefix=/usr && \
	    make && ${SUDO} make install DESTDIR=${WRKDIR:Q}
	cd tempdir; cp ${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c . && \
	    make -f tinyirc.c && ${SUDO} make -f tinyirc.c install \
	    DESTDIR=${WRKDIR:Q} BINDIR=/usr/bin
	${SUDO} install -o 0 -g 0 -m 644 \
	    ${BSDSRCDIR}/contrib/samples/dot.Xmodmap \
	    ${WRKDIR}/etc/skel/.Xmodmap

prepimg:
	cd ${WRKDIR} && MACHINE=i386 \
	    ${SUDO} ${MKSH} ${.CURDIR}/munge_it.sh

bsd.gz: bsd ${IMAGE}
	-rm -f bsd.tmp
	gzip -d <bsd >bsd.tmp
	${KERNEL_PREP}
	${RDSETROOT} bsd.tmp <${IMAGE}
	gzip -n9 <bsd.tmp >$@@

.if ${DUALIVE:L} != "no"
bsd: ${DUALIVE}/i386/bsd
.else
bsd: ${BSDOBJDIR}/distrib/generic/bsd
.endif
	cp -f $> $@@

nukefiles:
	cd ${WRKDIR} && ${SUDO} rm -rf etc/X11 usr/{local/lib/X11,releng} \
	    usr/{,X11R6/}{doc,info,man} usr/X11R6/lib/X11/doc
.if ${DEBUGLIBS:L} == "yes"
	-for name in ${WRKDIR}/usr/{,X11R6/}lib/*@@(.so.*|.a); do \
		print -n stripping $${name##*/} ...; \
		if [[ $$name = *.a ]]; then \
			for i in $${name%a}so*; do \
				if [[ -e $$i ]]; then \
					print deleted for $${i##*/}; \
					${SUDO} rm -f $$name; \
				else \
					${SUDO} strip --strip-unneeded \
					    $$name && print; \
				fi; \
				break; \
			done; \
		else \
			${SUDO} strip --strip-unneeded $$name && print; \
		fi; \
	done
.endif

makeimg: cdrom-prepare cdrom-generate

cdrom-prepare: bsd.gz
	${SUDO} chown $$(id -u) ${WRKDIR}
	chmod 755 ${WRKDIR}
	${SUDO} dd if=bsd.gz obs=2048 conv=osync of=${WRKDIR}/bsd
.if ${DUALIVE:L} != "no"
	${SUDO} cp ${DUALIVE}/sparc/boot ${WRKDIR}/b_sparc.ldr
	# fix path to default kernel file in second-stage boot loader
	set -A dump -- $$(dd if=${WRKDIR}/b_sparc.ldr bs=4 count=64 | \
	    hexdump -ve '1/1 "%02X"' | sed 's/\(........\)/ \1/g'); i=0; \
	while (( i < 64 )); do [[ $${dump[i++]} = 2035560? ]] && break; done; \
	if [[ $$i = 64 || $${dump[i-1]} != 20355601 ]]; then \
		print -u2 found invalid or no patch field version; exit 1; \
	fi; ofs=$$((#0x$${dump[i+1]})); \
	print -n v${OSrev}/sparc/bsd.rd\\0 | \
	    ${SUDO} dd of=${WRKDIR}/b_sparc.ldr bs=1 seek=$$ofs conv=notrunc
.endif
.ifdef DO_LIVEBOOT
	cd ${.CURDIR}/../../sys/arch/i386/stand/liveboot; \
	    ${MAKE} ${LIVEBOOT_ARGS} cleandir && \
	    ${MAKE} ${LIVEBOOT_ARGS} depend && \
	    exec ${MAKE} ${LIVEBOOT_ARGS}
.endif
	cd ${WRKDIR}; \
	    ${SUDO} cp ${BOOT} b_i386.ldr; \
	    ${SUDO} rm -f CKSUM*; \
	    if [[ -e v${OSrev}/i386/CKSUM ]]; then \
		cat v${OSrev}/i386/CKSUM >CKSUM~; \
	    else \
		gzip -dc v${OSrev}/i386/CKSUM.gz >CKSUM~; \
	    fi; \
	    while IFS= read -r line; do \
		if [[ $$line = *" = "+([0-9a-fA-F]) ]]; then \
			two=$${line#+([A-Z0-9]) \(}; \
		else \
			two=$${line#+([0-9]) +([0-9]) }; \
		fi; \
		one=$${line%%$$two}; \
		print -r "$${one}v${OSrev}/i386/$$two"; \
	    done <CKSUM~ >>CKSUM
.if ${DUALIVE:L} != "no"
	cd ${WRKDIR}; \
	    if [[ -e v${OSrev}/sparc/CKSUM ]]; then \
		cat v${OSrev}/sparc/CKSUM >CKSUM~; \
	    else \
		gzip -dc v${OSrev}/sparc/CKSUM.gz >CKSUM~; \
	    fi; \
	    while IFS= read -r line; do \
		if [[ $$line = *" = "+([0-9a-fA-F]) ]]; then \
			two=$${line#+([A-Z0-9]) \(}; \
		else \
			two=$${line#+([0-9]) +([0-9]) }; \
		fi; \
		one=$${line%%$$two}; \
		print -r "$${one}v${OSrev}/sparc/$$two"; \
	    done <CKSUM~ >>CKSUM
.endif
	cd ${WRKDIR}; \
	    cksum -a cksum -a rmd160 -a tiger 0* bsd b_* gzs* stand/* >>CKSUM
	-${SUDO} rm -f ${CDROM}* ${WRKDIR}/CKSUM~

cdrom-generate:
.if ${BATCH:L} != "yes"
	@@print WRKDIR is \"${WRKDIR:Q}\"
	@@print Build coordination: press RETURN to continue...; read dummy
.endif
	${SUDO} chown $$(id -u) ${WRKDIR}
	chmod 755 ${WRKDIR}
	cd ${WRKDIR}; \
	    [[ -e CKSUM && ! -e CKSUM.gz ]] || ${SUDO} gzip -d CKSUM; \
	    sort -k3 |& exec 3>&p; exec 4<&p; \
	    sort |& exec 5>&p; exec 6<&p; \
	    while IFS= read -r line; do \
		if [[ $$line = *" = "+([0-9a-fA-F]) ]]; then \
			print -ru5 "$$line"; \
		else \
			print -ru3 "$$line"; \
		fi; \
	    done <CKSUM; ${SUDO} rm -f CKSUM*; \
	    exec 3>&-; exec 5>&-; \
	    (cat <&4; cat <&6) | gzip -n9 >CKSUM.gz; \
	    dd if=/dev/zero bs=256 count=5 >>CKSUM.gz; \
	    flst=; for f in 0?-* NONFREE.TXT CKSUM.gz b_* gzsig* ?oot* ?sd* \
	    boot/grub/*; do [[ -e $$f ]] && flst="$$flst $$f"; done; \
	    ${SUDO} chown 0:0 . $$flst; \
	    for f in $$flst .; do if [[ -d $$f ]]; then \
		${SUDO} chmod 555 $$f; else ${SUDO} chmod 444 $$f; fi; \
	    done; \
	    ${SUDO} ${MKSH} ${.CURDIR}/mklocatedb.sh ${REALOBJDIR}/${IMAGE}
	(gzip -d <${WRKDIR}/CKSUM.gz | fgrep -v stand/locate.database; \
	    cd ${WRKDIR}; cksum -a cksum -a rmd160 -a tiger \
	    stand/locate.database) >tempdir/CKSUM
	cd ${WRKDIR}; \
	    sort -k3 |& exec 3>&p; exec 4<&p; \
	    sort |& exec 5>&p; exec 6<&p; \
	    while IFS= read -r line; do \
		if [[ $$line = *" = "+([0-9a-fA-F]) ]]; then \
			print -ru5 "$$line"; \
		else \
			print -ru3 "$$line"; \
		fi; \
	    done <${REALOBJDIR}/tempdir/CKSUM; \
	    exec 3>&-; exec 5>&-; \
	    ( (cat <&4; cat <&6) | gzip -n9; \
	      dd if=/dev/zero bs=256 count=5 2>&- ) | \
	    ${SUDO} dd of=CKSUM.gz
	dd if=/dev/arandom bs=2048 count=1 of=b_torito.ldr
	${SUDO} makefs -t cd9660 -o "$$(print -r -- ${CDROM_OPTS} | \
	    tr ' ~' ', ')" ${CDROM} ${WRKDIR}
	${SUDO} chown $$(id -u) ${CDROM} ${WRKDIR}
	chmod 755 ${WRKDIR}
	# pad the ISO with ]0;256K] NUL bytes, ie. for
	# a geometry of 16 heads, 32 sectors per track
	dd if=/dev/zero count=1 bs=$$((# (512 * 32 * 16) - \
	    ($$(stat -f %z ${CDROM}) % (512 * 32 * 16)) )) 2>&- >>${CDROM}
	getextent_cd9660 -f ${CDROM} b_i386.ldr | \
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh -B 11 | \
	    dd of=${CDROM} conv=notrunc bs=2048 seek=$$(getextent_cd9660 \
	    -f ${CDROM} -b '$$BootImage$$') 2>/dev/null
.if ${DUALIVE:L} == "no"
	getextent_cd9660 -f ${CDROM} b_i386.ldr | \
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh \
	    -g $$((#$$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
	    -A -M 4:0x96 -S 2 | \
	    dd of=${CDROM} conv=notrunc bs=512 2>/dev/null
.else
	getextent_cd9660 -f ${CDROM} b_i386.ldr | \
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh -A -S 2 | \
	    dd of=${CDROM} conv=notrunc bs=512 seek=${CHAINSECTOR} 2>/dev/null
	getextent_cd9660 -f ${CDROM} b_sparc.ldr | \
	    ${MKSH} ${WRKDIR}/v${OSrev}/sparc/bootxx.sh \
	    -g $$((#$$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
	    -0 ${CHAINSECTOR} -S 2 | \
	    dd of=${CDROM} conv=notrunc 2>/dev/null
.endif

clean cleandir cleannobsd: cleanworkdir unconfig
	-rm -f ${CDROM}* bsd{,.gz,.tmp} ${IMAGE}
	-rm -rf tempdir

cleanworkdir:
	-test ! -e ${WRKDIR} || ${SUDO} rm -rf ${WRKDIR}

tstmnt:
	${SUDO} mkdir -p ${TMPMOUNT}
	${SUDO} vnconfig svnd0 ${CDROM}
	${SUDO} mount_cd9660 /dev/svnd0a ${TMPMOUNT}

tstumnt: unconfig

unconfig:
	-${SUDO} umount -f ${VND_DEV}
	-${SUDO} vnconfig -u ${VND}
	-${SUDO} rm -rf ${TMPMOUNT}

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.72
log
@don‚Äôt forget adding the source of the GPL‚Äôd parts to the baselive image
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.69 2017/01/29 00:51:02 tg Exp $
d64 2
a65 2
CDROM_OPTS+=	preparer=MirBSD_and_its_contributors
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2018_The_MirOS_Project
@


1.71
log
@reconfirm -xzphf but add -M lncp
@
text
@d165 6
@


1.70
log
@2018
@
text
@d117 1
a117 1
	cd ${WRKDIR} && ${SUDO} tar xzphf ${STUFFDIR}/${_i}${OSrev}.ngz
@


1.69
log
@2017
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.67 2015/01/02 13:54:15 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2017_The_MirOS_Project
@


1.68
log
@2016
@
text
@d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2016_The_MirOS_Project
@


1.67
log
@2015; another year of the rolling release (and yes, new snapshots will be coming soonish)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.66 2014/01/04 20:24:56 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2015_The_MirOS_Project
@


1.66
log
@2014
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.65 2013/01/01 17:31:01 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2014_The_MirOS_Project
@


1.65
log
@2013
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.64 2012/01/05 09:49:04 bsiegert Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2013_The_MirOS_Project
@


1.64
log
@bump (c) to 2012
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.63 2011/01/03 17:49:39 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2012_The_MirOS_Project
@


1.63
log
@2011
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.62 2010/08/06 15:40:00 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2011_The_MirOS_Project
@


1.62
log
@I promised ¬´Jordan_U:#grml¬ª our next version would have support for the
boot method via /boot/grub/loopback.cfg ‚Äì voil√† (untested)

In MirOS bsd4grml, all options except chaining to GRUB are available.
In MirOS bsd4me, the install and baselive images, only the standard
bootloader prompt going to the installer is available, although the
command line gives support for e.g. switching to serial console.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.61 2010/01/06 18:52:23 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2010_The_MirOS_Project
@


1.61
log
@welcome to Y2k01
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.60 2009/12/27 14:48:11 tg Exp $
d130 2
@


1.60
log
@cf. http://www.technovelty.org/linux/strip.html
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.59 2009/08/15 18:18:40 tg Exp $
d65 1
a65 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2009_The_MirOS_Project
@


1.59
log
@we'll need a /current/i386/ on the FrOSCon CD
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.58 2009/08/02 16:20:49 tg Exp $
d204 2
a205 1
					${SUDO} strip -g $$name && print; \
d210 1
a210 1
			${SUDO} strip -s $$name && print; \
@


1.58
log
@jupp11
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.57 2009/08/01 13:24:29 tg Exp $
d113 3
@


1.57
log
@clean up the hysterical raisin mess that the X11 dist set lists are,
some from us, some inherited from OgreBSD:
‚Ä¢ all /etc/** stuff is now in xetc*.ngz, no matter if constant or conffile
‚Ä¢ all fonts are in the new xfont*.ngz set
‚Ä¢ everything else is either in xbase*.ngz or (regular+DMX, nested+VFB,
  print) server stuff in xserv*.ngz (renamed from xsrv*.ngz)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.56 2009/06/29 19:43:32 tg Exp $
d161 2
a162 2
	    ${MKSH} ${BSDSRCDIR}/contrib/code/jupp/configure \
	    --prefix=/usr --sysconfdir=/etc --disable-dependency-tracking && \
@


1.56
log
@better safe than sorry, use unsigned arithmetics (2G vs 4G ISOs, etc.)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.55 2009/06/29 17:35:01 tg Exp $
d113 1
a113 1
.for _i in base dev etc gnu xbase xetc xsrv
@


1.55
log
@gna, ARGS vs FLAGS again
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.54 2009/06/29 17:08:28 tg Exp $
d225 1
a225 1
	fi; ofs=$$((0x$${dump[i+1]})); \
d325 1
a325 1
	dd if=/dev/zero count=1 bs=$$(( (512 * 32 * 16) - \
d334 1
a334 1
	    -g $$(($$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
d343 1
a343 1
	    -g $$(($$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
@


1.54
log
@pad ISOs manually (without makefs(8)' help) to the correct geometry
not by „Äådd conv=osync„Äç or truncating after makefs had padded, but
by telling makefs to not pad, calculating the missing amount of NUL
bytes ourselves, and simply appending them (faster than osync)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.53 2009/06/29 16:46:36 tg Exp $
d231 3
a233 3
	    ${MAKE} ${LIVEBOOT_FLAGS} depend && \
	    ${MAKE} ${LIVEBOOT_FLAGS} clean && \
	    exec ${MAKE} ${LIVEBOOT_FLAGS}
@


1.53
log
@on non-DuaLive‚Ñ¢ MirOS Live CDs, provide a partition the size of the ISO,
so that we don‚Äôt waste the rest of the USB stick it‚Äôs dd(1)d upon; idea
from mika@@grml.org
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.52 2009/06/07 13:13:17 tg Exp $
a55 5
.if ${DUALIVE:L} != "no"
# no need as long as it's < 300 KiB and makefs -o no-trailing-padding isn't used
#CDROM_PAD?=	16 * 32
.endif
CDROM_PAD?=	1
d63 1
d320 2
a321 2
	    tr ' ~' ', ')" ${CDROM}~ ${WRKDIR}
	${SUDO} chown $$(id -u) ${CDROM}~ ${WRKDIR}
d323 4
a326 6
.if ${CDROM_PAD} == 1
	mv ${CDROM}~ ${CDROM}
.else
	dd if=${CDROM}~ of=${CDROM} obs=$$((${CDROM_PAD} * 512)) conv=osync
	${SUDO} rm -f ${CDROM}~
.endif
@


1.52
log
@use bxinst.i386 -A option for ISOs HDD boot function
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.51 2009/04/16 13:20:22 tg Exp $
d339 3
a341 1
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh -A -S 2 | \
@


1.51
log
@‚Ä¢ make use of the imbedded patch area to note the file(!) offset of
  the __defkernel patch field (and with possible future extensions)
‚Ä¢ strip /usr/mdec/boot now by default ‚ò∫
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.50 2009/02/02 22:58:12 tg Exp $
d339 1
a339 1
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh -S 2 | \
d343 1
a343 1
	    ${MKSH} ${WRKDIR}/v${OSrev}/i386/bootxx.sh -S 2 | \
@


1.50
log
@wtf we have a live cd!
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.49 2009/02/02 10:45:58 tg Exp $
d224 6
a229 10
	set -A sect_text -- $$(objdump -wh --target=a.out-sunos-big \
	    ${WRKDIR}/b_sparc.ldr | fgrep .text); \
	(( fofs_text = 0x$${sect_text[5]} )); \
	nm --target=a.out-sunos-big ${WRKDIR}/b_sparc.ldr |& \
	while read -p adr typ sym; do \
		[[ $$sym = @@(___defkernel|_start) ]] || continue; \
		eval typeset -i10 sym$$sym=0x\$$adr; \
	done; \
	typeset -Uui10 ofs; \
	(( ofs = sym___defkernel - sym_start + fofs_text )); \
a231 1
	${SUDO} strip --target=a.out-sunos-big ${WRKDIR}/b_sparc.ldr
@


1.49
log
@fix tinyirc compilation ‚Äì it‚Äôs a self-contained Makefile-in-.c-file now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.48 2009/01/18 19:26:35 tg Exp $
d72 3
d76 1
d114 3
d218 2
a243 4
.if ${GRML:L} != "no"
	${SUDO} cp /usr/mpkg/share/grub/stage2 ${WRKDIR}/grub.bin
	${SUDO} touch ${WRKDIR}/grub.cfg
.endif
d304 1
a304 1
	    grub*; do [[ -e $$f ]] && flst="$$flst $$f"; done; \
d306 3
a308 1
	    ${SUDO} chmod 444 $$flst; ${SUDO} chmod 555 .; \
@


1.48
log
@better file list
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.47 2009/01/18 19:24:36 tg Exp $
d162 2
a163 3
	    print 'PROG=tinyirc\nLDADD=-ltermcap\nNOMAN=yes\n.include' \
	    '<bsd.prog.mk>' >mkirc && make -f mkirc && \
	    ${SUDO} make -f mkirc install BINDIR=${WRKDIR}/usr/bin
@


1.47
log
@use /grub.bin and /grub.cfg from ports/sysutils/pxegrub
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.46 2009/01/17 12:21:00 tg Exp $
d299 4
a302 5
	    ${SUDO} chown 0:0 0?-* $$([[ ! -e NONFREE.TXT ]] || \
	    print NONFREE.TXT) CKSUM.gz b_* gzsig* ?oot* ?sd*; \
	    ${SUDO} chmod 444 0?-* $$([[ ! -e NONFREE.TXT ]] || \
	    print NONFREE.TXT) CKSUM.gz b_* gzsig* ?oot* ?sd*; \
	    ${SUDO} chown 0:0 .; ${SUDO} chmod 555 .; \
@


1.46
log
@2009
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.45 2009/01/17 12:18:23 tg Exp $
d236 4
@


1.45
log
@add grml, reserve boot.9 slot for grml too
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.44 2009/01/17 12:04:25 tg Exp $
d69 1
a69 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2008_The_MirOS_Project
@


1.44
log
@use ifdef to specify what CD we have
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.43 2009/01/17 11:58:37 tg Exp $
d11 5
d81 12
d119 4
a122 6
.if ${DUALIVE:L} != "no"
	cat ${TOPDIR}/common/boot.cfg.i386 ${.CURDIR}/boot.cfg.dual \
	    ${.CURDIR}/boot.cfg.tail | sudo dd of=${WRKDIR}/boot.cfg
.else
	cat ${TOPDIR}/common/boot.cfg.i386 ${.CURDIR}/boot.cfg.tail | \
	    sudo dd of=${WRKDIR}/boot.cfg
a123 1
	${SUDO} cp ${.CURDIR}/i386/boot.* ${WRKDIR}/
@


1.43
log
@make liveboot from here
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.42 2008/11/06 23:03:02 tg Exp $
d73 4
a196 2
#LIVEBOOT_ARGS+=	‚Ä¶

@


1.42
log
@xconsole(1) considered harmful!

Notwithstanding that, we do have a sort of working DuaLive CD now!
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.41 2008/11/01 02:07:46 tg Exp $
d21 1
a21 1
.if exists(${REALOBJDIR}/../../sys/arch/i386/stand/liveboot/boot)
d23 1
d193 2
d214 6
@


1.41
log
@place the gzsig(1) keys on the baselive CD too, not just installer CD
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.40 2008/10/31 23:43:44 tg Exp $
d56 1
@


1.40
log
@‚Ä¢ simplify DuaLive CD building
‚Ä¢ mention the CD type on more places
‚Ä¢ try to coerce makefs(8) to place bootloaders early
‚Ä¢ space: remove static libraries for which shared equivalents exist
‚Ä¢ handle v10/i386/CKSUM.gz gracefully
‚Ä¢ plug v10/sparc/CKSUM[.gz] if DuaLive
‚Ä¢ handle stand/locate.database checksumming
‚Ä¢ clean up mkisofs.log junk
‚Ä¢ remove statically linked stuff from /bin /sbin etc. and hard-link
  the dynamic variants from /usr/dbin and /usr/dsbin there, rm dbins
‚Ä¢ space: remove n≈çn-mirbsd linker scripts
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.39 2008/10/30 17:47:32 tg Exp $
d245 1
a245 1
	    cksum -a cksum -a rmd160 -a tiger 0* bsd b_* stand/* >>CKSUM
d270 1
a270 1
	    print NONFREE.TXT) CKSUM.gz b_* ?oot* ?sd*; \
d272 1
a272 1
	    print NONFREE.TXT) CKSUM.gz b_* ?oot* ?sd*; \
@


1.39
log
@improve padding scenarios:
‚Ä¢ as we do not use makefs(8) -o no-trailing-padding, an extra 300 KiB
  is *always* added (not padded) at the end of the ISO 9660 filesy-
  stem, thusly we can just truncate to a padding of 256 KiB
‚Ä¢ bigger padding (256 KiB ipv 64 KiB) reduces number of cylinders
‚Ä¢ no need to dd(1) if we can mv(1)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.38 2008/10/21 21:45:19 tg Exp $
d12 6
d81 6
d88 1
a88 1
	cd ${WRKDIR} && ${SUDO} tar xzphf ${BSDRELDIR}/rel/${_i}${OSrev}.ngz
d90 1
a90 1
	cd ${BSDRELDIR}/rel && pax -rw . ${WRKDIR}/v${OSrev}/i386/
d96 4
d102 1
d160 3
d164 1
d174 9
a182 1
			${SUDO} strip -g $$name && print; \
d213 5
d226 19
a244 1
	    done <v${OSrev}/i386/CKSUM >CKSUM; \
d246 1
a246 1
	-${SUDO} rm -f ${CDROM}*
d275 17
d323 1
a323 1
	-rm -f ${CDROM}* bsd{,.gz,.tmp} mkisofs.log ${IMAGE}
@


1.38
log
@unfortunately, this is about how far I get due to hitting an
assertion in makefs(8) the buggy pile of‚Ä¶ well, free software
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.37 2008/10/21 21:05:12 tg Exp $
d45 2
a46 1
CDROM_PAD?=	16 * 32
@


1.37
log
@speed up the common case
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.36 2008/10/21 21:03:32 tg Exp $
a181 1
	    ${SUDO} dd if=/dev/arandom bs=2048 count=1 of=b_torito.ldr; \
d200 2
d203 1
d212 1
a212 1
	    done <CKSUM; rm -f CKSUM; \
d216 4
a219 2
	    ${SUDO} chown 0:0 0?-* NONFREE.TXT CKSUM.gz ?oot* ?sd*; \
	    ${SUDO} chmod 444 0?-* NONFREE.TXT CKSUM.gz ?oot* ?sd*; \
d222 1
d226 1
a226 1
	${SUDO} chmod 755 ${WRKDIR}
@


1.36
log
@modernise, simplify
commit before testing (as backup)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.35 2008/10/05 16:26:16 tg Exp $
d220 1
a220 1
	${SUDO} chown $$(id -u) ${WRKDIR}
d222 3
d227 1
@


1.35
log
@use mksh realpath builtin instead of readlink -f for canonicalisation

note: there‚Äôs still a readlink(1) call left in, for instance, mirmake;
this does not hurt because we initially assumed that readlink(1) does
exist anyway and bundled ours just because some do not have the ‚Äò-f‚Äô
option for realpath(2)isation
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.34 2008/07/22 22:36:05 tg Exp $
d9 3
d14 3
a16 2
.if exists(${.CURDIR}/Makefile.${MACHINE})
.  include "${.CURDIR}/Makefile.${MACHINE}"
d18 4
d41 1
a41 3
INSTALLBOOT?=	${DESTDIR}/usr/mdec/installboot
BOOT?=		${DESTDIR}/usr/mdec/boot
BOOTXX?=	${DESTDIR}/usr/mdec/bootxx
d44 19
a62 3
CDROM_MDOPTS?=

BATCH?=		No
d68 1
a68 6
.if !target(it)
it:
	@@print -u2 The baselive cd infrastructure is not ready yet.
	@@print -u2 Please try again later.
	@@touch ${CDROM}
.endif
d70 1
a70 3
unpack: unpack-mi unpack-md

unpack-mi:
d73 1
a73 1
	mkdir -p ${WRKDIR}/v${OSrev}/${MACHINE}
d77 4
a80 1
	cd ${WRKDIR}/v${OSrev}/${MACHINE} && lndir ${BSDRELDIR}/rel
d83 1
a83 1
	cat ${TOPDIR}/common/boot.cfg.${MACHINE} ${.CURDIR}/boot.cfg.tail | \
d85 1
a85 2

unpack-md:
d132 1
a132 1
	cd ${WRKDIR} && MACHINE=${MACHINE} \
d142 3
d159 1
a159 1
makeimg: cdrom-prepare cdrom-mdcopy cdrom-generate cdrom-mdboot cdrom-finish
d163 17
d181 2
a182 1
	    ${SUDO} cp ${BOOT} boot.ldr; \
d191 4
a194 5
		print -r "$${one}v${OSrev}/${MACHINE}/$$two"; \
	    done <v${OSrev}/${MACHINE}/CKSUM >CKSUM; \
	    ${SUDO} touch boot.cat; \
	    cksum -a cksum -a rmd160 -a tiger 0* bsd boot.* stand/* >>CKSUM
	-${SUDO} rm -f ${WRKDIR}/boot.cat ${CDROM}
a200 5
	cd ${WRKDIR}; if [[ -e loot ]]; then \
		${SUDO} chown $$(id -u) loot; \
		chmod u+w loot; \
		perl -pi -e 's/bsd/lsd/g; s/B(SD|(?i)oot)/L$$1/g' loot; \
	fi
d218 3
a220 7
	${SUDO} mkisofs -R -f -L -d -D -N -v -v ${CDROM_MDOPTS} \
	    -P 'The MirOS Project and its contributors' \
	    -p 'Copyright ¬© 2007-2008 Thorsten Glaser' \
	    -V 'MirOS #${OSrev} BSD/${MACHINE} Live CD' \
	    -volset "$$(uname -slm) Live" -sysid "MirOSBSD" \
	    -pad -o ${CDROM} ${WRKDIR} 2>&1 | tee mkisofs.log
	${SUDO} chown $$(id -u) ${CDROM} ${WRKDIR}
d222 20
a241 2

cdrom-finish:
d244 1
a244 1
	-rm -f ${CDROM} bsd{,.gz,.tmp} mkisofs.log ${IMAGE}
@


1.34
log
@‚Ä¶ and another bootlooter fix ‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.33 2008/07/22 21:56:12 tg Exp $
d6 1
a6 1
REALOBJDIR!=	readlink -nf ${.OBJDIR}
@


1.33
log
@more file permission issues
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.32 2008/07/22 21:44:48 tg Exp $
d164 1
a164 1
	cd ${WRKDIR}; if [[ -s loot ]]; then \
d167 1
a167 1
		perl -pi -e 's/bsd/lsd/g; s/B(SD|(?i)oot)/L$1/g' loot; \
@


1.32
log
@make loot writable first
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.31 2008/07/22 21:31:38 tg Exp $
d182 2
a183 2
	    ${SUDO} chown 0:0 00-README CKSUM.gz ?oot* ?sd*; \
	    ${SUDO} chmod 444 00-README CKSUM.gz ?oot* ?sd*; \
@


1.31
log
@take care about loot and lsd permissions
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.30 2008/07/19 22:34:02 tg Exp $
d164 5
a168 2
	[[ ! -s ${WRKDIR}/loot ]] || \
	    perl -pi -e 's/bsd/lsd/g; s/B(SD|(?i)oot)/L$1/g' ${WRKDIR}/loot
@


1.30
log
@improve on looting ‚ò∫
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.29 2008/07/12 21:39:52 tg Exp $
d179 2
a180 2
	    ${SUDO} chown 0:0 00-README CKSUM.gz boot* bsd*; \
	    ${SUDO} chmod 444 00-README CKSUM.gz boot* bsd*; \
@


1.29
log
@improve snapshot and live cd generation again: adds new targets dist-ql[q]
and removes live cd generation from dist[-q] and Build.log; echo WRKDIR
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.28 2008/07/10 01:33:15 tg Exp $
d165 1
a165 1
	    perl -pi -e 's/MirBSD/MirLSD/; s/bsd/lsd/' ${WRKDIR}/loot
@


1.28
log
@automatise the creation of shared live(i386)+install(i386)+install(sparc)
CDs more
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.27 2008/07/09 23:57:21 tg Exp $
d161 1
@


1.27
log
@improve synchronised/manual i386+sparc snapshot generation
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.26 2008/06/13 19:58:34 tg Exp $
d163 2
@


1.26
log
@+xsrv
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.25 2008/03/21 04:48:21 tg Exp $
d40 2
d160 3
@


1.25
log
@one more 2007
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.24 2007/07/18 09:04:11 tg Exp $
d57 1
a57 1
.for _i in base dev etc gnu xbase xetc
@


1.24
log
@do the entropy-to-sector-0 dance BEFORE writing the disklabel,
I have no idea why but it sometimes seems to wreck it‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.23 2007/07/15 20:48:38 tg Exp $
d177 1
a177 1
	    -p 'Copyright ¬© 2007 Thorsten Glaser' \
@


1.23
log
@ah, I dÃ≤iÃ≤dÃ≤ miss that on the baselive cd, now I remember ‚ò∫
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.22 2007/07/11 16:08:55 tg Exp $
d76 2
a88 1
	${SUDO} dd if=/dev/arandom bs=512 count=1 of=$@@ conv=notrunc
@


1.22
log
@+--disable-dependency-tracking
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.21 2007/07/09 00:24:55 tg Exp $
d107 3
@


1.21
log
@check for contrib checkout and fix spelling
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.20 2007/06/08 11:40:20 tg Exp $
d101 1
a101 1
	    --prefix=/usr --sysconfdir=/etc && \
@


1.20
log
@speed up and make more reliable
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.19 2007/06/07 02:40:36 tg Exp $
d91 1
a91 1
		print -u2 Aborted: your checkout not complete; \
d95 1
a95 1
		print -u2 Aborted: your checkout not complete; \
@


1.19
log
@save time, don't strip files without debugging information
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.18 2007/05/25 23:08:56 tg Exp $
d60 1
a60 3
	cd ${WRKDIR}/v${OSrev}/${MACHINE} && for f in ${BSDRELDIR}/rel/*; do \
		ln -s $$f; \
	done
@


1.18
log
@what did I say about two days ago's typo of the day again?
sync with recent distrib/common/* changes
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.17 2007/03/09 11:31:49 tg Exp $
d124 1
d133 1
@


1.17
log
@use a combination of a CRC and two hashes from different families to
checksum the dist sets (ISO 8802-3: 1989 cksum, RIPEMD-160, TIGER) -
now we ‚Äúonly‚Äù need to fix gzsig(1) and the MirPorts pkgtools‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.16 2007/02/20 00:26:35 tg Exp $
d89 1
@


1.16
log
@more reality
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.15 2007/01/30 22:42:05 tg Exp $
d138 10
a147 3
	    ${SUDO} rm -f RMD160*; \
	    sed 's!RMD160 (!&v${OSrev}/${MACHINE}/!' \
	    <v${OSrev}/${MACHINE}/RMD160 >RMD160; \
d149 1
a149 1
	    rmd160 0* bsd boot.* stand/* >>RMD160
d154 14
a167 5
	    sort -uo RMD160 RMD160; \
	    gzip -n9 RMD160; \
	    dd if=/dev/zero count=2 >>RMD160.gz; \
	    ${SUDO} chown 0:0 00-README RMD160.gz boot* bsd*; \
	    ${SUDO} chmod 444 00-README RMD160.gz boot* bsd*; \
@


1.15
log
@we're in 2007 and use UTF-8, except for pre-OS things
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.14 2006/12/20 17:58:28 tg Exp $
d142 1
a142 1
	    rmd160 00-README bsd boot.* stand/* >>RMD160
@


1.14
log
@add a "declaration where you can find source code", especially
for third-party stuff (e.g. Live CD with preinstalled GPL stuff),
and for preinstalled non-free material (first line of /NONFREE.TXT
shall con- tain a list of all of them, then descriptions), etc.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.13 2006/11/17 03:05:13 tg Exp $
d156 1
a156 1
	    -p 'Copyright © 2006 Thorsten Glaser' \
@


1.13
log
@experimental: in jupp, too, set the default charset for files to utf-8,
regardless of current locale (MirOS live CD only, not the port)

ed and vi use a simple pass-through, but all you get on MirOS anyway
are ascii ("C") and utf-8; other encodings may not work well any more
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.12 2006/10/29 16:49:21 tg Exp $
d64 1
a64 1
	cp ${TOPDIR}/common/00-README ${WRKDIR}/
@


1.12
log
@try and fix some of the perms on the live cd
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.11 2006/10/16 19:27:50 tg Exp $
d100 1
a100 1
	cd tempdir; CC=${CC:Q} CFLAGS=${CFLAGS:Q}\ ${COPTS:Q} \
@


1.11
log
@not using -r but -R causes trouble with permissions sometimes;
try to make better ones at least temporarily
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.10 2006/10/14 23:18:30 tg Exp $
d73 1
d150 2
a151 2
	    ${SUDO} chown 0:0 00-README RMD160.gz; \
	    ${SUDO} chmod 444 00-README RMD160.gz; \
@


1.10
log
@unconfig shouldn't clobber ../common/ stuff
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.9 2006/10/13 19:18:02 tg Exp $
d56 1
a56 1
	mkdir -p ${WRKDIR}/v${OSrev}
d60 4
a63 1
	cd ${WRKDIR}/v${OSrev} && ln -s ${BSDRELDIR}/rel ${MACHINE}
d135 8
a142 5
	${SUDO} cp ${BOOT} ${WRKDIR}/boot.ldr
	cd ${WRKDIR}; sed 's!RMD160 (!&v${OSrev}/${MACHINE}/!' \
	    <v${OSrev}/${MACHINE}/RMD160 >RMD160; ${SUDO} touch boot.cat
	cd ${WRKDIR}; rmd160 00-README bsd boot.* stand/* >>RMD160
	-${SUDO} rm -f ${WRKDIR}/boot.cat ${CDROM} ${WRKDIR}/RMD160.gz
d145 8
a152 5
	cd ${WRKDIR}; sort -uo RMD160 RMD160; gzip -n9 RMD160
	# pad for gzsig(1) application later on
	dd if=/dev/zero count=2 >>${WRKDIR}/RMD160.gz
	cd ${WRKDIR} && ${SUDO} ${MKSH} ${.CURDIR}/mklocatedb.sh \
	    ${REALOBJDIR}/${IMAGE}
d159 2
a160 1
	${SUDO} chown $$(id -u) ${CDROM}
@


1.9
log
@move /etc/boot.cfg and friends to /
agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.8 2006/10/02 22:38:13 tg Exp $
d54 1
a54 1
	test ! -e ${TMPMOUNT} || (cd ${TOPDIR}/common; ${MAKE} unconfig)
d68 1
a68 2
	test ! -e ${TMPMOUNT} || (cd ${TOPDIR}/common; ${MAKE} unconfig)
	${SUDO} rm -rf ${TMPMOUNT}
d154 1
a154 1
clean cleandir cleannobsd: cleanworkdir tstumnt
d166 6
a171 2
tstumnt:
	test ! -e ${TMPMOUNT} || (cd ${TOPDIR}/common; ${MAKE} unconfig)
@


1.8
log
@fix up and (on i386) enable the baselive CD; still not installer-augmented
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.7 2006/10/02 07:08:10 tg Exp $
d63 1
a63 1
	    sudo dd of=${WRKDIR}/etc/boot.cfg
d133 1
a133 1
	${SUDO} cp ${BOOT} ${WRKDIR}/etc/boot.ldr
d135 3
a137 3
	    <v${OSrev}/${MACHINE}/RMD160 >RMD160; ${SUDO} touch etc/boot.cat
	cd ${WRKDIR}; rmd160 00-README bsd etc/boot.* stand/* >>RMD160
	-${SUDO} rm -f ${WRKDIR}/etc/boot.cat ${CDROM} ${WRKDIR}/RMD160.gz
@


1.7
log
@fix clean target
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.6 2006/10/02 07:03:16 tg Exp $
d9 2
d42 1
a42 1
it: ${CDROM}
d44 2
a45 4
.ifdef FINISHED_WORK
${CDROM}: unpack gendev addcontrib prepimg nukefiles makeimg
.else
${CDROM}:
d48 1
a48 1
	@@touch $@@
a66 2
gendev: ${IMAGE} bsd

d120 1
a120 1
	-for name in ${WRKDIR}/usr/lib/*@@(.so.*|.a); do \
d137 1
a137 1
	-${SUDO} rm -f ${WRKDIR}/etc/boot.cat ${CDROM}
@


1.6
log
@start bringing the live CD into shape
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.5 2006/08/19 19:06:04 tg Exp $
d157 1
a157 1
clean cleandir cleannobsd: cleanworkdir
d159 1
a159 1
	-rm -rf tempdir ${TMPMOUNT}
@


1.5
log
@start adding stuff from ../contrib/ towards a new structure live cd
@
text
@d1 1
a1 1
# $MirOS$
d140 2
a146 2

cdrom-generate:
d155 1
a155 9









d158 2
a159 2
	-rm -f ${CDROM} bsd{,.gz} mkisofs.log mr.fs rdsetroot
	-rm -rf tempdir tmpmnt
d162 1
a162 1
	-test ! -e workdir || ${SUDO} rm -rf workdir
d165 1
d167 1
a167 1
	${SUDO} mount_cd9660 /dev/svnd0a tmpmnt
d169 2
a170 1
tstumnt: unconfig
@


1.4
log
@new baselive infrastructure for top-level Makefile (designed to not break build)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.3 2006/08/18 22:32:40 tg Exp $
d5 2
d8 27
d36 1
a36 3
REALOBJDIR!=	readlink -nf ${.OBJDIR}

ANONCVSROOT=	anoncvs@@anoncvs.mirbsd.org:/cvs
d51 6
a56 2
unpack:
	mkdir -p workdir/v${OSrev}
d58 1
a58 1
	cd workdir && ${SUDO} tar xzphf ${BSDRELDIR}/rel/${_i}${OSrev}.ngz
d60 28
a87 19
	cd workdir && ln -sf ${TOPDIR}/common/00-README
	cd workdir/v${OSrev} && ln -s ${BSDRELDIR}/rel i386
	${SUDO} cp ${.CURDIR}/boot.* workdir/etc/

gendev: mr.fs

mr.fs:
	dd if=/dev/zero of=mr.fs bs=512 count=8192
	${SUDO} vnconfig -v -c svnd0 mr.fs
	${SUDO} disklabel -w -r svnd0 ipldisc
	${SUDO} newfs -m 0 -o space -c 16 -i 1024 /dev/rsvnd0a
	mkdir -p tmpmnt
	${SUDO} mount /dev/svnd0a tmpmnt
	${SUDO} cp workdir/dev/MAKEDEV tmpmnt/
	cd tmpmnt && ${SUDO} ${MKSH} MAKEDEV all
	@@${SUDO} dd if=/dev/arandom bs=512 count=4 of=tmpmnt/.rs
	@@df -i tmpmnt
	-${SUDO} umount tmpmnt
	-${SUDO} vnconfig -u svnd0
d99 1
a99 2
	targpath=$$(readlink -nf workdir); cd tempdir; \
	    CC=${CC:Q} CFLAGS=${CFLAGS:Q}\ ${COPTS:Q} \
d102 1
a102 1
	    make && ${SUDO} make install DESTDIR="$$targpath"
d106 1
a106 1
	    ${SUDO} make -f mkirc install BINDIR=../workdir/usr/bin
d109 1
a109 1
	cd workdir && MACHINE=${MACHINE} \
d112 6
a117 6
bsd.gz: ${REALOBJDIR}/../generic/bsd mr.fs
	-rm -f bsd bsd.gz
	gzip -d <${REALOBJDIR}/../generic/bsd >bsd
	print 'rootdev 6 0\nquit' | config -ef bsd	# (6,0) = cd0a
	${REALOBJDIR}/../common/elfrdsetroot bsd <mr.fs
	gzip -n9 bsd
d120 1
a120 1
	cd workdir && ${SUDO} rm -rf etc/X11 usr/{local/lib/X11,releng} \
d122 2
a123 2
	-for name in workdir/usr/lib/*@@(.so.*|.a); do \
		print -n stripping $$name ...; \
d131 10
a140 13
makeimg: bsd.gz mr.fs
	${SUDO} dd if=bsd.gz obs=2048 conv=osync of=workdir/bsd
	${SUDO} dd if=${BSDOBJDIR}/sys/arch/i386/stand/liveboot/boot \
	    obs=2048 conv=osync of=workdir/v${OSrev}/i386/boot.liv
	cd workdir/v${OSrev}/i386 && ${SUDO} cp boot.liv boot.iso
	sed 's!RMD160 (!&v${OSrev}/i386/!' <workdir/v${OSrev}/i386/RMD160 \
	    >workdir/RMD160
	touch workdir/boot.cat
	cd workdir && rmd160 00-README boot.cat bsd stand/fsrw.cpio \
	    tftpboot/bsd tftpboot/pxeboot v${OSrev}/i386/boot.iso \
	    v${OSrev}/i386/boot.liv >>RMD160
	rm -f workdir/boot.cat
	cd workdir; rm -f boot.cat; sort -uo RMD160 RMD160; gzip -n9 RMD160
d142 9
a150 9
	dd if=/dev/zero count=2 >>workdir/RMD160.gz
	-rm -f ${CDROM}
	cd workdir && ${SUDO} ${MKSH} ${.CURDIR}/mklocatedb.sh \
	    ${REALOBJDIR}/mr.fs
	touch ${CDROM}
	${SUDO} mkisofs -R -L -d -D -N -v -v -f \
	    -b v${OSrev}/i386/boot.iso -c boot.cat -p "Thorsten Glaser" \
	    -P "The http://MirBSD.de/ team and its contributors" \
	    -V "MirOS #${OSrev} BSD/${MACHINE} Live CD" \
d152 11
a162 13
	    -no-emul-boot -boot-load-size 4 -boot-info-table \
	    -pad -o ${CDROM} workdir 2>&1 | tee mkisofs.log
	workdir/usr/mdec/installboot -v -I \
	    $$(fgrep 'workdir/v${OSrev}/i386/boot.liv' mkisofs.log | \
		while read start end rest; do print $$start $$end; done) \
	    workdir/usr/mdec/bootxx ${CDROM}

rdsetroot: ${TOPDIR}/common/elfrdsetroot.c
	${HOSTCC} ${HOSTCFLAGS} -DDEBUG -o $@@ ${.ALLSRC}

unconfig:
	-${SUDO} umount -f /dev/svnd0a
	-${SUDO} vnconfig -u svnd0
a163 2
.PHONY:	addcontrib clean cleandir cleannobsd cleanworkdir \
	gendev it makeimg nukefiles prepimg tstmnt tstumnt unconfig unpack
@


1.3
log
@continue sanitising (still not complete, i386-md, no makefs)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.2 2006/08/18 22:18:24 tg Exp $
d15 1
d17 6
d50 1
a50 1
	if [[ ! -s ${BSDSRCDIR}/contrib/code/jupp/jupprc ]]; then \
d54 1
a54 1
	if [[ ! -s ${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c ]]; then \
@


1.2
log
@start sanitising
@
text
@d1 1
a1 1
# $MirOS: src/distrib/baselive/Makefile,v 1.1 2006/08/17 19:58:00 tg Exp $
d5 1
a7 1
HOSTCFLAGS?=	${CFLAGS} ${COPTS}
d22 1
a22 1
	cd workdir && ln -s ${.CURDIR}/../../ramdisk/00-README
d36 2
a37 2
	cd tmpmnt && ${SUDO} ${MKSH} ./MAKEDEV all
	@@${SUDO} dd if=/dev/arandom bs=512 count=8 of=tmpmnt/.rs
d42 4
a45 31
addcontrib: addjupp addtinyirc

addjupp:
	mkdir -p tempdir/jupp
	@@if [[ -s ${BSDSRCDIR}/contrib/code/jupp/jupprc ]]; then \
		cd tempdir/jupp; \
		lndir ${BSDSRCDIR}/contrib/code/jupp; \
	else \
		cd tempdir; \
		cvs -Rqz3 -d ${ANONCVSROOT} co \
		    -PAdjupp contrib/code/jupp || rm -rf jupp; \
	fi
	@@if [[ -d tempdir/jupp ]]; then \
		targpath=$$(readlink -nf workdir); \
		cd tempdir/jupp; \
		CC=${CC:Q} CFLAGS=${CFLAGS:Q}\ ${COPTS:Q} ${MKSH} \
		    ./configure --prefix=/usr --sysconfdir=/etc; \
		make; \
		${SUDO} make install DESTDIR="$$targpath"; \
	fi

addtinyirc:
	mkdir -p tempdir/tinyirc
	@@if [[ -s ${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c ]]; then \
		cd tempdir/tinyirc; \
		lndir ${BSDSRCDIR}/contrib/code/Snippets; \
	else \
		cd tempdir; \
		cvs -Rqz3 -d ${ANONCVSROOT} co \
		    -PAdtinyirc contrib/code/Snippets/tinyirc.c \
		    || rm -rf tinyirc; \
d47 3
a49 7
	@@if [[ -s tempdir/tinyirc/tinyirc.c ]]; then \
		targpath=$$(readlink -nf workdir); \
		cd tempdir/tinyirc; \
		${CC} ${CFLAGS} ${COPTS} ${CPPFLAGS} ${LDFLAGS} \
		    ${LDSTATIC} tinyirc.c -ltermcap; \
		${SUDO} install -c -s -o root -g bin -m 555 a.out \
		    $$targpath/usr/bin/tinyirc; \
d51 10
d63 2
a64 1
	cd workdir && ${SUDO} mksh ${.CURDIR}/munge_it.sh
d66 1
a66 1
bsd.gz: ${REALOBJDIR}/../generic/bsd mr.fs rdsetroot
d70 1
a70 1
	./rdsetroot bsd <mr.fs
a73 2
#	cd workdir && ${SUDO} rm -rf etc/X11 usr/{local/lib/X11,releng} \
#	    usr/{,X11R6/,share/}{doc,info,man} usr/X11R6/lib/X11/doc
d116 1
a116 1
rdsetroot:	${.CURDIR}/../../common/elfrdsetroot.c
d123 1
a123 1
.PHONY:	addcontrib addjupp addtinyirc clean cleandir cleannobsd cleanworkdir \
@


1.1
log
@* new Makefile structure
* move i386/livecd into baselive/ and sub-directory-structure appropriately
* rid unneeded files
* ifdef out build of rescue tools not needed on certain arches
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/livecd/Makefile,v 1.52 2006/08/16 18:46:13 tg Exp $
a19 1
#.for _i in base dev etc gnu ports xbase xetc
a24 2
#	# create mount points
#	${SUDO} mkdir workdir/usr/{mpkg,ports/{Distfiles,Packages}}
@

