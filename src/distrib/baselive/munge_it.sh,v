head	1.52;
access;
symbols
	MIRBSD_10:1.30.0.2
	MIRBSD_10_BASE:1.30;
locks; strict;
comment	@# @;


1.52
date	2018.12.15.05.25.51;	author tg;	state Exp;
branches;
next	1.51;
commitid	1005C14906A53002C9A;

1.51
date	2018.12.13.18.12.15;	author tg;	state Exp;
branches;
next	1.50;
commitid	1005C12A10B3689CD74;

1.50
date	2014.11.16.12.16.27;	author tg;	state Exp;
branches;
next	1.49;
commitid	100546895A24DE6792D;

1.49
date	2013.11.30.13.45.21;	author tg;	state Exp;
branches;
next	1.48;
commitid	1005299EBBC46543D75;

1.48
date	2013.09.28.19.55.15;	author tg;	state Exp;
branches;
next	1.47;
commitid	100524733DE1CEE6C8A;

1.47
date	2013.09.11.18.47.18;	author tg;	state Exp;
branches;
next	1.46;
commitid	1005230BAC403ABD4CD;

1.46
date	2009.03.29.13.04.12;	author tg;	state Exp;
branches;
next	1.45;
commitid	10049CF71B654F9EF54;

1.45
date	2009.02.02.22.31.20;	author tg;	state Exp;
branches;
next	1.44;
commitid	1004987744D2B64E6F1;

1.44
date	2008.11.29.17.10.53;	author tg;	state Exp;
branches;
next	1.43;
commitid	1004931774A5E826660;

1.43
date	2008.11.01.02.07.46;	author tg;	state Exp;
branches;
next	1.42;
commitid	100490BB9FC06892FFE;

1.42
date	2008.10.31.23.43.45;	author tg;	state Exp;
branches;
next	1.41;
commitid	100490B97B834F774AE;

1.41
date	2008.10.31.22.35.09;	author tg;	state Exp;
branches;
next	1.40;
commitid	100490B882C64012C66;

1.40
date	2008.10.31.02.37.16;	author tg;	state Exp;
branches;
next	1.39;
commitid	100490A6F6411686B6B;

1.39
date	2008.10.21.21.03.33;	author tg;	state Exp;
branches;
next	1.38;
commitid	10048FE43B158335A05;

1.38
date	2008.10.05.16.26.16;	author tg;	state Exp;
branches;
next	1.37;
commitid	10048E8EA7D6EAD401E;

1.37
date	2008.07.22.19.48.47;	author tg;	state Exp;
branches;
next	1.36;
commitid	100488639AD10D1E636;

1.36
date	2008.07.19.22.06.03;	author tg;	state Exp;
branches;
next	1.35;
commitid	100488265606553463A;

1.35
date	2008.07.09.23.32.01;	author tg;	state Exp;
branches;
next	1.34;
commitid	10048754A823D6E24B9;

1.34
date	2008.07.07.13.57.13;	author tg;	state Exp;
branches;
next	1.33;
commitid	100487220B36BA627AC;

1.33
date	2008.06.11.10.17.43;	author tg;	state Exp;
branches;
next	1.32;
commitid	100484FA64F46FE434C;

1.32
date	2008.05.13.12.14.29;	author tg;	state Exp;
branches;
next	1.31;
commitid	1004829863225D9AA36;

1.31
date	2008.05.13.11.49.02;	author tg;	state Exp;
branches;
next	1.30;
commitid	1004829802069699414;

1.30
date	2008.03.04.23.48.58;	author tg;	state Exp;
branches
	1.30.2.1;
next	1.29;
commitid	10047CDDF93661C0E2E;

1.29
date	2007.09.28.22.54.07;	author tg;	state Exp;
branches;
next	1.28;
commitid	10046FD8626212580F2;

1.28
date	2007.09.28.20.46.53;	author tg;	state Exp;
branches;
next	1.27;
commitid	10046FD684B204757B3;

1.27
date	2007.09.02.16.43.51;	author tg;	state Exp;
branches;
next	1.26;
commitid	10046DAE841690ACB34;

1.26
date	2007.08.12.13.59.36;	author tg;	state Exp;
branches;
next	1.25;
commitid	10046BF124C3829B226;

1.25
date	2007.07.24.09.21.55;	author tg;	state Exp;
branches;
next	1.24;
commitid	10046A5C4BE60A7AC60;

1.24
date	2007.07.14.15.44.25;	author tg;	state Exp;
branches;
next	1.23;
commitid	1004698EF662CE4E41B;

1.23
date	2007.06.30.02.47.41;	author tg;	state Exp;
branches;
next	1.22;
commitid	1004685C4315376C585;

1.22
date	2007.06.04.08.36.36;	author tg;	state Exp;
branches;
next	1.21;
commitid	1004663CEF86900A583;

1.21
date	2007.05.25.23.08.56;	author tg;	state Exp;
branches;
next	1.20;
commitid	10046576C8D33E14024;

1.20
date	2007.03.26.17.57.06;	author tg;	state Exp;
branches;
next	1.19;
commitid	100460809891D334527;

1.19
date	2007.02.20.01.38.20;	author tg;	state Exp;
branches;
next	1.18;
commitid	10045DA51232B3946A2;

1.18
date	2007.02.20.01.09.34;	author tg;	state Exp;
branches;
next	1.17;
commitid	10045DA49EE6CEB0C8A;

1.17
date	2007.02.20.00.57.32;	author tg;	state Exp;
branches;
next	1.16;
commitid	10045DA477F65AC3879;

1.16
date	2007.02.20.00.04.00;	author tg;	state Exp;
branches;
next	1.15;
commitid	10045DA3B075882B21D;

1.15
date	2006.11.01.00.27.21;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004547E9EA5EFD8589;

1.14
date	2006.10.29.17.02.54;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004544DECA5319F7FF;

1.13
date	2006.10.29.16.49.21;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004544DBA1435EA341;

1.12
date	2006.10.02.22.38.13;	author tg;	state Exp;
branches;
next	1.11;
commitid	100452194D0378AE099;

1.11
date	2006.10.02.07.09.14;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004520BB2A1CED5007;

1.10
date	2006.10.02.07.03.17;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004520B9C458C2C177;

1.9
date	2006.09.30.21.02.24;	author tg;	state Exp;
branches;
next	1.8;
commitid	100451EDB6E424CBBC6;

1.8
date	2006.09.30.20.59.00;	author tg;	state Exp;
branches;
next	1.7;
commitid	100451EDAA579D5615D;

1.7
date	2006.09.13.01.08.21;	author tg;	state Exp;
branches;
next	1.6;
commitid	100450759BA548292F2;

1.6
date	2006.08.22.21.51.40;	author tg;	state Exp;
branches;
next	1.5;
commitid	10044EB7C746813A3BA;

1.5
date	2006.08.19.01.37.50;	author tg;	state Exp;
branches;
next	1.4;
commitid	10044E66B6161B26B9A;

1.4
date	2006.08.19.01.29.15;	author tg;	state Exp;
branches;
next	1.3;
commitid	10044E6696F4065192C;

1.3
date	2006.08.19.01.02.20;	author tg;	state Exp;
branches;
next	1.2;
commitid	10044E6632809521B98;

1.2
date	2006.08.18.22.18.25;	author tg;	state Exp;
branches;
next	1.1;
commitid	10044E63CC77F985A26;

1.1
date	2006.08.17.19.58.00;	author tg;	state Exp;
branches;
next	;
commitid	10044E4CA2D0E8EFBD4;

1.30.2.1
date	2008.07.14.12.43.18;	author tg;	state Exp;
branches;
next	;
commitid	100487B49F66A33F1A5;


desc
@@


1.52
log
@if likely under Qemu user networking, try to SNTP from wirt
@
text
@#!/bin/mksh
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.50 2014/11/16 12:16:27 tg Exp $
#-
# Copyright (c) 2006, 2007, 2008, 2013, 2014, 2018
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# Patch a freshly unpacked MirOS installation into the standard base
# system generated live CD distribution.

set -ex
myplace=$(realpath "$0/..")

ed -s etc/X11/XF86Config <<-'EOF'
	/FontPath.*local/s/^/#/
	/FontPath.*100dpi.*unscaled/s/^/#/
	/FontPath.*Speedo/s/^/#/
	/FontPath.*Type1/s/^/#/
	/FontPath.*/s/^/#/
	/FontPath.*100dpi/s/^/#/
	/FontPath.*cyrillic/s/^/#/
	/FontPath.*OTF/s/^/#/
	wq
EOF
ed -s etc/X11/xdm/Xresources <<-'EOMD'
	/^xlogin.greeting:/s/CLIENTHOST/the MirOS BSD Live CD/
	/-100-100-/s//-75-75-/
	/^Chooser.label.label:/s/CLIENTHOST/Live-CD/
	wq
EOMD
cat >>etc/exports <<-'EOMD'
	/ -ro -maproot=root
EOMD
ed -s etc/group <<-'EOMD'
	/^wheel:/s/$/,live/
	/^operator:/s/$/,live/
	/^wsrc:/s/$/live/
	/^staff:/s/$/,live/
	/^www:/s/$/live/
	/^dialer:/s/$/live/
	/^audio:/s/$/live/
	/^nobody:/i
		live:*:32762:
	.
	wq
EOMD
ed -s etc/inetd.conf <<-'EOMD'
	%g/^.tftp/s/^.//
	%g!/tftpboot!s!!/var&!
	wq
EOMD
ed -s etc/master.passwd <<-'EOMD'
	/^nobody:/i
		live:$2a$04$NCMhVFfIg3afYRXLCDGjcOPYJxem4lxSLcthQT5AaejUaAAvIWdCW:32762:32762:staff:0:0:MirOS BSD Live CD User:/home/live:/bin/mksh
	.
	wq
EOMD
ed -s etc/rc <<-'EOMD'
	1i
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.50 2014/11/16 12:16:27 tg Exp $
	.
	/early munge point/d
	i
		mount -fwo async,noatime /dev/rd0a /dev
		cat /dev/.rs >/dev/urandom 2>&-
		# on sparc, use the nvram to provide some additional entropy
		# also read some stuff from the HDD etc. (doesn't matter if it breaks)
		( ( (for d in {w,s,rai,c}:128, f:1, r:1,512; do b=${d#*,}; d=${d%,*};\
		     dd if=/dev/r${d%:*}d0c count=${d#*:} ${b:+bs=$b of=/dev/urandom}\
		     ; done; dd if=/var/db/host.random of=/dev/urandom; dmesg; sysctl\
		     -a; eeprom) 2>&1 | cksum -a cksum -a sha512 -a suma -a tiger -a \
		     rmd160 -a adler32 -b >/dev/wrandom) &)
		(cd /dev; ln -s $(sysctl -n kern.root_device) root; rm -f .rs)
		print \#\\tMirOS BSD Live-CD/DVD/USB/CF/SD/HDD starting up...
	.
	/^raidctl.*all/s/^/#/
	/^umount/a
		mount -fwo async,noatime /dev/rd0a /dev >/dev/null 2>&1
	.
	/t nonfs/i
		print -n 'extracting mfs contents...'
		gzip -dc /stand/fsrw.dat | pax -r -pe
		print -n ' populating...'
		sleep 1
		cp -r etc/skel home/live
		chown -R 32762:32762 home/live
		[[ -s /stand/locate.database ]] && \
		    cp /stand/locate.database /var/db/locate.database
		wait
		print ' done'

	.
	/dmesg.boot/i

		# if this looks like Qemu, set the time from the host, maybe
		(x=$(/sbin/ifconfig -a)
		[[ $x != *'	address: 52:54:'* ||
		    $x != *'	inet 10.0.2.15 netmask 0xffffff00 '* ]] || \
		    /usr/sbin/rdate -sn 10.0.2.2 || :)

		# try to get some entropy from any attached Simtec EntropyKey
		[[ -x /usr/libexec/ekeyrng ]] && /usr/libexec/ekeyrng
		# try to get some entropy from the network
		(ulimit -T 60; exec /usr/bin/ftp -mvo /dev/urandom \
		    https://call.mirbsd.org/rn.cgi?live"<$(uname -a | sed '
			s/%/%25/g
			s/;/%3b/g
			s,/,%2f,g
			s/?/%3f/g
			s/:/%3a/g
			s/@@/%40/g
			s/&/%26/g
			s/=/%3d/g
			s/+/%2b/g
			s/\$/%24/g
			s/,/%2c/g
			s/ /%20/g
		    ')>,seed=$(dd if=/dev/arandom bs=57 count=1 2>&- | \
		    b64encode -r - | tr '+=/' '._-')" >/dev/wrandom 2>&1)
	.
	/openssl genrsa/s/4096/1024/
	wq
EOMD
ed -s etc/rc.securelevel <<-'EOMD'
	/^securelevel/s/1/-1/
	wq
EOMD
ed -s etc/sysctl.conf <<-'EOMD'
	/accept_rtadv/s/^.//
	/^.ddb.console/s/^.//
	/^.kern.seminfo.semmni/s/^.//
	/^.kern.seminfo.semmns/s/^.//
	/^.kern.seminfo.semmnu/s/^.//
	/^.kern.shminfo.shmall/s/^.//
	wq
EOMD
[[ $MACHINE = i386 ]] && ed -s etc/sysctl.conf <<-'EOMD'
	/^.machdep.allowaperture/s/^.//
	/^.machdep.kbdreset/s/^.//
	/^.kern.emul.linux/s/^.//
	/^.kern.emul.openbsd/s/^.//
	wq
EOMD
cp etc/ttys.dist etc/ttys
perl -p -i -e 's/MirOS ftp.1./MirOS LiveCD/' usr/bin/ftp
ed -s var/cron/tabs/root <<-'EOMD'
	/anacron/s/^/#/
	/daily/s/^/#/
	/weekly/s/^/#/
	/monthly/s/^/#/
	/randshuffle/s/^/#/
	/randomnumbers.info/s/^.//
	/fourmilab.ch/s/^.//
	/random.org/s/^.//
	wq
EOMD

install -c -o root -g staff -m 644 \
    $myplace/fstab etc/fstab
install -c -o root -g staff -m 644 \
    $myplace/$MACHINE/rc.conf.local etc/rc.conf.local
install -c -o root -g staff -m 644 \
    $myplace/$MACHINE/rc.netselect etc/rc.netselect
install -c -o root -g staff -m 644 \
    $myplace/rc.netselect.common etc/rc.netselect.common
install -c -o root -g staff -m 644 \
    $myplace/dot.xsession etc/skel/.xsession
install -c -o root -g bin -m 555 \
    $myplace/evilwm-session usr/local/bin/evilwm-session

(cd dev; mksh ./MAKEDEV std rd0a)
pwd_mkdb -pd $(realpath etc) master.passwd
( ( dd if=/dev/prandom bs=64 count=7; \
    dd if=/dev/arandom bs=64 count=56; \
    dd if=/dev/urandom bs=64 count=1; \
  ) 2>/dev/wrandom | dd of=var/db/host.random; \
    chown 0:0 var/db/host.random; \
    chmod 600 var/db/host.random) \
    >/dev/wrandom 2>&1

(cd usr/libdata/ldscripts; rm !(*mbsd*))

# sync with src/distrib/common/listend.i386-big
(saveIFS=$IFS
 tail -3 <usr/share/doc/README | grep '^key ' | \
    while IFS="	" read keynr keyfile; do
	IFS=" :"
	set -A keyno -- $keynr
	IFS=$saveIFS
	print -r -- $keyfile >gzsigkey.${keyno[1]}
done)

(cd usr/X11R6/lib/X11/fonts; rm -rf 100dpi OTF Speedo Type1 cyrillic local \
    misc/*-ISO8859-@@(1[013456]|[2345789]).* misc/*{KOI8,JISX0201}* \
    75dpi/*-ISO8859-@@(1[0345]|[2349]).* misc/{fonts.alias,gb,hang,jis,k14}*)
cp $myplace/misc_fonts.alias usr/X11R6/lib/X11/fonts/misc/fonts.alias
chown 0:0 usr/X11R6/lib/X11/fonts/misc/fonts.alias
chmod 444 usr/X11R6/lib/X11/fonts/misc/fonts.alias
(cd usr/X11R6/lib/X11/fonts/75dpi; mkfontdir)
(cd usr/X11R6/lib/X11/fonts/misc; mkfontdir)
(cd usr/X11R6/lib/X11; fc-cache -v .)

mv usr/X11R6/lib/X11/fonts usr/X11R6/lib/fonts
(cd usr/X11R6/lib/X11; ln -s ../fonts)
# tmp because of perms
find etc tmp usr/X11R6/lib/X11 var | sort | \
    cpio -oC512 -Hsv4crc -Mset | gzip -n9 >stand/fsrw.dat
rm -rf usr/X11R6/lib/X11 var sys
mkdir -p emul usr/X11R6/lib/X11 usr/mpkg usr/ports var
chown 0:0 emul var

exit 0
@


1.51
log
@begin updating

(the random hostname thingy could just use arandom directly)
@
text
@d4 2
a5 2
# Copyright (c) 2006, 2007, 2008, 2013, 2014
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.de>
d109 6
@


1.50
log
@mydir=$(realpath "$0/..") # mksh is cool like that, no dirname needed
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.49 2013/11/30 13:45:21 tg Exp $
a71 7
ed -s etc/ntpd.conf <<-'EOMD'
	/^.server /d
	i
		server ntp.mirbsd.org
	.
	wq
EOMD
d74 1
a74 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.49 2013/11/30 13:45:21 tg Exp $
@


1.49
log
@$(dirname "$(realpath "$0")") allows users to symlink-install scripts
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.48 2013/09/28 19:55:15 tg Exp $
d4 1
a4 1
# Copyright (c) 2006, 2007, 2008, 2013
d26 1
a26 1
myplace=$(dirname "$(realpath "$0")")
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.48 2013/09/28 19:55:15 tg Exp $
@


1.48
log
@ITIMER_PROF is driven from hardintr, not rtcintr, what a shame!
with this cprng(8) brings virtually no entropy but at pretty high
CPU cost nevertheless (I never liked it much, anyway…) so rid it
(think about adding jytter later)

basically we’ll need something that signals us at stathz intervals
(or profhz), for this to work
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.47 2013/09/11 18:47:18 tg Exp $
d26 1
a26 1
myplace=$(realpath $(dirname "$0"))
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.47 2013/09/11 18:47:18 tg Exp $
@


1.47
log
@ekeyrng (kludge) on baselive, too (moarrr entropy!)
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.46 2009/03/29 13:04:12 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.46 2009/03/29 13:04:12 tg Exp $
d83 1
a83 1
	/cprng.*pr16/d
a93 1
		/usr/libexec/cprng -pr32 >/dev/urandom &
@


1.46
log
@• take care of dbins
• #!/bin/mksh shebang, in most places
• rcsid while here
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.45 2009/02/02 22:31:20 tg Exp $
d4 1
a4 1
# Copyright (c) 2006, 2007, 2008
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.45 2009/02/02 22:31:20 tg Exp $
d117 2
@


1.45
log
@prevent abortion
@
text
@d1 2
a2 2
#!/usr/bin/env mksh
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.44 2008/11/29 17:10:53 tg Exp $
d68 1
a68 1
		live:$2a$04$NCMhVFfIg3afYRXLCDGjcOPYJxem4lxSLcthQT5AaejUaAAvIWdCW:32762:32762:staff:0:0:MirOS BSD Live CD User:/home/live:/usr/dbin/mksh
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.44 2008/11/29 17:10:53 tg Exp $
d159 1
a159 1
perl -p -i -e 's/MirOS ftp.1./MirOS LiveCD/' usr/bin/ftp usr/dbin/ftp
a194 7
for f in usr/dbin/* usr/dsbin/*; do
	for d in bin sbin usr/bin usr/sbin; do
		[[ ! -e $d/${f##*/} ]] || ln -f $f $d/${f##*/}
	done
done
rm -f sbin/dbins

@


1.44
log
@it is no longer needed to touch sudoers(5); instead, we just need to
ensure that the live/superuser's user account is listed in group wheel
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.43 2008/11/01 02:07:46 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.43 2008/11/01 02:07:46 tg Exp $
d197 1
a197 1
		[[ -e $d/${f##*/} ]] && ln -f $f $d/${f##*/}
@


1.43
log
@place the gzsig(1) keys on the baselive CD too, not just installer CD
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.42 2008/10/31 23:43:45 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.42 2008/10/31 23:43:45 tg Exp $
a141 4
ed -s etc/sudoers <<-'EOMD'
	%g/@@ROOT@@/s//live/
	wq
EOMD
@


1.42
log
@• simplify DuaLive CD building
• mention the CD type on more places
• try to coerce makefs(8) to place bootloaders early
• space: remove static libraries for which shared equivalents exist
• handle v10/i386/CKSUM.gz gracefully
• plug v10/sparc/CKSUM[.gz] if DuaLive
• handle stand/locate.database checksumming
• clean up mkisofs.log junk
• remove statically linked stuff from /bin /sbin etc. and hard-link
  the dynamic variants from /usr/dbin and /usr/dsbin there, rm dbins
• space: remove nōn-mirbsd linker scripts
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.41 2008/10/31 22:35:09 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.41 2008/10/31 22:35:09 tg Exp $
d208 10
@


1.41
log
@makefs(8) has been fixed to no longer trash device nodes
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.39 2008/10/21 21:03:33 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.39 2008/10/21 21:03:33 tg Exp $
d199 9
@


1.40
log
@makefs(8) trashes device nodes (and also, mtimes)
@
text
@d85 1
a85 4
		mount_mfs swap /.d
		(cd /.d; mksh /dev/MAKEDEV rd0a)
		mount -fwo async,noatime /.d/rd0a /dev
		umount /.d
d100 1
a100 4
		mount_mfs swap /.d
		(cd /.d; mksh /dev/MAKEDEV rd0a)
		mount -fwo async,noatime /.d/rd0a /dev
		umount /.d
d189 1
a189 1
(cd dev; mksh ./MAKEDEV std)
d215 1
a215 1
mkdir -p .d emul usr/X11R6/lib/X11 usr/mpkg usr/ports var
@


1.39
log
@modernise, simplify
commit before testing (as backup)
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.38 2008/10/05 16:26:16 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.38 2008/10/05 16:26:16 tg Exp $
d85 4
a88 1
		mount -fwo async,noatime /dev/rd0a /dev
d103 4
a106 1
		mount -fwo async,noatime /dev/rd0a /dev >/dev/null 2>&1
d195 1
a195 1
(cd dev; mksh ./MAKEDEV std rd0a)
d221 1
a221 1
mkdir -p emul usr/X11R6/lib/X11 usr/mpkg usr/ports var
@


1.38
log
@use mksh realpath builtin instead of readlink -f for canonicalisation

note: there’s still a readlink(1) call left in, for instance, mirmake;
this does not hurt because we initially assumed that readlink(1) does
exist anyway and bundled ours just because some do not have the ‘-f’
option for realpath(2)isation
@
text
@d1 2
a2 2
#!/bin/mksh
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.37 2008/07/22 19:48:47 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.37 2008/07/22 19:48:47 tg Exp $
d132 2
a133 1
		    ')>,seed=$RANDOM" >/dev/wrandom 2>&1)
d163 1
a163 4
ed -s usr/bin/ftp <<-'EOMD'
	%g/MirOS ftp(1)/s//MirOS LiveCD/
	wq
EOMD
@


1.37
log
@“ttyflags -a” needs /etc/ttys here, too
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.36 2008/07/19 22:06:03 tg Exp $
d26 1
a26 1
myplace=$(readlink -nf $(dirname "$0"))
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.36 2008/07/19 22:06:03 tg Exp $
d192 1
a192 1
pwd_mkdb -pd $(readlink -nf etc) master.passwd
@


1.36
log
@reduce amount of X11 fonts on the live cd
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.35 2008/07/09 23:32:01 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.35 2008/07/09 23:32:01 tg Exp $
d161 1
@


1.35
log
@nuke bsdstats and explain why
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.34 2008/07/07 13:57:13 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.34 2008/07/07 13:57:13 tg Exp $
d200 10
a209 1
rm -rf usr/X11R6/lib/X11/fonts/{100dpi,OTF,Speedo,Type1,cyrillic,local}
@


1.34
log
@nuke more advertising clauses from me; also remove mine and TNF's original
one (not all the other nbsd related) from the list
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.33 2008/06/11 10:17:43 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.33 2008/06/11 10:17:43 tg Exp $
a134 15
	/xdm may be started/i
		(
			cp /usr/bin/ftp /tmp/ftp.bsdstats
			ed -s /tmp/ftp.bsdstats <<-'EOFB'
				%g/MirOS LiveCD/s//MirOS ftp(1)/
				wq
			EOFB
			sed 's!/usr/bin/ftp!/tmp/ftp.bsdstats!g' \
			    </usr/share/misc/bsdstats >/tmp/run.bsdstats
			stats_sysadd=-livecd mksh \
			    /tmp/run.bsdstats <&- 2>&1 | logger -t BSDstats
			rm -f /tmp/ftp.bsdstats /tmp/run.bsdstats
		) &

	.
@


1.33
log
@new XF86Config handling:
• use installed
• munge font paths the same as before
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.32 2008/05/13 12:14:29 tg Exp $
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.32 2008/05/13 12:14:29 tg Exp $
d96 1
a96 1
		print \#\\tThis product includes material provided by Thorsten Glaser.
@


1.32
log
@nah, get rid of /dev/.root as root home directory entirely
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.31 2008/05/13 11:49:02 tg Exp $
d28 11
d81 1
a81 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.31 2008/05/13 11:49:02 tg Exp $
a192 2
    $myplace/$MACHINE/XF86Config etc/X11/XF86Config
install -c -o root -g staff -m 644 \
@


1.31
log
@* build fix: /root -> / for root home directory
* use /usr/dbin/mksh as user shell, while here
* nuke advertising clause, while here
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.30 2008/03/04 23:48:58 tg Exp $
a55 1
	/^root:/s!:/:!:/dev/.root:!
d70 1
a70 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.30 2008/03/04 23:48:58 tg Exp $
a205 1
mv root dev/.root
d210 1
a210 1
find dev/.root etc tmp usr/X11R6/lib/X11 var | sort | \
d212 1
a212 1
rm -rf dev/.root usr/X11R6/lib/X11 var sys
@


1.30
log
@provide some of our own entropy to the randomness source server when asking
for some seed to help the own pool initialising
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.29 2007/09/28 22:54:07 tg Exp $
a12 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
d56 1
a56 1
	/^root:/s!/root!/dev/.root!
d58 1
a58 1
		live:$2a$04$NCMhVFfIg3afYRXLCDGjcOPYJxem4lxSLcthQT5AaejUaAAvIWdCW:32762:32762:staff:0:0:MirOS BSD Live CD User:/home/live:/bin/mksh
d71 1
a71 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.29 2007/09/28 22:54:07 tg Exp $
@


1.30.2.1
log
@MFC: bsdstats removal
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.30 2008/03/04 23:48:58 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.30 2008/03/04 23:48:58 tg Exp $
d129 15
@


1.29
log
@don’t hardcode herc.mirbsd.org
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.28 2007/09/28 20:46:53 tg Exp $
d4 2
a5 2
# Copyright (c) 2006, 2007
#	Thorsten Glaser <tg@@mirbsd.de>
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.28 2007/09/28 20:46:53 tg Exp $
d126 1
a126 1
		    ')>" >/dev/wrandom 2>&1)
@


1.28
log
@reduce writes to /dev/arandom, do them where necessary only
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.27 2007/09/02 16:43:51 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.27 2007/09/02 16:43:51 tg Exp $
d113 1
a113 1
		    https://herc.mirbsd.org/rn.cgi?live"<$(uname -a | sed '
@


1.27
log
@run a one-off cprng(8) rather early, to provide better entropy earlier
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.26 2007/08/12 13:59:36 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.26 2007/08/12 13:59:36 tg Exp $
d80 1
a80 1
		cat /dev/.rs >/dev/arandom 2>&-
d84 2
a85 2
		     dd if=/dev/r${d%:*}d0c count=${d#*:} ${b:+bs=$b of=/dev/arandom}\
		     ; done; dd if=/var/db/host.random of=/dev/arandom; dmesg; sysctl\
d112 1
a112 1
		(ulimit -T 60; exec /usr/bin/ftp -mvo /dev/arandom \
@


1.26
log
@use entropy generated between /etc/rc start and hostname generation for the
latter, too
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.25 2007/07/24 09:21:55 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.25 2007/07/24 09:21:55 tg Exp $
d77 2
a78 3
	/shutdown request/ka
	/^fi/a

@


1.25
log
@run cprng-once early in the live cd boot process (for hostname generation)
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.24 2007/07/14 15:44:25 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.24 2007/07/14 15:44:25 tg Exp $
d89 1
a91 1
		/usr/libexec/cprng -pr32 >/dev/urandom &
@


1.24
log
@don't run anacron on the live cd either, d'oh…
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.23 2007/06/30 02:47:41 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.23 2007/06/30 02:47:41 tg Exp $
d91 1
d106 1
@


1.23
log
@next part of the master plan; automatically adjust to the console baud rate
even makes the baselive CD – except for the bootloader choice menu – usable
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.22 2007/06/04 08:36:36 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.22 2007/06/04 08:36:36 tg Exp $
d174 1
@


1.22
log
@/dev/arandom is seeded with only 256 octets of entropy for 400k octets of
output; while its entropy quality is better than that of /dev/urandom its
randomness is worse, so use more of /dev/urandom for /var/db/host.random.
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.21 2007/05/25 23:08:56 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.21 2007/05/25 23:08:56 tg Exp $
a126 63
	/parsed console/a
		[[ -e /etc/ttys ]] && if [[ $consdev != nochg ]]; then
			print -n adjusting /etc/ttys ...
			x=$(uname -m)
			if [[ $x = i386 ]]; then
				# clean up if we don't match
				if ! grep "^#AUTOCONS:$consdev,$consspeed." /etc/ttys >&- 2>&-; then
					print -n ' cleanup (i386)'
					ed -s /etc/ttys <<-EOF
						%g/^#AUTOCONS/d
						%g/	#AUTOADD\$/d
						%g/	#AUTODEL\$/s/^#*//
						%g/	#AUTODEL\$/s///
						wq
					EOF
				fi
			fi
			# if consdev=ttyC0: wscons, no change needed
			if [[ $consdev = ttyC0 ]]; then
				print -n ' wscons'
				# wscons, reset to default on sparc, no action on i386
				if [[ $x = sparc ]]; then
					print -n ' (sparc)'
					ed -s /etc/ttys <<-EOF
						/console.*suncons/s/^#*//
						/console.*std/s/^#*/#/
						wq
					EOF
				fi
			else
				# serial console, disable wscons
				print -n " serial ($consspeed bps)"
				if [[ $x = sparc ]]; then
					# we just use /dev/console for both
					# XXX what is this ttyC0 entry?
					print -n ' (sparc)'
					ed -s /etc/ttys <<-EOF
						/console.*suncons/s/^#*/#/
						/console.*std/s/^#*//
						/console.*std/s/std.[0-9]*/std.$consspeed/
						wq
					EOF
				fi
				if [[ $x = i386 ]]; then
					# keep wscons but enable tty0X dev
					print -n ' (i386)'
					if ! grep "^$consdev	.*std.$consspeed\".*	on" \
					    /etc/ttys >&- 2>&-; then
						print -n ' -> adding'
						ed -s /etc/ttys <<-EOF
							%g/^$consdev	/s/^.*\$/#&	#AUTODEL/
							wq
						EOF
						cat >>/etc/ttys <<-EOF
							$consdev	"/usr/libexec/getty std.$consspeed"	vt100	on  secure	#AUTOADD
							#AUTOCONS:$consdev,$consspeed.
						EOF
					fi
				fi
			fi
			print ' done.'
		fi
	.
@


1.21
log
@what did I say about two days ago's typo of the day again?
sync with recent distrib/common/* changes
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.20 2007/03/26 17:57:06 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.20 2007/03/26 17:57:06 tg Exp $
d264 7
a270 1
dd if=/dev/arandom count=4 of=var/db/host.random
@


1.20
log
@more environmental noise → boot entropy
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.19 2007/02/20 01:38:20 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.19 2007/02/20 01:38:20 tg Exp $
d84 5
a88 5
		( ( (dd if=/dev/rwd0c count=126; dd if=/dev/rsd0c count=126; \
		     dd if=/dev/rcwd0c count=96; eeprom; dmesg; sysctl -a; \
		     dd if=/var/db/host.random of=/dev/arandom) 2>&1 | \
		    cksum -a cksum -a sha512 -a suma -a tiger -a rmd160 -a adler32 \
		    -b >/dev/wrandom) &)
@


1.19
log
@damn, we actually need URI encoding (RFC 2396, according to bsdstats)
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.18 2007/02/20 01:09:34 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.18 2007/02/20 01:09:34 tg Exp $
d82 7
a88 2
		( (dd if=/dev/rwd0c count=126; dd if=/dev/rsd0c count=126) \
		    2>&1 | cksum -ba sha512 >/dev/arandom ) &
@


1.18
log
@get a little additional entropy, like bsd.rd, before creating sshd key
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.17 2007/02/20 00:57:32 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.17 2007/02/20 00:57:32 tg Exp $
d107 14
a120 2
		    https://herc.mirbsd.org/rn.cgi?live"<$(uname -a)>" \
		    >/dev/wrandom 2>&1)
@


1.17
log
@if the "umount -a" doesn't umount /dev again, don't bother giving
a "device busy" error on forced remount
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.16 2007/02/20 00:04:00 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.16 2007/02/20 00:04:00 tg Exp $
d103 7
@


1.16
log
@sync with current changes
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.15 2006/11/01 00:27:21 tg Exp $
d89 1
a89 1
		mount -fwo async,noatime /dev/rd0a /dev
@


1.15
log
@we (cnuke@@ to be precise) might need /emul as mount point (mfs)
so create it as an empty directory
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.14 2006/10/29 17:02:54 tg Exp $
d4 1
a4 1
# Copyright (c) 2006
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d17 8
a24 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.14 2006/10/29 17:02:54 tg Exp $
d219 1
@


1.14
log
@care about BSDstats who *^R)^%)*%^;2~_%_*$ hardcode the user agents allowed
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.13 2006/10/29 16:49:21 tg Exp $
d76 1
a76 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.13 2006/10/29 16:49:21 tg Exp $
d250 2
a251 2
mkdir -p usr/X11R6/lib/X11 usr/mpkg usr/ports var
chown 0:0 var
@


1.13
log
@try and fix some of the perms on the live cd
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.12 2006/10/02 22:38:13 tg Exp $
d76 1
a76 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.12 2006/10/02 22:38:13 tg Exp $
d169 12
a180 2
		(stats_sysadd=-livecd mksh \
		    /usr/share/misc/bsdstats <&- 2>&1 | logger -t BSDstats) &
@


1.12
log
@fix up and (on i386) enable the baselive CD; still not installer-augmented
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.11 2006/10/02 07:09:14 tg Exp $
d76 1
a76 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.11 2006/10/02 07:09:14 tg Exp $
d241 1
@


1.11
log
@try a compressed fsrw, once again
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.10 2006/10/02 07:03:17 tg Exp $
d27 2
a28 2
# Patch a freshly unpacked MirOS installation into the standard live
# CD distribution.
d35 1
d76 1
a76 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.10 2006/10/02 07:03:17 tg Exp $
d81 1
a81 1
		mount /dev/rd0a /dev
d85 1
a85 2
		(cd /dev; ln -s $(sysctl -n kern.root_device) root)
		rm -f /dev/.rs
d89 4
a92 15
	/^rm.*fastboot$/a

		function do_mfsmount
		{
			print -n " $1"
			mount_mfs -s ${2:-300000} swap /$1
		}
		print -n 'initialising memory filesystems...'
		do_mfsmount etc 20480
		do_mfsmount home
		do_mfsmount tmp 600000
		do_mfsmount usr/X11R6/lib/X11 20480
		do_mfsmount var
		print '... done'
		sleep 2
d95 1
a95 1
		print ' done'
d101 2
@


1.10
log
@start bringing the live CD into shape
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.9 2006/09/30 21:02:24 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.9 2006/09/30 21:02:24 tg Exp $
d105 1
a105 1
		pax -r -pe -f /stand/fsrw.dat
d247 1
a247 1
    cpio -oC512 -Hsv4crc -Mset >stand/fsrw.dat
@


1.9
log
@create /usr/ports and /usr/mpkg possible mount points
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.8 2006/09/30 20:59:00 tg Exp $
d33 1
a33 1
ed -s etc/X11/xdm/Xresources <<-'EOF'
d37 2
a38 2
EOF
cat >>etc/exports <<-'EOF'
d40 2
a41 2
EOF
ed -s etc/group <<-'EOF'
d53 2
a54 2
EOF
ed -s etc/inetd.conf <<-'EOF'
d58 2
a59 2
EOF
ed -s etc/master.passwd <<-'EOF'
d65 2
a66 2
EOF
ed -s etc/ntpd.conf <<-'EOF'
d72 2
a73 2
EOF
ed -s etc/rc <<-'EOF'
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.8 2006/09/30 20:59:00 tg Exp $
d113 63
a176 3
	%g!/etc/ttys\.gen!s!!/etc/ttys!g
	/^#	print -n adjusting/s/^#//
	/for now/d
d183 2
a184 2
EOF
ed -s etc/rc.securelevel <<-'EOF'
d187 2
a188 2
EOF
ed -s etc/sudoers <<-'EOF'
d191 2
a192 2
EOF
ed -s etc/sysctl.conf <<-'EOF'
d200 2
a201 2
EOF
[[ $MACHINE = i386 ]] && ed -s etc/sysctl.conf <<-'EOF'
d207 2
a208 2
EOF
ed -s usr/bin/ftp <<-'EOF'
d211 2
a212 2
EOF
ed -s var/cron/tabs/root <<-'EOF'
d220 1
a220 1
EOF
@


1.8
log
@simplify; commonise
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.7 2006/09/13 01:08:21 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.7 2006/09/13 01:08:21 tg Exp $
d189 1
a189 1
mkdir -p usr/X11R6/lib/X11 var
@


1.7
log
@rewritten-from-scratch bsdstats.org code, including live cd stuff
believe me, the 900s (plus safety zone) delay _is_ needed...

awaiting testing
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.6 2006/08/22 21:51:40 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.6 2006/08/22 21:51:40 tg Exp $
d171 2
@


1.6
log
@use the machdep.console_device sysctl(3) instead
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.5 2006/08/19 01:37:50 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.5 2006/08/19 01:37:50 tg Exp $
d117 5
@


1.5
log
@add an 'evilwm-session' script, invoked as "evilwm-utf8" because it spawns
uxterms by default ;) and keep plain evilwm as "evilwm-latin1"
also, add failsafe fallover stuff, just in case...
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.4 2006/08/19 01:29:15 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.4 2006/08/19 01:29:15 tg Exp $
d115 2
@


1.4
log
@install the "Desktop Environment Chooser"
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.3 2006/08/19 01:02:20 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.3 2006/08/19 01:02:20 tg Exp $
d165 2
@


1.3
log
@make the /etc/ttys generation code go live for the baselive cd
@
text
@d2 1
a2 1
# $MirOS: src/distrib/baselive/munge_it.sh,v 1.2 2006/08/18 22:18:25 tg Exp $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.2 2006/08/18 22:18:25 tg Exp $
d163 2
@


1.2
log
@start sanitising
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d75 1
a75 1
		# $MirOS: src/distrib/baselive/munge_it.sh,v 1.1 2006/08/17 19:58:00 tg Exp $
d114 1
a140 6
print -u2 XXX replace etc/ttys stuff with etc/rc stuff
[[ $MACHINE = i386 ]] && ed -s etc/ttys <<-'EOF'
	/^tty00/s/unknown/vt220/
	s/off/on secure/
	wq
EOF
@


1.1
log
@* new Makefile structure
* move i386/livecd into baselive/ and sub-directory-structure appropriately
* rid unneeded files
* ifdef out build of rescue tools not needed on certain arches
@
text
@d2 1
a2 1
# $MirOS: src/distrib/i386/livecd/munge_it.sh,v 1.45 2006/08/16 18:46:13 tg Exp $
d14 2
a15 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d25 1
a25 1
# the possibility of such damage or existence of a nontrivial bug.
a37 6
cat >>etc/bootparams <<-'EOF'
	* root=172.23.42.1:/
EOF
cat >>etc/ethers <<-'EOF'
	# format: aa:bb:cc:dd:ee:ff bpclnt1{0,1,2}
EOF
d56 1
d66 4
a69 8
: || ed -s etc/make.cfg <<-'EOF'
	$a
		### Run MirPorts off the Live CD
		DISTDIR?=		${LOCALBASE}/.ports/Distfiles
		BULK_COOKIES_DIR?=	${LOCALBASE}/.ports/Bulk
		PKGREPOSITORY?=		${LOCALBASE}/.ports/Packages
		WRKOBJDIR?=		${LOCALBASE}/.ports/build

a72 7
#ed -s etc/ntpd.conf <<-'EOF'
#	/^.server /d
#	i
#		server ntp.mirbsd.org
#	.
#	wq
#EOF
d75 1
a75 1
		# $MirOS: src/distrib/i386/livecd/munge_it.sh,v 1.45 2006/08/16 18:46:13 tg Exp $
d81 1
a81 1
		test -e /dev/.rs && cat /dev/.rs >/dev/arandom
d83 1
a83 1
		    2>&1 | /bin/cksum -ba sha512 >/dev/arandom ) &
d105 1
a105 1
		cpio -mid </stand/fsrw.cpio
a112 7
	/load arp tables/i
		#if [[ -e /tmp/try_rnd ]]; then
		#	( /usr/bin/ftp -r 120 -Vo - http://tg.mirsolutions.de/rnd_bin.cgi 2>&1 | /bin/cksum -ba sha512 >/dev/prandom ) &
		#fi

	.
	/rd0c/d
a115 38
: || ed -s etc/rc.local <<-'EOF'
	$a
		has_pkgs=0
		for a in /v?/*/*.cgz; do
			if [[ -s $a ]]; then
				has_pkgs=1
				break
			fi
		done
		if [[ $has_pkgs = 1 ]]; then
			print -n 'preloading packages...'
			mount_mfs -s 1200000 swap /usr/mpkg
			has_pkgtools=0
			print -n ' <pkgtools'
			for a in /v?/*/pkgutl*.ngz; do
				if [[ -s $a ]]; then
					has_pkgtools=$a
					break
				fi
			done
			if [[ $has_pkgtools != 0 ]]; then
				tar xzphf $a
			else
				print -n ' (compiling)'
				(cd /usr/ports; make setup)
			fi
			print -n '>'
			for a in /v?/*/*.cgz; do
				[[ -s $a ]] || continue
				print -n " ${a%.cgz}"
				/usr/mpkg/sbin/pkg_info ${a%.cgz} >/dev/null \
				    2>&1 || /usr/mpkg/sbin/pkg_add $a
			done
			print ' done'
		fi
	.
	wq
EOF
d131 3
d140 2
a141 1
ed -s etc/ttys <<-'EOF'
d160 8
a167 4
install -c -o root -g staff -m 644 $myplace/XF86Config etc/X11/XF86Config
install -c -o root -g staff -m 644 $myplace/fstab etc/fstab
install -c -o root -g staff -m 644 $myplace/rc.conf.local etc/rc.conf.local
install -c -o root -g staff -m 644 $myplace/rc.netselect etc/rc.netselect
d171 1
a171 9
dd if=/dev/arandom bs=4096 count=1 of=var/db/host.random
mkdir -p tftpboot/etc
(cd tftpboot; ln -s ../bsd; ln -s ../usr/mdec/pxeboot)
cat >tftpboot/etc/boot.cfg <<-'EOF'
	echo
	echo To boot from NFS, enter "nfs" as root device when asked.
	echo
	boot /bsd -a
EOF
d179 1
a179 1
    cpio -oC512 -Hsv4crc -Mset >stand/fsrw.cpio
@

