head	1.9;
access;
symbols
	MIRBSD_9_BASE:1.7;
locks; strict;
comment	@# @;


1.9
date	2006.08.17.14.09.20;	author tg;	state dead;
branches;
next	1.8;
commitid	10044E4787416A4A520;

1.8
date	2006.07.03.22.12.00;	author tg;	state Exp;
branches;
next	1.7;
commitid	10044A99644579D77B3;

1.7
date	2006.06.16.13.12.56;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004492AE534A0B6BB6;

1.6
date	2006.06.16.12.34.37;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004492A5697B3ED5FB;

1.5
date	2006.06.12.11.38.46;	author tg;	state Exp;
branches;
next	1.4;
commitid	100448D525A5797FFC6;

1.4
date	2006.06.11.01.53.25;	author tg;	state Exp;
branches;
next	1.3;
commitid	100448B77A36E3B7D58;

1.3
date	2006.06.11.01.41.43;	author tg;	state Exp;
branches;
next	1.2;
commitid	100448B74E73026F8F8;

1.2
date	2006.06.11.01.22.38;	author tg;	state Exp;
branches;
next	1.1;
commitid	100448B706E607060DF;

1.1
date	2006.06.11.01.08.29;	author tg;	state Exp;
branches;
next	;
commitid	100448B6D170B979B25;


desc
@@


1.9
log
@prepare for even larger structural change (unify miniroot, ramdisk, rambig):
* move install.md per-arch into distrib/common/install.MACHINE
* move Makefile.kernel into distrib/common/ too
@
text
@# $MirOS: src/distrib/Makefile.kernel,v 1.8 2006/07/03 22:12:00 tg Exp $

SYSDIR?=	${BSDSRCDIR}/sys
SYSSUBDIR?=	${SYSDIR}/arch/${MACHINE}
KERNDIR?=	${SYSSUBDIR}/compile/${RAMDISK}

KCONFIG?=	config -s ${SYSDIR} -b . ${SYSSUBDIR}/conf/${RAMDISK}
KMAKE_CLEAN?=	${MAKE} clean
KMAKE_DEPEND?=	${KMAKE} depend
KMAKE?=		${MAKE} COPTS=${CFLAGS:Q}

bsd:
	mkdir -p build/${RAMDISK}
	[[ -f build/${RAMDISK}/version || ! -f ${KERNDIR}/version ]] \
	    || cat ${KERNDIR}/version >build/${RAMDISK}/version
	( cd build/${RAMDISK}; ${KCONFIG} && ${KMAKE_CLEAN} && \
	    ${KMAKE_DEPEND} && exec ${KMAKE} bsd )
	mv build/${RAMDISK}/bsd .
	-[[ ! -e ${KERNDIR} ]] \
	    || if ! cat build/${RAMDISK}/version >${KERNDIR}/version; then \
		( print "# warning: kernel version changed"; \
		  print "print $$(<build/${RAMDISK}/version)" \
		     ">${KERNDIR}/version" ) \
		  | ${SUDO} tee -a /var/tmp/.buildnotice >&2; \
	    fi
@


1.8
log
@simplify
@
text
@d1 1
a1 1
# $MirOS: src/distrib/Makefile.kernel,v 1.7 2006/06/16 13:12:56 tg Exp $
@


1.7
log
@d'oh, that didn't work. copy two lines from i386/common/Makefile.inc
to the arch/generic/Makefile then and reduce the amount of work the
Makefile.kernel does
@
text
@d1 5
a5 1
# $MirOS: src/distrib/Makefile.kernel,v 1.6 2006/06/16 12:34:37 tg Exp $
@


1.6
log
@only CFLAGS+=COPTS if that hasn't yet been done
@
text
@d1 1
a1 6
# $MirOS: src/distrib/Makefile.kernel,v 1.5 2006/06/12 11:38:46 tg Exp $

.include <bsd.own.mk>
.if !${CFLAGS:M${COPTS}}
CFLAGS+=	${COPTS}
.endif
@


1.5
log
@fix COPTS
@
text
@d1 1
a1 1
# $MirOS: src/distrib/Makefile.kernel,v 1.4 2006/06/11 01:53:25 tg Exp $
d4 1
d6 1
@


1.4
log
@better legible
@
text
@d1 4
a4 1
# $MirOS: src/distrib/Makefile.kernel,v 1.3 2006/06/11 01:41:43 tg Exp $
@


1.3
log
@less redundancy
@
text
@d1 1
a1 1
# $MirOS: src/distrib/Makefile.kernel,v 1.2 2006/06/11 01:22:38 tg Exp $
d3 1
d12 1
a12 2
	( cd build/${RAMDISK}; config -s ${SYSDIR} -b . \
	    ${SYSSUBDIR}/conf/${RAMDISK} && ${KMAKE_CLEAN} && \
@


1.2
log
@use CFLAGS properly, even if cross-building
@
text
@d1 5
a5 1
# $MirOS: src/distrib/Makefile.kernel,v 1.1 2006/06/11 01:08:29 tg Exp $
d12 2
a13 2
	    ${SYSSUBDIR}/conf/${RAMDISK} && ${MAKE_CLEAN} && ${MAKE} \
	    COPTS=${CFLAGS:Q} depend && exec ${MAKE} COPTS=${CFLAGS:Q} bsd )
@


1.1
log
@bring some sparc kernel build infrastructure up to date
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/generic/Makefile.kernel,v 1.1 2006/02/14 20:47:53 tg Exp $
d8 2
a9 2
	    ${SYSSUBDIR}/conf/${RAMDISK} \
	    && ${MAKE_CLEAN} && ${MAKE} depend && exec ${MAKE} bsd )
@

