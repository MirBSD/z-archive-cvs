head	1.31;
access;
symbols
	MIRBSD_9_BASE:1.19
	MIRBSD_8:1.5.0.2
	MIRBSD_8_BASE:1.5
	cvs-200507211800:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.31
date	2006.07.24.00.24.00;	author tg;	state dead;
branches;
next	1.30;
commitid	10044C4132D5626FCF6;

1.30
date	2006.07.23.23.41.25;	author tg;	state Exp;
branches;
next	1.29;
commitid	10044C409313E5D0B2B;

1.29
date	2006.07.16.13.19.37;	author tg;	state Exp;
branches;
next	1.28;
commitid	10044BA3CF503761213;

1.28
date	2006.07.16.13.09.15;	author tg;	state Exp;
branches;
next	1.27;
commitid	10044BA3A8E296F2301;

1.27
date	2006.07.16.13.08.53;	author tg;	state Exp;
branches;
next	1.26;
commitid	10044BA3A6B4B0C1D75;

1.26
date	2006.07.16.13.07.48;	author tg;	state Exp;
branches;
next	1.25;
commitid	10044BA3A0D104B4672;

1.25
date	2006.07.05.23.01.19;	author tg;	state Exp;
branches;
next	1.24;
commitid	10044AC44D63799341D;

1.24
date	2006.07.05.22.58.56;	author tg;	state Exp;
branches;
next	1.23;
commitid	10044AC442748B9F9EB;

1.23
date	2006.07.05.21.06.15;	author tg;	state Exp;
branches;
next	1.22;
commitid	10044AC29D3229F7738;

1.22
date	2006.07.05.20.36.34;	author tg;	state Exp;
branches;
next	1.21;
commitid	10044AC22CF5554C0AF;

1.21
date	2006.07.03.23.17.49;	author tg;	state Exp;
branches;
next	1.20;
commitid	10044A9A5A4112B9606;

1.20
date	2006.07.03.22.12.01;	author tg;	state Exp;
branches;
next	1.19;
commitid	10044A99644579D77B3;

1.19
date	2006.06.15.20.01.48;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004491BCBD02E64A34;

1.18
date	2006.06.11.01.08.29;	author tg;	state Exp;
branches;
next	1.17;
commitid	100448B6D170B979B25;

1.17
date	2006.05.15.20.47.03;	author tg;	state Exp;
branches;
next	1.16;
commitid	1004468E8C548985FB8;

1.16
date	2006.05.15.19.20.14;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004468D4787674941C;

1.15
date	2006.04.09.08.59.28;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004438CCFD57718FBC;

1.14
date	2006.04.09.08.39.44;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004438C85848532AAC;

1.13
date	2006.04.07.13.09.33;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004436644737BC1A77;

1.12
date	2006.04.07.12.15.58;	author tg;	state Exp;
branches;
next	1.11;
commitid	100443658067D599CBD;

1.11
date	2006.04.06.11.07.29;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004434F66517D09156;

1.10
date	2006.02.24.01.30.39;	author tg;	state Exp;
branches;
next	1.9;
commitid	10043FE61CF4E20E30C;

1.9
date	2006.02.14.20.47.52;	author tg;	state Exp;
branches;
next	1.8;
commitid	10043F2407C51151E2F;

1.8
date	2006.02.01.19.46.46;	author tg;	state Exp;
branches;
next	1.7;
commitid	10043E110357157015B;

1.7
date	2006.02.01.18.30.49;	author tg;	state Exp;
branches;
next	1.6;
commitid	10043E0FE6C10081285;

1.6
date	2006.01.15.23.46.37;	author tg;	state Exp;
branches;
next	1.5;
commitid	10043CADEE658B3AB53;

1.5
date	2005.07.24.16.44.13;	author tg;	state Exp;
branches;
next	1.4;
commitid	377c42e3c570e5b3;

1.4
date	2005.07.01.11.51.42;	author tg;	state Exp;
branches;
next	1.3;
commitid	248142c52e5bc87f;

1.3
date	2005.03.29.17.54.47;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.06.18.58.03;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.22.10;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.22.10;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.07.21.20.45.43;	author tg;	state Exp;
branches;
next	;
commitid	560042e0092f571e;


desc
@@


1.31
log
@preliminary steps at unifying the ramdisk building
@
text
@# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.30 2006/07/23 23:41:25 tg Exp $
# $OpenBSD: Makefile.inc,v 1.15 2004/11/25 22:02:08 deraadt Exp $

.ifndef _MODSRC_DISTRIB_I386_COMMON_MAKEFILE_INC
_MODSRC_DISTRIB_I386_COMMON_MAKEFILE_INC=1

.include <bsd.own.mk>

USE_MAKEFS=	#defined
TOP=		${.CURDIR}/..
REALOBJDIR!=	readlink -nf ${.OBJDIR} || ( cd ${.OBJDIR} && pwd )
IMAGE=		mr.fs
CBIN?=		instbin
CRUNCHCONF?=	${CBIN}.conf
IS_SMALL_DISC?=	yes
.if ${IS_SMALL_DISC:L} != "yes"
LISTS?=		${.CURDIR}/../common/listpre.full ${.CURDIR}/../common/list
.else
LISTS?=		${.CURDIR}/../common/listpre.small ${.CURDIR}/../common/list
.endif
.if exists(${.CURDIR}/list.local)
LISTS+=		${.CURDIR}/list.local
.endif
UTILS?=		${.CURDIR}/../../miniroot
STRIP?=		strip

MOUNT_POINT=	${REALOBJDIR}/tmpmnt
MTREE?=		${UTILS}/mtree.conf

XNAME?=		floppy
FS?=		${XNAME}${OSrev}.fs
VND?=		svnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
REALIMAGE=	${REALOBJDIR}/tmp.ima
INSTALLBOOT?=	${DESTDIR}/usr/mdec/installboot -s ${FLOPPYSECS} -h 2
BOOT=		${BSDOBJDIR}/sys/arch/i386/stand/fdboot/boot
BOOTIN?=	${MOUNT_POINT}/boot
BOOTXX?=	${DESTDIR}/usr/mdec/bootxx
FLOPPYSIZE?=	2880
FLOPPYSECS?=	18
FLOPPYTYPE?=	floppy3
RAWLABEL?=	-r
.if !${COPTS:M-Os}
COPTS+=		-Os
.endif
CFLAGS+=	${CDIAGFLAGS} ${COPTS}
HOSTCFLAGS?=	${CFLAGS}

SYSDIR=		${.CURDIR}/../../../sys

DO_FLOPPY?=	Yes
DO_BSDRD_NAME?=	bsd.rd
DO_BSDRD_UC=	${DO_BSDRD_NAME}.uncompressed

.if ${DO_FLOPPY:L} == "yes"
all:	${FS}
.else
all:	${DO_BSDRD_NAME}
.endif

${FS}:	bsd.gz do-floppy

do-floppy:
.ifdef USE_MAKEFS
	${SUDO} rm -rf ${MOUNT_POINT}
	mkdir -p ${MOUNT_POINT}
	cp ${BOOT} ${MOUNT_POINT}/
	cp bsd.gz ${MOUNT_POINT}/bsd
	${SUDO} chown -R 0:0 ${MOUNT_POINT}
	${SUDO} chmod -R u=rwX,go=rX ${MOUNT_POINT}
	${SUDO} makefs -s ${FLOPPYSIZE}b -o \
	    minfree=0,optimization=space,bsize=4096,fsize=512 \
	    ${REALIMAGE} ${MOUNT_POINT}
	${SUDO} vnconfig -v -c ${VND} ${REALIMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${FLOPPYTYPE}
	${SUDO} mount -r ${VND_DEV} ${MOUNT_POINT}
.else
	dd if=/dev/zero of=${REALIMAGE} count=${FLOPPYSIZE}
	${SUDO} vnconfig -v -c ${VND} ${REALIMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${FLOPPYTYPE}
	${SUDO} newfs -m 0 -o space -i 1048576 -c 80 -b 4096 ${VND_RDEV}
	${SUDO} rm -rf ${MOUNT_POINT}
	mkdir -p ${MOUNT_POINT}
	${SUDO} mount ${VND_DEV} ${MOUNT_POINT}
	${SUDO} cp ${BOOT} ${REALOBJDIR}/boot
	${SUDO} dd if=${REALOBJDIR}/boot of=${BOOTIN} obs=512 conv=osync
	${SUDO} dd if=bsd.gz of=${MOUNT_POINT}/bsd obs=512 conv=osync
.endif
	${SUDO} ${INSTALLBOOT} -v ${BOOTIN} ${BOOTXX} ${VND_CRDEV}
	@@echo ""
	@@df -i ${MOUNT_POINT}
	@@echo ""
	${SUDO} umount ${MOUNT_POINT}
	${SUDO} fsck -fy ${VND_RDEV}
	${SUDO} vnconfig -u ${VND}
	cp ${REALIMAGE} ${FS}
	${SUDO} rm -rf ${REALIMAGE} ${MOUNT_POINT}

DISKTYPE?=	ipldisc
NBLKS?=		8192
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS=	-m 0 -o space -c 16 -i 3072

bsd.gz: ${DO_BSDRD_UC}
	cp ${DO_BSDRD_UC} bsd.strip
	${STRIP} --strip-all -R .comment -R .eh_frame bsd.strip
	gzip -nc9 bsd.strip >bsd.gz

${DO_BSDRD_UC}: ${IMAGE} bsd rdsetroot
	gzip -d <bsd >${DO_BSDRD_UC}
	print 'rootdev 17 0\nquit' | config -ef ${DO_BSDRD_UC}	# (17,0) = rd0a
	${REALOBJDIR}/rdsetroot ${DO_BSDRD_UC} <${IMAGE}

${DO_BSDRD_NAME}: ${DO_BSDRD_UC}
	gzip -n9 <${DO_BSDRD_UC} >${DO_BSDRD_NAME}

.ifndef KERNEL_LOCAL_BUILD
.  include "${.CURDIR}/../../Makefile.kernel"
.endif

${IMAGE}: ${CBIN} rd_setup do_files rd_teardown

rd_setup: ${CBIN}
.ifdef USE_MAKEFS
	${SUDO} rm -rf ${MOUNT_POINT}
	mkdir -p ${MOUNT_POINT}
.else
	dd if=/dev/zero of=${REALIMAGE} count=${NBLKS}
	${SUDO} vnconfig -v -c ${VND} ${REALIMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${DISKTYPE}
	${SUDO} newfs ${NEWFSARGS} ${VND_RDEV}
	${SUDO} rm -rf ${MOUNT_POINT}
	mkdir -p ${MOUNT_POINT}
	${SUDO} mount ${VND_DEV} ${MOUNT_POINT}
.endif

rd_teardown:
.ifdef USE_MAKEFS
	${SUDO} makefs -s ${NBLKS}b -o \
	    minfree=0,optimization=space,bsize=4096,fsize=512,density=3072 \
	    ${REALIMAGE} ${MOUNT_POINT}
	${SUDO} vnconfig -v -c ${VND} ${REALIMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${DISKTYPE}
	${SUDO} mount -r ${VND_DEV} ${MOUNT_POINT}
.endif
	@@df -i ${MOUNT_POINT}
	-${SUDO} umount ${MOUNT_POINT}
	${SUDO} fsck -fy ${VND_RDEV}
	-${SUDO} vnconfig -u ${VND}
	cp ${REALIMAGE} ${IMAGE}
	${SUDO} rm -rf ${REALIMAGE} ${MOUNT_POINT}

rdsetroot: ${TOP}/../common/elfrdsetroot.c
	${HOSTCC} ${HOSTCFLAGS} -DDEBUG -o $@@ $>

unconfig:
	-${SUDO} umount -f ${VND_DEV}
	-${SUDO} vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

install:
.ifndef NOBSDRD
	cp ${DO_BSDRD_NAME} ${DESTDIR}/snapshot/
.endif
.if ${DO_FLOPPY:L} == "yes"
	cp ${FS} ${DESTDIR}/snapshot/${FS}
.endif

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CRUNCHCONF}
	crunchgen -E -D ${BSDSRCDIR} -L ${DESTDIR}/usr/lib \
	    -c ${CBIN}.c -e ${CBIN} -m ${CBIN}.mk ${CRUNCHCONF}

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	make -f ${CBIN}.mk all
	${STRIP} --strip-all -R .comment -R .eh_frame ${CBIN}

${CRUNCHCONF}: ${LISTS}
	awk -f ${UTILS}/makeconf.awk CBIN=${CBIN} ${LISTS} >${CRUNCHCONF}

do_files:
	${SUDO} mtree -def ${MTREE} -p ${MOUNT_POINT}/ -u
	TOPDIR=${TOP} CURDIR=${.CURDIR} OBJDIR=${REALOBJDIR} \
	    REV=${OSrev} TARGDIR=${MOUNT_POINT} UTILS=${UTILS} \
	    ${SUDO} ${SHELL} ${UTILS}/runlist.sh ${LISTS}
	${SUDO} rm ${MOUNT_POINT}/${CBIN}

clean cleandir:
.ifndef KERNEL_LOCAL_BUILD
	-rm -rf build
.endif
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.mk ${CBIN}*.cache boot \
	    *.o *.lo *.c bsd bsd.rd bsd.gz bsd.strip floppy*.fs rdsetroot \
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME} ${DO_BSDRD_UC} \
	    ${FS} ${REALIMAGE}
	/bin/rm -rf ${MOUNT_POINT}

cleannobsd:
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.mk ${CBIN}*.cache boot \
	    *.o *.lo *.c bsd.rd bsd.gz bsd.strip floppy*.fs rdsetroot \
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME} ${DO_BSDRD_UC} \
	    ${FS} ${REALIMAGE}
	/bin/rm -rf ${MOUNT_POINT}

.include <bsd.obj.mk>
.include <bsd.subdir.mk>

.endif
@


1.30
log
@rename ldsec to bootxx to match all other arches
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.29 2006/07/16 13:19:37 tg Exp $
@


1.29
log
@begin synching these two
(neither tested nor complete)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.28 2006/07/16 13:09:15 tg Exp $
d40 1
a40 1
BOOTXX?=	${DESTDIR}/usr/mdec/ldsec
@


1.28
log
@bs=512 is redundant
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.27 2006/07/16 13:08:53 tg Exp $
d37 1
d39 2
d44 1
d69 1
a69 1
	cp ${BOOT} ${MOUNT_POINT}/boot
d77 1
a77 1
	${SUDO} disklabel -w -r ${VND} ${FLOPPYTYPE}
d82 1
a82 1
	${SUDO} disklabel -w -r ${VND} ${FLOPPYTYPE}
d88 1
a88 2
	${SUDO} dd if=${REALOBJDIR}/boot of=${MOUNT_POINT}/boot \
	    obs=512 conv=osync
d91 1
a91 2
	${SUDO} /usr/mdec/installboot -v -s ${FLOPPYSECS} -h 2 \
	    ${MOUNT_POINT}/boot ${DESTDIR}/usr/mdec/ldsec ${VND_CRDEV}
d132 1
a132 1
	${SUDO} disklabel -w -r ${VND} ${DISKTYPE}
d145 1
a145 1
	${SUDO} disklabel -w -r ${VND} ${DISKTYPE}
@


1.27
log
@use sudo for makefs call, in case files are not user-readable
(we could use an mtree spec instead tho)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.26 2006/07/16 13:07:48 tg Exp $
d128 1
a128 1
	dd if=/dev/zero of=${REALIMAGE} bs=512 count=${NBLKS}
@


1.26
log
@(untested) use makefs for generating mr.fs too
XXX still needs the vnd(4) for disklabel (mr.fs, floppy9.fs)
XXX and installboot (floppy9.fs); df -i needs mount
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.25 2006/07/05 23:01:19 tg Exp $
d69 3
a71 2
	makefs -o minfree=0,optimization=space,bsize=4096,fsize=512 \
	    -s ${FLOPPYSIZE}b ${REALIMAGE} ${MOUNT_POINT}
@


1.25
log
@default to makefs(8) for the floppy9.fs generation
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.24 2006/07/05 22:58:56 tg Exp $
d123 4
d134 1
d137 8
d150 1
a150 1
	rm ${REALIMAGE}
@


1.24
log
@allow sparc to USE_MAKEFS too; fix perms, etc.; sync arches
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.23 2006/07/05 21:06:15 tg Exp $
d9 1
@


1.23
log
@the do-floppy target only regenerates the floppy image from bsd.gz et al. now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.22 2006/07/05 20:36:34 tg Exp $
d62 1
d66 2
d78 1
d95 1
a95 1
	rm ${REALIMAGE}
d126 1
@


1.22
log
@make room on the i386 floppy for pppd(8)
and optionally use makefs(8) for generating the floppy9.fs image
so that it fits (more to come later)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.21 2006/07/03 23:17:49 tg Exp $
d58 3
a60 1
${FS}:	bsd.gz
@


1.21
log
@attempt to clean up that i386 distrib mess and make sparc workable
not fully tested yet
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.20 2006/07/03 22:12:01 tg Exp $
d59 10
d79 1
d86 1
d126 1
a126 1
	${SUDO} fsck -f ${VND_RDEV}
@


1.20
log
@simplify
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.19 2006/06/15 20:01:48 tg Exp $
d37 1
a37 1
FLOPPYSIZE?=	144
d59 1
a59 1
	dd if=/dev/zero of=${REALIMAGE} bs=10k count=${FLOPPYSIZE}
d119 2
a120 2
rdsetroot:	${TOP}/../common/elfrdsetroot.c
	${HOSTCC} ${HOSTCFLAGS} -DDEBUG -o $@@ ${TOP}/../common/elfrdsetroot.c
d160 1
a160 1
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME}{,.uncompressed} \
d167 1
a167 1
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME}{,.uncompressed} \
@


1.19
log
@get rid of STRIP_ADDS, we fixed something there
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.18 2006/06/11 01:08:29 tg Exp $
a46 3
SYSSUBDIR=	${SYSDIR}/arch/i386
KERNDIR=	${SYSSUBDIR}/compile/${RAMDISK}
MAKE_CLEAN?=	${MAKE} clean
@


1.18
log
@bring some sparc kernel build infrastructure up to date
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.17 2006/05/15 20:47:03 tg Exp $
a24 1
STRIP_ADDS?=	-K cngetc
d89 1
a89 1
	${STRIP} --strip-all -R .comment -R .eh_frame ${STRIP_ADDS} bsd.strip
@


1.17
log
@save us almost 3 kB of code on the boot floppy
which won't ever be used as "no emulation" image
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.16 2006/05/15 19:20:14 tg Exp $
d102 1
a102 1
.  include "${.CURDIR}/../generic/Makefile.kernel"
@


1.16
log
@use the SMALL tools only for the floppy
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.15 2006/04/09 08:59:28 tg Exp $
d37 1
a37 1
BOOT=		${DESTDIR}/usr/mdec/boot
@


1.15
log
@fsck afterwards, not before copying
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.14 2006/04/09 08:39:44 tg Exp $
d14 6
a19 1
LISTS?=		${.CURDIR}/../common/list
@


1.14
log
@fix a botch in UKCing the kernel... used the wrong file
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.13 2006/04/07 13:09:33 tg Exp $
a106 1
	${SUDO} fsck ${VND_RDEV}
d113 1
@


1.13
log
@set the root device to (17,0) for ramdisk/floppy kernels during
the generation process to avoid automatically asking which root
device should be used on the _installation_ media

if you want to boot from the CD/floppy, use 'boot -a' then.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.12 2006/04/07 12:15:58 tg Exp $
d49 1
d83 2
a84 2
bsd.gz: ${DO_BSDRD_NAME}.uncompressed
	cp ${DO_BSDRD_NAME}.uncompressed bsd.strip
d88 4
a91 4
${DO_BSDRD_NAME}.uncompressed: ${IMAGE} bsd rdsetroot
	gzip -d <bsd >${DO_BSDRD_NAME}.uncompressed
	print 'rootdev 17 0\nquit' | config -ef bsd	# (17,0) = rd0a
	${REALOBJDIR}/rdsetroot ${DO_BSDRD_NAME}.uncompressed <${IMAGE}
d93 2
a94 2
${DO_BSDRD_NAME}: ${DO_BSDRD_NAME}.uncompressed
	gzip -n9 <${DO_BSDRD_NAME}.uncompressed >${DO_BSDRD_NAME}
@


1.12
log
@* livecd: attempt at using the 4 MiB ramdisk image for /dev (and /root)
* common: sync
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.11 2006/04/06 11:07:29 tg Exp $
d89 1
@


1.11
log
@rename ffspbr to ldsec - it's not UFS specific anyway,
it's just the loading sector with map (á la lilo)

also simplify
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.10 2006/02/24 01:30:39 tg Exp $
d77 2
a78 2
DISKTYPE?=       ipldisc
NBLKS?=          8192
d120 1
a120 1
	-${SUDO} umount -f ${MOUNT_POINT}
@


1.10
log
@fix -fhonour-copts issue for host tools
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.9 2006/02/14 20:47:52 tg Exp $
d68 1
a68 1
	    ${MOUNT_POINT}/boot ${DESTDIR}/usr/mdec/ffspbr ${VND_CRDEV}
@


1.9
log
@restructure build system for better restartability,
move things to proper places, ensure root-only-access
to .buildnotice hack file, fix a few problems (using
${BSDMAKE} in gcc/Makefile, including wrong files),
use ${SUDO} on different places, ensure DESTDIR is
always correct on make build, move most of the former
'release' targets from src/etc/Makefile to src/Makefile
and remove associated targets in src/etc/Makefile; sync
list of phony targets in both; copy out common code in
distrib/i386/generic/Makefile, distrib/i386/common/Makefile.inc
into new distrib/i386/generic/Makefile.kernel, remove
unused target 'includes' in src/Makefile, rewrite the
distrib-dirs target, shuffle the creation and removal
of the systrace files around, build HTML manual pages
under systrace(1) control, auto-remove tmp buildhome,
check HOME makeenv/environment sync and being tmp, fix
index/checksum file generation, maybe more (read the diff)

untested
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.8 2006/02/01 19:46:46 tg Exp $
a35 1
HOSTCFLAGS?=	${CFLAGS} ${COPTS}
d40 1
@


1.8
log
@more honour-copts breakage
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.7 2006/02/01 18:30:49 tg Exp $
d10 1
a10 1
REALOBJDIR!=	readlink ${.OBJDIR} || ( cd ${.OBJDIR} && pwd )
d63 3
a65 2
	${SUDO} cp ${BOOT} ${.OBJDIR}/boot
	${SUDO} dd if=${.OBJDIR}/boot of=${MOUNT_POINT}/boot obs=512 conv=osync
d82 2
a83 2
bsd.gz: ${DO_BSDRD_NAME}
	cp ${DO_BSDRD_NAME} bsd.strip
d87 6
a92 3
${DO_BSDRD_NAME}:	${IMAGE} bsd rdsetroot
	gzip -d <bsd >${DO_BSDRD_NAME}
	${.OBJDIR}/rdsetroot ${DO_BSDRD_NAME} <${IMAGE}
d95 1
a95 15
bsd:
	mkdir -p build/${RAMDISK}
	[[ -f build/${RAMDISK}/version || ! -f ${KERNDIR}/version ]] \
	    || cat ${KERNDIR}/version >build/${RAMDISK}/version
	( cd build/${RAMDISK}; config -s ${SYSDIR} -b . \
	    ${SYSSUBDIR}/conf/${RAMDISK} \
	    && ${MAKE_CLEAN} && ${MAKE} depend && exec ${MAKE} bsd )
	mv build/${RAMDISK}/bsd .
	-[[ ! -e ${KERNDIR} ]] \
	    || if ! cat build/${RAMDISK}/version >${KERNDIR}/version; then \
		( print "# warning: kernel version changed"; \
		  print "print $$(<build/${RAMDISK}/version)" \
		     ">${KERNDIR}/version" ) \
		  | tee -a /var/tmp/.buildnotice >&2; \
	    fi
d146 1
a146 1
	TOPDIR=${TOP} CURDIR=${.CURDIR} OBJDIR=${.OBJDIR} \
d157 2
a158 1
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME} ${FS} ${REALIMAGE}
d164 2
a165 1
	    cdrom*.fs ${CRUNCHCONF} ${DO_BSDRD_NAME} ${FS} ${REALIMAGE}
@


1.7
log
@offer continuation
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.6 2006/01/15 23:46:37 tg Exp $
d148 1
a148 1
	make -f ${CBIN}.mk CFLAGS="${CFLAGS}" all
@


1.6
log
@gzip all kernels - our loaders can cope with it
(experimental)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.5 2005/07/24 16:44:13 tg Exp $
d45 1
d97 1
a97 1
	    && ${MAKE} clean && ${MAKE} depend && exec ${MAKE} bsd )
@


1.5
log
@merge and obsolete special kbd (we just use the generic one)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.4 2005/07/01 11:51:42 tg Exp $
d86 1
a86 1
	cp bsd ${DO_BSDRD_NAME}
@


1.4
log
@use [[ ! -e ]] || logic, even if prefixed by a dash
@
text
@d1 2
a2 2
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.3 2005/03/29 17:54:47 tg Exp $
# $OpenBSD: Makefile.inc,v 1.14 2004/05/05 23:40:13 deraadt Exp $
@


1.3
log
@Attention -> warning
man grep
@
text
@d1 1
a1 1
# $MirOS: src/distrib/i386/common/Makefile.inc,v 1.2 2005/03/06 18:58:03 tg Exp $
d98 2
a99 2
	-[[ -e ${KERNDIR} ]] \
	    && if ! cat build/${RAMDISK}/version >${KERNDIR}/version; then \
@


1.2
log
@merge src/distrib
@
text
@d1 1
a1 1
# $MirOS$
d100 1
a100 1
		( print "# Attention: kernel version changed"; \
@


1.1
log
@Initial revision
@
text
@d1 7
a7 1
#	$OpenBSD: Makefile.inc,v 1.14 2004/05/05 23:40:13 deraadt Exp $
d10 1
a10 2

.include "${TOP}/Makefile.inc"
d15 3
d19 2
d22 2
a23 2
MOUNT_POINT=	/mnt
MTREE=		${UTILS}/mtree.conf
d26 1
a26 1
FS?=		${XNAME}${REV}.fs
d31 1
a31 2
PID!=		echo $$$$
REALIMAGE!=	echo /var/tmp/image.${PID}
d34 1
d36 12
d49 1
d51 3
d57 10
a66 11
	vnconfig -v -c ${VND} ${REALIMAGE}
	disklabel -w -r ${VND} ${FLOPPYTYPE}
	newfs -m 0 -o space -i 524288 -c 80 ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}
	cp ${BOOT} ${.OBJDIR}/boot
	strip ${.OBJDIR}/boot
	strip -R .comment ${.OBJDIR}/boot
	dd if=${.OBJDIR}/boot of=${MOUNT_POINT}/boot bs=512
	dd if=bsd.gz of=${MOUNT_POINT}/bsd bs=512
	/usr/mdec/installboot -v ${MOUNT_POINT}/boot \
	    ${DESTDIR}/usr/mdec/biosboot ${VND_CRDEV}
d70 2
a71 2
	umount ${MOUNT_POINT}
	vnconfig -u ${VND}
d75 2
a76 2
DISKTYPE?=       rdroot
NBLKS?=          3510
d78 1
a78 11
NEWFSARGS= -m 0 -o space -c 16 -i 4096

bsd.gz: bsd.rd
	cp bsd.rd bsd.strip
	strip bsd.strip
	strip -R .comment bsd.strip
	gzip -c9 bsd.strip > bsd.gz

bsd.rd:	${IMAGE} bsd rdsetroot
	cp bsd bsd.rd
	${.OBJDIR}/rdsetroot bsd.rd < ${IMAGE}
d80 8
d89 1
d91 15
a105 4
	cd ${.CURDIR}/../../../sys/arch/i386/conf && config ${RAMDISK}
	cd ${.CURDIR}/../../../sys/arch/i386/compile/${RAMDISK} && \
	    make clean && make depend && COPTS=-Os make
	cp ${.CURDIR}/../../../sys/arch/i386/compile/${RAMDISK}/bsd bsd
d111 6
a116 5
	vnconfig -v -c ${VND} ${REALIMAGE}
	disklabel -w -r ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}
d120 2
a121 2
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}
d126 1
a126 1
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/../common/elfrdsetroot.c
d129 2
a130 2
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}
d136 1
a136 1
	cp bsd.rd ${DESTDIR}/snapshot/bsd.rd
d138 1
d140 1
d144 1
a144 1
	-c ${CBIN}.c -e ${CBIN} -m ${CBIN}.mk ${CRUNCHCONF}
d147 2
a148 2
	make -f ${CBIN}.mk all
	strip -R .comment ${CBIN}
d151 1
a151 1
	awk -f ${UTILS}/makeconf.awk CBIN=${CBIN} ${LISTS} > ${CRUNCHCONF}
d154 1
a154 1
	mtree -def ${MTREE} -p ${MOUNT_POINT}/ -u
d156 3
a158 3
	    REV=${REV} TARGDIR=${MOUNT_POINT} UTILS=${UTILS} \
	    sh ${UTILS}/runlist.sh ${LISTS}
	rm ${MOUNT_POINT}/${CBIN}
d161 13
a173 3
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.mk ${CBIN}*.cache \
	    *.o *.lo *.c bsd bsd.rd bsd.gz bsd.strip floppy*.fs \
	    rdsetroot boot ${CRUNCHCONF} ${FS}
d177 2
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@Import almost everything (no ancontrol, ifconfig, pfctl, wicontrol)
of (the undeleted parts of) OpenBSD-current's userland of about 3 hours ago.
Warning: this introduces major breakage!
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.inc,v 1.15 2004/11/25 22:02:08 deraadt Exp $
d51 1
a51 1
NBLKS?=          3800
@

