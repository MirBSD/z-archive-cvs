head	1.3;
access;
symbols
	MIRBSD_9_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2006.08.17.19.58.05;	author tg;	state dead;
branches;
next	1.2;
commitid	10044E4CA2D0E8EFBD4;

1.2
date	2006.05.26.21.09.02;	author tg;	state Exp;
branches;
next	1.1;
commitid	10044776E7E52ADE458;

1.1
date	2006.05.15.19.54.55;	author tg;	state Exp;
branches;
next	;
commitid	1004468DC9A0110D686;


desc
@@


1.3
log
@* new Makefile structure
* move i386/livecd into baselive/ and sub-directory-structure appropriately
* rid unneeded files
* ifdef out build of rescue tools not needed on certain arches
@
text
@#!/bin/mksh
# $MirOS: src/distrib/i386/livecd/mklocatedb.sh,v 1.2 2006/05/26 21:09:02 tg Exp $
#-
# Copyright (c) 2006
#	Thorsten Glaser <tg@@mirbsd.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a nontrivial bug.

function cleanup
{
	set -x
	cd $root
	set +e
	umount $root/var
	umount $root/usr/X11R6/lib/X11
	umount $root/tmp
	umount $root/home
	umount $root/etc
	umount $root/dev
	vnconfig -u svnd0
	rm -f $root/../locatedb.tmp $root/../locatedb.vnd
	exit ${1:-1}
}

set -x
rm -f $root/../locatedb.tmp $root/../locatedb.vnd
[[ -e $root/../locatedb.tmp ]] && exit 1
[[ -e $root/../locatedb.vnd ]] && exit 1
set -e
root=$(readlink -nf .)
cp "$1" $root/../locatedb.vnd
vnconfig svnd0 $root/../locatedb.vnd
set +e
cd $root
mount /dev/svnd0a dev || cleanup
rm -f dev/.rs
ln -s rd0a dev/root
mount_mfs -s 20480 swap $root/etc || cleanup
mount_mfs -s 300000 swap $root/home || cleanup
mount_mfs -s 600000 swap $root/tmp || cleanup
mount_mfs -s 20480 swap $root/usr/X11R6/lib/X11 || cleanup
mount_mfs -s 300000 swap $root/var || cleanup
cpio -mid <stand/fsrw.cpio || cleanup
cp -r etc/skel home/live || cleanup
chown -R 32762:32762 home/live || cleanup
chroot $root /usr/libexec/locate.updatedb --fcodes=- --tmpdir=/var/tmp \
    --filesystems='ffs ufs mfs' >$root/../locatedb.tmp
if [[ -s $root/../locatedb.tmp ]]; then
	cp $root/../locatedb.tmp $root/stand/locate.database
	chmod 444 $root/stand/locate.database
	chown root:wheel $root/stand/locate.database
	rv=0
else
	rv=1
fi
rm -f $root/../locatedb.tmp
cleanup $rv
@


1.2
log
@some path relocation issues (locate db)
@
text
@d2 1
a2 1
# $MirOS: src/distrib/i386/livecd/mklocatedb.sh,v 1.1 2006/05/15 19:54:55 tg Exp $
@


1.1
log
@first try at a locate database on the live CD
idea but no code by Vutral
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.7 2006/04/09 22:08:49 tg Rel $
d32 6
a37 6
	umount var
	umount usr/X11R6/lib/X11
	umount tmp
	umount home
	umount etc
	umount dev
d56 5
a60 5
mount_mfs -s 20480 swap etc || cleanup
mount_mfs -s 300000 swap home || cleanup
mount_mfs -s 600000 swap tmp || cleanup
mount_mfs -s 20480 swap usr/X11R6/lib/X11 || cleanup
mount_mfs -s 300000 swap var || cleanup
@

