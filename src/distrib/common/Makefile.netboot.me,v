head	1.5;
access;
symbols;
locks; strict;
comment	@.\" @;


1.5
date	2013.03.29.16.49.53;	author tg;	state Exp;
branches;
next	1.4;
commitid	1005155C6496F66A629;

1.4
date	2012.09.02.22.14.45;	author tg;	state Exp;
branches;
next	1.3;
commitid	1005043DA6D20CE1B7A;

1.3
date	2010.08.07.16.00.05;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004C5D82DA3E309F6D;

1.2
date	2010.08.06.15.40.01;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004C5C2C6D79827EDA;

1.1
date	2010.01.30.14.31.02;	author tg;	state Exp;
branches;
next	;
commitid	1004B6442BD5D9B6EF8;


desc
@@


1.5
log
@add brconfig(8) to the big i386 kernels; it’s a tight 20K but should work
@
text
@# $MirOS: src/distrib/common/Makefile.netboot.me,v 1.4 2012/09/02 22:14:45 tg Exp $

CBIN?=		instbin
IMAGESIZE=	8192
IMAGETYPE=	ipldisc

KERNEL_BUILD=	no
#		(17,0) = rd0a
RAMDISK_PREP=	print 'rootdev 17 0\nquit' | config -ef $@@~

FLOPPY=		no
.if exists(${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/.)
BOOT=		ldbsd.com
DO_LIVEBOOT=	#defined
.endif
CDROM=		bsd4me.iso
CDROM_OPTS+=	bootimage=i386\;eltorito.loo
CDROM_OPTS+=	no-emul-boot

CLEANFILES+=	ldbsd.* LICENCE.TXT gpl_srcs.tgz

all: templates/bsd4me.stamp

bsd: ${BSDOBJDIR}/distrib/generic/bsd
	cp -f $> $@@

LISTADDS=	boot bridge cd9660 dhclient disktools ext2fs i386 isdn msdos \
		nettools nfs nfsd pager-less ppp-user pppoe-kernel \
		pppoe-user upgrade
MACHCONF:=	i386-big
LISTADDS+=	netboot.me
LGRUBCFG=	netboot.me

${CBIN}.conf: gnustuff

gnustuff: .PHONY
	for dir in ${.CURDIR}/../grml/tinyirc ${TOPDIR}/../contrib/gnu/e3; do \
		(cd $$dir && ${MAKE} obj && ${MAKE} depend && ${MAKE}); \
	done
	cd ${TOPDIR}/../share/doc/legal && ${MAKE} bsd4me
	cp ${REALOBJDIR}/../../../share/doc/legal/bsd4me LICENCE.TXT
	rm -rf gplsrcs
	mkdir -p gplsrcs/{e3,tinyirc}
	cp ${TOPDIR}/../contrib/gnu/e3/{Makefile,README,e3.*} gplsrcs/e3/
	cp ${TOPDIR}/../contrib/code/Snippets/tinyirc.c gplsrcs/tinyirc/
	(cd gplsrcs && find * -type f | sort | cpio -oC512 -Hustar -Mdist | \
	    gzip -n9) >gpl_srcs.tgz

cleannobsd: clean_medirs

clean_medirs:
	-rm -rf gplsrcs templates

cdrom-prepare: ldbsd.stamp

ldbsd.stamp:
.ifdef DO_LIVEBOOT
	cd ${.CURDIR}/../../../sys/arch/i386/stand/liveboot; \
	    ${MAKE} BSD4ME=Yes cleandir && \
	    ${MAKE} BSD4ME=Yes depend && \
	    exec ${MAKE} BSD4ME=Yes
	cp ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/boot ldbsd.com
	cp ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/ldbsd.txt .
	@@:>$@@
.else
	@@echo 'need [[ -d ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/. ]]'
	@@exit 1
.endif

templates/bsd4me.stamp: ${CDROM}

cdrom-mdcopy:
	dd if=/dev/arandom bs=2048 count=1 of=eltorito.loo
	-rm -rf templates
	mkdir -p templates/bsd4me
	mv ${WRKDIR}/boot templates/
	mv ${WRKDIR}/v${OSrev}/${MACHINE}/bsd.rd templates/bsd4me/bsd
	cd ${WRKDIR} && rm -rf *
	cp ${.CURDIR}/boot.cfg LICENCE.TXT gpl_srcs.tgz ldbsd.{com,txt} \
	    templates/bsd4me/
	chmod 0644 templates/bsd4me/* templates/boot/grub/*
	cd templates && pax -rw -l -pe bsd4me boot/grub ${WRKDIR}/
	ln ${WRKDIR}/bsd4me/ldbsd.com ${WRKDIR}/b_${MACHINE}.ldr
	@@:>templates/bsd4me.stamp

cdrom-mdboot:
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | \
	    ${MKSH} ${BOOTSH} \
	    -g $$((#$$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
	    -A -M 4:0x96 -S 2 | \
	    dd of=${CDROM} conv=notrunc 2>/dev/null
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | \
	    ${MKSH} ${BOOTSH} -B 11 | \
	    dd of=${CDROM} conv=notrunc bs=2048 seek=$$(getextent_cd9660 \
	    -f ${CDROM} -b '$$BootImage$$') 2>/dev/null
@


1.4
log
@ensure each invocation puts on different hostent, for real now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.netboot.me,v 1.3 2010/08/07 16:00:05 tg Exp $
d27 1
a27 1
LISTADDS=	boot cd9660 dhclient disktools ext2fs i386 isdn msdos \
@


1.3
log
@fix boot (normal and loopback)

tested, except it doesn’t like the baselive ISO *at all*, even if
NULling its first 32 (512-byte) sectors, no idea why, GRUB is weird

also, cosmetics for loopback.cfg (menu labels)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.netboot.me,v 1.2 2010/08/06 15:40:01 tg Exp $
d9 1
a9 1
RAMDISK_PREP=	print 'rootdev 17 0\nquit' | config -ef $@@
@


1.2
log
@I promised «Jordan_U:#grml» our next version would have support for the
boot method via /boot/grub/loopback.cfg – voilà (untested)

In MirOS bsd4grml, all options except chaining to GRUB are available.
In MirOS bsd4me, the install and baselive images, only the standard
bootloader prompt going to the installer is available, although the
command line gives support for e.g. switching to serial console.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.netboot.me,v 1.1 2010/01/30 14:31:02 tg Exp $
d76 1
d81 2
a82 2
	chmod 0644 templates/bsd4me/*
	cd templates && pax -rw -l -pe bsd4me ${WRKDIR}/
@


1.1
log
@more templateering woes
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/netboot.me/Makefile,v 1.2 2010/01/30 13:19:08 tg Exp $
d32 1
@

