head	1.18;
access;
symbols;
locks; strict;
comment	@# @;


1.18
date	2018.04.28.06.05.11;	author tg;	state Exp;
branches;
next	1.17;
commitid	1005AE40F322F95292C;

1.17
date	2018.04.28.03.24.45;	author tg;	state Exp;
branches;
next	1.16;
commitid	1005AE3E98441347FF5;

1.16
date	2010.01.17.00.35.08;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004B525B3629110DD5;

1.15
date	2009.08.20.13.05.51;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004A8D4A466FA1C519;

1.14
date	2009.08.11.15.31.34;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004A818EED47422ACF;

1.13
date	2009.08.11.15.30.47;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004A818EBF49B1E6B5;

1.12
date	2009.06.29.19.43.33;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004A49196E0A8C7E20;

1.11
date	2009.06.29.17.08.28;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004A48F4DB6BC02B75;

1.10
date	2009.04.16.13.20.23;	author tg;	state Exp;
branches;
next	1.9;
commitid	10049E73089575F8D71;

1.9
date	2008.10.30.17.47.33;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004909F292493E4BFA;

1.8
date	2008.10.21.19.57.37;	author tg;	state Exp;
branches;
next	1.7;
commitid	10048FE342C64FB53F7;

1.7
date	2008.10.21.19.39.21;	author tg;	state Exp;
branches;
next	1.6;
commitid	10048FE2FE455E7E586;

1.6
date	2008.10.21.01.43.01;	author tg;	state Exp;
branches;
next	1.5;
commitid	10048FD33B40F8593B0;

1.5
date	2008.10.21.01.35.59;	author tg;	state Exp;
branches;
next	1.4;
commitid	10048FD319B20D7BD36;

1.4
date	2008.08.05.22.48.46;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004898D8A016CF755D;

1.3
date	2008.08.05.19.25.17;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004898A92C47002890;

1.2
date	2008.08.05.19.19.58;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004898A7E37E7F803E;

1.1
date	2008.07.12.22.06.13;	author tg;	state Exp;
branches;
next	;
commitid	10048792AAF4F6C5252;


desc
@@


1.18
log
@shrink until it hurts
@
text
@# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.15 2009/08/20 13:05:51 tg Exp $
# $OpenBSD: Makefile.inc,v 1.14 2002/05/01 19:21:28 mickey Exp $

RAWLABEL=
IMAGESIZE=	3616
IMAGETYPE=	ipldisc
AOUT_BSDRD=	Yes
FLOPPY=		no
KMAKE_EXTRA+=	SPARC_AUTO_NODBGSYM=Yes

LISTADDS=	boot cd9660 dhclient disktools msdos nettools nfs no-huge \
		pager-more ppp-off sparc upgrade

cdrom-mdcopy:
	cp ${WRKDIR}/b_sparc.ldr ${WRKDIR}/v${OSrev}/${MACHINE}/boot.net
	# fix path to default kernel file in second-stage boot loader
	set -A dump -- $$(dd if=${WRKDIR}/b_sparc.ldr bs=4 count=64 | \
	    hexdump -ve '1/1 "%02X"' | sed 's/\(........\)/ \1/g'); i=0; \
	while (( i < 64 )); do [[ $${dump[i++]} = 2035560? ]] && break; done; \
	if [[ $$i = 64 || $${dump[i-1]} != 20355601 ]]; then \
		print -u2 found invalid or no patch field version; exit 1; \
	fi; ofs=$$((#0x$${dump[i+1]})); \
	print -n v${OSrev}/${MACHINE}/bsd.rd\\0 | \
	    dd of=${WRKDIR}/b_${MACHINE}.ldr bs=1 seek=$$ofs conv=notrunc
	ln ${WRKDIR}/v${OSrev}/${MACHINE}/bsd.rd ${WRKDIR}/vmunix # for kicks

cdrom-mdboot:
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | ${MKSH} ${BOOTSH} \
	    -g $$((#$$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
	    -0 24 -S 2 | dd of=${CDROM} conv=notrunc 2>/dev/null
@


1.17
log
@attempt to make the sparc bsd.rd automatically marked nodbgsym if necessary
@
text
@d5 1
a5 1
IMAGESIZE=	3712
@


1.16
log
@• modularise floppy configuration and let sparc/floppy use the common one,
  adding some to it
• nuke printf(1) we have mksh(1) print builtin
@
text
@d9 1
@


1.15
log
@pasto
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.14 2009/08/11 15:31:34 tg Exp $
d10 3
@


1.14
log
@more similar code
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.13 2009/08/11 15:30:47 tg Exp $
d11 1
a11 1
	cp ${WRKDIR}/b_sparc.ldr v${OSrev}/${MACHINE}/boot.net
@


1.13
log
@a boot.net file can be helpful for obsd/sol converts
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.12 2009/06/29 19:43:33 tg Exp $
d11 1
a11 1
	cp ${BOOT} v${OSrev}/${MACHINE}/boot.net
@


1.12
log
@better safe than sorry, use unsigned arithmetics (2G vs 4G ISOs, etc.)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.11 2009/06/29 17:08:28 tg Exp $
d11 1
@


1.11
log
@pad ISOs manually (without makefs(8)' help) to the correct geometry
not by 「dd conv=osync」 or truncating after makefs had padded, but
by telling makefs to not pad, calculating the missing amount of NUL
bytes ourselves, and simply appending them (faster than osync)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.10 2009/04/16 13:20:23 tg Exp $
d17 1
a17 1
	fi; ofs=$$((0x$${dump[i+1]})); \
d24 1
a24 1
	    -g $$(($$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
@


1.10
log
@• make use of the imbedded patch area to note the file(!) offset of
  the __defkernel patch field (and with possible future extensions)
• strip /usr/mdec/boot now by default ☺
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.9 2008/10/30 17:47:33 tg Exp $
a8 2
# no need as long as it's < 300 KiB and makefs -o no-trailing-padding isn't used
#CDROM_PAD=	16 * 32
@


1.9
log
@improve padding scenarios:
• as we do not use makefs(8) -o no-trailing-padding, an extra 300 KiB
  is *always* added (not padded) at the end of the ISO 9660 filesy-
  stem, thusly we can just truncate to a padding of 256 KiB
• bigger padding (256 KiB ipv 64 KiB) reduces number of cylinders
• no need to dd(1) if we can mv(1)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.8 2008/10/21 19:57:37 tg Exp $
d14 6
a19 10
	set -A sect_text -- $$(objdump -wh --target=a.out-sunos-big \
	    ${WRKDIR}/b_${MACHINE}.ldr | fgrep .text); \
	(( fofs_text = 0x$${sect_text[5]} )); \
	nm --target=a.out-sunos-big ${WRKDIR}/b_${MACHINE}.ldr |& \
	while read -p adr typ sym; do \
		[[ $$sym = @@(___defkernel|_start) ]] || continue; \
		eval typeset -i10 sym$$sym=0x\$$adr; \
	done; \
	typeset -Uui10 ofs; \
	(( ofs = sym___defkernel - sym_start + fofs_text )); \
a21 1
	strip --target=a.out-sunos-big ${WRKDIR}/b_${MACHINE}.ldr
@


1.8
log
@strip sparc bootloader after patching, as we won’t need the symbol table
any more further on anyway, to save even more space (tested in qemu-snap)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.7 2008/10/21 19:39:21 tg Exp $
d9 2
a10 1
CDROM_PAD=	8 * 16
d31 1
a31 1
	    -g $$(($$(stat -f %z ${CDROM}) / (512 * 16 * 8))):8:16 \
@


1.7
log
@• instead of copying the kernel to /bsd, force the sparc second-stage
  bootloader on the ISO to default to /v${OSrev}/${MACHINE}/bsd.rd
• there is no boot.cfg for sparc
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.6 2008/10/21 01:43:01 tg Exp $
d25 1
@


1.6
log
@… this is what I mean by testing ;-)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.5 2008/10/21 01:35:59 tg Exp $
d12 13
a25 1
	ln ${WRKDIR}/v${OSrev}/${MACHINE}/bsd.rd ${WRKDIR}/bsd	# no comment…
@


1.5
log
@use some sensible geometry for the CD:
pad it up to “cylinders” of 8 heads, 16 sectors per track (in the worst
case, this is a loss of 62 KiB, but we pad with 300 KiB anyway, so the
percentage is low), and use this for the Sun disklabel, so that it now
exactly matches the real image size for all four slices (a, b, c, d)

XXX distrib/common clean target seems botched
XXX untested
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.4 2008/08/05 22:48:46 tg Exp $
d9 1
a9 1
CDROM_PAD=	8*16
@


1.4
log
@• replace uses of mkisofs.log file with new getextent_cd9660(1) tool
• remove -N -d -D -L: our bootloader can actually handle standard
  _conformant_ ISO 9660 filesystems… apparently unlike others’
• remove -f: no symlinks in the source tree
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.3 2008/08/05 19:25:17 tg Exp $
d9 1
d16 3
a18 3
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | \
	    ${MKSH} ${BOOTSH} -0 24 -S 2 | \
	    dd of=${CDROM} conv=notrunc 2>/dev/null
@


1.3
log
@split cdrom-mdboot better
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.2 2008/08/05 19:19:58 tg Exp $
d15 1
a15 1
	fgrep ${WRKDIR}/b_${MACHINE}.ldr mkisofs.log | \
@


1.2
log
@switch away from using mkisofs’ boot info table, for now and forever, or so…
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc-big,v 1.1 2008/07/12 22:06:13 tg Exp $
d15 3
@


1.1
log
@• sparc, i386: rmdir stuff only for i386-big
• sparc: add upgrade.sh
• move sparc bsd.rd from common+sparc to common/extra+sparc-big
• new sparc: stub for floppy building (experimental)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.sparc,v 1.10 2007/10/20 22:44:40 tg Exp $
d13 2
@

