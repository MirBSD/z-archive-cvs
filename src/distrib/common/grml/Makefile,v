head	1.10;
access;
symbols;
locks; strict;
comment	@# @;


1.10
date	2010.01.30.14.31.03;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004B6442BD5D9B6EF8;

1.9
date	2010.01.30.13.20.42;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004B64324239CADD71;

1.8
date	2010.01.30.13.19.08;	author tg;	state Exp;
branches;
next	1.7;
commitid	1004B6431E205819FE4;

1.7
date	2009.06.29.19.43.33;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004A49196E0A8C7E20;

1.6
date	2009.06.29.18.39.55;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004A490A8B3CDC3881;

1.5
date	2009.06.29.18.18.59;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004A49058C651D7FC1;

1.4
date	2009.06.29.16.47.10;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004A48F00F149883CE;

1.3
date	2009.06.07.13.13.18;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004A2BBCF702DB98DA;

1.2
date	2009.01.24.19.15.46;	author tg;	state Exp;
branches;
next	1.1;
commitid	100497B68F70DECC10E;

1.1
date	2009.01.18.15.54.49;	author tg;	state Exp;
branches;
next	;
commitid	100497350DB6B434B9D;


desc
@@


1.10
log
@more templateering woes
@
text
@# $MirOS: src/distrib/common/extra/Makefile,v 1.3 2008/07/12 22:06:16 tg Exp $

TOPDIR=		${.CURDIR}/../..

MACHCONF=	Grml

.include "../Makefile"
@


1.9
log
@flatten
@
text
@d1 1
a1 3
# $MirOS: src/distrib/common/grml/Makefile,v 1.8 2010/01/30 13:19:08 tg Exp $

.include <bsd.own.mk>
a3 30
CBIN=		instbin

IMAGESIZE=	8192
IMAGETYPE=	ipldisc

KERNEL_BUILD=	no
#		(17,0) = rd0a
RAMDISK_PREP=	print 'rootdev 17 0\nquit' | config -ef $@@

FLOPPY=		no
.if exists(${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/.)
BOOT=		ldbsd.iso
DO_LIVEBOOT=	#defined
.endif
CDROM=		bsd4grml.iso
CDROM_OPTS+=	bootimage=i386\;eltorito.loo
CDROM_OPTS+=	no-emul-boot

CLEANFILES+=	ldbsd.* LICENCE.TXT gpl_srcs.tgz

all: templates/bsd4grml.stamp

bsd: ${BSDOBJDIR}/distrib/generic/bsd
	cp -f $> $@@

LISTADDS=	boot cd9660 dhclient disktools ext2fs i386 isdn msdos \
		nettools nfs nfsd pager-less ppp-user pppoe-kernel \
		pppoe-user
MACHCONF:=	i386-big
LISTADDS+=	Grml
d5 1
a5 19
${CBIN}.conf: gnustuff

gnustuff: .PHONY
	for dir in ${.CURDIR}/tinyirc ${TOPDIR}/../contrib/gnu/e3; do \
		(cd $$dir && ${MAKE} obj && ${MAKE} depend && ${MAKE}); \
	done
	cd ${TOPDIR}/../share/doc/legal && ${MAKE} grml
	cp ${REALOBJDIR}/../../../share/doc/legal/grml LICENCE.TXT
	rm -rf gplsrcs
	mkdir -p gplsrcs/{e3,tinyirc}
	cp ${TOPDIR}/../contrib/gnu/e3/{Makefile,README,e3.*} gplsrcs/e3/
	cp ${TOPDIR}/../contrib/code/Snippets/tinyirc.c gplsrcs/tinyirc/
	(cd gplsrcs && find * -type f | sort | cpio -oC512 -Hustar -Mdist | \
	    gzip -n9) >gpl_srcs.tgz

cleannobsd: clean_grmldirs

clean_grmldirs:
	-rm -rf gplsrcs templates
a7 48

cdrom-prepare: ldbsd.stamp

ldbsd.stamp:
.ifdef DO_LIVEBOOT
	cd ${.CURDIR}/../../../sys/arch/i386/stand/liveboot; \
	    ${MAKE} BSD4GRML=iso cleandir && \
	    ${MAKE} BSD4GRML=iso depend && \
	    exec ${MAKE} BSD4GRML=iso NOMAN=Yes
	cp ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/boot ldbsd.iso
	cd ${.CURDIR}/../../../sys/arch/i386/stand/liveboot; \
	    ${MAKE} BSD4GRML=Yes cleandir && \
	    ${MAKE} BSD4GRML=Yes depend && \
	    exec ${MAKE} BSD4GRML=Yes
	cp ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/boot ldbsd.com
	cp ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/ldbsd.txt .
	@@:>$@@
.else
	@@echo 'need [[ -d ${REALOBJDIR}/../../../sys/arch/i386/stand/liveboot/. ]]'
	@@exit 1
.endif

templates/bsd4grml.stamp: ${CDROM}

cdrom-mdcopy:
	dd if=/dev/arandom bs=2048 count=1 of=eltorito.loo
	-rm -rf templates
	mkdir -p templates/boot/addons/bsd4grml
	mv ${WRKDIR}/v${OSrev}/${MACHINE}/bsd.rd templates/boot/addons/bsd4grml/
	cd ${WRKDIR} && rm -rf *
	cp ${.CURDIR}/boot.* LICENCE.TXT gpl_srcs.tgz ldbsd.{com,iso,txt} \
	    templates/boot/addons/bsd4grml/
	chmod 0644 templates/boot/addons/bsd4grml/*
	cd templates && pax -rw -l -pe boot ${WRKDIR}/
	rm -f templates/boot/addons/bsd4grml/ldbsd.iso
	ln ${WRKDIR}/boot/addons/bsd4grml/ldbsd.iso ${WRKDIR}/b_${MACHINE}.ldr
	@@:>templates/bsd4grml.stamp

cdrom-mdboot:
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | \
	    ${MKSH} ${BOOTSH} \
	    -g $$((#$$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
	    -A -M 4:0x96 -S 2 | \
	    dd of=${CDROM} conv=notrunc 2>/dev/null
	getextent_cd9660 -f ${CDROM} b_${MACHINE}.ldr | \
	    ${MKSH} ${BOOTSH} -B 11 | \
	    dd of=${CDROM} conv=notrunc bs=2048 seek=$$(getextent_cd9660 \
	    -f ${CDROM} -b '$$BootImage$$') 2>/dev/null
@


1.8
log
@adjust to new listadd scheme the Grml and netboot.me ISOs
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.7 2009/06/29 19:43:33 tg Exp $
d33 1
a33 1
		pppoe-user upgrade
@


1.7
log
@better safe than sorry, use unsigned arithmetics (2G vs 4G ISOs, etc.)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.6 2009/06/29 18:39:55 tg Exp $
d31 5
a35 3
MACHCONF=	nonexistant
LISTS=		${TOPDIR}/common/listbeg.i386-big ${TOPDIR}/common/list \
		${TOPDIR}/common/listend.i386-big ${TOPDIR}/common/grml/listadd
@


1.6
log
@generate the templates/ directory too, and tweak a little
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.5 2009/06/29 18:18:59 tg Exp $
d97 1
a97 1
	    -g $$(($$(stat -f %z ${CDROM}) / (512 * 32 * 16))):16:32 \
@


1.5
log
@create an ISO (and the target files separately)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.4 2009/06/29 16:47:10 tg Exp $
d26 2
d50 1
a50 1
cleandir: clean_gplsrcs
d52 2
a53 2
clean_gplsrcs:
	-rm -rf gplsrcs
d78 2
d82 11
a92 9
	cd ${WRKDIR} && \
	    mkdir -p boot/addons/bsd4grml && \
	    mv v${OSrev}/${MACHINE}/bsd.rd boot/addons/bsd4grml/ && \
	    rm -rf contrib v${OSrev} 00-README boot.cfg
	cp ${.CURDIR}/boot.* ${WRKDIR}/boot/addons/bsd4grml/
	cp LICENCE.TXT gpl_srcs.tgz ldbsd.{com,txt} \
	    ${WRKDIR}/boot/addons/bsd4grml/
	ln ${WRKDIR}/b_${MACHINE}.ldr ${WRKDIR}/boot/addons/bsd4grml/ldbsd.iso
	chmod 0644 ${WRKDIR}/boot/addons/bsd4grml/*
@


1.4
log
@similarily for the bsd4grml standalone ISOs, which arenâ€™t really generated
(XXX fix this, we currently need them for grml DVDs)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.3 2009/06/07 13:13:18 tg Exp $
d16 5
a20 1
CDROM=		no
d24 2
d39 13
d55 20
a74 1
# for testing this in stand-alone mode
d78 9
a97 3

cdrom-test: .PHONY
	cd ${.CURDIR} && exec ${MAKE} CDROM=cdrom${OSrev}.iso
@


1.3
log
@use bxinst.i386 -A option for ISOs HDD boot function
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.2 2009/01/24 19:15:46 tg Exp $
d43 3
a45 1
	    ${MKSH} ${BOOTSH} -A -S 2 | \
@


1.2
log
@add debugging stuff
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/grml/Makefile,v 1.1 2009/01/18 15:54:49 tg Exp $
d43 1
a43 1
	    ${MKSH} ${BOOTSH} -S 2 | \
@


1.1
log
@add the rest of the grmlisator
@
text
@d1 1
a1 1
# $MirOS$
d17 2
d35 17
@

