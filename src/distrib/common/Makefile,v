head	1.71;
access;
symbols
	MIRBSD_10:1.28.0.2
	MIRBSD_10_BASE:1.28
	MIRBSD_9_BASE:1.1;
locks; strict;
comment	@# @;


1.71
date	2019.01.05.13.30.50;	author tg;	state Exp;
branches;
next	1.70;
commitid	1005C30B1A05E192EA5;

1.70
date	2018.01.07.23.27.31;	author tg;	state Exp;
branches;
next	1.69;
commitid	1005A52ACF9654215C5;

1.69
date	2017.01.29.00.51.03;	author tg;	state Exp;
branches;
next	1.68;
commitid	100588D3C8F09DC1F20;

1.68
date	2016.01.02.20.05.05;	author tg;	state Exp;
branches;
next	1.67;
commitid	10056882D871C1C3E41;

1.67
date	2015.10.24.21.59.03;	author tg;	state Exp;
branches;
next	1.66;
commitid	100562BFF3657F6BB88;

1.66
date	2015.01.02.13.54.17;	author tg;	state Exp;
branches;
next	1.65;
commitid	10054A6A31E3A41516F;

1.65
date	2014.01.04.20.24.57;	author tg;	state Exp;
branches;
next	1.64;
commitid	10052C86E2F00C31DB5;

1.64
date	2013.09.15.11.01.24;	author tg;	state Exp;
branches;
next	1.63;
commitid	1005235938A2629E92C;

1.63
date	2013.01.01.17.31.06;	author tg;	state Exp;
branches;
next	1.62;
commitid	10050E31D6B7FB977FF;

1.62
date	2012.09.02.22.14.45;	author tg;	state Exp;
branches;
next	1.61;
commitid	1005043DA6D20CE1B7A;

1.61
date	2012.09.02.15.16.29;	author tg;	state Exp;
branches;
next	1.60;
commitid	100504378544281C2A0;

1.60
date	2012.09.02.12.34.22;	author tg;	state Exp;
branches;
next	1.59;
commitid	1005043526618413EC2;

1.59
date	2012.09.02.12.31.41;	author tg;	state Exp;
branches;
next	1.58;
commitid	100504351C55789E9FE;

1.58
date	2012.01.14.18.59.31;	author tg;	state Exp;
branches;
next	1.57;
commitid	1004F11D0A671854233;

1.57
date	2011.01.03.17.49.37;	author tg;	state Exp;
branches;
next	1.56;
commitid	1004D220C4445D53F23;

1.56
date	2010.08.06.20.28.37;	author tg;	state Exp;
branches;
next	1.55;
commitid	1004C5C708C20EA8D77;

1.55
date	2010.08.06.20.27.50;	author tg;	state Exp;
branches;
next	1.54;
commitid	1004C5C705750224562;

1.54
date	2010.08.06.15.40.01;	author tg;	state Exp;
branches;
next	1.53;
commitid	1004C5C2C6D79827EDA;

1.53
date	2010.01.17.00.35.07;	author tg;	state Exp;
branches;
next	1.52;
commitid	1004B525B3629110DD5;

1.52
date	2010.01.16.23.36.45;	author tg;	state Exp;
branches;
next	1.51;
commitid	1004B524D9A6D7BE1E2;

1.51
date	2010.01.11.01.15.54;	author tg;	state Exp;
branches;
next	1.50;
commitid	1004B4A7BDC7E9F8DD2;

1.50
date	2010.01.10.21.09.54;	author tg;	state Exp;
branches;
next	1.49;
commitid	1004B4A42324C8E3C80;

1.49
date	2010.01.07.20.56.07;	author tg;	state Exp;
branches;
next	1.48;
commitid	1004B464A630F817F6F;

1.48
date	2010.01.06.18.52.21;	author tg;	state Exp;
branches;
next	1.47;
commitid	1004B44DBF909E317C9;

1.47
date	2009.08.15.18.24.42;	author tg;	state Exp;
branches;
next	1.46;
commitid	1004A86FD7C442C85D6;

1.46
date	2009.06.29.19.43.33;	author tg;	state Exp;
branches;
next	1.45;
commitid	1004A49196E0A8C7E20;

1.45
date	2009.06.29.18.49.04;	author tg;	state Exp;
branches;
next	1.44;
commitid	1004A490CAD5BCFB0E5;

1.44
date	2009.06.29.18.47.55;	author tg;	state Exp;
branches;
next	1.43;
commitid	1004A490C450C8E4EFB;

1.43
date	2009.06.29.17.37.34;	author tg;	state Exp;
branches;
next	1.42;
commitid	1004A48FBE7321A12CB;

1.42
date	2009.06.29.17.08.28;	author tg;	state Exp;
branches;
next	1.41;
commitid	1004A48F4DB6BC02B75;

1.41
date	2009.01.17.12.21.01;	author tg;	state Exp;
branches;
next	1.40;
commitid	1004971CD4344697E68;

1.40
date	2008.10.30.17.47.33;	author tg;	state Exp;
branches;
next	1.39;
commitid	1004909F292493E4BFA;

1.39
date	2008.10.21.19.39.21;	author tg;	state Exp;
branches;
next	1.38;
commitid	10048FE2FE455E7E586;

1.38
date	2008.10.21.19.04.54;	author tg;	state Exp;
branches;
next	1.37;
commitid	10048FE27E01D8D9CE5;

1.37
date	2008.10.21.01.43.01;	author tg;	state Exp;
branches;
next	1.36;
commitid	10048FD33B40F8593B0;

1.36
date	2008.10.21.01.37.04;	author tg;	state Exp;
branches;
next	1.35;
commitid	10048FD32532EF31514;

1.35
date	2008.10.21.01.35.57;	author tg;	state Exp;
branches;
next	1.34;
commitid	10048FD319B20D7BD36;

1.34
date	2008.10.05.16.26.16;	author tg;	state Exp;
branches;
next	1.33;
commitid	10048E8EA7D6EAD401E;

1.33
date	2008.08.06.00.28.37;	author tg;	state Exp;
branches;
next	1.32;
commitid	1004898F04165AB89FE;

1.32
date	2008.08.05.22.48.45;	author tg;	state Exp;
branches;
next	1.31;
commitid	1004898D8A016CF755D;

1.31
date	2008.08.05.19.25.16;	author tg;	state Exp;
branches;
next	1.30;
commitid	1004898A92C47002890;

1.30
date	2008.08.05.19.19.58;	author tg;	state Exp;
branches;
next	1.29;
commitid	1004898A7E37E7F803E;

1.29
date	2008.03.15.22.23.04;	author tg;	state Exp;
branches;
next	1.28;
commitid	10047DC4C5E4800B348;

1.28
date	2007.10.20.23.30.40;	author tg;	state Exp;
branches;
next	1.27;
commitid	100471A8F9932BF985D;

1.27
date	2007.10.20.22.44.40;	author tg;	state Exp;
branches;
next	1.26;
commitid	100471A84E479B84A8D;

1.26
date	2007.10.01.20.53.45;	author tg;	state Exp;
branches;
next	1.25;
commitid	10047015E696BD7B698;

1.25
date	2007.10.01.20.50.49;	author tg;	state Exp;
branches;
next	1.24;
commitid	10047015DB118D4B0ED;

1.24
date	2007.07.18.09.04.10;	author tg;	state Exp;
branches;
next	1.23;
commitid	100469DD7687BA1D07D;

1.23
date	2007.07.07.22.02.41;	author tg;	state Exp;
branches;
next	1.22;
commitid	10046900D300D91247A;

1.22
date	2007.05.24.22.19.15;	author tg;	state Exp;
branches;
next	1.21;
commitid	10046560F7A5EF7D607;

1.21
date	2007.05.24.20.15.57;	author tg;	state Exp;
branches;
next	1.20;
commitid	1004655F28D21BD63C0;

1.20
date	2007.01.30.22.42.05;	author tg;	state Exp;
branches;
next	1.19;
commitid	10045BFC9D207524C68;

1.19
date	2007.01.26.19.33.10;	author tg;	state Exp;
branches;
next	1.18;
commitid	10045BA577D1DF64163;

1.18
date	2007.01.26.19.14.33;	author tg;	state Exp;
branches;
next	1.17;
commitid	10045BA53263C21EB6C;

1.17
date	2007.01.26.19.08.04;	author tg;	state Exp;
branches;
next	1.16;
commitid	10045BA519F678C4849;

1.16
date	2006.10.14.23.20.07;	author tg;	state Exp;
branches;
next	1.15;
commitid	100453170B62E6F6DAF;

1.15
date	2006.10.13.19.18.02;	author tg;	state Exp;
branches;
next	1.14;
commitid	100452FE67757921301;

1.14
date	2006.09.29.22.25.35;	author tg;	state Exp;
branches;
next	1.13;
commitid	100451D9D66097EBA5E;

1.13
date	2006.08.19.18.32.01;	author tg;	state Exp;
branches;
next	1.12;
commitid	10044E7593214C9D65E;

1.12
date	2006.08.19.15.22.47;	author tg;	state Exp;
branches;
next	1.11;
commitid	10044E72CDC4BDCB845;

1.11
date	2006.08.19.15.00.42;	author tg;	state Exp;
branches;
next	1.10;
commitid	10044E727AE60C8E939;

1.10
date	2006.08.19.14.57.56;	author tg;	state Exp;
branches;
next	1.9;
commitid	10044E727084DEE47A5;

1.9
date	2006.08.19.11.59.39;	author tg;	state Exp;
branches;
next	1.8;
commitid	10044E6FD395499E6C5;

1.8
date	2006.08.19.11.46.07;	author tg;	state Exp;
branches;
next	1.7;
commitid	10044E6FA0335217B0F;

1.7
date	2006.08.18.21.41.25;	author tg;	state Exp;
branches;
next	1.6;
commitid	10044E63411311312CF;

1.6
date	2006.08.18.21.36.29;	author tg;	state Exp;
branches;
next	1.5;
commitid	10044E6324B5104F24D;

1.5
date	2006.08.18.21.08.02;	author tg;	state Exp;
branches;
next	1.4;
commitid	10044E62C491BAE1536;

1.4
date	2006.08.18.20.48.46;	author tg;	state Exp;
branches;
next	1.3;
commitid	10044E627C4580B7224;

1.3
date	2006.08.17.14.17.46;	author tg;	state Exp;
branches;
next	1.2;
commitid	10044E47A7563EFA504;

1.2
date	2006.08.17.14.09.20;	author tg;	state dead;
branches;
next	1.1;
commitid	10044E4787416A4A520;

1.1
date	2006.06.08.23.52.20;	author tg;	state Exp;
branches;
next	;
commitid	1004488B8437EBFFF12;


desc
@@


1.71
log
@2019
@
text
@# $MirOS: src/distrib/common/Makefile,v 1.70 2018/01/07 23:27:31 tg Exp $

.include <bsd.own.mk>

# common variables
REALOBJDIR!=	realpath ${.OBJDIR}
TOPDIR?=	${.CURDIR}/..
SYSDIR=		${TOPDIR}/../sys
MACHCONF?=	${MACHINE}

.if exists(${TOPDIR}/common/Makefile.${MACHCONF})
.  include "${TOPDIR}/common/Makefile.${MACHCONF}"
.endif

# compiler options
.if ${COPTS:M-O*:N-Os}
COPTS+=		-Os
.endif
.if !${COPTS:M-Os}
COPTS+=		-Os
.endif
CFLAGS+=	${CDIAGFLAGS} ${COPTS}
HOSTCFLAGS?=	${CFLAGS}

# temporary mounts
WRKDIR=		${REALOBJDIR}/tmpdata
TMPMOUNT=	${REALOBJDIR}/tmpmnt
VND?=		svnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
RAWLABEL?=	-r

# tools selection
RDSETROOT?=	elfrdsetroot
CRUNCHGENOPTS?=	-E
STRIP?=		strip
STRIP_CBIN?=	--strip-all -R .comment -R .eh_frame
STRIP_KERNEL?=	--strip-all -R .comment -R .eh_frame

# crunched binary and ramdisk (miniroot filesystem)
CBIN?=		instbin
LISTS?=		${TOPDIR}/common/listbeg.${MACHCONF} ${TOPDIR}/common/list \
		${TOPDIR}/common/listend.${MACHCONF}
.for _i in ${LISTADDS}
LISTS+=		${TOPDIR}/common/listadd.${_i}
.endfor
MTREE?=		${TOPDIR}/common/mtree.conf
IMAGE?=		ramdisk${OSrev}.fs
IMAGESIZE?=	3584
IMAGEOPTS?=	minfree=0,optimization=space,bsize=4096,fsize=512,density=3072
IMAGETYPE?=	rdroot
IMAGE_PREP?=	@@:

# kernel (build one, create bsd.rd)
RAMDISK?=	RAMDISK
KERNEL_BUILD?=	Yes
KERNEL_BSDRD?=	Yes
BSDRD_COMPR?=	gzip -vn9
AOUT_BSDRD?=	No
RAMDISK_PREP?=	@@:

.if ${KERNEL_BUILD:L} != "no"
.  include "${TOPDIR}/common/Makefile.kernel"
.endif

# floppy (set to no to disable)
FLOPPY?=	floppy${OSrev}.fs
FLOPPYSIZE?=	2880
FLOPPYGEOM?=	80:2:18
FLOPPYFILES?=	boot bsd
BOOT?=		${DESTDIR}/usr/mdec/boot
BOOT_TAR?=	${DESTDIR}/usr/mdec/boot.fd
BOOTXX?=	${DESTDIR}/usr/mdec/bootxx
BOOTXX_TAR?=	cat ${DESTDIR}/usr/mdec/bootxx.tar -
BOOTSH?=	${DESTDIR}/usr/mdec/bootxx.sh

# compact disc image (set to no to disable)
CDROM?=		cdrom${OSrev}.iso
CDROM_OPTS+=	applicationid=NetBSD_makefs
CDROM_OPTS+=	label=MirOS~v${OSrev}~BSD/${MACHINE}~boot-only~CD
CDROM_OPTS+=	no-trailing-padding
CDROM_OPTS+=	preparer=MirBSD_and_contributors
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2019_MirBSD
CDROM_OPTS+=	rockridge
CDROM_OPTS+=	rr-squash
CDROM_OPTS+=	volumeid=$$(uname -slm | tr -- '- \#' :_):Setup
#CDROM_OPTS+=	v=1

#---

.if ${KERNEL_BSDRD:L} == "yes"
_RD_KERNELS=	bsd.rd
.  if ${AOUT_BSDRD:L} != "no"
_RD_KERNELS+=	bsd.rd.net
.  endif
.endif

ALL_TGTS=	${IMAGE} ${_RD_KERNELS} ${FLOPPY:S/^no$//} ${CDROM:S/^no$//}
INST_FILES?=	${_RD_KERNELS} ${FLOPPY:S/^no$//} ${CDROM:S/^no$//}
_RD_TARGETS?=	${_RD_KERNELS} ${FLOPPY:S/^no$//} ${CDROM:S/^no$//}

all: ${ALL_TGTS}

install:
.for _i in ${INST_FILES}
	${INSTALL} -c -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE} \
	    ${_i} ${DESTDIR}/snapshot/
.endfor

unconfig:
	-${SUDO} umount -f ${VND_DEV}
	-${SUDO} vnconfig -u ${VND}
	-${SUDO} rm -rf ${TMPMOUNT} ${WRKDIR} ${IMAGE}

cleannobsd: unconfig
	rm -f *core ${CBIN} ${CBIN}.{cache,conf,mk,unstripped} ${IMAGE} \
	    ${RDSETROOT} *.c *.o *.lo *.loo *~ bsd.uc ${_RD_TARGETS} \
	    ${CLEANFILES}

clean cleandir: cleannobsd
	rm -f bsd
.if ${KERNEL_BUILD:L} != "no"
	rm -rf build
.endif

${RDSETROOT}: ${TOPDIR}/common/${RDSETROOT}.c
	${HOSTCC} ${HOSTCFLAGS} -DDEBUG -o $@@ $>

${CBIN}.conf: ${LISTS}
	awk -f ${TOPDIR}/common/makeconf.awk CBIN=${CBIN} ${LISTS} >$@@

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CBIN}.conf
	crunchgen ${CRUNCHGENOPTS} -D ${BSDSRCDIR} -L ${DESTDIR}/usr/lib \
	    -c ${CBIN}.c -e ${CBIN} -m ${CBIN}.mk ${CBIN}.conf

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	${MAKE} -f ${CBIN}.mk all
	cp ${CBIN} ${CBIN}.unstripped
	${STRIP} ${STRIP_CBIN} ${CBIN}

${IMAGE}: ${CBIN}
	test ! -e ${TMPMOUNT} || (cd ${.CURDIR}; ${MAKE} unconfig)
	${SUDO} rm -rf ${WRKDIR}
	${SUDO} mkdir -p ${WRKDIR}
	${SUDO} mtree -Udef ${MTREE} -p ${WRKDIR}/
	OBJDIR=${REALOBJDIR:Q} TARGDIR=${WRKDIR:Q} TOPDIR=${TOPDIR:Q} \
	    DESTDIR=${DESTDIR:Q} BSDOBJDIR=${BSDOBJDIR:Q} \
	    ${SUDO} ${SHELL} ${TOPDIR}/common/runlist.sh ${LISTS}
	${SUDO} rm ${WRKDIR}/${CBIN}
	${SUDO} makefs -s ${IMAGESIZE}b -o ${IMAGEOPTS} ${IMAGE} ${WRKDIR}
.ifndef IMAGE_NO_ARND
	${SUDO} dd if=/dev/arandom bs=32 count=1 of=$@@ conv=notrunc
.endif
	sync
	${SUDO} mkdir -p ${TMPMOUNT}
	${SUDO} vnconfig -v -c ${VND} ${IMAGE}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${IMAGETYPE}
	${SUDO} mount -r ${VND_DEV} ${TMPMOUNT}
	${IMAGE_PREP}
	@@echo ""
	@@df -i ${TMPMOUNT}
	@@echo ""
	${SUDO} umount ${TMPMOUNT}
	${SUDO} fsck -fy ${VND_RDEV}
	${SUDO} vnconfig -v -u ${VND}
	${SUDO} rm -rf ${TMPMOUNT} ${WRKDIR}

bsd.uc: bsd ${IMAGE} ${RDSETROOT}
	-rm -f $@@ $@@~
	gzip -fd <bsd >$@@~
	${RAMDISK_PREP}
	${REALOBJDIR}/${RDSETROOT} $@@~ <${IMAGE}
	mv -f $@@~ $@@

bsd.rd: bsd.uc
	cp -f bsd.uc bsd.uc~
	config -ef bsd.uc~ <<<"quit"
	${BSDRD_COMPR} <bsd.uc~ >$@@
	-rm -f bsd.uc~

bsd.rd.net: bsd.uc
	cp -f bsd.uc bsd.uc~
	config -ef bsd.uc~ <<<"quit"
	${STRIP} ${STRIP_KERNEL} bsd.uc~
	elf2aout bsd.uc~ $@@ -b
	-rm -f bsd.uc~

FLOPPY_BOOTCFG?=@@:
${FLOPPY}: bsd.uc
	test ! -e ${TMPMOUNT} || (cd ${.CURDIR}; ${MAKE} unconfig)
	${SUDO} rm -rf ${WRKDIR} e~
	mkdir -p ${WRKDIR}
	cp -f bsd.uc bsd.uc~
	config -ef bsd.uc~ <<<"quit"
	${STRIP} ${STRIP_KERNEL} bsd.uc~
	gzip -vn9 <bsd.uc~ >${WRKDIR}/bsd
	-rm -f bsd.uc~
	${FLOPPY_BOOTCFG}
	dd if=/dev/zero of=${FLOPPY}~ count=${FLOPPYSIZE}
	(tar -b 1 -M dist -cf - -C ${WRKDIR} ${FLOPPYFILES} || touch e~) | \
	    ${BOOTXX_TAR} | dd of=${FLOPPY}~ conv=notrunc
	@@[[ ! -e e~ ]]
	(( $$(stat -f %z ${FLOPPY}~) == 512 * ${FLOPPYSIZE} ))
	mv -f ${FLOPPY}~ ${FLOPPY}
	rm -rf ${WRKDIR} e~

${CDROM}: cdrom-prepare cdrom-mdcopy cdrom-generate cdrom-mdboot

cdrom-prepare: bsd.uc
	${SUDO} rm -rf ${WRKDIR}
	mkdir -p ${WRKDIR}/v${OSrev}/${MACHINE}
	@@if [[ -e ${TOPDIR}/contrib ]]; then \
		echo Integrating contrib dir; \
		mkdir ${WRKDIR}/contrib; \
		cd ${TOPDIR}/contrib; \
		pax -v -rw -pe . ${WRKDIR}/contrib/; \
	fi
	cp ${BOOT} ${WRKDIR}/b_${MACHINE}.ldr
.if exists(${TOPDIR}/common/boot.cfg.${MACHINE})
	cp ${TOPDIR}/common/boot.cfg.${MACHINE} ${WRKDIR}/boot.cfg
.endif
.if defined(LGRUBCFG)
	mkdir -p ${WRKDIR}/boot/grub
	cp ${TOPDIR}/common/${LGRUBCFG}/loopback.* ${WRKDIR}/boot/grub/
.endif
	cp ${BOOTSH} ${WRKDIR}/v${OSrev}/${MACHINE}/
	cp -f bsd.uc bsd.uc~
	config -ef bsd.uc~ <<<"quit"
	${BSDRD_COMPR} <bsd.uc~ >${WRKDIR}/v${OSrev}/${MACHINE}/bsd.rd
	-rm -f bsd.uc~
	cp ${TOPDIR}/common/00-README ${WRKDIR}/
	chmod -R u+w ${WRKDIR}

cdrom-generate:
	chmod -R u+w ${WRKDIR}
	makefs -t cd9660 -o "$$(print -r -- ${CDROM_OPTS} | tr ' ~' ', ')" \
	    ${CDROM} ${WRKDIR}
	# pad the ISO with ]0;256K] NUL bytes, ie. for
	# a geometry of 16 heads, 32 sectors per track
	dd if=/dev/zero count=1 bs=$$((# (512 * 32 * 16) - \
	    ($$(stat -f %z ${CDROM}) % (512 * 32 * 16)) )) 2>&- >>${CDROM}

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.70
log
@2018
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.69 2017/01/29 00:51:03 tg Exp $
d83 2
a84 2
CDROM_OPTS+=	preparer=MirBSD_and_its_contributors
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2018_The_MirOS_Project
@


1.69
log
@2017
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.67 2015/10/24 21:59:03 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2017_The_MirOS_Project
@


1.68
log
@2016
@
text
@d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2016_The_MirOS_Project
@


1.67
log
@attempt at making the i386 floppy a tad smaller again
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.66 2015/01/02 13:54:17 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2015_The_MirOS_Project
@


1.66
log
@2015; another year of the rolling release (and yes, new snapshots will be coming soonish)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.65 2014/01/04 20:24:57 tg Exp $
d153 1
a153 1
	${SUDO} dd if=/dev/arandom bs=128 count=1 of=$@@ conv=notrunc
@


1.65
log
@2014
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.64 2013/09/15 11:01:24 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2014_The_MirOS_Project
@


1.64
log
@we can build SPARC again, but only with a tad more floppy squeezing
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.63 2013/01/01 17:31:06 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2013_The_MirOS_Project
@


1.63
log
@2013
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.62 2012/09/02 22:14:45 tg Exp $
d152 1
d154 1
@


1.62
log
@ensure each invocation puts on different hostent, for real now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.61 2012/09/02 15:16:29 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2012_The_MirOS_Project
@


1.61
log
@a stripped kernel does not allow randomisation, ok, sure‚Ä¶ but that's
no reason for config(8) to‚Ä¶ segfault! or even exit(1).
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.60 2012/09/02 12:34:22 tg Exp $
d61 1
a61 1
RAMDISK_PREP?=	config -ef $@@ <<<'quit'
d118 1
a118 1
	    ${RDSETROOT} *.c *.o *.lo *.loo *~ bsd.{uc,st} ${_RD_TARGETS} \
d168 2
a169 2
	-rm -f $@@
	gzip -fd <bsd >$@@
d171 2
a172 1
	${REALOBJDIR}/${RDSETROOT} $@@ <${IMAGE}
d175 11
a185 11
	-rm -f $@@
	config -ef $> <<<'quit'
	${BSDRD_COMPR} <$> >$@@

bsd.st: bsd.uc
	config -ef $> <<<'quit'
	cp -f $> $@@ && ${STRIP} ${STRIP_KERNEL} $@@ || (rm -f $@@; exit 1)

bsd.rd.net: bsd.st
	-rm -f $@@
	elf2aout $> $@@ -b
d188 1
a188 1
${FLOPPY}: bsd.st
d192 5
a196 1
	gzip -vn9 <bsd.st >${WRKDIR}/bsd
d208 1
a208 1
cdrom-prepare: bsd.rd
d225 5
a229 1
	cp bsd.rd ${BOOTSH} ${WRKDIR}/v${OSrev}/${MACHINE}/
@


1.60
log
@ensure every bsd.rd-ish file contains entropy, different from all others
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.58 2012/01/14 18:59:31 tg Exp $
a183 1
	config -ef $> <<<'quit'
a190 1
	config -ef bsd.st <<<'quit'
@


1.59
log
@fix possible mis-use of semi-finished rule result
@
text
@d61 1
a61 1
RAMDISK_PREP?=	@@:
d175 1
d179 1
d184 1
d192 1
@


1.58
log
@¬© 2012 (in most places where it‚Äôs appropriate)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.57 2011/01/03 17:49:37 tg Exp $
d178 1
a178 2
	cp -f $> $@@
	${STRIP} ${STRIP_KERNEL} $@@
@


1.57
log
@2011
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.56 2010/08/06 20:28:37 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2011_The_MirOS_Project
@


1.56
log
@narf!
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.55 2010/08/06 20:27:50 tg Exp $
d84 1
a84 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2010_The_MirOS_Project
@


1.55
log
@fix wrong subdir
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.54 2010/08/06 15:40:01 tg Exp $
d217 1
a217 1
	cp ${TOPDIR}/${LGRUBCFG}/loopback.* ${WRKDIR}/boot/grub/
@


1.54
log
@I promised ¬´Jordan_U:#grml¬ª our next version would have support for the
boot method via /boot/grub/loopback.cfg ‚Äì voil√† (untested)

In MirOS bsd4grml, all options except chaining to GRUB are available.
In MirOS bsd4me, the install and baselive images, only the standard
bootloader prompt going to the installer is available, although the
command line gives support for e.g. switching to serial console.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.53 2010/01/17 00:35:07 tg Exp $
d217 1
a217 1
	cp ${.CURDIR}/${LGRUBCFG}/loopback.* ${WRKDIR}/boot/grub/
@


1.53
log
@‚Ä¢ modularise floppy configuration and let sparc/floppy use the common one,
  adding some to it
‚Ä¢ nuke printf(1) we have mksh(1) print builtin
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.52 2010/01/16 23:36:45 tg Exp $
d215 4
@


1.52
log
@use the bootxx.sh for ustarfs on sparc
tested in qemu
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.51 2010/01/11 01:15:54 tg Exp $
d45 3
@


1.51
log
@un-commit debugging code, oeps
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.50 2010/01/10 21:09:54 tg Exp $
d67 1
d72 1
a72 1
BOOTXX_TAR?=	${DESTDIR}/usr/mdec/bootxx.tar
a186 1
	cp ${BOOT_TAR} ${WRKDIR}/boot
d191 1
a191 1
	    cat ${BOOTXX_TAR} - | dd of=${FLOPPY}~ conv=notrunc
@


1.50
log
@experimental ustar format boot floppies
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.49 2010/01/07 20:56:07 tg Exp $
d173 3
a175 3
#bsd.st: bsd.uc
#	cp -f $> $@@
#	${STRIP} ${STRIP_KERNEL} $@@
@


1.49
log
@add auto-network-and-sshd ISO variant, requested by Vutral
thanks for the good idea - we'll provide it by default from now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.48 2010/01/06 18:52:21 tg Exp $
d67 1
a67 4
FLOPPYSECS?=	18
FLOPPYOPTS?=	minfree=0,optimization=space,bsize=4096,fsize=512
FLOPPYTYPE?=	floppy3
INSTALLBOOT?=	${DESTDIR}/usr/mdec/installboot -h 2 -s ${FLOPPYSECS}
d69 1
d71 1
d173 3
a175 3
bsd.st: bsd.uc
	cp -f $> $@@
	${STRIP} ${STRIP_KERNEL} $@@
d184 1
a184 1
	${SUDO} rm -rf ${WRKDIR}
d186 1
a186 1
	cp ${BOOT} ${WRKDIR}/boot
d189 7
a195 15
	${SUDO} chown -R 0:0 ${WRKDIR}
	${SUDO} chmod -R u=rwX,go=rX ${WRKDIR}
	${SUDO} makefs -s ${FLOPPYSIZE}b -o ${FLOPPYOPTS} ${FLOPPY} ${WRKDIR}
	mkdir -p ${TMPMOUNT}
	${SUDO} vnconfig -v -c ${VND} ${FLOPPY}
	${SUDO} disklabel -w ${RAWLABEL} ${VND} ${FLOPPYTYPE}
	${SUDO} mount -r ${VND_DEV} ${TMPMOUNT}
	${SUDO} ${INSTALLBOOT} -v ${TMPMOUNT}/boot ${BOOTXX} ${VND_CRDEV}
	@@echo ""
	@@df -i ${TMPMOUNT}
	@@echo ""
	${SUDO} umount ${TMPMOUNT}
	${SUDO} fsck -fy ${VND_RDEV}
	${SUDO} vnconfig -v -u ${VND}
	${SUDO} rm -rf ${TMPMOUNT} ${WRKDIR}
@


1.48
log
@welcome to Y2k01
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.47 2009/08/15 18:24:42 tg Exp $
d56 1
d166 1
a166 1
	gzip -d <bsd >$@@
d172 1
a172 1
	gzip -vn9 <$> >$@@
@


1.47
log
@The same for floppies, and fix relative paths
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.46 2009/06/29 19:43:33 tg Exp $
d80 1
a80 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2009_The_MirOS_Project
@


1.46
log
@better safe than sorry, use unsigned arithmetics (2G vs 4G ISOs, etc.)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.45 2009/06/29 18:49:04 tg Exp $
d181 1
d188 1
@


1.45
log
@rename it to rr-squash (to squash uid, gid *and* perms)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.44 2009/06/29 18:47:55 tg Exp $
d228 1
a228 1
	dd if=/dev/zero count=1 bs=$$(( (512 * 32 * 16) - \
@


1.44
log
@introduce ‚Äú-o rr-squash-ugid‚Äù to squash UID and GID in rock ridge to 0,
similar to how mkisofs‚Äô option worked but not for the permissions, and
use it in the mini ISOs and the bsd4grml ISO4dvd
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.43 2009/06/29 17:37:34 tg Exp $
d82 1
a82 1
CDROM_OPTS+=	rr-squash-ugid
@


1.43
log
@add CLEANFILES as usual
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.42 2009/06/29 17:08:28 tg Exp $
d82 1
@


1.42
log
@pad ISOs manually (without makefs(8)' help) to the correct geometry
not by „Äådd conv=osync„Äç or truncating after makefs had padded, but
by telling makefs to not pad, calculating the missing amount of NUL
bytes ourselves, and simply appending them (faster than osync)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.41 2009/01/17 12:21:01 tg Exp $
d113 2
a114 1
	    ${RDSETROOT} *.c *.o *.lo *.loo *~ bsd.{uc,st} ${_RD_TARGETS}
@


1.41
log
@2009
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.40 2008/10/30 17:47:33 tg Exp $
a75 2
CDROM_PAD?=	1
# do *not* use no-trailing-padding
d78 1
d223 5
a227 7
	    ${CDROM}~ ${WRKDIR}
.if ${CDROM_PAD} == 1
	mv ${CDROM}~ ${CDROM}
.else
	dd if=${CDROM}~ of=${CDROM} obs=$$((${CDROM_PAD} * 512)) conv=osync
.endif
	-rm -rf ${WRKDIR} ${CDROM}~
@


1.40
log
@improve padding scenarios:
‚Ä¢ as we do not use makefs(8) -o no-trailing-padding, an extra 300 KiB
  is *always* added (not padded) at the end of the ISO 9660 filesy-
  stem, thusly we can just truncate to a padding of 256 KiB
‚Ä¢ bigger padding (256 KiB ipv 64 KiB) reduces number of cylinders
‚Ä¢ no need to dd(1) if we can mv(1)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.39 2008/10/21 19:39:21 tg Exp $
d81 1
a81 1
CDROM_OPTS+=	publisher=Copyright_\<c\>_2002=2008_The_MirOS_Project
@


1.39
log
@‚Ä¢ instead of copying the kernel to /bsd, force the sparc second-stage
  bootloader on the ISO to default to /v${OSrev}/${MACHINE}/bsd.rd
‚Ä¢ there is no boot.cfg for sparc
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.37 2008/10/21 01:43:01 tg Exp $
d77 1
d225 3
d229 1
@


1.38
log
@fix integrating a contrib dir (unused for a while, but makefs(8) does
not follow symbolic links)
@
text
@d213 1
d215 1
@


1.37
log
@‚Ä¶ this is what I mean by testing ;-)
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.36 2008/10/21 01:37:04 tg Exp $
d209 2
a210 2
		cd ${WRKDIR}/contrib; \
		lndir ${TOPDIR}/contrib; \
@


1.36
log
@fix the clean target
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.35 2008/10/21 01:35:57 tg Exp $
d113 1
a113 1
	    ${RDSETROOT} *.c *.o *.lo *~ bsd.{uc,st} ${_RD_TARGETS}
d222 1
a222 1
	dd if=${CDROM}~ of=${CDROM} obs=$$(${CDROM_PAD}*512) conv=osync
@


1.35
log
@use some sensible geometry for the CD:
pad it up to ‚Äúcylinders‚Äù of 8 heads, 16 sectors per track (in the worst
case, this is a loss of 62 KiB, but we pad with 300 KiB anyway, so the
percentage is low), and use this for the Sun disklabel, so that it now
exactly matches the real image size for all four slices (a, b, c, d)

XXX distrib/common clean target seems botched
XXX untested
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.34 2008/10/05 16:26:16 tg Exp $
d113 1
a113 1
	    ${RDSETROOT} *.c *.o *.lo* bsd.{uc,st} ${_RD_TARGETS}
@


1.34
log
@use mksh realpath builtin instead of readlink -f for canonicalisation

note: there‚Äôs still a readlink(1) call left in, for instance, mirmake;
this does not hurt because we initially assumed that readlink(1) does
exist anyway and bundled ours just because some do not have the ‚Äò-f‚Äô
option for realpath(2)isation
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.33 2008/08/06 00:28:37 tg Exp $
d76 1
d221 3
a223 2
	    ${CDROM} ${WRKDIR}
	-rm -rf ${WRKDIR}
@


1.33
log
@switch to NetBSD¬Æ makefs(8), with prejudice
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.32 2008/08/05 22:48:45 tg Exp $
d6 1
a6 1
REALOBJDIR!=	readlink -nf ${.OBJDIR}
@


1.32
log
@‚Ä¢ replace uses of mkisofs.log file with new getextent_cd9660(1) tool
‚Ä¢ remove -N -d -D -L: our bootloader can actually handle standard
  _conformant_ ISO 9660 filesystems‚Ä¶ apparently unlike others‚Äô
‚Ä¢ remove -f: no symlinks in the source tree
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.31 2008/08/05 19:25:16 tg Exp $
d76 7
a82 1
CDROM_MDOPTS?=
d219 2
a220 6
	mkisofs -r ${CDROM_MDOPTS} \
	    -P 'The http://mirbsd.de/ team and its contributors' \
	    -p 'Copyright ¬© 2002-2008 by The MirOS Project' \
	    -V 'MirOS #${OSrev} BSD/${MACHINE} boot-only CD' \
	    -volset "$$(uname -slm) Setup" -sysid "MirOSBSD" \
	    -pad -o ${CDROM} ${WRKDIR}
@


1.31
log
@split cdrom-mdboot better
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.30 2008/08/05 19:19:58 tg Exp $
d106 1
a106 1
	    ${RDSETROOT} *.c *.o *.lo* bsd.{uc,st} ${_RD_TARGETS} mkisofs.log
d213 1
a213 1
	mkisofs -r -f -L -d -D -N -v -v ${CDROM_MDOPTS} \
d218 1
a218 1
	    -pad -o ${CDROM} ${WRKDIR} 2>&1 | tee mkisofs.log
@


1.30
log
@switch away from using mkisofs‚Äô boot info table, for now and forever, or so‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.29 2008/03/15 22:23:04 tg Exp $
a218 3
	fgrep ${WRKDIR}/b_${MACHINE}.ldr mkisofs.log | \
	    ${MKSH} ${BOOTSH} -0 24 -S 2 | \
	    dd of=${CDROM} conv=notrunc 2>/dev/null
@


1.29
log
@2008
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.28 2007/10/20 23:30:40 tg Exp $
d194 1
a194 1
${CDROM}: cdrom-prepare cdrom-mdcopy cdrom-generate
@


1.28
log
@use the new -0 option, remove need for pregenerated prepend_chain.sh to
exist in the repo, and dual_chain.bin hasn‚Äôt been used for a while either
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.27 2007/10/20 22:44:40 tg Exp $
d215 1
a215 1
	    -p 'Copyright ¬© 2002-2007 by The MirOS Project' \
@


1.27
log
@eliminate the need for cdrom-mdboot and merge cdrom-finish into cdrom-generate
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.26 2007/10/01 20:53:45 tg Exp $
d220 1
a220 1
	    ${MKSH} ${BOOTSH} -0 -S 2 | \
@


1.26
log
@boot.ldr -> b_{i386,sparc}.ldr
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.25 2007/10/01 20:50:49 tg Exp $
d72 1
d194 1
a194 1
${CDROM}: cdrom-prepare cdrom-mdcopy cdrom-generate cdrom-mdboot cdrom-finish
d207 1
a207 1
	cp bsd.rd ${WRKDIR}/v${OSrev}/${MACHINE}/
d219 3
a221 2

cdrom-finish:
@


1.25
log
@we haven‚Äôt needed the etc/ directory on the CD since long
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.24 2007/07/18 09:04:10 tg Exp $
d204 1
a204 1
	cp ${BOOT} ${WRKDIR}/boot.ldr
@


1.24
log
@do the entropy-to-sector-0 dance BEFORE writing the disklabel,
I have no idea why but it sometimes seems to wreck it‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.23 2007/07/07 22:02:41 tg Exp $
d197 1
a197 1
	mkdir -p ${WRKDIR}/{etc,v${OSrev}/${MACHINE}}
@


1.23
log
@crunchgen:
‚Ä¢ make stubbed object files obsolete, use GNU objcopy(1)‚Äôs symbol renaming
  feature instead
‚Ä¢ rewrite to use BSD make and <bsd.prog.mk>, finally
‚Ä¢ shrink the size of the generated makefile by a lot
‚Ä¢ document that ‚Äò-E‚Äô flag has been obsolete since version 1.x
‚Ä¢ bump to version 2.0

users of crunchgen:
‚Ä¢ change clean removal of *.lo to *.lo* to account for more temp files
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.22 2007/05/24 22:19:15 tg Exp $
d138 2
a151 1
	${SUDO} dd if=/dev/arandom bs=128 count=1 of=$@@ conv=notrunc
@


1.22
log
@forgot sudo
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.21 2007/05/24 20:15:57 tg Exp $
d105 1
a105 1
	    ${RDSETROOT} *.c *.o *.lo bsd.{uc,st} ${_RD_TARGETS} mkisofs.log
@


1.21
log
@prepend the image with some entropy
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.20 2007/01/30 22:42:05 tg Exp $
d150 1
a150 1
	dd if=/dev/arandom bs=128 count=1 of=$@@ conv=notrunc
@


1.20
log
@we're in 2007 and use UTF-8, except for pre-OS things
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.19 2007/01/26 19:33:10 tg Exp $
d150 1
@


1.19
log
@same -Os handling: default to it, but don't overly add it
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.18 2007/01/26 19:14:33 tg Exp $
d212 1
a212 1
	    -p 'Copyright © 2002-2006 by The MirOS Project' \
@


1.18
log
@use ${BSDSRCDIR} not ../../ since the special things do it too
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.17 2007/01/26 19:08:04 tg Exp $
d16 3
@


1.17
log
@for "educational" purposes - nm(1) - save an unstripped copy of instbin
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.16 2006/10/14 23:20:07 tg Exp $
d117 1
a117 1
	crunchgen ${CRUNCHGENOPTS} -D ${TOPDIR}/.. -L ${DESTDIR}/usr/lib \
@


1.16
log
@don't clobber ./ when unconfig'ing in extra/
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.15 2006/10/13 19:18:02 tg Exp $
d101 1
a101 1
	rm -f *core ${CBIN} ${CBIN}.mk ${CBIN}.cache ${CBIN}.conf ${IMAGE} \
d122 1
@


1.15
log
@move /etc/boot.cfg and friends to /
agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.14 2006/09/29 22:25:35 tg Exp $
d125 1
a125 1
	test ! -e ${TMPMOUNT} || (cd ${TOPDIR}/common; ${MAKE} unconfig)
d166 1
a166 1
	test ! -e ${TMPMOUNT} || (cd ${TOPDIR}/common; ${MAKE} unconfig)
@


1.14
log
@really make the disklabel binary with no integrated manpage
only for the i386 small floppy, nothing else
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.13 2006/08/19 18:32:01 tg Exp $
d198 2
a199 2
	cp ${BOOT} ${WRKDIR}/etc/boot.ldr
	cp ${TOPDIR}/common/boot.cfg.${MACHINE} ${WRKDIR}/etc/boot.cfg
@


1.13
log
@what kind of typo was THAT?
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.12 2006/08/19 15:22:47 tg Exp $
d85 1
d98 1
a98 1
	-${SUDO} rm -rf ${TMPMOUNT} ${WRKDIR} ${IMAGE} ${FLOPPY}
d102 1
a102 1
	    ${RDSETROOT} *.c *.o *.lo bsd.{uc,st} ${_RD_KERNELS} mkisofs.log
@


1.12
log
@fix perms
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.11 2006/08/19 15:00:42 tg Exp $
d11 1
a11 1
.if ${TOPDIR}/common/Makefile.${MACHCONF} != "no"
@


1.11
log
@use ${WRKDIR}
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.10 2006/08/19 14:57:56 tg Exp $
d201 1
d204 1
@


1.10
log
@missing CDROM_MDOPTS
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.9 2006/08/19 11:59:39 tg Exp $
a101 1
	rm -rf workdir
d186 1
a186 1
${CDROM}: cdrom-prepare cdrom-mdcopy cdrom-generate cdrom-mdboot
d189 2
a190 2
	-rm -rf workdir
	mkdir -p workdir/{etc,v${OSrev}/${MACHINE}}
d193 2
a194 2
		mkdir workdir/contrib; \
		cd workdir/contrib; \
d197 4
a200 4
	cp ${BOOT} workdir/etc/boot.ldr
	cp ${TOPDIR}/common/boot.cfg.${MACHINE} workdir/etc/boot.cfg
	cp bsd.rd workdir/v${OSrev}/${MACHINE}/
	cp ${TOPDIR}/common/00-README workdir/
d208 4
a211 1
	    -pad -o ${CDROM} workdir 2>&1 | tee mkisofs.log
@


1.9
log
@only use ${.ALLSRC} when it's appropriate ;) pasto
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.8 2006/08/19 11:46:07 tg Exp $
d204 1
a204 1
	mkisofs -r -f -L -d -D -N -v -v \
@


1.8
log
@* use a workdir in addition to the temporary mount point
* mtree needs -U not -u
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.7 2006/08/18 21:41:25 tg Exp $
d149 1
a149 1
	gzip -d <$> >$@@
@


1.7
log
@make df(1) the last action called before umount
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.6 2006/08/18 21:36:29 tg Exp $
d23 1
d97 1
a97 1
	-${SUDO} rm -rf ${TMPMOUNT} ${IMAGE} ${FLOPPY}
d126 4
a129 3
	${SUDO} mkdir -p ${TMPMOUNT}
	${SUDO} mtree -def ${MTREE} -p ${TMPMOUNT}/ -u
	OBJDIR=${REALOBJDIR:Q} TARGDIR=${TMPMOUNT:Q} TOPDIR=${TOPDIR:Q} \
d132 3
a134 2
	${SUDO} rm ${TMPMOUNT}/${CBIN}
	${SUDO} makefs -s ${IMAGESIZE}b -o ${IMAGEOPTS} ${IMAGE} ${TMPMOUNT}
d145 1
a145 1
	${SUDO} rm -rf ${TMPMOUNT}
d167 7
a174 5
	cp ${BOOT} ${TMPMOUNT}/boot
	gzip -vn9 <bsd.st >${TMPMOUNT}/bsd
	${SUDO} chown -R 0:0 ${TMPMOUNT}
	${SUDO} chmod -R u=rwX,go=rX ${TMPMOUNT}
	${SUDO} makefs -s ${FLOPPYSIZE}b -o ${FLOPPYOPTS} ${FLOPPY} ${TMPMOUNT}
d185 1
a185 1
	${SUDO} rm -rf ${TMPMOUNT}
@


1.6
log
@sync the sizes of the ramdisk images and the disktabs between arches
XXX i386 RAMDISK is probably too big now
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.5 2006/08/18 21:08:02 tg Exp $
d135 1
a138 1
	${IMAGE_PREP}
d173 1
a176 1
	${SUDO} ${INSTALLBOOT} -v ${TMPMOUNT}/boot ${BOOTXX} ${VND_CRDEV}
@


1.5
log
@migrate miniroot into the new unified image generation system
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.4 2006/08/18 20:48:46 tg Exp $
d43 1
a43 1
IMAGESIZE?=	8192
@


1.4
log
@fix paths, etc.
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.3 2006/08/17 14:17:46 tg Exp $
d46 1
d138 1
@


1.3
log
@add two-pass Makefile configuration

distrib/common/Makefile is cloned from
current (to vanish) distrib/ramdisk/Makefile
with listpre changed into listbeg for alphabetical sorting
@
text
@d1 1
a1 1
# $MirOS: src/distrib/ramdisk/Makefile,v 1.16 2006/08/17 14:09:22 tg Exp $
d37 1
a37 1
# crunched binary and ramdisk
d41 1
a41 1
MTREE?=		${TOPDIR}/miniroot/mtree.conf
d47 1
a47 1
# kernel
d50 1
d74 1
d76 1
a76 1
.if ${AOUT_BSDRD:L} != "no"
d78 1
d81 1
a81 1
ALL_TGTS=	${_RD_KERNELS} ${FLOPPY:S/^no$//} ${CDROM:S/^no$//}
d98 1
a98 1
	rm -f *core ${CBIN} ${CBIN}.mk ${CBIN}.cache ${CBIN}.conf \
d112 1
a112 1
	awk -f ${TOPDIR}/miniroot/makeconf.awk CBIN=${CBIN} ${LISTS} >$@@
d128 1
a128 1
	    ${SUDO} ${SHELL} ${TOPDIR}/miniroot/runlist.sh ${LISTS}
d185 1
a185 1
	@@if [[ -e ${TOPDIR}/common/contrib ]]; then \
d189 1
a189 1
		lndir ${TOPDIR}/common/contrib; \
@


1.2
log
@prepare for even larger structural change (unify miniroot, ramdisk, rambig):
* move install.md per-arch into distrib/common/install.MACHINE
* move Makefile.kernel into distrib/common/ too
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile,v 1.1 2006/06/08 23:52:20 tg Exp $
d3 1
a3 4
PROG=		rdsetroot
SRCS=		elfrdsetroot.c
NOMAN=		yes
CPPFLAGS+=	-DDEBUG
d5 198
a202 1
.include <bsd.prog.mk>
@


1.1
log
@simple host Makefile, e.g. for use with -x
@
text
@d1 1
a1 1
# $MirOS$
@

