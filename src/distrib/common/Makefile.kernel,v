head	1.5;
access;
symbols
	MIRBSD_10:1.2.0.2
	MIRBSD_10_BASE:1.2;
locks; strict;
comment	@# @;


1.5
date	2018.04.28.03.24.45;	author tg;	state Exp;
branches;
next	1.4;
commitid	1005AE3E98441347FF5;

1.4
date	2008.04.09.06.00.12;	author tg;	state Exp;
branches;
next	1.3;
commitid	10047FC5B7E262B000C;

1.3
date	2008.04.03.15.35.58;	author tg;	state Exp;
branches;
next	1.2;
commitid	10047F4F9640B131265;

1.2
date	2006.10.29.17.09.31;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004544E0622984C4B5;

1.1
date	2006.08.17.14.09.20;	author tg;	state Exp;
branches;
next	;
commitid	10044E4787416A4A520;


desc
@@


1.5
log
@attempt to make the sparc bsd.rd automatically marked nodbgsym if necessary
@
text
@# $MirOS: src/distrib/common/Makefile.kernel,v 1.3 2008/04/03 15:35:58 tg Exp $

SYSDIR?=	${BSDSRCDIR}/sys
SYSSUBDIR?=	${SYSDIR}/arch/${MACHINE}
KERNDIR?=	${SYSSUBDIR}/compile/${RAMDISK}

KCONFIG?=	config -s ${SYSDIR} -b . ${SYSSUBDIR}/conf/${RAMDISK}
KMAKE_CLEAN?=	${MAKE} clean
KMAKE_DEPEND?=	${KMAKE} depend
KMAKE?=		${MAKE} COPTS=${CFLAGS:Q}

bsd:
	mkdir -p build/${RAMDISK}
	[[ -s ${KERNDIR}/version ]] && [[ ! -s build/${RAMDISK}/version || \
	    ${KERNDIR}/version -nt build/${RAMDISK}/version ]] && \
	    cat ${KERNDIR}/version >build/${RAMDISK}/version || :
	( cd build/${RAMDISK}; ${KCONFIG} && ${KMAKE_CLEAN} && \
	    ${KMAKE_DEPEND} && exec ${KMAKE} ${KMAKE_EXTRA} bsd )
	mv build/${RAMDISK}/bsd .
	# The following line may generate a "systrace deny", ignore it.
	-[[ ! -e ${KERNDIR} ]] \
	    || if ! cat build/${RAMDISK}/version >${KERNDIR}/version; then \
		( print "# warning: kernel version changed"; \
		  print "print $$(<build/${RAMDISK}/version)" \
		     ">${KERNDIR}/version" ) \
		  | ${SUDO} tee -a /var/tmp/.buildnotice >&2; \
	    fi
@


1.4
log
@make can be annoying at times
@
text
@d18 1
a18 1
	    ${KMAKE_DEPEND} && exec ${KMAKE} bsd )
@


1.3
log
@use /sys/arch/*/compile/*/version over ${OBJDIR}/build/*/version if newer
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.kernel,v 1.2 2006/10/29 17:09:31 tg Exp $
d14 3
a16 5
	if [[ -s ${KERNDIR}/version ]]; then \
		[[ ! -s build/${RAMDISK}/version || \
		    ${KERNDIR}/version -nt build/${RAMDISK}/version ]] && \
		    cat ${KERNDIR}/version >build/${RAMDISK}/version; \
	fi
@


1.2
log
@add docs
@
text
@d1 1
a1 1
# $MirOS: src/distrib/common/Makefile.kernel,v 1.1 2006/08/17 14:09:20 tg Exp $
d14 5
a18 2
	[[ -f build/${RAMDISK}/version || ! -f ${KERNDIR}/version ]] \
	    || cat ${KERNDIR}/version >build/${RAMDISK}/version
@


1.1
log
@prepare for even larger structural change (unify miniroot, ramdisk, rambig):
* move install.md per-arch into distrib/common/install.MACHINE
* move Makefile.kernel into distrib/common/ too
@
text
@d1 1
a1 1
# $MirOS: src/distrib/Makefile.kernel,v 1.8 2006/07/03 22:12:00 tg Exp $
d19 1
@

