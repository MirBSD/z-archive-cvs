head	1.150;
access;
symbols
	MIRBSD_10:1.120.0.2
	MIRBSD_10_BASE:1.120
	MIRBSD_9_BASE:1.57
	MIRBSD_8:1.29.0.2
	MIRBSD_8_BASE:1.29
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.150
date	2017.04.03.02.37.25;	author tg;	state Exp;
branches;
next	1.149;
commitid	10058E1B57D7636EBCE;

1.149
date	2013.08.05.21.57.16;	author tg;	state Exp;
branches;
next	1.148;
commitid	10052001FD430071199;

1.148
date	2012.07.14.12.13.33;	author tg;	state Exp;
branches;
next	1.147;
commitid	1005001628571DDF389;

1.147
date	2010.01.29.18.29.41;	author tg;	state Exp;
branches;
next	1.146;
commitid	1004B63292575EEFB72;

1.146
date	2010.01.14.11.01.44;	author tg;	state Exp;
branches;
next	1.145;
commitid	1004B4EF9A355D129EE;

1.145
date	2009.12.27.17.05.39;	author tg;	state Exp;
branches;
next	1.144;
commitid	1004B3793E431013FA9;

1.144
date	2009.11.15.12.39.33;	author tg;	state Exp;
branches;
next	1.143;
commitid	1004AFFF67F0FC3EE8C;

1.143
date	2009.09.15.15.33.41;	author tg;	state Exp;
branches;
next	1.142;
commitid	1004AAFB3E076B16515;

1.142
date	2009.08.08.14.14.35;	author tg;	state Exp;
branches;
next	1.141;
commitid	1004A7D884F37AF542D;

1.141
date	2009.03.29.13.04.09;	author tg;	state Exp;
branches;
next	1.140;
commitid	10049CF71B654F9EF54;

1.140
date	2009.03.29.11.09.14;	author tg;	state Exp;
branches;
next	1.139;
commitid	10049CF56EB3B2ED213;

1.139
date	2009.02.01.11.11.10;	author tg;	state Exp;
branches;
next	1.138;
commitid	100498583605F82DA73;

1.138
date	2009.01.24.13.39.31;	author tg;	state Exp;
branches;
next	1.137;
commitid	100497B1A20537153C3;

1.137
date	2008.12.10.18.40.14;	author tg;	state Exp;
branches;
next	1.136;
commitid	10049400D213BD80DD4;

1.136
date	2008.08.20.18.26.21;	author tg;	state Exp;
branches;
next	1.135;
commitid	10048AC61D70D949162;

1.135
date	2008.08.19.17.17.30;	author tg;	state Exp;
branches;
next	1.134;
commitid	10048AB002524D69A0D;

1.134
date	2008.07.26.20.21.08;	author tg;	state Exp;
branches;
next	1.133;
commitid	100488B872858FFA434;

1.133
date	2008.07.19.21.11.21;	author tg;	state Exp;
branches;
next	1.132;
commitid	100488258886EB362DF;

1.132
date	2008.07.14.12.14.38;	author tg;	state Exp;
branches;
next	1.131;
commitid	100487B433D4E8F8507;

1.131
date	2008.07.12.21.39.51;	author tg;	state Exp;
branches;
next	1.130;
commitid	1004879249A724183F4;

1.130
date	2008.07.10.18.10.06;	author tg;	state Exp;
branches;
next	1.129;
commitid	1004876508C5156F86A;

1.129
date	2008.07.10.14.40.53;	author tg;	state Exp;
branches;
next	1.128;
commitid	10048761F8717D2450C;

1.128
date	2008.07.09.23.57.20;	author tg;	state Exp;
branches;
next	1.127;
commitid	10048755076220C9CF5;

1.127
date	2008.07.03.19.13.42;	author tg;	state Exp;
branches;
next	1.126;
commitid	100486D24F547313A5A;

1.126
date	2008.05.01.01.13.47;	author tg;	state Exp;
branches;
next	1.125;
commitid	1004819195C044F795B;

1.125
date	2008.05.01.01.12.38;	author tg;	state Exp;
branches;
next	1.124;
commitid	10048191917735FA482;

1.124
date	2008.04.11.20.06.10;	author tg;	state Exp;
branches;
next	1.123;
commitid	10047FFC4C67AC6E05A;

1.123
date	2008.04.02.18.56.17;	author tg;	state Exp;
branches;
next	1.122;
commitid	10047F3D6C920D9F997;

1.122
date	2008.04.02.00.17.27;	author tg;	state Exp;
branches;
next	1.121;
commitid	10047F2D09F09A1972C;

1.121
date	2008.03.27.19.05.10;	author tg;	state Exp;
branches;
next	1.120;
commitid	10047EBEE7D110FDF6B;

1.120
date	2007.10.21.15.43.48;	author tg;	state Exp;
branches;
next	1.119;
commitid	100471B73B9787100A6;

1.119
date	2007.10.21.13.25.54;	author tg;	state Exp;
branches;
next	1.118;
commitid	100471B53790DD579D8;

1.118
date	2007.10.18.19.40.26;	author tg;	state Exp;
branches;
next	1.117;
commitid	1004717B6B778970766;

1.117
date	2007.10.18.18.42.08;	author tg;	state Exp;
branches;
next	1.116;
commitid	1004717A90D5434AF01;

1.116
date	2007.10.16.22.24.36;	author tg;	state Exp;
branches;
next	1.115;
commitid	10047153A332A2CAA16;

1.115
date	2007.10.02.18.42.11;	author tg;	state Exp;
branches;
next	1.114;
commitid	100470290F44FF4AEC7;

1.114
date	2007.10.02.18.26.25;	author tg;	state Exp;
branches;
next	1.113;
commitid	10047028D624B67594F;

1.113
date	2007.08.25.17.48.17;	author tg;	state Exp;
branches;
next	1.112;
commitid	10046D06B74727BE673;

1.112
date	2007.08.24.14.12.17;	author tg;	state Exp;
branches;
next	1.111;
commitid	10046CEE71679015638;

1.111
date	2007.08.19.12.16.20;	author tg;	state Exp;
branches;
next	1.110;
commitid	10046C834AA42C844D9;

1.110
date	2007.08.07.18.05.10;	author tg;	state Exp;
branches;
next	1.109;
commitid	10046B8B46C0FEB8912;

1.109
date	2007.08.07.18.03.31;	author tg;	state Exp;
branches;
next	1.108;
commitid	10046B8B4082D55440E;

1.108
date	2007.07.09.00.24.55;	author tg;	state Exp;
branches;
next	1.107;
commitid	1004691806679D5D403;

1.107
date	2007.06.16.21.13.55;	author tg;	state Exp;
branches;
next	1.106;
commitid	100467452AA0173188E;

1.106
date	2007.06.09.18.49.39;	author tg;	state Exp;
branches;
next	1.105;
commitid	100466AF6541224027C;

1.105
date	2007.06.08.11.17.31;	author tg;	state Exp;
branches;
next	1.104;
commitid	10046693AE037665600;

1.104
date	2007.06.07.02.31.18;	author tg;	state Exp;
branches;
next	1.103;
commitid	10046676DFF32EC1FF6;

1.103
date	2007.06.07.02.11.04;	author tg;	state Exp;
branches;
next	1.102;
commitid	10046676948747229C5;

1.102
date	2007.06.07.01.54.42;	author tg;	state Exp;
branches;
next	1.101;
commitid	100466765497DC25CBC;

1.101
date	2007.05.17.14.52.24;	author tg;	state Exp;
branches;
next	1.100;
commitid	100464C6BBF17A3FF75;

1.100
date	2007.05.10.13.09.21;	author tg;	state Exp;
branches;
next	1.99;
commitid	1004643195847EA64E6;

1.99
date	2007.05.09.06.59.43;	author tg;	state Exp;
branches;
next	1.98;
commitid	1004641716B3968807C;

1.98
date	2007.05.09.06.57.47;	author tg;	state Exp;
branches;
next	1.97;
commitid	100464170F752DA13B7;

1.97
date	2007.03.09.11.31.49;	author tg;	state Exp;
branches;
next	1.96;
commitid	10045F145644159D152;

1.96
date	2007.02.08.21.13.33;	author tg;	state Exp;
branches;
next	1.95;
commitid	10045CB927F6C16FAF5;

1.95
date	2007.02.05.17.50.28;	author tg;	state Exp;
branches;
next	1.94;
commitid	10045C76E707CDD8262;

1.94
date	2007.01.27.14.54.37;	author tg;	state Exp;
branches;
next	1.93;
commitid	10045BB67A920901B64;

1.93
date	2007.01.26.18.57.06;	author tg;	state Exp;
branches;
next	1.92;
commitid	10045BA4F0C3449D669;

1.92
date	2007.01.23.11.18.42;	author tg;	state Exp;
branches;
next	1.91;
commitid	10045B5EF1B720C9A2C;

1.91
date	2007.01.22.19.51.59;	author tg;	state Exp;
branches;
next	1.90;
commitid	10045B515EA6FA8DBC2;

1.90
date	2006.12.23.04.36.22;	author tg;	state Exp;
branches;
next	1.89;
commitid	100458CB25513A296BC;

1.89
date	2006.12.22.21.14.03;	author tg;	state Exp;
branches;
next	1.88;
commitid	100458C4AA70D1925A3;

1.88
date	2006.12.20.15.56.46;	author tg;	state Exp;
branches;
next	1.87;
commitid	10045895CD14E3BC846;

1.87
date	2006.12.20.15.49.32;	author tg;	state Exp;
branches;
next	1.86;
commitid	10045895B851892EB44;

1.86
date	2006.11.17.13.17.41;	author tg;	state Exp;
branches;
next	1.85;
commitid	100455DB6874F9FCEC1;

1.85
date	2006.11.17.12.37.04;	author tg;	state Exp;
branches;
next	1.84;
commitid	100455DAD053CF4F0A2;

1.84
date	2006.11.17.01.52.21;	author tg;	state Exp;
branches;
next	1.83;
commitid	100455D15E07AF879E8;

1.83
date	2006.11.17.01.48.55;	author tg;	state Exp;
branches;
next	1.82;
commitid	100455D15171A0FDD4A;

1.82
date	2006.11.17.01.47.47;	author tg;	state Exp;
branches;
next	1.81;
commitid	100455D14BB56D31BCD;

1.81
date	2006.11.17.01.45.33;	author tg;	state Exp;
branches;
next	1.80;
commitid	100455D143D56B63A00;

1.80
date	2006.11.17.01.43.32;	author tg;	state Exp;
branches;
next	1.79;
commitid	100455D138F6905A2B0;

1.79
date	2006.11.17.01.36.37;	author tg;	state Exp;
branches;
next	1.78;
commitid	100455D1233102D0DEC;

1.78
date	2006.11.02.02.30.39;	author tg;	state Exp;
branches;
next	1.77;
commitid	100454958635BD73FAC;

1.77
date	2006.10.29.12.37.48;	author tg;	state Exp;
branches;
next	1.76;
commitid	1004544A0B10B9F6AD2;

1.76
date	2006.10.29.12.24.02;	author tg;	state Exp;
branches;
next	1.75;
commitid	10045449D731D03F280;

1.75
date	2006.10.29.12.13.30;	author tg;	state Exp;
branches;
next	1.74;
commitid	10045449AFB0BA6D588;

1.74
date	2006.10.16.19.19.20;	author tg;	state Exp;
branches;
next	1.73;
commitid	1004533DA4B359CD3D9;

1.73
date	2006.10.14.23.43.02;	author tg;	state Exp;
branches;
next	1.72;
commitid	10045317619084813E7;

1.72
date	2006.10.14.23.28.36;	author tg;	state Exp;
branches;
next	1.71;
commitid	100453172AF07AB315E;

1.71
date	2006.10.13.19.33.57;	author tg;	state Exp;
branches;
next	1.70;
commitid	100452FEA3457E19088;

1.70
date	2006.10.02.07.38.39;	author tg;	state Exp;
branches;
next	1.69;
commitid	1004520C20D05C1BF3E;

1.69
date	2006.09.24.19.00.50;	author tg;	state Exp;
branches;
next	1.68;
commitid	1004516D5E476124155;

1.68
date	2006.09.22.12.31.02;	author tg;	state Exp;
branches;
next	1.67;
commitid	1004513D7900B7CDBBA;

1.67
date	2006.09.21.17.07.10;	author tg;	state Exp;
branches;
next	1.66;
commitid	1004512C6CA0323136C;

1.66
date	2006.08.18.22.39.54;	author tg;	state Exp;
branches;
next	1.65;
commitid	10044E641C13B3155E5;

1.65
date	2006.07.05.23.59.46;	author tg;	state Exp;
branches;
next	1.64;
commitid	10044AC526E738510E5;

1.64
date	2006.07.04.03.45.17;	author tg;	state Exp;
branches;
next	1.63;
commitid	10044A9E45C1E091811;

1.63
date	2006.07.03.01.19.54;	author tg;	state Exp;
branches;
next	1.62;
commitid	10044A870B77F4C6116;

1.62
date	2006.07.02.18.18.11;	author tg;	state Exp;
branches;
next	1.61;
commitid	10044A80DF3384FC93F;

1.61
date	2006.07.02.18.17.38;	author tg;	state Exp;
branches;
next	1.60;
commitid	10044A80DCF76424EFF;

1.60
date	2006.07.01.00.48.20;	author tg;	state Exp;
branches;
next	1.59;
commitid	10044A5C66B5038EFE4;

1.59
date	2006.07.01.00.46.50;	author tg;	state Exp;
branches;
next	1.58;
commitid	10044A5C5FF41EA0AE7;

1.58
date	2006.07.01.00.34.59;	author tg;	state Exp;
branches;
next	1.57;
commitid	10044A5C33C5FA45C94;

1.57
date	2006.06.25.05.39.48;	author tg;	state Exp;
branches;
next	1.56;
commitid	100449E21B52A622610;

1.56
date	2006.06.16.22.55.09;	author tg;	state Exp;
branches;
next	1.55;
commitid	100449336D54F3F56E1;

1.55
date	2006.06.16.21.54.08;	author tg;	state Exp;
branches;
next	1.54;
commitid	1004493288D59FF42E5;

1.54
date	2006.06.16.15.16.56;	author tg;	state Exp;
branches;
next	1.53;
commitid	1004492CB755E8140D4;

1.53
date	2006.06.09.01.23.35;	author tg;	state Exp;
branches;
next	1.52;
commitid	1004488CDA120C587B1;

1.52
date	2006.06.09.01.21.28;	author tg;	state Exp;
branches;
next	1.51;
commitid	1004488CD21330A9B3F;

1.51
date	2006.05.26.21.37.57;	author tg;	state Exp;
branches;
next	1.50;
commitid	10044777549265528FF;

1.50
date	2006.05.26.20.02.22;	author tg;	state Exp;
branches;
next	1.49;
commitid	10044775EE12196AA44;

1.49
date	2006.05.26.20.01.12;	author tg;	state Exp;
branches;
next	1.48;
commitid	10044775E9217DB50CE;

1.48
date	2006.05.26.19.45.37;	author tg;	state Exp;
branches;
next	1.47;
commitid	10044775AF54ECDD7F1;

1.47
date	2006.05.26.17.12.44;	author tg;	state Exp;
branches;
next	1.46;
commitid	100447737192B2E263B;

1.46
date	2006.05.26.17.09.20;	author tg;	state Exp;
branches;
next	1.45;
commitid	1004477364A7303D8BF;

1.45
date	2006.05.25.21.34.41;	author tg;	state Exp;
branches;
next	1.44;
commitid	100447622FA60C1D3AA;

1.44
date	2006.05.25.21.34.11;	author tg;	state Exp;
branches;
next	1.43;
commitid	100447622E3279282C8;

1.43
date	2006.04.19.21.27.06;	author tg;	state Exp;
branches;
next	1.42;
commitid	1004446AB1B438FA4C9;

1.42
date	2006.04.11.05.09.38;	author tg;	state Exp;
branches;
next	1.41;
commitid	100443B3A0B5256B986;

1.41
date	2006.04.10.21.35.28;	author tg;	state Exp;
branches;
next	1.40;
commitid	100443ACFAE4E101F67;

1.40
date	2006.04.10.21.26.29;	author tg;	state Exp;
branches;
next	1.39;
commitid	100443ACD781D83DC46;

1.39
date	2006.04.10.21.18.23;	author tg;	state Exp;
branches;
next	1.38;
commitid	100443ACB6310264F81;

1.38
date	2006.02.24.12.26.18;	author tg;	state Exp;
branches;
next	1.37;
commitid	10043FEFB65419A44DD;

1.37
date	2006.02.15.13.20.34;	author tg;	state Exp;
branches;
next	1.36;
commitid	10043F32A9C6379BEF4;

1.36
date	2006.02.15.10.14.48;	author tg;	state Exp;
branches;
next	1.35;
commitid	10043F2FF2409F396DC;

1.35
date	2006.02.14.22.06.15;	author tg;	state Exp;
branches;
next	1.34;
commitid	10043F254645C3DA695;

1.34
date	2006.02.14.20.47.51;	author tg;	state Exp;
branches;
next	1.33;
commitid	10043F2407C51151E2F;

1.33
date	2006.01.31.13.58.25;	author tg;	state Exp;
branches;
next	1.32;
commitid	10043DF6CF916F28F5C;

1.32
date	2006.01.04.02.22.18;	author tg;	state Exp;
branches;
next	1.31;
commitid	10043BB316C438D98E5;

1.31
date	2006.01.04.02.15.10;	author tg;	state Exp;
branches;
next	1.30;
commitid	10043BB2FC4746B9C84;

1.30
date	2005.12.30.14.05.14;	author tg;	state Exp;
branches;
next	1.29;
commitid	10043B53E791E7D4C62;

1.29
date	2005.12.22.01.12.33;	author tg;	state Exp;
branches;
next	1.28;
commitid	10043A9FD7D2436905D;

1.28
date	2005.12.21.19.26.58;	author tg;	state Exp;
branches;
next	1.27;
commitid	10043A9AC8F5646A143;

1.27
date	2005.12.21.19.25.03;	author tg;	state Exp;
branches;
next	1.26;
commitid	10043A9AC2120449C1B;

1.26
date	2005.12.21.14.59.09;	author tg;	state Exp;
branches;
next	1.25;
commitid	10043A96DC63D2B5F6D;

1.25
date	2005.12.21.14.55.50;	author tg;	state Exp;
branches;
next	1.24;
commitid	10043A96CA743A384D9;

1.24
date	2005.12.18.16.36.47;	author tg;	state Exp;
branches;
next	1.23;
commitid	10043A58BE830AFB807;

1.23
date	2005.12.05.16.06.01;	author tg;	state Exp;
branches;
next	1.22;
commitid	b384394655a7e46;

1.22
date	2005.06.14.13.04.39;	author tg;	state Exp;
branches;
next	1.21;
commitid	29b042aed5f3791b;

1.21
date	2005.06.13.20.48.48;	author tg;	state Exp;
branches;
next	1.20;
commitid	117f42adf141485a;

1.20
date	2005.06.13.19.53.41;	author tg;	state Exp;
branches;
next	1.19;
commitid	2b6c42ade4528e57;

1.19
date	2005.05.01.23.35.26;	author tg;	state Exp;
branches;
next	1.18;

1.18
date	2005.04.29.19.57.40;	author tg;	state Exp;
branches;
next	1.17;

1.17
date	2005.04.29.19.21.45;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2005.04.20.06.18.04;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2005.04.19.12.53.46;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2005.03.29.22.07.19;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2005.03.29.22.05.57;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2005.03.29.17.33.27;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2005.03.29.17.02.29;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2005.03.29.13.03.55;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2005.03.29.12.27.47;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2005.03.29.12.24.56;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2005.03.29.12.20.06;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2005.03.29.10.49.05;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2005.03.29.00.12.16;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2005.03.15.17.17.59;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.15.17.17.17;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.06.21.27.25;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.22.03;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.22.03;	author tg;	state Exp;
branches;
next	;


desc
@@


1.150
log
@no gmake needed to build base any more! yay!
@
text
@# $MirOS: src/Makefile,v 1.148 2012/07/14 12:13:33 tg Exp $
# $OpenBSD: Makefile,v 1.103 2004/05/03 15:18:18 drahn Exp $

.if defined(MAKECONF) && exists(${MAKECONF})
.  error MAKECONF is set to '${MAKECONF}', you don't want this!
.endif
.include <bsd.own.mk>
.include "Makefile.inc"
.if exists(gcc/Makefile.lang)
.  include "gcc/Makefile.lang"
.else
NO_ADA?=	Yes
NO_PASCAL?=	Yes
.endif
NOMAN?=		no
CVSROOT?=	/cvs
ANONCVSROOT?=	_anoncvs@@anoncvs.mirbsd.org:/cvs
_SAFEPATH=	/bin:/usr/bin:/sbin:/usr/sbin:/usr/X11R6/bin
BATCH?=		No
TSCOMPRESS?=	Yes

  SUBDIR+= lib
  SUBDIR+= include
  SUBDIR+= bin
  SUBDIR+= libexec
  SUBDIR+= sbin
  SUBDIR+= usr.bin
  SUBDIR+= usr.sbin
  SUBDIR+= share
  SUBDIR+= gnu
  SUBDIR+= sys
.if make(clean) || make(cleandir) || make(obj)
  SUBDIR+= distrib
.endif

beforeinstall: distrib-dirs
	cd ${.CURDIR}/include && exec ${MAKE} includes

afterinstall:
.if ${NOMAN:L} == "no"
	cd ${.CURDIR}/share/man && exec ${MAKE} makedb
.endif

mksystrace: mksystrace-obj mksystrace-dest

mksystrace-obj:
	cd ${BSDOBJDIR} && env WRITEDIR=${BSDOBJDIR:Q} \
	    ${SHELL} ${BSDSRCDIR}/scripts/systrace.mk ${MAKE}

mksystrace-dest:
	d=${DESTDIR:Q}; cd $${d:-/}; [[ -n $$d ]] || d="/:/*"; \
	    env WRITEDIR="$$d" NOWRITEDIR=${BSDOBJDIR:Q} \
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/systrace.mk ${MAKE}

build-pre:
	-${SUDO} rm -f ${_STFILE_OBJ} ${_STFILE_DEST}
	cd ${.CURDIR} && exec ${MAKE} mksystrace
	cd ${.CURDIR}/share/mk \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install
	cd ${.CURDIR}/include \
	    && ${_STCMD_OBJ} ${MAKE} prereq \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} includes
	rm -rf ${BSDOBJDIR}/lib
	cd ${.CURDIR}/lib && ${MAKE} obj && exec ${_STCMD_OBJ} ${MAKE} depend
	cd ${.CURDIR}/lib/csu \
	    && ${_STCMD_OBJ} ${MAKE} \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install NOMAN=yes

build-lib:
	cd ${.CURDIR}/lib/libc \
	    && ${_STCMD_OBJ} ${MAKE} \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install NOMAN=yes
	${SUDO} /sbin/ldconfig -R
	cd ${.CURDIR}/lib \
	    && ${_STCMD_OBJ} ${MAKE} \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install NOMAN=yes
	${SUDO} /sbin/ldconfig -R
	cd ${.CURDIR} && ${_STCMD_OBJ} ${MAKE} depend

contbuild:
	cd ${.CURDIR} && exec ${MAKE} mksystrace
	cd ${.CURDIR} && ${_STCMD_OBJ} ${MAKE} \
	    && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install
	@@sleep 1
	${SUDO} rm -f ${_STFILE_OBJ} ${_STFILE_DEST}

distrib-dirs:
	[[ -d ${DESTDIR}/. ]] || \
	    ${SUDO} ${INSTALL} -d -o root -g wheel -m 755 ${DESTDIR}
	${SUDO} mtree -p ${DESTDIR}/ -Uqdef ${.CURDIR}/etc/mtree/4.4BSD.dist
	grep -v -e '^fd' -e dev/fd ${.CURDIR}/etc/mtree/special | \
	    ${SUDO} mtree -p ${DESTDIR}/ -Uqde
	cd ${DESTDIR}/var/anoncvs && \
	    if [[ ! -h var || $$(readlink var) != . ]]; then \
		${SUDO} rm -f var; \
		${SUDO} ln -s . var; \
	fi
	for i in ${DESTDIR}/usr/{ports,src}; do \
		[[ -d $$i ]] || \
		    ${SUDO} ${INSTALL} -d -o root -g wsrc -m 775 $$i; \
	done
	cd ${DESTDIR}/ && ${SUDO} rm -f sys && ${SUDO} ln -s usr/src/sys sys

b-r:
	# Test if the targets are mounted suitable for root (BTSTF)
.for _dir in ${BSDOBJDIR} ${BSDRELDIR}
	mkdir -p ${_dir} || ${SUDO} mkdir -p ${_dir}
	${SUDO} touch ${_dir}/permissions.test
	${SUDO} chown root:wheel ${_dir}/permissions.test
	${SUDO} rm ${_dir}/permissions.test
.endfor
	touch ${BSDOBJDIR}/permissions.test && rm ${BSDOBJDIR}/permissions.test
	cd ${.CURDIR} && exec ${MAKE} obj
	cd ${.CURDIR} && exec ${MAKE} build-pre DESTDIR=
	cd ${.CURDIR} && exec ${MAKE} build-lib DESTDIR=
	cd ${.CURDIR} && exec ${MAKE} contbuild DESTDIR=

release:
	mkdir -p ${DESTDIR} || ${SUDO} mkdir -p ${DESTDIR}
	cd ${.CURDIR} && exec ${MAKE} mksystrace-dest
	cd ${.CURDIR} && exec ${SUDO} ${_STCMD_DEST} ${MAKE} install
	cd ${.CURDIR}/etc && exec ${SUDO} ${_STCMD_DEST} ${MAKE} etc-files
	@@sleep 1
	${SUDO} rm -f ${_STFILE_DEST}

do-htman:
	-${SUDO} rm -rf ${BSDOBJDIR}/htman ${BSDRELDIR}/htman
	${SUDO} mkdir -p ${BSDOBJDIR}/htman ${BSDRELDIR}/htman
	${SUDO} chown $$(id -u) ${BSDOBJDIR}/htman ${BSDRELDIR}/htman
	BSDOBJDIR=${BSDOBJDIR:Q} BSDSRCDIR=${BSDSRCDIR:Q} \
	    BSDRELDIR=${BSDRELDIR:Q} OSrev=${OSrev:Q} \
	    ${SHELL} ${.CURDIR}/scripts/genhtman.sh
	${SUDO} chown -R 0:0 ${BSDRELDIR}/htman/*
	${SUDO} chmod -R a=rX ${BSDRELDIR}/htman/*

do-htinfopapers:
	cd ${BSDOBJDIR} && env WRITEDIR=${BSDOBJDIR:Q} \
	    ${SHELL} ${BSDSRCDIR}/scripts/systrace.mk ${MAKE} ${SHELL}
.for _doc in papers psd smm usd
	cd ${BSDOBJDIR}/htman/papers/${_doc} && ${_STCMD_OBJ} ${MAKE}
.endfor
	cd ${.CURDIR} && ${_STCMD_OBJ} ${MAKE} _do-htinfo
	-rm -f ${BSDOBJDIR}/.policy.mk

_do-htinfo:
	cd ${BSDOBJDIR}/gnu/usr.bin/binutils/bfd/doc && \
	    rm -f {bfd,bfdint}.html && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc/bfd.texinfo && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc/bfdint.texi && \
	    cp {bfd,bfdint}.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gnu/usr.bin/binutils/binutils/doc && \
	    rm -f binutils.html && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/binutils/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/binutils/doc/binutils.texi && \
	    cp binutils.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gnu/usr.bin/binutils/gas/doc && \
	    rm -f as.html && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gas/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/gas/doc/as.texinfo && \
	    cp as.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gnu/usr.bin/binutils/gdb/doc && \
	    rm -f {gdb,gdbint,stabs,annotate}.html && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/mi \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc/gdb.texinfo && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc/gdbint.texinfo && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc/stabs.texinfo && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/gdb/doc/annotate.texinfo && \
	    cp {gdb,gdbint,stabs,annotate}.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gnu/usr.bin/binutils/ld && \
	    rm -f ld{,int}.html && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/ld \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/ld/ld.texinfo && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/ld \
	    -I ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/ld/ldint.texinfo && \
	    cp ld{,int}.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gnu/usr.bin/cvs/doc && \
	    rm -f cvs{,client}.html && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gnu/usr.bin/cvs/doc \
	    ${BSDSRCDIR}/gnu/usr.bin/cvs/doc/cvs.texinfo && \
	    makeinfo --no-split --html \
	    ${BSDSRCDIR}/gnu/usr.bin/cvs/doc/cvsclient.texi && \
	    cp cvs{,client}.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/gcc/gcc && \
	    rm -f {cpp{,internals},gcc{,int}}.html && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gcc/gcc/doc/include \
	    ${BSDSRCDIR}/gcc/gcc/doc/cpp.texi && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gcc/gcc/doc/include \
	    ${BSDSRCDIR}/gcc/gcc/doc/gcc.texi && \
	    makeinfo --no-split --html -I ${BSDSRCDIR}/gcc/gcc/doc/include \
	    ${BSDSRCDIR}/gcc/gcc/doc/gccint.texi && \
	    makeinfo --no-split --html \
	    ${BSDSRCDIR}/gcc/gcc/doc/cppinternals.texi && \
	    cp {cpp{,internals},gcc{,int}}.html ${BSDOBJDIR}/htman/texinfo/
.if ${NO_ADA:L} == "no"
	cd ${BSDOBJDIR}/gcc/gcc && \
	    rm -f gnat{_ugn_unw,_rm,-style}.html && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gcc/gcc/doc/include -I ${BSDSRCDIR}/gcc/gcc/ada \
	    doc/gnat_ugn_unw.texi && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gcc/gcc/doc/include -I ${BSDSRCDIR}/gcc/gcc/ada \
	    ${BSDSRCDIR}/gcc/gcc/ada/gnat_rm.texi && \
	    makeinfo --no-split --html \
	    -I ${BSDSRCDIR}/gcc/gcc/doc/include -I ${BSDSRCDIR}/gcc/gcc/ada \
	    ${BSDSRCDIR}/gcc/gcc/ada/gnat-style.texi && \
	    cp gnat{_ugn_unw,_rm,-style}.html ${BSDOBJDIR}/htman/texinfo/
.endif
.if ${NO_PASCAL:L} == "no"
	cd ${BSDOBJDIR}/gcc/gpcdoc && \
	    cp gpc{,-hr,s{,-de,-hr}}.html ${BSDOBJDIR}/htman/texinfo/
.endif

base-distbuild:
	cd ${.CURDIR} && exec ${MAKE} mksystrace-obj
	cd ${.CURDIR}/distrib && ${_STCMD_OBJ} ${MAKE} depend && \
	    exec ${_STCMD_OBJ} ${MAKE}
	-rm -f ${_STFILE_OBJ}

base-distinstall:
	cd ${.CURDIR} && exec ${MAKE} mksystrace-dest
.if (${MACHINE_ARCH} == "i386")
	${INSTALL} -c -o ${BINOWN} -g ${BINGRP} -m ${BINMODE} \
	    ${.CURDIR}/distrib/common/ekeyrng ${DESTDIR}/usr/libexec/
.endif
	-rm -rf ${_STFILE_OBJ} ${DESTDIR}/snapshot
	${INSTALL} -d -o root -g wheel -m 755 ${DESTDIR}/snapshot
	cd ${DESTDIR} && for file in usr/mdec/*{boot,mbr}*; do \
		[[ -e $$file ]] || continue; \
		${INSTALL} -c -o root -g wheel -m 444 $$file snapshot/; \
	done
	cd ${.CURDIR}/distrib && exec ${_STCMD_DEST} ${MAKE} install
	cd ${.CURDIR}/share/man && exec ${_STCMD_DEST} ${MAKE} makedb
	cd ${.CURDIR}/gnu/usr.bin/texinfo && exec ${_STCMD_DEST} \
	    ${MAKE} -f Makefile.bsd-wrapper mkinfodir
	-rm -f ${_STFILE_DEST}

dist:
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:M*:Q} \
	    HOME=$$(/usr/bin/mktemp -d /var/tmp/buildhome.XXXXXXXXXX) \
	    PATH=${_SAFEPATH} TZ=UTC \
	    ${MAKE} _do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
	@@date | tee -a ${.CURDIR}/Build.log
	-[[ -d ${BSDRELDIR}/rel && -s ${.CURDIR}/Build.log ]] && \
	    ${SUDO} cp ${.CURDIR}/Build.log ${BSDRELDIR}/rel/

dist-q:
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:M*:Q} \
	    HOME=$$(/usr/bin/mktemp -d /var/tmp/buildhome.XXXXXXXXXX) \
	    PATH=${_SAFEPATH} TZ=UTC BATCH=Yes \
	    ${MAKE} _do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
	@@date | tee -a ${.CURDIR}/Build.log
	-[[ -d ${BSDRELDIR}/rel && -s ${.CURDIR}/Build.log ]] && \
	    ${SUDO} cp ${.CURDIR}/Build.log ${BSDRELDIR}/rel/

_DISTS=		base
.ifdef QUICK_DIST2
QUICK_DIST=	implied
.else
_DISTS+=	x11
.endif
.ifndef QUICK_DIST
_DISTS+=	htman
.endif
DIST_RESTART?=	0

_do-dist:
	@@h=${HOME:Q}; [[ $$h = $$HOME ]] || exit 1
	@@if [[ $$HOME != /var/tmp/buildhome.* ]]; then \
		echo Do not call this target directly; \
		exit 1; \
	fi
	@@echo Initialising sudo as ${SUDO:Q}
	${SUDO} true
	mkdir -p ${HOME}/.etc/systrace
.ifdef QUICK_DIST2
.  if ${NO_JAVA:L} == "no"
	@@[[ -e /usr/X11R6/include/X11/X.h && -e /usr/X11R6/lib/libX11.a ]] || \
	    {	print 'To build gcc/libjava you must have X11 installed!'; \
		${SUDO} rm -rf ${HOME}; \
		exit 1; \
	}
.  endif
.endif
.ifndef QUICK_DIST
	@@c='${CVSROOT}'; [[ $$c = @@(:@@(ext|pserver):|*@@(@@))*@@(:/)* || \
	    -e $$c/CVSROOT/config ]] || { \
		print 'To build a full release CVSROOT must point to the'; \
		print 'locally mounted MirOS /cvs or a remote repository'; \
		${SUDO} rm -rf ${HOME}; \
		exit 1; \
	}
.endif
	@@if ! ${SUDO} mksh -c '[[ -w /var/anoncvs/bin/cvs ]]'; then \
		print 'Your /var/anoncvs must be mounted read-write'; \
		${SUDO} rm -rf ${HOME}; \
		exit 1; \
	fi
	@@echo ============================================================
	@@if [[ ! -e /var/tmp/.buildnotice ]]; then \
		${SUDO} install -c -o 0 -g 0 -m 600 /dev/null \
		    /var/tmp/.buildnotice; \
	fi
	${SUDO} ${MKSH} -c 'echo rm -rf ${HOME} >>/var/tmp/.buildnotice'
	@@${SUDO} rm -f ${BSDRELDIR}/rel/Build.log
	@@echo Initiating MirOS Build...
	@@date
.if ${BATCH:L} == "yes"
	@@echo BATCH mode engaged.
.else
	@@echo INTERACTIVE mode engaged.
.endif
.ifdef QUICK_DIST
	@@echo QUICK dist-build mode active:
	@@echo not building ports, package tools, or HTML manual pages.
.  ifdef QUICK_DIST2
	@@echo not building XFree86® either.
.  endif
.endif
	@@echo ============================================================
.if ${DIST_RESTART} > 0
	@@print not removing ${BSDOBJDIR:Q} and ${BSDRELDIR:Q}
.elif defined(NFS_DIST)
	@@for dir in ${BSDOBJDIR} ${BSDRELDIR}; do \
		if [[ -d $$dir ]]; then \
			${SUDO} rm -rf $$dir/{*,.*}; \
		elif [[ -e $$dir ]]; then \
			print "Warning: '$$dir' not a directory!"; \
			print "The build might fail due to strange"; \
			print "mount combinations, symlinks, etc."; \
			print "and '$$dir' cannot be cleaned either!"; \
		else \
			print "Warning: '$$dir' non-existant; if you"; \
			print "intend an NFS dist you should better"; \
			print "mount something there before starting!"; \
		fi; \
	done
.else
	${SUDO} rm -rf ${BSDOBJDIR} ${BSDRELDIR}
.endif
	cd ${.CURDIR} && exec ${MAKE} distrib-dirs DESTDIR=
	${SUDO} install -d -o 0 -g 0 -m ${DIRMODE} ${BSDRELDIR}/{base,rel,x11}
.if ${DIST_RESTART} == 0
	cd ${.CURDIR} && exec ${MAKE} b-r
.elif ${DIST_RESTART} == 1
	cd ${.CURDIR} && ${MAKE} build-lib && exec ${MAKE} contbuild
.elif ${DIST_RESTART} == 2
	cd ${.CURDIR} && exec ${MAKE} contbuild
.endif
	${SUDO} /sbin/ldconfig -R
.ifndef QUICK_DIST2
	@@date
.  if ${DIST_RESTART} < 4
	cd ${.CURDIR}/X11 && exec ${MAKE} b-r
.  endif
.endif
	${SUDO} /sbin/ldconfig -R
	@@date
.if ${DIST_RESTART} < 5
	cd ${.CURDIR}/gcc && exec ${MAKE} b-r
.endif
	${SUDO} /sbin/ldconfig -R
	@@date
.if ${DIST_RESTART} < 6
	cd ${.CURDIR} && exec ${MAKE} release DESTDIR=${BSDRELDIR}/base
	cd ${.CURDIR}/gcc && \
	    exec ${SUDO} ${MAKE} install DESTDIR=${BSDRELDIR}/base
.  ifndef QUICK_DIST2
	cd ${.CURDIR}/X11 && \
	    exec ${SUDO} ${MAKE} release DESTDIR=${BSDRELDIR}/x11
.  endif
.endif
	@@date
.if ${DIST_RESTART} < 7
	cd ${.CURDIR} && exec ${MAKE} base-distbuild DESTDIR=${BSDRELDIR}/base
	cd ${.CURDIR} && exec ${SUDO} ${MAKE} base-distinstall \
	    DESTDIR=${BSDRELDIR}/base
.endif
.ifndef QUICK_DIST
	@@date
	t=0; cd ${BSDRELDIR}; \
	if mount 2>&- | fgrep ' on ${BSDRELDIR}/usr ' >&- 2>&-; then \
		${SUDO} umount ${BSDRELDIR}/usr; \
	fi; \
	test ! -e usr || ${SUDO} rm -rf usr; \
	mkdir usr && \
	${SUDO} mount_mfs -s 458752 swap ${BSDRELDIR}/usr && \
	if ! test -e ${BSDRELDIR}/rel/ports${OSrev}.ngz; then \
		cd usr && \
		(umask 002; cvs -Rqz3 -d ${CVSROOT} co -PA ports) && \
		${MKSH} ${.CURDIR}/scripts/mnt-cvsroot ${ANONCVSROOT} . && \
		mkdir -m 0775 ports/{Distfiles,Packages} && \
		${SUDO} chown -R root:wsrc ports && \
		cd .. && \
		find usr/ports | sort | cpio -oC512 -Hsv4cpio -Mset | \
		    gzip -n9 | ${SUDO} dd of=rel/ports${OSrev}.ngz && t=1; \
	else \
		${SUDO} tar xzphf ${BSDRELDIR}/rel/ports${OSrev}.ngz \
		    usr/ports/{CVS,M*,S*,essentials/pkgtools,in*} && t=1; \
	fi; \
	test -e ${BSDRELDIR}/rel/pkgutl${OSrev}.ngz || if [[ $$t = 1 ]]; then \
		cd ${BSDRELDIR}/base/dev; ${SUDO} ./MAKEDEV std systrace; \
		cd ..; ${SUDO} rm -rf usr/{mpkg,ports} .etc var/games; \
		${SUDO} mkdir .etc; cd ../usr; ${SUDO} pax -rw -pe -l \
		    ports/{Makefile,Setup.sh,essentials/pkgtools,infra*} \
		    ${BSDRELDIR}/base/usr && cd ${BSDRELDIR}/base && \
		${SUDO} chroot . mksh -c 'cd /usr/ports && make \
		    HOME=/ SUDO= setup' && \
		find usr/mpkg | sort | ${SUDO} cpio -oC512 -Hsv4cpio -Mset | \
		    gzip -n9 | ${SUDO} dd of=../rel/pkgutl${OSrev}.ngz && t=; \
		[[ -z $$t ]] || rm -f ${BSDRELDIR}/rel/pkgutl${OSrev}.ngz; \
		cd ${BSDRELDIR}; ${SUDO} rm -rf base/dev/!(MAKEDEV) \
		    base/usr/{mpkg,ports} base/.etc base/var/games; \
		${SUDO} mkdir -m 0775 ${BSDRELDIR}/base/usr/ports; \
		${SUDO} chown root:wsrc ${BSDRELDIR}/base/usr/ports; \
	fi; \
	cd ${BSDRELDIR}; ${SUDO} umount ${BSDRELDIR}/usr; \
	test -e ${BSDRELDIR}/rel/pkgutl${OSrev}.ngz
	@@date
	if [[ ! -e ${BSDRELDIR}/rel/htmi${OSrev}.ngz || \
	    ! -e ${BSDRELDIR}/rel/htmd${OSrev}.ngz ]]; then \
		cd ${.CURDIR} && exec ${MAKE} do-htman; \
	fi
.endif
	col -bx <${BSDRELDIR}/base/usr/share/man/cat7/install.${MACHINE}.0 \
	    >${BSDOBJDIR}/INSTALL
	@@date
	@@echo ============================================================
	@@if [[ -e /var/tmp/.buildnotice ]]; then \
		${SUDO} cat /var/tmp/.buildnotice; \
		${SUDO} ${MKSH} /var/tmp/.buildnotice; \
		${SUDO} rm -f /var/tmp/.buildnotice || true; \
		echo ============================================================; \
	fi
	@@echo Checking files:
	@@echo
.for _set in ${_DISTS}
	-cd ${BSDSRCDIR}/distrib/lists/${_set} && \
	    DESTDIR=${BSDRELDIR:Q}/${_set} RELEASEDIR=${BSDRELDIR:Q}/rel \
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/tarsets check
.endfor
	@@echo ============================================================
.if ${BATCH:L} != "yes"
	@@date
	@@read a?'Press Return to continue...'
.endif
	@@date
	${SUDO} ${INSTALL} -c -o root -g wheel -m 444 \
	    ${BSDOBJDIR}/INSTALL ${BSDRELDIR}/base/snapshot/* ${BSDRELDIR}/rel/
	${SUDO} ${INSTALL} -c -o root -g wheel -m 444 \
	    ${BSDSRCDIR}/distrib/empty.ngz ${BSDRELDIR}/rel/fixes${OSrev}.ngz
	${SUDO} ${INSTALL} -c -o root -g wheel -m 444 \
	    ${BSDSRCDIR}/distrib/empty.ngz ${BSDRELDIR}/rel/site${OSrev}.ngz
.for _set in ${_DISTS}
	-cd ${BSDSRCDIR}/distrib/lists/${_set} && env doz=${TSCOMPRESS:L:Q} \
	    DESTDIR=${BSDRELDIR:Q}/${_set} RELEASEDIR=${BSDRELDIR:Q}/rel \
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/tarsets make ${OSrev}
.endfor
	-cd ${BSDRELDIR}/rel; \
	    ${SUDO} rm -f CKSUM* index.txt; \
	    ( \
		/bin/ls -d1 !(@@(Build|index.txt)*); \
		echo CKSUM; \
		echo CKSUM.gz; \
		echo index.txt; \
	    ) | ${SUDO} sort -uo index.txt; \
	    sort -k3 |& exec 3>&p; exec 4<&p; \
	    sort |& exec 5>&p; exec 6<&p; \
	    cksum -a cksum -a rmd160 -a tiger !(@@(Build|CKSUM)*) | \
	    while IFS= read -r line; do \
		if [[ $$line = *" = "+([0-9a-fA-F]) ]]; then \
			print -ru5 "$$line"; \
		else \
			print -ru3 "$$line"; \
		fi; \
	    done; \
	    exec 3>&-; exec 5>&-; \
	    (cat <&4; cat <&6) | ${SUDO} dd of=CKSUM 2>/dev/null; \
	    ${SUDO} chmod 755 $$(find . -type d); \
	    ${SUDO} chmod 444 $$(find . -type f); \
	    ${SUDO} chown -R 0:0 .
	@@echo ============================================================
	@@echo Done with MirOS Build.
.if ${DIST_RESTART} != 0
	@@${SUDO} touch ${BSDRELDIR}/rel/Not_an_official_release!
.endif
	@@/bin/ls -Fl ${BSDRELDIR}/rel
	@@date
	@@echo ============================================================

cflags:
	@@print -r -- CFLAGS=\'${CFLAGS:N-Werror:Q} ${COPTS:N-Werror:Q}\'

.PHONY:	afterinstall b-r base-distbuild base-distinstall beforeinstall \
	build-pre cflags cleandir contbuild dist dist-q distrib-dirs \
	do-htman mksystrace mksystrace-dest mksystrace-obj release _do-dist

.include <bsd.subdir.mk>

cleandir:
	-rm -rf ${BSDOBJDIR}/htman
@


1.149
log
@sprinkle a few “ldconfig -R” into the dist process
@
text
@a294 6
	@@if [[ ! -x /usr/mpkg/bin/gmake ]] || \
	    ! /usr/mpkg/bin/gmake --version >/dev/null; then \
		print 'To build gcc you must have GNU make installed!'; \
		${SUDO} rm -rf ${HOME}; \
		exit 1; \
	fi
@


1.148
log
@prevent another often cause of build aborts
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.147 2010/01/29 18:29:41 tg Exp $
d73 1
d77 1
d366 1
d373 1
d378 1
@


1.147
log
@improve the test if this can really be used
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.146 2010/01/14 11:01:44 tg Exp $
d281 2
d308 5
a312 2
	@@echo Initialising sudo as ${SUDO:Q}
	${SUDO} true
@


1.146
log
@like lib/ install lib/csu/ and lib/libc/ early to aid rebuilds
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.145 2009/12/27 17:05:39 tg Exp $
d291 2
a292 1
	@@[[ -x /usr/mpkg/bin/gmake ]] || { \
d296 1
a296 1
	}
@


1.145
log
@finish merging using the generated/compiled info/html documentation
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.144 2009/11/15 12:39:33 tg Exp $
d65 3
d70 3
@


1.144
log
@run the “Cute” minimal entropy gathering shell script on first boot, if
available (i386 only, since sparc does not have USB)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.143 2009/09/15 15:33:41 tg Exp $
d212 2
a213 1
	cp ${BSDSRCDIR}/gcc/gpcdoc/gpc{,s,s-de}.html ${BSDOBJDIR}/htman/texinfo/
@


1.143
log
@since building libs sometimes fails, insert another DIST_RESTART level
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.142 2009/08/08 14:14:35 tg Exp $
d223 4
@


1.142
log
@new “make dist-q” variable TSCOMPRESS?=Yes (compress dist sets-p)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.141 2009/03/29 13:04:09 tg Exp $
d64 3
a67 2
	    && ${MAKE} obj \
	    && ${_STCMD_OBJ} ${MAKE} depend \
d107 1
d343 2
d349 1
a349 1
.  if ${DIST_RESTART} < 3
d354 1
a354 1
.if ${DIST_RESTART} < 4
d358 1
a358 1
.if ${DIST_RESTART} < 5
d368 1
a368 1
.if ${DIST_RESTART} < 6
@


1.141
log
@• take care of dbins
• #!/bin/mksh shebang, in most places
• rcsid while here
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.140 2009/03/29 11:09:14 tg Exp $
d20 1
d445 1
a445 1
	-cd ${BSDSRCDIR}/distrib/lists/${_set} && \
@


1.140
log
@unhook dbins and dbinsuid from build
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.139 2009/02/01 11:11:10 tg Exp $
d18 1
a18 1
_SAFEPATH=	/usr/dbin:/bin:/usr/bin:/usr/dsbin:/sbin:/usr/sbin:/usr/X11R6/bin
a27 2
# SUBDIR+= distrib/dbins
# SUBDIR+= distrib/dbinsuid
@


1.139
log
@create the INSTALL file automatically
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.138 2009/01/24 13:39:31 tg Exp $
d28 2
a29 2
  SUBDIR+= distrib/dbins
  SUBDIR+= distrib/dbinsuid
@


1.138
log
@add /usr/ports/{Distfiles,Packages} directories with correct perms
to ports10.ngz
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.137 2008/12/10 18:40:14 tg Exp $
d416 2
d439 2
a440 2
	cd ${BSDRELDIR}/base/snapshot && ${SUDO} ${INSTALL} -c \
	    -o root -g wheel -m 444 * ${BSDRELDIR}/rel/
@


1.137
log
@eurynome: anoncvs@@ → _anoncvs@@
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.136 2008/08/20 18:26:21 tg Exp $
d383 1
@


1.136
log
@create empty fixes10.ngz and site10.ngz to prevent problems with the
installer not verifying if the sets listed in index.txt actually exist
(the empty.ngz file hand-crafted #)

spotted by folken at Chaostreff Basel in Muttenz, yesternight, too
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.135 2008/08/19 17:17:30 tg Exp $
d17 1
a17 1
ANONCVSROOT?=	anoncvs@@anoncvs.mirbsd.org:/cvs
d85 1
a85 1
	cd ${DESTDIR}/var/anoncvs/anoncvs && \
@


1.135
log
@enhance check on $CVSROOT validity for bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.134 2008/07/26 20:21:08 tg Exp $
d438 4
a453 2
		echo fixes${OSrev}.ngz; \
		echo site${OSrev}.ngz; \
@


1.134
log
@disable automated baselive CD building capability due to me not wanting
to cope with the bugs in J�rg Schilling’s mkisofs(8) any longer
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.133 2008/07/19 21:11:21 tg Exp $
d285 3
a287 2
	@@c='${CVSROOT}'; [[ $$c = *@@(@@)*@@(:/)* || -e $$c/CVSROOT/config ]] || \
	    {	print 'To build a full release CVSROOT must point to the'; \
@


1.133
log
@if /var/anoncvs/anoncvs is R/O, don’t fail
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.132 2008/07/14 12:14:38 tg Exp $
a251 8
dist-ql: dist-q
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:M*:Q} \
	    HOME=/ PATH=${_SAFEPATH} TZ=UTC ${MAKE} _do-livecd

dist-qlq: dist-q
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:M*:Q} \
	    HOME=/ PATH=${_SAFEPATH} TZ=UTC BATCH=Yes ${MAKE} _do-livecd

a475 18
_do-livecd:
	@@echo ============================================================
.if (${MACHINE_ARCH} == "sparc")
	@@echo Cannot build the Baselive CD on sparc.
.elif !exists(${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c) || \
    !exists(${BSDSRCDIR}/contrib/code/jupp/jupprc)
	@@echo Cannot build the Baselive CD: your checkout is incomplete.
.elif defined(QUICK_DIST2)
	@@echo Cannot build the Baselive CD: QUICK_DIST mode selected.
.else
	cd ${BSDSRCDIR}/distrib/baselive && \
	    BATCH=${BATCH:Q} ${MAKE} it #cleanworkdir
	@@echo
	@@echo Done with MirOS Baselive-CD generation.
	@@/bin/ls -Fl ${BSDOBJDIR}/distrib/baselive/livecd${OSrev}.iso
	@@echo ============================================================
.endif

d479 3
a481 4
.PHONY:	_do-dist _do-livecd afterinstall b-r base-distbuild base-distinstall \
	beforeinstall build-pre cflags cleandir contbuild dist dist-q \
	dist-ql dist-qlq distrib-dirs do-htman mksystrace mksystrace-dest \
	mksystrace-obj release
@


1.132
log
@fix reverse logic error… *sigh*
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.131 2008/07/12 21:39:51 tg Exp $
d86 4
a89 2
	    ${SUDO} rm -f usr var && \
	    ${SUDO} ln -s . var
@


1.131
log
@improve snapshot and live cd generation again: adds new targets dist-ql[q]
and removes live cd generation from dist[-q] and Build.log; echo WRKDIR
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.130 2008/07/10 18:10:06 tg Exp $
d436 1
a436 1
.if ${BATCH:L} == "yes"
@


1.130
log
@fix the output for !livecd builds a little
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.129 2008/07/10 14:40:53 tg Exp $
a15 4
.if ${MACHINE_ARCH} == "sparc"
# cannot be implemented until boot(8/sparc) parses boot.cfg
NO_LIVECD=	ENOCOFFEE
.endif
d232 1
a232 1
dist-q:
d236 1
a236 1
	    ${MAKE} BATCH=Yes _do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
d241 1
a241 1
dist:
d244 1
a244 1
	    PATH=${_SAFEPATH} TZ=UTC \
d250 8
a258 4
.if !exists(${BSDSRCDIR}/contrib/code/Snippets/tinyirc.c) || \
    !exists(${BSDSRCDIR}/contrib/code/jupp/jupprc)
NO_LIVECD=	incomplete
.endif
a260 1
NO_LIVECD=	implied
a320 10
.ifdef NO_LIVECD
.  if ${MACHINE_ARCH} == "sparc"
	@@echo SPARC dist-build mode active:
.  elif ${NO_LIVECD} == "incomplete"
	@@echo Your checkout is not complete:
.  elif !defined(QUICK_DIST)
	@@echo QUICK dist-build mode active:
.  endif
	@@echo not building the baselive CD image.
.endif
a478 1
.if !defined(NO_LIVECD)
a479 1
.endif
d481 11
a491 1
.if !defined(NO_LIVECD)
d493 1
a493 1
	    ${MAKE} BATCH=${BATCH:Q} it #cleanworkdir
d495 1
a495 1
	@@echo Done with MirOS Snapshot generation.
d503 4
a506 3
.PHONY:	beforeinstall afterinstall mksystrace mksystrace-obj mksystrace-dest \
	build-pre contbuild distrib-dirs b-r release do-htman \
	base-distbuild base-distinstall dist-q dist _do-dist cleandir cflags
@


1.129
log
@htpsd, htusd are long gone
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.128 2008/07/09 23:57:20 tg Exp $
d323 5
a327 1
.  ifndef QUICK_DIST
a329 3
.  if ${NO_LIVECD} == "incomplete"
	@@echo Your checkout is not complete:
.  endif
@


1.128
log
@improve synchronised/manual i386+sparc snapshot generation
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.127 2008/07/03 19:13:42 tg Exp $
d425 2
a426 2
	if [[ ! -e ${BSDRELDIR}/rel/htpsd${OSrev}.ngz || \
	    ! -e ${BSDRELDIR}/rel/htusd${OSrev}.ngz ]]; then \
@


1.127
log
@add a “make cflags” here, as I need it *so* often…
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.126 2008/05/01 01:13:47 tg Exp $
d23 1
d240 1
a240 1
	    ${MAKE} BATCH=1 _do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
d310 1
a310 1
.ifdef BATCH
d446 1
a446 1
.ifndef BATCH
d494 2
a495 1
	cd ${BSDSRCDIR}/distrib/baselive && ${MAKE} it #cleanworkdir
@


1.126
log
@another typo or pasto
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.125 2008/05/01 01:12:38 tg Exp $
d500 3
d505 1
a505 1
	base-distbuild base-distinstall dist-q dist _do-dist cleandir
@


1.125
log
@typo
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.124 2008/04/11 20:06:10 tg Exp $
d22 1
a22 1
_SAFEPATH=	/usr/dbin/bin:/usr/bin:/usr/dsbin:/sbin:/usr/sbin:/usr/X11R6/bin
@


1.124
log
@dbin here too
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.123 2008/04/02 18:56:17 tg Exp $
d238 1
a238 1
	    PATH=${SAFEPATH} TZ=UTC \
d247 1
a247 1
	    PATH=${SAFEPATH} TZ=UTC \
@


1.123
log
@bsiegert@@ wants a talking (self-explaining) name for the (security) updates
from the -stable branch
→ introduce fixes10.ngz
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.122 2008/04/02 00:17:27 tg Exp $
d22 1
d238 1
a238 1
	    PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/X11R6/bin TZ=UTC \
d247 1
a247 1
	    PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/X11R6/bin TZ=UTC \
@


1.122
log
@in the future, add site10.ngz to the index.txt too, to ease updates
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.121 2008/03/27 19:05:10 tg Exp $
d463 1
@


1.121
log
@• move all the formerly statically linked binaries to /usr/d{,s}bin/ and
  link them dynamically, except…
  ‣ init(8) since it’s used for system startup (chflags(8) comes to mind)
  ‣ shutdown(8) since it’s 4550 root:operator, which would be hard to do
    in a non-exploitable way otherwise
  ‣ test(1), domainname(1), dhclient-script, since they are shell scripts
  ‣ ldconfig(8) to prevent shooting into ourselves’ feet
• add the build of two crunchgen(1)d binaries, dbins and dbinsuid, collec-
  ting the stuff formerly statically built (dbins is 0555 root:bin, while
  dbinsuid is 4555 root:bin – {ping,traceroute}{,6} only)
• some cosmetical et al. changes to the Makefiles involved
  ‣ spacing, shell
  ‣ utf-8
  ‣ use ${CONFGRP}
• CFLAGS+=-DNFS -I… → CPPFLAGS+=… *sigh*

This enables us to make most out of ports/sysutils/fakeroot

agreed bsiegert@@
“fakeroot ist cool” Jonathan Schleifer
idea from and “:-)” Han Boetes
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.120 2007/10/21 15:43:48 tg Exp $
d463 1
@


1.120
log
@simplify manpage generation; implement MD-only generation
untested (both modūs operandi)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.119 2007/10/21 13:25:54 tg Exp $
d30 2
@


1.119
log
@genhtman.sh can be trusted, it doesn’t need to be systrace(1)d
it will never write outside of BSDOBJDIR
→ another rather large speed-up
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.118 2007/10/18 19:40:26 tg Exp $
d116 11
a126 3
	-rm -rf ${BSDOBJDIR}/htman
	mkdir -p ${BSDOBJDIR}/htman/{man,htm}
	cd ${BSDOBJDIR}/htman && env WRITEDIR=${BSDOBJDIR:Q}/htman \
a127 12
.for _set _dir in x11 X11R6 base share
	cd ${BSDRELDIR}/${_set}/usr/${_dir}/man && \
	    find * -type f -o -type l | cpio -pdlu ${BSDOBJDIR}/htman/man
.endfor
	cd ${BSDOBJDIR}/htman && tar xzf \
	    ${BSDRELDIR}/rel/ports${OSrev}.ngz usr/ports/Setup.sh.8 && \
	    ${NROFF} -mdoc usr/ports/Setup.sh.8 \
	    >${BSDOBJDIR}/htman/man/cat8/Setup.sh.0
	cd ${BSDOBJDIR}/htman && tar xzf \
	    ${BSDRELDIR}/rel/pkgutl${OSrev}.ngz usr/mpkg/man/cat?/*.0
	cd ${BSDOBJDIR}/htman/usr/mpkg/man && \
	    find * -type f -o -type l | cpio -pdlu ${BSDOBJDIR}/htman/man
d129 1
a129 4
	mkdir -p ${BSDOBJDIR}/htman/papers/${_doc}
	cd ${BSDOBJDIR}/htman/papers/${_doc} && \
	    lndir ${BSDRELDIR}/base/usr/share/doc/${_doc} && \
	    ${_STCMD_HTMAN} ${MAKE}
d131 1
a131 4
	mkdir -p ${BSDOBJDIR}/htman/texinfo
	cd ${BSDOBJDIR} && env WRITEDIR=${BSDOBJDIR:Q} \
	    ${SHELL} ${BSDSRCDIR}/scripts/systrace.mk ${MAKE} ${SHELL}
	cd ${.CURDIR} && ${_STCMD_OBJ} ${MAKE} do-htinfo
a132 23
	cp ${BSDOBJDIR}/share/doc/legal/LICENCE-BSD.0 \
	    ${BSDOBJDIR}/htman/man/cat7/BSD-Licence.0
	BSDOBJDIR=${BSDOBJDIR:Q} BSDSRCDIR=${BSDSRCDIR:Q} \
	    ${SHELL} ${.CURDIR}/scripts/genhtman.sh
	. ${.CURDIR}/scripts/roff2htm; output_htaccess >${BSDOBJDIR}/htman/H
	-rm -f ${BSDOBJDIR}/htman/.policy.mk
	${SUDO} mkdir -p ${BSDRELDIR}/htman/man{DOCS,INFO}
	cd ${BSDOBJDIR}/htman/htm && \
	    find * -type f -o -type l | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman/
	cd ${BSDOBJDIR}/htman/texinfo && \
	    ${SUDO} pax -rw *.html ${BSDRELDIR}/htman/manINFO/
	cd ${BSDRELDIR}/base/usr/share/doc/html && \
	    ${SUDO} pax -rw * ${BSDRELDIR}/htman/manDOCS/
	cd ${BSDRELDIR}/htman/manDOCS && ${SUDO} rm -f \
	    $$(find . -type f -a ! -name '*.htm' -a \
		! -name '*.html' -a ! -name '*.jpg')
	cd ${BSDOBJDIR}/htman && \
	    ${SUDO} cp H ${BSDRELDIR}/htman/.htaccess && \
	    ${SUDO} cp H ${BSDRELDIR}/htman/manDOCS/.htaccess && \
	    print "AddType 'text/html; charset=iso-8859-1' html" >>H && \
	    ${SUDO} cp H ${BSDRELDIR}/htman/manINFO/.htaccess
	${SUDO} chown -R 0:0 ${BSDRELDIR}/htman/*
	${SUDO} chmod -R a=rX ${BSDRELDIR}/htman/*
d134 1
a134 1
do-htinfo:
@


1.118
log
@copy symbolic links too, not only files, for htman stuff
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.117 2007/10/18 18:42:08 tg Exp $
d146 1
a146 1
	    ${_STCMD_HTMAN} ${SHELL} ${.CURDIR}/scripts/genhtman.sh
@


1.117
log
@our build script has issues with spaces in filenames, this is quick fix
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.116 2007/10/16 22:24:36 tg Exp $
d131 1
a131 1
	    find * -type f | cpio -pdlu ${BSDOBJDIR}/htman/man
d151 1
a151 1
	    find man* -type f | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman/
d153 1
a153 1
	    find *.html | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman/manINFO/
@


1.116
log
@document _why_ there is no sparc baselive CD yet
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.115 2007/10/02 18:42:11 tg Exp $
d513 1
a513 1
	@@${SUDO} touch ${BSDRELDIR}/rel/'Not an official release!'
@


1.115
log
@htman: docs/ → manDOCS/ to better accomodate changeset 10047025D2D55AD7C34
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.114 2007/10/02 18:26:25 tg Exp $
d17 1
@


1.114
log
@get rid of snap_md
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.113 2007/08/25 17:48:17 tg Exp $
d148 1
a148 1
	${SUDO} mkdir -p ${BSDRELDIR}/htman/{docs,manINFO}
d154 2
a155 2
	    ${SUDO} pax -rw * ${BSDRELDIR}/htman/docs/
	cd ${BSDRELDIR}/htman/docs && ${SUDO} rm -f \
d160 1
a160 1
	    ${SUDO} cp H ${BSDRELDIR}/htman/docs/.htaccess && \
@


1.113
log
@unbreak build
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.112 2007/08/24 14:12:17 tg Exp $
d254 4
a258 1
	cd ${.CURDIR}/etc && exec ${_STCMD_DEST} ${MAKE} snap_md
@


1.112
log
@• new ${_STCMD_HTMAN}: do not use ${_STCMD} directly except in Makefile.inc
• new .if defined(CUSTOM_NO_SYSTRACE) && ${CUSTOM_NO_SYSTRACE:L} != "no"
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.111 2007/08/19 12:16:20 tg Exp $
d140 1
a140 1
	cd ${.CURDIR} && ${_STFILE_OBJ} ${MAKE} do-htinfo
@


1.111
log
@no livecd for sparc yet; fix typo too
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.110 2007/08/07 18:05:10 tg Exp $
d133 3
a135 3
	cd ${BSDOBJDIR}/htman/papers/${_doc} \
	    && lndir ${BSDRELDIR}/base/usr/share/doc/${_doc} \
	    && ${_STCMD} -f ${BSDOBJDIR}/htman/.policy.mk ${MAKE}
d140 1
a140 2
	cd ${.CURDIR} && ${_STCMD} -f ${BSDOBJDIR}/.policy.mk \
	    ${MAKE} do-htinfo
d145 1
a145 2
	    ${_STCMD} -f ${BSDOBJDIR}/htman/.policy.mk \
	    ${SHELL} ${.CURDIR}/scripts/genhtman.sh
@


1.110
log
@missing var defns
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.109 2007/08/07 18:03:31 tg Exp $
d16 3
d315 1
a315 1
		{SUDO} rm -rf ${HOME}; \
@


1.109
log
@.if exists(gcc/Makefile.lang)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.108 2007/07/09 00:24:55 tg Exp $
d11 3
@


1.108
log
@check for contrib checkout and fix spelling
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.107 2007/06/16 21:13:55 tg Exp $
d9 3
a11 1
.include "gcc/Makefile.lang"
@


1.107
log
@unbreak htinfo generation
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.106 2007/06/09 18:49:39 tg Exp $
d274 4
d345 3
@


1.106
log
@• just in case…
• ldint was missing
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.105 2007/06/08 11:17:31 tg Exp $
d162 1
a162 1
	    rm -f {bfd,bfdint}.html &&
d169 1
a169 1
	    rm -f binutils.html &&
d174 1
a174 1
	    rm -f as.html &&
d179 1
a179 1
	    rm -f {gdb,gdbint,stabs,annotate}.html &&
d192 1
a192 1
	    rm -f ld{,int}.html &&
d203 1
a203 1
	    rm -f cvs{,client}.html &&
d210 1
a210 1
	    rm -f {cpp{,internals},gcc{,int}}.html &&
d222 1
a222 1
	    rm -f gnat{_ugn_unw,_rm,-style}.html &&
@


1.105
log
@fix info->html generation, sync
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.104 2007/06/07 02:31:18 tg Exp $
d162 1
d169 1
d174 1
d179 1
d192 1
d201 1
a201 1
	    cp ld.html ${BSDOBJDIR}/htman/texinfo/
d203 1
d210 1
d219 1
a219 1
	    cp {cpp,gcc,gccint,cppinternals}.html ${BSDOBJDIR}/htman/texinfo/
d222 1
@


1.104
log
@meh, don't play the charset dance, just install them as latin1, speeds up
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.103 2007/06/07 02:11:04 tg Exp $
d130 3
a132 1
	cd ${.CURDIR} && ${_STCMD} -f ${BSDOBJDIR}/htman/.policy.mk \
d134 1
a134 2
	cd ${BSDSRCDIR}/gnu/usr.bin/cvs/obj/doc && \
	    makeinfo --no-split --html -I /usr/src/gnu/usr.bin/cvs/doc /usr/src/gnu/usr.bin/cvs/doc/cvs.texinfo
d146 1
a146 1
	    find *.htm | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman/manINFO/
d173 1
a173 1
	    ${BSDSRCDIR}/gnu/usr.bin/binutils/bfd/doc/as.texinfo && \
d384 1
d388 1
@


1.103
log
@unbreak inter-document hrefs
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.102 2007/06/07 01:54:42 tg Exp $
d151 5
a155 5
	${SUDO} cp ${BSDOBJDIR}/htman/H ${BSDRELDIR}/htman/.htaccess
	${SUDO} cp ${BSDOBJDIR}/htman/H ${BSDRELDIR}/htman/manINFO/.htaccess
	print '/htm$$/t.\ns//&l/\nwq' | \
	    ${SUDO} ed -s ${BSDRELDIR}/htman/manINFO/.htaccess
	${SUDO} cp ${BSDOBJDIR}/htman/H ${BSDRELDIR}/htman/docs/.htaccess
d165 1
a165 4
	    for file in bfd.html bfdint.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d169 1
a169 4
	    for file in binutils.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d173 1
a173 4
	    for file in as.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d185 1
a185 4
	    for file in {gdb,gdbint,stabs,annotate}.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d195 1
a195 4
	    for file in ld.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d201 1
a201 4
	    for file in cvs.html cvsclient.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d211 1
a211 4
	    for file in {cpp,gcc,gccint,cppinternals}.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d223 1
a223 4
	    for file in {gnat_ugn_unw,gnat_rm,gnat-style}.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	    done
d226 1
a226 4
	for file in ${BSDSRCDIR}/gcc/gpcdoc/*.html; do \
		iconv -f iso-8859-1 -t utf-8 $$file \
		    >${BSDOBJDIR}/htman/texinfo/$$file; \
	done
a227 3
	cd ${BSDOBJDIR}/htman/texinfo && for file in *.html; do \
		print '/iso-8859-1/s//utf-8/\nwq' | ed -s $$file; \
	done
@


1.102
log
@• gpc docs: regenerate info and generate html
• Makefile: add, experimentally, HTML versions of the (all) Texinfo pages
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.101 2007/05/17 14:52:24 tg Exp $
d153 2
d165 4
a168 1
	    cp bfd.html bfdint.html ${BSDOBJDIR}/htman/texinfo/
d172 4
a175 1
	    cp binutils.html ${BSDOBJDIR}/htman/texinfo/
d179 4
a182 1
	    cp as.html ${BSDOBJDIR}/htman/texinfo/
d194 4
a197 1
	    cp {gdb,gdbint,stabs,annotate}.html ${BSDOBJDIR}/htman/texinfo/
d207 4
a210 1
	    cp ld.html ${BSDOBJDIR}/htman/texinfo/
d216 5
a220 2
	    cp cvs.html cvsclient.html ${BSDOBJDIR}/htman/texinfo/
	cd ${BSDOBJDIR}/htman/texinfo && \
d228 5
a232 1
	    ${BSDSRCDIR}/gcc/gcc/doc/cppinternals.texi
d244 4
a247 1
	    cp {gnat_ugn_unw,gnat_rm,gnat-style}.html ${BSDOBJDIR}/htman/texinfo/
d250 4
a253 1
	cp ${BSDSRCDIR}/gcc/gpcdoc/*.html ${BSDOBJDIR}/htman/texinfo/
d256 1
a256 2
		iconv -f iso-8859-1 -t utf-8 $$a >$${a%l}; \
		print '/iso-8859-1/s//utf-8/\nwq' | ed -s $${a%l}; \
@


1.101
log
@experimental new variable DIST_RESTART, for use by ME only,
and not for official snapshots/releases
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.100 2007/05/10 13:09:21 tg Exp $
d9 1
d129 5
d141 1
a141 1
	${SUDO} mkdir -p ${BSDRELDIR}/htman/docs
d144 2
d152 1
d157 73
a276 4
.ifdef QUICK_DIST2
.  include "gcc/Makefile.lang"
.endif

@


1.100
log
@• fix missing ZCONST
• fix floppy ramdisk not fitting (probably due to whirlpool etc. addition)
• fix symlink'd manpages (XFree86®) missing from the htman set (the MLINKS
  from base are hardlink'd)

not a full sync, but close
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.99 2007/05/09 06:59:43 tg Exp $
d193 1
d258 3
a260 1
.ifdef NFS_DIST
d280 1
d282 3
d287 1
d289 1
d292 1
d294 1
d296 1
d300 1
a300 1
.ifndef QUICK_DIST2
d303 1
d407 3
@


1.99
log
@don't checksum Build.log nor include it in index.txt
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.98 2007/05/09 06:57:47 tg Exp $
d112 1
a112 1
	    find * -type f | cpio -pdlu ${BSDOBJDIR}/htman/man
@


1.98
log
@make sure leftovers don't creep in
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.97 2007/03/09 11:31:49 tg Exp $
d372 1
a372 1
		/bin/ls -d1 !(index.txt*); \
d379 1
a379 1
	    cksum -a cksum -a rmd160 -a tiger !(CKSUM*) | \
@


1.97
log
@use a combination of a CRC and two hashes from different families to
checksum the dist sets (ISO 8802-3: 1989 cksum, RIPEMD-160, TIGER) -
now we “only” need to fix gzsig(1) and the MirPorts pkgtools…
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.96 2007/02/08 21:13:33 tg Exp $
d235 1
@


1.96
log
@* add .htaccess to htman top-level dir and docs/ subdir
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.95 2007/02/05 17:50:28 tg Exp $
d369 1
a369 1
	    ${SUDO} rm -f CKSUM* RMD160* index.txt; \
d373 1
a373 2
		echo RMD160.gz; \
		echo RMD160; \
d376 12
a387 4
	    cksum -a cksum -a rmd160 !(@@(CKSUM|RMD160)*) | \
	    ${SUDO} tee CKSUM~ | fgrep RMD160 | ${SUDO} sort -uo RMD160; \
	    fgrep -v RMD160 CKSUM~ | ${SUDO} sort -k3 -uo CKSUM; \
	    ${SUDO} rm -f CKSUM~; \
@


1.95
log
@add /usr/share/doc/html to ht* stuff
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.94 2007/01/27 14:54:37 tg Exp $
d133 1
d143 2
@


1.94
log
@actualise the whatis.db after _all_ manpages, including gcc,
have been installed
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.93 2007/01/26 18:57:06 tg Exp $
d134 8
a141 3
	${SUDO} mkdir -p ${BSDRELDIR}/htman
	cd ${BSDOBJDIR}/htman/htm \
	    && find man* -type f | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman/
@


1.93
log
@output date after (successful or failing) build
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.92 2007/01/23 11:18:42 tg Exp $
d152 1
@


1.92
log
@fix copying the Build.log to release dir
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.91 2007/01/22 19:51:59 tg Exp $
d161 1
d170 1
d377 2
d380 1
a380 1
	@@/bin/ls -Fl ${BSDRELDIR}/rel
a385 1
	@@date
@


1.91
log
@check for GNU make before building
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.90 2006/12/23 04:36:22 tg Exp $
d161 2
a162 1
	cp ${.CURDIR}/Build.log ${BSDRELDIR}/rel/
d169 2
a170 1
	cp ${.CURDIR}/Build.log ${BSDRELDIR}/rel/
@


1.90
log
@auto-save Build.log after completion (*sigh*)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.89 2006/12/22 21:14:03 tg Exp $
d194 5
a198 4
	@@[[ -e /usr/X11R6/include/X11/X.h && -e /usr/X11R6/lib/libX11.a ]] \
	    || { print 'To build gcc/libjava you must have X11 installed!'; \
		 ${SUDO} rm -rf ${HOME}; \
		 exit 1; }
d201 5
d207 6
a212 5
	@@c='${CVSROOT}'; [[ $$c = *@@(@@)*@@(:/)* || -e $$c/CVSROOT/config ]] \
	    || { print 'To build a full release CVSROOT must point to the'; \
		 print 'locally mounted MirOS /cvs or a remote repository'; \
		 ${SUDO} rm -rf ${HOME}; \
		 exit 1; }
@


1.89
log
@make sure we can umount; cd out if necessary (cvs breaks, etc.)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.88 2006/12/20 15:56:46 tg Exp $
d161 1
d168 1
@


1.88
log
@in case someone wants to build a distribution with BSDOBJDIR and/or
BSDRELDIR mounted via NFS: add new make option NFS_DIST whose presence
replaces the unconditional 'rm -rf BSD{OBJ,REL}DIR' with a more
sophisticated check - they're only cleaned if they're directories
though; if not (symlinks?) it's warned and they're not cleaned
(in case something is mounted on the symlink target), but the
build might fail (PEBKAC, NMP); if they don't exist, they don't
need to be cleaned and will be re-created below anyway, but we
_also_ warn since the user requested the checks via NFS_DIST
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.87 2006/12/20 15:49:32 tg Exp $
d310 1
a310 1
	${SUDO} umount ${BSDRELDIR}/usr; \
@


1.87
log
@if we require /cvs at 'make dist' time, check so beforehand
(with a quirk allowing CVSROOT=user@@host:/repo overrides)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.86 2006/11/17 13:17:41 tg Exp $
d234 16
d251 1
@


1.86
log
@missing Setup.sh(8) man page
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.85 2006/11/17 12:37:04 tg Exp $
d198 7
@


1.85
log
@typo
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.84 2006/11/17 01:52:21 tg Exp $
d115 4
@


1.84
log
@generate HTML manpages from package tools, too (finally, again)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.83 2006/11/17 01:48:55 tg Exp $
d277 1
a277 1
		cd ${BSDRELDIR}; ${SUDO} rm -f base/dev/!(MAKEDEV) \
@


1.83
log
@generate ports earlier (only moves lines)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.82 2006/11/17 01:47:47 tg Exp $
d111 2
a112 2
	cd ${BSDRELDIR}/${_set}/usr/${_dir}/man \
	    && find * -type f | cpio -pdlu ${BSDOBJDIR}/htman/man
d114 4
@


1.82
log
@create /usr/releng/rel early and allow people to populate it while the
normal release process is running, instead of using the /usr/src kludge
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.81 2006/11/17 01:45:33 tg Exp $
a242 27
	if [[ ! -e ${BSDRELDIR}/rel/htpsd${OSrev}.ngz || \
	    ! -e ${BSDRELDIR}/rel/htusd${OSrev}.ngz ]]; then \
		cd ${.CURDIR} && exec ${MAKE} do-htman; \
	fi
.endif
	@@date
	@@echo ============================================================
	@@if [[ -e /var/tmp/.buildnotice ]]; then \
		${SUDO} cat /var/tmp/.buildnotice; \
		${SUDO} ${MKSH} /var/tmp/.buildnotice; \
		${SUDO} rm -f /var/tmp/.buildnotice || true; \
		echo ============================================================; \
	fi
	@@echo Checking files:
	@@echo
.for _set in ${_DISTS}
	-cd ${BSDSRCDIR}/distrib/lists/${_set} && \
	    DESTDIR=${BSDRELDIR:Q}/${_set} RELEASEDIR=${BSDRELDIR:Q}/rel \
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/tarsets check
.endfor
	@@echo ============================================================
.ifndef BATCH
	@@date
	@@read a?'Press Return to continue...'
.endif
	@@date
.ifndef QUICK_DIST
d280 25
d306 1
@


1.81
log
@livecd is NO_LIVECD; QUICK_DIST2 implies NO_LIVECD since baselive needs X11
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.80 2006/11/17 01:43:32 tg Exp $
d221 1
a221 1
	${SUDO} install -d -o 0 -g 0 -m ${DIRMODE} ${BSDRELDIR}/{base,x11}
a247 2
	${SUDO} rm -rf ${BSDRELDIR}/rel
	mkdir ${BSDRELDIR}/rel
a249 5
	@@for f in ${BSDSRCDIR}/*${OSrev}.ngz ${BSDSRCDIR}/*.cgz; do \
		[[ -e $$f ]] || continue; \
		${SUDO} ln $$f ${BSDRELDIR}/rel/ || \
		    ${SUDO} cp $$f ${BSDRELDIR}/rel/; \
	done
@


1.80
log
@make QUICK_DIST not skip XFree86® build, but QUICK_DIST2
(QUICK_DIST2 implies QUICK_DIST)

intention: formal releases on sparc could define QUICK_DIST,
do a normal release, then copy over HTML manpages from i386,
since they're MI, same for ports, quickly build pkgutl, then
maybe do a live CD
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.79 2006/11/17 01:36:37 tg Exp $
d163 1
d207 1
a207 1
	@@echo not building ports, package tools, live CD or HTML manual pages.
d212 6
d343 1
a343 1
.if !defined(QUICK_DIST) && !defined(NO_LIVECD)
@


1.79
log
@generate a pkgutl dist set, yay!
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.78 2006/11/02 02:30:39 tg Exp $
d160 3
a162 2
.ifdef QUICK_DIST
_DISTS=	base
d164 4
a167 1
_DISTS=	base x11 htman
d170 1
a170 1
.ifdef QUICK_DIST
d181 1
a181 1
.ifdef QUICK_DIST
d206 4
a209 1
	@@echo not building XFree86, ports, live CD or HTML manual pages.
d216 1
a216 1
.ifndef QUICK_DIST
d226 1
a226 1
.ifndef QUICK_DIST
@


1.78
log
@permission curses
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.77 2006/10/29 12:37:48 tg Exp $
d229 4
a232 1
	cd ${.CURDIR} && exec ${MAKE} do-htman
d263 7
a270 7
		cd ${BSDRELDIR}; \
		if mount 2>&- | fgrep ' on ${BSDRELDIR}/usr ' >&- 2>&-; then \
			${SUDO} umount ${BSDRELDIR}/usr; \
		fi; \
		test ! -e usr || ${SUDO} rm -rf usr; \
		mkdir usr && \
		${SUDO} mount_mfs -s 458752 swap ${BSDRELDIR}/usr && \
d277 23
a299 3
		    gzip -n9 | ${SUDO} dd of=rel/ports${OSrev}.ngz && \
		${SUDO} umount ${BSDRELDIR}/usr; \
	fi
@


1.77
log
@EPERM
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.76 2006/10/29 12:24:02 tg Exp $
d206 1
a207 1
	cd ${.CURDIR} && exec ${MAKE} distrib-dirs DESTDIR=
@


1.76
log
@consolidate tar* scripts into one
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.75 2006/10/29 12:13:30 tg Exp $
d298 3
a300 3
	    chmod 755 $$(find . -type d); \
	    chmod 444 $$(find . -type f); \
	    chown -R 0:0 .
@


1.75
log
@consolidate 'tarports' into Makefile
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.74 2006/10/16 19:19:20 tg Exp $
d251 1
a251 1
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/tarck
d283 1
a283 1
	    ${SUDO} ${SHELL} ${BSDSRCDIR}/scripts/tarmk ${OSrev}
@


1.74
log
@* improve permissions on ${BSDRELDIR}/rel (and live cd)
* fix content of index.txt
* simplify checksumming
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.73 2006/10/14 23:43:02 tg Exp $
d9 3
a11 2
NOMAN?=	no
CVSROOT?=/cvs
d260 17
a276 3
	test -e ${BSDRELDIR}/rel/ports${OSrev}.ngz || env SUDO=${SUDO:Q} \
	    OSrev=${OSrev:Q} BSDRELDIR=${BSDRELDIR:Q} \
	    CVSROOT=${CVSROOT:Q} ${MKSH} ${BSDSRCDIR}/scripts/tarports
@


1.73
log
@the copy case already handled
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.72 2006/10/14 23:28:36 tg Exp $
d271 15
a285 6
	    ${SUDO} rm -f index.txt; \
	    ${SUDO} touch CKSUM RMD160 RMD160.gz index.txt; \
	    /bin/ls -1 | ${SUDO} sort -uo index.txt; \
	    ${SUDO} rm -f CKSUM RMD160 RMD160.gz; \
	    cksum !(@@(source|xfree)${OSrev}.ngz) | ${SUDO} sort -k3 -uo CKSUM; \
	    rmd160 !(CKSUM) | ${SUDO} sort -uo RMD160
@


1.72
log
@fix ports generation; no need to manually copy it in if pregenerated
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.71 2006/10/13 19:33:57 tg Exp $
a257 4
.for _i in ports${OSrev}.ngz source${OSrev}.ngz xfree${OSrev}.ngz
	test ! -e ${BSDSRCDIR}/${_i} || \
	    ${SUDO} ln -s ${BSDSRCDIR}/${_i} ${BSDRELDIR}/rel/
.endfor
@


1.71
log
@improve index.txt generation from what's really there
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.70 2006/10/02 07:38:39 tg Exp $
d258 4
d263 1
a263 1
	test -f ${BSDRELDIR}/rel/ports${OSrev}.ngz || env SUDO=${SUDO:Q} \
a273 4
.for _i in source${OSrev}.ngz xfree${OSrev}.ngz
	test ! -e ${BSDSRCDIR}/${_i} || \
	    ${SUDO} ln -s ${BSDSRCDIR}/${_i} ${BSDRELDIR}/rel/
.endfor
@


1.70
log
@/usr/releng/gcc? no, it's base, sort of.
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.69 2006/09/24 19:00:50 tg Exp $
a164 2
_INDEX_FILES=	CKSUM RMD160 RMD160.gz source${OSrev}.ngz xfree${OSrev}.ngz

d270 1
a270 4
	-cd ${BSDRELDIR}/rel && ${SUDO} touch ${_INDEX_FILES} index.txt
	-cd ${BSDRELDIR}/rel && /bin/ls -1 | ${SUDO} sort -uo index.txt
	-cd ${BSDRELDIR}/rel && ${SUDO} rm -f ${_INDEX_FILES}
.for _i in ${_INDEX_FILES:M*.ngz}
d274 7
a280 2
	-cd ${BSDRELDIR}/rel && cksum * | ${SUDO} sort -k3 -uo CKSUM
	-cd ${BSDRELDIR}/rel && rmd160 !(CKSUM) | ${SUDO} sort -uo RMD160
@


1.69
log
@there is no DIROWN/DIRGRP, use root:wheel for X11 and BINOWN:BINGRP for rest
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.68 2006/09/22 12:31:02 tg Exp $
d207 1
a207 1
	${SUDO} install -d -o 0 -g 0 -m ${DIRMODE} ${BSDRELDIR}/{base,x11,gcc}
@


1.68
log
@prevent X11 sets to have gid wsrc on all files
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.67 2006/09/21 17:07:10 tg Exp $
d207 1
a207 2
	${SUDO} install -d -o ${DIROWN} -g ${DIRGRP} -m ${DIRMODE} \
	    ${BSDRELDIR}/{base,x11,gcc}
@


1.67
log
@improve quoting

:M* idea from NetBSD(R) pkgsrc(R)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.66 2006/08/18 22:39:54 tg Exp $
d207 2
@


1.66
log
@new baselive infrastructure for top-level Makefile (designed to not break build)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.65 2006/07/05 23:59:46 tg Exp $
d37 1
a37 1
	cd ${BSDOBJDIR} && env WRITEDIR="${BSDOBJDIR}" \
d41 2
a42 2
	d="${DESTDIR}"; cd $${d:-/}; [[ -n $$d ]] || d="/:/*"; \
	    env WRITEDIR="$$d" NOWRITEDIR="${BSDOBJDIR}" \
d107 1
a107 1
	cd ${BSDOBJDIR}/htman && env WRITEDIR="${BSDOBJDIR}/htman" \
d121 1
a121 1
	BSDOBJDIR="${BSDOBJDIR}" BSDSRCDIR="${BSDSRCDIR}" \
d148 1
a148 1
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:Q} \
d154 1
a154 1
	cd ${.CURDIR} && exec /usr/bin/env -i MAKEFLAGS=${MFLAGS:Q} \
d188 1
a188 2
	@@echo "============================================================"
	@@echo Initiating MirOS Build...
d194 1
d205 1
a205 1
	@@echo "============================================================"
d234 1
a234 1
	@@echo "============================================================"
d244 1
a244 1
		echo "============================================================"; \
d246 2
a247 2
	@@echo "Checking files:"
	@@echo ""
d250 1
a250 1
	    DESTDIR="${BSDRELDIR}/${_set}" RELEASEDIR="${BSDRELDIR}/rel" \
d253 1
a253 1
	@@echo "============================================================"
d268 1
a268 1
	    DESTDIR="${BSDRELDIR}/${_set}" RELEASEDIR="${BSDRELDIR}/rel" \
d280 1
a280 1
	@@echo "============================================================"
d284 1
a284 1
	@@echo "============================================================"
d291 1
a291 1
	@@echo "============================================================"
@


1.65
log
@* sync lists (base)
* manually adjust htman too
* add archname to output
* boot.{iso,liv} don't need to be in index.txt
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.64 2006/07/04 03:45:17 tg Exp $
d285 2
a286 3
.if exists(${BSDSRCDIR}/distrib/${MACHINE}/livecd/Makefile) && \
    !defined(QUICK_DIST) && !defined(NO_LIVECD)
	cd ${BSDSRCDIR}/distrib/${MACHINE}/livecd && ${MAKE} it #cleanworkdir
d290 1
a290 1
	@@/bin/ls -Fl ${BSDOBJDIR}/distrib/${MACHINE}/livecd/livecd${OSrev}.iso
@


1.64
log
@the 'cvsup' target isn't needed, it doesn't descend anyway
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.63 2006/07/03 01:19:54 tg Exp $
d165 1
a165 2
_INDEX_FILES=	CKSUM RMD160 RMD160.gz boot.iso boot.liv \
		source${OSrev}.ngz xfree${OSrev}.ngz
@


1.63
log
@/etc/mtree/special was not intended to be used for creation
don't create ${BSDRELDIR}/base/dev/fd
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.62 2006/07/02 18:18:11 tg Exp $
a295 3
cvsup:
	cd ${.CURDIR} && cvs -Rqz3 -d ${CVSROOT} up -PAd [!BCXcptw]!(*cc) .*

d298 1
a298 1
	base-distbuild base-distinstall dist-q dist _do-dist cvsup cleandir
@


1.62
log
@use UTC for build logs, always, period.
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.61 2006/07/02 18:17:38 tg Exp $
d72 2
a73 1
	${SUDO} mtree -p ${DESTDIR}/ -Uqdef ${.CURDIR}/etc/mtree/special
@


1.61
log
@if batch, show when it's happening
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.60 2006/07/01 00:48:20 tg Exp $
d149 1
a149 1
	    PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/X11R6/bin \
d155 1
a155 1
	    PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/X11R6/bin \
@


1.60
log
@oops
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.59 2006/07/01 00:46:50 tg Exp $
d255 1
@


1.59
log
@prevent clash between 4.4BSD.dist and special re. special dirs
and more lenient perms in 4.4BSD.dist for mirports users
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.58 2006/07/01 00:34:59 tg Exp $
d209 1
@


1.58
log
@install files to BSDRELDIR only muuuuuuuuch later
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.57 2006/06/25 05:39:48 tg Exp $
d72 1
@


1.57
log
@allow flag for no livecd building
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.56 2006/06/16 22:55:09 tg Exp $
a92 1
	cd ${.CURDIR} && exec ${MAKE} contrelease DESTDIR=${BSDRELDIR}/base
d94 1
a94 5
cont-b-r:
	cd ${.CURDIR} && exec ${MAKE} contbuild DESTDIR=
	cd ${.CURDIR} && exec ${MAKE} contrelease DESTDIR=${BSDRELDIR}/base

contrelease:
a207 1
.ifndef QUICK_DIST
d214 8
d296 1
a296 1
	build-pre contbuild distrib-dirs b-r cont-b-r contrelease do-htman \
@


1.56
log
@make 'share' cross-buildable and installable as non-root;
don't build I18N modules if NOPIC
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.55 2006/06/16 21:54:08 tg Exp $
d281 1
a281 1
    !defined(QUICK_DIST)
@


1.55
log
@include gnu (not yet finished) and sys in cross build
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.54 2006/06/16 15:16:56 tg Exp $
a18 1
.if ${CROSS_MODE:L} != "yes"
a19 1
.endif
@


1.54
log
@generate ports tarball with all the others, together
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.53 2006/06/09 01:23:35 tg Exp $
d21 1
a23 1
.endif
@


1.53
log
@none of our arches has an includes: target in sys
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.52 2006/06/09 01:21:28 tg Exp $
a230 5
.ifndef QUICK_DIST
	@@date
	SUDO=${SUDO:Q} OSrev=${OSrev:Q} BSDRELDIR=${BSDRELDIR:Q} \
	    CVSROOT=${CVSROOT:Q} ${MKSH} ${BSDSRCDIR}/scripts/tarports
.endif
d255 6
@


1.52
log
@* Makefile: allow re-start of failed builds
* include/Makefile: libcdk is no more
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.51 2006/05/26 21:37:57 tg Exp $
d55 1
a55 3
	rm -rf ${BSDOBJDIR}/{lib,sys}
	cd ${.CURDIR}/lib && ${MAKE} obj
	cd ${.CURDIR}/sys && ${MAKE} obj
d57 1
@


1.51
log
@copy .cgz files too
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.50 2006/05/26 20:02:22 tg Exp $
a194 8
.ifndef OVERRIDE_CONTINUE
	@@if [[ -e /var/tmp/.buildnotice ]]; then \
		echo Error: /var/tmp/.buildnotice existed.; \
		${SUDO} cat /var/tmp/.buildnotice; \
		${SUDO} rm -rf ${HOME}; \
		exit 1; \
	fi
.endif
d197 4
a200 3
.ifndef OVERRIDE_CONTINUE
	${SUDO} install -c -o 0 -g 0 -m 600 /dev/null /var/tmp/.buildnotice
.endif
@


1.50
log
@live CD requires X
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.49 2006/05/26 20:01:12 tg Exp $
d246 2
a247 2
	@@for f in ${BSDSRCDIR}/*${OSrev}.ngz; do \
		[[ -e $$f ]] || break; \
@


1.49
log
@* mksh -> ${MKSH}
* copy pre-prepared sets into release dir
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.48 2006/05/26 19:45:37 tg Exp $
d217 1
a217 1
	@@echo not building XFree86, ports or HTML manual pages.
d289 2
a290 1
.if exists(${BSDSRCDIR}/distrib/${MACHINE}/livecd/Makefile)
@


1.48
log
@missing &&
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.45 2006/05/25 21:34:41 tg Exp $
d208 1
a208 1
	${SUDO} mksh -c 'echo rm -rf ${HOME} >>/var/tmp/.buildnotice'
d246 5
d253 1
a253 1
		${SUDO} /bin/mksh /var/tmp/.buildnotice; \
@


1.47
log
@developer helpers (not affecting normal builds)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.46 2006/05/26 17:09:20 tg Exp $
d139 1
a139 1
	cd ${.CURDIR}/distrib ${_STCMD_OBJ} ${MAKE} depend && \
@


1.46
log
@depend the tools before building them
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.45 2006/05/25 21:34:41 tg Exp $
d195 1
d202 1
d205 1
d207 1
@


1.45
log
@don't cleanworkdir after live cd generation, user can do that himself
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.44 2006/05/25 21:34:11 tg Exp $
d139 2
a140 1
	cd ${.CURDIR}/distrib && exec ${_STCMD_OBJ} ${MAKE}
@


1.44
log
@be more general about live cd targets
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.43 2006/04/19 21:27:06 tg Exp $
d280 1
a280 1
	cd ${BSDSRCDIR}/distrib/${MACHINE}/livecd && ${MAKE} it cleanworkdir
@


1.43
log
@* Makefile: remove RMD160.gz generation which didn't work
* Makefile: add boot.iso, boot.liv to index.txt
* livecd: generate RMD160.gz here instead (actually working)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.42 2006/04/11 05:09:38 tg Exp $
d279 2
a280 2
.if ${MACHINE_ARCH} == "i386"
	cd ${BSDSRCDIR}/distrib/i386/livecd && ${MAKE} it cleanworkdir
d284 1
a284 1
	@@/bin/ls -Fl ${BSDOBJDIR}/distrib/i386/livecd/livecd${OSrev}.iso
@


1.42
log
@clean up live CD workdir immediately after building
while time-costly, shaves off some of the /etc/daily "costs"...
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.41 2006/04/10 21:35:28 tg Exp $
d170 2
a171 1
_INDEX_FILES=	CKSUM RMD160 RMD160.gz source${OSrev}.ngz xfree${OSrev}.ngz
a273 4
	-gzip -n9 <${BSDRELDIR}/rel/RMD160 >${HOME}/RMD160.gz
	# pad for gzsig(1) application later on
	-dd if=/dev/zero bs=768 count=1 >>${HOME}/RMD160.gz
	-${SUDO} mv ${HOME}/RMD160.gz ${BSDRELDIR}/rel/
@


1.41
log
@automatically build the live cd (on i386)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.40 2006/04/10 21:26:29 tg Exp $
d283 1
a283 1
	cd ${BSDSRCDIR}/distrib/i386/livecd && ${MAKE} it
@


1.40
log
@* if /usr/src/{source,xfree}*.ngz exist, link them into BSDRELDIR/rel
  for later processment of livecd/Makefile
* add RMD160.gz (padded with 768 zero bytes for gzsig(1) space)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.39 2006/04/10 21:18:23 tg Exp $
d282 8
@


1.39
log
@build ports8.ngz automatically (from $CVSROOT, default /cvs)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.38 2006/02/24 12:26:18 tg Exp $
d267 4
d273 4
@


1.38
log
@quickly clean only what's clobbered by include prereqs
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.37 2006/02/15 13:20:34 tg Exp $
d10 1
d170 1
a170 2
_INDEX_FILES=	CKSUM RMD160 RMD160.gz ports${OSrev}.ngz \
		source${OSrev}.ngz xfree${OSrev}.ngz
d211 1
a211 1
	@@echo not building XFree86 or HTML manual pages.
d231 7
a256 2
	${SUDO} rm -rf ${BSDRELDIR}/rel
	${SUDO} mkdir ${BSDRELDIR}/rel
a274 1
CVSROOT?=/cvs
@


1.37
log
@* add a few more files to index.txt
* some FOSDEM wlog commentary
* announce new snapshot
* preannounce new cvsrepo seed
* update random content
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.36 2006/02/15 10:14:48 tg Exp $
d54 3
a56 1
	cd ${.CURDIR} && ${SUDO} ${_STCMD_OBJ} ${MAKE} cleandir
@


1.36
log
@DESTDIR is empty that late in the release process
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.35 2006/02/14 22:06:15 tg Exp $
d167 3
d257 1
a257 1
	-cd ${BSDRELDIR}/rel && ${SUDO} touch CKSUM RMD160{,.gz} index.txt
d259 1
a259 1
	-cd ${BSDRELDIR}/rel && ${SUDO} rm -f CKSUM RMD160{,.gz}
@


1.35
log
@if aborting manually clean up buildhome too
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.34 2006/02/14 20:47:51 tg Exp $
d247 2
a248 2
	cd ${DESTDIR}/snapshot && ${SUDO} ${INSTALL} -c -o root -g wheel \
	    -m 444 * ${BSDRELDIR}/rel/
@


1.34
log
@restructure build system for better restartability,
move things to proper places, ensure root-only-access
to .buildnotice hack file, fix a few problems (using
${BSDMAKE} in gcc/Makefile, including wrong files),
use ${SUDO} on different places, ensure DESTDIR is
always correct on make build, move most of the former
'release' targets from src/etc/Makefile to src/Makefile
and remove associated targets in src/etc/Makefile; sync
list of phony targets in both; copy out common code in
distrib/i386/generic/Makefile, distrib/i386/common/Makefile.inc
into new distrib/i386/generic/Makefile.kernel, remove
unused target 'includes' in src/Makefile, rewrite the
distrib-dirs target, shuffle the creation and removal
of the systrace files around, build HTML manual pages
under systrace(1) control, auto-remove tmp buildhome,
check HOME makeenv/environment sync and being tmp, fix
index/checksum file generation, maybe more (read the diff)

untested
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.33 2006/01/31 13:58:25 tg Exp $
d182 1
@


1.33
log
@we don't do h2ph(1) any more - I haven't seen precompiled header
files on any GNU/Linux or Solaris I've come across... let's look
whether something actually breaks.
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.32 2006/01/04 02:22:18 tg Exp $
a26 4
includes:
	cd ${.CURDIR}/include && ${MAKE} prereq \
	    && exec ${SUDO} ${MAKE} includes

a33 1
	-sleep 1; rm -f ${_STFILE_DEST}
d46 3
a48 1
build: mksystrace
a59 2
	# The build is now restartable from here.
	cd ${.CURDIR} && exec ${MAKE} contbuild
d62 1
a62 2
	[[ -s ${_STFILE_OBJ} ]] || ${MAKE} mksystrace-obj
	[[ -s ${_STFILE_DEST} ]] || ${MAKE} mksystrace-dest
d65 2
a66 1
	-sleep 1; rm -f ${_STFILE_OBJ}
d69 11
a79 2
	cd ${.CURDIR}/etc \
	    && exec ${SUDO} ${MAKE} distrib-dirs DESTDIR=${DESTDIR}
d81 1
a81 1
b-r: .PHONY
d91 3
a93 2
	cd ${.CURDIR} && exec ${MAKE} build
	cd ${.CURDIR} && exec ${MAKE} contrelease
d96 2
a97 2
	cd ${.CURDIR} && exec ${MAKE} contbuild
	cd ${.CURDIR} && exec ${MAKE} contrelease
d100 6
a105 6
	@@echo -n >/var/tmp/.buildnotice
	mkdir -p ${BSDRELDIR}/base ${BSDRELDIR}/rel \
	    || ${SUDO} mkdir -p ${BSDRELDIR}/base ${BSDRELDIR}/rel
	cd ${.CURDIR} && exec ${MAKE} mksystrace DESTDIR=${BSDRELDIR}/base
	cd ${.CURDIR}/etc && exec ${MAKE} release DESTDIR=${BSDRELDIR}/base
	-sleep 1; rm -f ${_STFILE_OBJ}
d110 2
d120 1
a120 1
	    && ${MAKE}
d125 1
d127 1
d134 15
d172 5
d187 6
d195 2
d209 1
a209 2
	cd ${.CURDIR}/etc \
	    && exec ${SUDO} ${MAKE} distrib-dirs DESTDIR=
d217 4
a220 2
	cd ${.CURDIR}/gnu/usr.bin/texinfo && exec ${SUDO} ${MAKE} \
	    -f Makefile.bsd-wrapper DESTDIR=${BSDRELDIR}/base mkinfodir
d227 6
d244 4
d253 1
a253 4
	-cd ${BSDRELDIR}/rel && cksum bsd!(*.gz) *boot* *BOOT* *.fs \
	    *.iso *.gz *.ngz | cat - CKSUM | ${SUDO} sort -k3 -uo CKSUM
	-cd ${BSDRELDIR}/rel && rmd160 bsd!(*.gz) *boot* *BOOT* *.fs \
	    *.iso *.gz *.ngz | cat - RMD160 | ${SUDO} sort -uo RMD160
d255 3
a262 1
	@@echo 'You might want to nuke ${HOME} now...'
d268 3
a270 3
.PHONY:	includes beforeinstall afterinstall mksystrace mksystrace-obj \
	mksystrace-dest build contbuild distrib-dirs b-r contrelease \
	cont-b-r cvsup do-htman dist dist-q _do-dist
@


1.32
log
@pgp's dead
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.31 2006/01/04 02:15:10 tg Exp $
a180 2
	cd ${.CURDIR}/gnu/usr.bin/perl && exec ${SUDO} ${MAKE} \
	    -f Makefile.bsd-wrapper DESTDIR=${BSDRELDIR}/base do-h2ph
@


1.31
log
@sync
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.30 2005/12/30 14:05:14 tg Exp $
d211 1
a211 3
	-cd ${BSDRELDIR}/rel && for f in RMD160.asc index.txt *; do \
		print "$$f"; \
	 done | ${SUDO} sort -uo index.txt
@


1.30
log
@if MAKECONF is set, abort (should do this in all places, oh well)
happened by accident (hint: don't source SetEnv.sh when building base)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.29 2005/12/22 01:12:33 tg Exp $
d148 1
a155 1
	mkdir -p ${HOME}/.etc/systrace
@


1.29
log
@* add BSD-Licence(7) to the list of generated HTML manual pages,
  for ports/Setup.sh(8)
* fix .htaccess files missing problem
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.28 2005/12/21 19:26:58 tg Exp $
d4 3
@


1.28
log
@* use /var/tmp
* descriptive end message...
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.27 2005/12/21 19:25:03 tg Exp $
d112 3
a114 2
	BSDOBJDIR="${BSDOBJDIR}" BSDRELDIR="${BSDRELDIR}" \
	    BSDSRCDIR="${BSDSRCDIR}" SUDO="${SUDO}" OSrev="${OSrev}" \
d118 1
a118 1
	    && find man* -name \*.htm | ${SUDO} cpio -pdlu ${BSDRELDIR}/htman
@


1.27
log
@we still do need a $HOME, use mktemp to build one
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.26 2005/12/21 14:59:09 tg Exp $
d123 1
a123 1
	    HOME=$$(/usr/bin/mktemp -d /tmp/buildhome.XXXXXXXXXX) \
d129 1
a129 1
	    HOME=$$(/usr/bin/mktemp -d /tmp/buildhome.XXXXXXXXXX) \
d215 1
@


1.26
log
@we need however to pass ${.MAKEFLAGS} to the target make
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.25 2005/12/21 14:55:50 tg Exp $
d122 2
a123 1
	cd ${.CURDIR} && exec /usr/bin/env -i HOME=/ MAKEFLAGS=${MFLAGS:Q} \
d128 2
a129 1
	cd ${.CURDIR} && exec /usr/bin/env -i HOME=/ MAKEFLAGS=${MFLAGS:Q} \
d151 1
@


1.25
log
@* sync after small build
* well... I've come to a difficult decision. Don't complain if your
  cpio(1) installed via ports is older than the one in base and set
  creation fails - even on default MirOS, a MirPorts installation
  overrides the installed executables (PATH, LD_LIBRARY_PATH, MANPATH,
  INFOPATH, PERL5LIB, etc.), thus...
  but for building snapshots, we use a very stringent environment now
  (yet untested), so that set creation does _not_ fail (I hope)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.24 2005/12/18 16:36:47 tg Exp $
d122 1
a122 1
	cd ${.CURDIR} && exec /usr/bin/env -i HOME=/ \
d127 1
a127 1
	cd ${.CURDIR} && exec /usr/bin/env -i HOME=/ \
@


1.24
log
@Part 2 of the big commit:
* www/vbegin.php: don't output the UTF-8 BOM for now
* ports/Setup.sh: change order in which path is divined [1]
* ports/books/mirex: convert to CVS_DISTF
* ports/comms/ssfe: increase line length limit and history buffer size
* ports/infrastructure/install/setup.sh: sync path order with Setup.sh [1]
* ports/infrastructure/mk/bsd.port.mk: (_PORTPATH) sync default PATH [1]
* ports/infrastructure/mk/bsd.port.mk: (_UPGRADE_FLAGS) new, default to -a
* ports/infrastructure/mk/bsd.port.mk: (_upgrade) use it
* ports/infrastructure/mk/bsd.port.mk: (reupgrade) new target, set to -a -f
* ports/infrastructure/scripts/mkmcz: don't use $LOCALBASE, trust in PATH
* ports/infrastructure/mk/bsd.port.mk: (_CVS_FETCH) use _PORTPATH
* ports/infrastructure/pkgtools/create: treat /usr/info same as /usr/man
* ports/infrastructure/pkgtools/upgrade: fix path to temp +REQUIRED_BY
* ports/www/firesomething: break, suggest Opera-Linux/K-Meleon/Safari
* src/Makefile, src/gcc/Makefile.lang: if build GCJ, check if X11 installed
* src/Makefile, src/gnu/usr.bin/perl/Makefile.bsd-wrapper: defer h2ph
  execution to end of build
* src/distrib/lists: sync with pre-h2ph change
* src/etc/services: add openvpn, from IANA
* src/gcc/Makefile.inc, Makefile.lang: fragment out NO_*= stuff
* src/gcc/libjava/Makefile.bsd-wrapper: DEBUGPROGS is gone
* src/gnu/usr.bin/perl/Makefile.bsd-wrapper: flesh out h2ph, fix perms
* src/lib/libc/time/localtime.c: fix undefined extern
* ports/net/sirc/Makefile: automatically insert version into CTCP VERSION
* ports/net/sirc/dist/PROGRAMMING: document capab hooks
* ports/net/sirc/dist/dsircp: several hours of perl hacking with Club-Mate
  - publish $msgchannel, $talkserver [2]
  - support for CAPAB: publish $has_capab, $capab_cmd, $capab_response;
    add "capab" hook in reply
  - support for CAPAB IDENTIFY-MSG: publish $has_identifymsg; new
    $unverified, $unverified_m; enable automatically if present;
    change <...> [...] -...- to ... [[...]] ...
  - /describe nick now looks [*] (or [[*]]) instead of *, /me now looks
    # instead of * if identified, to facilitate this conversion
  - fix abuse of U+0060
  - sort /names [2]
  - fix ^B ^_ ^V [2]
  - remove trailing whitespace on outgoing msgs [2]
  - remove trailing whitespace on incoming msgs
  - fix indentation
  - auto-split overlong lines (partially [2])
  - in NOTICE make nick bold too [2]
  - disable DCC since it crashes
  - beautify CTCP TIME replies
  - add ACCEPT command (for ratbox-ircd, e.g. Freeforge)
* ports/net/sirc/pkg/DESCR: summarise new features

[1] all for the sake of bsiegert@@ wanting to not have to souce a
    SetEnv.sh or SetEnv.csh before building in "default MirPorts"
    (i.e. LOCALBASE=/usr/mpkg SYSCONFDIR=/etc BINOWN=root SUDO=sudo)
[2] adapted from http://co.ordinate.org/sirc/
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.23 2005/12/05 16:06:01 tg Exp $
d122 3
a124 2
	cd ${.CURDIR} && exec ${MAKE} BATCH=defined \
	    do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
d127 3
a129 2
	cd ${.CURDIR} && exec ${MAKE} \
	    do-dist 2>&1 | tee -a ${.CURDIR}/Build.log
d141 1
a141 1
do-dist:
d219 1
a219 1
	cont-b-r cvsup do-htman dist dist-q do-dist
@


1.23
log
@* Makefile: sprinkle a few @@date
* distrib: sync set lists with reality
* distrib: move PSD man pages and papers into dev set
* sbin/route: sync reality with distribution set lists
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.22 2005/06/14 13:04:39 tg Exp $
d135 4
d140 7
d172 2
d175 1
a175 1
	    -f Makefile.bsd-wrapper mkinfodir DESTDIR=${BSDRELDIR}/base
@


1.22
log
@fix gen-info-dir invocation
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.21 2005/06/13 20:48:48 tg Exp $
d136 2
d156 1
d159 1
d164 1
d167 1
@


1.21
log
@use the mkinfodir target
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.20 2005/06/13 19:53:41 tg Exp $
d157 2
a158 2
	cd ${.CURDIR}/gnu/usr.bin/texinfo && \
	    exec ${MAKE} mkinfodir DESTDIR=${BSDRELDIR}/base
@


1.20
log
@move "gcc" dist set into "dev" dist set
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.19 2005/05/01 23:35:26 tg Exp $
d157 2
@


1.19
log
@so I never forget to make index.txt
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.18 2005/04/29 19:57:40 tg Exp $
d102 1
a102 1
.for _set _dir in x11 X11R6 gcc share base share
d130 1
a130 1
_DISTS=	base gcc
d132 1
a132 1
_DISTS=	base x11 gcc htman
@


1.18
log
@instead of removing build log before cvs up, just exclude it
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.17 2005/04/29 19:21:45 tg Exp $
d181 3
@


1.17
log
@a quick dist mode, only for me
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.16 2005/04/20 06:18:04 tg Exp $
d189 1
a189 2
	-rm -f ${.CURDIR}/Build.log
	cd ${.CURDIR} && cvs -Rqz3 -d ${CVSROOT} up -PAd [!CXcptw]!(*cc) .*
@


1.16
log
@get rid of ${RELEASEDIR} altogether
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.15 2005/04/19 12:53:46 tg Exp $
d129 6
d144 4
d153 1
d155 1
d157 1
d159 1
d163 1
a163 1
.for _set in base x11 gcc htman
d172 1
a172 1
.for _set in base x11 gcc htman
@


1.15
log
@make the overall build process more similar to a build.sh and have a
common framework, with ======== lines and stuff, and the checkflist
and maketars stuff only executed at the end of the whole make dist
(this means they are not built any more with a make b-r, I know).
This also unifies the set generation, runs cksum and rmd160 only
once and makes an unattended non-quiet build possible.
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.14 2005/03/29 22:07:19 tg Exp $
d96 1
a96 2
	cd ${.CURDIR}/etc && exec ${MAKE} \
	    release DESTDIR=${BSDRELDIR}/base RELEASEDIR=${BSDRELDIR}/rel
@


1.14
log
@add htman to cleandir
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.13 2005/03/29 22:05:57 tg Exp $
d54 1
a54 1
	${SUDO} ${_STCMD_OBJ} ${MAKE} cleandir
d59 1
a59 1
	${_STCMD_OBJ} ${MAKE} depend
d61 1
a61 1
	exec ${MAKE} contbuild
d66 2
a67 2
	${_STCMD_OBJ} ${MAKE} \
	    && ${SUDO} ${_STCMD_DEST} ${MAKE} install
d83 3
a85 6
	@@echo ============================================================
	@@date
	@@echo ============================================================
	${MAKE} obj
	${MAKE} build
	${MAKE} contrelease BSDRELDIR=${BSDRELDIR}
d88 2
a89 2
	${MAKE} contbuild
	${MAKE} contrelease BSDRELDIR=${BSDRELDIR}
d95 1
a95 1
	cd ${.CURDIR} && ${MAKE} mksystrace DESTDIR=${BSDRELDIR}/base
a98 4
	@@echo ============================================================
	@@echo Build and Release for the MirOS base system complete.
	@@date; uname -a
	@@echo ============================================================
a120 21
	@@echo "============================================================"
	@@echo "Checking files:"
	@@echo ""
	-cd ${BSDSRCDIR}/distrib/lists/htman && DESTDIR=${BSDRELDIR}/htman \
	    RELEASEDIR=${BSDRELDIR}/rel ${EXTRA_ENV} ${SUDO} ${SHELL} \
	    ${BSDSRCDIR}/scripts/tarck
	@@echo "============================================================"
.ifndef BATCH
	@@read a?'Press Return to continue...'
.endif
	cd ${BSDSRCDIR}/distrib/lists/htman && DESTDIR=${BSDRELDIR}/htman \
	    RELEASEDIR=${BSDRELDIR}/rel ${EXTRA_ENV} ${SUDO} ${SHELL} \
	    ${BSDSRCDIR}/scripts/tarmk ${OSrev}
	-cd ${BSDRELDIR}/rel; cksum htman*.ngz \
	    | cat - CKSUM | ${SUDO} sort -k3 -o CKSUM
	-cd ${BSDRELDIR}/rel; rmd160 htman*.ngz \
	    | cat - RMD160 | ${SUDO} sort -o RMD160
	@@echo ============================================================
	@@echo Build and Release for the HTML Documentation complete.
	@@date; uname -a
	@@echo ============================================================
d131 1
d139 1
d147 22
d172 1
@


1.13
log
@fix htman generation
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.12 2005/03/29 17:33:27 tg Exp $
d187 3
@


1.12
log
@* support finding the actual X11 man pages
* append to log (I suppose it doesn't exist before)
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.11 2005/03/29 17:02:29 tg Exp $
d108 1
d110 1
a110 1
.for _set _dir in x11 share x11 X11R6 gcc share base share
d117 1
a117 1
	    && lndir ${BSDOBJDIR}/base/usr/share/doc/${_doc} \
@


1.11
log
@cont-b-r target
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.10 2005/03/29 13:03:55 tg Exp $
d109 2
a110 2
.for _i in x11 gcc base
	cd ${BSDRELDIR}/${_i}/usr/share/man \
d113 4
a116 4
.for _i in papers psd smm usd
	mkdir -p ${BSDOBJDIR}/htman/papers/${_i}
	cd ${BSDOBJDIR}/htman/papers/${_i} \
	    && lndir ${BSDOBJDIR}/base/usr/share/doc/${_i} \
d151 1
a151 1
	    do-dist 2>&1 | tee ${.CURDIR}/Build.log
d155 1
a155 1
	    do-dist 2>&1 | tee ${.CURDIR}/Build.log
@


1.10
log
@another pleasant target
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.9 2005/03/29 12:27:47 tg Exp $
d90 4
d183 1
a183 1
	cvsup do-htman dist dist-q do-dist
@


1.9
log
@mop up
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.8 2005/03/29 12:24:56 tg Exp $
d146 2
a147 1
	cd ${.CURDIR} && exec ${MAKE} dist BATCH=defined
d150 4
d179 1
a179 1
	cvsup do-htman dist dist-q
@


1.8
log
@we don't need this shell script either
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.7 2005/03/29 12:20:06 tg Exp $
d116 1
a116 1
	    SUDO="${SUDO}" OSrev="${OSrev}" \
@


1.7
log
@move out as much stuff as possible to the Makefile
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.6 2005/03/29 10:49:05 tg Exp $
d145 22
d174 1
a174 1
	cvsup do-htman
@


1.6
log
@hack some of the genhtman script
more to follow
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.5 2005/03/29 00:12:16 tg Exp $
d104 13
a116 1
	BSDRELDIR="${BSDRELDIR}" SUDO="${SUDO}" OSrev="${OSrev}" \
d118 5
@


1.5
log
@WAIT_CHECKFLIST => BATCH and reverse logic
default is now an interactive b-r
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.4 2005/03/15 17:17:59 tg Exp $
d103 25
d135 1
a135 1
	cvsup
@


1.4
log
@make that hint dependant... d'oh
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.3 2005/03/15 17:17:17 tg Exp $
a74 3
.ifndef WAIT_CHECKFLIST
	@@echo "Did you not forget to add WAIT_CHECKFLIST=yes to ${MAKE}?"
.endif
@


1.3
log
@add hint for us builders who want it interactive
@
text
@d1 1
a1 1
# $MirOS: src/Makefile,v 1.2 2005/03/06 21:27:25 tg Exp $
d75 1
d77 1
@


1.2
log
@merge top-level
@
text
@d1 1
a1 1
# $MirOS$
d75 1
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile,v 1.108 2004/11/30 15:46:01 mickey Exp $
d4 15
a18 41
#
# For more information on building in tricky environments, please see
# the list of possible environment variables described in
# /usr/share/mk/bsd.README.
#
# Building recommendations:
#
# 1) If at all possible, put this source tree in /usr/src.  If /usr/src
# must be a symbolic link, setenv BSDSRCDIR to point to the real location.
#
# 2) It is also recommended that you compile with objects outside the
# source tree. To do this, ensure /usr/obj exists or points to some
# area of disk of sufficient size.  Then do "cd /usr/src; make obj".
# This will make a symbolic link called "obj" in each directory, as
# well as populate the /usr/obj properly with directories for the
# objects.
#
# 3) It is strongly recommended that you build and install a new kernel
# before rebuilding your system. Some of the new programs may use new
# functionality or depend on API changes that your old kernel doesn't have.
#
# 4) If you are reasonably sure that things will compile OK, use the
# "make build" target supplied here. Good luck.
#
# 5) If you want to setup a cross-build environment, there is a "cross-tools"
# target available which upon completion of "make TARGET=<target> cross-tools"
# (where <target> is one of the names in the /sys/arch directory) will produce
# a set of compilation tools along with the includes in the /usr/cross/<target>
# directory. The "cross-distrib" target will build cross-tools as well as
# binaries for a given <target>.
#

.include <bsd.own.mk>	# for NOMAN, if it's there.

SUBDIR+= lib include bin libexec sbin usr.bin usr.sbin share games
SUBDIR+= gnu

SUBDIR+= sys lkm

.if (${KERBEROS5:L} == "yes")
SUBDIR+= kerberosV
d20 2
a21 9

.if   make(clean) || make(cleandir) || make(obj)
SUBDIR+= distrib regress
.endif

.if exists(regress)
regression-tests:
	@@echo Running regression tests...
	@@cd ${.CURDIR}/regress && ${MAKE} depend && exec ${MAKE} regress
d25 2
a26 1
	cd ${.CURDIR}/include && ${MAKE} prereq && exec ${SUDO} ${MAKE} includes
d28 1
a28 2
beforeinstall:
	cd ${.CURDIR}/etc && exec ${MAKE} DESTDIR=${DESTDIR} distrib-dirs
d32 1
a32 1
.ifndef NOMAN
d35 1
d37 1
a37 252
build:
.ifdef GLOBAL_AUTOCONF_CACHE
	cp /dev/null ${GLOBAL_AUTOCONF_CACHE}
.endif
	cd ${.CURDIR}/share/mk && exec ${SUDO} ${MAKE} install
	cd ${.CURDIR}/include && ${MAKE} prereq && exec ${SUDO} ${MAKE} includes
	${SUDO} ${MAKE} cleandir
	cd ${.CURDIR}/lib && ${MAKE} depend && ${MAKE} && \
	    NOMAN=1 exec ${SUDO} ${MAKE} install
	cd ${.CURDIR}/gnu/lib && ${MAKE} depend && ${MAKE} && \
	    NOMAN=1 exec ${SUDO} ${MAKE} install
	${MAKE} depend && ${MAKE} && exec ${SUDO} ${MAKE} install

.if !defined(TARGET)
cross-tools cross-distrib:
	echo "TARGET must be set"; exit 1
.else
cross-tools:	cross-includes cross-binutils cross-gcc cross-lib
cross-distrib:	cross-tools cross-bin cross-etc-root-var

CROSSCPPFLAGS?=	-nostdinc -I${CROSSDIR}/usr/include
CROSSLDFLAGS?=	-nostdlib -L${CROSSDIR}/usr/lib -static
CROSSCFLAGS?=	${CROSSCPPFLAGS}
CROSSCXXFLAGS?=	${CROSSCPPFLAGS}
LDSTATIC?=	-static

CROSSDIR=	${DESTDIR}/usr/cross/${TARGET}
CROSSENV=	AR=${CROSSDIR}/usr/bin/ar AS=${CROSSDIR}/usr/bin/as \
		CC=${CROSSDIR}/usr/bin/cc CPP=${CROSSDIR}/usr/bin/cpp \
		CXX=${CROSSDIR}/usr/bin/c++ \
		LD=${CROSSDIR}/usr/bin/ld NM=${CROSSDIR}/usr/bin/nm \
		LORDER=/usr/bin/lorder RANLIB=${CROSSDIR}/usr/bin/ranlib \
		SIZE=${CROSSDIR}/usr/bin/size STRIP=${CROSSDIR}/usr/bin/strip \
		HOSTCC=\"${CC}\" HOSTCXX=\"${CXX}\" NOMAN= DESTDIR=${CROSSDIR} \
		HOSTCFLAGS=\"${CFLAGS}\" HOSTCXXFLAGS=\"${CXXFLAGS}\" \
		HOSTLDFLAGS=\"${LDFLAGS} \" \
		CFLAGS=\"${CROSSCFLAGS}\" CPPFLAGS=\"${CROSSCPPFLAGS}\" \
		CXXFLAGS=\"${CROSSCXXFLAGS}\" \
		LDFLAGS=\"${CROSSLDFLAGS}\"
CROSSPATH=	${PATH}:${CROSSDIR}/usr/bin
CROSSLANGS?=	c c++

CROSSDIRS=	${CROSSDIR}/.dirs_done
CROSSOBJ=	${CROSSDIR}/usr/obj/.obj_done
CROSSINCLUDES=	${CROSSDIR}/usr/include/.includes_done
CROSSBINUTILS=	${CROSSDIR}/usr/bin/.binutils_done
CROSSGCC=	${CROSSDIR}/usr/bin/.gcc_done
NO_CROSS=	isakmpd tn3270 less sudo openssl libkeynote libssl \
		photurisd keynote sectok ssh

cross-dirs:	${CROSSDIRS}
cross-obj:	${CROSSOBJ}
cross-includes:	${CROSSINCLUDES}
cross-binutils:	${CROSSBINUTILS}
cross-gcc:	${CROSSGCC}

cross-env:	.PHONY
	@@echo ${CROSSENV} MACHINE=${TARGET} \
	    MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH`

${CROSSDIRS}:
	@@-mkdir -p ${CROSSDIR}
	@@case ${TARGET} in \
		alpha|amd64|hppa|hppa64|i386|m68k|m88k|powerpc|sparc|sparc64|vax) \
			echo ${TARGET} ;;\
		amiga|hp300|mac68k|mvme68k) \
			echo m68k ;;\
		luna88k|mvme88k) \
			echo m88k ;;\
		macppc|mvmeppc) \
			echo powerpc ;;\
		sgi) \
			echo mips64 ;;\
		*) \
			(echo Unknown arch ${TARGET} >&2) ; exit 1;; \
	esac > ${CROSSDIR}/TARGET_ARCH
	@@echo TARGET_ARCH is `cat ${CROSSDIR}/TARGET_ARCH`
	@@eval `grep '^osr=' sys/conf/newvers.sh`; \
	   sed "s/\$$/-unknown-openbsd$$osr/" ${CROSSDIR}/TARGET_ARCH > \
	   ${CROSSDIR}/TARGET_CANON
	@@-mkdir -p ${CROSSDIR}
	@@-mkdir -p ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`
	@@ln -sf ${CROSSDIR}/usr/include \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/include
	@@ln -sf ${CROSSDIR}/usr/lib \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/lib
	@@-mkdir -p ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin
	@@(cd ${.CURDIR}/etc && DESTDIR=${CROSSDIR} ${MAKE} distrib-dirs)
	@@touch ${CROSSDIRS}

${CROSSOBJ}:	${CROSSDIRS}
	@@-mkdir -p ${CROSSDIR}/usr/obj
	@@(cd ${.CURDIR} && \
	    BSDOBJDIR=${CROSSDIR}/usr/obj \
	    MACHINE=${TARGET} \
	    MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    BSDSRCDIR=${.CURDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} obj)
	@@touch ${CROSSOBJ}

${CROSSINCLUDES}:	${CROSSOBJ}
	@@-mkdir -p ${CROSSDIR}/usr/include
	@@(cd ${.CURDIR}/include && \
	    MACHINE=${TARGET} MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} prereq && \
	    MACHINE=${TARGET} MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} DESTDIR=${CROSSDIR} includes)
	@@touch ${CROSSINCLUDES}

.if ${MACHINE_ARCH} == "m68k" || ${MACHINE_ARCH} == "m88k" || \
    ${MACHINE_ARCH} == "vax"
BINUTILS=	ar as ld nm ranlib objcopy objdump strings strip
NEW_BINUTILS?=	No
.else
BINUTILS=	ar as gasp ld nm objcopy objdump ranlib readelf size \
		strings strip
NEW_BINUTILS?=	Yes
.endif

${CROSSBINUTILS}:	${CROSSINCLUDES}
.if ${NEW_BINUTILS:L} == "yes"
	(cd ${.CURDIR}/gnu/usr.bin/binutils; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    TARGET_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    ${MAKE} -f Makefile.bsd-wrapper depend && \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    TARGET_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    ${MAKE} -f Makefile.bsd-wrapper all && \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} -f Makefile.bsd-wrapper install)
.else
	(cd ${.CURDIR}/gnu/usr.bin/gas; \
	    TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} ${MAKE} depend all; \
	    TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/as \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/as
	(cd ${.CURDIR}/gnu/usr.bin/ld; \
	    TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOPIC= NOMAN= depend all; \
	    TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOPIC= NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/ld \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/ld
	(cd ${.CURDIR}/usr.bin/ar; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} ${MAKE} NOMAN= depend all; \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/ar \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/ar
	(cd ${.CURDIR}/usr.bin/ranlib; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} ${MAKE} NOMAN= depend all; \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/ranlib \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/ranlib
	(cd ${.CURDIR}/usr.bin/strip; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    NOMAN= depend all; \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} TARGET_MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` \
	    NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/strip \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/strip
.endif
	(cd ${.CURDIR}/usr.bin/nm; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOMAN= depend all; \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} NOMAN= install)
	ln -sf ${CROSSDIR}/usr/bin/nm \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/nm
	ln -sf ${CROSSDIR}/usr/bin/size \
	    ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/size
	@@for cmd in ${BINUTILS}; do \
	 if [ ! -e ${CROSSDIR}/usr/bin/$$cmd -a \
	 -e ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-$$cmd ]; then \
	    ln -sf ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-$$cmd \
	        ${CROSSDIR}/usr/bin/$$cmd ;\
	 elif [ -e ${CROSSDIR}/usr/bin/$$cmd -a \
	 ! -e ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-$$cmd ]; then \
	    ln -sf ${CROSSDIR}/usr/bin/$$cmd \
	        ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-$$cmd; \
	 fi ;\
	 if [ -e ${CROSSDIR}/usr/bin/$$cmd -a \
	 ! -e ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/$$cmd ]; then \
	    ln -sf ${CROSSDIR}/usr/bin/$$cmd \
	        ${CROSSDIR}/usr/`cat ${CROSSDIR}/TARGET_CANON`/bin/$$cmd; \
	 fi ;\
	done
	@@touch ${CROSSBINUTILS}

# bsd.own.mk can't do it for us
.if ${TARGET} == "amd64" || ${TARGET} == "cats" || \
    ${TARGET} == "hppa" || ${TARGET} == "hppa64" || \
    ${TARGET} == "sparc64" || ${TARGET} == "sgi"
USE_GCC3=yes
.endif

${CROSSGCC}:		${CROSSBINUTILS}
.if ${USE_GCC3:L} == "yes"
	(cd ${.CURDIR}/gnu/usr.bin/gcc; \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    TARGET_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` CROSSDIR=${CROSSDIR} \
	    ${MAKE} -f Makefile.bsd-wrapper depend && \
	    MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    TARGET_ARCH=`cat ${CROSSDIR}/TARGET_ARCH` CROSSDIR=${CROSSDIR} \
	    ${MAKE} -f Makefile.bsd-wrapper all && \
	    DESTDIR=${CROSSDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    ${MAKE} -f Makefile.bsd-wrapper install)
	ln -sf ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-g++ \
	    ${CROSSDIR}/usr/bin/c++
	ln -sf ${CROSSDIR}/usr/libexec/cpp \
	    ${CROSSDIR}/usr/bin/cpp
.else
	(cd ${CROSSDIR}/usr/obj/gnu/egcs/gcc; \
	    /bin/sh ${.CURDIR}/gnu/egcs/gcc/configure \
	    --with-gnu-as --with-gnu-ld --prefix ${CROSSDIR}/usr \
	    --target `cat ${CROSSDIR}/TARGET_CANON` \
	    --enable-languages="c,c++" --enable-cpp --disable-nls \
	    --with-gxx-include-dir=${CROSSDIR}/usr/include/g++ && \
	    PATH=${CROSSPATH} ${MAKE} BISON=yacc LANGUAGES="${CROSSLANGS}" \
	    CFLAGS="${CFLAGS} -I${.CURDIR}/gnu/lib/libiberty/include" \
	    LIBIBERTY_INCLUDES=${.CURDIR}/gnu/lib/libiberty/include \
	    DEMANGLER_PROG= DEMANGLE_H= LDFLAGS="${LDSTATIC}" build_infodir=. \
	    GCC_FOR_TARGET="./xgcc -B./ -I${CROSSDIR}/usr/include" && \
	    ${MAKE} BISON=yacc LANGUAGES="${CROSSLANGS}" LDFLAGS="${LDSTATIC}" \
	    GCC_FOR_TARGET="./xgcc -B./ -I${CROSSDIR}/usr/include" \
	    CFLAGS="${CFLAGS} -I${.CURDIR}/gnu/lib/libiberty/include" \
	    LIBIBERTY_INCLUDES=${.CURDIR}/gnu/lib/libiberty/include \
	    build_infodir=. INSTALL_MAN= INSTALL_HEADERS_DIR= install)
	ln -sf ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-gcc \
	    ${CROSSDIR}/usr/bin/cc
	ln -sf ${CROSSDIR}/usr/bin/`cat ${CROSSDIR}/TARGET_CANON`-g++ \
	    ${CROSSDIR}/usr/bin/c++
	${INSTALL} -c -o ${BINOWN} -g ${BINGRP} -m ${BINMODE} \
	    ${CROSSDIR}/usr/obj/gnu/egcs/gcc/cpp \
	    ${CROSSDIR}/usr/libexec/cpp
	sed -e 's#/usr/libexec/cpp#${CROSSDIR}/usr/libexec/cpp#' \
	    -e 's#/usr/include#${CROSSDIR}/usr/include#' \
	    ${.CURDIR}/usr.bin/cpp/cpp.sh > ${CROSSDIR}/usr/bin/cpp
	chmod ${BINMODE} ${CROSSDIR}/usr/bin/cpp
	chown ${BINOWN}:${BINGRP} ${CROSSDIR}/usr/bin/cpp
.endif
	@@touch ${CROSSGCC}
d39 72
a110 48
# XXX MAKEOBJDIR maybe should be obj.${TARGET} here, revisit later
cross-lib:	${CROSSGCC}
	MACHINE=${TARGET} MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH`; \
	export MACHINE MACHINE_ARCH; \
	(cd ${.CURDIR}/lib; \
	    for lib in csu libc; do \
	    (cd $$lib; \
	        eval ${CROSSENV} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
		    ${MAKE} depend all install); \
	    done; \
	    eval ${CROSSENV} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	        SKIPDIR=\"${NO_CROSS} libocurses/PSD.doc\" \
	        ${MAKE} depend all install)

cross-bin:	${CROSSOBJ}
	MACHINE=${TARGET} MACHINE_ARCH=`cat ${CROSSDIR}/TARGET_ARCH`; \
	export MACHINE MACHINE_ARCH; \
	for i in libexec bin sbin usr.bin usr.sbin; do \
	(cd ${.CURDIR}/$$i; \
	    eval ${CROSSENV} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	        SKIPDIR=\"${BINUTILS} ${NO_CROSS}\" \
	        ${MAKE} depend all install); \
	done

cross-etc-root-var:	${CROSSOBJ}
	(cd ${.CURDIR}/etc && \
	    DESTDIR=${CROSSDIR} ${MAKE} distribution-etc-root-var)

cross-depend:	.PHONY
	@@(cd ${.CURDIR} && \
	    BSDOBJDIR=${CROSSDIR}/usr/obj \
	    BSDSRCDIR=${.CURDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    SKIPDIR="${NO_CROSS}" \
	    ${MAKE} depend)

cross-clean:	.PHONY
	@@(cd ${.CURDIR} && \
	    BSDOBJDIR=${CROSSDIR}/usr/obj \
	    BSDSRCDIR=${.CURDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    SKIPDIR="${NO_CROSS}" \
	    ${MAKE} clean)

cross-cleandir:	.PHONY
	@@(cd ${.CURDIR} && \
	    BSDOBJDIR=${CROSSDIR}/usr/obj \
	    BSDSRCDIR=${.CURDIR} MAKEOBJDIR=obj.${MACHINE}.${TARGET} \
	    SKIPDIR="${NO_CROSS}" \
	    ${MAKE} cleandir)
a111 2
.endif # defined(TARGET)
 
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@
