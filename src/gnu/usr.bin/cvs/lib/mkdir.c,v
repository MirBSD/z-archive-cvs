head	1.1;
branch	1.1.101;
access;
symbols
	MIRBSD_10:1.1.101.3.0.4
	MIRBSD_10_BASE:1.1.101.3
	MIRBSD_9_BASE:1.1.101.3
	MIRBSD_8:1.1.101.3.0.2
	MIRBSD_8_BASE:1.1.101.3
	cvs-1_12_13:1.1.101.3
	cvs-1_12_12:1.1.101.2
	FSF:1.1.101;
locks; strict;
comment	@ * @;


1.1
date	2005.03.06.15.17.51;	author tg;	state Exp;
branches
	1.1.101.1;
next	;

1.1.101.1
date	2005.03.06.15.17.51;	author tg;	state Exp;
branches;
next	1.1.101.2;

1.1.101.2
date	2005.04.19.20.33.22;	author tg;	state Exp;
branches;
next	1.1.101.3;

1.1.101.3
date	2005.12.05.21.43.46;	author tg;	state Exp;
branches;
next	;
commitid	2cec4394b499b817;


desc
@@


1.1
log
@Initial revision
@
text
@/* mkrmdir.c -- BSD compatible directory functions for System V
   Copyright (C) 1988, 1990 Free Software Foundation, Inc.

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.  */

#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include <sys/types.h>
#include <sys/stat.h>
#include <errno.h>
#ifndef STDC_HEADERS
extern int errno;
#endif

/* mkdir and rmdir adapted from GNU tar. */

/* Make directory DPATH, with permission mode DMODE.

   Written by Robert Rother, Mariah Corporation, August 1985
   (sdcsvax!rmr or rmr@@uscd).  If you want it, it's yours.

   Severely hacked over by John Gilmore to make a 4.2BSD compatible
   subroutine.	11Mar86; hoptoad!gnu

   Modified by rmtodd@@uokmax 6-28-87 -- when making an already existing dir,
   subroutine didn't return EEXIST.  It does now. */

int
mkdir (dpath, dmode)
     const char *dpath;
     int dmode;
{
  int cpid, status;
  struct stat statbuf;

  if (stat (dpath, &statbuf) == 0)
    {
      errno = EEXIST;		/* stat worked, so it already exists. */
      return -1;
    }

  /* If stat fails for a reason other than non-existence, return error. */
  if (! existence_error (errno))
    return -1;

  cpid = fork ();
  switch (cpid)
    {
    case -1:			/* Cannot fork. */
      return -1;		/* errno is set already. */

    case 0:			/* Child process. */
      /* Cheap hack to set mode of new directory.  Since this child
	 process is going away anyway, we zap its umask.
	 This won't suffice to set SUID, SGID, etc. on this
	 directory, so the parent process calls chmod afterward. */
      status = umask (0);	/* Get current umask. */
      umask (status | (0777 & ~dmode));	/* Set for mkdir. */
      execl ("/bin/mkdir", "mkdir", dpath, (char *) 0);
      _exit (1);

    default:			/* Parent process. */
      while (wait (&status) != cpid) /* Wait for kid to finish. */
	/* Do nothing. */ ;

      if (status & 0xFFFF)
	{
	  errno = EIO;		/* /bin/mkdir failed. */
	  return -1;
	}
      return chmod (dpath, dmode);
    }
}

/* Remove directory DPATH.
   Return 0 if successful, -1 if not. */

int
rmdir (dpath)
     char *dpath;
{
  int cpid, status;
  struct stat statbuf;

  if (stat (dpath, &statbuf) != 0)
    return -1;			/* stat set errno. */

  if ((statbuf.st_mode & S_IFMT) != S_IFDIR)
    {
      errno = ENOTDIR;
      return -1;
    }

  cpid = fork ();
  switch (cpid)
    {
    case -1:			/* Cannot fork. */
      return -1;		/* errno is set already. */

    case 0:			/* Child process. */
      execl ("/bin/rmdir", "rmdir", dpath, (char *) 0);
      _exit (1);

    default:			/* Parent process. */
      while (wait (&status) != cpid) /* Wait for kid to finish. */
	/* Do nothing. */ ;

      if (status & 0xFFFF)
	{
	  errno = EIO;		/* /bin/rmdir failed. */
	  return -1;
	}
      return 0;
    }
}
@


1.1.101.1
log
@GNU CVS 1.12.11 with the following directories removed:
- contrib/pam
- emx
- os2
- tools
- vms
- windows-NT
- zlib
@
text
@@


1.1.101.2
log
@GNU CVS 1.12.12 "should" fix security issues
@
text
@d1 2
a2 4
/* On some systems, mkdir ("foo/", 0700) fails because of the trailing
   slash.  On those systems, this wrapper removes the trailing slash.

   Copyright (C) 2001, 2003 Free Software Foundation, Inc.
d12 1
a12 1
   GNU General Public License for more details.
d14 3
a16 3
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software Foundation,
   Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
d18 6
a23 1
/* written by Jim Meyering */
d25 1
a25 1
#include <config.h>
d27 1
a27 4
/* Disable the definition of mkdir to rpl_mkdir (from config.h) in this
   file.  Otherwise, we'd get conflicting prototypes for rpl_mkdir on
   most systems.  */
#undef mkdir
d29 2
a30 5
#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
d32 2
a33 2
#include "dirname.h"
#include "xalloc.h"
d35 2
a36 1
/* This function is required at least for NetBSD 1.5.2.  */
d39 3
a41 1
rpl_mkdir (char const *dir, mode_t mode)
d43 2
a44 3
  int ret_val;
  char *tmp_dir;
  size_t len = strlen (dir);
d46 1
a46 1
  if (len && dir[len - 1] == '/')
d48 2
a49 2
      tmp_dir = xstrdup (dir);
      strip_trailing_slashes (tmp_dir);
d51 7
a57 1
  else
d59 23
a81 1
      tmp_dir = (char *) dir;
d83 1
d85 2
a86 1
  ret_val = mkdir (tmp_dir, mode);
d88 9
a96 2
  if (tmp_dir != dir)
    free (tmp_dir);
d98 27
a124 1
  return ret_val;
@


1.1.101.3
log
@Import current version of GNU CVS, in the hope to actually fix bugs...
@
text
@d18 1
a18 1
   Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */
d22 1
a22 3
#ifdef HAVE_CONFIG_H
# include <config.h>
#endif
@


