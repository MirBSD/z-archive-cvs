head	1.12;
access;
symbols
	MIRBSD_10:1.7.0.2
	MIRBSD_10_BASE:1.7
	MIRBSD_9_BASE:1.4
	MIRBSD_8:1.3.0.2
	MIRBSD_8_BASE:1.3
	mirbsd:1.1.7;
locks; strict;
comment	@# @;


1.12
date	2017.04.06.21.19.06;	author tg;	state Exp;
branches;
next	1.11;
commitid	10058E6B07B2F3DF9F4;

1.11
date	2010.12.12.23.42.24;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004D055DF602883891;

1.10
date	2009.01.29.17.16.08;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004981E45C3B3F1DFF;

1.9
date	2008.11.29.17.03.52;	author tg;	state Exp;
branches;
next	1.8;
commitid	100493175607A689D2F;

1.8
date	2008.07.10.12.41.47;	author tg;	state Exp;
branches;
next	1.7;
commitid	1004876039C6636FADA;

1.7
date	2007.07.07.22.02.42;	author tg;	state Exp;
branches;
next	1.6;
commitid	10046900D300D91247A;

1.6
date	2007.02.09.19.12.18;	author tg;	state Exp;
branches;
next	1.5;
commitid	10045CCC7A1555E78CF;

1.5
date	2006.09.21.23.50.42;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004513254E3B488E26;

1.4
date	2006.02.24.18.15.26;	author tg;	state Exp;
branches;
next	1.3;
commitid	10043FF4D4816FF87C6;

1.3
date	2005.12.04.20.29.50;	author tg;	state Exp;
branches;
next	1.2;
commitid	6a93439351d1d17c;

1.2
date	2005.09.23.10.53.59;	author tg;	state Exp;
branches;
next	1.1;
commitid	65374333ded79c2c;

1.1
date	2005.03.06.16.46.49;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.1.7.1
date	2005.03.06.16.46.49;	author tg;	state Exp;
branches;
next	;


desc
@@


1.12
log
@rsync-related (but no bad idea for CVS, too) timezone/chroot changes:

• install /usr/share/zoneinfo/UTC into the chroot, always
• make /etc/localtime again a symlink to it (user-changeable, iff they also
  install the link target into /var/anoncvs/usr/share/zoneinfo/ manually⚠)
• install /var/anoncvs/usr/share/zoneinfo/posixrules as hardlink to UTC

⚠ these two new files are non-negotiable and must be regularily updated
@
text
@# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.11 2010/12/12 23:42:24 tg Exp $

CBIN=		anoncvsbin
BINDIR=		/var/anoncvs
BINOWN=		root
BINGRP=		_anoncvs
BINMODE=	110

CLEANFILES+=	${CBIN}.conf ${CBIN}.c ${CBIN}.cache ${CBIN}.mk \
		${CBIN}.o ${CBIN} cvs.lo* cvs_stub.c cvs_stub.o

all:	${CBIN}

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CBIN}.conf
	crunchgen -E -D ${BSDSRCDIR} -L ${DESTDIR}/usr/lib \
	    -c ${CBIN}.c -e ${CBIN} -m ${CBIN}.mk ${CBIN}.conf

${CBIN}.conf: crunch.conf
	sed 's%OBJPATH%${BSDOBJDIR}%g' <${.CURDIR}/crunch.conf >${CBIN}.conf

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	${MAKE} -f ${CBIN}.mk

realinstall:
	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} -o ${BINOWN} -g ${BINGRP} \
	    -m ${BINMODE} ${CBIN} ${DESTDIR}${BINDIR}
	cd ${DESTDIR}${BINDIR}; ln -f ${CBIN} bin/cvs; rm ${CBIN}

.if defined(DESTDIR) && ${DESTDIR} != "" && ${DESTDIR} != "/"
distribution:
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    /dev/null ${DESTDIR}${BINDIR}/.hushlogin
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${.CURDIR}/dot.plan ${DESTDIR}${BINDIR}/.plan
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${.CURDIR}/resolv.conf ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/group ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/hosts ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/passwd ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/protocols ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/pwd.db ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/services ${DESTDIR}${BINDIR}/etc/
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/etc/ttys.dist ${DESTDIR}${BINDIR}/etc/ttys
	ln -sf ../usr/share/zoneinfo/UTC ${DESTDIR}${BINDIR}/etc/localtime
.else
distribution:
	@@echo "Error: doing make distribution here is a great cause"
	@@echo "	of potential security problems. Please do not do this."
	@@exit 1
.endif

depend:

lint:

tags:

.include <bsd.prog.mk>
@


1.11
log
@we NEED /etc/localtime in the anoncvs chroot, for leap seconds only though, so hardcode UTC since it is the smallest and works just fine
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.10 2009/01/29 17:16:08 tg Exp $
d51 1
a51 2
	install -c -o ${BINOWN} -g ${CONFGRP} -m ${NONBINMODE} \
	    ${DESTDIR}/usr/share/zoneinfo/UTC ${DESTDIR}${BINDIR}/etc/localtime
@


1.10
log
@use CONFGRP not BINGRP for configs
fixes daily security moo

(and yes, I still have headaches...)
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.9 2008/11/29 17:03:52 tg Exp $
d51 2
@


1.9
log
@move anoncvs stub from /var/anoncvs/anoncvs to /var/anoncvs,
shell from /var/anoncvs/anoncvssh to /usr/libexec/anoncvssh,
devices are now on mfs, fix some typos etc. while here

=> /var/anoncvs and its subdirectories can now be mounted
   with nodev and nosuid

condition on the mfs mount: at least one user must exist
whose home directory is /var/anoncvs (or one of its sub-
directories), whose shell is /usr/libexec/anoncvssh, and
whose password is not empty ('*'); /var/anoncvs/dev will
be filled with arandom, null and zero.

also enforce stricter perms on cvs and rsync binaries in
the chroot (0110 root:_anoncvs)

do not change anything pertaining to the MirOS mirrors
yet, as these will have to be changed to match the new
default values with some OS upgrade later
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.8 2008/07/10 12:41:47 tg Exp $
d31 1
a31 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d33 1
a33 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d35 1
a35 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d37 1
a37 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d39 1
a39 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d41 1
a41 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d43 1
a43 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d45 1
a45 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d47 1
a47 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
d49 1
a49 1
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
@


1.8
log
@ttys is now called ttys.dist
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.7 2007/07/07 22:02:42 tg Exp $
d4 1
a4 1
BINDIR=		/var/anoncvs/anoncvs
d6 2
a7 2
BINGRP=		wheel
BINMODE=	111
@


1.7
log
@crunchgen:
• make stubbed object files obsolete, use GNU objcopy(1)’s symbol renaming
  feature instead
• rewrite to use BSD make and <bsd.prog.mk>, finally
• shrink the size of the generated makefile by a lot
• document that ‘-E’ flag has been obsolete since version 1.x
• bump to version 2.0

users of crunchgen:
• change clean removal of *.lo to *.lo* to account for more temp files
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.6 2007/02/09 19:12:18 tg Exp $
d36 1
a36 1
	    ${.CURDIR}/resolv.conf ${DESTDIR}${BINDIR}/etc
d38 1
a38 1
	    ${DESTDIR}/etc/group ${DESTDIR}${BINDIR}/etc
d40 1
a40 1
	    ${DESTDIR}/etc/hosts ${DESTDIR}${BINDIR}/etc
d42 1
a42 1
	    ${DESTDIR}/etc/passwd ${DESTDIR}${BINDIR}/etc
d44 1
a44 1
	    ${DESTDIR}/etc/protocols ${DESTDIR}${BINDIR}/etc
d46 1
a46 1
	    ${DESTDIR}/etc/pwd.db ${DESTDIR}${BINDIR}/etc
d48 1
a48 1
	    ${DESTDIR}/etc/services ${DESTDIR}${BINDIR}/etc
d50 1
a50 1
	    ${DESTDIR}/etc/ttys ${DESTDIR}${BINDIR}/etc
@


1.6
log
@remove these annoying # Nothing here so far...
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.5 2006/09/21 23:50:42 tg Exp $
d10 1
a10 1
		${CBIN}.o ${CBIN} cvs.lo cvs_stub.c cvs_stub.o
@


1.5
log
@anoncvs probably doesn't need these any more,
anoncvssh only executes 'cvs server' and that
has no need for the other tools from 2.9 time
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.4 2006/02/24 18:15:26 tg Exp $
a58 1
	# Nothing here so far...
a60 1
	# Nothing here so far...
a62 1
	# Nothing here so far...
@


1.4
log
@no longer needed with new crunch tools (in fact, BROKE!)
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.3 2005/12/04 20:29:50 tg Exp $
d10 1
a10 3
		${CBIN}.o ${CBIN} cat.lo cat_stub.c cat_stub.o mksh.lo \
		mksh_stub.c mksh_stub.o pwd.lo pwd_stub.c pwd_stub.o rm.lo \
		rm_stub.c rm_stub.o cvs.lo cvs_stub.c cvs_stub.o
d27 1
a27 3
	cd ${DESTDIR}${BINDIR}; ln -f ${CBIN} bin/cat; ln -f ${CBIN} bin/pwd; \
	    ln -f ${CBIN} bin/rm; ln -f ${CBIN} bin/sh; \
	    ln -f ${CBIN} bin/cvs; rm ${CBIN}
a35 2
	    ${.CURDIR}/dot.profile ${DESTDIR}${BINDIR}/.profile
	install -c -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
@


1.3
log
@ksh -> mksh ...
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.2 2005/09/23 10:53:59 tg Exp $
d24 1
a24 1
	${MAKE} -f ${CBIN}.mk CFLAGS="${CFLAGS}" all
@


1.2
log
@accomodate usr and var changes
@
text
@d1 1
a1 1
# $MirOS: src/gnu/usr.bin/anoncvs/Makefile,v 1.1.7.1 2005/03/06 16:46:49 tg Exp $
d10 2
a11 2
		${CBIN}.o ${CBIN} cat.lo cat_stub.c cat_stub.o ksh.lo \
		ksh_stub.c ksh_stub.o pwd.lo pwd_stub.c pwd_stub.o rm.lo \
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $MirOS$
d31 1
a31 1
	    ln -f ${CBIN} usr/bin/cvs; rm ${CBIN}
a56 1
	cd ${DESTDIR}${BINDIR}/var; rm -f tmp; ln -s ../tmp tmp
@


1.1.7.1
log
@Add another couple of software they didn't have
@
text
@@
