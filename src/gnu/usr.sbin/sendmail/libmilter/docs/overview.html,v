head	1.4;
access;
symbols
	sendmail-8_14_9:1.1.127.4
	sendmail-8_14_7:1.1.127.3
	sendmail-8_14_6:1.1.127.3
	sendmail-8_14_5-ERRATA-1:1.1.127.3
	mbsd-20101220_mergebase:1.2
	sendmail-8_14_5:1.1.127.3
	cvs-201107021500:1.1.1.4
	cvs-20101220:1.1.1.3
	mbsd-20101220:1.2.0.2
	cvs-201012191730:1.1.1.2
	sendmail-8_14_5_Beta0:1.1.127.2
	sendmail-8_14_3:1.1.127.1
	sendmail:1.1.127
	cvs-200812170000:1.1.1.2
	cvs-200805071200:1.1.1.2
	MIRBSD_10:1.1.1.2.0.2
	MIRBSD_10_BASE:1.1.1.2
	cvs-200803022030:1.1.1.2
	cvs-200707152000:1.1.1.2
	cvs-200704292000:1.1.1.2
	cvs-200702051700:1.1.1.2
	cvs-200609121900:1.1.1.1
	MIRBSD_9_BASE:1.1.1.1
	cvs-200606151800:1.1.1.1
	cvs-200603231300:1.1.1.1
	MIRBSD_8:1.1.1.1.0.2
	MIRBSD_8_BASE:1.1.1.1
	cvs-200507211800:1.1.1.1
	cvs-200504262050:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2014.06.09.15.17.17;	author tg;	state Exp;
branches;
next	1.3;
commitid	1005395CFC65E5646F1;

1.3
date	2011.07.02.15.51.05;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004E0F3E737D0D545A;

1.2
date	2010.12.19.17.18.10;	author tg;	state Exp;
branches
	1.2.2.1;
next	1.1;
commitid	1004D0E3E2D1286B3DF;

1.1
date	2005.02.05.17.24.22;	author tg;	state Exp;
branches
	1.1.1.1
	1.1.127.1;
next	;

1.2.2.1
date	2011.07.02.16.04.53;	author tg;	state Exp;
branches;
next	;
commitid	1004E0F418C2E526E32;

1.1.1.1
date	2005.02.05.17.24.22;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2007.02.05.17.05.51;	author tg;	state Exp;
branches;
next	1.1.1.3;
commitid	10045C763C551AABAF7;

1.1.1.3
date	2011.07.02.14.59.50;	author tg;	state Exp;
branches;
next	1.1.1.4;
commitid	1004E0F31C5496AB95F;

1.1.1.4
date	2011.07.02.15.17.39;	author tg;	state Exp;
branches;
next	;
commitid	1004E0F36A10B5CA95B;

1.1.127.1
date	2010.12.19.14.45.52;	author tg;	state Exp;
branches;
next	1.1.127.2;
commitid	1004D0E1A94384778FD;

1.1.127.2
date	2010.12.19.14.56.33;	author tg;	state Exp;
branches;
next	1.1.127.3;
commitid	1004D0E1D294DE25888;

1.1.127.3
date	2011.07.02.15.24.48;	author tg;	state Exp;
branches;
next	1.1.127.4;
commitid	1004E0F38410A41234F;

1.1.127.4
date	2014.06.09.14.29.24;	author tg;	state Exp;
branches;
next	;
commitid	1005395C4CC1A6DB9EE;


desc
@@


1.4
log
@merge
@
text
@<HTML>
<HEAD>
<TITLE>Technical Overview</TITLE>
</HEAD>
<BODY>
<!--
$Id: overview.html,v 1.22 2013-11-22 20:51:39 ca Exp $
-->

<H1>Technical Overview</H1>

<H2>Contents</H2>

<UL>
    <LI><A HREF="#Initialization">Initialization</A>
    <LI><A HREF="#ControlFlow">Control Flow</A>
    <LI><A HREF="#Multithreading">Multithreading</A>
    <LI><A HREF="#ResourceManagement">Resource Management</A>
    <LI><A HREF="#SignalHandling">Signal Handling</A>
</UL>

<H2><A NAME="Initialization">Initialization</A></H2>

In addition to its own initialization,
libmilter expects a filter to initialize several parameters
before calling <A HREF="smfi_main.html">smfi_main</A>:
<UL>
    <LI>The callbacks the filter wishes to be called, and the types of
    message modification it intends to perform (required, see
    <A HREF="smfi_register.html">smfi_register</A>).

    <LI>The socket address to be used when communicating with the MTA
    (required, see <A HREF="smfi_setconn.html">smfi_setconn</A>).

    <LI>The number of seconds to wait for MTA connections before
    timing out (optional, see
    <A HREF="smfi_settimeout.html">smfi_settimeout</A>).
</UL>
<P>
If the filter fails to initialize libmilter,
or if one or more of the parameters it has passed are invalid,
a subsequent call to smfi_main will fail.

<H2><A NAME="ControlFlow">Control Flow</A></H2>

<P>
The following pseudocode describes the filtering process from the
perspective of a set of <CODE>N</CODE> MTA's,
each corresponding to a connection.
Callbacks are shown beside the processing stages in which they are invoked;
if no callbacks are defined for a particular stage,
that stage may be bypassed.
Though it is not shown,
processing may be aborted at any time during a message,
in which case the
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked and control
returns to <CODE>MESSAGE</CODE>.
<P>
<PRE>
For each of N connections
{
	For each filter
		process connection (<A HREF="xxfi_connect.html">xxfi_connect</A>)
	For each filter
		process helo/ehlo (<A HREF="xxfi_helo.html">xxfi_helo</A>)
MESSAGE:For each message in this connection (sequentially)
	{
		For each filter
			process sender (<A HREF="xxfi_envfrom.html">xxfi_envfrom</A>)
		For each recipient
		{
			For each filter
				process recipient (<A HREF="xxfi_envrcpt.html">xxfi_envrcpt</A>)
		}
		For each filter
		{
			process DATA (<A HREF="xxfi_data.html">xxfi_data</A>)
			For each header
				process header (<A HREF="xxfi_header.html">xxfi_header</A>)
			process end of headers (<A HREF="xxfi_eoh.html">xxfi_eoh</A>)
			For each body block
				process this body block (<A HREF="xxfi_body.html">xxfi_body</A>)
			process end of message (<A HREF="xxfi_eom.html">xxfi_eom</A>)
		}
	}
	For each filter
		process end of connection (<A HREF="xxfi_close.html">xxfi_close</A>)
}
</PRE>

<P>Note: Filters are contacted in order defined in config file.</P>

<P>
To write a filter, a vendor supplies callbacks to process relevant
parts of a message transaction.
The library then controls all sequencing, threading,
and protocol exchange with the MTA.
<A HREF="#figure-3">Figure 3</A> outlines control flow for a filter
process, showing where different callbacks are invoked.
</P>

<DIV ALIGN="center"><A NAME="figure-3"></A>
<TABLE border=1 cellspacing=0 cellpadding=2 width="70%">
<TR bgcolor="#dddddd"><TH>SMTP Commands</TH><TH>Milter Callbacks</TH></TR>
<TR><TD>(open SMTP connection)</TD><TD>xxfi_connect</TD></TR>
<TR><TD>HELO ...</TD><TD>xxfi_helo</TD></TR>
<TR><TD>MAIL From: ...</TD><TD>xxfi_envfrom</TD></TR>
<TR><TD>RCPT To: ...</TD><TD>xxfi_envrcpt</TD></TR>
<TR><TD>[more RCPTs]</TD><TD>[xxfi_envrcpt]</TD></TR>
<TR><TD>DATA</TD><TD>xxfi_data</TD></TR>
<TR><TD>Header: ...</TD><TD>xxfi_header</TD></TR>
<TR><TD>[more headers]</TD><TD>[xxfi_header]</TD></TR>
<TR><TD>&nbsp;</TD><TD>xxfi_eoh</TD></TR>
<TR><TD>body... </TD><TD>xxfi_body</TD></TR>
<TR><TD>[more body...]</TD><TD>[xxfi_body]</TD></TR>
<TR><TD>.</TD><TD>xxfi_eom</TD></TR>
<TR><TD>QUIT</TD><TD>xxfi_close</TD></TR>
<TR><TD>(close SMTP connection)</TD><TD>&nbsp;</TD></TR>
</TABLE>
<B>Figure 3: Milter callbacks related to an SMTP transaction.</B>
</DIV>

<P>
Note that although only a single message is shown above, multiple
messages may be sent in a single connection.
Note also that a message or connection may be aborted by
either the remote host or the MTA
at any point during the SMTP transaction.
If this occurs during a message (between the MAIL command and the final "."),
the filter's
<A HREF="xxfi_abort.html">xxfi_abort</A> routine will be called.
<A HREF="xxfi_close.html">xxfi_close</A> is called any time the
connection closes.

<H2><A NAME="Multithreading">Multithreading</A></H2>

<P>
A single filter process may handle any number of connections
simultaneously.
All filtering callbacks must therefore be reentrant,
and use some appropriate external synchronization methods to access
global data.
Furthermore, since there is not a one-to-one correspondence
between threads and connections
(N connections mapped onto M threads, M &lt;= N),
connection-specific data must be accessed
through the handles provided by the Milter library.
The programmer cannot rely on library-supplied thread-specific data blocks
(e.g., <CODE>pthread_getspecific(3)</CODE>) to store connection-specific data.
See the API documentation for
<A HREF="smfi_setpriv.html">smfi_setpriv</A> and
<A HREF="smfi_getpriv.html">smfi_getpriv</A> for details.

<H2><A NAME="ResourceManagement">Resource Management</A></H2>

Since filters are likely to be long-lived,
and to handle many connections,
proper deallocation of per-connection resources is important.
The lifetime of a connection is bracketed by calls to the
callbacks <A HREF="xxfi_connect.html">xxfi_connect</A> and
<A HREF="xxfi_close.html">xxfi_close</A>.
Therefore connection-specific
resources (accessed via <A HREF="smfi_getpriv.html">smfi_getpriv</A>
and <A HREF="smfi_setpriv.html">smfi_setpriv</A>) may be allocated in
<A HREF="xxfi_connect.html">xxfi_connect</A>,
and should be freed in
<A HREF="xxfi_close.html">xxfi_close</A>.
For further information see
the <A HREF="api.html#conn-msg">discussion</A> of message- versus
connection-oriented routines.
In particular,
note that there is only one connection-specific data pointer per connection.
<P>

Each message is bracketed by calls to
<A HREF="xxfi_envfrom.html">xxfi_envfrom</A> and
<A HREF="xxfi_eom.html">xxfi_eom</A> (or
<A HREF="xxfi_abort.html">xxfi_abort</A>),
implying that message-specific resources can be allocated
and reclaimed in these routines.
Since the messages in a connection are processed sequentially by each filter,
there will be only one active message associated with a given
connection and filter (and connection-private data block).
These resources must still be accessed through
<A HREF="smfi_getpriv.html">smfi_getpriv</A> and
<A HREF="smfi_setpriv.html">smfi_setpriv</A>,
and must be reclaimed in
<A HREF="xxfi_abort.html">xxfi_abort</A>.

<H2><A NAME="SignalHandling">Signal Handling</A></H2>

libmilter takes care of signal handling,
the filters are not influenced directly by signals.
There are basically two types of signal handlers:

<OL>
<LI><TT>Stop</TT>: no new connections from the MTA will be accepted,
but existing connections are allowed to continue.
<LI><TT>Abort</TT>: all filters will be stopped as soon as the next
communication with the MTA happens.
</OL>

Filters are not terminated asynchronously
(except by signals that can't be caught).
In the case of <TT>Abort</TT> the
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked.

<HR size="1">
<FONT size="-1">
Copyright (c) 2000, 2001, 2003, 2006 Proofpoint, Inc. and its suppliers.
All rights reserved.
<BR>
By using this file, you agree to the terms and conditions set
forth in the LICENSE.
</FONT>
</BODY>
</HTML>
@


1.3
log
@fastmerge from vendor branch "sendmail"
@
text
@d7 1
a7 1
$Id: overview.html,v 1.21 2010/12/14 20:59:52 ca Exp $
d210 1
a210 1
Copyright (c) 2000, 2001, 2003, 2006 Sendmail, Inc. and its suppliers.
@


1.2
log
@merge newer sendmail; fix and correct; reduce upstream diffs; prep for deb
@
text
@d7 1
a7 1
$Id: overview.html,v 1.20 2009/11/13 18:15:05 ca Exp $
d129 1
a129 1
f this occurs during a message (between the MAIL command and the final "."),
@


1.2.2.1
log
@fastmerge on vendor branch "openbsd", focus on THEIRS, not intended for use
@
text
@d7 1
a7 1
$Id: overview.html,v 1.21 2010/12/14 20:59:52 ca Exp $
d129 1
a129 1
If this occurs during a message (between the MAIL command and the final "."),
@


1.1
log
@Initial revision
@
text
@d1 5
a5 5
<html>
<head>
<title>Technical Overview</title>
</head>
<body>
d7 1
a7 1
$Sendmail: overview.html,v 1.14 2003/03/05 19:57:54 ca Exp $
d10 1
a10 1
<h1>Technical Overview</h1>
d12 1
a12 1
<h2>Contents</h2>
d14 29
a42 27
<ul>
    <li>Initialization
    <li>Control flow
    <li>Multithreading
    <li>Resource Management
    <li>Signal Handling
</ul>

<h2>Initialization</h2>

In addition to its own initialization, libmilter expects a filter to initialize several parameters before calling <a href="smfi_main.html">smfi_main</a>:
<ul>
    <li>The callbacks the filter wishes to be called, and the types of
    message modification it intends to perform (required, see <a
    href="smfi_register.html">smfi_register</a>).

    <li>The socket address to be used when communicating with the MTA
    (required, see <a href="smfi_setconn.html">smfi_setconn</a>).

    <li>The number of seconds to wait for MTA connections before
    timing out (optional, see <a
    href="smfi_settimeout.html">smfi_settimeout</a>).
</ul>
<p>
If the filter fails to initialize libmilter, or if one or more of the
parameters it has passed are invalid, a subsequent call to smfi_main
will fail.
d44 1
a44 1
<h2>Control flow</h2>
d46 1
a46 1
<p>
d48 12
a59 9
perspective of a set of <code>N</code> MTA's, each corresponding to a
connection.  Callbacks are shown beside the processing stages in which
they are invoked; if no callbacks are defined for a particular stage,
that stage may be bypassed.  Though it is not shown, processing may be
aborted at any time during a message, in which case the <a
href="xxfi_abort.html">xxfi_abort</a> callback is invoked and control
returns to <code>MESSAGE</code>.
<p>
<pre>
d63 3
a65 1
		process connection/helo (<a href="xxfi_connect.html">xxfi_connect</a>, <a href="xxfi_helo.html">xxfi_helo</a>)
d69 1
a69 1
			process sender (<a href="xxfi_envfrom.html">xxfi_envfrom</a>)
d73 1
a73 1
				process recipient (<a href="xxfi_envrcpt.html">xxfi_envrcpt</a>)
d77 1
d79 2
a80 2
				process header (<a href="xxfi_header.html">xxfi_header</a>)
			process end of headers (<a href="xxfi_eoh.html">xxfi_eoh</a>)
d82 2
a83 2
				process this body block (<a href="xxfi_body.html">xxfi_body</a>)
			process end of message (<a href="xxfi_eom.html">xxfi_eom</a>)
d87 1
a87 1
		process end of connection (<a href="xxfi_close.html">xxfi_close</a>)
d89 1
a89 1
</pre>
d95 4
a98 3
parts of a message transaction.  The library then controls all
sequencing, threading, and protocol exchange with the MTA.  <a
href="#figure-3">Figure 3</a> outlines control flow for a filter
d100 24
a123 22
</p>
<div align="center"><a name="figure-3"></a>
<table border=1 cellspacing=0 cellpadding=2 width="70%">
<tr bgcolor="#dddddd"><th>SMTP Commands</th><th>Milter Callbacks</th></tr>
<tr><td>(open SMTP connection)</td><td>xxfi_connect</td></tr>
<tr><td>HELO ...</td><td>xxfi_helo</td></tr>
<tr><td>MAIL From: ...</td><td>xxfi_envfrom</td></tr>
<tr><td>RCPT To: ...</td><td>xxfi_envrcpt</td></tr>
<tr><td>[more RCPTs]</td><td>[xxfi_envrcpt]</td></tr>
<tr><td>DATA</td><td>&nbsp;</td></tr>
<tr><td>Header: ...</td><td>xxfi_header</td></tr>
<tr><td>[more headers]</td><td>[xxfi_header]</td></tr>
<tr><td>&nbsp;</td><td>xxfi_eoh</td></tr>
<tr><td>body... </td><td>xxfi_body</td></tr>
<tr><td>[more body...]</td><td>[xxfi_body]</td></tr>
<tr><td>.</td><td>xxfi_eom</td></tr>
<tr><td>QUIT</td><td>xxfi_close</td></tr>
<tr><td>(close SMTP connection)</td><td>&nbsp;</td></tr>
</table>
<b>Figure 3: Milter callbacks related to an SMTP transaction.</b>
</div>
<p>
d125 8
a132 6
messages may be sent in a single connection.  Note also that a message
and/or connection may be aborted by either the remote host or the MTA
at any point during the SMTP transaction.  If this occurs during a
message (between the MAIL command and the final "."), the filter's <a
href="xxfi_abort.html">xxfi_abort</a> routine will be called.  <a
href="xxfi_close.html">xxfi_close</a> is called any time the
d135 1
a135 1
<h2>Multithreading</h2>
d137 1
a137 1
<p>
d139 2
a140 1
simultaneously.  All filtering callbacks must therefore be reentrant,
d142 40
a181 32
global data. Furthermore, since there is not a one-to-one
correspondence between threads and connections (N connections mapped
onto M threads, M &lt;= N), connection-specific data must be accessed
through the handles provided by the Milter library.  The programmer
cannot rely on library-supplied thread-specific data blocks
(e.g. pthread_getspecific()) to store connection-specific data.  See
the API documentation for <a
href="smfi_setpriv.html">smfi_setpriv</a> and <a
href="smfi_getpriv.html">smfi_getpriv</a> for details.

<h2>Resource management</h2>

Since filters are likely to be long-lived, and to handle many
connections, proper deallocation of per-connection resources is
important.  The lifetime of a connection is bracketed by calls to the
callbacks <a href="xxfi_connect.html">xxfi_connect</a> and <a
href="xxfi_close.html">xxfi_close</a>.  Therefore connection-specific
resources (accessed via <a href="smfi_getpriv.html">smfi_getpriv</a>
and <a href="smfi_setpriv.html">smfi_setpriv</a>) may be allocated in
<a href="xxfi_connect.html">xxfi_connect</a>, and should be freed in
<a href="xxfi_close.html">xxfi_close</a>.  For further information see
the <a href="api.html#conn-msg">discussion</a> of message- versus
connection-oriented routines.  In particular, note that there is only
one connection-specific data pointer per connection.
<p>

Each message is bracketed by calls to <a
href="xxfi_envfrom.html">xxfi_envfrom</a> and <a
href="xxfi_eom.html">xxfi_eom</a> (or <a
href="xxfi_abort.html">xxfi_abort</a>), implying that message-specific
resources can be allocated and reclaimed in these routines.  Since the
messages in a connection are processed sequentially by each filter,
d183 6
a188 5
connection and filter (and connection-private data block).  These
resources must still be accessed through <a
href="smfi_getpriv.html">smfi_getpriv</a> and <a
href="smfi_setpriv.html">smfi_setpriv</a>, and must be reclaimed
in <a href="xxfi_abort.html">xxfi_abort</a>.
d190 1
a190 1
<h2>Signal Handling</h2>
d192 2
a193 2
libmilter takes care of signal handling, the filters are
not influenced directly by signals.
d196 2
a197 2
<ol>
<li><TT>Stop</TT>: no new connections from the MTA will be accepted,
d199 1
a199 1
<li><TT>Abort</TT>: all filters will be stopped as soon as the next
d201 1
a201 1
</ol>
d203 2
a204 2
Filters are not terminated asynchronously (except by
signals that can't be caught).
d206 1
a206 1
<a href="xxfi_abort.html">xxfi_abort</a> callback is invoked.
d208 3
a210 3
<hr size="1">
<font size="-1">
Copyright (c) 2000, 2001, 2003 Sendmail, Inc. and its suppliers.
d212 1
a212 1
<br>
d215 3
a217 3
</font>
</body>
</html>
@


1.1.127.1
log
@Import Sendmail 8.14.3, suitably stripped down by the not yet committed
contrib/samples/import-3rdpty,v 1.35; we have some new and renamed files
@
text
@d1 5
a5 5
<HTML>
<HEAD>
<TITLE>Technical Overview</TITLE>
</HEAD>
<BODY>
d7 1
a7 1
$Id: overview.html,v 1.19 2006/12/21 18:23:47 ca Exp $
d10 1
a10 1
<H1>Technical Overview</H1>
d12 1
a12 1
<H2>Contents</H2>
d14 27
a40 29
<UL>
    <LI><A HREF="#Initialization">Initialization</A>
    <LI><A HREF="#ControlFlow">Control Flow</A>
    <LI><A HREF="#Multithreading">Multithreading</A>
    <LI><A HREF="#ResourceManagement">Resource Management</A>
    <LI><A HREF="#SignalHandling">Signal Handling</A>
</UL>

<H2><A NAME="Initialization">Initialization</A></H2>

In addition to its own initialization,
libmilter expects a filter to initialize several parameters
before calling <A HREF="smfi_main.html">smfi_main</A>:
<UL>
    <LI>The callbacks the filter wishes to be called, and the types of
    message modification it intends to perform (required, see
    <A HREF="smfi_register.html">smfi_register</A>).

    <LI>The socket address to be used when communicating with the MTA
    (required, see <A HREF="smfi_setconn.html">smfi_setconn</A>).

    <LI>The number of seconds to wait for MTA connections before
    timing out (optional, see
    <A HREF="smfi_settimeout.html">smfi_settimeout</A>).
</UL>
<P>
If the filter fails to initialize libmilter,
or if one or more of the parameters it has passed are invalid,
a subsequent call to smfi_main will fail.
d42 1
a42 1
<H2><A NAME="ControlFlow">Control Flow</A></H2>
d44 1
a44 1
<P>
d46 9
a54 12
perspective of a set of <CODE>N</CODE> MTA's,
each corresponding to a connection.
Callbacks are shown beside the processing stages in which they are invoked;
if no callbacks are defined for a particular stage,
that stage may be bypassed.
Though it is not shown,
processing may be aborted at any time during a message,
in which case the
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked and control
returns to <CODE>MESSAGE</CODE>.
<P>
<PRE>
d58 1
a58 1
		process connection/helo (<A HREF="xxfi_connect.html">xxfi_connect</A>, <A HREF="xxfi_helo.html">xxfi_helo</A>)
d62 1
a62 1
			process sender (<A HREF="xxfi_envfrom.html">xxfi_envfrom</A>)
d66 1
a66 1
				process recipient (<A HREF="xxfi_envrcpt.html">xxfi_envrcpt</A>)
a69 1
			process DATA (<A HREF="xxfi_data.html">xxfi_data</A>)
d71 2
a72 2
				process header (<A HREF="xxfi_header.html">xxfi_header</A>)
			process end of headers (<A HREF="xxfi_eoh.html">xxfi_eoh</A>)
d74 2
a75 2
				process this body block (<A HREF="xxfi_body.html">xxfi_body</A>)
			process end of message (<A HREF="xxfi_eom.html">xxfi_eom</A>)
d79 1
a79 1
		process end of connection (<A HREF="xxfi_close.html">xxfi_close</A>)
d81 1
a81 1
</PRE>
d87 3
a89 4
parts of a message transaction.
The library then controls all sequencing, threading,
and protocol exchange with the MTA.
<A HREF="#figure-3">Figure 3</A> outlines control flow for a filter
d91 22
a112 24
</P>

<DIV ALIGN="center"><A NAME="figure-3"></A>
<TABLE border=1 cellspacing=0 cellpadding=2 width="70%">
<TR bgcolor="#dddddd"><TH>SMTP Commands</TH><TH>Milter Callbacks</TH></TR>
<TR><TD>(open SMTP connection)</TD><TD>xxfi_connect</TD></TR>
<TR><TD>HELO ...</TD><TD>xxfi_helo</TD></TR>
<TR><TD>MAIL From: ...</TD><TD>xxfi_envfrom</TD></TR>
<TR><TD>RCPT To: ...</TD><TD>xxfi_envrcpt</TD></TR>
<TR><TD>[more RCPTs]</TD><TD>[xxfi_envrcpt]</TD></TR>
<TR><TD>DATA</TD><TD>xxfi_data</TD></TR>
<TR><TD>Header: ...</TD><TD>xxfi_header</TD></TR>
<TR><TD>[more headers]</TD><TD>[xxfi_header]</TD></TR>
<TR><TD>&nbsp;</TD><TD>xxfi_eoh</TD></TR>
<TR><TD>body... </TD><TD>xxfi_body</TD></TR>
<TR><TD>[more body...]</TD><TD>[xxfi_body]</TD></TR>
<TR><TD>.</TD><TD>xxfi_eom</TD></TR>
<TR><TD>QUIT</TD><TD>xxfi_close</TD></TR>
<TR><TD>(close SMTP connection)</TD><TD>&nbsp;</TD></TR>
</TABLE>
<B>Figure 3: Milter callbacks related to an SMTP transaction.</B>
</DIV>

<P>
d114 6
a119 8
messages may be sent in a single connection.
Note also that a message or connection may be aborted by
either the remote host or the MTA
at any point during the SMTP transaction.
f this occurs during a message (between the MAIL command and the final "."),
the filter's
<A HREF="xxfi_abort.html">xxfi_abort</A> routine will be called.
<A HREF="xxfi_close.html">xxfi_close</A> is called any time the
d122 1
a122 1
<H2><A NAME="Multithreading">Multithreading</A></H2>
d124 1
a124 1
<P>
d126 1
a126 2
simultaneously.
All filtering callbacks must therefore be reentrant,
d128 32
a159 40
global data.
Furthermore, since there is not a one-to-one correspondence
between threads and connections
(N connections mapped onto M threads, M &lt;= N),
connection-specific data must be accessed
through the handles provided by the Milter library.
The programmer cannot rely on library-supplied thread-specific data blocks
(e.g., <CODE>pthread_getspecific(3)</CODE>) to store connection-specific data.
See the API documentation for
<A HREF="smfi_setpriv.html">smfi_setpriv</A> and
<A HREF="smfi_getpriv.html">smfi_getpriv</A> for details.

<H2><A NAME="ResourceManagement">Resource Management</A></H2>

Since filters are likely to be long-lived,
and to handle many connections,
proper deallocation of per-connection resources is important.
The lifetime of a connection is bracketed by calls to the
callbacks <A HREF="xxfi_connect.html">xxfi_connect</A> and
<A HREF="xxfi_close.html">xxfi_close</A>.
Therefore connection-specific
resources (accessed via <A HREF="smfi_getpriv.html">smfi_getpriv</A>
and <A HREF="smfi_setpriv.html">smfi_setpriv</A>) may be allocated in
<A HREF="xxfi_connect.html">xxfi_connect</A>,
and should be freed in
<A HREF="xxfi_close.html">xxfi_close</A>.
For further information see
the <A HREF="api.html#conn-msg">discussion</A> of message- versus
connection-oriented routines.
In particular,
note that there is only one connection-specific data pointer per connection.
<P>

Each message is bracketed by calls to
<A HREF="xxfi_envfrom.html">xxfi_envfrom</A> and
<A HREF="xxfi_eom.html">xxfi_eom</A> (or
<A HREF="xxfi_abort.html">xxfi_abort</A>),
implying that message-specific resources can be allocated
and reclaimed in these routines.
Since the messages in a connection are processed sequentially by each filter,
d161 5
a165 6
connection and filter (and connection-private data block).
These resources must still be accessed through
<A HREF="smfi_getpriv.html">smfi_getpriv</A> and
<A HREF="smfi_setpriv.html">smfi_setpriv</A>,
and must be reclaimed in
<A HREF="xxfi_abort.html">xxfi_abort</A>.
d167 1
a167 1
<H2><A NAME="SignalHandling">Signal Handling</A></H2>
d169 2
a170 2
libmilter takes care of signal handling,
the filters are not influenced directly by signals.
d173 2
a174 2
<OL>
<LI><TT>Stop</TT>: no new connections from the MTA will be accepted,
d176 1
a176 1
<LI><TT>Abort</TT>: all filters will be stopped as soon as the next
d178 1
a178 1
</OL>
d180 2
a181 2
Filters are not terminated asynchronously
(except by signals that can't be caught).
d183 1
a183 1
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked.
d185 3
a187 3
<HR size="1">
<FONT size="-1">
Copyright (c) 2000, 2001, 2003, 2006 Sendmail, Inc. and its suppliers.
d189 1
a189 1
<BR>
d192 3
a194 3
</FONT>
</BODY>
</HTML>
@


1.1.127.2
log
@Import sendmail.8.14.5.Beta0.tar.gz
@
text
@d7 1
a7 1
$Id: overview.html,v 1.20 2009/11/13 18:15:05 ca Exp $
d63 1
a63 3
		process connection (<A HREF="xxfi_connect.html">xxfi_connect</A>)
	For each filter
		process helo/ehlo (<A HREF="xxfi_helo.html">xxfi_helo</A>)
@


1.1.127.3
log
@Import sendmail.8.14.5.tar.gz.sig
@
text
@d7 1
a7 1
$Id: overview.html,v 1.21 2010/12/14 20:59:52 ca Exp $
d129 1
a129 1
If this occurs during a message (between the MAIL command and the final "."),
@


1.1.127.4
log
@Import sendmail 8.14.9
@
text
@d7 1
a7 1
$Id: overview.html,v 1.22 2013-11-22 20:51:39 ca Exp $
d210 1
a210 1
Copyright (c) 2000, 2001, 2003, 2006 Proofpoint, Inc. and its suppliers.
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@Import Sendmail 8.14.0 via OpenBSD
@
text
@d1 5
a5 5
<HTML>
<HEAD>
<TITLE>Technical Overview</TITLE>
</HEAD>
<BODY>
d7 1
a7 1
$Sendmail: overview.html,v 1.19 2006/12/21 18:23:47 ca Exp $
d10 1
a10 1
<H1>Technical Overview</H1>
d12 1
a12 1
<H2>Contents</H2>
d14 27
a40 29
<UL>
    <LI><A HREF="#Initialization">Initialization</A>
    <LI><A HREF="#ControlFlow">Control Flow</A>
    <LI><A HREF="#Multithreading">Multithreading</A>
    <LI><A HREF="#ResourceManagement">Resource Management</A>
    <LI><A HREF="#SignalHandling">Signal Handling</A>
</UL>

<H2><A NAME="Initialization">Initialization</A></H2>

In addition to its own initialization,
libmilter expects a filter to initialize several parameters
before calling <A HREF="smfi_main.html">smfi_main</A>:
<UL>
    <LI>The callbacks the filter wishes to be called, and the types of
    message modification it intends to perform (required, see
    <A HREF="smfi_register.html">smfi_register</A>).

    <LI>The socket address to be used when communicating with the MTA
    (required, see <A HREF="smfi_setconn.html">smfi_setconn</A>).

    <LI>The number of seconds to wait for MTA connections before
    timing out (optional, see
    <A HREF="smfi_settimeout.html">smfi_settimeout</A>).
</UL>
<P>
If the filter fails to initialize libmilter,
or if one or more of the parameters it has passed are invalid,
a subsequent call to smfi_main will fail.
d42 1
a42 1
<H2><A NAME="ControlFlow">Control Flow</A></H2>
d44 1
a44 1
<P>
d46 9
a54 12
perspective of a set of <CODE>N</CODE> MTA's,
each corresponding to a connection.
Callbacks are shown beside the processing stages in which they are invoked;
if no callbacks are defined for a particular stage,
that stage may be bypassed.
Though it is not shown,
processing may be aborted at any time during a message,
in which case the
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked and control
returns to <CODE>MESSAGE</CODE>.
<P>
<PRE>
d58 1
a58 1
		process connection/helo (<A HREF="xxfi_connect.html">xxfi_connect</A>, <A HREF="xxfi_helo.html">xxfi_helo</A>)
d62 1
a62 1
			process sender (<A HREF="xxfi_envfrom.html">xxfi_envfrom</A>)
d66 1
a66 1
				process recipient (<A HREF="xxfi_envrcpt.html">xxfi_envrcpt</A>)
a69 1
			process DATA (<A HREF="xxfi_data.html">xxfi_data</A>)
d71 2
a72 2
				process header (<A HREF="xxfi_header.html">xxfi_header</A>)
			process end of headers (<A HREF="xxfi_eoh.html">xxfi_eoh</A>)
d74 2
a75 2
				process this body block (<A HREF="xxfi_body.html">xxfi_body</A>)
			process end of message (<A HREF="xxfi_eom.html">xxfi_eom</A>)
d79 1
a79 1
		process end of connection (<A HREF="xxfi_close.html">xxfi_close</A>)
d81 1
a81 1
</PRE>
d87 3
a89 4
parts of a message transaction.
The library then controls all sequencing, threading,
and protocol exchange with the MTA.
<A HREF="#figure-3">Figure 3</A> outlines control flow for a filter
d91 22
a112 24
</P>

<DIV ALIGN="center"><A NAME="figure-3"></A>
<TABLE border=1 cellspacing=0 cellpadding=2 width="70%">
<TR bgcolor="#dddddd"><TH>SMTP Commands</TH><TH>Milter Callbacks</TH></TR>
<TR><TD>(open SMTP connection)</TD><TD>xxfi_connect</TD></TR>
<TR><TD>HELO ...</TD><TD>xxfi_helo</TD></TR>
<TR><TD>MAIL From: ...</TD><TD>xxfi_envfrom</TD></TR>
<TR><TD>RCPT To: ...</TD><TD>xxfi_envrcpt</TD></TR>
<TR><TD>[more RCPTs]</TD><TD>[xxfi_envrcpt]</TD></TR>
<TR><TD>DATA</TD><TD>xxfi_data</TD></TR>
<TR><TD>Header: ...</TD><TD>xxfi_header</TD></TR>
<TR><TD>[more headers]</TD><TD>[xxfi_header]</TD></TR>
<TR><TD>&nbsp;</TD><TD>xxfi_eoh</TD></TR>
<TR><TD>body... </TD><TD>xxfi_body</TD></TR>
<TR><TD>[more body...]</TD><TD>[xxfi_body]</TD></TR>
<TR><TD>.</TD><TD>xxfi_eom</TD></TR>
<TR><TD>QUIT</TD><TD>xxfi_close</TD></TR>
<TR><TD>(close SMTP connection)</TD><TD>&nbsp;</TD></TR>
</TABLE>
<B>Figure 3: Milter callbacks related to an SMTP transaction.</B>
</DIV>

<P>
d114 6
a119 8
messages may be sent in a single connection.
Note also that a message or connection may be aborted by
either the remote host or the MTA
at any point during the SMTP transaction.
f this occurs during a message (between the MAIL command and the final "."),
the filter's
<A HREF="xxfi_abort.html">xxfi_abort</A> routine will be called.
<A HREF="xxfi_close.html">xxfi_close</A> is called any time the
d122 1
a122 1
<H2><A NAME="Multithreading">Multithreading</A></H2>
d124 1
a124 1
<P>
d126 1
a126 2
simultaneously.
All filtering callbacks must therefore be reentrant,
d128 32
a159 40
global data.
Furthermore, since there is not a one-to-one correspondence
between threads and connections
(N connections mapped onto M threads, M &lt;= N),
connection-specific data must be accessed
through the handles provided by the Milter library.
The programmer cannot rely on library-supplied thread-specific data blocks
(e.g., <CODE>pthread_getspecific(3)</CODE>) to store connection-specific data.
See the API documentation for
<A HREF="smfi_setpriv.html">smfi_setpriv</A> and
<A HREF="smfi_getpriv.html">smfi_getpriv</A> for details.

<H2><A NAME="ResourceManagement">Resource Management</A></H2>

Since filters are likely to be long-lived,
and to handle many connections,
proper deallocation of per-connection resources is important.
The lifetime of a connection is bracketed by calls to the
callbacks <A HREF="xxfi_connect.html">xxfi_connect</A> and
<A HREF="xxfi_close.html">xxfi_close</A>.
Therefore connection-specific
resources (accessed via <A HREF="smfi_getpriv.html">smfi_getpriv</A>
and <A HREF="smfi_setpriv.html">smfi_setpriv</A>) may be allocated in
<A HREF="xxfi_connect.html">xxfi_connect</A>,
and should be freed in
<A HREF="xxfi_close.html">xxfi_close</A>.
For further information see
the <A HREF="api.html#conn-msg">discussion</A> of message- versus
connection-oriented routines.
In particular,
note that there is only one connection-specific data pointer per connection.
<P>

Each message is bracketed by calls to
<A HREF="xxfi_envfrom.html">xxfi_envfrom</A> and
<A HREF="xxfi_eom.html">xxfi_eom</A> (or
<A HREF="xxfi_abort.html">xxfi_abort</A>),
implying that message-specific resources can be allocated
and reclaimed in these routines.
Since the messages in a connection are processed sequentially by each filter,
d161 5
a165 6
connection and filter (and connection-private data block).
These resources must still be accessed through
<A HREF="smfi_getpriv.html">smfi_getpriv</A> and
<A HREF="smfi_setpriv.html">smfi_setpriv</A>,
and must be reclaimed in
<A HREF="xxfi_abort.html">xxfi_abort</A>.
d167 1
a167 1
<H2><A NAME="SignalHandling">Signal Handling</A></H2>
d169 2
a170 2
libmilter takes care of signal handling,
the filters are not influenced directly by signals.
d173 2
a174 2
<OL>
<LI><TT>Stop</TT>: no new connections from the MTA will be accepted,
d176 1
a176 1
<LI><TT>Abort</TT>: all filters will be stopped as soon as the next
d178 1
a178 1
</OL>
d180 2
a181 2
Filters are not terminated asynchronously
(except by signals that can't be caught).
d183 1
a183 1
<A HREF="xxfi_abort.html">xxfi_abort</A> callback is invoked.
d185 3
a187 3
<HR size="1">
<FONT size="-1">
Copyright (c) 2000, 2001, 2003, 2006 Sendmail, Inc. and its suppliers.
d189 1
a189 1
<BR>
d192 3
a194 3
</FONT>
</BODY>
</HTML>
@


1.1.1.3
log
@Replace “$Sendmail: ” with “$Id: ” (the latter is used by upstream)
@
text
@d7 1
a7 1
$Id: overview.html,v 1.19 2006/12/21 18:23:47 ca Exp $
@


1.1.1.4
log
@Import OpenBSD’s sendmail 8.14.5, RCS IDs properly sedded back
@
text
@d7 1
a7 1
$Id: overview.html,v 1.21 2010/12/14 20:59:52 ca Exp $
d63 1
a63 3
		process connection (<A HREF="xxfi_connect.html">xxfi_connect</A>)
	For each filter
		process helo/ehlo (<A HREF="xxfi_helo.html">xxfi_helo</A>)
d127 1
a127 1
If this occurs during a message (between the MAIL command and the final "."),
@


