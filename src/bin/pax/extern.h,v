head	1.39;
access;
symbols
	paxmirabilis-20190825:1.39
	paxmirabilis-20190224:1.39
	paxmirabilis-20190210:1.37
	npax:1.1.1.10.0.2
	cvs-20181212:1.1.1.10
	paxmirabilis-20171021:1.31
	paxmirabilis-20161104:1.31
	paxmirabilis-20161031:1.31
	paxmirabilis-20161025:1.31
	paxmirabilis-20160306:1.28
	cvs-201603041945:1.1.1.5
	paxmirabilis-20151013:1.25
	paxmirabilis-20140703:1.25
	paxmirabilis-20120606:1.24
	paxmirabilis-20120605:1.24
	cvs-201206051745:1.1.1.4
	paxmirabilis-20120520:1.21
	paxmirabilis-20120216:1.19
	paxmirabilis-20120212:1.16
	cvs-201202112230:1.1.1.4
	paxmirabilis-20110817:1.15
	MIRBSD_10:1.10.0.2
	MIRBSD_10_BASE:1.10
	cvs-200710231945:1.1.1.3
	cvs-200606232242:1.1.1.2
	MIRBSD_9_BASE:1.6
	MIRBSD_8:1.4.0.2
	MIRBSD_8_BASE:1.4
	cvs-200507211800:1.1.1.2
	cvs-200504291700:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.39
date	2019.02.24.01.49.17;	author tg;	state Exp;
branches;
next	1.38;
commitid	1005C71F80D12F84641;

1.38
date	2019.02.20.22.07.01;	author tg;	state Exp;
branches;
next	1.37;
commitid	1005C6DCF5166849B2E;

1.37
date	2018.12.13.07.14.16;	author tg;	state Exp;
branches;
next	1.36;
commitid	1005C1206DD06338A12;

1.36
date	2018.12.13.07.12.01;	author tg;	state Exp;
branches;
next	1.35;
commitid	1005C1206596A173853;

1.35
date	2018.12.13.07.09.10;	author tg;	state Exp;
branches;
next	1.34;
commitid	1005C1205A44B32AFA4;

1.34
date	2018.12.12.18.08.43;	author tg;	state Exp;
branches;
next	1.33;
commitid	1005C114EA81986F5EC;

1.33
date	2018.12.12.00.23.05;	author tg;	state Exp;
branches;
next	1.32;
commitid	1005C1054FE750D63F3;

1.32
date	2018.12.12.00.09.27;	author tg;	state Exp;
branches;
next	1.31;
commitid	1005C1051C27816C858;

1.31
date	2016.10.25.19.27.12;	author tg;	state Exp;
branches;
next	1.30;
commitid	100580FB2217F8FFA4F;

1.30
date	2016.10.25.18.57.54;	author tg;	state Exp;
branches;
next	1.29;
commitid	100580FAB4B20AD4FA2;

1.29
date	2016.03.12.13.20.47;	author tg;	state Exp;
branches;
next	1.28;
commitid	10056E417C13E8BF870;

1.28
date	2016.03.06.14.12.27;	author tg;	state Exp;
branches;
next	1.27;
commitid	10056DC3ADA1858410D;

1.27
date	2016.03.06.13.47.49;	author tg;	state Exp;
branches;
next	1.26;
commitid	10056DC351700BAF310;

1.26
date	2015.10.14.18.10.08;	author tg;	state Exp;
branches;
next	1.25;
commitid	100561E9A905398529C;

1.25
date	2013.10.31.20.05.40;	author tg;	state Exp;
branches;
next	1.24;
commitid	1005272B7081B0E5655;

1.24
date	2012.06.05.19.09.41;	author tg;	state Exp;
branches;
next	1.23;
commitid	1004FCE598C750277B2;

1.23
date	2012.06.05.18.52.15;	author tg;	state Exp;
branches;
next	1.22;
commitid	1004FCE55470EF2C532;

1.22
date	2012.06.05.18.13.49;	author tg;	state Exp;
branches;
next	1.21;
commitid	1004FCE4C7439736DC4;

1.21
date	2012.05.20.17.21.44;	author tg;	state Exp;
branches;
next	1.20;
commitid	1004FB9283F72C8E596;

1.20
date	2012.05.20.16.13.17;	author tg;	state Exp;
branches;
next	1.19;
commitid	1004FB918314D2FECC0;

1.19
date	2012.02.16.17.27.31;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004F3D3C992B2187A1;

1.18
date	2012.02.16.17.11.45;	author tg;	state Exp;
branches;
next	1.17;
commitid	1004F3D38626EFD0781;

1.17
date	2012.02.16.16.01.08;	author tg;	state Exp;
branches;
next	1.16;
commitid	1004F3D28152C6F33B8;

1.16
date	2012.02.12.00.27.15;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004F3707786D20BF4A;

1.15
date	2011.08.16.21.32.47;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004E4AE1EF00AF3003;

1.14
date	2011.08.16.13.57.14;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004E4A774D3CB07A5D;

1.13
date	2011.08.16.13.50.17;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004E4A75A9095E9071;

1.12
date	2009.10.04.14.51.06;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004AC8B662360E113C;

1.11
date	2008.10.29.17.34.48;	author tg;	state Exp;
branches;
next	1.10;
commitid	10049089E5F758E2CFE;

1.10
date	2007.10.23.20.07.42;	author tg;	state Exp;
branches;
next	1.9;
commitid	100471E5499154FE86E;

1.9
date	2007.02.17.04.52.40;	author tg;	state Exp;
branches;
next	1.8;
commitid	10045D68A2D54E2C558;

1.8
date	2007.02.17.04.16.09;	author tg;	state Exp;
branches;
next	1.7;
commitid	10045D6817E17DB1AB4;

1.7
date	2006.07.16.17.56.29;	author tg;	state Exp;
branches;
next	1.6;
commitid	10044BA7DDB68C27897;

1.6
date	2006.06.19.19.22.08;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004496F94825B1E33A;

1.5
date	2005.12.30.14.19.15;	author tg;	state Exp;
branches;
next	1.4;
commitid	10043B541E63A5BE8D7;

1.4
date	2005.12.17.07.12.06;	author tg;	state Exp;
branches;
next	1.3;
commitid	10043A3B7997FC3F459;

1.3
date	2005.11.23.23.27.10;	author tg;	state Exp;
branches;
next	1.2;
commitid	61c84384fa91bd26;

1.2
date	2005.11.16.13.58.39;	author tg;	state Exp;
branches;
next	1.1;
commitid	63cf437b3768eac1;

1.1
date	2005.02.05.17.22.06;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.22.06;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.04.29.17.05.15;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2007.10.23.19.50.48;	author tg;	state Exp;
branches;
next	1.1.1.4;
commitid	100471E50A5256C77AE;

1.1.1.4
date	2012.02.11.22.47.21;	author tg;	state Exp;
branches;
next	1.1.1.5;
commitid	1004F36F008225F3522;

1.1.1.5
date	2016.03.04.19.46.09;	author tg;	state Exp;
branches;
next	1.1.1.6;
commitid	10056D9E61429EE6550;

1.1.1.6
date	2016.03.04.20.55.00;	author tg;	state Exp;
branches;
next	1.1.1.7;
commitid	10056D9F62E152ECBA5;

1.1.1.7
date	2016.03.06.13.29.54;	author tg;	state Exp;
branches;
next	1.1.1.8;
commitid	10056DC30960F3F5FA0;

1.1.1.8
date	2016.10.25.18.46.09;	author tg;	state Exp;
branches;
next	1.1.1.9;
commitid	100580FA88137705D31;

1.1.1.9
date	2018.12.12.00.15.04;	author tg;	state Exp;
branches;
next	1.1.1.10;
commitid	1005C1052FA5E745A2C;

1.1.1.10
date	2018.12.12.00.24.23;	author tg;	state Exp;
branches
	1.1.1.10.2.1;
next	;
commitid	1005C1055452C78F9E4;

1.1.1.10.2.1
date	2018.12.12.00.52.58;	author tg;	state Exp;
branches;
next	1.1.1.10.2.2;
commitid	1005C105BC86262A0B7;

1.1.1.10.2.2
date	2018.12.12.03.13.31;	author tg;	state Exp;
branches;
next	1.1.1.10.2.3;
commitid	1005C107CE315DC51F3;

1.1.1.10.2.3
date	2018.12.12.06.25.15;	author tg;	state Exp;
branches;
next	1.1.1.10.2.4;
commitid	1005C10A9DB34B11C85;

1.1.1.10.2.4
date	2018.12.12.06.57.43;	author tg;	state Exp;
branches;
next	1.1.1.10.2.5;
commitid	1005C10B17B60390CAF;

1.1.1.10.2.5
date	2018.12.12.07.03.47;	author tg;	state Exp;
branches;
next	1.1.1.10.2.6;
commitid	1005C10B2E50CAEB848;

1.1.1.10.2.6
date	2018.12.12.07.47.48;	author tg;	state Exp;
branches;
next	1.1.1.10.2.7;
commitid	1005C10BD3146450729;

1.1.1.10.2.7
date	2018.12.12.08.32.29;	author tg;	state Exp;
branches;
next	1.1.1.10.2.8;
commitid	1005C10C7B32275D60D;

1.1.1.10.2.8
date	2018.12.12.09.08.56;	author tg;	state Exp;
branches;
next	1.1.1.10.2.9;
commitid	1005C10D0381A00BE25;

1.1.1.10.2.9
date	2018.12.12.10.24.14;	author tg;	state Exp;
branches;
next	1.1.1.10.2.10;
commitid	1005C10E1DB5956B939;

1.1.1.10.2.10
date	2018.12.12.10.41.25;	author tg;	state Exp;
branches;
next	1.1.1.10.2.11;
commitid	1005C10E5E87909E6FC;

1.1.1.10.2.11
date	2018.12.12.15.33.05;	author tg;	state Exp;
branches;
next	1.1.1.10.2.12;
commitid	1005C112A434F807902;

1.1.1.10.2.12
date	2018.12.12.15.38.31;	author tg;	state Exp;
branches;
next	1.1.1.10.2.13;
commitid	1005C112B8E47E3ADA5;

1.1.1.10.2.13
date	2018.12.12.16.24.27;	author tg;	state Exp;
branches;
next	;
commitid	1005C11364A797CBA33;


desc
@@


1.39
log
@deprecate some old earliest MirCPIO extensions:

• tar -R and -S (also dedocumented)
• the dist, v4norm, v4root formats (which already were undocumented)

but indicate in tar(1) that YMMV
@
text
@/*	$OpenBSD: extern.h,v 1.59 2018/09/13 12:33:43 millert Exp $	*/
/*	$NetBSD: extern.h,v 1.5 1996/03/26 23:54:16 mrg Exp $	*/

/*-
 * Copyright © 2013, 2015, 2016, 2018, 2019
 *	mirabilos <m@@mirbsd.org>
 * Copyright (c) 1992 Keith Muller.
 * Copyright (c) 1992, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * This code is derived from software contributed to Berkeley by
 * Keith Muller of the University of California, San Diego.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)extern.h	8.2 (Berkeley) 4/18/94
 */

/*
 * External references from each source file
 */

#ifdef EXTERN
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.38 2019/02/20 22:07:01 tg Exp $");
#endif

#ifndef PAX_JUST_THE_WARNINGS
/*
 * ar.c
 */
int uar_stwr(int);
int uar_ismagic(char *);
int uar_id(char *, int) MKSH_A_NORETURN;
int uar_rd(ARCHD *, char *);
int uar_wr(ARCHD *);
int uar_wr_data(ARCHD *, int, off_t *);
off_t uar_endrd(void);
int uar_trail(ARCHD *, char *, int, int *) MKSH_A_NORETURN;

/*
 * ar_io.c
 */
extern const char *arcname;
extern const char *compress_program;
extern char force_one_volume;
int ar_open(const char *);
void ar_close(int _in_sig);
void ar_drain(void);
int ar_set_wr(void);
int ar_app_ok(void);
int ar_read(char *, int);
int ar_write(char *, int);
int ar_rdsync(void);
int ar_fow(off_t, off_t *);
int ar_rev(off_t );
int ar_next(void);
extern char ar_do_keepopen;
int ar_next_keepopen(void);

/*
 * ar_subs.c
 */
extern u_long flcnt;
void list(void);
void extract(void);
void append(void);
void archive(void);
void copy(void);

/*
 * buf_subs.c
 */
extern int blksz;
extern int wrblksz;
extern int maxflt;
extern int rdblksz;
extern off_t wrlimit;
extern off_t rdcnt;
extern off_t wrcnt;
int wr_start(void);
int rd_start(void);
void cp_start(void);
int appnd_start(off_t);
int rd_sync(void);
void pback(const char *, int);
int rd_skip(off_t);
void wr_fin(void);
int wr_rdbuf(const char *, int);
int rd_wrbuf(char *, int);
int wr_skip(off_t);
int wr_rdfile(ARCHD *, int, off_t *);
int rd_wrfile(ARCHD *, int, off_t *);
void cp_file(ARCHD *, int, int);
int buf_fill(void);
int buf_fill_internal(int);
int buf_flush(int);

/*
 * cache.c
 */
#if !HAVE_UG_FROM_UGID
int uidtb_start(void);
int gidtb_start(void);
const char *name_uid(uid_t, int);
const char *name_gid(gid_t, int);
#else
#define name_uid(u, frc) ((const char *)user_from_uid((u), !(frc)))
#define name_gid(g, frc) ((const char *)group_from_gid((g), !(frc)))
#endif
#if !HAVE_UGID_FROM_UG
int usrtb_start(void);
int grptb_start(void);
int uid_name(const char *, uid_t *);
int gid_name(const char *, gid_t *);
int uid_uncached(const char *, uid_t *);
int gid_uncached(const char *, gid_t *);
#else
#define uid_name uid_from_user
#define gid_name gid_from_group
#define uid_uncached uid_from_user
#define gid_uncached gid_from_group
#endif

/*
 * cpio.c
 */
int cpio_strd(void);
int cpio_trail(ARCHD *, char *, int, int *);
int cpio_endwr(void);
int cpio_id(char *, int);
int cpio_rd(ARCHD *, char *);
off_t cpio_endrd(void);
int cpio_stwr(int);
int dist_stwr(int);
int cpio_wr(ARCHD *);
int vcpio_id(char *, int);
int crc_id(char *, int);
int crc_strd(void);
int vcpio_rd(ARCHD *, char *);
off_t vcpio_endrd(void);
int crc_stwr(int);
int v4root_stwr(int);
int v4norm_stwr(int);
int vcpio_wr(ARCHD *);
int bcpio_id(char *, int);
int bcpio_rd(ARCHD *, char *);
off_t bcpio_endrd(void);
int bcpio_wr(ARCHD *);

/*
 * file_subs.c
 */
int file_creat(ARCHD *);
void file_close(ARCHD *, int);
int lnk_creat(ARCHD *, int *);
int cross_lnk(ARCHD *);
int chk_same(ARCHD *);
int node_creat(ARCHD *);
int unlnk_exist(char *, int);
int chk_path(char *, uid_t, gid_t);
void set_ftime(const char *, const struct stat *, int, int);
int set_ids(char *, uid_t, gid_t, int);
int fset_ids(char *, int, uid_t, gid_t);
void set_pmode(char *, mode_t, int);
void fset_pmode(char *, int, mode_t);
struct file_times; /* avoid pulling time.h globally */
int set_attr(const struct file_times *, int _force_times, mode_t,
    int _do_mode, int _in_sig);
int file_write(int, char *, int, int *, int *, int, char *);
void file_flush(int, char *, int);
void rdfile_close(ARCHD *, int *);
int set_crc(ARCHD *, int);

/*
 * ftree.c
 */
int ftree_start(void);
int ftree_add(char *, int);
void ftree_sel(ARCHD *);
void ftree_skipped_newer(void);
void ftree_chk(void);
int next_file(ARCHD *);

/*
 * gen_subs.c
 */
void ls_list(ARCHD *, FILE *);
void ls_tty(ARCHD *);
void safe_print(const char *, FILE *);
u_long asc_ul(char *, int, int);
int ul_asc(u_long, char *, int, int);
unsigned long long asc_ull(char *, int, int);
int ull_asc(unsigned long long, char *, int, int);
size_t fieldcpy(char *, size_t, const char *, size_t);

/*
 * getoldopt.c
 */
int getoldopt(int, char **, const char *);

/*
 * options.c
 */
extern const FSUB fsub[];
extern const unsigned char ford[];
extern int anonarch;
extern char to_stdout;
void options(int, char **);
OPLIST * opt_next(void);
int opt_add(const char *);
int bad_opt(void);
void guess_compress_program(int);
void anonarch_init(void);
void mircpio_deprecated(const char *, const char *);
extern char *chdname;

/*
 * pat_rep.c
 */
int rep_add(char *);
int pat_add(char *, char *);
void pat_chk(void);
int pat_sel(ARCHD *);
int pat_match(ARCHD *);
int mod_name(ARCHD *);
int set_dest(ARCHD *, char *, int);
int has_dotdot(const char *);

/*
 * pax.c
 */
extern signed char act;
extern const FSUB *frmt;
extern signed char cflag;
extern signed char cwdfd;
extern signed char dflag;
extern signed char iflag;
extern signed char kflag;
extern signed char lflag;
extern signed char nflag;
extern signed char tflag;
extern signed char uflag;
extern signed char Vflag;
extern signed char vflag;
extern signed char Dflag;
extern signed char Hflag;
extern signed char Lflag;
extern signed char Xflag;
extern signed char Yflag;
extern signed char Zflag;
extern signed char zeroflag;
extern signed char vfpart;
extern signed char patime;
extern signed char pmtime;
extern signed char nodirs;
extern signed char pmode;
extern signed char pids;
extern signed char rmleadslash;
extern signed char exit_val;
extern signed char docrc;
extern char *dirptr;
extern const char *argv0;
extern enum op_mode { OP_PAX, OP_TAR, OP_CPIO } op_mode;
extern FILE *listf;
extern int listfd;
extern char *tempfile;
extern char *tempbase;
extern char havechd;
extern time_t now;

void sig_cleanup(int) MKSH_A_NORETURN;

/*
 * sel_subs.c
 */
int sel_chk(ARCHD *);
int grp_add(char *);
int usr_add(char *);
int trng_add(char *);

/*
 * tables.c
 */
int lnk_start(void);
int chk_lnk(ARCHD *);
void purg_lnk(ARCHD *);
void lnk_end(void);
int ftime_start(void);
int chk_ftime(ARCHD *);
int sltab_start(void);
int sltab_add_sym(const char *_path, const char *_value, mode_t _mode);
int sltab_add_link(const char *, const struct stat *);
void sltab_process(int _in_sig);
int name_start(void);
int add_name(char *, int, char *);
void sub_name(char *, int *, int);
int dev_start(void);
int add_dev(ARCHD *);
int map_dev(ARCHD *, u_long, u_long);
int atdir_start(void);
void atdir_end(void);
void add_atdir(const char *, const struct stat *);
int do_atdir(const char *, dev_t, ino_t);
int dir_start(void);
void add_dir(char *, struct stat *, int);
void delete_dir(dev_t, ino_t);
void proc_dir(int _in_sig);
unsigned int st_hash(const char *, int, int);
int flnk_start(void);
int chk_flnk(ARCHD *);

/*
 * tar.c
 */
#ifndef SMALL
extern char tar_nodir;
#endif
extern char *gnu_name_string, *gnu_link_string;
int tar_endwr(void);
off_t tar_endrd(void);
int tar_trail(ARCHD *, char *, int, int *);
int tar_id(char *, int);
#ifndef SMALL
int tar_opt(void);
#else
#define tar_opt bad_opt
#endif
int tar_rd(ARCHD *, char *);
int tar_wr(ARCHD *);
int ustar_strd(void);
int ustar_stwr(int);
int ustar_id(char *, int);
int ustar_rd(ARCHD *, char *);
int ustar_wr(ARCHD *);

/*
 * tty_subs.c
 */
extern char fdgetline_err;
char *fdgetline(int);
int tty_init(void);
void tty_prnt(const char *, ...)
    MKSH_A_NONNULL(1)
    MKSH_A_FORMAT(__printf__, 1, 2);
char *tty_rd(void);
#endif
void paxwarn(int, const char *, ...)
    MKSH_A_NONNULL(2)
    MKSH_A_FORMAT(__printf__, 2, 3);
void syswarn(int, int, const char *, ...)
    MKSH_A_NONNULL(3)
    MKSH_A_FORMAT(__printf__, 3, 4);
@


1.38
log
@port to MidnightBSD (both clang (default) and gcc tested)

• has only utmpx.h and therefore not UT_NAMESIZE
• needs _WITH_DPRINTF defined for picking up dprintf declaration

also, fix FTBFS when HAVE_UGID_FROM_UG was true (affects also OpenBSD)
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.36 2018/12/13 07:12:01 tg Exp $");
d236 1
@


1.37
log
@place another const with no ill effect
@
text
@d5 1
a5 1
 * Copyright © 2013, 2015, 2016, 2018
a119 1
#if !HAVE_UGID_FROM_UG
d126 5
d132 1
a134 7
#if HAVE_UG_FROM_UGID
#define name_uid(u, frc) ((const char *)user_from_uid((u), !(frc)))
#define name_gid(g, frc) ((const char *)group_from_gid((g), !(frc)))
#else
const char *name_uid(uid_t, int);
const char *name_gid(gid_t, int);
#endif
@


1.36
log
@constify
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.35 2018/12/13 07:09:10 tg Exp $");
d107 1
a107 1
void pback(char *, int);
@


1.35
log
@fixing and string pooling and int shortening offensive
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.34 2018/12/12 18:08:43 tg Exp $");
d110 1
a110 1
int wr_rdbuf(char *, int);
@


1.34
log
@merge the npax branch into MAIN

asides from a missing dprintf and portability, this ought to be
good enough for people (well me) to play with for now
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.13 2018/12/12 16:24:27 tg Exp $");
d67 1
a67 1
extern int force_one_volume;
d79 1
a79 1
extern int ar_do_keepopen;
d228 2
a229 2
extern FSUB fsub[];
extern const int ford[];
d231 1
a231 1
extern int to_stdout;
d255 29
a283 29
extern int act;
extern FSUB *frmt;
extern int cflag;
extern int cwdfd;
extern int dflag;
extern int iflag;
extern int kflag;
extern int lflag;
extern int nflag;
extern int tflag;
extern int uflag;
extern int Vflag;
extern int vflag;
extern int Dflag;
extern int Hflag;
extern int Lflag;
extern int Xflag;
extern int Yflag;
extern int Zflag;
extern int zeroflag;
extern int vfpart;
extern int patime;
extern int pmtime;
extern int nodirs;
extern int pmode;
extern int pids;
extern int rmleadslash;
extern int exit_val;
extern int docrc;
d291 1
a291 1
extern int havechd;
d339 1
a339 1
extern int tar_nodir;
d346 1
d348 3
@


1.33
log
@slowmerge (untested though)
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.58 2017/09/12 17:11:11 otto Exp $	*/
a40 3
#ifndef MIRCPIO_EXTERN_H
#define MIRCPIO_EXTERN_H "$MirOS: src/bin/pax/extern.h,v 1.32 2018/12/12 00:09:27 tg Exp $"

d45 3
d49 1
d55 1
a55 1
int uar_id(char *, int) __attribute__((__noreturn__));
d60 1
a60 1
int uar_trail(ARCHD *, char *, int, int *) __attribute__((__noreturn__));
d69 1
a69 1
void ar_close(void);
d120 1
d124 1
d127 1
d130 4
d136 1
d139 8
a176 1
extern char *gnu_name_string, *gnu_link_string;
d185 2
a186 2
void set_ftime(char *, time_t, time_t, int, int);
int set_ids(char *, uid_t, gid_t);
a187 1
int set_lids(char *, uid_t, gid_t);
d190 3
a192 2
int set_attr(const struct file_times *, int _force_times, mode_t, int _do_mode,
    int _in_sig);
d211 1
a211 1
void ls_list(ARCHD *, time_t, FILE *);
d216 2
a217 2
ot_type asc_ot(char *, int, int);
int ot_asc(ot_type, char *, int, int);
d230 2
d237 1
d286 1
d288 1
d292 3
d325 1
a325 1
void add_atdir(char *, dev_t, ino_t, time_t, time_t);
d330 2
a331 2
void proc_dir(void);
u_int st_hash(const char *, int, int);
d341 1
a341 1
extern char *gnu_hack_string;
d362 2
a363 1
    __attribute__((__format__(__printf__, 1, 2)));
d365 1
d367 2
a368 1
    __attribute__((__format__(__printf__, 2, 3)));
d370 2
a371 15
    __attribute__((__format__(__printf__, 3, 4)));

/*
 * portability glue
 */
#ifndef HAVE_STRLCPY
size_t strlcat(char *, const char *, size_t);
size_t strlcpy(char *, const char *, size_t);
#endif

#ifndef HAVE_STRMODE
void strmode(mode_t, char *);
#endif

#endif
@


1.32
log
@merge patches from Debian 1:20171021-3 upload
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.34 +1.51 +1.52 +1.54 2010/12/02 04:08:27 tedu Exp $	*/
d42 1
a42 1
#define MIRCPIO_EXTERN_H "$MirOS: src/bin/pax/extern.h,v 1.30 2016/10/25 18:57:54 tg Exp $"
d295 1
a295 1
void sub_name(char *, int *, size_t);
@


1.31
log
@fixup after the import, also clears up lies in the manpage
@
text
@d5 1
a5 1
 * Copyright © 2013, 2015, 2016
d169 1
a169 1
void set_ftime(char *fnm, time_t mtime, time_t atime, int frc);
d173 1
a173 1
void set_pmode(char *, mode_t);
@


1.30
log
@fastmerge
@
text
@d42 1
a42 1
#define MIRCPIO_EXTERN_H "$MirOS: src/bin/pax/extern.h,v 1.29 2016/03/12 13:20:47 tg Exp $"
d213 1
a213 1
extern int ford[];
d314 1
d316 1
@


1.29
log
@drop support for bcpio and (old)tar on the floppy
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.34 2010/12/02 04:08:27 tedu Exp $	*/
d42 1
a42 1
#define MIRCPIO_EXTERN_H "$MirOS: src/bin/pax/extern.h,v 1.28 2016/03/06 14:12:27 tg Exp $"
a271 2
int main(int, char **);

d314 1
@


1.28
log
@version the *.h files as idstrings, too
@
text
@d42 1
a42 1
#define MIRCPIO_EXTERN_H "$MirOS$"
d219 1
a219 1
char *chdname;
@


1.27
log
@merge CVE fixes from openbsd branch
@
text
@a0 1
/**	$MirOS: src/bin/pax/extern.h,v 1.25 2013/10/31 20:05:40 tg Exp $ */
d41 3
d355 2
@


1.26
log
@end this nonsense locally, until the next obsd import
@
text
@d6 1
a6 1
 * Copyright © 2013, 2015
d173 2
d229 1
d289 4
d302 1
a302 1
int get_atdir(dev_t, ino_t, time_t *, time_t *);
d305 1
@


1.25
log
@adapt most __attribute__((…)) occurrences to new KNF style(9)
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.24 2012/06/05 19:09:41 tg Exp $ */
d6 2
a7 2
 * Copyright © 2013
 *	Thorsten “mirabilos” Glaser <tg@@mirbsd.org>
a260 1
extern char *ltmfrmt;
@


1.24
log
@change tty_read(buf,sz) to buf=tty_rd() in callers so fdgetline() conversion makes sense
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.23 2012/06/05 18:52:15 tg Exp $ */
d6 2
d328 1
a328 1
    __attribute__((__format__ (__printf__, 1, 2)));
d331 1
a331 1
    __attribute__((__format__ (__printf__, 2, 3)));
d333 1
a333 1
    __attribute__((__format__ (__printf__, 3, 4)));
@


1.23
log
@• add a fdgetline() helper function to prepare to get rid off stdio
  almost entirely (save {,v}asprintf and fprintf(stderr, …) calls)
• just use UNIX I/O in tty_subs
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.22 2012/06/05 18:13:49 tg Exp $ */
d327 1
a327 1
int tty_read(char *, int);
@


1.22
log
@hook symlinked-into-here portability code as glue
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.21 2012/05/20 17:21:44 tg Exp $ */
d322 2
@


1.21
log
@implement archive format auto-guessing – inspired by http://petereisentraut.blogspot.de/2012/05/time-to-retrain-fingers.html – with silent failback to no compressor; uses lzma only when writing .tlz and lzop transparently
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.20 2012/05/20 16:13:17 tg Exp $ */
d332 1
a332 1
 * part of the OS
d334 1
a334 1
#ifdef USE_LIBBSD
d338 4
@


1.20
log
@get rid of extern.h including other headers
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.19 2012/02/16 17:27:31 tg Exp $ */
d212 1
@


1.19
log
@clean up some ugliness
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.18 2012/02/16 17:11:45 tg Exp $ */
a43 4
#include <sys/cdefs.h>
#if defined(__GLIBC__)
#include <time.h>
#endif
@


1.18
log
@Debian GNU/kFreeBSD can be more difficult to deal with than GNU/Hurd at times.

• switch from quad_t to using unsigned long / unsigned long long
• sanitise use of off_t-relevant types
• cast when printing off_t; use a once-defined type and format specifier
• convert “This define is important” into actual compile-time assertion
• simplify ifdef mess by always defining off_t specific routines
  instead of reusing those for long if off_t is just long
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.17 2012/02/16 16:01:08 tg Exp $ */
d65 1
a65 1
extern const char *gzip_program;
@


1.17
log
@implement the GNU cpio option -V (print a dot per file processed)
sponsored by tarent solutions GmbH for work on evolvis (FusionForge)
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.16 2012/02/12 00:27:15 tg Exp $ */
a48 1

d198 2
a199 4
#ifndef LONG_OFF_T
u_quad_t asc_uqd(char *, int, int);
int uqd_asc(u_quad_t, char *, int, int);
#endif
@


1.16
log
@merge OpenBSD
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.15 2011/08/16 21:32:47 tg Exp $ */
d246 1
@


1.15
log
@backend for Unix Archiver libraries – ar(5) and deb(5) format files
(since GNU binutils on ELF systems thinks SYSV style ar is used…)
@
text
@d1 2
a2 2
/**	$MirOS: src/bin/pax/extern.h,v 1.14 2011/08/16 13:57:14 tg Exp $ */
/*	$OpenBSD: extern.h,v 1.32 2006/11/17 08:38:04 otto Exp $	*/
d187 1
@


1.14
log
@portability overhaul
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.13 2011/08/16 13:50:17 tg Exp $ */
d51 12
d79 2
d117 1
d141 2
a142 2
int cpio_stwr(void);
int dist_stwr(void);
d149 3
a151 3
int crc_stwr(void);
int v4root_stwr(void);
int v4norm_stwr(void);
d318 1
a318 1
int ustar_stwr(void);
@


1.13
log
@use underscores with __attribute__s
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.12 2009/10/04 14:51:06 tg Exp $ */
a48 6
#if !defined(__INTERIX) && !defined(__APPLE__)
#define HAS_TAPE	1
#else
#define HAS_TAPE	0
#endif

d319 8
@


1.12
log
@exclude tape support on Mac OSX too, not just Interix,
because it got removed in Snow Leopard
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.11 2008/10/29 17:34:48 tg Exp $ */
d319 1
a319 1
    __attribute__((format (printf, 1, 2)));
d322 1
a322 1
    __attribute__((format (printf, 2, 3)));
d324 1
a324 1
    __attribute__((format (printf, 3, 4)));
@


1.11
log
@add code to work around broken archives such as the CPIO archive inside
Fedora Core 4 glibc-common-2.3.6-3.i386.rpm which carry the actual data
of hardlinks not in the first but a later (here, the last) occurence of
the file in question: iff hardlinking succeeds (no cross-device!), size
of the linked files is 0, size of the archive member is greater than 0,
we are extracting, but not to stdout, proceed writing out the data.
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.10 2007/10/23 20:07:42 tg Exp $ */
d49 7
@


1.10
log
@merge openbsd changes and fix tar -R, -S flag misdocumentation
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.9 2007/02/17 04:52:40 tg Exp $ */
d148 1
a148 1
int lnk_creat(ARCHD *);
@


1.9
log
@__CRAZY clean
@
text
@d1 2
a2 2
/**	$MirOS: src/bin/pax/extern.h,v 1.8 2007/02/17 04:16:09 tg Exp $ */
/*	$OpenBSD: extern.h,v 1.31 2005/04/28 06:58:07 otto Exp $	*/
d252 1
@


1.8
log
@make fset_ftime() static to file_subs.c as it's not used in
any other places; give it its own conditional, do not just
nullify it on Interix
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.7 2006/07/16 17:56:29 tg Exp $ */
d111 4
a114 4
char * name_uid(uid_t, int);
char * name_gid(gid_t, int);
int uid_name(char *, uid_t *);
int gid_name(char *, gid_t *);
d248 1
a248 1
extern char *argv0;
a253 1
void sig_cleanup(int);
d285 1
a285 1
u_int st_hash(char *, int, int);
d310 2
a311 1
void tty_prnt(const char *, ...);
d313 4
a316 2
void paxwarn(int, const char *, ...);
void syswarn(int, int, const char *, ...);
@


1.7
log
@glibc requires <time.h> in addition to <sys/time.h>
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.6 2006/06/19 19:22:08 tg Exp $ */
a154 1
void fset_ftime(char *fnm, int, time_t mtime, time_t atime, int frc);
@


1.6
log
@move the anonarch commons into options.c and options.h
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.5 2005/12/30 14:19:15 tg Exp $ */
d45 3
@


1.5
log
@found while fixing: limit not to 0x000F but to ANON_MAXVAL;
actually use the value found
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.4 2005/12/17 07:12:06 tg Exp $ */
a200 8
#define	ANON_INODES	0x0001
#define	ANON_HARDLINKS	0x0002
#define	ANON_MTIME	0x0004
#define	ANON_UIDGID	0x0008
#define	ANON_VERBOSE	0x0010
#define	ANON_DEBUG	0x0020
#define	ANON_MAXVAL	0x003F
extern int anonarch;
@


1.4
log
@Once upon a time, we had two new formats.
Then, a third one.

Now, we've got the -M option with which you can set all these
anonymisation, normalisation etc. options bitwise.
We also have two new bits:
 - verbose, which tells you what anon options are used
 - debug, which traces files as their headers are stored

That all of course documented in the manual page.
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.3 2005/11/23 23:27:10 tg Exp $ */
d207 1
@


1.3
log
@* cpio.1, pax.1: document new format "dist"
* cpio.c: implement new format "dist"
* cpio.c: trailer doesn't need an inode in any case
* cpio.h: sync comments between CPIO and VCPIO structs
* extern.h, options.c: add glue for new format "dist"
@
text
@d1 1
a1 1
/**	$MirOS: src/bin/pax/extern.h,v 1.2 2005/11/16 13:58:39 tg Exp $ */
d201 7
@


1.2
log
@* cpio.1: Document sv4crc format for creation and extraction
* cpio.1, pax.1: Document new v4norm and v4root formats for creation only
  (to extract these, the sv4crc driver is being used)
* cpio.c: Add initialisation routines for v4norm and v4root formats
* cpio.c (vcpio_wr): Write c_ino, c_uid, c_gid and c_mtime through a
  layer of indirection, depending on the state of (v4norm) setting them
  to the stat buf value, zero (uid, gid, mtime) or the result of a table
  lookup (inode)
* extern.h: expose new v4norm_stwr, v4root_stwr (cpio.c) and
  flnk_start, chk_flnk (table.c) functions
* options.c: add entries for new formats v4norm, v4root
* tables.c: mirror lnk_start, chk_lnk functions to build up a hard link
  table on archive creation as well, anonymising _all_ inodes stored

(inodes start at 3)
@
text
@d1 1
a1 1
/**	$MirOS$ */
d123 1
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
/*	$OpenBSD: extern.h,v 1.28 2004/03/30 16:14:22 millert Exp $	*/
d130 2
d151 1
d153 1
d156 1
d183 1
d281 1
a281 1
void add_dir(char *, int, struct stat *, int);
d284 2
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@improve my Frankenstein OS (*wink* you know who you are) further
sans wchar_t of course

this is the essence of reading >1200 commit messages which suck
due to not having the new format of ours...
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.31 2005/04/28 06:58:07 otto Exp $	*/
a147 1
void fset_ftime(char *fnm, int, time_t mtime, time_t atime, int frc);
a148 1
int fset_ids(char *, int, uid_t, gid_t);
a150 1
void fset_pmode(char *, int, mode_t);
a176 1
size_t fieldcpy(char *, size_t, const char *, size_t);
d274 1
a274 1
void add_dir(char *, struct stat *, int);
@


1.1.1.3
log
@import latest OpenCPIO ☺
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.32 2006/11/17 08:38:04 otto Exp $	*/
a245 1
extern int havechd;
@


1.1.1.4
log
@import up-to-date pax from OpenBSD 5.1-current
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.34 2010/12/02 04:08:27 tedu Exp $	*/
a164 1
void ftree_skipped_newer(ARCHD *);
a226 1
extern int Nflag;
@


1.1.1.5
log
@pull newer paxtar from OpenBSD
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.54 2016/01/01 15:56:03 tedu Exp $	*/
d43 2
d52 1
a52 1
void ar_close(int _in_sig);
d138 1
d147 2
a148 4
void set_ftime(const char *, const struct timespec *,
    const struct timespec *, int);
void fset_ftime(const char *, int, const struct timespec *,
    const struct timespec *, int);
d151 1
a153 2
int set_attr(const struct file_times *, int _force_times, mode_t, int _do_mode,
    int _in_sig);
d177 1
d180 1
d197 1
a197 1
extern char *chdname;
a208 1
int has_dotdot(const char *);
d243 1
a245 1
extern int listfd;
d250 1
a269 4
int sltab_start(void);
int sltab_add_sym(const char *_path, const char *_value, mode_t _mode);
int sltab_add_link(const char *, const struct stat *);
void sltab_process(int _in_sig);
a272 1
#ifndef NOCPIO
a275 5
#else
# define dev_start()	0
# define add_dev(x)	0
# define map_dev(x,y,z)	0
#endif /* NOCPIO */
d278 2
a279 3
void add_atdir(char *, dev_t, ino_t, const struct timespec *,
    const struct timespec *);
int do_atdir(const char *, dev_t, ino_t);
d282 2
a283 3
void delete_dir(dev_t, ino_t);
void proc_dir(int _in_sig);
u_int st_hash(const char *, int, int);
d288 1
a288 2
extern int tar_nodir;
extern char *gnu_name_string, *gnu_link_string;
d306 1
a306 2
void tty_prnt(const char *, ...)
    __attribute__((nonnull(1), format(printf, 1, 2)));
d308 2
a309 4
void paxwarn(int, const char *, ...)
    __attribute__((nonnull(2), format(printf, 2, 3)));
void syswarn(int, int, const char *, ...)
    __attribute__((nonnull(3), format(printf, 3, 4)));
@


1.1.1.6
log
@revert the import; we’ll just backport the CVE fixes, for now ☹
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.34 2010/12/02 04:08:27 tedu Exp $	*/
a42 2
#include <sys/cdefs.h>

d50 1
a50 1
void ar_close(void);
a135 1
extern char *gnu_name_string, *gnu_link_string;
d144 4
a147 2
void set_ftime(char *fnm, time_t mtime, time_t atime, int frc);
void fset_ftime(char *fnm, int, time_t mtime, time_t atime, int frc);
a149 1
int set_lids(char *, uid_t, gid_t);
d152 2
a176 1
#ifndef LONG_OFF_T
a178 1
#endif
d195 1
a195 1
char *chdname;
d207 1
a241 1
extern char *ltmfrmt;
d244 1
a248 1
int main(int, char **);
d268 4
d275 1
d279 5
d286 3
a288 2
void add_atdir(char *, dev_t, ino_t, time_t, time_t);
int get_atdir(dev_t, ino_t, time_t *, time_t *);
d291 3
a293 2
void proc_dir(void);
u_int st_hash(char *, int, int);
d298 2
a299 1
extern char *gnu_hack_string;
d317 2
a318 1
void tty_prnt(const char *, ...);
d320 4
a323 2
void paxwarn(int, const char *, ...);
void syswarn(int, int, const char *, ...);
@


1.1.1.7
log
@backport OpenBSD pax erratum, more specifically:

• directory bug, symlinks with -C bug
• escaping with .. and symlinks
• tar without -P
• validate directories touched in the cleanup phase
@
text
@a153 2
int set_attr(const struct file_times *, int _force_times, mode_t, int _do_mode,
    int _in_sig);
a208 1
int has_dotdot(const char *);
a269 4
int sltab_start(void);
int sltab_add_sym(const char *_path, const char *_value, mode_t _mode);
int sltab_add_link(const char *, const struct stat *);
void sltab_process(int _in_sig);
d279 1
a279 1
int do_atdir(const char *, dev_t, ino_t);
a281 1
void delete_dir(dev_t, ino_t);
@


1.1.1.8
log
@bunch of cherry-picks from OpenBSD
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.34 +1.51 +1.52 +1.54 2010/12/02 04:08:27 tedu Exp $	*/
d199 1
a199 1
extern char *chdname;
d253 1
a295 1
extern int tar_nodir;
@


1.1.1.9
log
@merge what OpenBSD did between our last cherry-pick and today minus one commit

(“Use the new libc uid_from_user() and gid_from_group() instead of
  the pax-specific functions in cache.c” is ignored, for now)
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.58 2017/09/12 17:11:11 otto Exp $	*/
d278 1
a278 1
void sub_name(char *, int *, int);
@


1.1.1.10
log
@Import latest OpenBSD paxtar, unmodified, into vendor branch
@
text
@d1 1
a1 1
/*	$OpenBSD: extern.h,v 1.59 2018/09/13 12:33:43 millert Exp $	*/
d43 2
d52 1
a52 1
void ar_close(int _in_sig);
d101 12
d138 1
d147 2
a148 4
void set_ftime(const char *, const struct timespec *,
    const struct timespec *, int);
void fset_ftime(const char *, int, const struct timespec *,
    const struct timespec *, int);
d151 1
d179 4
a182 2
unsigned long long asc_ull(char *, int, int);
int ull_asc(unsigned long long, char *, int, int);
d246 1
a247 1
extern enum op_mode { OP_PAX, OP_TAR, OP_CPIO } op_mode;
a248 1
extern int listfd;
a278 1
#ifndef NOCPIO
a281 5
#else
# define dev_start()	0
# define add_dev(x)	0
# define map_dev(x,y,z)	0
#endif /* NOCPIO */
d284 1
a284 2
void add_atdir(char *, dev_t, ino_t, const struct timespec *,
    const struct timespec *);
d289 2
a290 2
void proc_dir(int _in_sig);
u_int st_hash(const char *, int, int);
d296 1
a296 1
extern char *gnu_name_string, *gnu_link_string;
d304 2
d314 1
a314 2
void tty_prnt(const char *, ...)
    __attribute__((nonnull(1), format(printf, 1, 2)));
d316 2
a317 4
void paxwarn(int, const char *, ...)
    __attribute__((nonnull(2), format(printf, 2, 3)));
void syswarn(int, int, const char *, ...)
    __attribute__((nonnull(3), format(printf, 3, 4)));
@


1.1.1.10.2.1
log
@Wrangle the OpenBSD branch into shape as starting point:

• Revert “Use the new libc uid_from_user() and gid_from_group()
  instead of the pax-specific functions in cache.c” (revisit later)
• fix MAX_TIME_T (plain wrong), mirtoconf later
• drop all NOCPIO
• Revert “Replace name_{uid,gid}() with the libc routines
  user_from_uid() and group_from_gid()”
@
text
@a98 12
 * cache.c
 */
int uidtb_start(void);
int gidtb_start(void);
int usrtb_start(void);
int grptb_start(void);
char *name_uid(uid_t, int);
char *name_gid(gid_t, int);
int uid_name(char *, uid_t *);
int gid_name(char *, gid_t *);

/*
d264 1
d268 5
a295 2
int ustar_strd(void);
int ustar_stwr(void);
@


1.1.1.10.2.2
log
@extremely rudimentary conversion to mirtoconf, doesn’t even build yet
@
text
@a42 4
#ifdef EXTERN
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/mksh/sh.h,v 1.868 2018/12/04 21:13:47 tg Exp $");
#endif

d288 1
a288 1
unsigned int st_hash(const char *, int, int);
@


1.1.1.10.2.3
log
@do extern.h, but we’ll have to do something about time values
@
text
@a4 2
 * Copyright © 2013, 2015, 2016, 2018
 *	mirabilos <m@@mirbsd.org>
d44 1
a44 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.2 2018/12/12 03:13:31 tg Exp $");
a47 12
 * ar.c
 */
int uar_stwr(int);
int uar_ismagic(char *);
int uar_id(char *, int) MKSH_A_NORETURN;
int uar_rd(ARCHD *, char *);
int uar_wr(ARCHD *);
int uar_wr_data(ARCHD *, int, off_t *);
off_t uar_endrd(void);
int uar_trail(ARCHD *, char *, int, int *) MKSH_A_NORETURN;

/*
d51 1
a51 1
extern const char *compress_program;
a63 2
extern int ar_do_keepopen;
int ar_next_keepopen(void);
a99 1
int buf_fill_internal(int);
d109 4
a112 4
const char *name_uid(uid_t, int);
const char *name_gid(gid_t, int);
int uid_name(const char *, uid_t *);
int gid_name(const char *, gid_t *);
d123 1
a123 2
int cpio_stwr(int);
int dist_stwr(int);
d130 1
a130 3
int crc_stwr(int);
int v4root_stwr(int);
int v4norm_stwr(int);
d142 1
a142 1
int lnk_creat(ARCHD *, int *);
a147 1
/*XXX TODO: const struct timespec → time expression */
d149 1
a149 1
    const struct timespec *, int, int);
d154 1
a154 2
int set_lids(char *, uid_t, gid_t);
void set_pmode(char *, mode_t, int);
d169 1
a169 1
void ftree_skipped_newer(void);
d194 1
a194 1
extern const int ford[];
a198 1
void guess_compress_program(int);
a226 1
extern int Vflag;
d246 1
a246 1
extern const char *argv0;
a284 1
/*XXX TODO: time value */
a292 2
int flnk_start(void);
int chk_flnk(ARCHD *);
a296 1
#ifndef SMALL
a297 1
#endif
d307 1
a307 1
int ustar_stwr(int);
a314 2
extern char fdgetline_err;
char *fdgetline(int);
d317 2
a318 3
    MKSH_A_NONNULL(1)
    MKSH_A_FORMAT(__printf__, 1, 2);
char *tty_rd(void);
d320 1
a320 2
    MKSH_A_NONNULL(2)
    MKSH_A_FORMAT(__printf__, 2, 3);
d322 1
a322 2
    MKSH_A_NONNULL(3)
    MKSH_A_FORMAT(__printf__, 3, 4);
@


1.1.1.10.2.4
log
@solve one of the two API issues
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.3 2018/12/12 06:25:15 tg Exp $");
d309 3
a311 1
void add_atdir(const char *, const struct stat *);
@


1.1.1.10.2.5
log
@and the other half, modulo what’ll be yet merged anyway
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.4 2018/12/12 06:57:43 tg Exp $");
d168 5
a172 2
void set_ftime(const char *, const struct stat *, int, int);
void fset_ftime(const char *, int, const struct stat *, int);
@


1.1.1.10.2.6
log
@ugly ifdeffing for portability FTW
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.5 2018/12/12 07:03:47 tg Exp $");
d169 1
@


1.1.1.10.2.7
log
@fclownat vs lchown
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.6 2018/12/12 07:47:48 tg Exp $");
d169 1
a169 1
int set_ids(char *, uid_t, gid_t, int);
d171 1
@


1.1.1.10.2.8
log
@merge ‘g’ and switch to a global “now”
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.7 2018/12/12 08:32:29 tg Exp $");
d193 1
a193 1
void ls_list(ARCHD *, FILE *);
a271 1
extern time_t now;
@


1.1.1.10.2.9
log
@this would be most of the ‘o’s (some more strtonum for later)
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.8 2018/12/12 09:08:56 tg Exp $");
a211 2
extern int anonarch;
extern int to_stdout;
a216 1
void anonarch_init(void);
d250 1
@


1.1.1.10.2.10
log
@some more tweaks
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.9 2018/12/12 10:24:14 tg Exp $");
d173 2
a174 3
struct file_times; /* avoid pulling time.h globally */
int set_attr(const struct file_times *, int _force_times, mode_t,
    int _do_mode, int _in_sig);
@


1.1.1.10.2.11
log
@revisit all those initial reverts
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.10 2018/12/12 10:41:25 tg Exp $");
a118 1
#if !HAVE_UGID_FROM_UG
a121 1
#if !HAVE_UG_FROM_UGID
a123 1
#endif
a125 4
#if HAVE_UG_FROM_UGID
#define name_uid(u, frc) ((const char *)user_from_uid((u), !(frc)))
#define name_gid(g, frc) ((const char *)group_from_gid((g), !(frc)))
#else
a127 1
#endif
a129 8
int uid_uncached(const char *, uid_t *);
int gid_uncached(const char *, gid_t *);
#else
#define uid_name uid_from_user
#define gid_name gid_from_group
#define uid_uncached uid_from_user
#define gid_uncached gid_from_group
#endif
@


1.1.1.10.2.12
log
@unwarn more
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.11 2018/12/12 15:33:05 tg Exp $");
a48 1
#ifndef PAX_JUST_THE_WARNINGS
a363 1
#endif
@


1.1.1.10.2.13
log
@various bugfixes and a system header issue workaround in Makefile
@
text
@d46 1
a46 1
__IDSTRING(rcsid_extern_h, "$MirOS: src/bin/pax/extern.h,v 1.1.1.10.2.12 2018/12/12 15:38:31 tg Exp $");
d294 1
a294 1
void sig_cleanup(int) MKSH_A_NORETURN;
@


