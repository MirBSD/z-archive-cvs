head	1.27;
access;
symbols
	npax:1.1.1.4.0.2
	cvs-20181212:1.1.1.4
	paxmirabilis-20171021:1.20
	paxmirabilis-20161104:1.20
	paxmirabilis-20161031:1.20
	paxmirabilis-20161025:1.20
	paxmirabilis-20160306:1.18
	cvs-201603041945:1.1.1.2
	paxmirabilis-20151013:1.16
	paxmirabilis-20140703:1.16
	paxmirabilis-20120606:1.11
	paxmirabilis-20120605:1.11
	cvs-201206051745:1.1.1.1
	paxmirabilis-20120520:1.9
	paxmirabilis-20120216:1.9
	paxmirabilis-20120212:1.7
	cvs-201202112230:1.1.1.1
	paxmirabilis-20110817:1.7
	MIRBSD_10:1.4.0.2
	MIRBSD_10_BASE:1.4
	cvs-200710231945:1.1.1.1
	cvs-200606232242:1.1.1.1
	MIRBSD_9_BASE:1.2
	MIRBSD_8:1.2.0.2
	MIRBSD_8_BASE:1.2
	cvs-200507211800:1.1.1.1
	cvs-200504291700:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.27
date	2019.08.25.23.06.40;	author tg;	state Exp;
branches;
next	1.26;
commitid	1005D631480152ED348;

1.26
date	2019.02.23.22.23.29;	author tg;	state Exp;
branches;
next	1.25;
commitid	1005C71C7FC6E80448B;

1.25
date	2019.02.10.21.56.04;	author tg;	state Exp;
branches;
next	1.24;
commitid	1005C609E0F54EC13D0;

1.24
date	2018.12.13.17.46.54;	author tg;	state Exp;
branches;
next	1.23;
commitid	1005C129B225C2D0BDC;

1.23
date	2018.12.13.07.09.08;	author tg;	state Exp;
branches;
next	1.22;
commitid	1005C1205A44B32AFA4;

1.22
date	2018.12.12.18.08.40;	author tg;	state Exp;
branches;
next	1.21;
commitid	1005C114EA81986F5EC;

1.21
date	2018.12.12.00.09.27;	author tg;	state Exp;
branches;
next	1.20;
commitid	1005C1051C27816C858;

1.20
date	2016.10.25.19.00.26;	author tg;	state Exp;
branches;
next	1.19;
commitid	100580FABDA6C691A00;

1.19
date	2016.03.12.20.53.11;	author tg;	state Exp;
branches;
next	1.18;
commitid	10056E481C030395179;

1.18
date	2016.03.06.14.59.08;	author tg;	state Exp;
branches;
next	1.17;
commitid	10056DC45D014C845B2;

1.17
date	2016.03.03.23.51.32;	author tg;	state Exp;
branches;
next	1.16;
commitid	10056D8CDDB557933AC;

1.16
date	2013.07.09.18.48.11;	author tg;	state Exp;
branches;
next	1.15;
commitid	10051DC5B0326139BCF;

1.15
date	2012.11.26.16.39.45;	author tg;	state Exp;
branches;
next	1.14;
commitid	10050B39B68766C9680;

1.14
date	2012.10.14.16.24.18;	author tg;	state Exp;
branches;
next	1.13;
commitid	100507AE74B5A5694DD;

1.13
date	2012.10.14.16.22.49;	author tg;	state Exp;
branches;
next	1.12;
commitid	100507AE6F17C8A5E8E;

1.12
date	2012.10.14.14.51.09;	author tg;	state Exp;
branches;
next	1.11;
commitid	100507AD16A30C7442C;

1.11
date	2012.06.05.18.15.58;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004FCE4CF50152FFC2;

1.10
date	2012.06.05.18.13.49;	author tg;	state Exp;
branches;
next	1.9;
commitid	1004FCE4C7439736DC4;

1.9
date	2012.02.16.17.48.06;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004F3D41610777EBB2;

1.8
date	2012.02.16.17.11.44;	author tg;	state Exp;
branches;
next	1.7;
commitid	1004F3D38626EFD0781;

1.7
date	2011.08.16.21.32.45;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004E4AE1EF00AF3003;

1.6
date	2008.05.07.13.50.21;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004821B3A342AA83EE;

1.5
date	2008.03.27.19.05.11;	author tg;	state Exp;
branches;
next	1.4;
commitid	10047EBEE7D110FDF6B;

1.4
date	2006.08.18.18.21.36;	author tg;	state Exp;
branches;
next	1.3;
commitid	10044E605445178AFD0;

1.3
date	2006.07.16.17.55.17;	author tg;	state Exp;
branches;
next	1.2;
commitid	10044BA7D99093CFC29;

1.2
date	2005.04.13.20.11.23;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.22.06;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.22.06;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2016.03.04.19.46.08;	author tg;	state Exp;
branches;
next	1.1.1.3;
commitid	10056D9E61429EE6550;

1.1.1.3
date	2016.03.04.20.54.57;	author tg;	state Exp;
branches;
next	1.1.1.4;
commitid	10056D9F62E152ECBA5;

1.1.1.4
date	2018.12.12.00.24.22;	author tg;	state Exp;
branches
	1.1.1.4.2.1;
next	;
commitid	1005C1055452C78F9E4;

1.1.1.4.2.1
date	2018.12.12.00.52.57;	author tg;	state Exp;
branches;
next	1.1.1.4.2.2;
commitid	1005C105BC86262A0B7;

1.1.1.4.2.2
date	2018.12.12.16.12.17;	author tg;	state Exp;
branches;
next	1.1.1.4.2.3;
commitid	1005C1133723FCCBD80;

1.1.1.4.2.3
date	2018.12.12.16.24.26;	author tg;	state Exp;
branches;
next	;
commitid	1005C11364A797CBA33;


desc
@@


1.27
log
@support contemporary MirBSD having just added this to libc

(but not bumped the POSuX version supported)
@
text
@# $MirOS: src/bin/pax/Makefile,v 1.25 2019/02/10 21:56:04 tg Exp $
#-
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
#		2011, 2012, 2013, 2014, 2015, 2016, 2017, 2019
#	mirabilos <m@@mirbsd.org>
# Copyright (c) 2018
#	mirabilos <t.glaser@@tarent.de>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# MirMakefile explicitly as part of MirBSD base; use Build.sh if you
# wish to build paxmirabilis (MirCPIO) on anything else, these days.

.include <bsd.own.mk>

SRCDIR=		${.CURDIR}

PROG=		pax
SRCS=		ar.c ar_io.c ar_subs.c buf_subs.c compat.c cpio.c \
		file_subs.c ftree.c gen_subs.c getoldopt.c options.c \
		pat_rep.c pax.c sel_subs.c tables.c tar.c tty_subs.c
SRCS+=		cache.c
MAN=		cpio.1 pax.1 tar.1
LINKS+=		${BINDIR}/pax ${BINDIR}/cpio
LINKS+=		${BINDIR}/pax ${BINDIR}/tar
.if !make(test-build)
CPPFLAGS+=	-D_ALL_SOURCE \
		-DHAVE_ATTRIBUTE_BOUNDED=1 -DHAVE_ATTRIBUTE_FORMAT=1 \
		-DHAVE_ATTRIBUTE_NONNULL=1 -DHAVE_ATTRIBUTE_NORETURN=1 \
		-DHAVE_ATTRIBUTE_PURE=1 -DHAVE_ATTRIBUTE_UNUSED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_TIME_H=1 -DHAVE_TIME_H=1 \
		-DHAVE_BOTH_TIME_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MTIO_H=1 \
		-DHAVE_SYS_RESOURCE_H=1 -DHAVE_SYS_SYSMACROS_H=0 \
		-DHAVE_GRP_H=1 -DHAVE_PATHS_H=1 -DHAVE_STDINT_H=1 \
		-DHAVE_STRINGS_H=1 -DHAVE_UTIME_H=1 -DHAVE_UTMP_H=1 \
		-DHAVE_UTMPX_H=0 -DHAVE_VIS_H=1 -DHAVE_CAN_INTTYPES=1 \
		-DHAVE_CAN_UCBINTS=1 -DHAVE_CAN_INT16TYPE=1 \
		-DHAVE_CAN_UCBINT16=1 -DHAVE_CAN_ULONG=1 -DHAVE_DPRINTF=0 \
		-DHAVE_FCHMODAT=0 -DHAVE_FCHOWNAT=0 -DHAVE_FUTIMENS=0 \
		-DHAVE_FUTIMES=1 -DHAVE_LCHMOD=1 -DHAVE_LCHOWN=1 \
		-DHAVE_LINKAT=0 -DHAVE_PLEDGE=0 -DHAVE_REALLOCARRAY=1 \
		-DHAVE_SETPGENT=1 -DHAVE_STRLCPY=1 -DHAVE_STRMODE=1 \
		-DHAVE_STRTONUM=1 -DHAVE_UG_FROM_UGID=1 -DHAVE_UGID_FROM_UG=0 \
		-DHAVE_UTIMENSAT=0 -DHAVE_UTIMES=1 -DHAVE_OFFT_LONG=0 \
		-DHAVE_TIMET_LONG=0 -DHAVE_TIMET_LARGE=1 -DHAVE_ST_MTIM=0 \
		-DHAVE_ST_MTIMENSEC=1
#XXX TODO: sparc has a non-large time_t
CPPFLAGS+=	-I.
COPTS+=		-Wall
.endif
COPTS+=		-std=c89 -U__STRICT_ANSI__
# for MirBSD only, for a while
CPPFLAGS+=	-DREALPATH_CAN_ALLOCATE=2

SAFE_PATH=	/bin:/usr/bin:/usr/mpkg/bin:/usr/local/bin
CPPFLAGS+=	-DPAX_SAFE_PATH=\"${SAFE_PATH:Q}\"

TEST_BUILD_ENV:=	TARGET_OS= CPP=

test-build: .PHONY
	-rm -rf build-dir
	mkdir -p build-dir
	cd build-dir; env CC=${CC:Q} CFLAGS=${CFLAGS:M*:Q} \
	    CPPFLAGS=${CPPFLAGS:M*:Q} LDFLAGS=${LDFLAGS:M*:Q} \
	    LIBS= NOWARN=-Wno-error ${TEST_BUILD_ENV} /bin/sh \
	    ${SRCDIR}/Build.sh -Q -r

cleandir: clean-extra

clean-extra: .PHONY
	-rm -rf build-dir

CLEANFILES+=	${MANALL:S/.cat/.ps/} ${MAN:S/$/.pdf/} ${MANALL:S/$/.gz/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.htm.gz/}
CLEANFILES+=	${MAN:S/$/.txt/} ${MAN:S/$/.txt.gz/}

.include <bsd.prog.mk>

CLEANFILES+=	cpio tar
all: cpio tar

cpio:
	ln -sf ${PROG} cpio

tar:
	ln -sf ${PROG} tar

.ifmake cats
V_GROFF!=	pkg_info -e 'groff-*'
V_GHOSTSCRIPT!=	pkg_info -e 'ghostscript-*'
.  if empty(V_GROFF) || empty(V_GHOSTSCRIPT)
.    error empty V_GROFF=${V_GROFF} or V_GHOSTSCRIPT=${V_GHOSTSCRIPT}
.  endif
.endif

CATS_KW=	cpio, pax, tar
CATS_TITLE_cpio_1=paxcpio - copy file archives in and out
CATS_TITLE_pax_1=pax - read and write file archives and copy directory hierarchies
CATS_TITLE_tar_1=paxtar - Unix tape archiver
cats: ${MANALL} ${MANALL:S/.cat/.ps/}
.if "${MANALL:Ncpio.cat1:Npax.cat1:Ntar.cat1}" != ""
.  error Adjust here.
.endif
.for _m _n in cpio 1 pax 1 tar 1
	x=$$(ident ${SRCDIR:Q}/${_m}.${_n} | \
	    awk '/Mir''OS:/ { print $$4$$5; }' | \
	    tr -dc 0-9); (( $${#x} == 14 )) || exit 1; exec \
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -p pa4 -c \
	    -o ${_m}.${_n}.pdf '[' /Author '(The MirOS Project)' \
	    /Title '('${CATS_TITLE_${_m}_${_n}:Q}')' \
	    /Subject '(BSD Reference Manual)' /ModDate "(D:$$x)" \
	    /Creator '(GNU groff version ${V_GROFF:S/groff-//} \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript ${V_GHOSTSCRIPT:S/ghostscript-//:S/-artifex//} \(MirPorts\))' \
	    /Keywords '('${CATS_KW:Q}')' /DOCINFO pdfmark \
	    -f ${_m}.ps${_n}
.endfor
	set -e; . ${BSDSRCDIR:Q}/scripts/roff2htm; set_target_absolute; \
	    for m in ${MANALL}; do \
		bn=$${m%.*}; ext=$${m##*.cat}; \
		[[ $$bn != $$m ]]; [[ $$ext != $$m ]]; \
		gzip -n9 <"$$m" >"$$m.gz"; \
		col -bx <"$$m" >"$$bn.$$ext.txt"; \
		rm -f "$$bn.$$ext.txt.gz"; gzip -n9 "$$bn.$$ext.txt"; \
		do_conversion_verbose "$$bn" "$$ext" "$$m" "$$bn.$$ext.htm"; \
		rm -f "$$bn.$$ext.htm.gz"; gzip -n9 "$$bn.$$ext.htm"; \
	done
@


1.26
log
@ease debugging
@
text
@d4 1
a4 1
#		2011, 2012, 2013, 2014, 2015, 2016, 2017
d65 2
@


1.25
log
@refresh
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.22 2018/12/12 18:08:40 tg Exp $
d90 9
@


1.24
log
@missed installing the hardlinks to the binary
@
text
@d57 4
a60 2
		-DHAVE_UTIMENSAT=0 -DHAVE_UTIMES=1 -DHAVE_OFFT_LLONG=1 \
		-DHAVE_TIMET_LLONG=1 -DHAVE_ST_MTIM=0 -DHAVE_ST_MTIMENSEC=1
@


1.23
log
@fixing and string pooling and int shortening offensive
@
text
@d37 2
@


1.22
log
@merge the npax branch into MAIN

asides from a missing dprintf and portability, this ought to be
good enough for people (well me) to play with for now
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.1.1.4.2.3 2018/12/12 16:24:26 tg Exp $
d58 1
a58 1
COPTS+=		-std=c89 -U__STRICT_ANSI__ -Wall
d60 1
@


1.21
log
@merge patches from Debian 1:20171021-3 upload
@
text
@d1 1
a1 2
# $MirOS: src/bin/pax/Makefile,v 1.19 2016/03/12 20:53:11 tg Exp $
# $OpenBSD: Makefile,v 1.10 2001/05/26 00:32:20 millert Exp $
d3 5
a7 2
# It may be necessary to define some options on pre-4.4BSD or
# other operating systems:
d9 21
a29 2
# -DLONG_OFF_T	The base type of off_t is a long, not a long long.
#		This is often defined in: /usr/include/sys/types.h
d31 44
a74 15
PROG=   pax
SRCS=	ar.c ar_io.c ar_subs.c buf_subs.c cache.c cpio.c file_subs.c ftree.c \
	gen_subs.c getoldopt.c options.c pat_rep.c pax.c sel_subs.c tables.c \
	tar.c tty_subs.c
MAN=	cpio.1 pax.1 tar.1
LINKS+=	${BINDIR}/pax ${BINDIR}/cpio
LINKS+=	${BINDIR}/pax ${BINDIR}/tar

SAFE_PATH=/bin:/usr/bin:/usr/mpkg/bin:/usr/local/bin
CPPFLAGS+= -DPAX_SAFE_PATH=\"${SAFE_PATH}\"

.if (${MACHINE_OS} == "Interix") || (${MACHINE_OS} == "Linux") || \
    ((${MACHINE_OS} == "GNU") && (${OSNAME} != "GNU/kFreeBSD"))
CPPFLAGS+= -DLONG_OFF_T
.endif
d76 2
a77 5
.if (${MACHINE_OS} == "GNU") || (${MACHINE_OS} == "Linux")
CPPFLAGS+= -DHAVE_FCHMODAT # probably
CPPFLAGS+= -DHAVE_LINKAT # probably
CPPFLAGS+= -DHAVE_SYS_SYSMACROS_H # probably
.endif
d79 3
a81 5
.if (${MACHINE_OS} == "BSD")
CPPFLAGS+= -DHAVE_STRLCPY
CPPFLAGS+= -DHAVE_STRMODE
CPPFLAGS+= -DHAVE_VIS
.endif
a92 3
CLEANFILES+=	${MANALL:S/.cat/.ps/} ${MAN:S/$/.pdf/} ${MANALL:S/$/.gz/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.htm.gz/}
CLEANFILES+=	${MAN:S/$/.txt/} ${MAN:S/$/.txt.gz/}
d102 2
a103 2
	x=$$(ident ${.CURDIR:Q}/${_m}.${_n} | \
	    awk '/MirOS:/ { print $$4$$5; }' | \
a123 10

# NetBSD®
NOMANDOC=	Yes
# OpenBSD
.if defined(MANLINT) && !empty(MANLINT)
all: use_nroff_instead
use_nroff_instead:
	@@echo 'Install GNU groff or AT&T nroff to format *roff manpages!'
	@@exit 1
.endif
@


1.20
log
@make compressor path a Makefile variable, for portability
@
text
@d27 1
@


1.19
log
@SpanKY (gentoo-dev) requests <sys/sysmacros.h>
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.15 2012/11/26 16:39:45 tg Exp $
d18 3
@


1.18
log
@stub out another linkat(2)
@
text
@d25 1
@


1.17
log
@render PDF manpages in PA4 paper size ipv DIN ISO A4 paper size
@
text
@d23 4
@


1.16
log
@some Hanfout prevention
@
text
@d54 1
a54 1
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -c \
@


1.15
log
@make cats more flexible
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.14 2012/10/14 16:24:18 tg Exp $
d73 10
@


1.14
log
@sort
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.13 2012/10/14 16:22:49 tg Exp $
d31 8
d42 4
d50 2
a51 23
	x=$$(ident ${.CURDIR:Q}/cpio.1 | \
	    awk '/MirOS:/ { print $$4$$5; }' | \
	    tr -dc 0-9); (( $${#x} == 14 )) || exit 1; exec \
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -c \
	    -o cpio.1.pdf '[' /Author '(The MirOS Project)' \
	    /Title '(paxcpio - copy file archives in and out)' \
	    /Subject '(BSD Reference Manual)' /ModDate "(D:$$x)" \
	    /Creator '(GNU groff version 1.19.2-3 \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript 8.54-3 \(MirPorts\))' \
	    /Keywords '(cpio, pax, tar)' /DOCINFO pdfmark \
	    -f cpio.ps1
	x=$$(ident ${.CURDIR:Q}/pax.1 | \
	    awk '/MirOS:/ { print $$4$$5; }' | \
	    tr -dc 0-9); (( $${#x} == 14 )) || exit 1; exec \
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -c \
	    -o pax.1.pdf '[' /Author '(The MirOS Project)' \
	    /Title '(pax - read and write file archives and copy directory hierarchies)' \
	    /Subject '(BSD Reference Manual)' /ModDate "(D:$$x)" \
	    /Creator '(GNU groff version 1.19.2-3 \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript 8.54-3 \(MirPorts\))' \
	    /Keywords '(cpio, pax, tar)' /DOCINFO pdfmark \
	    -f pax.ps1
	x=$$(ident ${.CURDIR:Q}/tar.1 | \
d55 2
a56 2
	    -o tar.1.pdf '[' /Author '(The MirOS Project)' \
	    /Title '(paxtar - Unix tape archiver)' \
d58 5
a62 4
	    /Creator '(GNU groff version 1.19.2-3 \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript 8.54-3 \(MirPorts\))' \
	    /Keywords '(cpio, pax, tar)' /DOCINFO pdfmark \
	    -f tar.ps1
@


1.13
log
@gzip the catmanpage, the text page and the HTML page
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.12 2012/10/14 14:51:09 tg Exp $
d14 3
a16 3
MAN=	pax.1 tar.1 cpio.1
LINKS=	${BINDIR}/pax ${BINDIR}/tar \
	${BINDIR}/pax ${BINDIR}/cpio
@


1.12
log
@add code to preformat manpages, for lesser OSes such as NetBSD®
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.11 2012/06/05 18:15:58 tg Exp $
d31 2
a32 2
CLEANFILES+=	${MANALL:S/.cat/.ps/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.pdf/}
d75 1
d79 1
@


1.11
log
@HAVE_VIS, too
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.10 2012/06/05 18:13:49 tg Exp $
d30 49
@


1.10
log
@hook symlinked-into-here portability code as glue
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.9 2012/02/16 17:48:06 tg Exp $
d26 1
@


1.9
log
@distinguish between GNU/Linux and GNU/Hurd vs. GNU/kFreeBSD
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.8 2012/02/16 17:11:44 tg Exp $
d23 5
@


1.8
log
@Debian GNU/kFreeBSD can be more difficult to deal with than GNU/Hurd at times.

• switch from quad_t to using unsigned long / unsigned long long
• sanitise use of off_t-relevant types
• cast when printing off_t; use a once-defined type and format specifier
• convert “This define is important” into actual compile-time assertion
• simplify ifdef mess by always defining off_t specific routines
  instead of reusing those for long if off_t is just long
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.7 2011/08/16 21:32:45 tg Exp $
d18 2
a19 1
.if (${MACHINE_OS} == "Interix") || (${MACHINE_OS} == "Linux") || (${MACHINE_OS} == "GNU")
@


1.7
log
@backend for Unix Archiver libraries – ar(5) and deb(5) format files
(since GNU binutils on ELF systems thinks SYSV style ar is used…)
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.6 2008/05/07 13:50:21 tg Exp $
d3 3
a5 10

# To install on versions prior to BSD 4.4 the following may have to be
# defined with CFLAGS +=
#
# -DLONG_OFF_T	Define this if the base type of an off_t is a long (and is
#		NOT a quad).  (This is often defined in the file
#		/usr/include/sys/types.h).
# 		This define is important, as if you do have a quad_t
# 		off_t and define LONG_OFF_T, pax will compile but will
# 		NOT RUN PROPERLY.
d7 2
@


1.6
log
@prepare for new MACHINE_OS type "GNU"
will be explained in the commit introducing it
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.5 2008/03/27 19:05:11 tg Exp $
d16 2
a17 2
SRCS=	ar_io.c ar_subs.c buf_subs.c cache.c cpio.c file_subs.c ftree.c\
	gen_subs.c getoldopt.c options.c pat_rep.c pax.c sel_subs.c tables.c\
@


1.5
log
@• move all the formerly statically linked binaries to /usr/d{,s}bin/ and
  link them dynamically, except…
  ‣ init(8) since it’s used for system startup (chflags(8) comes to mind)
  ‣ shutdown(8) since it’s 4550 root:operator, which would be hard to do
    in a non-exploitable way otherwise
  ‣ test(1), domainname(1), dhclient-script, since they are shell scripts
  ‣ ldconfig(8) to prevent shooting into ourselves’ feet
• add the build of two crunchgen(1)d binaries, dbins and dbinsuid, collec-
  ting the stuff formerly statically built (dbins is 0555 root:bin, while
  dbinsuid is 4555 root:bin – {ping,traceroute}{,6} only)
• some cosmetical et al. changes to the Makefiles involved
  ‣ spacing, shell
  ‣ utf-8
  ‣ use ${CONFGRP}
• CFLAGS+=-DNFS -I… → CPPFLAGS+=… *sigh*

This enables us to make most out of ports/sysutils/fakeroot

agreed bsiegert@@
“fakeroot ist cool” Jonathan Schleifer
idea from and “:-)” Han Boetes
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.4 2006/08/18 18:21:36 tg Exp $
d23 1
a23 1
.if (${MACHINE_OS} == "Interix") || (${MACHINE_OS} == "Linux")
@


1.4
log
@MACHINE_OS not OStype
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.3 2006/07/16 17:55:17 tg Exp $
d20 2
a21 1
LINKS=	${BINDIR}/pax ${BINDIR}/tar ${BINDIR}/pax ${BINDIR}/cpio
@


1.3
log
@certain things (glibc) are as limited as Interix
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.2 2005/04/13 20:11:23 tg Exp $
d22 1
a22 1
.if (${OStype} == "Interix") || (${OStype} == "Linux")
@


1.2
log
@portability fix: long = off_t
XXX does this mean interix is worse than Linux wrt large files?
@
text
@d1 1
a1 1
# $MirOS$
d22 1
a22 1
.if ${OStype} == "Interix"
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile,v 1.10 2001/05/26 00:32:20 millert Exp $
d22 4
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@pull newer paxtar from OpenBSD
@
text
@d1 12
a12 1
#	$OpenBSD: Makefile,v 1.11 2014/01/08 04:58:36 guenther Exp $
@


1.1.1.3
log
@revert the import; we’ll just backport the CVE fixes, for now ☹
@
text
@d1 1
a1 12
#	$OpenBSD: Makefile,v 1.10 2001/05/26 00:32:20 millert Exp $

# To install on versions prior to BSD 4.4 the following may have to be
# defined with CFLAGS +=
#
# -DLONG_OFF_T	Define this if the base type of an off_t is a long (and is
#		NOT a quad).  (This is often defined in the file
#		/usr/include/sys/types.h).
# 		This define is important, as if you do have a quad_t
# 		off_t and define LONG_OFF_T, pax will compile but will
# 		NOT RUN PROPERLY.
#
@


1.1.1.4
log
@Import latest OpenBSD paxtar, unmodified, into vendor branch
@
text
@d1 12
a12 1
#	$OpenBSD: Makefile,v 1.13 2018/09/13 12:33:43 millert Exp $
a13 1
WARNINGS=Yes
d15 1
a15 1
SRCS=	ar_io.c ar_subs.c buf_subs.c cpio.c file_subs.c ftree.c\
@


1.1.1.4.2.1
log
@Wrangle the OpenBSD branch into shape as starting point:

• Revert “Use the new libc uid_from_user() and gid_from_group()
  instead of the pax-specific functions in cache.c” (revisit later)
• fix MAX_TIME_T (plain wrong), mirtoconf later
• drop all NOCPIO
• Revert “Replace name_{uid,gid}() with the libc routines
  user_from_uid() and group_from_gid()”
@
text
@d5 1
a5 1
SRCS=	ar_io.c ar_subs.c buf_subs.c cache.c cpio.c file_subs.c ftree.c\
@


1.1.1.4.2.2
log
@rudimentary new Makefile for in-tree based on mksh’s, generated
@
text
@d1 1
a1 25
# $MirOS: src/bin/mksh/Makefile,v 1.163 2018/01/13 21:38:08 tg Exp $
#-
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
#		2011, 2012, 2013, 2014, 2015, 2016, 2017
#	mirabilos <m@@mirbsd.org>
# Copyright (c) 2018
#	mirabilos <t.glaser@@tarent.de>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# MirMakefile explicitly as part of MirBSD base; use Build.sh if you
# wish to build paxmirabilis (MirCPIO) on anything else, these days.
d3 7
a9 55
.include <bsd.own.mk>

SRCDIR=		${.CURDIR}

PROG=		pax
SRCS=		ar.c ar_io.c ar_subs.c buf_subs.c compat.c cpio.c \
		file_subs.c ftree.c gen_subs.c getoldopt.c options.c \
		pat_rep.c pax.c sel_subs.c tables.c tar.c tty_subs.c
SRCS+=		cache.c
MAN=		cpio.1 pax.1 tar.1
.if !make(test-build)
CPPFLAGS+=	\
		-DHAVE_ATTRIBUTE_BOUNDED=1 -DHAVE_ATTRIBUTE_FORMAT=1 \
		-DHAVE_ATTRIBUTE_NONNULL=1 -DHAVE_ATTRIBUTE_NORETURN=1 \
		-DHAVE_ATTRIBUTE_PURE=1 -DHAVE_ATTRIBUTE_UNUSED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_TIME_H=1 -DHAVE_TIME_H=1 \
		-DHAVE_BOTH_TIME_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MTIO_H=1 \
		-DHAVE_SYS_RESOURCE_H=1 -DHAVE_SYS_SYSMACROS_H=0 \
		-DHAVE_GRP_H=1 -DHAVE_PATHS_H=1 -DHAVE_STDINT_H=1 \
		-DHAVE_STRINGS_H=1 -DHAVE_UTIME_H=1 -DHAVE_UTMP_H=1 \
		-DHAVE_UTMPX_H=0 -DHAVE_VIS_H=1 -DHAVE_CAN_INTTYPES=1 \
		-DHAVE_CAN_UCBINTS=1 -DHAVE_CAN_INT16TYPE=1 \
		-DHAVE_CAN_UCBINT16=1 -DHAVE_CAN_ULONG=1 -DHAVE_DPRINTF=0 \
		-DHAVE_FCHMODAT=0 -DHAVE_FCHOWNAT=0 -DHAVE_FUTIMENS=0 \
		-DHAVE_FUTIMES=0 -DHAVE_LCHMOD=1 -DHAVE_LCHOWN=1 \
		-DHAVE_LINKAT=0 -DHAVE_PLEDGE=0 -DHAVE_REALLOCARRAY=1 \
		-DHAVE_SETPGENT=1 -DHAVE_STRLCPY=1 -DHAVE_STRMODE=1 \
		-DHAVE_STRTONUM=1 -DHAVE_UG_FROM_UGID=1 -DHAVE_UGID_FROM_UG=0 \
		-DHAVE_UTIMENSAT=0 -DHAVE_UTIMES=1 -DHAVE_TIMET_LLONG=1 \
		-DHAVE_ST_MTIM=0 -DHAVE_ST_MTIMENSEC=1
CPPFLAGS+=	-I.
COPTS+=		-std=c89 -Wall
.endif

SAFE_PATH=	/bin:/usr/bin:/usr/mpkg/bin:/usr/local/bin
CPPFLAGS+=	-DPAX_SAFE_PATH=\"${SAFE_PATH:Q}\"

TEST_BUILD_ENV:=	TARGET_OS= CPP=

test-build: .PHONY
	-rm -rf build-dir
	mkdir -p build-dir
	cd build-dir; env CC=${CC:Q} CFLAGS=${CFLAGS:M*:Q} \
	    CPPFLAGS=${CPPFLAGS:M*:Q} LDFLAGS=${LDFLAGS:M*:Q} \
	    LIBS= NOWARN=-Wno-error ${TEST_BUILD_ENV} /bin/sh \
	    ${SRCDIR}/Build.sh -Q -r

cleandir: clean-extra

clean-extra: .PHONY
	-rm -rf build-dir

CLEANFILES+=	${MANALL:S/.cat/.ps/} ${MAN:S/$/.pdf/} ${MANALL:S/$/.gz/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.htm.gz/}
CLEANFILES+=	${MAN:S/$/.txt/} ${MAN:S/$/.txt.gz/}
a11 40

.ifmake cats
V_GROFF!=	pkg_info -e 'groff-*'
V_GHOSTSCRIPT!=	pkg_info -e 'ghostscript-*'
.  if empty(V_GROFF) || empty(V_GHOSTSCRIPT)
.    error empty V_GROFF=${V_GROFF} or V_GHOSTSCRIPT=${V_GHOSTSCRIPT}
.  endif
.endif

CATS_KW=	cpio, pax, tar
CATS_TITLE_cpio_1=paxcpio - copy file archives in and out
CATS_TITLE_pax_1=pax - read and write file archives and copy directory hierarchies
CATS_TITLE_tar_1=paxtar - Unix tape archiver
cats: ${MANALL} ${MANALL:S/.cat/.ps/}
.if "${MANALL:Ncpio.cat1:Npax.cat1:Ntar.cat1}" != ""
.  error Adjust here.
.endif
.for _m _n in cpio 1 pax 1 tar 1
	x=$$(ident ${SRCDIR:Q}/${_m}.${_n} | \
	    awk '/Mir''OS:/ { print $$4$$5; }' | \
	    tr -dc 0-9); (( $${#x} == 14 )) || exit 1; exec \
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -p pa4 -c \
	    -o ${_m}.${_n}.pdf '[' /Author '(The MirOS Project)' \
	    /Title '('${CATS_TITLE_${_m}_${_n}:Q}')' \
	    /Subject '(BSD Reference Manual)' /ModDate "(D:$$x)" \
	    /Creator '(GNU groff version ${V_GROFF:S/groff-//} \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript ${V_GHOSTSCRIPT:S/ghostscript-//:S/-artifex//} \(MirPorts\))' \
	    /Keywords '('${CATS_KW:Q}')' /DOCINFO pdfmark \
	    -f ${_m}.ps${_n}
.endfor
	set -e; . ${BSDSRCDIR:Q}/scripts/roff2htm; set_target_absolute; \
	    for m in ${MANALL}; do \
		bn=$${m%.*}; ext=$${m##*.cat}; \
		[[ $$bn != $$m ]]; [[ $$ext != $$m ]]; \
		gzip -n9 <"$$m" >"$$m.gz"; \
		col -bx <"$$m" >"$$bn.$$ext.txt"; \
		rm -f "$$bn.$$ext.txt.gz"; gzip -n9 "$$bn.$$ext.txt"; \
		do_conversion_verbose "$$bn" "$$ext" "$$m" "$$bn.$$ext.htm"; \
		rm -f "$$bn.$$ext.htm.gz"; gzip -n9 "$$bn.$$ext.htm"; \
	done
@


1.1.1.4.2.3
log
@various bugfixes and a system header issue workaround in Makefile
@
text
@d1 1
a1 1
# $MirOS: src/bin/pax/Makefile,v 1.1.1.4.2.2 2018/12/12 16:12:17 tg Exp $
d38 1
a38 1
CPPFLAGS+=	-D_ALL_SOURCE \
d51 1
a51 1
		-DHAVE_FUTIMES=1 -DHAVE_LCHMOD=1 -DHAVE_LCHOWN=1 \
d55 2
a56 2
		-DHAVE_UTIMENSAT=0 -DHAVE_UTIMES=1 -DHAVE_OFFT_LLONG=1 \
		-DHAVE_TIMET_LLONG=1 -DHAVE_ST_MTIM=0 -DHAVE_ST_MTIMENSEC=1
d58 1
a58 1
COPTS+=		-std=c89 -U__STRICT_ANSI__ -Wall
@


