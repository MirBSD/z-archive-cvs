head	1.165;
access;
symbols
	tg-multikey-bind:1.99.0.2
	tg-wcswidth-behaviour:1.78.0.4
	tg-nameref:1.78.0.2
	tg-mksh-printf-builtin:1.75.0.2
	tg-aalloc-experimental_BASE:1.70.2.1
	tg-aalloc-experimental:1.70.0.2
	MIRBSD_10:1.54.0.2
	MIRBSD_10_BASE:1.54
	tg-mksh-plan9ape_BASE:1.12
	tg-mksh-plan9ape:1.11.0.2
	MIRBSD_9_BASE:1.9
	MIRBSD_8:1.8.0.2
	MIRBSD_8_BASE:1.8
	mksh-R22:1.3
	mksh-R21:1.3;
locks; strict;
comment	@# @;


1.165
date	2019.12.29.23.40.40;	author tg;	state Exp;
branches;
next	1.164;
commitid	1005E09394D04739973;

1.164
date	2019.03.01.16.18.14;	author tg;	state Exp;
branches;
next	1.163;
commitid	1005C795B5E18CB9829;

1.163
date	2018.01.13.21.38.08;	author tg;	state Exp;
branches;
next	1.162;
commitid	1005A5A7C0944B414C1;

1.162
date	2017.08.29.13.38.29;	author tg;	state Exp;
branches;
next	1.161;
commitid	10059A56E5C5EA2D5AB;

1.161
date	2017.08.07.21.39.25;	author tg;	state Exp;
branches;
next	1.160;
commitid	1005988DE2644315248;

1.160
date	2017.04.28.11.13.45;	author tg;	state Exp;
branches;
next	1.159;
commitid	100590323E86CD0E167;

1.159
date	2017.04.28.00.33.15;	author tg;	state Exp;
branches;
next	1.158;
commitid	10059028DE5082E07FC;

1.158
date	2017.04.12.18.33.23;	author tg;	state Exp;
branches;
next	1.157;
commitid	10058EE730B10091C4D;

1.157
date	2017.04.06.01.46.42;	author tg;	state Exp;
branches;
next	1.156;
commitid	10058E59E197FE50EC2;

1.156
date	2017.04.02.14.14.04;	author tg;	state Exp;
branches;
next	1.155;
commitid	10058E106EA70D8ABF7;

1.155
date	2016.11.12.00.20.37;	author tg;	state Exp;
branches;
next	1.154;
commitid	1005826606C15850C5A;

1.154
date	2016.11.11.23.31.30;	author tg;	state Exp;
branches;
next	1.153;
commitid	100582654B972655F84;

1.153
date	2016.11.07.16.58.45;	author tg;	state Exp;
branches;
next	1.152;
commitid	1005820B2DD17077C51;

1.152
date	2016.08.25.16.21.30;	author tg;	state Exp;
branches;
next	1.151;
commitid	10057BF1B1D101BE102;

1.151
date	2016.08.10.18.20.17;	author tg;	state Exp;
branches;
next	1.150;
commitid	10057AB70790ACA1487;

1.150
date	2016.07.25.21.05.19;	author tg;	state Exp;
branches;
next	1.149;
commitid	10057967F184AB0E82A;

1.149
date	2016.07.25.00.04.37;	author tg;	state Exp;
branches;
next	1.148;
commitid	1005795579F14A3FE5C;

1.148
date	2016.03.04.18.28.40;	author tg;	state Exp;
branches;
next	1.147;
commitid	10056D9D3E84E42085B;

1.147
date	2016.03.03.23.51.31;	author tg;	state Exp;
branches;
next	1.146;
commitid	10056D8CDDB557933AC;

1.146
date	2016.01.21.18.24.34;	author tg;	state Exp;
branches;
next	1.145;
commitid	10056A12268001BF859;

1.145
date	2015.12.12.22.25.11;	author tg;	state Exp;
branches;
next	1.144;
commitid	100566C9EDD3DC6C239;

1.144
date	2015.10.05.17.58.56;	author tg;	state Exp;
branches;
next	1.143;
commitid	1005612BA62412FC278;

1.143
date	2015.09.05.19.19.00;	author tg;	state Exp;
branches;
next	1.142;
commitid	10055EB402C54C3076B;

1.142
date	2015.07.09.20.52.36;	author tg;	state Exp;
branches;
next	1.141;
commitid	100559EDF161DEE9DD2;

1.141
date	2015.04.11.23.28.17;	author tg;	state Exp;
branches;
next	1.140;
commitid	1005529AD8D33CF99B9;

1.140
date	2015.03.20.23.37.17;	author tg;	state Exp;
branches;
next	1.139;
commitid	100550CAF453A2DE382;

1.139
date	2014.11.25.21.13.19;	author tg;	state Exp;
branches;
next	1.138;
commitid	1005474F00E09321C83;

1.138
date	2014.10.07.15.22.13;	author tg;	state Exp;
branches;
next	1.137;
commitid	1005434053135366996;

1.137
date	2014.10.03.17.32.08;	author tg;	state Exp;
branches;
next	1.136;
commitid	100542EDD596FD5FBF9;

1.136
date	2014.09.03.19.22.48;	author tg;	state Exp;
branches;
next	1.135;
commitid	10054076A8136C0C0D1;

1.135
date	2014.06.24.20.47.42;	author tg;	state Exp;
branches;
next	1.134;
commitid	10053A9E3FD4EC55000;

1.134
date	2014.06.09.13.25.50;	author tg;	state Exp;
branches;
next	1.133;
commitid	1005395B5803902C8E9;

1.133
date	2014.05.27.13.22.42;	author tg;	state Exp;
branches;
next	1.132;
commitid	1005384911C31753F0C;

1.132
date	2014.02.09.22.49.29;	author tg;	state Exp;
branches;
next	1.131;
commitid	10052F806114B993C09;

1.131
date	2014.01.05.21.57.22;	author tg;	state Exp;
branches;
next	1.130;
commitid	10052C9D445413B34DF;

1.130
date	2013.11.30.17.41.32;	author tg;	state Exp;
branches;
next	1.129;
commitid	100529A23520014334E;

1.129
date	2013.11.30.15.42.19;	author tg;	state Exp;
branches;
next	1.128;
commitid	100529A075F29C695AE;

1.128
date	2013.11.20.21.14.50;	author tg;	state Exp;
branches;
next	1.127;
commitid	100528D26524CF1F1DE;

1.127
date	2013.11.17.22.21.17;	author tg;	state Exp;
branches;
next	1.126;
commitid	100528941705C91094F;

1.126
date	2013.09.10.17.32.57;	author tg;	state Exp;
branches;
next	1.125;
commitid	100522F57C13E265FDE;

1.125
date	2013.08.23.14.07.33;	author tg;	state Exp;
branches;
next	1.124;
commitid	10052176CB912FE954B;

1.124
date	2013.08.10.13.44.26;	author tg;	state Exp;
branches;
next	1.123;
commitid	100520643B4127D9BCA;

1.123
date	2013.07.21.18.47.15;	author tg;	state Exp;
branches;
next	1.122;
commitid	10051EC2CBD68BDF6A5;

1.122
date	2013.05.31.23.27.13;	author tg;	state Exp;
branches;
next	1.121;
commitid	10051A931CB73794C1D;

1.121
date	2013.05.02.21.59.45;	author tg;	state Exp;
branches;
next	1.120;
commitid	1005182E1E55272FF6B;

1.120
date	2013.04.27.18.50.21;	author tg;	state Exp;
branches;
next	1.119;
commitid	100517C1D840086DC8F;

1.119
date	2013.04.27.18.22.47;	author tg;	state Exp;
branches;
next	1.118;
commitid	100517C178064640B91;

1.118
date	2013.04.27.18.12.37;	author tg;	state Exp;
branches;
next	1.117;
commitid	100517C152C6C287552;

1.117
date	2013.04.26.21.22.40;	author tg;	state Exp;
branches;
next	1.116;
commitid	100517AEF6C22DD1AE7;

1.116
date	2013.04.26.19.40.09;	author tg;	state Exp;
branches;
next	1.115;
commitid	100517AD81849062C68;

1.115
date	2013.03.24.00.56.19;	author tg;	state Exp;
branches;
next	1.114;
commitid	100514E4F1D5C90862C;

1.114
date	2013.03.05.15.41.40;	author tg;	state Exp;
branches;
next	1.113;
commitid	1005136124A171442C9;

1.113
date	2013.02.23.20.03.27;	author tg;	state Exp;
branches;
next	1.112;
commitid	1005129208E57646522;

1.112
date	2013.02.18.22.55.37;	author tg;	state Exp;
branches;
next	1.111;
commitid	1005122B16E6B48945B;

1.111
date	2013.02.17.05.40.12;	author tg;	state Exp;
branches;
next	1.110;
commitid	10051206D50560C037D;

1.110
date	2013.02.16.00.21.56;	author tg;	state Exp;
branches;
next	1.109;
commitid	100511ED11C146CFC01;

1.109
date	2012.12.17.23.46.31;	author tg;	state Exp;
branches;
next	1.108;
commitid	10050CFAEEB2D5D31EB;

1.108
date	2012.12.17.23.37.44;	author tg;	state Exp;
branches;
next	1.107;
commitid	10050CFACCB511261BB;

1.107
date	2012.11.30.20.49.17;	author tg;	state Exp;
branches;
next	1.106;
commitid	10050B91BDD34E31558;

1.106
date	2012.11.26.16.39.43;	author tg;	state Exp;
branches;
next	1.105;
commitid	10050B39B68766C9680;

1.105
date	2012.11.20.18.50.42;	author tg;	state Exp;
branches;
next	1.104;
commitid	10050ABD11751603401;

1.104
date	2012.10.21.17.16.44;	author tg;	state Exp;
branches;
next	1.103;
commitid	10050842E15653ECAC0;

1.103
date	2012.10.14.16.22.49;	author tg;	state Exp;
branches;
next	1.102;
commitid	100507AE6F17C8A5E8E;

1.102
date	2012.10.14.14.51.08;	author tg;	state Exp;
branches;
next	1.101;
commitid	100507AD16A30C7442C;

1.101
date	2012.07.01.15.54.36;	author tg;	state Exp;
branches;
next	1.100;
commitid	1004FF072D535165399;

1.100
date	2012.06.28.20.17.34;	author tg;	state Exp;
branches;
next	1.99;
commitid	1004FECBBF10FC5C93C;

1.99
date	2012.05.04.22.44.31;	author tg;	state Exp;
branches;
next	1.98;
commitid	1004FA45BE357DA71DC;

1.98
date	2012.04.14.16.07.44;	author tg;	state Exp;
branches;
next	1.97;
commitid	1004F89A0D311D70891;

1.97
date	2012.04.07.11.19.46;	author tg;	state Exp;
branches;
next	1.96;
commitid	1004F8022E670BC1C0E;

1.96
date	2012.03.27.23.13.41;	author tg;	state Exp;
branches;
next	1.95;
commitid	1004F7249BA2221FCA0;

1.95
date	2012.03.27.22.36.49;	author tg;	state Exp;
branches;
next	1.94;
commitid	1004F7240673EAD3A5A;

1.94
date	2012.03.27.21.23.51;	author tg;	state Exp;
branches;
next	1.93;
commitid	1004F722FB133BECAE5;

1.93
date	2012.03.23.19.38.11;	author tg;	state Exp;
branches;
next	1.92;
commitid	1004F6CD13A7403AC2D;

1.92
date	2011.12.31.02.04.17;	author tg;	state Exp;
branches;
next	1.91;
commitid	1004EFE6D783E94B328;

1.91
date	2011.12.08.22.19.16;	author tg;	state Exp;
branches;
next	1.90;
commitid	1004EE137FB02A31BBD;

1.90
date	2011.11.26.00.45.17;	author tg;	state Exp;
branches;
next	1.89;
commitid	1004ED036B353923A89;

1.89
date	2011.11.25.23.29.30;	author tg;	state Exp;
branches;
next	1.88;
commitid	1004ED0249F2884E13A;

1.88
date	2011.10.07.19.51.17;	author tg;	state Exp;
branches;
next	1.87;
commitid	1004E8F584D6869C0B2;

1.87
date	2011.04.09.18.47.12;	author tg;	state Exp;
branches;
next	1.86;
commitid	1004DA0A9C665117993;

1.86
date	2011.02.11.01.18.14;	author tg;	state Exp;
branches;
next	1.85;
commitid	1004D548C4E66D17A12;

1.85
date	2011.01.30.02.28.31;	author tg;	state Exp;
branches;
next	1.84;
commitid	1004D44CCE6262193E2;

1.84
date	2011.01.29.19.07.16;	author tg;	state Exp;
branches;
next	1.83;
commitid	1004D44657A0535F27E;

1.83
date	2010.10.08.17.56.56;	author tg;	state Exp;
branches;
next	1.82;
commitid	1004CAF5B5A6D74E1C9;

1.82
date	2010.09.14.21.26.05;	author tg;	state Exp;
branches;
next	1.81;
commitid	1004C8FE654576B0E25;

1.81
date	2010.08.24.15.19.53;	author tg;	state Exp;
branches;
next	1.80;
commitid	1004C73E31577F0CD63;

1.80
date	2010.07.04.17.41.39;	author tg;	state Exp;
branches;
next	1.79;
commitid	1004C30C7E926089493;

1.79
date	2009.12.12.22.27.03;	author tg;	state Exp;
branches;
next	1.78;
commitid	1004B2418AF282F4231;

1.78
date	2009.08.27.16.52.12;	author tg;	state Exp;
branches;
next	1.77;
commitid	1004A96B9CD5362B588;

1.77
date	2009.07.30.19.18.06;	author tg;	state Stab;
branches;
next	1.76;
commitid	1004A71F2011F781F3D;

1.76
date	2009.07.30.19.11.09;	author tg;	state Exp;
branches;
next	1.75;
commitid	1004A71F04C54EFD9CF;

1.75
date	2009.06.08.20.34.38;	author tg;	state Stab;
branches
	1.75.2.1;
next	1.74;
commitid	1004A2D75D22EFFE1BD;

1.74
date	2009.05.16.16.59.31;	author tg;	state Stab;
branches;
next	1.73;
commitid	1004A0EF0664EF4168D;

1.73
date	2009.04.03.09.39.03;	author tg;	state Exp;
branches;
next	1.72;
commitid	10049D5D94A2E5145F0;

1.72
date	2009.03.22.16.55.37;	author tg;	state Exp;
branches;
next	1.71;
commitid	10049C66D5D5A75A28F;

1.71
date	2008.12.13.17.02.10;	author tg;	state Exp;
branches;
next	1.70;
commitid	1004943EAA830C0300B;

1.70
date	2008.11.17.01.14.57;	author tg;	state Exp;
branches
	1.70.2.1;
next	1.69;
commitid	1004920C58E7143C915;

1.69
date	2008.11.15.11.42.18;	author tg;	state Exp;
branches;
next	1.68;
commitid	100491EB5952D30F89E;

1.68
date	2008.11.12.07.38.42;	author tg;	state Exp;
branches;
next	1.67;
commitid	100491A87F01EA17C13;

1.67
date	2008.11.12.07.36.18;	author tg;	state Exp;
branches;
next	1.66;
commitid	100491A872A75670F3C;

1.66
date	2008.11.12.04.59.42;	author tg;	state Exp;
branches;
next	1.65;
commitid	100491A62CC18906809;

1.65
date	2008.11.02.22.42.37;	author tg;	state Exp;
branches;
next	1.64;
commitid	100490E2CEC2E888B81;

1.64
date	2008.10.28.14.32.37;	author tg;	state Exp;
branches;
next	1.63;
commitid	1004907226D3DEFCCD1;

1.63
date	2008.10.26.22.03.05;	author tg;	state Exp;
branches;
next	1.62;
commitid	1004904E922178B75F0;

1.62
date	2008.10.05.16.26.13;	author tg;	state Exp;
branches;
next	1.61;
commitid	10048E8EA7D6EAD401E;

1.61
date	2008.08.02.17.40.37;	author tg;	state Exp;
branches;
next	1.60;
commitid	10048949C246574D5F3;

1.60
date	2008.06.21.19.20.15;	author tg;	state Exp;
branches;
next	1.59;
commitid	100485D546D2A4FC22F;

1.59
date	2008.05.17.18.27.54;	author tg;	state Exp;
branches;
next	1.58;
commitid	100482F238341D5E08C;

1.58
date	2008.05.04.01.51.29;	author tg;	state Exp;
branches;
next	1.57;
commitid	100481D16AF3E4A7EEA;

1.57
date	2008.04.20.02.15.12;	author tg;	state Exp;
branches;
next	1.56;
commitid	100480AA7400A110D7D;

1.56
date	2008.03.27.22.44.17;	author tg;	state Exp;
branches;
next	1.55;
commitid	10047EC2345229AB68B;

1.55
date	2008.03.25.21.34.44;	author tg;	state Exp;
branches;
next	1.54;
commitid	10047E96EF5608C6FD5;

1.54
date	2008.03.05.18.49.15;	author tg;	state Exp;
branches
	1.54.2.1;
next	1.53;
commitid	10047CEEB2D48891B08;

1.53
date	2008.03.05.17.06.50;	author tg;	state Exp;
branches;
next	1.52;
commitid	10047CED336427DBA32;

1.52
date	2008.02.29.16.38.40;	author tg;	state Exp;
branches;
next	1.51;
commitid	10047C8350F6BECB74A;

1.51
date	2008.02.29.11.57.30;	author tg;	state Exp;
branches;
next	1.50;
commitid	10047C7F33F1FB9D756;

1.50
date	2007.10.25.14.43.02;	author tg;	state Exp;
branches;
next	1.49;
commitid	1004720AB86255A53C3;

1.49
date	2007.10.14.13.36.40;	author tg;	state Exp;
branches;
next	1.48;
commitid	10047121B7A369F0F0F;

1.48
date	2007.08.24.14.25.33;	author tg;	state Exp;
branches;
next	1.47;
commitid	10046CEEA1D199F064A;

1.47
date	2007.08.24.14.19.56;	author tg;	state Exp;
branches;
next	1.46;
commitid	10046CEE8E817DEC27F;

1.46
date	2007.08.12.13.42.20;	author tg;	state Exp;
branches;
next	1.45;
commitid	10046BF0E4F7055959B;

1.45
date	2007.07.31.11.11.23;	author tg;	state Exp;
branches;
next	1.44;
commitid	10046AF18D74B1B5DF4;

1.44
date	2007.07.01.21.47.07;	author tg;	state Exp;
branches;
next	1.43;
commitid	100468820CD07282054;

1.43
date	2007.06.05.21.47.48;	author tg;	state Exp;
branches;
next	1.42;
commitid	1004665D9D956A3B2CA;

1.42
date	2007.06.05.19.48.45;	author tg;	state Exp;
branches;
next	1.41;
commitid	1004665BE264E72FCFA;

1.41
date	2007.06.04.21.55.38;	author tg;	state Exp;
branches;
next	1.40;
commitid	10046648A710B86FCC9;

1.40
date	2007.06.04.21.27.53;	author tg;	state Exp;
branches;
next	1.39;
commitid	10046648335104B0B82;

1.39
date	2007.05.24.09.06.31;	author tg;	state Exp;
branches;
next	1.38;
commitid	1004655559A29A3848F;

1.38
date	2007.04.24.10.42.02;	author tg;	state Exp;
branches;
next	1.37;
commitid	100462DDE7C6EC3BD7F;

1.37
date	2007.04.23.20.37.16;	author tg;	state Exp;
branches;
next	1.36;
commitid	100462D18E37B6B8D16;

1.36
date	2007.04.16.18.54.37;	author tg;	state Exp;
branches;
next	1.35;
commitid	1004623C5744FDC6F8B;

1.35
date	2007.03.04.04.36.45;	author tg;	state Exp;
branches;
next	1.34;
commitid	10045EA4CCF3ED98D2A;

1.34
date	2007.03.04.03.04.23;	author tg;	state Exp;
branches;
next	1.33;
commitid	10045EA374B3374AB35;

1.33
date	2007.03.04.00.13.14;	author tg;	state Exp;
branches;
next	1.32;
commitid	10045EA0F2F6674C8B9;

1.32
date	2007.03.03.21.48.33;	author tg;	state Exp;
branches;
next	1.31;
commitid	10045E9ED4737C03C2B;

1.31
date	2007.02.18.16.24.13;	author tg;	state Exp;
branches;
next	1.30;
commitid	10045D87D7D0FC908BE;

1.30
date	2007.02.10.21.59.15;	author tg;	state Exp;
branches;
next	1.29;
commitid	10045CE40341BE5E0A2;

1.29
date	2007.01.18.16.05.05;	author tg;	state Exp;
branches;
next	1.28;
commitid	10045AF9AC06E556EEF;

1.28
date	2007.01.18.15.50.32;	author tg;	state Exp;
branches;
next	1.27;
commitid	10045AF974442B3F2AC;

1.27
date	2007.01.18.01.24.46;	author tg;	state Exp;
branches;
next	1.26;
commitid	10045AECC5E2D67D562;

1.26
date	2007.01.17.23.27.47;	author tg;	state Exp;
branches;
next	1.25;
commitid	10045AEB1062E76AA2B;

1.25
date	2007.01.17.23.18.55;	author tg;	state Exp;
branches;
next	1.24;
commitid	10045AEAEED31DCCB57;

1.24
date	2007.01.17.22.51.46;	author tg;	state Exp;
branches;
next	1.23;
commitid	10045AEA86F7FE51B97;

1.23
date	2007.01.17.21.42.23;	author tg;	state Exp;
branches;
next	1.22;
commitid	10045AE984A425BEE7A;

1.22
date	2007.01.12.01.11.03;	author tg;	state Exp;
branches
	1.22.2.1;
next	1.21;
commitid	10045A6E0396C8D353A;

1.21
date	2007.01.12.00.25.39;	author tg;	state Exp;
branches;
next	1.20;
commitid	10045A6D3B866AF7B2F;

1.20
date	2006.11.12.13.21.50;	author tg;	state Exp;
branches;
next	1.19;
commitid	10045571FFF75016FEB;

1.19
date	2006.11.12.13.19.06;	author tg;	state Exp;
branches;
next	1.18;
commitid	10045571F5E3519F589;

1.18
date	2006.11.12.12.56.09;	author tg;	state Exp;
branches;
next	1.17;
commitid	100455719F125BF13F8;

1.17
date	2006.11.09.15.03.56;	author tg;	state Exp;
branches;
next	1.16;
commitid	1004553437330FDC0C3;

1.16
date	2006.11.09.00.11.39;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004552723039ED92BA;

1.15
date	2006.11.08.23.45.46;	author tg;	state Exp;
branches;
next	1.14;
commitid	10045526C372A4C60AB;

1.14
date	2006.11.08.23.24.49;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004552675863B69336;

1.13
date	2006.11.05.12.11.13;	author tg;	state Exp;
branches;
next	1.12;
commitid	100454DD4E712F5401D;

1.12
date	2006.08.26.20.30.27;	author tg;	state Exp;
branches;
next	1.11;
commitid	10044F0AF574E06B6B7;

1.11
date	2006.08.01.12.46.01;	author tg;	state Exp;
branches
	1.11.2.1;
next	1.10;
commitid	10044CF4D16439F4D0F;

1.10
date	2006.07.23.19.10.59;	author tg;	state Exp;
branches;
next	1.9;
commitid	10044C3C9C71BB14FC4;

1.9
date	2006.05.08.12.18.49;	author tg;	state Exp;
branches;
next	1.8;
commitid	100445F37325FE69A7C;

1.8
date	2005.10.21.11.44.25;	author tg;	state Exp;
branches;
next	1.7;
commitid	616d4358d4a1f32f;

1.7
date	2005.10.20.12.47.49;	author tg;	state Exp;
branches;
next	1.6;
commitid	353f43579208719c;

1.6
date	2005.10.08.18.53.09;	author tg;	state Exp;
branches;
next	1.5;
commitid	1a5e434815a40ffe;

1.5
date	2005.08.29.01.16.22;	author tg;	state Exp;
branches;
next	1.4;
commitid	3a40431261e27265;

1.4
date	2005.08.26.22.03.55;	author tg;	state Exp;
branches;
next	1.3;
commitid	57a8430f91c30d91;

1.3
date	2005.05.23.14.48.21;	author tg;	state Exp;
branches;
next	1.2;
commitid	7bf94291ed463ca9;

1.2
date	2005.05.23.11.59.06;	author tg;	state Exp;
branches;
next	1.1;
commitid	7d2b4291c5850420;

1.1
date	2005.05.23.03.06.05;	author tg;	state Exp;
branches;
next	;
commitid	1a89429147b8402d;

1.75.2.1
date	2009.07.25.18.27.53;	author tg;	state Exp;
branches;
next	;
commitid	1004A6B4E471DB88B03;

1.70.2.1
date	2008.11.19.21.08.24;	author tg;	state Exp;
branches;
next	1.70.2.2;
commitid	1004924805F7FD79D3D;

1.70.2.2
date	2008.11.19.21.10.13;	author tg;	state Exp;
branches;
next	1.70.2.3;
commitid	100492480CA4DEFE70C;

1.70.2.3
date	2008.11.21.08.53.10;	author tg;	state Exp;
branches;
next	1.70.2.4;
commitid	100492676FC5F9F4F70;

1.70.2.4
date	2008.11.22.13.20.24;	author tg;	state Exp;
branches;
next	;
commitid	100492806F80A7B2451;

1.54.2.1
date	2008.04.22.13.29.20;	author tg;	state Exp;
branches;
next	1.54.2.2;
commitid	100480DE80F32BAA72D;

1.54.2.2
date	2008.05.19.18.41.15;	author tg;	state Exp;
branches;
next	1.54.2.3;
commitid	1004831C9A63DA06745;

1.54.2.3
date	2008.07.11.11.49.23;	author tg;	state Exp;
branches;
next	1.54.2.4;
commitid	100487748D62394D033;

1.54.2.4
date	2008.12.14.00.07.31;	author tg;	state Exp;
branches;
next	;
commitid	10049444E5325915C76;

1.22.2.1
date	2007.03.03.21.37.51;	author tg;	state Exp;
branches;
next	1.22.2.2;
commitid	10045E9EAC27ABA6ADF;

1.22.2.2
date	2007.03.03.21.50.21;	author tg;	state Exp;
branches;
next	1.22.2.3;
commitid	10045E9EDB3243C2550;

1.22.2.3
date	2007.03.03.22.38.23;	author tg;	state Exp;
branches;
next	;
commitid	10045E9F8F5395F55BB;

1.11.2.1
date	2006.08.28.01.49.14;	author tg;	state Exp;
branches;
next	;
commitid	10044F24B9666020C36;


desc
@@


1.165
log
@merge the mksh FAQ into one quill-moving place

(hts-.inc-format file in mksh source tree, linked into HTML, not installed)
@
text
@# $MirOS: src/bin/mksh/Makefile,v 1.161 2017/08/07 21:39:25 tg Exp $
#-
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
#		2011, 2012, 2013, 2014, 2015, 2016, 2017
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.

.ifmake d
__CRAZY=	Yes
MKC_DEBG=	cpp
DEBUGFILE=	Yes
NOMAN=		Yes
.endif

.include <bsd.own.mk>

SRCDIR=		${.CURDIR}

PROG=		mksh
SRCS=		edit.c eval.c exec.c expr.c funcs.c histrap.c jobs.c \
		lalloc.c lex.c main.c misc.c shf.c syn.c tree.c var.c
.if !make(test-build)
CPPFLAGS+=	-DMKSH_ASSUME_UTF8 -DMKSH_DISABLE_DEPRECATED \
		-DHAVE_ATTRIBUTE_BOUNDED=1 -DHAVE_ATTRIBUTE_FORMAT=1 \
		-DHAVE_ATTRIBUTE_NORETURN=1 -DHAVE_ATTRIBUTE_PURE=1 \
		-DHAVE_ATTRIBUTE_UNUSED=1 -DHAVE_ATTRIBUTE_USED=1 \
		-DHAVE_SYS_TIME_H=1 -DHAVE_TIME_H=1 -DHAVE_BOTH_TIME_H=1 \
		-DHAVE_SYS_BSDTYPES_H=0 -DHAVE_SYS_FILE_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_RESOURCE_H=1 -DHAVE_SYS_SELECT_H=1 \
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_BSTRING_H=0 -DHAVE_GRP_H=1 \
		-DHAVE_IO_H=0 -DHAVE_LIBGEN_H=1 -DHAVE_LIBUTIL_H=0 \
		-DHAVE_PATHS_H=1 -DHAVE_STDINT_H=1 -DHAVE_STRINGS_H=1 \
		-DHAVE_TERMIOS_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_CAN_INTTYPES=1 -DHAVE_CAN_UCBINTS=1 \
		-DHAVE_CAN_INT8TYPE=1 -DHAVE_CAN_UCBINT8=1 -DHAVE_RLIM_T=1 \
		-DHAVE_SIG_T=1 -DHAVE_SYS_ERRLIST=1 -DHAVE_SYS_SIGNAME=1 \
		-DHAVE_SYS_SIGLIST=1 -DHAVE_FLOCK=1 -DHAVE_LOCK_FCNTL=1 \
		-DHAVE_GETRUSAGE=1 -DHAVE_GETSID=1 -DHAVE_GETTIMEOFDAY=1 \
		-DHAVE_KILLPG=1 -DHAVE_MEMMOVE=1 -DHAVE_MKNOD=0 -DHAVE_MMAP=1 \
		-DHAVE_FTRUNCATE=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_SELECT=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRERROR=0 -DHAVE_STRSIGNAL=0 -DHAVE_STRLCPY=1 \
		-DHAVE_FLOCK_DECL=1 -DHAVE_REVOKE_DECL=1 \
		-DHAVE_SYS_ERRLIST_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=571
CPPFLAGS+=	-D${${PROG:L}_tf:C/(Mir${MAN:E}{0,1}){2}/4/:S/x/mksh_BUILD/:U}
CPPFLAGS+=	-I.
COPTS+=		-std=c89 -Wall
.endif

USE_PRINTF_BUILTIN?=	0
.if ${USE_PRINTF_BUILTIN} == 1
.PATH: ${BSDSRCDIR}/usr.bin/printf
SRCS+=		printf.c
CPPFLAGS+=	-DMKSH_PRINTF_BUILTIN
.endif

DEBUGFILE?=	No
.if ${DEBUGFILE:L} == "yes"
CPPFLAGS+=	-DDF=mksh_debugtofile
.endif

MANLINKS=	[ false pwd sh sleep test true
BINLINKS=	${MANLINKS} echo domainname kill
.for _i in ${BINLINKS}
LINKS+=		${BINDIR}/${PROG} ${BINDIR}/${_i}
.endfor
.for _i in ${MANLINKS}
MLINKS+=	${PROG}.1 ${_i}.1
.endfor

OPTGENS!=	cd ${SRCDIR:Q} && echo *.opt
.for _i in ${OPTGENS}
GENERATED+=	${_i:R}.gen
${_i:R}.gen: ${_i} ${SRCDIR}/Build.sh
	/bin/sh ${SRCDIR:Q}/Build.sh -G ${SRCDIR:Q}/${_i:Q}
.endfor
CLEANFILES+=	${GENERATED}

${PROG} beforedepend: ${GENERATED}

REGRESS_CATEGORIES:=shell:legacy-no,int:32,shell:textmode-no,shell:binmode-yes,fastbox
.if !empty(GCEXTRA:M-DMKSH_FAUX_EBCDIC)
REGRESS_CATEGORIES:=${REGRESS_CATEGORIES},shell:faux-ebcdic
.endif

regress: ${PROG} check.pl check.t
	-rm -rf regress-dir
	mkdir -p regress-dir
	echo export FNORD=666 >regress-dir/.mkshrc
	HOME=$$(realpath regress-dir) perl ${SRCDIR}/check.pl \
	    -s ${SRCDIR}/check.t -v -p ./${PROG} \
	    -C ${REGRESS_CATEGORIES}

TEST_BUILD_ENV:=	TARGET_OS= CPP=
TEST_BUILD_ENV+=	HAVE_STRING_POOLING=0

test-build: .PHONY
	-rm -rf build-dir
	mkdir -p build-dir
.if ${USE_PRINTF_BUILTIN} == 1
	cp ${BSDSRCDIR}/usr.bin/printf/printf.c build-dir/
.endif
	cd build-dir; env CC=${CC:Q} CFLAGS=${CFLAGS:M*:Q} \
	    CPPFLAGS=${CPPFLAGS:M*:Q} LDFLAGS=${LDFLAGS:M*:Q} \
	    LIBS= NOWARN=-Wno-error ${TEST_BUILD_ENV} /bin/sh \
	    ${SRCDIR}/Build.sh -Q -r ${_TBF} && ./test.sh -v -f

CLEANFILES+=	lksh.cat1
test-build-lksh: .PHONY
	cd ${SRCDIR} && exec ${MAKE} lksh.cat1 test-build _TBF=-L

bothmans: .PHONY
	cd ${SRCDIR} && exec ${MAKE} MAN='lksh.1 mksh.1' __MANALL

cleandir: clean-extra

clean-extra: .PHONY
	-rm -rf build-dir regress-dir printf.o printf.ln

mksh_tf=xMakefile${OStype:S/${MACHINE_OS}/1/1g}${OSNAME}
distribution:
	sed 's!\$$I''d\([:$$]\)!$$M''irSecuCron\1!g' \
	    ${SRCDIR}/dot.mkshrc >${DESTDIR}/etc/skel/.mkshrc
	chown ${BINOWN}:${CONFGRP} ${DESTDIR}/etc/skel/.mkshrc
	chmod 0644 ${DESTDIR}/etc/skel/.mkshrc

.if make(cats) || make(clean) || make(cleandir)
MAN=		lksh.1 mksh.1
.endif
CLEANFILES+=	${MANALL:S/.cat/.ps/} ${MAN:S/$/.pdf/} ${MANALL:S/$/.gz/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.htm.gz/}
CLEANFILES+=	${MAN:S/$/.txt/} ${MAN:S/$/.txt.gz/}

.include <bsd.prog.mk>

.ifmake cats
V_GROFF!=	pkg_info -e 'groff-*'
V_GHOSTSCRIPT!=	pkg_info -e 'ghostscript-*'
.  if empty(V_GROFF) || empty(V_GHOSTSCRIPT)
.    error empty V_GROFF=${V_GROFF} or V_GHOSTSCRIPT=${V_GHOSTSCRIPT}
.  endif
.endif

CATS_KW=	mksh, lksh, ksh, sh, Korn Shell, Android
CATS_TITLE_lksh_1=lksh - Legacy Korn shell built on mksh
CATS_TITLE_mksh_1=mksh - The MirBSD Korn Shell
cats: ${MANALL} ${MANALL:S/.cat/.ps/}
.if "${MANALL:Nlksh.cat1:Nmksh.cat1}" != ""
.  error Adjust here.
.endif
.for _m _n in lksh 1 mksh 1
	x=$$(ident ${SRCDIR:Q}/${_m}.${_n} | \
	    awk '/Mir''OS:/ { print $$4$$5; }' | \
	    tr -dc 0-9); (( $${#x} == 14 )) || exit 1; exec \
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -p pa4 -c \
	    -o ${_m}.${_n}.pdf '[' /Author '(The MirOS Project)' \
	    /Title '('${CATS_TITLE_${_m}_${_n}:Q}')' \
	    /Subject '(BSD Reference Manual)' /ModDate "(D:$$x)" \
	    /Creator '(GNU groff version ${V_GROFF:S/groff-//} \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript ${V_GHOSTSCRIPT:S/ghostscript-//:S/-artifex//} \(MirPorts\))' \
	    /Keywords '('${CATS_KW:Q}')' /DOCINFO pdfmark \
	    -f ${_m}.ps${_n}
.endfor
	set -e; . ${BSDSRCDIR:Q}/scripts/roff2htm; set_target_absolute; \
	    for m in ${MANALL}; do \
		bn=$${m%.*}; ext=$${m##*.cat}; \
		[[ $$bn != $$m ]]; [[ $$ext != $$m ]]; \
		gzip -n9 <"$$m" >"$$m.gz"; \
		col -bx <"$$m" >"$$bn.$$ext.txt"; \
		rm -f "$$bn.$$ext.txt.gz"; gzip -n9 "$$bn.$$ext.txt"; \
		do_conversion_verbose "$$bn" "$$ext" "$$m" "$$bn.$$ext.htm"; \
		rm -f "$$bn.$$ext.htm.gz"; gzip -n9 "$$bn.$$ext.htm"; \
	done

.ifmake d
.  ifmake obj || depend || all || install || regress || test-build
d:
.  else
d: all
.  endif
.endif

dr:
	p=$$(realpath ${PROG:Q}) && cd ${SRCDIR:Q} && exec ${MKSH} \
	    ${BSDSRCDIR:Q}/contrib/hosted/tg/sdmksh "$$p"

r:
	cd ${.CURDIR:Q} && exec env ENV=/nonexistent PS1='% ' ${.OBJDIR:Q}/mksh

repool:
	cd ${.CURDIR:Q} && \
	    exec ${MKSH} ${BSDSRCDIR:Q}/scripts/stringpool.sh sh.h

.ifmake validate
.  include "${BSDSRCDIR}/www/Defs.mk"
.endif
validate:
	${_inc2xhtml} <${.CURDIR}/mksh.faq | xmlstarlet val -d ${_xhtmldtd} -e -
	#(cd ${BSDSRCDIR:Q}/www && make obj && exec make validate=mksh-faq)
@


1.164
log
@bump
@
text
@d210 7
@


1.163
log
@implement early (mediæval) locale tracking, as a compile-time option,
for SuSE; slightly inspired by the original patch submitted by
From: Dr. Werner Fink <werner@@suse.de>
@
text
@d61 1
a61 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=563
@


1.162
log
@monkey-patch offsetof for a klibc/dietlibc warning; bump to R56b (bugfixes)
@
text
@d61 1
a61 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=562
@


1.161
log
@release
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.156 2017/04/02 14:14:04 tg Exp $
d61 1
a61 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=561
@


1.160
log
@add -DMKSH_FAUX_EBCDIC to test the codepaths better

waking up to: Lanfear - Just Another Broken Shell
@
text
@d55 5
a59 4
		-DHAVE_NICE=1 -DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_SELECT=1 -DHAVE_SETRESUGID=1 \
		-DHAVE_SETGROUPS=1 -DHAVE_STRERROR=0 -DHAVE_STRSIGNAL=0 \
		-DHAVE_STRLCPY=1 -DHAVE_FLOCK_DECL=1 -DHAVE_REVOKE_DECL=1 \
d61 1
a61 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=551
d98 1
a98 1
REGRESS_CATEGORIES:=shell:legacy-no,int:32,shell:ebcdic-no,shell:ascii-yes,shell:textmode-no,shell:binmode-yes,fastbox
@


1.159
log
@adjust
@
text
@d97 5
d108 1
a108 1
	    -C shell:legacy-no,int:32,shell:ebcdic-no,shell:ascii-yes,shell:textmode-no,shell:binmode-yes,fastbox
@


1.158
log
@R55
@
text
@d103 1
a103 1
	    -C shell:legacy-no,int:32,shell:textmode-no,shell:binmode-yes,fastbox
@


1.157
log
@something comfy
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=549
@


1.156
log
@introduce the -T flag to set TEXTMODE (ASCII CR+LF newline support)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.152 2016/08/25 16:21:30 tg Exp $
d198 3
@


1.155
log
@make both cats
@
text
@d4 1
a4 1
#		2011, 2012, 2013, 2014, 2015, 2016
d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=541
d103 1
a103 1
	    -C shell:legacy-no,int:32,fastbox
@


1.154
log
@collective R54 release preparation multi-merger:

install both lksh and mksh manpages from Build.sh (Martijn Dekker)
spelling fixes (Larry Hynes)
manpage improvements (Martijn Dekker)
initial port to Harvey-OS’ APEX (Ronald G. Minnich, Elbing Miss, Álvaro Jurado)
more from komh’s OS/2 port (KO Myung-Hun)
@
text
@d138 7
d155 2
a156 4
CLEANFILES+=	${MANALL:S/.cat/.ps/} ${MAN:S/$/.pdf/} ${MANALL:S/$/.gz/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.htm.gz/}
CLEANFILES+=	${MAN:S/$/.txt/} ${MAN:S/$/.txt.gz/}
CATS_KW=	mksh, ksh, sh
d162 1
a162 1
.for _m _n in mksh 1
@


1.153
log
@fix lazy evaluation with side effects; spotted by ormaaj via IRC
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=539
@


1.152
log
@outstanding bumps
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.147 2016/03/03 23:51:31 tg Exp $
d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=531
@


1.151
log
@bump, required by XTaran
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=530
@


1.150
log
@remove fd>9 support in favour of upcoming named file descriptors; bump
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=529
@


1.149
log
@rework string pooling; disable our own (rely on compiler’s)…
• if HAVE_STRING_POOLING is set to 1
• if HAVE_STRING_POOLING is set to 2 and not GCC < 4 is used
• if HAVE_STRING_POOLING is not set to 0 and LLVM or GCC >= 4 is used

Closes: LP#1580348
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=523
d105 3
d116 1
a116 1
	    LIBS= NOWARN=-Wno-error TARGET_OS= CPP= /bin/sh \
@


1.148
log
@document upcoming set +o changes; bump
@
text
@d189 4
@


1.147
log
@render PDF manpages in PA4 paper size ipv DIN ISO A4 paper size
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.146 2016/01/21 18:24:34 tg Exp $
d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=522
@


1.146
log
@save 200 bytes off .text by revisiting string pooling

also, forgotten version bump
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.138 2014/10/07 15:22:13 tg Exp $
d158 1
a158 1
	    ${MKSH} ${BSDSRCDIR:Q}/contrib/hosted/tg/ps2pdfmir -c \
@


1.145
log
@update for recent changes
@
text
@d4 1
a4 1
#		2011, 2012, 2013, 2014, 2015
d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=521
@


1.144
log
@stop using issetugid(2) for ±p check as it’s probably not the right tool
@
text
@d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=511
@


1.143
log
@oksh sync, simplify *all* if(x)free(x); constructs, simplify x_push() and sync boilerplate while here
@
text
@d5 1
a5 1
#	mirabilos <tg@@mirbsd.org>
d54 5
a58 6
		-DHAVE_ISSETUGID=1 -DHAVE_KILLPG=1 -DHAVE_MEMMOVE=1 \
		-DHAVE_MKNOD=0 -DHAVE_MMAP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_SELECT=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRERROR=0 -DHAVE_STRSIGNAL=0 -DHAVE_STRLCPY=1 \
		-DHAVE_FLOCK_DECL=1 -DHAVE_REVOKE_DECL=1 \
@


1.142
log
@harden the crlf vs lf tests even more; use binary mode explicitly on OS/2
@
text
@d5 1
a5 1
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.org>
d157 1
a157 1
	    awk '/MirOS:/ { print $$4$$5; }' | \
@


1.141
log
@Implement the “FKSH functions have local scope for shell options” feature
for mksh but not lksh; bump to R51-alpha.

While here, tweak build scripts a bit, fixup MirBSD-specific Makefile
things, remove part of a comment that’s uninteresting.
@
text
@d46 14
a59 13
		-DHAVE_LIBGEN_H=1 -DHAVE_LIBUTIL_H=0 -DHAVE_PATHS_H=1 \
		-DHAVE_STDINT_H=1 -DHAVE_STRINGS_H=1 -DHAVE_TERMIOS_H=1 \
		-DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 -DHAVE_CAN_INTTYPES=1 \
		-DHAVE_CAN_UCBINTS=1 -DHAVE_CAN_INT8TYPE=1 \
		-DHAVE_CAN_UCBINT8=1 -DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 \
		-DHAVE_SYS_ERRLIST=1 -DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 \
		-DHAVE_FLOCK=1 -DHAVE_LOCK_FCNTL=1 -DHAVE_GETRUSAGE=1 \
		-DHAVE_GETSID=1 -DHAVE_GETTIMEOFDAY=1 -DHAVE_ISSETUGID=1 \
		-DHAVE_KILLPG=1 -DHAVE_MEMMOVE=1 -DHAVE_MKNOD=0 -DHAVE_MMAP=1 \
		-DHAVE_NICE=1 -DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_SELECT=1 -DHAVE_SETRESUGID=1 \
		-DHAVE_SETGROUPS=1 -DHAVE_STRERROR=0 -DHAVE_STRSIGNAL=0 \
		-DHAVE_STRLCPY=1 -DHAVE_FLOCK_DECL=1 -DHAVE_REVOKE_DECL=1 \
d61 1
a61 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=510
@


1.140
log
@permit building lksh with printf builtin, for testing
@
text
@d5 1
a5 1
#	Thorsten Glaser <tg@@mirbsd.org>
d31 2
d60 1
a60 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=509
d87 1
a87 1
OPTGENS!=	cd ${.CURDIR:Q} && echo *.opt
d90 2
a91 2
${_i:R}.gen: ${_i} ${.CURDIR}/Build.sh
	/bin/sh ${.CURDIR:Q}/Build.sh -G ${.CURDIR:Q}/${_i:Q}
d101 2
a102 2
	HOME=$$(realpath regress-dir) perl ${.CURDIR}/check.pl \
	    -s ${.CURDIR}/check.t -v -p ./${PROG} \
d114 1
a114 1
	    ${.CURDIR}/Build.sh -Q -r ${_TBF} && ./test.sh -v -f
d118 1
a118 1
	cd ${.CURDIR} && exec ${MAKE} lksh.cat1 test-build _TBF=-L
d121 1
a121 1
	cd ${.CURDIR} && exec ${MAKE} MAN='lksh.1 mksh.1' __MANALL
d131 1
a131 1
	    ${.CURDIR}/dot.mkshrc >${DESTDIR}/etc/skel/.mkshrc
d155 1
a155 1
	x=$$(ident ${.CURDIR:Q}/${_m}.${_n} | \
d187 1
a187 1
	p=$$(realpath ${PROG:Q}) && cd ${.CURDIR:Q} && exec ${MKSH} \
@


1.139
log
@• Build.sh: fix NSIG detection for gcc-snapshot
• all: bump version to R50-current; add more comments; whitespace
• all: remove all mkssert(); we’ll do full re-runs of scan-build and,
  hopefully, Coverity Scan/Prevent
• check.t: fix a testcase (sed could exit false, but we don’t care)
• eval.c: fix tilde_ok data type (only unsigned may shl constantly)
• exec.c: fix shebang buf array accesses to always go via uint8_t *
@
text
@d4 1
a4 1
#		2011, 2012, 2013, 2014
d116 1
a116 2
	cd ${.CURDIR} && exec ${MAKE} lksh.cat1 test-build \
	    _TBF=-L USE_PRINTF_BUILTIN=0
@


1.138
log
@fix severe regression in field splitting (LP#1378208)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.137 2014/10/03 17:32:08 tg Exp $
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=504
@


1.137
log
@overhaul IFS handling, fix bugs reported by Stephane Chazelas and mikeserv

now we’re at: 486 passed testsuite items, 0 failed
ifs.sh still: # tests 6856 passed 6856 failed 0
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.136 2014/09/03 19:22:48 tg Exp $
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=503
@


1.136
log
@permit $1, $!, etc. to be nameref’d again ($_ was); spotted by Jb_boin, 10x!
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.135 2014/06/24 20:47:42 tg Exp $
d51 3
a53 3
		-DHAVE_GETSID=1 -DHAVE_GETTIMEOFDAY=1 -DHAVE_KILLPG=1 \
		-DHAVE_MEMMOVE=1 -DHAVE_MKNOD=0 -DHAVE_MMAP=1 -DHAVE_NICE=1 \
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=502
@


1.135
log
@bump
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.134 2014/06/09 13:25:50 tg Exp $
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=501
@


1.134
log
@fix some of the signal stuff (still didn’t get rid of awk(1) and printf(1)
calls in Build.sh, we need HOSTCC for that… which we should do, using BER
or something encoded for integers, and pregenerated hashtables as planned)

also, bump to R50 beta, due to today’s language changes
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.133 2014/05/27 13:22:42 tg Exp $
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=500
@


1.133
log
@fix LP#1277691 (“nameref RHS not syntax checked”) and the inability to
use errorf() while nameref states were being changed (by almost completely
eliminating the global variable) and the readonly first array variable
bypass (typo/refactoro); also, whitespace, one int → bool, and add a
comment wrt. the parser rewrite talked about with igli during a fever ;)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.132 2014/02/09 22:49:29 tg Exp $
d41 13
a53 13
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_RESOURCE_H=1 \
		-DHAVE_SYS_SELECT_H=1 -DHAVE_SYS_SYSMACROS_H=0 \
		-DHAVE_BSTRING_H=0 -DHAVE_GRP_H=1 -DHAVE_LIBGEN_H=1 \
		-DHAVE_LIBUTIL_H=0 -DHAVE_PATHS_H=1 -DHAVE_STDINT_H=1 \
		-DHAVE_STRINGS_H=1 -DHAVE_TERMIOS_H=1 -DHAVE_ULIMIT_H=0 \
		-DHAVE_VALUES_H=0 -DHAVE_CAN_INTTYPES=1 -DHAVE_CAN_UCBINTS=1 \
		-DHAVE_CAN_INT8TYPE=1 -DHAVE_CAN_UCBINT8=1 -DHAVE_RLIM_T=1 \
		-DHAVE_SIG_T=1 -DHAVE_SYS_ERRLIST=1 -DHAVE_SYS_SIGNAME=1 \
		-DHAVE_SYS_SIGLIST=1 -DHAVE_FLOCK=1 -DHAVE_LOCK_FCNTL=1 \
		-DHAVE_GETRUSAGE=1 -DHAVE_GETSID=1 -DHAVE_GETTIMEOFDAY=1 \
		-DHAVE_KILLPG=1 -DHAVE_MEMMOVE=1 -DHAVE_MKNOD=0 -DHAVE_MMAP=1 \
		-DHAVE_NICE=1 -DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=499
@


1.132
log
@tentatively drop C99
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.131 2014/01/05 21:57:22 tg Exp $
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=491
@


1.131
log
@• fix ${12345678901234567890} segfault (OOB access / integer overflow)
  ‣ not like oksh did, but using mksh’s built-in features
• handle suggested __pure additions
• revert cid 1004F7F096867C83CF0
  ‣ always use our wcwidth code
  ‣ only use our strlcpy code if none found
• fix a couple of gcc-snapshot and clang/scan-build warnings
• mksh R49~rc1
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.130 2013/11/30 17:41:32 tg Exp $
d61 1
a61 1
COPTS+=		-std=c99 -Wall
@


1.130
log
@detect getsid(2), also spotted by RT, this on MSYS
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.129 2013/11/30 15:42:19 tg Exp $
d4 1
a4 1
#		2011, 2012, 2013
d37 5
a41 4
		-DHAVE_ATTRIBUTE_NORETURN=1 -DHAVE_ATTRIBUTE_UNUSED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_TIME_H=1 -DHAVE_TIME_H=1 \
		-DHAVE_BOTH_TIME_H=1 -DHAVE_SYS_BSDTYPES_H=0 \
		-DHAVE_SYS_FILE_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
d58 1
a58 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=489
@


1.129
log
@zsh on BeOS calls sigsuspend() on “dot”, which fails; work around it

tested by RT
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.128 2013/11/20 21:14:50 tg Exp $
d50 3
a52 3
		-DHAVE_GETRUSAGE=1 -DHAVE_GETTIMEOFDAY=1 -DHAVE_KILLPG=1 \
		-DHAVE_MEMMOVE=1 -DHAVE_MKNOD=0 -DHAVE_MMAP=1 -DHAVE_NICE=1 \
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
@


1.128
log
@make this actually call getopt.sh, correctly, and Heirloom sh compatible
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.127 2013/11/17 22:21:17 tg Exp $
d87 2
a88 2
${_i:R}.gen: ${_i} ${.CURDIR}/genopt.sh
	(srcfile=${.CURDIR:Q}/${_i}; . ${.CURDIR:Q}/genopt.sh)
@


1.127
log
@more clueful (automatic) getopt string generation
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.124 2013/08/10 13:44:26 tg Exp $
d88 1
a88 1
	${MKSH} ${.CURDIR:Q}/genopt.sh ${.CURDIR:Q}/${_i}
@


1.126
log
@integrate latest changes from oksh: Wed Sep 4 15:49:19 2013 UTC by millert

Add a proper suspend builtin that saves/restores the tty and pgrp
as needed instead of an alias that just sends SIGSTOP.  Login shells
may be suspended if they are not running in an orphan process group.
@
text
@d59 1
d84 10
@


1.125
log
@SECURITY: Unbreak “set +p”, broken by OpenBSD ksh change.

TODO: I am seriously considering following Chet and changing
the way this works, by explicitly dropping privs unless the
shell is run with -p. Every other shell does it like mksh,
except Heirloom sh, which on the other hand doesn’t know any
explicit set -p or set +p (though it doesn’t know set +foo
for any foo either).

┌──┤ QUESTION: Do we need the ability to do this:
│ tg@@blau:~ $ ./suidmksh -p -c 'whoami; set +p; whoami'
│ root
│ tg

If not, I’m seriously considering to drop set ±p as well,
only parse -p on the command line, with +p being the default,
and dropping FPRIVILEGED.

Thanks to RT for noticing and jilles for initial follow-up
discussion, as well as Chet Ramey for doing the sane/secure
thing instead of following Debian.
@
text
@d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=483
@


1.124
log
@reduce amount of .bss memory needed; initialise via AEDIT at x_init
or even first run of x_vi
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.123 2013/07/21 18:47:15 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=481
@


1.123
log
@Fix most “set -x” problems (LP#1179287)

• “set -x” manually (cmdline too) snapshots fd#2 now
• “set -o inherit-xtrace” introduced; default still enabled
• reverted iodup printing to pre-R45 behaviour
• made Flag(FXTRACE) a proper state machine
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.122 2013/05/31 23:27:13 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=471
@


1.122
log
@Replace wcwidth code by mine based on Unicode 6.2.0
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.121 2013/05/02 21:59:45 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=469
@


1.121
log
@implement VALSUBs
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.119 2013/04/27 18:22:47 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=461
@


1.120
log
@after enough complaints by POSIX sh advocates,
• make parsing numbers with leading digit-zero as octal independent of
  mksh/lksh and dependent on set -o posix; adjust manpages to match
• warn about these changes and why mksh uses 32-bit consistent arithmetics
  and point people to lksh for host-long undefined-behaviour arithmetics
• point out, explicitly, that it is *legal* for the operating environment
  to make 'print $((2147483647 + 1))' (on a 32-bit system; adjust for a
  64-bit system) to run 'rm -rf ~ /' instead
@
text
@d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=459
@


1.119
log
@add lksh manpage formatting support
do not add it as regular mksh manpage, we do not ship lksh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.118 2013/04/27 18:12:37 tg Exp $
d107 3
d138 1
a138 1
.if "${MANALL:Nmksh.cat1}" != ""
@


1.118
log
@start next development iteration
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.117 2013/04/26 21:22:40 tg Exp $
d102 1
d104 1
a104 1
	cd ${.CURDIR} && exec ${MAKE} test-build \
@


1.117
log
@Oh well… this looks well, is done done, and gcc-snapshot doesn’t complain:
• correct order of built-in commands; use POSIX special versus “all others”
  plus “keeps assignments” as distinction, no longer play POSIX regular vs.
  others game; sync manpage
• fix LP#1156707: map (( internally to “let]” which is no valid function
  name and so can’t be overridden but is unlikely to be used otherwhere
  and not strictly permitted (by POSIX) anyway
• we do not need -Wno-overflow any more, either
• bump to R45
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.116 2013/04/26 19:40:09 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=451
@


1.116
log
@now get rid of the run-time check, the idivwrapv nonsense, and straighten out lksh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.115 2013/03/24 00:56:19 tg Exp $
d57 1
a57 1
		-DHAVE_PERSISTENT_HISTORY=1 -DMKSH_BUILD_R=449
@


1.115
log
@• let mksh “set -x” print whole TCOM trees
• plug some memory leaks in debug (“set -x”) and warning paths while here
• one from Florian (friend of Natureshadow) for WTF
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.114 2013/03/05 15:41:40 tg Exp $
d57 1
a57 2
		-DHAVE_PERSISTENT_HISTORY=1 -DHAVE_SILENT_IDIVWRAPV=0 \
		-DMKSH_BUILD_R=449
d89 1
a89 1
	    -C shell:legacy-no,int:32,nodeprecated,fastbox
a98 1
	    HAVE_SILENT_IDIVWRAPV=0 \
@


1.114
log
@bump
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.113 2013/02/23 20:03:27 tg Exp $
d58 1
a58 1
		-DMKSH_BUILD_R=441
@


1.113
log
@both mksh(1) and POSIX say: "$@@" should always generate multiple words
issue in pdksh reported in IRC by engla, thanks!
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.112 2013/02/18 22:55:37 tg Exp $
d58 1
a58 1
		-DMKSH_BUILD_R=440
@


1.112
log
@put list of check_categories into Makefrag.inc generated; bump patchlevel
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.111 2013/02/17 05:40:12 tg Exp $
d58 1
a58 1
		-DMKSH_BUILD_R=431
@


1.111
log
@backpedal with $'…' and $"…" interpolation

it turns out this breaks more legacy scripts than anticipated
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.110 2013/02/16 00:21:56 tg Exp $
d58 1
a58 1
		-DMKSH_BUILD_R=430
@


1.110
log
@… I fsck’d up and built R42b from MAIN ipv mksh-R42stable… oh well.

TODO: convert enum to something like uint8_t to save even more space
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.109 2012/12/17 23:46:31 tg Exp $
d4 1
a4 1
#		2011, 2012
d58 1
a58 1
		-DMKSH_BUILD_R=429
@


1.109
log
@sync clog et al.
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.107 2012/11/30 20:49:17 tg Exp $
d58 1
a58 1
		-DMKSH_BUILD_R=419
@


1.108
log
@force HAVE_SILENT_IDIVWRAPV=0 for test-build, since it’s used by me to
generate the CPPFLAGS for mksh for base and installer, and it’s archdep
@
text
@d37 5
a41 4
		-DHAVE_ATTRIBUTE_NONNULL=1 -DHAVE_ATTRIBUTE_NORETURN=1 \
		-DHAVE_ATTRIBUTE_UNUSED=1 -DHAVE_ATTRIBUTE_USED=1 \
		-DHAVE_SYS_BSDTYPES_H=0 -DHAVE_SYS_FILE_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 -DHAVE_SYS_PARAM_H=1 \
d48 2
a49 2
		-DHAVE_SIG_T=1 -DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 \
		-DHAVE_STRSIGNAL=0 -DHAVE_FLOCK=1 -DHAVE_LOCK_FCNTL=1 \
d51 4
a54 3
		-DHAVE_MKNOD=0 -DHAVE_MMAP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_SELECT=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
d56 3
a58 2
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1 \
		-DHAVE_SILENT_IDIVWRAPV=0 -DMKSH_BUILD_R=419
@


1.107
log
@regenerate Makefiles
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.106 2012/11/26 16:39:43 tg Exp $
d97 1
@


1.106
log
@make cats more flexible
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.105 2012/11/20 18:50:42 tg Exp $
d55 1
a55 1
		-DHAVE_SILENT_IDIVWRAPV=0 -DMKSH_BUILD_R=409
@


1.105
log
@RT tells me Minix 2 (i386) also doesn’t have gettimeofday(2)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.104 2012/10/21 17:16:44 tg Exp $
d118 8
d129 2
d135 2
a136 1
	x=$$(ident ${.CURDIR:Q}/mksh.1 | \
d140 2
a141 2
	    -o mksh.1.pdf '[' /Title '(mksh - The MirBSD Korn Shell)' \
	    /Author '(Thorsten Glaser, The MirOS Project)' \
d143 5
a147 4
	    /Creator '(GNU groff version 1.19.2-3 \(MirPorts\))' \
	    /Producer '(Artifex Ghostscript 8.54-3 \(MirPorts\))' \
	    /Keywords '(mksh, ksh, sh)' /DOCINFO pdfmark \
	    -f mksh.ps1
@


1.104
log
@add split-screen debugging; close-on-exec the logfile
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.103 2012/10/14 16:22:49 tg Exp $
d49 2
a50 2
		-DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 -DHAVE_MKNOD=0 \
		-DHAVE_MMAP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
@


1.103
log
@gzip the catmanpage, the text page and the HTML page
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.102 2012/10/14 14:51:08 tg Exp $
d21 7
a27 2
#-
# use CPPFLAGS=-DDEBUG __CRAZY=Yes to check for certain more stuff
d146 12
@


1.102
log
@add code to preformat manpages, for lesser OSes such as NetBSD®
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.101 2012/07/01 15:54:36 tg Exp $
d113 2
a114 2
CLEANFILES+=	${MANALL:S/.cat/.ps/}
CLEANFILES+=	${MAN:S/$/.htm/} ${MAN:S/$/.pdf/}
d135 1
d139 1
@


1.101
log
@add test-build-lksh developer target
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.99 2012/05/04 22:44:31 tg Exp $
d112 27
@


1.100
log
@(mksh) tighten 32-bit requirements; (lksh) switch to long; allow any bitness
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.98 2012/04/14 16:07:44 tg Exp $
d93 5
a97 1
	    ${.CURDIR}/Build.sh -Q -r && ./test.sh -v -f
@


1.99
log
@keep up
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.97 2012/04/07 11:19:46 tg Exp $
d81 2
a82 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG} -C fastbox,nodeprecated
@


1.98
log
@rewrite maketemp() obsoleting tempnam(3) and mkstemp(3) external deps
@
text
@d39 2
a40 2
		-DHAVE_STRINGS_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_CAN_INTTYPES=1 -DHAVE_CAN_UCBINTS=1 \
@


1.97
log
@drop all deprecated code, you have been warned
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.96 2012/03/27 23:13:41 tg Exp $
d45 1
a45 1
		-DHAVE_MKSTEMP=1 -DHAVE_MMAP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
@


1.96
log
@pass the version to avoid stale Makefile.inc files
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.95 2012/03/27 22:36:49 tg Exp $
d44 2
a45 2
		-DHAVE_MMAP=1 -DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 \
		-DHAVE_MKNOD=0 -DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
d48 3
a50 4
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_FLOCK_DECL=1 \
		-DHAVE_REVOKE_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1 -DHAVE_SILENT_IDIVWRAPV=0 \
		-DMKSH_BUILD_R=409
@


1.95
log
@• implement fcntl(2)-based advisory locking as an alternative iff flock(2)
  is not found, from a suggestion by RT (LP: #912691)
• try harder (in a loop) to acquire a file lock if the locking mechanism
  documents EINTR is a possibility (fcntl always, flock on Linux not .Ox)
• use -std=c99 not -std=gnu99 if it must be at all
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.94 2012/03/27 21:23:51 tg Exp $
d50 2
a51 3
		-DHAVE_PERSISTENT_HISTORY=1
# probably differs between i386 and sparc
CPPFLAGS+=	-DHAVE_SILENT_IDIVWRAPV=0
@


1.94
log
@You have this ↓ guy a lot to thank for.
00:45 -!- variable [root@@freebsd/developer/variable] has joined #!/bin/mksh

• +b *!*root@@*, +b $a:root, +b $r:root on one more channel
• certain checks to prevent:
00:47 < variable> wjcw: sh.h:308: error: conflicting types for 'getrusage'
01:19 < variable> oh
01:19 < variable> I needed to run Build.sh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.93 2012/03/23 19:38:11 tg Exp $
d3 2
a4 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011
d43 2
a44 1
		-DHAVE_STRSIGNAL=0 -DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 \
d54 1
a54 1
COPTS+=		-std=gnu99 -Wall
@


1.93
log
@efficient debug-to-file output (/tmp racy, but hey)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.92 2011/12/31 02:04:17 tg Exp $
d51 1
d99 1
@


1.92
log
@followup for cid 1004EE408E1382C1752 and 1004EE40DDD498FBB0D:
do a mirtoconf run-time check (ugh) to see whether the CPU designers
smoked/were brain-dead or if we don’t actually need the manual check
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.91 2011/12/08 22:19:16 tg Exp $
d61 5
@


1.91
log
@disable deprecated code on MirBSD-current mksh-current (note: next to deprecate is support for parsing $((010)) as octal, which is agreed gecko2@@ tonight at the Jugo already)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.90 2011/11/26 00:45:17 tg Exp $
d49 2
@


1.90
log
@fix stateptr-underflow; really do call fastbox regression checks; bump vsn
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.89 2011/11/25 23:29:30 tg Exp $
d29 1
a29 1
CPPFLAGS+=	-DMKSH_ASSUME_UTF8 \
d73 1
a73 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG} -C fastbox
@


1.89
log
@add a -f option to test.sh that runs tests of class fastbox
plus a test in that category for a bug spotted during development of
https://evolvis.org/plugins/scmgit/cgi-bin/gitweb.cgi?p=shellsnippets/shellsnippets.git;a=blob;f=mksh/sysadmin/getjpics.cgi;h=d74018cbc1ae4e88408267ecc73a6df19aa4c99a;hb=HEAD
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.88 2011/10/07 19:51:17 tg Exp $
d73 1
a73 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG}
@


1.88
log
@unbreak test-build with printf
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.87 2011/04/09 18:47:12 tg Exp $
d84 1
a84 1
	    ${.CURDIR}/Build.sh -Q -r && ./test.sh -v
@


1.87
log
@sync… various things
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.86 2011/02/11 01:18:14 tg Exp $
d78 3
@


1.86
log
@• more comment and int→bool cleanup, add and improve some comments
• in interactive mode, always look up {LC_{ALL,CTYPE},LANG} environment
  variables if setlocale/nl_langinfo(CODESET) doesn’t suffice
• add the ability to call any builtin (some don't make sense or wouldn't
  work) directly by analysing argv[0]
• for direct builtin calls, the {LC_{ALL,CTYPE},LANG} environment
  variables determine utf8-mode, even if MKSH_ASSUME_UTF8 was set
• when called as builtin, echo behaves POSIXish
• add domainname as alias for true on MirBSD only, to be able to link it
• sync mksh Makefiles with Build.sh output
• adjust manpage wrt release plans
• link some things to mksh now that we have callable builtins:
  bin/echo bin/kill bin/pwd bin/sleep (exact matches)
  bin/test bin/[ (were scripts before)
  bin/domainname=usr/bin/true usr/bin/false (move to /bin/ now)
• drop linked utilities and, except for echo and kill, their manpages
• adjust instbin and link a few more there as well
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.85 2011/01/30 02:28:31 tg Exp $
d34 10
a43 11
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_SELECT_H=1 \
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_BSTRING_H=0 -DHAVE_GRP_H=1 \
		-DHAVE_LIBGEN_H=1 -DHAVE_LIBUTIL_H=0 -DHAVE_PATHS_H=1 \
		-DHAVE_STDBOOL_H=1 -DHAVE_STDINT_H=1 -DHAVE_STRINGS_H=1 \
		-DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 -DHAVE_CAN_INTTYPES=1 \
		-DHAVE_CAN_UCBINTS=1 -DHAVE_CAN_INT8TYPE=1 \
		-DHAVE_CAN_UCBINT8=1 -DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 \
		-DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 \
		-DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 -DHAVE_MKNOD=0 \
		-DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
@


1.85
log
@regen
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.84 2011/01/29 19:07:16 tg Exp $
d3 1
a3 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
d33 4
a36 2
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_FILE_H=1 -DHAVE_SYS_MKDEV_H=0 \
		-DHAVE_SYS_MMAN_H=1 -DHAVE_SYS_SYSMACROS_H=0 -DHAVE_GRP_H=1 \
d46 4
a49 3
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_FLOCK_DECL=1 -DHAVE_REVOKE_DECL=1 \
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1
d60 8
a67 2
LINKS+=		${BINDIR}/${PROG} ${BINDIR}/sh
MLINKS+=	${PROG}.1 sh.1
@


1.84
log
@-DIN_MKSH is not used by anything
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.83 2010/10/08 17:56:56 tg Exp $
d33 10
a42 9
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_GRP_H=1 -DHAVE_LIBGEN_H=1 \
		-DHAVE_LIBUTIL_H=0 -DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 \
		-DHAVE_STDINT_H=1 -DHAVE_STRINGS_H=1 -DHAVE_ULIMIT_H=0 \
		-DHAVE_VALUES_H=0 -DHAVE_CAN_INTTYPES=1 -DHAVE_CAN_UCBINTS=1 \
		-DHAVE_CAN_INT8TYPE=1 -DHAVE_CAN_UCBINT8=1 -DHAVE_RLIM_T=1 \
		-DHAVE_SIG_T=1 -DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 \
		-DHAVE_STRSIGNAL=0 -DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 \
		-DHAVE_MKNOD=0 -DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
@


1.83
log
@mknod’s now demoted and only used as special-case builtin, in MirBSD only
built for the installer, to save time, as the original OpenBSD hack wanted
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.82 2010/09/14 21:26:05 tg Exp $
d45 1
a45 1
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1 -DIN_MKSH
@


1.82
log
@• Address concerns of Chris Palmer from the Android security team
  – possible integer overflows in memory allocation, mostly
    ‣ multiplication: all are checked now
    ‣ addition: reviewed them, most were “proven” or guessed to be
      “almost” impossible to run over (e.g. when we have a string
      whose length is taken it is assumed that the length will be
      more than only a few bytes below SIZE_MAX, since code and
      stack have to fit); some are checked now (e.g. when one of
      the summands is an off_t); most of the unchecked ones are
      annotated now
    ⇒ cost (MirBSD/i386 static): +76 .text
    ⇒ cost (Debian sid/i386): +779 .text  -4 .data
  – on Linux targets, setuid() setresuid() setresgid() can fail
    with EAGAIN; check for that and, if so, warn once and retry
    infinitely (other targets to be added later once we know that
    they are “insane”)
    ⇒ cost (Debian sid/i386): +192 .text (includes .rodata)
• setmode.c: Do overflow checking for realloc() too; switch back
  from calloc() to a checked malloc() for simplification while there
• define -DIN_MKSH and let setmode.c look a tad nicer while here
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.81 2010/08/24 15:19:53 tg Exp $
d41 1
a41 1
		-DHAVE_MKNOD=1 -DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
d43 3
a45 4
		-DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_FLOCK_DECL=1 \
		-DHAVE_REVOKE_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1 -DIN_MKSH
@


1.81
log
@it’s ugly to write a ./stdint.h file if we can instead define the
types from sh.h; sync clog
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.80 2010/07/04 17:41:39 tg Exp $
d46 1
a46 1
		-DHAVE_PERSISTENT_HISTORY=1
@


1.80
log
@sync
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.79 2009/12/12 22:27:03 tg Exp $
d3 1
a3 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009
d34 8
a41 7
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_LIBGEN_H=1 -DHAVE_LIBUTIL_H=0 \
		-DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 -DHAVE_STRINGS_H=1 \
		-DHAVE_GRP_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_STDINT_H=1 -DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 \
		-DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 \
		-DHAVE_GETRUSAGE=1 -DHAVE_KILLPG=1 -DHAVE_MKNOD=1 \
		-DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REVOKE=1 \
@


1.79
log
@re-vamp __attribute__ handling; let this pass on HP-UX bundled compiler
as well as HP aCC
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.78 2009/08/27 16:52:12 tg Exp $
a38 1
		-DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_PUSHB=1 \
d43 1
a43 2
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
		-DHAVE_ARC4RANDOM_PUSHB_DECL=1 -DHAVE_FLOCK_DECL=1 \
@


1.78
log
@we need more RCS IDs!
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.77 2009/07/30 19:18:06 tg Stab $
d30 4
a33 3
		-DHAVE_ATTRIBUTE=1 -DHAVE_ATTRIBUTE_BOUNDED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
d41 4
a44 5
		-DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REALPATH=1 \
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.77
log
@sync cleandir target
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.76 2009/07/30 19:11:09 tg Exp $
d82 4
a85 2
	${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${CONFGRP} -m 0644 \
	    ${.CURDIR}/dot.mkshrc ${DESTDIR}/etc/skel/.mkshrc
@


1.76
log
@"official" but unsupported printf-as-builtin code, cleaner API than
in the branch; USE_PRINTF_BUILTIN=1 to enable it (Build.sh + Makefile)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.75.2.1 2009/07/25 18:27:53 tg Exp $
d79 1
a79 1
	-rm -rf build-dir regress-dir
@


1.75
log
@• Check if killpg(3) is available; if not, use kill(2) with negative
  process ID and hope it works (is POSIXly killpg-endowed)
• bump version
• sync clog
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.74 2009/05/16 16:59:31 tg Stab $
d51 7
@


1.75.2.1
log
@prepare for another stab at having a printf(1) builtin in mksh(1) again,
since people like Md aren't, ever, going to see the light, I suppose...

API:
#ifdef MKSH_PRINTF_BUILTIN
void mksh_flush(void);
extern int c_printf(const char **);
^-> must call mksh_flush() first, then process as usual (calling main),
    then call fflush(NULL) again, then return; MUST NOT exit/abort/err!
#endif

XXX still need to think at how to embed it in portable mksh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.75 2009/06/08 20:34:38 tg Stab $
a50 6
.ifndef NO_PRINTF_BUILTIN
.PATH: ${BSDSRCDIR}/usr.bin/printf
SRCS+=		printf.c
CPPFLAGS+=	-DMKSH_PRINTF_BUILTIN
.endif

@


1.74
log
@• sync distrib/special/mksh/Makefile with bin/mksh/Build.sh and
  fix the regression test’s results while here, which have been
  broken since cid 10049D9BE5254CE65B8
• get rid of separate copyright file which was intended for De-
  bian; track down commits in all files of oksh-mirbsd and mksh
  to get correct copyright years per-file, as is BSD custom
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.73 2009/04/03 09:39:03 tg Exp $
d39 6
a44 5
		-DHAVE_GETRUSAGE=1 -DHAVE_MKNOD=1 -DHAVE_MKSTEMP=1 \
		-DHAVE_NICE=1 -DHAVE_REALPATH=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.73
log
@(experimental) implement getrusage via times if not found
@
text
@d1 19
a19 1
# $MirOS: src/bin/mksh/Makefile,v 1.72 2009/03/22 16:55:37 tg Exp $
@


1.72
log
@remove espie's double-linked-list based allocator and write a
similarily simple one from scratch, which however performs
better than espie's with AFREE_DEBUG enabled which took away
the benefit of the double-linked-list approach

all of (core) mksh is now MirOS licenced
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.71 2008/12/13 17:02:10 tg Exp $
d20 6
a25 6
		-DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKNOD=1 \
		-DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REALPATH=1 \
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.71
log
@* back out almost all of the memory allocator related changes, as aalloc
  was hard to type and hard to fix, galloc is also hard to fix, and some
  things I learned will probably improve things more but make me use the
  original form as base (especially for space savings)
* let sizeofN die though, remove even more casts
* optimise, polish
* regen Makefiles
* sprinkle a few /* CONSTCOND */ while here
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.70 2008/11/17 01:14:57 tg Exp $
d8 2
a9 2
SRCS=		alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c \
		jobs.c lex.c main.c misc.c shf.c syn.c tree.c var.c
a10 3
.  if ${DEBUGLIBS:L} == "yes"
CPPFLAGS+=	-DMKSH_AFREE_DEBUG	# MirOS development version
.  endif
@


1.70
log
@by the principle of the working tree, we cannot enable aalloc as of now.

damn, pointers in C are so uselessly complicated… in asm it’s much easier
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.69 2008/11/15 11:42:18 tg Exp $
d8 1
a8 6
.ifdef TEST
SRCS=		aalloc.c
.else
SRCS=		alloc.c
.endif
SRCS+=		edit.c eval.c exec.c expr.c funcs.c histrap.c \
a12 1
#CPPFLAGS+=	-DAALLOC_TRACK		# MirOS development version
a13 1
CPPFLAGS+=	-DAALLOC_NO_COOKIES	# for now… aalloc cookies are broken
d25 2
a26 2
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=1 \
		-DHAVE_LANGINFO_CODESET=1 -DHAVE_SETMODE=1 \
@


1.70.2.1
log
@beginnings
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.70 2008/11/17 01:14:57 tg Exp $
a4 2
NOMAN=		Yes	# temporary

@


1.70.2.2
log
@still broken
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.70.2.1 2008/11/19 21:08:24 tg Exp $
d10 6
a15 1
SRCS=		aalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c \
@


1.70.2.3
log
@some ad-hōc-ery for more tests, will be removed later
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.70.2.2 2008/11/19 21:10:13 tg Exp $
a35 3
.if ${CC} == "llvm-gcc"
CPPFLAGS+=	-UHAVE_ATTRIBUTE_BOUNDED -DHAVE_ATTRIBUTE_BOUNDED=0
.endif
@


1.70.2.4
log
@before I’m going to accidentally type “cvs -Rq up -PAd” a̲n̲o̲t̲h̲e̲r̲ time,
better save the current not-so progress into the repo… it segfaults,
and the code to free any memory is not even written, so do not use.
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.70.2.3 2008/11/21 08:53:10 tg Exp $
a8 4
.ifdef TEST
PROG=		_
SRCS=		_.c galloc.c
.else
d10 1
a10 1
SRCS=		edit.c eval.c exec.c expr.c funcs.c galloc.c histrap.c \
a11 1
.endif
d13 5
@


1.69
log
@rewrite the cookie logic… while this is better than previously,
we still have issues:

(gdb) r
Starting program: /usr/obj/bin/mksh/mksh -c print\ \$KSH_VERSION
mksh in free(): error: modified (chunk-) pointer

Program received signal SIGABRT, Aborted.
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.68 2008/11/12 07:38:42 tg Exp $
d8 6
a13 1
SRCS=		aalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c \
@


1.68
log
@use -DAALLOC_TRACK in MirOS-current but not releases, similar to
-DMKSH_AFREE_DEBUG, which is even similar in functionality

cost 412 code, 32 bss
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.67 2008/11/12 07:36:18 tg Exp $
d13 1
a13 1
CPPFLAGS+=	-DAALLOC_TRACK		# MirOS development version
@


1.67
log
@leave at least a working tree, with zero-penalty -DAALLOC_NO_COOKIES
XXX cookies are still broken?

cost for aalloc.c: data -= (4, 0, 4, 0); text += (1665, ?, 2115, 2217)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.66 2008/11/12 04:59:42 tg Exp $
d13 1
@


1.66
log
@fix first batch of compile warnings, enable aalloc for mirbsd
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.65 2008/11/02 22:42:37 tg Exp $
d14 1
@


1.65
log
@regenerate CPPFLAGS
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.64 2008/10/28 14:32:37 tg Exp $
d8 1
a8 1
SRCS=		alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c \
@


1.64
log
@• rewrite code to no longer use statements-as-expressions
• optimise a little
• Build.sh: remove HAVE_EXPSTMT test
• Build.sh, */Makefile: sort tests, regenerate
• mksh.hts: sync clog
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.63 2008/10/26 22:03:05 tg Exp $
d19 10
a28 9
		-DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 -DHAVE_GRP_H=1 \
		-DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 -DHAVE_STDINT_H=1 \
		-DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 -DHAVE_SYS_SIGNAME=1 \
		-DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 -DHAVE_ARC4RANDOM=1 \
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKNOD=1 -DHAVE_MKSTEMP=1 \
		-DHAVE_NICE=1 -DHAVE_REALPATH=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETLOCALE_CTYPE=1 -DHAVE_LANGINFO_CODESET=1 \
		-DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.63
log
@sync MirBSD-specific mksh Makefiles after recent Build.sh changes
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.62 2008/10/05 16:26:13 tg Exp $
d15 3
a17 3
		-DHAVE_EXPSTMT=1 -DHAVE_ATTRIBUTE=1 \
		-DHAVE_ATTRIBUTE_BOUNDED=1 -DHAVE_ATTRIBUTE_USED=1 \
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
d23 2
a24 1
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKSTEMP=1 -DHAVE_NICE=1 \
a25 1
		-DHAVE_MKNOD=1 -DHAVE_REALPATH=1 -DHAVE_REVOKE=1 \
@


1.62
log
@use mksh realpath builtin instead of readlink -f for canonicalisation

note: there’s still a readlink(1) call left in, for instance, mirmake;
this does not hurt because we initially assumed that readlink(1) does
exist anyway and bundled ours just because some do not have the ‘-f’
option for realpath(2)isation
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.61 2008/08/02 17:40:37 tg Exp $
d23 1
a23 1
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKSTEMP=1 \
@


1.61
log
@run millert’s afree checker by default (idea from openbsd) if MirOS-current
and not MirOS-stable (via DEBUGLIBS from <bsd.own.mk>)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.60 2008/06/21 19:20:15 tg Exp $
d41 1
a41 1
	HOME=$$(readlink -nf regress-dir) perl ${.CURDIR}/check.pl \
@


1.60
log
@remove check_category “pdksh”, it starts to make trouble and was never
taken seriously anyway, just historic ballast
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.59 2008/05/17 18:27:54 tg Exp $
d11 3
@


1.59
log
@add new builtin “realpath” calling realpath(3) on its argument, skipping
over “--” for compatibility to Debian realpath(1) and possibly busybox’

“sounds handy” replaced@@TNF
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.58 2008/05/04 01:51:29 tg Exp $
d39 1
a39 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG} -C pdksh
@


1.58
log
@remove dead code and ifdefs, speed up configuring
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.57 2008/04/20 02:15:12 tg Exp $
d22 3
a24 3
		-DHAVE_MKNOD=1 -DHAVE_REVOKE=1 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.57
log
@clean up unused defines
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.56 2008/03/27 22:44:17 tg Exp $
d21 1
a21 1
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
@


1.56
log
@• Build.sh: be a little more explicit about the unknown compilers
• Build.sh: add another one
• */Makefile: sync CPPFLAGS
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.55 2008/03/25 21:34:44 tg Exp $
d20 1
a20 1
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_FLOCK_EX=1 -DHAVE_MKSTEMP=1 \
@


1.55
log
@• Add support for Ultrix 4.5 and ucode cc (?)
  ‣ I/O redirection seems broken:
    $ (date; date >/dev/null; date) | wc -l
    1 (expected: 2)
  ‣ other than that: working fine
  ‣ -YBSD (default) and -YSYSTEM_FIVE don’t work, just -YPOSIX, somehow
• Fix $(…) to `…` for OSF/1 V2.0 /bin/sh
  ‣ this compiler is FUBAR though:
	$ cat >t.c
	main() { return (foo()); }
	$ cc t.c
	ld:
	Unresolved :
	foo
	$ echo $?
	0
	$ ls -l a.out
	-rwxr-xr-x   1 mirbsd   users      10835 Jul 21 17:12 a.out
  ‣ it seems to have ucode, but man is not installed
• new mirtoconf check: mkstemp(3)
• if !HAVE_MKSTEMP (Ultrix), use tempnam(3)
• only use printf(1) if it exists (it doesn’t on Ultrix)
• a few more signals
• add S_ISLNK if the OS doesn’t define it
• add strcasecmp(3) proto for Ultrix (it _is_ in <portability.h>, but
  only for -YBSD I think)
• fgrep(1) on Ultrix doesn’t do “-e ① -e ②”

10x DEChengst:#UnixNL for giving access
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.54 2008/03/05 18:49:15 tg Exp $
d24 4
a27 3
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 -DHAVE_FLOCK_DECL=1 \
		-DHAVE_ARC4RANDOM_PUSHB_DECL=1 -DHAVE_REVOKE_DECL=1 \
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1
@


1.54
log
@• check for flock decl too (weird on OSF/1: if !POSIX and BSD)
• un-experimental Tru64
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.53 2008/03/05 17:06:50 tg Exp $
d20 1
a20 1
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_FLOCK_EX=1 \
@


1.54.2.1
log
@MFC: mksh-R33d code, mksh-current dot.mkshrc
(this code is MirBSD-specific, as Build.sh is not included)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.56 2008/03/27 22:44:17 tg Exp $
d10 1
d20 1
a20 1
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_FLOCK_EX=1 -DHAVE_MKSTEMP=1 \
d24 3
a26 4
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
		-DHAVE_ARC4RANDOM_PUSHB_DECL=1 -DHAVE_FLOCK_DECL=1 \
		-DHAVE_REVOKE_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1
d28 1
d40 8
@


1.54.2.2
log
@MFC: pull up mksh-R34β since it’ll be required by MirPorts soonish…
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.59 2008/05/17 18:27:54 tg Exp $
a9 1
.if !make(test-build)
d19 5
a23 5
		-DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKSTEMP=1 \
		-DHAVE_SETLOCALE_CTYPE=1 -DHAVE_LANGINFO_CODESET=1 \
		-DHAVE_MKNOD=1 -DHAVE_REALPATH=1 -DHAVE_REVOKE=1 \
		-DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 \
		-DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
a27 1
.endif
a38 8
test-build: .PHONY
	-rm -rf build-dir
	mkdir -p build-dir
	cd build-dir; env CC=${CC:Q} CFLAGS=${CFLAGS:M*:Q} \
	    CPPFLAGS=${CPPFLAGS:M*:Q} LDFLAGS=${LDFLAGS:M*:Q} \
	    LIBS= NOWARN=-Wno-error TARGET_OS= CPP= /bin/sh \
	    ${.CURDIR}/Build.sh -Q -r && ./test.sh -v

@


1.54.2.3
log
@MFC: mksh R35
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.60 2008/06/21 19:20:15 tg Exp $
d39 1
a39 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG}
@


1.54.2.4
log
@MFC: mksh R36b
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.54.2.3 2008/07/11 11:49:23 tg Exp $
d12 3
a14 3
		-DHAVE_ATTRIBUTE=1 -DHAVE_ATTRIBUTE_BOUNDED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
d16 9
a24 10
		-DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 -DHAVE_STRINGS_H=1 \
		-DHAVE_GRP_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_STDINT_H=1 -DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 \
		-DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 \
		-DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_PUSHB=1 -DHAVE_MKNOD=1 \
		-DHAVE_MKSTEMP=1 -DHAVE_NICE=1 -DHAVE_REALPATH=1 \
		-DHAVE_REVOKE=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.53
log
@OSF/1 doesn’t seem to declare revoke(2) anywhere
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.52 2008/02/29 16:38:40 tg Exp $
d24 1
a24 1
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
@


1.52
log
@fix on Interix, where tr(1) is more weird than even Solaris’ XPG4 one…
just do not use ranges, no matter what.
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.51 2008/02/29 11:57:30 tg Exp $
d25 2
a26 2
		-DHAVE_ARC4RANDOM_PUSHB_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1
@


1.51
log
@fix passing of env var to regression tests
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.50 2007/10/25 14:43:02 tg Exp $
d38 1
a38 1
	    -e tr=tr -s ${.CURDIR}/check.t -v -p ./${PROG} -C pdksh
@


1.50
log
@be more quiet at test-build time
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.49 2007/10/14 13:36:40 tg Exp $
d38 1
a38 1
	    -s ${.CURDIR}/check.t -v -p ./${PROG} -C pdksh
@


1.49
log
@sync w/ current Build.sh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.48 2007/08/24 14:25:33 tg Exp $
d46 1
a46 1
	    ${.CURDIR}/Build.sh -r && ./test.sh -v
@


1.48
log
@revert the -std=gnu99–by–default change until programmes are ready, as this
is too much annoying (for now) – extra commit so that we have a changeset
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.47 2007/08/24 14:19:56 tg Exp $
d16 2
a17 2
		-DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 -DHAVE_STDINT_H=1 \
		-DHAVE_GRP_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
@


1.47
log
@• add -std=gnu99 to default CFLAGS
• first round of assorted fixes
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.46 2007/08/12 13:42:20 tg Exp $
d27 1
a28 1
COPTS+=		-Wall
@


1.46
log
@add “set -o arc4random”, RTFM for details
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.45 2007/07/31 11:11:23 tg Exp $
a26 1
COPTS+=		-std=gnu99 -Wall
d28 1
@


1.45
log
@• new way of checking for mknod & friends, due to tcc vs glibc weirdness
• bump vsn for the code restructuring
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.44 2007/07/01 21:47:07 tg Exp $
d20 1
a20 1
		-DHAVE_ARC4RANDOM_PUSH=1 -DHAVE_FLOCK_EX=1 \
d25 1
a25 1
		-DHAVE_ARC4RANDOM_PUSH_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
@


1.44
log
@• fix display problem
• add <libutil.h> if it exists – revoke(2) on UWIN
• add <stdlib.h> for NULL in test of mmap(2)
• regen CPPFLAGS for MirBSD native builds
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.43 2007/06/05 21:47:48 tg Exp $
d22 5
a26 4
		-DHAVE_REVOKE=1 -DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 \
		-DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 \
		-DHAVE_ARC4RANDOM_DECL=1 -DHAVE_ARC4RANDOM_PUSH_DECL=1 \
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1
@


1.43
log
@with this, we don't need the special list of pre-known signal names
any more either, and can make use of code sharing between detection
of sys_siglist and sys_signame (and the underscored variants); nuke
the now-useless signames.c file too (merge struct into histrap.c)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.42 2007/06/05 19:48:45 tg Exp $
d12 8
a19 8
		-DHAVE_ATTRIBUTE=1 -DHAVE_ATTRIBUTE_BOUNDED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_EXPSTMT=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_LIBGEN_H=1 -DHAVE_PATHS_H=1 \
		-DHAVE_STDBOOL_H=1 -DHAVE_STDINT_H=1 -DHAVE_GRP_H=1 \
		-DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 -DHAVE_RLIM_T=1 \
		-DHAVE_SIG_T=1 -DHAVE_SYS_SIGNAME=1 -DHAVE_SYS_SIGLIST=1 \
		-DHAVE_STRSIGNAL=0 -DHAVE_ARC4RANDOM=1 \
@


1.42
log
@fix for the SUNpro 8 on yofuh's E420:
cc: Sun C 5.8 Patch 121015-04 2007/01/10
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.41 2007/06/04 21:55:38 tg Exp $
d13 2
a14 2
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_EXPSTMT=1 \
		-DHAVE_SYS_PARAM_H=1 -DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
d18 8
a25 9
		-DHAVE_SIG_T=1 -DHAVE_MKSH_SIGNAME=0 -DHAVE_SYS_SIGNAME=1 \
		-DHAVE__SYS_SIGNAME=0 -DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 \
		-DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_PUSH=1 \
		-DHAVE_FLOCK_EX=1 -DHAVE_SETLOCALE_CTYPE=0 \
		-DHAVE_LANGINFO_CODESET=0 -DHAVE_REVOKE=1 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_ARC4RANDOM_DECL=1 \
		-DHAVE_ARC4RANDOM_PUSH_DECL=1 -DHAVE_SYS_SIGLIST_DECL=1 \
		-DHAVE_PERSISTENT_HISTORY=1
@


1.41
log
@sync
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.40 2007/06/04 21:27:53 tg Exp $
d13 2
a14 2
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_MMAN_H=1 \
@


1.40
log
@When compiling native MirOS BSD binaries with SUNpro 12 (don't look like a
car only slower, yes this is possible, and the resulting binary passes the
testsuite just fine), the definition of __RCSID() in <sys/cdefs.h> expands
to something with __attribute__((used)), which triggers a warning, because
__attribute__ in general is supported but the used attribute isn't. Thusly
always use our own strings and get rid of the MULTI_RCSID test (introduced
because __RCSID() on Darwin is inferiour).

Maybe we should fix <sys/cdefs.h> too? #ifdef __SUNPRO_C helps here.
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.39 2007/05/24 09:06:31 tg Exp $
d25 2
a26 2
		-DHAVE_ARC4RANDOM_PUSH_DECL=1 -DHAVE_CONFSTR_DECL=1 \
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1
@


1.39
log
@we don't have -d in mksh R30β any more
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.38 2007/04/24 10:42:02 tg Exp $
d26 1
a26 2
		-DHAVE_SYS_SIGLIST_DECL=1 -DHAVE_PERSISTENT_HISTORY=1 \
		-DHAVE_MULTI_IDSTRING=1
@


1.38
log
@• arc4random, arc4random_push: use our own protos to check
  XXX u_int32_t is not ISO C99, but seems to work well enough
  XXX if it fails anywhere, we'll see in the build logs
  XXX apple doesn't have the standard uint32_t and API doesn't specify it
• sys_siglist_defn: rename to sys_siglist_decl as we're really checking
  for the declaration in the headers; change wording to “check if … does
  not need to be declared” since we don't need to declare if we don't use
• scan for arc4random, arc4random_push, confstr declarations too
• sh.h: confstr declaration is no longer #ifdef __sun__; sort
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.37 2007/04/23 20:37:16 tg Exp $
d47 1
a47 1
	    ${.CURDIR}/Build.sh -d -r && ./test.sh -v
@


1.37
log
@AIX has sys_siglist[] but doesn't define it anywhere, so add a means to
scan for defns and use it here; bug reported by Kurt Telep
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.36 2007/04/16 18:54:37 tg Exp $
d20 7
a26 5
		-DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_PUSH=1 -DHAVE_FLOCK_EX=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_REVOKE=1 -DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 \
		-DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 \
		-DHAVE_SYS_SIGLIST_DEFN=1 -DHAVE_PERSISTENT_HISTORY=1 \
@


1.36
log
@• from a MirOS point of view:
  place most stuff from /etc/profile in /etc/skel/.mkshrc; admins must make
  sure to copy this file to users' homes on upgrade (benefit: non-login but
  interactive shells also get all the goodies); fix some quoting; simplify,
  reformat, change comments
• from an mksh point of view:
  slight internal changes in dot.mkshrc; external commands are now prefixed
  with “ulimit -c 0”; $TERM is defined; improvement in determining the host
  name (e.g. on Debian if a FQDN is not given); declare locals as such both
  in $PS1 and outside; remove superfluous quoting, quote properly; simplify
  hd alias, add rot13 alias; place RCS ID at the bottom
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.35 2007/03/04 04:36:45 tg Exp $
d24 2
a25 1
		-DHAVE_PERSISTENT_HISTORY=1 -DHAVE_MULTI_IDSTRING=1
@


1.35
log
@• Minix 3 doesn't have <sys/mman.h>
• Some OSes might need <stdint.h> for int32_t (Minix 3 with GCC)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.34 2007/03/04 03:04:23 tg Exp $
d51 4
@


1.34
log
@• remove strcasestr.c, use home-grown implementation¹, call it stricmp,
  and have it return an API-correct const char *
• enhance and stylify comments
• a little KNF and simplifications
• #ifdef DEBUG: replace strchr and strstr with ucstrchr and ucstrstr
  that take and return a non-const char *, and fix the violations
• new cstrchr, cstrstr (take and give const char *)
• new vstrchr, vstrstr (take const or not, give boolean value)
• new afreechk(x) = afreechv(x,x) = if (x1) afree(x2, ATEMP)
• new ksh_isdash(str) = (str != NULL) && !strcmp(str, "-")
• replace the only use of strrchr with inlined code to shrink
• minor man page fixes
• Minix 3 signames are autogenerated with gcc
• rename strlfun.c to strlcpy.c since we don't do strlcat(3) anyway,
  only strlcpy(3), and shorten it
• dot.mkshrc: move MKSH=… down to the export line
  to not disturb the PS1 visual impression ☺
• dot.mkshrc: Lstripcom(): optimise
• bump version

¹) side effect from creating API-correct cstrchr, cstrstr, etc.
   uses goto so it must be better ☻

tested on mirbsd-current via both Makefile and Build.sh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.33 2007/03/04 00:13:14 tg Exp $
d14 7
a20 7
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_SYSMACROS_H=0 \
		-DHAVE_LIBGEN_H=1 -DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 \
		-DHAVE_GRP_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 -DHAVE_MKSH_SIGNAME=0 \
		-DHAVE_SYS_SIGNAME=1 -DHAVE__SYS_SIGNAME=0 \
		-DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 -DHAVE_ARC4RANDOM=1 \
		-DHAVE_ARC4RANDOM_PUSH=1 -DHAVE_FLOCK_EX=1 \
d24 1
a24 1
		-DHAVE_MULTI_IDSTRING=1 -DHAVE_PERSISTENT_HISTORY=1
@


1.33
log
@merge the const branch +- a few
@
text
@d1 3
a3 1
# $MirOS$
@


1.32
log
@sync
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.31 2007/02/18 16:24:13 tg Exp $
a24 1
CDIAGFLAGS+=	-Wno-cast-qual
@


1.31
log
@• embed MKSH_ASSUME_UTF8 and MKSH_NEED_MKNOD in Build.sh
• have mksh with BSD makefiles always enable MKSH_ASSUME_UTF8
• sync BSD makefiles with Build.sh output
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.30 2007/02/10 21:59:15 tg Exp $
d22 1
a22 1
		-DHAVE_MULTI_IDSTRING=1
@


1.30
log
@add new #ifdef MKSH_ASSUME_UTF8 which saves us from needing to
call setlocale() if we know the result will always be UTF-8
@
text
@d1 3
a3 1
# $MirOS: src/bin/mksh/Makefile,v 1.29 2007/01/18 16:05:05 tg Exp $
d9 2
a10 1
CPPFLAGS+=	-DHAVE_ATTRIBUTE=1 -DHAVE_ATTRIBUTE_BOUNDED=1 \
d22 2
a23 1
		-DHAVE_MULTI_IDSTRING=1 -DMKSH_ASSUME_UTF8
@


1.29
log
@autoscan for persistent history support
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.28 2007/01/18 15:50:32 tg Exp $
d16 1
a16 1
		-DHAVE_SETLOCALE_CTYPE=1 -DHAVE_LANGINFO_CODESET=1 \
d19 1
a19 1
		-DHAVE_MULTI_IDSTRING=1
@


1.28
log
@header overhaul: replace all #ifdef __OS__ with mirtoconf checks
(except the persistent history one)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.27 2007/01/18 01:24:46 tg Exp $
d15 5
a19 4
		-DHAVE_ARC4RANDOM_PUSH=1 -DHAVE_SETLOCALE_CTYPE=1 \
		-DHAVE_LANGINFO_CODESET=1 -DHAVE_REVOKE=1 -DHAVE_SETMODE=1 \
		-DHAVE_SETRESUGID=1 -DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 \
		-DHAVE_STRLCPY=1 -DHAVE_MULTI_IDSTRING=1
@


1.27
log
@* new target 'test-build' to easily check Build.sh operation from mbsd
* regen CPPFLAGS+= stuff with 'test-build'
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.26 2007/01/17 23:27:47 tg Exp $
d9 6
a14 5
		-DHAVE_SYS_SYSMACROS_H=0 -DHAVE_LIBGEN_H=1 \
		-DHAVE_STDBOOL_H=1 -DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 \
		-DHAVE_MKSH_SIGNAME=0 -DHAVE_SYS_SIGNAME=1 \
		-DHAVE__SYS_SIGNAME=0 -DHAVE_SYS_SIGLIST=1 \
		-DHAVE_STRSIGNAL=0 -DHAVE_ARC4RANDOM=1 \
@


1.26
log
@scan for revoke()
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.25 2007/01/17 23:18:55 tg Exp $
d6 13
a18 8
CPPFLAGS+=	-DHAVE_ATTRIBUTE -DHAVE_ATTRIBUTE_BOUNDED -DHAVE_ATTRIBUTE_USED
CPPFLAGS+=	-DHAVE_SYS_PARAM_H -DHAVE_SYS_SYSMACROS_H=0 -DHAVE_LIBGEN_H
CPPFLAGS+=	-DHAVE_STDBOOL_H -DHAVE_RLIM_T
CPPFLAGS+=	-DHAVE_SYS_SIGNAME -DHAVE_SYS_SIGLIST
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH -DHAVE_SETLOCALE_CTYPE
CPPFLAGS+=	-DHAVE_LANGINFO_CODESET -DHAVE_REVOKE -DHAVE_SETMODE
CPPFLAGS+=	-DHAVE_SETRESUGID -DHAVE_SETGROUPS -DHAVE_STRCASESTR
CPPFLAGS+=	-DHAVE_STRLCPY -DHAVE_MULTI_IDSTRING
d31 7
a37 1
cleandir: clean-regress
d39 4
a42 2
clean-regress:
	-rm -rf regress-dir
@


1.25
log
@if we don't have rlim_t, assume it's long
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.24 2007/01/17 22:51:46 tg Exp $
d11 3
a13 3
CPPFLAGS+=	-DHAVE_LANGINFO_CODESET -DHAVE_SETMODE -DHAVE_SETRESUGID
CPPFLAGS+=	-DHAVE_SETGROUPS -DHAVE_STRCASESTR -DHAVE_STRLCPY
CPPFLAGS+=	-DHAVE_MULTI_IDSTRING
@


1.24
log
@* support old environments without libgen.h (ancient GNU/Linux)
  and stdbool.h (ancient GNU/Linux; NetBSD® 1.6.1)
* __dead must come after, not before, to accomodate gcc 2.7.2.3
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.23 2007/01/17 21:42:23 tg Exp $
d7 2
a8 1
CPPFLAGS+=	-DHAVE_SYS_PARAM_H -DHAVE_LIBGEN_H -DHAVE_STDBOOL_H
@


1.23
log
@check if __RCSID() can be used multiple times; req'd eg. on Mac
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.22 2007/01/12 01:11:03 tg Exp $
d7 2
a8 1
CPPFLAGS+=	-DHAVE_SYS_PARAM_H -DHAVE_SYS_SIGNAME -DHAVE_SYS_SIGLIST
@


1.22
log
@clean regress-dir before re-using
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.21 2007/01/12 00:25:39 tg Exp $
a5 1
CPPFLAGS+=	-DHAVE_SYS_PARAM_H -DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH
d7 5
a11 4
CPPFLAGS+=	-DHAVE_SETLOCALE_CTYPE -DHAVE_LANGINFO_CODESET
CPPFLAGS+=	-DHAVE_SETMODE -DHAVE_SETRESUGID -DHAVE_SETGROUPS
CPPFLAGS+=	-DHAVE_STRCASESTR -DHAVE_STRLCPY
CPPFLAGS+=	-DHAVE_SYS_SIGLIST -DHAVE_SYS_SIGNAME
@


1.22.2.1
log
@merge -rHEAD as of now into the const-correctness branch
@
text
@d1 1
a1 3
# $MirOS: src/bin/mksh/Makefile,v 1.31 2007/02/18 16:24:13 tg Exp $

.include <bsd.own.mk>
d6 6
a11 17
.if !make(test-build)
CPPFLAGS+=	-DMKSH_ASSUME_UTF8 \
		-DHAVE_ATTRIBUTE=1 -DHAVE_ATTRIBUTE_BOUNDED=1 \
		-DHAVE_ATTRIBUTE_USED=1 -DHAVE_SYS_PARAM_H=1 \
		-DHAVE_SYS_MKDEV_H=0 -DHAVE_SYS_SYSMACROS_H=0 \
		-DHAVE_LIBGEN_H=1 -DHAVE_PATHS_H=1 -DHAVE_STDBOOL_H=1 \
		-DHAVE_GRP_H=1 -DHAVE_ULIMIT_H=0 -DHAVE_VALUES_H=0 \
		-DHAVE_RLIM_T=1 -DHAVE_SIG_T=1 -DHAVE_MKSH_SIGNAME=0 \
		-DHAVE_SYS_SIGNAME=1 -DHAVE__SYS_SIGNAME=0 \
		-DHAVE_SYS_SIGLIST=1 -DHAVE_STRSIGNAL=0 -DHAVE_ARC4RANDOM=1 \
		-DHAVE_ARC4RANDOM_PUSH=1 -DHAVE_FLOCK_EX=1 \
		-DHAVE_SETLOCALE_CTYPE=0 -DHAVE_LANGINFO_CODESET=0 \
		-DHAVE_REVOKE=1 -DHAVE_SETMODE=1 -DHAVE_SETRESUGID=1 \
		-DHAVE_SETGROUPS=1 -DHAVE_STRCASESTR=1 -DHAVE_STRLCPY=1 \
		-DHAVE_MULTI_IDSTRING=1
COPTS+=		-std=gnu99 -Wall
.endif
d24 1
a24 7
test-build: .PHONY
	-rm -rf build-dir
	mkdir -p build-dir
	cd build-dir; env CC=${CC:Q} CFLAGS=${CFLAGS:M*:Q} \
	    CPPFLAGS=${CPPFLAGS:M*:Q} LDFLAGS=${LDFLAGS:M*:Q} \
	    LIBS= NOWARN=-Wno-error TARGET_OS= CPP= /bin/sh \
	    ${.CURDIR}/Build.sh -d -r && ./test.sh -v
d26 2
a27 4
cleandir: clean-extra

clean-extra: .PHONY
	-rm -rf build-dir regress-dir
@


1.22.2.2
log
@make this (almost, as before) buildable again
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.32 2007/03/03 21:48:33 tg Exp $
d22 1
a22 1
		-DHAVE_MULTI_IDSTRING=1 -DHAVE_PERSISTENT_HISTORY=1
@


1.22.2.3
log
@begin constification
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.22.2.2 2007/03/03 21:50:21 tg Exp $
d25 1
@


1.21
log
@Clean up the signal mess, saves 172 Bytes:
* 'sigseen' in Build.sh goes away
* Signal name existence is checked in this order:
  have our own¹ -> sys_signame[] -> _sys_signame[] -> build our own²
* Signal description existence is checked in this order:
  sys_siglist[] -> _sys_siglist[] -> strsignal() -> NULL³
¹ Predefined list of items, for operating systems where we
  cannot build² them, i.e. Plan 9 and Minix 3 (e.g. no $CPP -dD)
² The usual cpp(1) stuff
³ Changed later, see below
* Make $CPP test dependent on $NEED_MKSH_SIGNAME (others can
  be added here, this is not absolute)
* Make signal name list generation² dependent on $NEED_MKSH_SIGNAME
* Fix check if the generation worked
* Guarantee that sigtraps[*].name and sigtraps[*].mess are valid
  C strings; this makes the code shorter *and* removes a few pos-
  sible nil pointer dereferences
* Embed autoconf'd usages of sys_sig* / strsignal / mksh_sigpairs
  into inittraps()
* Check for each signal 0<=i<=NSIG that
  name is not NULL or "" -> replace with ("%d", i)
  mess is not NULL or "" -> replace with ("Signal %d", i)
  name does not start (case-insensitive) with "SIG" -> name += 3
* In gettrap(), fix check if signal name starts, case-sensitive
  or case-insensitive, depending on need, with "SIG" (bug from millert@@)

Other changes:
* Build.sh: ac_test[n]() are documented
* Build.sh: ac_test[n]() can have negative prereqs as well now
* Build.sh: use <<-'EOF' consistently
* bump patchlevel to today
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.20 2006/11/12 13:21:50 tg Exp $
d7 1
d18 1
@


1.20
log
@order the same way as Build.sh outputs them
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.19 2006/11/12 13:19:06 tg Exp $
d10 1
@


1.19
log
@strcasestr, oops
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.18 2006/11/12 12:56:09 tg Exp $
d6 2
a7 2
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH -DHAVE_SYS_PARAM_H
CPPFLAGS+=	-DHAVE_LANGINFO_CODESET -DHAVE_SETLOCALE_CTYPE
@


1.18
log
@scan for setresuid/setresgid and setgroups
no alternative implementation yet
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.17 2006/11/09 15:03:56 tg Exp $
d9 1
a9 1
CPPFLAGS+=	-DHAVE_STRLCPY
@


1.17
log
@missed these
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.16 2006/11/09 00:11:39 tg Exp $
d8 2
a9 1
CPPFLAGS+=	-DHAVE_SETMODE -DHAVE_STRLCPY
@


1.16
log
@* instead of including <sys/cdefs.h> (not in Solaris), we hope <sys/types.h>
  includes it for us
* autoconf-test for <sys/param.h> (not in SUSv3) existence
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.15 2006/11/08 23:45:46 tg Exp $
d8 1
a8 1
CPPFLAGS+=	-DHAVE_SETMODE -DHAVE_STRLCAT -DHAVE_STRLCPY
@


1.15
log
@implement autoconf tests for langstuff; sync date
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.14 2006/11/08 23:24:49 tg Exp $
d6 1
a6 1
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH
@


1.14
log
@fix native build
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.13 2006/11/05 12:11:13 tg Exp $
d6 2
a7 1
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH -DHAVE_LANGSTUFF
@


1.13
log
@add new "set -o utf8-hack", currently no effect
set automatically on startup if we have locale functions (on MirOS)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.12 2006/08/26 20:30:27 tg Exp $
d7 1
@


1.12
log
@use an autoconf-like approach to check for arc4random(3)
after gecko2 told me his mac recently has it and I found
out that Interix has it in -lcrypt and soon -lmirmake (:
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.11 2006/08/01 12:46:01 tg Exp $
d6 1
a6 1
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH
@


1.11
log
@remove GNUish 'check' target, we always use 'regress'
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.10 2006/07/23 19:10:59 tg Exp $
d6 1
@


1.11.2.1
log
@merge the latest results of HEAD in here
and bring back the probably-problematic
chunk with a fat comment
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.12 2006/08/26 20:30:27 tg Exp $
a5 1
CPPFLAGS+=	-DHAVE_ARC4RANDOM -DHAVE_ARC4RANDOM_PUSH
@


1.10
log
@switch /bin/sh to mksh
this at least gets us rid of a bunch of segfaults on freewrt openssl builds
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.9 2006/05/08 12:18:49 tg Exp $
a10 3
check:
	@@cd ${.CURDIR} && ${MAKE} regress V=-v

d15 1
a15 1
	    -s ${.CURDIR}/check.t ${V} -p ./${PROG} -C pdksh
@


1.9
log
@auto-test check.t:mkshrc-1 as well (verified to work)
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.8 2005/10/21 11:44:25 tg Exp $
d8 3
@


1.8
log
@remove USE_PRINTF hooks, it never worked anyway, and probably nobody
is going to fix it...
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.3 2005/05/23 14:48:21 tg Exp $
d12 9
a20 2
	perl ${.CURDIR}/check.pl -s ${.CURDIR}/check.t ${V} \
	    -p ./${PROG} -C pdksh
@


1.7
log
@fix up DEBUGLIBS and DEBUGPROGS
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.6 2005/10/08 18:53:09 tg Exp $
a7 11
.include <bsd.own.mk>

NO_PRINTF_BUILTIN=broken for now

.ifndef NO_PRINTF_BUILTIN
.PATH: ${BSDSRCDIR}/usr.bin/printf
SRCS+=		printf.c
CFLAGS_printf.o=-DBUILTIN
CPPFLAGS+=	-DUSE_PRINTF
.endif

@


1.6
log
@* bump version
* disable DEBUGPROGS
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.5 2005/08/29 01:16:22 tg Exp $
a18 2
DEBUGPROGS=	No	# objcopy can't mod /bin/mksh after install (ETXTBUSY)

@


1.5
log
@disable printf(1) builtin for now, it's broken (yet irreproducible)
probably multiple i/o redirection, or stuff like that
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.4 2005/08/26 22:03:55 tg Exp $
d19 2
@


1.4
log
@* add printf(1) as mksh(1) builtin on MirOS
  (or, more general, all systems using Makefile
  instead of Build.sh)
* document this fact
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.3 2005/05/23 14:48:21 tg Exp $
d10 2
@


1.3
log
@fix running of all tests
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.2 2005/05/23 11:59:06 tg Exp $
d8 9
@


1.2
log
@* if __CRAZY, automatically add CDIAGFLAGS, and add them AFTER our
  crazy warning options
* use it for mksh
@
text
@d1 1
a1 1
# $MirOS: src/bin/mksh/Makefile,v 1.1 2005/05/23 03:06:05 tg Exp $
d13 1
a13 1
	    -p ./${PROG} -C pdksh,sh,ksh,posix,posix-upu
@


1.1
log
@Add mirbsdksh R21, which was developed in a temporary external CVS repo-
sitory whose ChangeLog follows. mksh R21 is licenced under the MirOS li-
cence, shown in "sh.h", and a two-clause UCB-style licence by Marc Espie
as shown in "alloc.c".

This executable is a fair bit smaller and shorter than our /bin/ksh that
it is designed to eventually replace (as /bin/sh hardlink), with the old
/bin/ksh to completely vanish. It is still in beta testing though, and I
don't think it will compile on other operating systems.

mksh R21 is a completely new port, bringing together the OpenBSD-current
/bin/ksh, the MirOS-current /bin/ksh and the older mksh R20 (which still
was portable, ocvs-based).
@
text
@d1 1
a1 1
# $MirOS: mksh/Makefile,v 1.4 2005/05/23 01:10:30 tg Exp $
d6 1
@

