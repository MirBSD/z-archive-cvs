head	1.747;
access;
symbols
	mksh-R57:1.734
	mksh-R56c:1.731
	mksh-R56b:1.727
	mksh-R56:1.726
	mksh-R55:1.716
	mksh-R54:1.707
	mksh-R53a:1.702
	mksh-R53:1.702
	mksh-R52c:1.697
	mksh-R52b:1.695
	mksh-R52:1.693
	mksh-R51:1.689
	mksh-R50f:1.669.2.4
	mksh-R50e:1.669.2.2
	mksh-R50stable:1.669.0.2
	mksh-R50d:1.669
	mksh-R50c:1.668
	mksh-R50b:1.664
	mksh-R50:1.662
	mksh-R49:1.655
	mksh-R48b:1.645
	mksh-R48:1.645
	mksh-R47:1.640
	mksh-R46:1.630
	mksh-R45:1.627
	mksh-R44:1.624
	mksh-R43:1.622
	mksh-R42b:1.616
	mksh-R41c:1.590.2.10
	mksh-R41b:1.590.2.10
	mksh-R42:1.616.2.1
	mksh-R41:1.590.2.1
	mksh-R41stable:1.590.0.2
	mksh-wheezy:1.578.0.2
	tg-multikey-bind:1.566.0.2
	mksh-R40f:1.484.2.14
	mksh-R40e:1.484.2.12
	mksh-R40d:1.484.2.7
	mksh-R40c:1.484.2.4
	mksh-R40b:1.484.2.2
	mksh-R40stable:1.484.0.2
	mksh-R40:1.482
	mksh-R39c:1.443
	mksh-R39b:1.439
	tg-wcswidth-behaviour:1.430.0.2
	tg-nameref:1.423.0.2
	mksh-R39:1.419
	tg-mksh-printf-builtin:1.408.0.2
	mksh-R38c:1.401
	mksh-R38b:1.396
	mksh-R38:1.395
	mksh-R37c:1.390
	mksh-R37b:1.385
	mksh-R37:1.377
	mksh-R36b:1.373
	tg-aalloc-experimental_BASE:1.373
	tg-aalloc-experimental:1.373.0.2
	mksh-R36:1.360
	mksh-R35b:1.349
	mksh-R35:1.337
	mksh-R33d:1.313
	mksh-R33c:1.313
	mksh-R33b:1.306
	mksh-R33:1.279
	mksh-R32:1.275
	mksh-R31d:1.271
	mksh-R31c:1.265
	mksh-R31b:1.261
	mksh-R31:1.252
	mksh-R30:1.245
	mksh-R29g:1.182.2.3
	mksh-R29f:1.182.2.2
	mksh-R29e:1.182.2.1
	mksh-R29stable:1.182.0.2
	mksh-R29d:1.182
	mksh-R29c:1.169
	mksh-R29b:1.166
	mksh-R29:1.163
	mksh-R28:1.54
	tg-mksh-plan9ape_BASE:1.54
	tg-mksh-plan9ape:1.48.0.2
	mksh-R27e:1.32
	MIRBSD_9_BASE:1.30
	mksh-R27d:1.30
	mksh-R27:1.29
	mksh-R26c:1.24
	mksh-R26b:1.24
	MIRBSD_8:1.23.0.2
	MIRBSD_8_BASE:1.23
	mksh-R26:1.23
	mksh-R25:1.23
	mksh-R24c:1.17
	mksh-R24b:1.17
	mksh-R24:1.16
	mksh-R23:1.15
	mksh-R22:1.9
	mksh-R21:1.3;
locks; strict;
comment	@# @;


1.747
date	2020.01.03.21.58.50;	author tg;	state Exp;
branches;
next	1.746;
commitid	1005E0FB9077C4E4FC1;

1.746
date	2019.12.11.20.17.33;	author tg;	state Exp;
branches;
next	1.745;
commitid	1005DF14EF327C75129;

1.745
date	2019.12.11.17.59.16;	author tg;	state Exp;
branches;
next	1.744;
commitid	1005DF12E841B917499;

1.744
date	2019.09.05.14.32.04;	author tg;	state Exp;
branches;
next	1.743;
commitid	1005D711C181C287E6D;

1.743
date	2019.08.15.02.15.13;	author tg;	state Exp;
branches;
next	1.742;
commitid	1005D54C01111A5FCF7;

1.742
date	2019.08.01.22.08.55;	author tg;	state Exp;
branches;
next	1.741;
commitid	1005D4362B11380DB05;

1.741
date	2019.08.01.19.53.05;	author tg;	state Exp;
branches;
next	1.740;
commitid	1005D4343341AD34425;

1.740
date	2019.07.25.21.25.15;	author tg;	state Exp;
branches;
next	1.739;
commitid	1005D3A1E333A088C0B;

1.739
date	2019.07.25.17.11.00;	author tg;	state Exp;
branches;
next	1.738;
commitid	1005D39E29553B05155;

1.738
date	2019.04.26.16.17.01;	author tg;	state Exp;
branches;
next	1.737;
commitid	1005CC32F1753020661;

1.737
date	2019.04.26.15.53.15;	author tg;	state Exp;
branches;
next	1.736;
commitid	1005CC3297203E801D6;

1.736
date	2019.04.09.16.19.52;	author tg;	state Exp;
branches;
next	1.735;
commitid	1005CACC64175064243;

1.735
date	2019.04.09.16.15.41;	author tg;	state Exp;
branches;
next	1.734;
commitid	1005CACC5185EDD7FF9;

1.734
date	2019.03.01.16.18.13;	author tg;	state Exp;
branches;
next	1.733;
commitid	1005C795B5E18CB9829;

1.733
date	2018.12.12.10.41.23;	author tg;	state Exp;
branches;
next	1.732;
commitid	1005C10E5E87909E6FC;

1.732
date	2018.01.25.12.33.54;	author tg;	state Exp;
branches;
next	1.731;
commitid	1005A69CEB041DAB77B;

1.731
date	2018.01.13.21.38.06;	author tg;	state Exp;
branches;
next	1.730;
commitid	1005A5A7C0944B414C1;

1.730
date	2018.01.05.20.05.26;	author tg;	state Exp;
branches;
next	1.729;
commitid	1005A4FDA9B62BDBB88;

1.729
date	2017.12.22.18.36.21;	author tg;	state Exp;
branches;
next	1.728;
commitid	1005A3D509B6D447A6C;

1.728
date	2017.12.22.16.29.58;	author tg;	state Exp;
branches;
next	1.727;
commitid	1005A3D330845A04109;

1.727
date	2017.08.29.13.38.28;	author tg;	state Exp;
branches;
next	1.726;
commitid	10059A56E5C5EA2D5AB;

1.726
date	2017.08.07.20.40.56;	author tg;	state Exp;
branches;
next	1.725;
commitid	1005988D0430B222211;

1.725
date	2017.05.15.13.35.38;	author tg;	state Exp;
branches;
next	1.724;
commitid	1005919AEB37ADD1A52;

1.724
date	2017.05.05.22.59.36;	author tg;	state Exp;
branches;
next	1.723;
commitid	100590D03EC7D4B3D65;

1.723
date	2017.05.03.14.51.14;	author tg;	state Exp;
branches;
next	1.722;
commitid	1005909EE7C16B07DC3;

1.722
date	2017.05.03.13.00.09;	author tg;	state Exp;
branches;
next	1.721;
commitid	1005909D44A1764451B;

1.721
date	2017.05.01.20.03.25;	author tg;	state Exp;
branches;
next	1.720;
commitid	100590794A1560667FC;

1.720
date	2017.05.01.19.22.53;	author tg;	state Exp;
branches;
next	1.719;
commitid	10059078B1C3EDAB114;

1.719
date	2017.04.29.14.36.12;	author tg;	state Exp;
branches;
next	1.718;
commitid	1005904A4EC64ED4A4D;

1.718
date	2017.04.28.02.24.53;	author tg;	state Exp;
branches;
next	1.717;
commitid	1005902A8007F54B819;

1.717
date	2017.04.28.00.27.48;	author tg;	state Exp;
branches;
next	1.716;
commitid	10059028C897645EBDD;

1.716
date	2017.04.12.18.33.22;	author tg;	state Exp;
branches;
next	1.715;
commitid	10058EE730B10091C4D;

1.715
date	2017.04.12.16.01.44;	author tg;	state Exp;
branches;
next	1.714;
commitid	10058EE4F791111D6F8;

1.714
date	2017.04.12.15.23.31;	author tg;	state Exp;
branches;
next	1.713;
commitid	10058EE468D6BDD61E8;

1.713
date	2017.04.03.02.08.56;	author tg;	state Exp;
branches;
next	1.712;
commitid	10058E1AEC63BB0CE23;

1.712
date	2017.04.02.15.00.39;	author tg;	state Exp;
branches;
next	1.711;
commitid	10058E1121E64BBAB7B;

1.711
date	2017.04.02.14.14.03;	author tg;	state Exp;
branches;
next	1.710;
commitid	10058E106EA70D8ABF7;

1.710
date	2017.04.02.13.38.01;	author tg;	state Exp;
branches;
next	1.709;
commitid	10058E0FEB71C12075B;

1.709
date	2017.03.17.23.47.05;	author tg;	state Exp;
branches;
next	1.708;
commitid	10058CC758B1EAA28E9;

1.708
date	2017.02.18.02.33.08;	author tg;	state Exp;
branches;
next	1.707;
commitid	10058A7B271530B4CED;

1.707
date	2016.11.11.23.31.29;	author tg;	state Exp;
branches;
next	1.706;
commitid	100582654B972655F84;

1.706
date	2016.11.07.16.55.51;	author tg;	state Exp;
branches;
next	1.705;
commitid	1005820B2244EF6EB22;

1.705
date	2016.09.01.12.59.04;	author tg;	state Exp;
branches;
next	1.704;
commitid	10057C8260A04757349;

1.704
date	2016.08.25.16.21.28;	author tg;	state Exp;
branches;
next	1.703;
commitid	10057BF1B1D101BE102;

1.703
date	2016.08.24.20.50.11;	author tg;	state Exp;
branches;
next	1.702;
commitid	10057BE0897213CAEE7;

1.702
date	2016.08.10.18.20.16;	author tg;	state Exp;
branches;
next	1.701;
commitid	10057AB70790ACA1487;

1.701
date	2016.07.27.00.55.26;	author tg;	state Exp;
branches;
next	1.700;
commitid	100579806802F9D6BB9;

1.700
date	2016.07.25.21.05.18;	author tg;	state Exp;
branches;
next	1.699;
commitid	10057967F184AB0E82A;

1.699
date	2016.07.25.00.04.35;	author tg;	state Exp;
branches;
next	1.698;
commitid	1005795579F14A3FE5C;

1.698
date	2016.06.25.23.49.12;	author tg;	state Exp;
branches;
next	1.697;
commitid	100576F188B17A582E9;

1.697
date	2016.03.04.18.28.39;	author tg;	state Exp;
branches;
next	1.696;
commitid	10056D9D3E84E42085B;

1.696
date	2016.01.21.18.24.33;	author tg;	state Exp;
branches;
next	1.695;
commitid	10056A12268001BF859;

1.695
date	2016.01.02.20.11.31;	author tg;	state Exp;
branches;
next	1.694;
commitid	10056882EF909114576;

1.694
date	2015.12.31.21.16.20;	author tg;	state Exp;
branches;
next	1.693;
commitid	10056859B3358F13E1A;

1.693
date	2015.12.12.22.25.10;	author tg;	state Exp;
branches;
next	1.692;
commitid	100566C9EDD3DC6C239;

1.692
date	2015.12.08.20.59.33;	author tg;	state Exp;
branches;
next	1.691;
commitid	100566744C51EAE46FA;

1.691
date	2015.10.05.17.58.55;	author tg;	state Exp;
branches;
next	1.690;
commitid	1005612BA62412FC278;

1.690
date	2015.09.05.19.18.59;	author tg;	state Exp;
branches;
next	1.689;
commitid	10055EB402C54C3076B;

1.689
date	2015.07.10.17.16.23;	author tg;	state Exp;
branches;
next	1.688;
commitid	100559FFD2F76B8C225;

1.688
date	2015.07.09.20.52.34;	author tg;	state Exp;
branches;
next	1.687;
commitid	100559EDF161DEE9DD2;

1.687
date	2015.07.09.20.11.44;	author tg;	state Exp;
branches;
next	1.686;
commitid	100559ED592471E50AC;

1.686
date	2015.07.09.19.59.13;	author tg;	state Exp;
branches;
next	1.685;
commitid	100559ED2A65B6AF321;

1.685
date	2015.07.09.19.46.40;	author tg;	state Exp;
branches;
next	1.684;
commitid	100559ECFAC4F39D69B;

1.684
date	2015.07.09.19.28.17;	author tg;	state Exp;
branches;
next	1.683;
commitid	100559ECB63048E9D39;

1.683
date	2015.07.09.19.19.09;	author tg;	state Exp;
branches;
next	1.682;
commitid	100559EC93854E741C4;

1.682
date	2015.07.09.19.04.28;	author tg;	state Exp;
branches;
next	1.681;
commitid	100559EC5C615118572;

1.681
date	2015.07.06.17.48.28;	author tg;	state Exp;
branches;
next	1.680;
commitid	100559ABF230C8CC8EB;

1.680
date	2015.07.05.15.45.16;	author tg;	state Exp;
branches;
next	1.679;
commitid	100559951194B011855;

1.679
date	2015.05.01.16.08.26;	author tg;	state Exp;
branches;
next	1.678;
commitid	1005543A50960B8D4D1;

1.678
date	2015.04.29.20.44.31;	author tg;	state Exp;
branches;
next	1.677;
commitid	100554142C5624212CA;

1.677
date	2015.04.29.20.39.00;	author tg;	state Exp;
branches;
next	1.676;
commitid	100554141715BD350D6;

1.676
date	2015.04.29.20.13.46;	author tg;	state Exp;
branches;
next	1.675;
commitid	10055413B917A56A81D;

1.675
date	2015.04.29.18.38.50;	author tg;	state Exp;
branches;
next	1.674;
commitid	100554125524190E2D8;

1.674
date	2015.04.19.18.50.35;	author tg;	state Exp;
branches;
next	1.673;
commitid	1005533F8D6407346B7;

1.673
date	2015.04.11.23.28.16;	author tg;	state Exp;
branches;
next	1.672;
commitid	1005529AD8D33CF99B9;

1.672
date	2014.12.08.12.20.40;	author tg;	state Exp;
branches;
next	1.671;
commitid	100548597A713CD6746;

1.671
date	2014.11.25.21.13.18;	author tg;	state Exp;
branches;
next	1.670;
commitid	1005474F00E09321C83;

1.670
date	2014.11.25.20.00.36;	author tg;	state Exp;
branches;
next	1.669;
commitid	1005474DFFB1DC897E5;

1.669
date	2014.10.07.15.22.12;	author tg;	state Exp;
branches
	1.669.2.1;
next	1.668;
commitid	1005434053135366996;

1.668
date	2014.10.03.17.32.07;	author tg;	state Exp;
branches;
next	1.667;
commitid	100542EDD596FD5FBF9;

1.667
date	2014.10.03.17.19.26;	author tg;	state Exp;
branches;
next	1.666;
commitid	100542EDAB6504F28CB;

1.666
date	2014.09.29.18.57.00;	author tg;	state Exp;
branches;
next	1.665;
commitid	1005429AB95374C5947;

1.665
date	2014.09.04.23.06.51;	author tg;	state Exp;
branches;
next	1.664;
commitid	1005408F09E40F0355D;

1.664
date	2014.09.03.19.22.48;	author tg;	state Exp;
branches;
next	1.663;
commitid	10054076A8136C0C0D1;

1.663
date	2014.07.04.11.03.52;	author tg;	state Exp;
branches;
next	1.662;
commitid	10053B68A3021537F8C;

1.662
date	2014.06.29.10.56.08;	author tg;	state Exp;
branches;
next	1.661;
commitid	10053AFF0D4591AB932;

1.661
date	2014.06.24.20.47.40;	author tg;	state Exp;
branches;
next	1.660;
commitid	10053A9E3FD4EC55000;

1.660
date	2014.06.09.13.25.49;	author tg;	state Exp;
branches;
next	1.659;
commitid	1005395B5803902C8E9;

1.659
date	2014.05.27.13.41.53;	author tg;	state Exp;
branches;
next	1.658;
commitid	100538496257FDA8BD8;

1.658
date	2014.05.27.13.22.41;	author tg;	state Exp;
branches;
next	1.657;
commitid	1005384911C31753F0C;

1.657
date	2014.03.28.12.08.25;	author tg;	state Exp;
branches;
next	1.656;
commitid	1005335664B7E0E7786;

1.656
date	2014.02.08.20.20.17;	author tg;	state Exp;
branches;
next	1.655;
commitid	10052F6919867F476EA;

1.655
date	2014.01.05.21.57.21;	author tg;	state Exp;
branches;
next	1.654;
commitid	10052C9D445413B34DF;

1.654
date	2013.12.02.19.47.33;	author tg;	state Exp;
branches;
next	1.653;
commitid	100529CE3E15D49FA9E;

1.653
date	2013.11.30.17.41.31;	author tg;	state Exp;
branches;
next	1.652;
commitid	100529A23520014334E;

1.652
date	2013.11.30.15.42.18;	author tg;	state Exp;
branches;
next	1.651;
commitid	100529A075F29C695AE;

1.651
date	2013.11.20.21.14.49;	author tg;	state Exp;
branches;
next	1.650;
commitid	100528D26524CF1F1DE;

1.650
date	2013.11.17.22.22.50;	author tg;	state Exp;
branches;
next	1.649;
commitid	100528941C810C8A893;

1.649
date	2013.11.17.22.21.16;	author tg;	state Exp;
branches;
next	1.648;
commitid	100528941705C91094F;

1.648
date	2013.10.31.20.05.38;	author tg;	state Exp;
branches;
next	1.647;
commitid	1005272B7081B0E5655;

1.647
date	2013.09.10.17.32.56;	author tg;	state Exp;
branches;
next	1.646;
commitid	100522F57C13E265FDE;

1.646
date	2013.08.23.14.07.32;	author tg;	state Exp;
branches;
next	1.645;
commitid	10052176CB912FE954B;

1.645
date	2013.08.10.13.44.25;	author tg;	state Exp;
branches;
next	1.644;
commitid	100520643B4127D9BCA;

1.644
date	2013.07.25.17.01.03;	author tg;	state Exp;
branches;
next	1.643;
commitid	10051F159DE5C95CF5A;

1.643
date	2013.07.25.15.54.33;	author tg;	state Exp;
branches;
next	1.642;
commitid	10051F14A3A7C2E9F40;

1.642
date	2013.07.25.15.43.59;	author tg;	state Exp;
branches;
next	1.641;
commitid	10051F147D85557878E;

1.641
date	2013.07.25.15.36.18;	author tg;	state Exp;
branches;
next	1.640;
commitid	10051F1460A5D83D9C0;

1.640
date	2013.07.21.18.47.14;	author tg;	state Exp;
branches;
next	1.639;
commitid	10051EC2CBD68BDF6A5;

1.639
date	2013.07.08.10.12.45;	author tg;	state Exp;
branches;
next	1.638;
commitid	10051DA90B43C8F0571;

1.638
date	2013.06.03.22.27.15;	author tg;	state Exp;
branches;
next	1.637;
commitid	10051AD185B26F65812;

1.637
date	2013.06.02.03.09.11;	author tg;	state Exp;
branches;
next	1.636;
commitid	10051AAB6AE4E828507;

1.636
date	2013.05.31.23.27.11;	author tg;	state Exp;
branches;
next	1.635;
commitid	10051A931CB73794C1D;

1.635
date	2013.05.22.19.24.32;	author tg;	state Exp;
branches;
next	1.634;
commitid	100519D1B8441837E8B;

1.634
date	2013.05.22.18.56.50;	author tg;	state Exp;
branches;
next	1.633;
commitid	100519D14F66467253E;

1.633
date	2013.05.08.11.30.45;	author tg;	state Exp;
branches;
next	1.632;
commitid	100518A377D38E239B1;

1.632
date	2013.05.08.11.16.17;	author tg;	state Exp;
branches;
next	1.631;
commitid	100518A34193FAA8C4B;

1.631
date	2013.05.05.13.38.00;	author tg;	state Exp;
branches;
next	1.630;
commitid	100518660932889602A;

1.630
date	2013.05.02.21.59.44;	author tg;	state Exp;
branches;
next	1.629;
commitid	1005182E1E55272FF6B;

1.629
date	2013.05.02.20.21.36;	author tg;	state Exp;
branches;
next	1.628;
commitid	1005182CAE814B1B129;

1.628
date	2013.04.27.18.12.37;	author tg;	state Exp;
branches;
next	1.627;
commitid	100517C152C6C287552;

1.627
date	2013.04.26.21.22.39;	author tg;	state Exp;
branches;
next	1.626;
commitid	100517AEF6C22DD1AE7;

1.626
date	2013.04.26.19.40.07;	author tg;	state Exp;
branches;
next	1.625;
commitid	100517AD81849062C68;

1.625
date	2013.03.24.00.56.17;	author tg;	state Exp;
branches;
next	1.624;
commitid	100514E4F1D5C90862C;

1.624
date	2013.03.05.15.41.39;	author tg;	state Exp;
branches;
next	1.623;
commitid	1005136124A171442C9;

1.623
date	2013.02.23.20.03.25;	author tg;	state Exp;
branches;
next	1.622;
commitid	1005129208E57646522;

1.622
date	2013.02.19.18.45.15;	author tg;	state Exp;
branches;
next	1.621;
commitid	1005123C815760131DF;

1.621
date	2013.02.18.22.55.35;	author tg;	state Exp;
branches;
next	1.620;
commitid	1005122B16E6B48945B;

1.620
date	2013.02.17.07.06.15;	author tg;	state Exp;
branches;
next	1.619;
commitid	1005120817E574CC123;

1.619
date	2013.02.17.05.40.11;	author tg;	state Exp;
branches;
next	1.618;
commitid	10051206D50560C037D;

1.618
date	2013.02.16.17.55.51;	author tg;	state Exp;
branches;
next	1.617;
commitid	100511FC81525949AF7;

1.617
date	2013.02.16.00.21.55;	author tg;	state Exp;
branches;
next	1.616;
commitid	100511ED11C146CFC01;

1.616
date	2013.02.11.16.27.56;	author tg;	state Exp;
branches
	1.616.2.1;
next	1.615;
commitid	10051191BFF08BD28F0;

1.615
date	2013.02.10.21.20.57;	author tg;	state Exp;
branches;
next	1.614;
commitid	10051180F522D816E87;

1.614
date	2013.02.10.18.17.28;	author tg;	state Exp;
branches;
next	1.613;
commitid	1005117E43D0E3438DA;

1.613
date	2013.01.12.02.25.01;	author tg;	state Exp;
branches;
next	1.612;
commitid	10050F0C9702926C312;

1.612
date	2013.01.01.21.19.36;	author tg;	state Exp;
branches;
next	1.611;
commitid	10050E352F23B706399;

1.611
date	2012.12.28.04.58.13;	author tg;	state Exp;
branches;
next	1.610;
commitid	10050DD26F130A0DA53;

1.610
date	2012.12.28.03.35.33;	author tg;	state Exp;
branches;
next	1.609;
commitid	10050DD139C31612F17;

1.609
date	2012.12.28.03.20.34;	author tg;	state Exp;
branches;
next	1.608;
commitid	10050DD101A4F012982;

1.608
date	2012.12.28.03.05.17;	author tg;	state Exp;
branches;
next	1.607;
commitid	10050DD0C8519194AE9;

1.607
date	2012.12.28.02.28.29;	author tg;	state Exp;
branches;
next	1.606;
commitid	10050DD03E43C678B81;

1.606
date	2012.12.27.15.52.47;	author tg;	state Exp;
branches;
next	1.605;
commitid	10050DC6EE7414F88E8;

1.605
date	2012.12.24.17.50.10;	author tg;	state Exp;
branches;
next	1.604;
commitid	10050D895C311FB947A;

1.604
date	2012.12.22.00.03.37;	author tg;	state Exp;
branches;
next	1.603;
commitid	10050D4F8C95001AF1D;

1.603
date	2012.12.17.23.31.30;	author tg;	state Exp;
branches;
next	1.602;
commitid	10050CFAB6A290F8382;

1.602
date	2012.12.17.23.18.01;	author tg;	state Exp;
branches;
next	1.601;
commitid	10050CFA81334F40D7F;

1.601
date	2012.12.17.22.57.49;	author tg;	state Exp;
branches;
next	1.600;
commitid	10050CFA37459E35D3F;

1.600
date	2012.12.17.22.14.24;	author tg;	state Exp;
branches;
next	1.599;
commitid	10050CF9958429136E1;

1.599
date	2012.12.17.21.55.04;	author tg;	state Exp;
branches;
next	1.598;
commitid	10050CF94C775867203;

1.598
date	2012.12.05.19.38.05;	author tg;	state Exp;
branches;
next	1.597;
commitid	10050BFA2B54D772FB3;

1.597
date	2012.12.03.22.10.02;	author tg;	state Exp;
branches;
next	1.596;
commitid	10050BD22C502F97B97;

1.596
date	2012.12.03.13.07.11;	author tg;	state Exp;
branches;
next	1.595;
commitid	10050BCA41766DA29C2;

1.595
date	2012.12.01.14.22.09;	author tg;	state Exp;
branches;
next	1.594;
commitid	10050BA12A9448DDD09;

1.594
date	2012.12.01.01.36.16;	author tg;	state Exp;
branches;
next	1.593;
commitid	10050B95F03690E9DEE;

1.593
date	2012.11.30.22.17.32;	author tg;	state Exp;
branches;
next	1.592;
commitid	10050B93094425CEC11;

1.592
date	2012.11.30.20.49.16;	author tg;	state Exp;
branches;
next	1.591;
commitid	10050B91BDD34E31558;

1.591
date	2012.11.30.20.19.09;	author tg;	state Exp;
branches;
next	1.590;
commitid	10050B914D41435E735;

1.590
date	2012.11.20.18.50.41;	author tg;	state Exp;
branches
	1.590.2.1;
next	1.589;
commitid	10050ABD11751603401;

1.589
date	2012.10.22.20.19.08;	author tg;	state Exp;
branches;
next	1.588;
commitid	1005085AA537A17A752;

1.588
date	2012.10.22.16.53.20;	author tg;	state Exp;
branches;
next	1.587;
commitid	10050857A0A617725BC;

1.587
date	2012.10.21.17.38.21;	author tg;	state Exp;
branches;
next	1.586;
commitid	100508433245EAC86CE;

1.586
date	2012.10.14.14.02.10;	author tg;	state Exp;
branches;
next	1.585;
commitid	100507AC5FA49432D4F;

1.585
date	2012.10.03.17.24.13;	author tg;	state Exp;
branches;
next	1.584;
commitid	100506C74D35719B33B;

1.584
date	2012.09.28.18.57.49;	author tg;	state Exp;
branches;
next	1.583;
commitid	1005065F3450337663B;

1.583
date	2012.09.27.18.23.43;	author tg;	state Exp;
branches;
next	1.582;
commitid	100506499941EC578A6;

1.582
date	2012.09.18.14.18.59;	author tg;	state Exp;
branches;
next	1.581;
commitid	100505882EB3C148611;

1.581
date	2012.08.24.19.09.09;	author tg;	state Exp;
branches;
next	1.580;
commitid	1005037D16D4D0C81CC;

1.580
date	2012.08.03.18.16.43;	author tg;	state Exp;
branches;
next	1.579;
commitid	100501C15A301E6824D;

1.579
date	2012.07.01.15.54.49;	author tg;	state Exp;
branches;
next	1.578;
commitid	1004FF072DE3F1A3116;

1.578
date	2012.07.01.15.51.24;	author tg;	state Exp;
branches
	1.578.2.1;
next	1.577;
commitid	1004FF0720D63425C4E;

1.577
date	2012.06.28.20.17.33;	author tg;	state Exp;
branches;
next	1.576;
commitid	1004FECBBF10FC5C93C;

1.576
date	2012.06.26.19.33.29;	author tg;	state Exp;
branches;
next	1.575;
commitid	1004FEA0E9F218104F1;

1.575
date	2012.06.26.19.15.11;	author tg;	state Exp;
branches;
next	1.574;
commitid	1004FEA0A4923E1165D;

1.574
date	2012.06.25.16.05.06;	author tg;	state Exp;
branches;
next	1.573;
commitid	1004FE88C477BD00898;

1.573
date	2012.06.24.20.47.07;	author tg;	state Exp;
branches;
next	1.572;
commitid	1004FE77CD86FA77C95;

1.572
date	2012.06.24.20.46.07;	author tg;	state Exp;
branches;
next	1.571;
commitid	1004FE77C9F5037C65C;

1.571
date	2012.05.18.01.38.04;	author tg;	state Exp;
branches;
next	1.570;
commitid	1004FB5A80A37378531;

1.570
date	2012.05.17.19.36.41;	author tg;	state Exp;
branches;
next	1.569;
commitid	1004FB553600397D80E;

1.569
date	2012.05.17.19.14.07;	author tg;	state Exp;
branches;
next	1.568;
commitid	1004FB54DEF3662B61F;

1.568
date	2012.05.17.18.54.28;	author tg;	state Exp;
branches;
next	1.567;
commitid	1004FB5496F5DF8FA06;

1.567
date	2012.05.09.23.20.42;	author tg;	state Exp;
branches;
next	1.566;
commitid	1004FAAFBE14FB50BBC;

1.566
date	2012.05.07.17.03.03;	author tg;	state Exp;
branches;
next	1.565;
commitid	1004FA8000112B6602D;

1.565
date	2012.05.06.15.40.31;	author tg;	state Exp;
branches;
next	1.564;
commitid	1004FA69B732BF657A4;

1.564
date	2012.05.05.17.37.42;	author tg;	state Exp;
branches;
next	1.563;
commitid	1004FA5657C4457F07B;

1.563
date	2012.05.04.22.34.49;	author tg;	state Exp;
branches;
next	1.562;
commitid	1004FA4598C7DB8428A;

1.562
date	2012.05.04.22.18.22;	author tg;	state Exp;
branches;
next	1.561;
commitid	1004FA455C411397094;

1.561
date	2012.05.04.22.04.58;	author tg;	state Exp;
branches;
next	1.560;
commitid	1004FA452A16C9E34E1;

1.560
date	2012.05.04.21.57.36;	author tg;	state Exp;
branches;
next	1.559;
commitid	1004FA450E704CFDFF0;

1.559
date	2012.05.04.21.42.50;	author tg;	state Exp;
branches;
next	1.558;
commitid	1004FA44D7024BF2AB1;

1.558
date	2012.05.04.21.37.08;	author tg;	state Exp;
branches;
next	1.557;
commitid	1004FA44C1B3D1F77B2;

1.557
date	2012.05.04.21.34.12;	author tg;	state Exp;
branches;
next	1.556;
commitid	1004FA44B6B0FB9EB24;

1.556
date	2012.05.04.21.33.14;	author tg;	state Exp;
branches;
next	1.555;
commitid	1004FA44B316BC0EE38;

1.555
date	2012.05.04.21.30.06;	author tg;	state Exp;
branches;
next	1.554;
commitid	1004FA44A7060EB6B5D;

1.554
date	2012.05.04.21.28.06;	author tg;	state Exp;
branches;
next	1.553;
commitid	1004FA449C67A9AD826;

1.553
date	2012.05.04.20.49.00;	author tg;	state Exp;
branches;
next	1.552;
commitid	1004FA4409A67B135DE;

1.552
date	2012.04.27.16.16.19;	author tg;	state Exp;
branches;
next	1.551;
commitid	1004F9AC66A708942C6;

1.551
date	2012.04.16.17.49.40;	author tg;	state Exp;
branches;
next	1.550;
commitid	1004F8C5BB26AB58BBE;

1.550
date	2012.04.14.19.35.43;	author tg;	state Exp;
branches;
next	1.549;
commitid	1004F89D19F46B121A8;

1.549
date	2012.04.14.16.07.43;	author tg;	state Exp;
branches;
next	1.548;
commitid	1004F89A0D311D70891;

1.548
date	2012.04.14.14.11.07;	author tg;	state Exp;
branches;
next	1.547;
commitid	1004F89859248CF525A;

1.547
date	2012.04.14.14.07.45;	author tg;	state Exp;
branches;
next	1.546;
commitid	1004F8984C858E8C9F2;

1.546
date	2012.04.14.14.04.13;	author tg;	state Exp;
branches;
next	1.545;
commitid	1004F8983F46AA27222;

1.545
date	2012.04.14.14.02.39;	author tg;	state Exp;
branches;
next	1.544;
commitid	1004F89836C6359BA94;

1.544
date	2012.04.08.20.02.33;	author tg;	state Exp;
branches;
next	1.543;
commitid	1004F81EEF07E3B7E50;

1.543
date	2012.04.07.11.19.45;	author tg;	state Exp;
branches;
next	1.542;
commitid	1004F8022E670BC1C0E;

1.542
date	2012.04.06.23.10.50;	author tg;	state Exp;
branches;
next	1.541;
commitid	1004F7F780C31C894F7;

1.541
date	2012.04.06.15.20.41;	author tg;	state Exp;
branches;
next	1.540;
commitid	1004F7F096867C83CF0;

1.540
date	2012.04.06.15.03.42;	author tg;	state Exp;
branches;
next	1.539;
commitid	1004F7F05E56B217A5D;

1.539
date	2012.04.06.13.25.51;	author tg;	state Exp;
branches;
next	1.538;
commitid	1004F7EEEE854E70C61;

1.538
date	2012.04.06.12.59.25;	author tg;	state Exp;
branches;
next	1.537;
commitid	1004F7EE8B85815EBA4;

1.537
date	2012.04.06.12.57.53;	author tg;	state Exp;
branches;
next	1.536;
commitid	1004F7EE85B52944147;

1.536
date	2012.04.01.17.48.24;	author tg;	state Exp;
branches;
next	1.535;
commitid	1004F7894E36DD2F52B;

1.535
date	2012.04.01.17.17.45;	author tg;	state Exp;
branches;
next	1.534;
commitid	1004F788DAC064A3EA5;

1.534
date	2012.04.01.16.55.15;	author tg;	state Exp;
branches;
next	1.533;
commitid	1004F78886806E0931E;

1.533
date	2012.04.01.16.40.26;	author tg;	state Exp;
branches;
next	1.532;
commitid	1004F78851116DFACAB;

1.532
date	2012.04.01.04.57.24;	author tg;	state Exp;
branches;
next	1.531;
commitid	1004F77E01E6C246924;

1.531
date	2012.04.01.02.35.33;	author tg;	state Exp;
branches;
next	1.530;
commitid	1004F77BE8F370E45E8;

1.530
date	2012.03.31.18.33.16;	author tg;	state Exp;
branches;
next	1.529;
commitid	1004F774E03191E0794;

1.529
date	2012.03.31.17.42.58;	author tg;	state Exp;
branches;
next	1.528;
commitid	1004F77422D0771AA93;

1.528
date	2012.03.31.17.37.03;	author tg;	state Exp;
branches;
next	1.527;
commitid	1004F77403C56153627;

1.527
date	2012.03.30.10.24.45;	author tg;	state Exp;
branches;
next	1.526;
commitid	1004F758A0479912EB3;

1.526
date	2012.03.30.09.27.19;	author tg;	state Exp;
branches;
next	1.525;
commitid	1004F757C8D124C8DF2;

1.525
date	2012.03.29.19.22.54;	author tg;	state Exp;
branches;
next	1.524;
commitid	1004F74B525291EF6DE;

1.524
date	2012.03.28.11.15.04;	author tg;	state Exp;
branches;
next	1.523;
commitid	1004F72F2C03D40F901;

1.523
date	2012.03.28.11.14.20;	author tg;	state Exp;
branches;
next	1.522;
commitid	1004F72F2A22718F5F9;

1.522
date	2012.03.28.11.13.45;	author tg;	state Exp;
branches;
next	1.521;
commitid	1004F72F26A0F0E90E5;

1.521
date	2012.03.27.23.13.40;	author tg;	state Exp;
branches;
next	1.520;
commitid	1004F7249BA2221FCA0;

1.520
date	2012.03.27.23.01.51;	author tg;	state Exp;
branches;
next	1.519;
commitid	1004F7246F73A5DADD7;

1.519
date	2012.03.27.22.41.16;	author tg;	state Exp;
branches;
next	1.518;
commitid	1004F72421C16F52F81;

1.518
date	2012.03.27.22.36.48;	author tg;	state Exp;
branches;
next	1.517;
commitid	1004F7240673EAD3A5A;

1.517
date	2012.03.27.21.23.50;	author tg;	state Exp;
branches;
next	1.516;
commitid	1004F722FB133BECAE5;

1.516
date	2012.03.27.21.01.55;	author tg;	state Exp;
branches;
next	1.515;
commitid	1004F722AD0347A4BA4;

1.515
date	2012.03.26.20.14.58;	author tg;	state Exp;
branches;
next	1.514;
commitid	1004F70CE5966910746;

1.514
date	2012.03.26.19.54.54;	author tg;	state Exp;
branches;
next	1.513;
commitid	1004F70C9A53478D6F9;

1.513
date	2012.03.26.19.48.06;	author tg;	state Exp;
branches;
next	1.512;
commitid	1004F70C80D7AD1B9F3;

1.512
date	2012.03.03.21.30.13;	author tg;	state Exp;
branches;
next	1.511;
commitid	1004F528D751182BBC8;

1.511
date	2012.03.03.19.27.07;	author tg;	state Exp;
branches;
next	1.510;
commitid	1004F5270A22AA50744;

1.510
date	2012.02.17.13.59.56;	author tg;	state Exp;
branches;
next	1.509;
commitid	1004F3E5D734914F7A8;

1.509
date	2012.02.17.09.49.45;	author tg;	state Exp;
branches;
next	1.508;
commitid	1004F3E22A54F12FDE4;

1.508
date	2012.01.04.08.56.27;	author tg;	state Exp;
branches;
next	1.507;
commitid	1004F041451130192F8;

1.507
date	2012.01.03.16.14.39;	author tg;	state Exp;
branches;
next	1.506;
commitid	1004F0329860E277B09;

1.506
date	2012.01.03.16.03.22;	author tg;	state Exp;
branches;
next	1.505;
commitid	1004F0326E12B3630AE;

1.505
date	2012.01.03.01.40.13;	author tg;	state Exp;
branches;
next	1.504;
commitid	1004F025C8A70617D83;

1.504
date	2012.01.03.01.30.16;	author tg;	state Exp;
branches;
next	1.503;
commitid	1004F025A2E0A6286CC;

1.503
date	2012.01.03.00.58.06;	author tg;	state Exp;
branches;
next	1.502;
commitid	1004F025261140919C7;

1.502
date	2011.12.31.02.54.15;	author tg;	state Exp;
branches;
next	1.501;
commitid	1004EFE796B294601A5;

1.501
date	2011.12.31.02.04.16;	author tg;	state Exp;
branches;
next	1.500;
commitid	1004EFE6D783E94B328;

1.500
date	2011.12.31.00.31.25;	author tg;	state Exp;
branches;
next	1.499;
commitid	1004EFE57F5523BDD4C;

1.499
date	2011.12.18.02.20.09;	author tg;	state Exp;
branches;
next	1.498;
commitid	1004EED4DB31D0E8494;

1.498
date	2011.12.10.14.16.09;	author tg;	state Exp;
branches;
next	1.497;
commitid	1004EE369C02D9A705D;

1.497
date	2011.12.08.22.19.03;	author tg;	state Exp;
branches;
next	1.496;
commitid	1004EE137ED7AAC8DC0;

1.496
date	2011.12.08.22.16.42;	author tg;	state Exp;
branches;
next	1.495;
commitid	1004EE137486198F3D9;

1.495
date	2011.12.04.19.59.33;	author tg;	state Exp;
branches;
next	1.494;
commitid	1004EDBD1266A61D50A;

1.494
date	2011.12.04.19.38.36;	author tg;	state Exp;
branches;
next	1.493;
commitid	1004EDBCC4F00F825FC;

1.493
date	2011.12.03.00.01.26;	author tg;	state Exp;
branches;
next	1.492;
commitid	1004ED966E04423C3DF;

1.492
date	2011.12.02.22.55.45;	author tg;	state Exp;
branches;
next	1.491;
commitid	1004ED9575E20B9B002;

1.491
date	2011.11.26.17.56.29;	author tg;	state Exp;
branches;
next	1.490;
commitid	1004ED12855386724F1;

1.490
date	2011.11.25.23.29.30;	author tg;	state Exp;
branches;
next	1.489;
commitid	1004ED0249F2884E13A;

1.489
date	2011.11.05.23.39.01;	author tg;	state Exp;
branches;
next	1.488;
commitid	1004EB5C91C1FD111AE;

1.488
date	2011.10.07.19.51.41;	author tg;	state Exp;
branches;
next	1.487;
commitid	1004E8F58646396DFB2;

1.487
date	2011.08.26.10.24.51;	author tg;	state Exp;
branches;
next	1.486;
commitid	1004E57748A0697426D;

1.486
date	2011.08.26.10.20.28;	author tg;	state Exp;
branches;
next	1.485;
commitid	1004E5773825C0DF1F3;

1.485
date	2011.07.16.18.03.04;	author tg;	state Exp;
branches;
next	1.484;
commitid	1004E21D26C11A6B90C;

1.484
date	2011.07.07.21.24.51;	author tg;	state Exp;
branches
	1.484.2.1;
next	1.483;
commitid	1004E16241A43F1A588;

1.483
date	2011.06.12.15.54.42;	author tg;	state Exp;
branches;
next	1.482;
commitid	1004DF4E15A3F3ECFF2;

1.482
date	2011.06.12.14.37.00;	author tg;	state Exp;
branches;
next	1.481;
commitid	1004DF4CF2331923406;

1.481
date	2011.06.05.19.55.22;	author tg;	state Exp;
branches;
next	1.480;
commitid	1004DEBDF41262D0695;

1.480
date	2011.06.05.18.23.43;	author tg;	state Exp;
branches;
next	1.479;
commitid	1004DEBC9BD415E0E89;

1.479
date	2011.06.05.18.16.19;	author tg;	state Exp;
branches;
next	1.478;
commitid	1004DEBC80A5D475DC9;

1.478
date	2011.05.29.16.31.38;	author tg;	state Exp;
branches;
next	1.477;
commitid	1004DE274F9085CC4DD;

1.477
date	2011.04.09.21.00.58;	author tg;	state Exp;
branches;
next	1.476;
commitid	1004DA0C9186AA3EA10;

1.476
date	2011.04.09.15.14.51;	author tg;	state Exp;
branches;
next	1.475;
commitid	1004DA077823393B1E0;

1.475
date	2011.03.28.21.15.04;	author tg;	state Exp;
branches;
next	1.474;
commitid	1004D90FA4606EFF9E3;

1.474
date	2011.03.16.20.26.33;	author tg;	state Exp;
branches;
next	1.473;
commitid	1004D811CB27C272DCB;

1.473
date	2011.03.16.20.03.21;	author tg;	state Exp;
branches;
next	1.472;
commitid	1004D81178B44C2A337;

1.472
date	2011.02.27.19.29.18;	author tg;	state Exp;
branches;
next	1.471;
commitid	1004D6AA624642CC00C;

1.471
date	2011.02.11.00.49.03;	author tg;	state Exp;
branches;
next	1.470;
commitid	1004D5487841D1E5AC7;

1.470
date	2011.02.09.19.32.26;	author tg;	state Exp;
branches;
next	1.469;
commitid	1004D52EBE13E0DE6A5;

1.469
date	2011.01.30.02.18.19;	author tg;	state Exp;
branches;
next	1.468;
commitid	1004D44CA581AA49FF9;

1.468
date	2011.01.30.01.35.29;	author tg;	state Exp;
branches;
next	1.467;
commitid	1004D44C07439762D63;

1.467
date	2011.01.29.19.07.15;	author tg;	state Exp;
branches;
next	1.466;
commitid	1004D44657A0535F27E;

1.466
date	2011.01.21.20.51.56;	author tg;	state Exp;
branches;
next	1.465;
commitid	1004D39F1FE32530F7C;

1.465
date	2011.01.15.21.56.36;	author tg;	state Exp;
branches;
next	1.464;
commitid	1004D321809401703DB;

1.464
date	2010.12.12.14.06.35;	author tg;	state Exp;
branches;
next	1.463;
commitid	1004D04D6F360C188AB;

1.463
date	2010.10.08.17.56.55;	author tg;	state Exp;
branches;
next	1.462;
commitid	1004CAF5B5A6D74E1C9;

1.462
date	2010.10.01.19.04.35;	author tg;	state Exp;
branches;
next	1.461;
commitid	1004CA6307E2EE8E957;

1.461
date	2010.09.14.21.26.04;	author tg;	state Exp;
branches;
next	1.460;
commitid	1004C8FE654576B0E25;

1.460
date	2010.09.14.21.15.09;	author tg;	state Exp;
branches;
next	1.459;
commitid	1004C8FE5D57435CE69;

1.459
date	2010.08.24.15.46.06;	author tg;	state Exp;
branches;
next	1.458;
commitid	1004C73E9557B394B09;

1.458
date	2010.08.24.15.19.52;	author tg;	state Exp;
branches;
next	1.457;
commitid	1004C73E31577F0CD63;

1.457
date	2010.08.15.00.43.55;	author tg;	state Exp;
branches;
next	1.456;
commitid	1004C67384A285452DB;

1.456
date	2010.08.15.00.41.05;	author tg;	state Exp;
branches;
next	1.455;
commitid	1004C6737A539B6643B;

1.455
date	2010.07.18.17.29.49;	author tg;	state Exp;
branches;
next	1.454;
commitid	1004C4339F54CCC5B85;

1.454
date	2010.07.04.17.45.10;	author tg;	state Exp;
branches;
next	1.453;
commitid	1004C30C8946816B0C1;

1.453
date	2010.07.04.17.33.53;	author tg;	state Exp;
branches;
next	1.452;
commitid	1004C30C5ED28DF693B;

1.452
date	2010.05.13.18.41.13;	author tg;	state Exp;
branches;
next	1.451;
commitid	1004BEC4622270F1C27;

1.451
date	2010.04.20.17.28.20;	author tg;	state Exp;
branches;
next	1.450;
commitid	1004BCDE44A713F7C1F;

1.450
date	2010.03.30.13.29.03;	author tg;	state Exp;
branches;
next	1.449;
commitid	1004BB1FCAE6AB35B5A;

1.449
date	2010.03.27.20.36.25;	author tg;	state Exp;
branches;
next	1.448;
commitid	1004BAE6C4B05F1BFE4;

1.448
date	2010.03.27.15.32.58;	author tg;	state Exp;
branches;
next	1.447;
commitid	1004BAE25367BF23130;

1.447
date	2010.03.27.15.28.59;	author tg;	state Exp;
branches;
next	1.446;
commitid	1004BAE244B09562919;

1.446
date	2010.03.14.11.58.29;	author tg;	state Exp;
branches;
next	1.445;
commitid	1004B9CCF5B34BE8F30;

1.445
date	2010.03.14.11.56.07;	author tg;	state Exp;
branches;
next	1.444;
commitid	1004B9CCEDB7691A65B;

1.444
date	2010.03.01.08.57.45;	author tg;	state Exp;
branches;
next	1.443;
commitid	1004B8B81972BA30FE7;

1.443
date	2010.02.23.22.02.35;	author tg;	state Exp;
branches;
next	1.442;
commitid	1004B84508D664F9D7E;

1.442
date	2010.02.23.22.02.19;	author tg;	state Exp;
branches;
next	1.441;
commitid	1004B845076088ECDB1;

1.441
date	2010.02.18.17.21.19;	author tg;	state Exp;
branches;
next	1.440;
commitid	1004B7D77167AE38192;

1.440
date	2010.02.16.23.53.28;	author tg;	state Exp;
branches;
next	1.439;
commitid	1004B7B2FAB4CF0BF95;

1.439
date	2010.01.28.19.46.53;	author tg;	state Exp;
branches;
next	1.438;
commitid	1004B61E9C41D80C758;

1.438
date	2010.01.28.17.03.22;	author tg;	state Exp;
branches;
next	1.437;
commitid	1004B61C34F33F773ED;

1.437
date	2010.01.28.15.12.34;	author tg;	state Exp;
branches;
next	1.436;
commitid	1004B61A9654C03FFAB;

1.436
date	2010.01.25.12.16.04;	author tg;	state Exp;
branches;
next	1.435;
commitid	1004B5D8B8718835B48;

1.435
date	2010.01.19.14.26.24;	author tg;	state Exp;
branches;
next	1.434;
commitid	1004B55C1162FFA875D;

1.434
date	2010.01.01.18.27.42;	author tg;	state Exp;
branches;
next	1.433;
commitid	1004B3E3EAB53C27BB7;

1.433
date	2009.12.12.22.27.02;	author tg;	state Exp;
branches;
next	1.432;
commitid	1004B2418AF282F4231;

1.432
date	2009.12.12.21.17.25;	author tg;	state Exp;
branches;
next	1.431;
commitid	1004B24086932E5CB01;

1.431
date	2009.12.05.16.19.59;	author tg;	state Exp;
branches;
next	1.430;
commitid	1004B1A883C2E15B1B0;

1.430
date	2009.10.27.16.59.59;	author tg;	state Exp;
branches;
next	1.429;
commitid	1004AE726F77A03CF56;

1.429
date	2009.10.16.18.51.30;	author tg;	state Exp;
branches;
next	1.428;
commitid	1004AD8C08D68586B2B;

1.428
date	2009.10.16.18.45.31;	author tg;	state Exp;
branches;
next	1.427;
commitid	1004AD8BF3761358CA6;

1.427
date	2009.10.15.16.50.21;	author tg;	state Exp;
branches;
next	1.426;
commitid	1004AD752CA09995875;

1.426
date	2009.10.15.12.58.34;	author tg;	state Exp;
branches;
next	1.425;
commitid	1004AD71C6168FA0A7A;

1.425
date	2009.09.24.17.15.28;	author tg;	state Exp;
branches;
next	1.424;
commitid	1004ABBA8D95908292B;

1.424
date	2009.09.23.18.22.37;	author tg;	state Exp;
branches;
next	1.423;
commitid	1004ABA67775B112BE0;

1.423
date	2009.08.30.13.22.37;	author tg;	state Exp;
branches;
next	1.422;
commitid	1004A9A7CF57ABC87F3;

1.422
date	2009.08.28.17.37.47;	author tg;	state Exp;
branches;
next	1.421;
commitid	1004A9815CF780125A2;

1.421
date	2009.08.08.13.52.35;	author tg;	state Exp;
branches;
next	1.420;
commitid	1004A7D833502419D27;

1.420
date	2009.08.08.13.08.48;	author tg;	state Exp;
branches;
next	1.419;
commitid	1004A7D785D73D49CFA;

1.419
date	2009.08.01.21.58.06;	author tg;	state Stab;
branches;
next	1.418;
commitid	1004A74BA811362AE45;

1.418
date	2009.08.01.21.52.02;	author tg;	state Exp;
branches;
next	1.417;
commitid	1004A74B9016DC9B993;

1.417
date	2009.08.01.21.51.24;	author tg;	state Exp;
branches;
next	1.416;
commitid	1004A74B8E0418E2BBD;

1.416
date	2009.08.01.20.58.07;	author tg;	state Exp;
branches;
next	1.415;
commitid	1004A74AC6174DFFAEB;

1.415
date	2009.08.01.20.29.02;	author tg;	state Exp;
branches;
next	1.414;
commitid	1004A74A59D29C42A6F;

1.414
date	2009.08.01.14.12.13;	author tg;	state Exp;
branches;
next	1.413;
commitid	1004A744D4E620293AA;

1.413
date	2009.07.30.19.11.09;	author tg;	state Exp;
branches;
next	1.412;
commitid	1004A71F04C54EFD9CF;

1.412
date	2009.07.25.21.31.23;	author tg;	state Exp;
branches;
next	1.411;
commitid	1004A6B79B87CB15A8B;

1.411
date	2009.07.25.20.52.39;	author tg;	state Exp;
branches;
next	1.410;
commitid	1004A6B70886FFC8C3F;

1.410
date	2009.07.25.20.18.13;	author tg;	state Exp;
branches;
next	1.409;
commitid	1004A6B688A1A8581CB;

1.409
date	2009.07.25.20.04.09;	author tg;	state Exp;
branches;
next	1.408;
commitid	1004A6B65431B11B7B1;

1.408
date	2009.07.19.14.59.40;	author tg;	state Exp;
branches;
next	1.407;
commitid	1004A6334B046F4362D;

1.407
date	2009.07.07.20.36.58;	author tg;	state Exp;
branches;
next	1.406;
commitid	1004A53B1F71B90A43F;

1.406
date	2009.07.07.18.42.47;	author tg;	state Exp;
branches;
next	1.405;
commitid	1004A5397307EAE755A;

1.405
date	2009.07.07.18.39.51;	author tg;	state Exp;
branches;
next	1.404;
commitid	1004A53967131407010;

1.404
date	2009.07.07.18.38.49;	author tg;	state Exp;
branches;
next	1.403;
commitid	1004A5396451C4F4738;

1.403
date	2009.07.07.18.34.21;	author tg;	state Exp;
branches;
next	1.402;
commitid	1004A53953C5366E00B;

1.402
date	2009.06.10.21.25.39;	author tg;	state Exp;
branches;
next	1.401;
commitid	1004A3024D87198BDA0;

1.401
date	2009.06.08.20.52.28;	author tg;	state Stab;
branches;
next	1.400;
commitid	1004A2D79BE067C2178;

1.400
date	2009.06.08.20.34.37;	author tg;	state Exp;
branches;
next	1.399;
commitid	1004A2D75D22EFFE1BD;

1.399
date	2009.06.07.22.26.00;	author tg;	state Exp;
branches;
next	1.398;
commitid	1004A2C3E733F86B5BD;

1.398
date	2009.06.07.22.21.39;	author tg;	state Exp;
branches;
next	1.397;
commitid	1004A2C3D786C3D3264;

1.397
date	2009.06.07.14.50.58;	author tg;	state Exp;
branches;
next	1.396;
commitid	1004A2BD3C0513CE064;

1.396
date	2009.05.29.14.41.37;	author tg;	state Stab;
branches;
next	1.395;
commitid	1004A1FF39A784E6A72;

1.395
date	2009.05.27.09.58.20;	author tg;	state Stab;
branches;
next	1.394;
commitid	1004A1D0E9B4EF3C493;

1.394
date	2009.05.20.10.10.35;	author tg;	state Exp;
branches;
next	1.393;
commitid	1004A13D729362C9EB2;

1.393
date	2009.05.16.18.40.03;	author tg;	state Stab;
branches;
next	1.392;
commitid	1004A0F087409E93A5D;

1.392
date	2009.05.16.16.59.31;	author tg;	state Exp;
branches;
next	1.391;
commitid	1004A0EF0664EF4168D;

1.391
date	2009.04.10.16.09.53;	author tg;	state Exp;
branches;
next	1.390;
commitid	10049DF6F583161454B;

1.390
date	2009.04.07.18.41.32;	author tg;	state Exp;
branches;
next	1.389;
commitid	10049DB9E493037411A;

1.389
date	2009.04.06.08.37.42;	author tg;	state Exp;
branches;
next	1.388;
commitid	10049D9BF3E06207517;

1.388
date	2009.04.06.08.33.36;	author tg;	state Exp;
branches;
next	1.387;
commitid	10049D9BE5254CE65B8;

1.387
date	2009.04.06.08.29.21;	author tg;	state Exp;
branches;
next	1.386;
commitid	10049D9BD7131CD41B8;

1.386
date	2009.04.06.08.24.57;	author tg;	state Exp;
branches;
next	1.385;
commitid	10049D9BC6513710654;

1.385
date	2009.04.05.13.07.06;	author tg;	state Exp;
branches;
next	1.384;
commitid	10049D8AD116C7C031D;

1.384
date	2009.04.05.12.35.28;	author tg;	state Exp;
branches;
next	1.383;
commitid	10049D8A5A72FBB1A39;

1.383
date	2009.04.05.12.21.14;	author tg;	state Exp;
branches;
next	1.382;
commitid	10049D8A25010264CDB;

1.382
date	2009.04.03.10.56.32;	author tg;	state Exp;
branches;
next	1.381;
commitid	10049D5EB7824AB9CF0;

1.381
date	2009.04.03.09.45.22;	author tg;	state Exp;
branches;
next	1.380;
commitid	10049D5DAB828D70A55;

1.380
date	2009.04.03.09.42.37;	author tg;	state Exp;
branches;
next	1.379;
commitid	10049D5DA256479EF9B;

1.379
date	2009.04.03.09.39.01;	author tg;	state Exp;
branches;
next	1.378;
commitid	10049D5D94A2E5145F0;

1.378
date	2009.03.29.17.50.45;	author tg;	state Exp;
branches;
next	1.377;
commitid	10049CFB50738812C26;

1.377
date	2009.03.23.08.54.12;	author tg;	state Exp;
branches;
next	1.376;
commitid	10049C74E2A2A02080F;

1.376
date	2009.03.22.16.55.37;	author tg;	state Exp;
branches;
next	1.375;
commitid	10049C66D5D5A75A28F;

1.375
date	2008.12.31.16.09.51;	author tg;	state Exp;
branches;
next	1.374;
commitid	100495B994937CBC03F;

1.374
date	2008.12.20.20.39.05;	author tg;	state Exp;
branches;
next	1.373;
commitid	100494D57CB69634B87;

1.373
date	2008.11.13.00.36.07;	author tg;	state Exp;
branches
	1.373.2.1;
next	1.372;
commitid	100491B768E3195A968;

1.372
date	2008.11.12.07.36.18;	author tg;	state Exp;
branches;
next	1.371;
commitid	100491A872A75670F3C;

1.371
date	2008.11.11.23.20.08;	author tg;	state Exp;
branches;
next	1.370;
commitid	100491A132045248D21;

1.370
date	2008.11.11.21.52.51;	author tg;	state Exp;
branches;
next	1.369;
commitid	1004919FEA95976F767;

1.369
date	2008.11.10.20.25.04;	author tg;	state Exp;
branches;
next	1.368;
commitid	1004918989929A80B7B;

1.368
date	2008.11.08.17.36.35;	author tg;	state Exp;
branches;
next	1.367;
commitid	1004915CDEC427B69F6;

1.367
date	2008.11.02.23.06.36;	author tg;	state Exp;
branches;
next	1.366;
commitid	100490E328A7E63E4EC;

1.366
date	2008.11.02.22.29.34;	author tg;	state Exp;
branches;
next	1.365;
commitid	100490E29A42BDC6B59;

1.365
date	2008.10.30.17.11.14;	author tg;	state Exp;
branches;
next	1.364;
commitid	1004909EAC02C00339A;

1.364
date	2008.10.28.14.32.36;	author tg;	state Exp;
branches;
next	1.363;
commitid	1004907226D3DEFCCD1;

1.363
date	2008.10.26.21.57.47;	author ahoka;	state Exp;
branches;
next	1.362;
commitid	1004904E76663B09B34;

1.362
date	2008.10.26.21.51.25;	author ahoka;	state Exp;
branches;
next	1.361;
commitid	1004904E5B13CEB9815;

1.361
date	2008.10.25.12.58.41;	author tg;	state Exp;
branches;
next	1.360;
commitid	100490317DE66CA83B0;

1.360
date	2008.10.24.21.35.21;	author tg;	state Exp;
branches;
next	1.359;
commitid	10049023FA84B717FCE;

1.359
date	2008.10.24.20.01.42;	author tg;	state Exp;
branches;
next	1.358;
commitid	100490229A83E958700;

1.358
date	2008.10.24.19.59.54;	author tg;	state Exp;
branches;
next	1.357;
commitid	1004902294813A63361;

1.357
date	2008.10.24.19.55.35;	author tg;	state Exp;
branches;
next	1.356;
commitid	10049022842071F423B;

1.356
date	2008.10.24.19.55.06;	author tg;	state Exp;
branches;
next	1.355;
commitid	1004902281D678A776A;

1.355
date	2008.10.20.19.29.22;	author tg;	state Exp;
branches;
next	1.354;
commitid	10048FCDBAF5C7D98EB;

1.354
date	2008.10.10.21.57.16;	author tg;	state Exp;
branches;
next	1.353;
commitid	10048EFCFBD0010B755;

1.353
date	2008.10.10.21.36.04;	author tg;	state Exp;
branches;
next	1.352;
commitid	10048EFCACB366CDC00;

1.352
date	2008.10.04.19.13.22;	author tg;	state Exp;
branches;
next	1.351;
commitid	10048E7C03236190056;

1.351
date	2008.09.30.17.34.25;	author tg;	state Exp;
branches;
next	1.350;
commitid	10048E263160B0D9F56;

1.350
date	2008.07.21.21.00.25;	author tg;	state Exp;
branches;
next	1.349;
commitid	1004884F8FF426BF19F;

1.349
date	2008.07.18.11.42.52;	author tg;	state Exp;
branches;
next	1.348;
commitid	100488081C942369D8F;

1.348
date	2008.07.18.11.34.20;	author tg;	state Exp;
branches;
next	1.347;
commitid	10048807FCE20B3AF11;

1.347
date	2008.07.17.15.17.46;	author tg;	state Exp;
branches;
next	1.346;
commitid	100487F62AC53EA50ED;

1.346
date	2008.07.17.14.50.24;	author tg;	state Exp;
branches;
next	1.345;
commitid	100487F5C3555AC45FC;

1.345
date	2008.07.15.23.44.51;	author tg;	state Exp;
branches;
next	1.344;
commitid	100487D358B287B38B2;

1.344
date	2008.07.15.20.54.47;	author tg;	state Exp;
branches;
next	1.343;
commitid	100487D0E8A71805FC9;

1.343
date	2008.07.14.15.06.02;	author tg;	state Exp;
branches;
next	1.342;
commitid	100487B6B71520D6AA0;

1.342
date	2008.07.14.14.59.20;	author tg;	state Exp;
branches;
next	1.341;
commitid	100487B69A834DCFFFF;

1.341
date	2008.07.14.14.40.47;	author tg;	state Exp;
branches;
next	1.340;
commitid	100487B65750A676A5B;

1.340
date	2008.07.13.16.43.54;	author tg;	state Exp;
branches;
next	1.339;
commitid	100487A30D56F4B2E1B;

1.339
date	2008.07.11.19.51.22;	author tg;	state Exp;
branches;
next	1.338;
commitid	1004877B9A442EF6CF3;

1.338
date	2008.07.11.18.31.10;	author tg;	state Exp;
branches;
next	1.337;
commitid	1004877A6F64068B0E9;

1.337
date	2008.07.10.18.55.43;	author tg;	state Exp;
branches;
next	1.336;
commitid	10048765B3E61D211C7;

1.336
date	2008.07.10.18.49.22;	author tg;	state Exp;
branches;
next	1.335;
commitid	100487659BC1CE1C464;

1.335
date	2008.07.08.21.14.42;	author tg;	state Exp;
branches;
next	1.334;
commitid	1004873D8C94AB17991;

1.334
date	2008.07.08.21.05.01;	author tg;	state Exp;
branches;
next	1.333;
commitid	1004873D654382DA840;

1.333
date	2008.07.06.23.19.31;	author tg;	state Exp;
branches;
next	1.332;
commitid	100487153133820B42C;

1.332
date	2008.06.29.19.46.56;	author tg;	state Exp;
branches;
next	1.331;
commitid	1004867E6BF1CF4CB67;

1.331
date	2008.06.29.18.18.56;	author tg;	state Exp;
branches;
next	1.330;
commitid	1004867D21C0B3C3E6D;

1.330
date	2008.06.29.18.08.55;	author tg;	state Exp;
branches;
next	1.329;
commitid	1004867CFC62496FBF0;

1.329
date	2008.06.28.23.00.43;	author tg;	state Exp;
branches;
next	1.328;
commitid	1004866C2A918DC517D;

1.328
date	2008.06.22.20.51.31;	author tg;	state Exp;
branches;
next	1.327;
commitid	100485EBB6457B0281F;

1.327
date	2008.06.21.19.38.41;	author tg;	state Exp;
branches;
next	1.326;
commitid	100485D589C74E3E5FF;

1.326
date	2008.06.21.19.20.14;	author tg;	state Exp;
branches;
next	1.325;
commitid	100485D546D2A4FC22F;

1.325
date	2008.05.20.18.47.06;	author tg;	state Exp;
branches;
next	1.324;
commitid	10048331C8D4AD5D1CA;

1.324
date	2008.05.17.18.27.53;	author tg;	state Exp;
branches;
next	1.323;
commitid	100482F238341D5E08C;

1.323
date	2008.05.17.18.19.11;	author tg;	state Exp;
branches;
next	1.322;
commitid	100482F21AD13DAA384;

1.322
date	2008.05.13.00.08.12;	author tg;	state Exp;
branches;
next	1.321;
commitid	1004828DBF236DC406C;

1.321
date	2008.05.11.14.47.04;	author tg;	state Exp;
branches;
next	1.320;
commitid	100482706CF4DC3421A;

1.320
date	2008.05.10.03.16.07;	author tg;	state Exp;
branches;
next	1.319;
commitid	1004825133715611188;

1.319
date	2008.05.04.01.59.44;	author tg;	state Exp;
branches;
next	1.318;
commitid	100481D18A278423D59;

1.318
date	2008.05.04.01.58.14;	author tg;	state Exp;
branches;
next	1.317;
commitid	100481D183D7217B8F3;

1.317
date	2008.05.04.01.51.28;	author tg;	state Exp;
branches;
next	1.316;
commitid	100481D16AF3E4A7EEA;

1.316
date	2008.05.04.00.55.18;	author tg;	state Exp;
branches;
next	1.315;
commitid	100481D095467650914;

1.315
date	2008.04.20.02.15.12;	author tg;	state Exp;
branches;
next	1.314;
commitid	100480AA7400A110D7D;

1.314
date	2008.04.19.22.15.00;	author tg;	state Exp;
branches;
next	1.313;
commitid	100480A6CC85EC0197B;

1.313
date	2008.04.02.16.55.05;	author tg;	state Exp;
branches;
next	1.312;
commitid	10047F3BA6A180846DA;

1.312
date	2008.04.01.20.40.20;	author tg;	state Exp;
branches;
next	1.311;
commitid	10047F29D740D1FD5B8;

1.311
date	2008.04.01.17.25.36;	author tg;	state Exp;
branches;
next	1.310;
commitid	10047F270227C3BD64A;

1.310
date	2008.04.01.17.22.53;	author tg;	state Exp;
branches;
next	1.309;
commitid	10047F26F7E1E387A7C;

1.309
date	2008.04.01.17.14.31;	author tg;	state Exp;
branches;
next	1.308;
commitid	10047F26D883A136279;

1.308
date	2008.04.01.17.13.49;	author tg;	state Exp;
branches;
next	1.307;
commitid	10047F26D565E768CA8;

1.307
date	2008.03.28.22.56.15;	author tg;	state Exp;
branches;
next	1.306;
commitid	10047ED778348F249D9;

1.306
date	2008.03.28.14.04.23;	author tg;	state Exp;
branches;
next	1.305;
commitid	10047ECFAEE481801E1;

1.305
date	2008.03.28.13.55.11;	author tg;	state Exp;
branches;
next	1.304;
commitid	10047ECF8C924D450FC;

1.304
date	2008.03.27.22.44.16;	author tg;	state Exp;
branches;
next	1.303;
commitid	10047EC2345229AB68B;

1.303
date	2008.03.27.22.17.01;	author tg;	state Exp;
branches;
next	1.302;
commitid	10047EC1CCB4B4615B8;

1.302
date	2008.03.27.17.59.27;	author tg;	state Exp;
branches;
next	1.301;
commitid	10047EBE08B0311C6DE;

1.301
date	2008.03.27.17.55.31;	author tg;	state Exp;
branches;
next	1.300;
commitid	10047EBDF964BAA8B7B;

1.300
date	2008.03.27.13.08.37;	author tg;	state Exp;
branches;
next	1.299;
commitid	10047EB9C596A91F2CC;

1.299
date	2008.03.25.21.34.42;	author tg;	state Exp;
branches;
next	1.298;
commitid	10047E96EF5608C6FD5;

1.298
date	2008.03.25.20.25.27;	author tg;	state Exp;
branches;
next	1.297;
commitid	10047E95FC426A37819;

1.297
date	2008.03.23.21.53.36;	author tg;	state Exp;
branches;
next	1.296;
commitid	10047E6D12B527257DB;

1.296
date	2008.03.23.20.55.17;	author tg;	state Exp;
branches;
next	1.295;
commitid	10047E6C3B86E22471A;

1.295
date	2008.03.23.20.21.24;	author tg;	state Exp;
branches;
next	1.294;
commitid	10047E6BBCB2D6200F4;

1.294
date	2008.03.23.20.19.26;	author tg;	state Exp;
branches;
next	1.293;
commitid	10047E6BB5E5D7C0072;

1.293
date	2008.03.14.21.34.55;	author tg;	state Exp;
branches;
next	1.292;
commitid	10047DAEF8D410FBB1F;

1.292
date	2008.03.06.18.12.58;	author tg;	state Exp;
branches;
next	1.291;
commitid	10047D034367D9CDE00;

1.291
date	2008.03.06.18.02.33;	author tg;	state Exp;
branches;
next	1.290;
commitid	10047D031C8226F86C6;

1.290
date	2008.03.05.19.59.27;	author tg;	state Exp;
branches;
next	1.289;
commitid	10047CEFBA247589E3D;

1.289
date	2008.03.05.19.14.19;	author tg;	state Exp;
branches;
next	1.288;
commitid	10047CEF1060B0EE1E2;

1.288
date	2008.03.05.18.49.14;	author tg;	state Exp;
branches;
next	1.287;
commitid	10047CEEB2D48891B08;

1.287
date	2008.03.05.18.25.57;	author tg;	state Exp;
branches;
next	1.286;
commitid	10047CEE5CC68C1832F;

1.286
date	2008.03.05.18.21.44;	author tg;	state Exp;
branches;
next	1.285;
commitid	10047CEE3A0658866A1;

1.285
date	2008.03.05.17.52.43;	author tg;	state Exp;
branches;
next	1.284;
commitid	10047CEDE0131923274;

1.284
date	2008.03.05.17.30.10;	author tg;	state Exp;
branches;
next	1.283;
commitid	10047CED8A765958DF9;

1.283
date	2008.03.05.17.12.08;	author tg;	state Exp;
branches;
next	1.282;
commitid	10047CED4623E989284;

1.282
date	2008.03.05.17.06.49;	author tg;	state Exp;
branches;
next	1.281;
commitid	10047CED336427DBA32;

1.281
date	2008.03.05.17.00.33;	author tg;	state Exp;
branches;
next	1.280;
commitid	10047CED1A662B56C99;

1.280
date	2008.03.03.19.40.08;	author tg;	state Exp;
branches;
next	1.279;
commitid	10047CC4E30646C42ED;

1.279
date	2008.03.01.15.07.50;	author tg;	state Rel;
branches;
next	1.278;
commitid	10047C9714F2EFF1FA7;

1.278
date	2008.02.29.16.38.40;	author tg;	state Exp;
branches;
next	1.277;
commitid	10047C8350F6BECB74A;

1.277
date	2008.02.29.11.57.30;	author tg;	state Exp;
branches;
next	1.276;
commitid	10047C7F33F1FB9D756;

1.276
date	2008.02.29.11.48.31;	author tg;	state Exp;
branches;
next	1.275;
commitid	10047C7F11E25C9D944;

1.275
date	2007.10.25.15.23.08;	author tg;	state Exp;
branches;
next	1.274;
commitid	1004720B4ED147A8549;

1.274
date	2007.10.25.14.26.52;	author tg;	state Exp;
branches;
next	1.273;
commitid	1004720A7B12AC914F2;

1.273
date	2007.10.25.14.18.55;	author tg;	state Exp;
branches;
next	1.272;
commitid	1004720A5D93951F8E8;

1.272
date	2007.10.15.21.09.51;	author tg;	state Exp;
branches;
next	1.271;
commitid	1004713D70A5362BACF;

1.271
date	2007.10.14.13.31.01;	author tg;	state Exp;
branches;
next	1.270;
commitid	10047121A2C6F29438E;

1.270
date	2007.10.10.11.42.24;	author tg;	state Exp;
branches;
next	1.269;
commitid	100470CBAB0459BE429;

1.269
date	2007.10.10.11.32.49;	author tg;	state Exp;
branches;
next	1.268;
commitid	100470CB75C5D6064BB;

1.268
date	2007.10.09.14.29.42;	author tg;	state Exp;
branches;
next	1.267;
commitid	100470B903141342E3B;

1.267
date	2007.10.09.14.21.54;	author tg;	state Exp;
branches;
next	1.266;
commitid	100470B8E4D3F899082;

1.266
date	2007.09.21.10.46.56;	author tg;	state Exp;
branches;
next	1.265;
commitid	10046F3A13761372D0F;

1.265
date	2007.09.11.18.38.29;	author tg;	state Exp;
branches;
next	1.264;
commitid	10046E6E0B66867941E;

1.264
date	2007.09.11.18.12.16;	author tg;	state Exp;
branches;
next	1.263;
commitid	10046E6D6B74D0333E1;

1.263
date	2007.09.11.17.49.57;	author tg;	state Exp;
branches;
next	1.262;
commitid	10046E6D55266F5D3C0;

1.262
date	2007.09.11.17.47.25;	author tg;	state Exp;
branches;
next	1.261;
commitid	10046E6D4B47AFE639A;

1.261
date	2007.09.10.20.16.47;	author tg;	state Exp;
branches;
next	1.260;
commitid	10046E5A6255D8174EE;

1.260
date	2007.09.09.19.24.58;	author tg;	state Exp;
branches;
next	1.259;
commitid	10046E448623FFE86FC;

1.259
date	2007.09.09.18.31.41;	author tg;	state Exp;
branches;
next	1.258;
commitid	10046E43C242B4A87F4;

1.258
date	2007.09.09.18.30.04;	author tg;	state Exp;
branches;
next	1.257;
commitid	10046E43BBD3FF0A0C8;

1.257
date	2007.09.09.18.21.52;	author tg;	state Exp;
branches;
next	1.256;
commitid	10046E439D369E976E3;

1.256
date	2007.09.09.12.02.38;	author tg;	state Exp;
branches;
next	1.255;
commitid	10046E3E0EB6CD2EE96;

1.255
date	2007.09.09.11.55.44;	author tg;	state Exp;
branches;
next	1.254;
commitid	10046E3DF4C25CF15C7;

1.254
date	2007.09.09.11.04.30;	author tg;	state Exp;
branches;
next	1.253;
commitid	10046E3D33E7341F5CB;

1.253
date	2007.09.09.10.49.20;	author tg;	state Exp;
branches;
next	1.252;
commitid	10046E3CFA6632292FF;

1.252
date	2007.09.07.21.58.40;	author tg;	state Exp;
branches;
next	1.251;
commitid	10046E1C99F6DAD7616;

1.251
date	2007.08.12.13.42.19;	author tg;	state Exp;
branches;
next	1.250;
commitid	10046BF0E4F7055959B;

1.250
date	2007.07.31.11.11.23;	author tg;	state Exp;
branches;
next	1.249;
commitid	10046AF18D74B1B5DF4;

1.249
date	2007.07.31.10.42.14;	author tg;	state Exp;
branches;
next	1.248;
commitid	10046AF121C3F451EF4;

1.248
date	2007.07.31.10.17.52;	author tg;	state Exp;
branches;
next	1.247;
commitid	10046AF0C551FC2C2FC;

1.247
date	2007.07.31.10.04.46;	author tg;	state Exp;
branches;
next	1.246;
commitid	10046AF093241F3D771;

1.246
date	2007.07.26.22.38.31;	author tg;	state Exp;
branches;
next	1.245;
commitid	10046A9227664EB18F2;

1.245
date	2007.07.24.21.54.46;	author tg;	state Exp;
branches;
next	1.244;
commitid	10046A674F069FEA147;

1.244
date	2007.07.24.21.47.13;	author tg;	state Exp;
branches;
next	1.243;
commitid	10046A673784E7347BC;

1.243
date	2007.07.22.13.47.10;	author tg;	state Exp;
branches;
next	1.242;
commitid	10046A35FF26FFF34D1;

1.242
date	2007.07.22.13.46.13;	author tg;	state Exp;
branches;
next	1.241;
commitid	10046A35F6D6E418744;

1.241
date	2007.07.22.13.34.48;	author tg;	state Exp;
branches;
next	1.240;
commitid	10046A35CEC35BB7B5F;

1.240
date	2007.07.22.13.08.54;	author tg;	state Exp;
branches;
next	1.239;
commitid	10046A356DC5E98CAFD;

1.239
date	2007.07.17.19.41.26;	author tg;	state Exp;
branches;
next	1.238;
commitid	100469D1B441B1DC62C;

1.238
date	2007.07.09.11.19.55;	author tg;	state Exp;
branches;
next	1.237;
commitid	100469219E754EB6F30;

1.237
date	2007.07.04.14.53.19;	author tg;	state Exp;
branches;
next	1.236;
commitid	100468BB459351E69C7;

1.236
date	2007.07.01.21.59.10;	author tg;	state Exp;
branches;
next	1.235;
commitid	100468823BC0BC9A791;

1.235
date	2007.07.01.21.52.20;	author tg;	state Exp;
branches;
next	1.234;
commitid	1004688222708859F43;

1.234
date	2007.07.01.21.47.07;	author tg;	state Exp;
branches;
next	1.233;
commitid	100468820CD07282054;

1.233
date	2007.07.01.21.27.02;	author tg;	state Exp;
branches;
next	1.232;
commitid	10046881C10526620B9;

1.232
date	2007.07.01.19.24.11;	author tg;	state Exp;
branches;
next	1.231;
commitid	1004687FF61575AB9FC;

1.231
date	2007.07.01.19.04.52;	author tg;	state Exp;
branches;
next	1.230;
commitid	1004687FAEA6DAA2FEC;

1.230
date	2007.07.01.18.00.18;	author tg;	state Exp;
branches;
next	1.229;
commitid	1004687EBC91CDC9040;

1.229
date	2007.07.01.17.22.07;	author tg;	state Exp;
branches;
next	1.228;
commitid	1004687E2B108CADBF1;

1.228
date	2007.07.01.17.19.15;	author tg;	state Exp;
branches;
next	1.227;
commitid	1004687E2221F3B1524;

1.227
date	2007.07.01.16.57.00;	author tg;	state Exp;
branches;
next	1.226;
commitid	1004687DCE80BF58CF5;

1.226
date	2007.07.01.16.47.05;	author tg;	state Exp;
branches;
next	1.225;
commitid	1004687DA7A5EA1964B;

1.225
date	2007.07.01.15.45.58;	author tg;	state Exp;
branches;
next	1.224;
commitid	1004687CBD7464C81CD;

1.224
date	2007.06.30.22.02.50;	author tg;	state Exp;
branches;
next	1.223;
commitid	1004686D3216C006412;

1.223
date	2007.06.30.21.34.23;	author tg;	state Exp;
branches;
next	1.222;
commitid	1004686CC6E0AED61EB;

1.222
date	2007.06.30.21.01.42;	author tg;	state Exp;
branches;
next	1.221;
commitid	1004686C4BE783962DC;

1.221
date	2007.06.30.20.57.55;	author tg;	state Exp;
branches;
next	1.220;
commitid	1004686C3DB0D06998E;

1.220
date	2007.06.30.20.04.23;	author tg;	state Exp;
branches;
next	1.219;
commitid	1004686B75A00D93404;

1.219
date	2007.06.30.19.58.51;	author tg;	state Exp;
branches;
next	1.218;
commitid	1004686B5CC294F8FCB;

1.218
date	2007.06.30.19.48.04;	author tg;	state Exp;
branches;
next	1.217;
commitid	1004686B32E09B5A745;

1.217
date	2007.06.23.20.51.21;	author tg;	state Exp;
branches;
next	1.216;
commitid	100467D87D912D74738;

1.216
date	2007.06.21.16.11.37;	author tg;	state Exp;
branches;
next	1.215;
commitid	100467AA33E1343EACA;

1.215
date	2007.06.21.15.53.14;	author tg;	state Exp;
branches;
next	1.214;
commitid	100467A9EC324AAAAD6;

1.214
date	2007.06.21.15.43.33;	author tg;	state Exp;
branches;
next	1.213;
commitid	100467A986370E36304;

1.213
date	2007.06.15.21.55.18;	author tg;	state Exp;
branches;
next	1.212;
commitid	10046730AA46E14A9D1;

1.212
date	2007.06.10.17.06.07;	author tg;	state Exp;
branches;
next	1.211;
commitid	100466C2F7B7C764024;

1.211
date	2007.06.09.22.06.55;	author tg;	state Exp;
branches;
next	1.210;
commitid	100466B248758B0B312;

1.210
date	2007.06.09.22.01.40;	author tg;	state Exp;
branches;
next	1.209;
commitid	100466B23524CFD40D0;

1.209
date	2007.06.06.23.25.28;	author tg;	state Exp;
branches;
next	1.208;
commitid	10046674279320A1AA8;

1.208
date	2007.06.06.22.03.24;	author tg;	state Exp;
branches;
next	1.207;
commitid	10046672F434EF04DA3;

1.207
date	2007.06.06.21.59.38;	author tg;	state Exp;
branches;
next	1.206;
commitid	10046672E526FF86B77;

1.206
date	2007.06.06.21.56.12;	author tg;	state Exp;
branches;
next	1.205;
commitid	10046672D8E69B7213D;

1.205
date	2007.06.06.21.36.29;	author tg;	state Exp;
branches;
next	1.204;
commitid	100466728AC5CB298E8;

1.204
date	2007.06.05.23.10.51;	author tg;	state Exp;
branches;
next	1.203;
commitid	1004665ED7926CC0995;

1.203
date	2007.06.05.21.47.48;	author tg;	state Exp;
branches;
next	1.202;
commitid	1004665D9D956A3B2CA;

1.202
date	2007.06.05.21.17.05;	author tg;	state Exp;
branches;
next	1.201;
commitid	1004665D2E30EFAFE6D;

1.201
date	2007.06.05.21.10.52;	author tg;	state Exp;
branches;
next	1.200;
commitid	1004665D152020757A3;

1.200
date	2007.06.05.20.57.46;	author tg;	state Exp;
branches;
next	1.199;
commitid	1004665CE5104FF690A;

1.199
date	2007.06.05.20.18.54;	author tg;	state Exp;
branches;
next	1.198;
commitid	1004665C51672DB4351;

1.198
date	2007.06.05.20.01.26;	author tg;	state Exp;
branches;
next	1.197;
commitid	1004665C12C3ED13388;

1.197
date	2007.06.05.19.48.45;	author tg;	state Exp;
branches;
next	1.196;
commitid	1004665BE264E72FCFA;

1.196
date	2007.06.05.19.39.20;	author tg;	state Exp;
branches;
next	1.195;
commitid	1004665BBF9194B66C8;

1.195
date	2007.06.04.21.27.53;	author tg;	state Exp;
branches;
next	1.194;
commitid	10046648335104B0B82;

1.194
date	2007.06.04.21.15.27;	author tg;	state Exp;
branches;
next	1.193;
commitid	100466481003361E716;

1.193
date	2007.06.04.20.26.47;	author tg;	state Exp;
branches;
next	1.192;
commitid	1004664758D78A6B98D;

1.192
date	2007.06.04.20.22.08;	author tg;	state Exp;
branches;
next	1.191;
commitid	100466474802735C499;

1.191
date	2007.06.04.20.14.34;	author tg;	state Exp;
branches;
next	1.190;
commitid	100466472AA29C1B492;

1.190
date	2007.06.04.20.00.50;	author tg;	state Exp;
branches;
next	1.189;
commitid	10046646F792FFFD778;

1.189
date	2007.06.03.17.29.29;	author tg;	state Exp;
branches;
next	1.188;
commitid	1004662FA8756139FA3;

1.188
date	2007.05.31.21.25.25;	author tg;	state Exp;
branches;
next	1.187;
commitid	100465F3D355758100B;

1.187
date	2007.05.28.13.47.09;	author tg;	state Exp;
branches;
next	1.186;
commitid	100465ADD5D20EB4CA0;

1.186
date	2007.05.24.23.07.18;	author tg;	state Exp;
branches;
next	1.185;
commitid	10046561A9326851C73;

1.185
date	2007.05.24.09.22.58;	author tg;	state Exp;
branches;
next	1.184;
commitid	100465559530388675D;

1.184
date	2007.05.02.20.02.07;	author tg;	state Exp;
branches;
next	1.183;
commitid	1004638EE466466C614;

1.183
date	2007.04.30.19.50.09;	author tg;	state Exp;
branches;
next	1.182;
commitid	1004636486176FDA6FF;

1.182
date	2007.04.30.19.18.37;	author tg;	state Exp;
branches
	1.182.2.1;
next	1.181;
commitid	100463640E0490101BB;

1.181
date	2007.04.30.19.12.18;	author tg;	state Exp;
branches;
next	1.180;
commitid	10046363EFA5CCFB81B;

1.180
date	2007.04.24.10.44.58;	author tg;	state Exp;
branches;
next	1.179;
commitid	100462DDFBC7C65E266;

1.179
date	2007.04.24.10.42.02;	author tg;	state Exp;
branches;
next	1.178;
commitid	100462DDE7C6EC3BD7F;

1.178
date	2007.04.23.22.33.20;	author tg;	state Exp;
branches;
next	1.177;
commitid	100462D33940FA4A726;

1.177
date	2007.04.23.21.36.02;	author tg;	state Exp;
branches;
next	1.176;
commitid	100462D26D3734B2FEF;

1.176
date	2007.04.23.21.31.58;	author tg;	state Exp;
branches;
next	1.175;
commitid	100462D25E4434A53D4;

1.175
date	2007.04.23.21.15.44;	author tg;	state Exp;
branches;
next	1.174;
commitid	100462D221747036F62;

1.174
date	2007.04.23.20.57.50;	author tg;	state Exp;
branches;
next	1.173;
commitid	100462D1DD73FC87BBC;

1.173
date	2007.04.23.20.37.15;	author tg;	state Exp;
branches;
next	1.172;
commitid	100462D18E37B6B8D16;

1.172
date	2007.04.23.20.17.58;	author tg;	state Exp;
branches;
next	1.171;
commitid	100462D1471488B665C;

1.171
date	2007.04.23.14.06.47;	author tg;	state Exp;
branches;
next	1.170;
commitid	100462CBD6C2927BC06;

1.170
date	2007.04.23.12.13.03;	author tg;	state Exp;
branches;
next	1.169;
commitid	100462CA2CF598C723D;

1.169
date	2007.04.23.11.33.25;	author tg;	state Exp;
branches;
next	1.168;
commitid	100462C996E13AB5D90;

1.168
date	2007.04.01.01.48.31;	author tg;	state Exp;
branches;
next	1.167;
commitid	100460F0F7A6A132EFD;

1.167
date	2007.03.19.22.58.19;	author tg;	state Exp;
branches;
next	1.166;
commitid	10045FF15934512D640;

1.166
date	2007.03.10.19.19.12;	author tg;	state Exp;
branches;
next	1.165;
commitid	10045F304A12CABB06E;

1.165
date	2007.03.10.18.51.59;	author tg;	state Exp;
branches;
next	1.164;
commitid	10045F2FE653C8BFD72;

1.164
date	2007.03.10.17.29.53;	author tg;	state Exp;
branches;
next	1.163;
commitid	10045F2EB1A2AAAF37E;

1.163
date	2007.03.04.05.14.09;	author tg;	state Exp;
branches;
next	1.162;
commitid	10045EA559E18A98F24;

1.162
date	2007.03.04.05.03.57;	author tg;	state Exp;
branches;
next	1.161;
commitid	10045EA53541DED340A;

1.161
date	2007.03.04.04.53.06;	author tg;	state Exp;
branches;
next	1.160;
commitid	10045EA50B0299A3648;

1.160
date	2007.03.04.04.52.28;	author tg;	state Exp;
branches;
next	1.159;
commitid	10045EA509C092445F1;

1.159
date	2007.03.04.04.45.36;	author tg;	state Exp;
branches;
next	1.158;
commitid	10045EA4F0078714EAA;

1.158
date	2007.03.04.04.36.45;	author tg;	state Exp;
branches;
next	1.157;
commitid	10045EA4CCF3ED98D2A;

1.157
date	2007.03.04.04.28.58;	author tg;	state Exp;
branches;
next	1.156;
commitid	10045EA4B1D3AE1C507;

1.156
date	2007.03.04.03.48.50;	author tg;	state Exp;
branches;
next	1.155;
commitid	10045EA41B951107DDF;

1.155
date	2007.03.04.03.04.22;	author tg;	state Exp;
branches;
next	1.154;
commitid	10045EA374B3374AB35;

1.154
date	2007.03.03.21.36.06;	author tg;	state Exp;
branches;
next	1.153;
commitid	10045E9EA54328B08FC;

1.153
date	2007.02.27.00.31.17;	author tg;	state Exp;
branches;
next	1.152;
commitid	10045E37BAB1C1A7CB5;

1.152
date	2007.02.27.00.23.20;	author tg;	state Exp;
branches;
next	1.151;
commitid	10045E37A0E1252F7C0;

1.151
date	2007.02.18.16.24.13;	author tg;	state Exp;
branches;
next	1.150;
commitid	10045D87D7D0FC908BE;

1.150
date	2007.02.13.12.26.46;	author tg;	state Exp;
branches;
next	1.149;
commitid	10045D1AE97039FE75F;

1.149
date	2007.02.02.10.27.21;	author tg;	state Exp;
branches;
next	1.148;
commitid	10045C3117F7D096576;

1.148
date	2007.01.28.20.05.29;	author tg;	state Exp;
branches;
next	1.147;
commitid	10045BD01FA6112AC24;

1.147
date	2007.01.26.18.25.01;	author tg;	state Exp;
branches;
next	1.146;
commitid	10045BA478968EC5A33;

1.146
date	2007.01.18.20.40.39;	author tg;	state Exp;
branches;
next	1.145;
commitid	10045AFDB5548216405;

1.145
date	2007.01.18.16.06.22;	author tg;	state Exp;
branches;
next	1.144;
commitid	10045AF9B0A05DC9B0B;

1.144
date	2007.01.18.16.05.04;	author tg;	state Exp;
branches;
next	1.143;
commitid	10045AF9AC06E556EEF;

1.143
date	2007.01.18.15.50.31;	author tg;	state Exp;
branches;
next	1.142;
commitid	10045AF974442B3F2AC;

1.142
date	2007.01.18.03.31.50;	author tg;	state Exp;
branches;
next	1.141;
commitid	10045AEEA2B7E7FDF48;

1.141
date	2007.01.18.03.31.24;	author tg;	state Exp;
branches;
next	1.140;
commitid	10045AEEA0C3A401797;

1.140
date	2007.01.18.02.54.19;	author tg;	state Exp;
branches;
next	1.139;
commitid	10045AEE1323487FE38;

1.139
date	2007.01.18.01.10.55;	author tg;	state Exp;
branches;
next	1.138;
commitid	10045AEC90F0029F8FC;

1.138
date	2007.01.18.00.16.26;	author tg;	state Exp;
branches;
next	1.137;
commitid	10045AEBC7055B3BFD9;

1.137
date	2007.01.18.00.10.16;	author tg;	state Exp;
branches;
next	1.136;
commitid	10045AEBAEC2A958426;

1.136
date	2007.01.17.23.54.39;	author tg;	state Exp;
branches;
next	1.135;
commitid	10045AEB75443B113F8;

1.135
date	2007.01.17.23.50.26;	author tg;	state Exp;
branches;
next	1.134;
commitid	10045AEB6554BB71182;

1.134
date	2007.01.17.23.47.14;	author tg;	state Exp;
branches;
next	1.133;
commitid	10045AEB50A4F8328BF;

1.133
date	2007.01.17.23.27.47;	author tg;	state Exp;
branches;
next	1.132;
commitid	10045AEB1062E76AA2B;

1.132
date	2007.01.17.23.18.55;	author tg;	state Exp;
branches;
next	1.131;
commitid	10045AEAEED31DCCB57;

1.131
date	2007.01.17.23.04.19;	author tg;	state Exp;
branches;
next	1.130;
commitid	10045AEAB814721728C;

1.130
date	2007.01.17.22.59.25;	author tg;	state Exp;
branches;
next	1.129;
commitid	10045AEAA567A03FA1A;

1.129
date	2007.01.17.22.55.47;	author tg;	state Exp;
branches;
next	1.128;
commitid	10045AEA97540DC73E0;

1.128
date	2007.01.17.22.51.45;	author tg;	state Exp;
branches;
next	1.127;
commitid	10045AEA86F7FE51B97;

1.127
date	2007.01.17.22.35.09;	author tg;	state Exp;
branches;
next	1.126;
commitid	10045AEA41918A1ADF4;

1.126
date	2007.01.17.21.42.23;	author tg;	state Exp;
branches;
next	1.125;
commitid	10045AE984A425BEE7A;

1.125
date	2007.01.17.17.57.31;	author tg;	state Exp;
branches;
next	1.124;
commitid	10045AE63953882E771;

1.124
date	2007.01.17.17.46.18;	author tg;	state Exp;
branches;
next	1.123;
commitid	10045AE60E813A601EA;

1.123
date	2007.01.17.17.42.22;	author tg;	state Exp;
branches;
next	1.122;
commitid	10045AE5FEF159B49BE;

1.122
date	2007.01.17.17.31.59;	author tg;	state Exp;
branches;
next	1.121;
commitid	10045AE5D6C73A3F9F9;

1.121
date	2007.01.17.17.14.25;	author tg;	state Exp;
branches;
next	1.120;
commitid	10045AE593A639448EB;

1.120
date	2007.01.17.17.12.43;	author tg;	state Exp;
branches;
next	1.119;
commitid	10045AE592133F488C8;

1.119
date	2007.01.17.17.08.34;	author tg;	state Exp;
branches;
next	1.118;
commitid	10045AE581A6D95EFA3;

1.118
date	2007.01.17.17.03.59;	author tg;	state Exp;
branches;
next	1.117;
commitid	10045AE570517078499;

1.117
date	2007.01.17.16.57.41;	author tg;	state Exp;
branches;
next	1.116;
commitid	10045AE559C264868BC;

1.116
date	2007.01.17.16.52.00;	author tg;	state Exp;
branches;
next	1.115;
commitid	10045AE544117257BAF;

1.115
date	2007.01.17.16.44.19;	author tg;	state Exp;
branches;
next	1.114;
commitid	10045AE527A4B985A0E;

1.114
date	2007.01.17.16.39.55;	author tg;	state Exp;
branches;
next	1.113;
commitid	10045AE51285236A2AB;

1.113
date	2007.01.17.01.59.38;	author tg;	state Exp;
branches;
next	1.112;
commitid	10045AD831E65988855;

1.112
date	2007.01.17.01.24.28;	author tg;	state Exp;
branches;
next	1.111;
commitid	10045AD7A912A404713;

1.111
date	2007.01.14.21.38.25;	author tg;	state Exp;
branches
	1.111.2.1;
next	1.110;
commitid	10045AAA2911444D1C3;

1.110
date	2007.01.12.03.30.40;	author tg;	state Exp;
branches;
next	1.109;
commitid	10045A700E82D4D0181;

1.109
date	2007.01.12.03.20.07;	author tg;	state Exp;
branches;
next	1.108;
commitid	10045A6FE735D84B3CE;

1.108
date	2007.01.12.03.17.08;	author tg;	state Exp;
branches;
next	1.107;
commitid	10045A6FDC70E8DE927;

1.107
date	2007.01.12.02.46.27;	author tg;	state Exp;
branches;
next	1.106;
commitid	10045A6F68B3F95C382;

1.106
date	2007.01.12.02.40.18;	author tg;	state Exp;
branches;
next	1.105;
commitid	10045A6F51A064B1D1A;

1.105
date	2007.01.12.02.37.32;	author tg;	state Exp;
branches;
next	1.104;
commitid	10045A6F474479B7EED;

1.104
date	2007.01.12.02.34.46;	author tg;	state Exp;
branches;
next	1.103;
commitid	10045A6F3B04E7550AA;

1.103
date	2007.01.12.02.27.40;	author tg;	state Exp;
branches;
next	1.102;
commitid	10045A6F21B36267381;

1.102
date	2007.01.12.02.12.16;	author tg;	state Exp;
branches;
next	1.101;
commitid	10045A6EE7C28FFE71F;

1.101
date	2007.01.12.02.09.10;	author tg;	state Exp;
branches;
next	1.100;
commitid	10045A6EDDD3B7F6C10;

1.100
date	2007.01.12.02.01.48;	author tg;	state Exp;
branches;
next	1.99;
commitid	10045A6EBFE0C6FB787;

1.99
date	2007.01.12.01.49.26;	author tg;	state Exp;
branches;
next	1.98;
commitid	10045A6E8B92FCAC95A;

1.98
date	2007.01.12.01.44.32;	author tg;	state Exp;
branches;
next	1.97;
commitid	10045A6E80664C6C5E9;

1.97
date	2007.01.12.01.32.27;	author tg;	state Exp;
branches;
next	1.96;
commitid	10045A6E5267C68825E;

1.96
date	2007.01.12.01.27.28;	author tg;	state Exp;
branches;
next	1.95;
commitid	10045A6E4131C78EEEF;

1.95
date	2007.01.12.01.17.10;	author tg;	state Exp;
branches;
next	1.94;
commitid	10045A6E1A04A004359;

1.94
date	2007.01.12.00.25.38;	author tg;	state Exp;
branches;
next	1.93;
commitid	10045A6D3B866AF7B2F;

1.93
date	2007.01.11.03.03.34;	author tg;	state Exp;
branches;
next	1.92;
commitid	10045A5A8E32DF9EC0A;

1.92
date	2007.01.11.02.41.53;	author tg;	state Exp;
branches;
next	1.91;
commitid	10045A5A3A9112268F8;

1.91
date	2007.01.11.02.37.40;	author tg;	state Exp;
branches;
next	1.90;
commitid	10045A5A281766D1C15;

1.90
date	2007.01.11.02.11.46;	author tg;	state Exp;
branches;
next	1.89;
commitid	10045A59CD1439CF956;

1.89
date	2007.01.11.02.08.49;	author tg;	state Exp;
branches;
next	1.88;
commitid	10045A59C3424354B8C;

1.88
date	2007.01.11.00.57.56;	author tg;	state Exp;
branches;
next	1.87;
commitid	10045A58BA169D3002E;

1.87
date	2007.01.11.00.47.40;	author tg;	state Exp;
branches;
next	1.86;
commitid	10045A5891D76585361;

1.86
date	2007.01.11.00.44.08;	author tg;	state Exp;
branches;
next	1.85;
commitid	10045A5885A3F5EDFE7;

1.85
date	2007.01.11.00.38.37;	author tg;	state Exp;
branches;
next	1.84;
commitid	10045A5871656872D96;

1.84
date	2006.12.11.19.58.37;	author tg;	state Exp;
branches;
next	1.83;
commitid	100457DB87D19AC4202;

1.83
date	2006.11.21.21.45.24;	author tg;	state Exp;
branches;
next	1.82;
commitid	10045637371079BA399;

1.82
date	2006.11.12.13.49.22;	author tg;	state Exp;
branches;
next	1.81;
commitid	1004557266E7645E007;

1.81
date	2006.11.12.13.38.40;	author tg;	state Exp;
branches;
next	1.80;
commitid	100455723EE5EE38E07;

1.80
date	2006.11.12.13.35.29;	author tg;	state Exp;
branches;
next	1.79;
commitid	100455722FF1E6F1B08;

1.79
date	2006.11.12.13.15.26;	author tg;	state Exp;
branches;
next	1.78;
commitid	10045571E7C6CC49355;

1.78
date	2006.11.12.13.09.09;	author tg;	state Exp;
branches;
next	1.77;
commitid	10045571D0612B0F1BE;

1.77
date	2006.11.12.13.08.30;	author tg;	state Exp;
branches;
next	1.76;
commitid	10045571CC335689F20;

1.76
date	2006.11.12.12.56.09;	author tg;	state Exp;
branches;
next	1.75;
commitid	100455719F125BF13F8;

1.75
date	2006.11.10.07.18.56;	author tg;	state Exp;
branches;
next	1.74;
commitid	100455427B90A1F6E32;

1.74
date	2006.11.09.23.09.05;	author tg;	state Exp;
branches;
next	1.73;
commitid	1004553B4832963A309;

1.73
date	2006.11.09.23.04.34;	author tg;	state Exp;
branches;
next	1.72;
commitid	1004553B40A327773F8;

1.72
date	2006.11.09.22.56.55;	author tg;	state Exp;
branches;
next	1.71;
commitid	1004553B24D495B9AEC;

1.71
date	2006.11.09.22.56.09;	author tg;	state Exp;
branches;
next	1.70;
commitid	1004553B2150E073091;

1.70
date	2006.11.09.22.53.21;	author tg;	state Exp;
branches;
next	1.69;
commitid	1004553B17257820E4B;

1.69
date	2006.11.09.22.51.49;	author tg;	state Exp;
branches;
next	1.68;
commitid	1004553B1067EE76632;

1.68
date	2006.11.09.15.02.30;	author tg;	state Exp;
branches;
next	1.67;
commitid	100455343104AF09372;

1.67
date	2006.11.09.00.13.27;	author tg;	state Exp;
branches;
next	1.66;
commitid	100455272BE12392C59;

1.66
date	2006.11.09.00.11.38;	author tg;	state Exp;
branches;
next	1.65;
commitid	1004552723039ED92BA;

1.65
date	2006.11.09.00.08.25;	author tg;	state Exp;
branches;
next	1.64;
commitid	1004552718755B31C28;

1.64
date	2006.11.09.00.06.33;	author tg;	state Exp;
branches;
next	1.63;
commitid	10045527109131743D8;

1.63
date	2006.11.09.00.03.37;	author tg;	state Exp;
branches;
next	1.62;
commitid	1004552706D03BA947F;

1.62
date	2006.11.09.00.01.04;	author tg;	state Exp;
branches;
next	1.61;
commitid	10045526FD10E175CFB;

1.61
date	2006.11.08.23.45.46;	author tg;	state Exp;
branches;
next	1.60;
commitid	10045526C372A4C60AB;

1.60
date	2006.11.08.23.38.28;	author tg;	state Exp;
branches;
next	1.59;
commitid	10045526A0E710E3AED;

1.59
date	2006.11.08.23.23.40;	author tg;	state Exp;
branches;
next	1.58;
commitid	1004552670E1A677D8A;

1.58
date	2006.09.29.19.33.48;	author tg;	state Exp;
branches;
next	1.57;
commitid	100451D752B7E4B9B97;

1.57
date	2006.09.21.22.12.05;	author tg;	state Exp;
branches;
next	1.56;
commitid	10045130E3141B7BB8C;

1.56
date	2006.09.21.22.09.41;	author tg;	state Exp;
branches;
next	1.55;
commitid	10045130DB6057AAFCB;

1.55
date	2006.09.13.23.07.10;	author tg;	state Exp;
branches;
next	1.54;
commitid	10045088EF2767794C7;

1.54
date	2006.08.28.01.37.29;	author tg;	state Exp;
branches;
next	1.53;
commitid	10044F248E34775C17B;

1.53
date	2006.08.28.01.30.37;	author tg;	state Exp;
branches;
next	1.52;
commitid	10044F2473E3FBB557B;

1.52
date	2006.08.26.20.48.29;	author tg;	state Exp;
branches;
next	1.51;
commitid	10044F0B3AD28355421;

1.51
date	2006.08.26.20.30.27;	author tg;	state Exp;
branches;
next	1.50;
commitid	10044F0AF574E06B6B7;

1.50
date	2006.08.24.20.32.52;	author tg;	state Exp;
branches;
next	1.49;
commitid	10044EE0CE2267A59CF;

1.49
date	2006.08.22.22.01.59;	author tg;	state Exp;
branches;
next	1.48;
commitid	10044EB7EDF4DD6F6D1;

1.48
date	2006.08.12.20.30.22;	author tg;	state Exp;
branches
	1.48.2.1;
next	1.47;
commitid	10044DE3A6C00309F7F;

1.47
date	2006.08.12.20.19.36;	author tg;	state Exp;
branches;
next	1.46;
commitid	10044DE37E970293554;

1.46
date	2006.08.12.20.01.35;	author tg;	state Stab;
branches;
next	1.45;
commitid	10044DE33B17A5F93D6;

1.45
date	2006.08.12.19.53.39;	author tg;	state Exp;
branches;
next	1.44;
commitid	10044DE31D6464ADBDF;

1.44
date	2006.08.12.19.51.08;	author tg;	state Exp;
branches;
next	1.43;
commitid	10044DE31360656EAD5;

1.43
date	2006.08.12.19.38.44;	author tg;	state Exp;
branches;
next	1.42;
commitid	10044DE2E523F0559AC;

1.42
date	2006.08.12.19.26.20;	author tg;	state Exp;
branches;
next	1.41;
commitid	10044DE2B65745AC686;

1.41
date	2006.08.12.18.49.21;	author tg;	state Exp;
branches;
next	1.40;
commitid	10044DE22C225FE2676;

1.40
date	2006.08.12.18.48.39;	author tg;	state Exp;
branches;
next	1.39;
commitid	10044DE22950557922A;

1.39
date	2006.08.12.18.43.55;	author tg;	state Exp;
branches;
next	1.38;
commitid	10044DE21485A4E7741;

1.38
date	2006.08.02.14.17.13;	author tg;	state Exp;
branches;
next	1.37;
commitid	10044D0B3FC70112440;

1.37
date	2006.08.02.11.50.28;	author tg;	state Exp;
branches;
next	1.36;
commitid	10044D091507AB5F673;

1.36
date	2006.08.02.10.41.03;	author tg;	state Exp;
branches;
next	1.35;
commitid	10044D080B163DF8431;

1.35
date	2006.08.02.10.02.21;	author tg;	state Exp;
branches;
next	1.34;
commitid	10044D078302B2C3D0C;

1.34
date	2006.08.01.12.57.07;	author tg;	state Exp;
branches;
next	1.33;
commitid	10044CF4F9F33070288;

1.33
date	2006.07.23.18.44.22;	author tg;	state Exp;
branches;
next	1.32;
commitid	10044C3C31D4538E6DA;

1.32
date	2006.07.03.12.17.08;	author tg;	state Exp;
branches;
next	1.31;
commitid	10044A90AD54AEF559A;

1.31
date	2006.07.01.14.39.41;	author tg;	state Exp;
branches;
next	1.30;
commitid	10044A6892A30C70186;

1.30
date	2006.06.23.15.05.39;	author tg;	state Exp;
branches;
next	1.29;
commitid	100449C035551CF7D76;

1.29
date	2006.05.27.20.33.01;	author tg;	state Exp;
branches;
next	1.28;
commitid	1004478B77C48A7733B;

1.28
date	2006.05.27.11.30.07;	author tg;	state Exp;
branches;
next	1.27;
commitid	1004478383955AB9057;

1.27
date	2006.05.26.22.24.20;	author tg;	state Exp;
branches;
next	1.26;
commitid	100447780251CF9F1B6;

1.26
date	2006.05.10.20.34.28;	author tg;	state Exp;
branches;
next	1.25;
commitid	10044624E5E754F5A1D;

1.25
date	2006.03.19.18.06.31;	author tg;	state Exp;
branches;
next	1.24;
commitid	100441D9DAA7AB80F15;

1.24
date	2006.01.27.00.50.12;	author tg;	state Exp;
branches;
next	1.23;
commitid	10043D96E3C47E6367A;

1.23
date	2005.10.26.08.47.19;	author tg;	state Exp;
branches;
next	1.22;
commitid	58a0435f42a21cea;

1.22
date	2005.10.25.21.07.21;	author tg;	state Exp;
branches;
next	1.21;
commitid	50be435e9e9918f1;

1.21
date	2005.10.25.20.59.00;	author tg;	state Exp;
branches;
next	1.20;
commitid	42e6435e9c9dd35c;

1.20
date	2005.10.25.20.54.29;	author tg;	state Exp;
branches;
next	1.19;
commitid	79f2435e9b972912;

1.19
date	2005.10.25.19.46.52;	author tg;	state Exp;
branches;
next	1.18;
commitid	63bc435e8bbaca0a;

1.18
date	2005.10.25.19.46.10;	author tg;	state Exp;
branches;
next	1.17;
commitid	6836435e8b86013e;

1.17
date	2005.08.21.13.02.16;	author tg;	state Exp;
branches;
next	1.16;
commitid	521743087b5a03be;

1.16
date	2005.07.07.23.27.52;	author tg;	state Exp;
branches;
next	1.15;
commitid	419f42cdba670de9;

1.15
date	2005.06.08.23.02.08;	author tg;	state Exp;
branches;
next	1.14;
commitid	39bd42a778ffdf71;

1.14
date	2005.06.08.22.47.54;	author tg;	state Exp;
branches;
next	1.13;
commitid	68c142a775a8984c;

1.13
date	2005.06.08.22.46.06;	author tg;	state Exp;
branches;
next	1.12;
commitid	359f42a7753fb372;

1.12
date	2005.06.08.22.42.31;	author tg;	state Exp;
branches;
next	1.11;
commitid	322b42a7744413c7;

1.11
date	2005.06.08.21.51.20;	author tg;	state Exp;
branches;
next	1.10;
commitid	318442a76849872f;

1.10
date	2005.06.08.10.19.33;	author tg;	state Exp;
branches;
next	1.9;
commitid	633842a6c6471527;

1.9
date	2005.06.05.16.38.19;	author tg;	state Exp;
branches;
next	1.8;
commitid	329342a32a8e3325;

1.8
date	2005.06.05.16.34.59;	author tg;	state Exp;
branches;
next	1.7;
commitid	554142a329b5b671;

1.7
date	2005.05.30.07.05.29;	author tg;	state Exp;
branches;
next	1.6;
commitid	614429abb0f4197;

1.6
date	2005.05.28.21.30.32;	author tg;	state Exp;
branches;
next	1.5;
commitid	41cd4298e301a333;

1.5
date	2005.05.25.23.44.50;	author tg;	state Exp;
branches;
next	1.4;
commitid	2dfc42950d7e5359;

1.4
date	2005.05.25.09.53.02;	author tg;	state Exp;
branches;
next	1.3;
commitid	4c8f42944b03b9e3;

1.3
date	2005.05.23.17.24.23;	author tg;	state Exp;
branches;
next	1.2;
commitid	24084292117f040d;

1.2
date	2005.05.23.16.56.22;	author tg;	state Exp;
branches;
next	1.1;
commitid	50e942920b439af6;

1.1
date	2005.05.23.16.48.52;	author tg;	state Exp;
branches;
next	;
commitid	60bc4292097ef8fe;

1.669.2.1
date	2015.01.25.15.35.34;	author tg;	state Exp;
branches;
next	1.669.2.2;
commitid	10054C50D442D861FBF;

1.669.2.2
date	2015.03.01.15.42.50;	author tg;	state Exp;
branches;
next	1.669.2.3;
commitid	10054F33364551D895A;

1.669.2.3
date	2015.04.12.22.32.14;	author tg;	state Exp;
branches;
next	1.669.2.4;
commitid	100552AF26A429AA816;

1.669.2.4
date	2015.04.19.19.18.08;	author tg;	state Exp;
branches;
next	;
commitid	1005533FF4D64965277;

1.616.2.1
date	2013.02.11.17.25.00;	author tg;	state Exp;
branches;
next	;
commitid	100511929846067390F;

1.590.2.1
date	2012.11.30.20.49.10;	author tg;	state Exp;
branches;
next	1.590.2.2;
commitid	10050B91BDD34E31558;

1.590.2.2
date	2012.11.30.22.17.34;	author tg;	state Exp;
branches;
next	1.590.2.3;
commitid	10050B93094425CEC11;

1.590.2.3
date	2012.12.01.14.22.12;	author tg;	state Exp;
branches;
next	1.590.2.4;
commitid	10050BA12A9448DDD09;

1.590.2.4
date	2012.12.03.13.07.13;	author tg;	state Exp;
branches;
next	1.590.2.5;
commitid	10050BCA41766DA29C2;

1.590.2.5
date	2012.12.03.22.10.04;	author tg;	state Exp;
branches;
next	1.590.2.6;
commitid	10050BD22C502F97B97;

1.590.2.6
date	2012.12.04.01.26.12;	author tg;	state Exp;
branches;
next	1.590.2.7;
commitid	10050BD5149729CD584;

1.590.2.7
date	2012.12.05.19.58.23;	author tg;	state Exp;
branches;
next	1.590.2.8;
commitid	10050BFA7766B61F30F;

1.590.2.8
date	2013.01.01.21.19.53;	author tg;	state Exp;
branches;
next	1.590.2.9;
commitid	10050E352F23B706399;

1.590.2.9
date	2013.01.12.02.25.05;	author tg;	state Exp;
branches;
next	1.590.2.10;
commitid	10050F0C9702926C312;

1.590.2.10
date	2013.02.10.17.11.15;	author tg;	state Exp;
branches;
next	;
commitid	1005117D46E22B420F2;

1.578.2.1
date	2013.02.10.16.50.34;	author tg;	state Exp;
branches;
next	;
commitid	1005117CFE74C9B84A1;

1.484.2.1
date	2011.07.07.21.42.08;	author tg;	state Exp;
branches;
next	1.484.2.2;
commitid	1004E162810137500DE;

1.484.2.2
date	2011.07.16.18.03.01;	author tg;	state Exp;
branches;
next	1.484.2.3;
commitid	1004E21D26C11A6B90C;

1.484.2.3
date	2011.10.25.22.50.27;	author tg;	state Exp;
branches;
next	1.484.2.4;
commitid	1004EA73D456165B188;

1.484.2.4
date	2011.11.19.22.21.51;	author tg;	state Exp;
branches;
next	1.484.2.5;
commitid	1004EC82C02177E0E27;

1.484.2.5
date	2011.11.26.18.23.14;	author tg;	state Exp;
branches;
next	1.484.2.6;
commitid	1004ED12E8854A4E765;

1.484.2.6
date	2011.12.04.19.59.37;	author tg;	state Exp;
branches;
next	1.484.2.7;
commitid	1004EDBD1266A61D50A;

1.484.2.7
date	2011.12.11.18.18.18;	author tg;	state Exp;
branches;
next	1.484.2.8;
commitid	1004EE4F3FF0C99C8CA;

1.484.2.8
date	2011.12.31.02.25.21;	author tg;	state Exp;
branches;
next	1.484.2.9;
commitid	1004EFE72A268DB0925;

1.484.2.9
date	2011.12.31.02.54.13;	author tg;	state Exp;
branches;
next	1.484.2.10;
commitid	1004EFE796B294601A5;

1.484.2.10
date	2012.02.11.15.25.26;	author tg;	state Exp;
branches;
next	1.484.2.11;
commitid	1004F36887A2CA1070B;

1.484.2.11
date	2012.03.03.21.41.37;	author tg;	state Exp;
branches;
next	1.484.2.12;
commitid	1004F529027715CBC71;

1.484.2.12
date	2012.03.24.21.22.27;	author tg;	state Exp;
branches;
next	1.484.2.13;
commitid	1004F6E3A967ACCD93A;

1.484.2.13
date	2012.04.06.14.40.08;	author tg;	state Exp;
branches;
next	1.484.2.14;
commitid	1004F7F0056695FD460;

1.484.2.14
date	2012.04.06.23.10.45;	author tg;	state Exp;
branches;
next	;
commitid	1004F7F780C31C894F7;

1.373.2.1
date	2008.11.19.21.10.12;	author tg;	state Exp;
branches;
next	;
commitid	100492480CA4DEFE70C;

1.182.2.1
date	2007.05.13.19.29.31;	author tg;	state Exp;
branches;
next	1.182.2.2;
commitid	1004647668D4636830B;

1.182.2.2
date	2007.05.24.10.53.58;	author tg;	state Exp;
branches;
next	1.182.2.3;
commitid	10046556ED772F4D319;

1.182.2.3
date	2007.07.05.11.49.12;	author tg;	state Exp;
branches;
next	;
commitid	100468CDAAD5BCF14BE;

1.111.2.1
date	2007.03.03.21.37.50;	author tg;	state Exp;
branches;
next	;
commitid	10045E9EAC27ABA6ADF;

1.48.2.1
date	2006.08.15.23.49.51;	author tg;	state Exp;
branches;
next	1.48.2.2;
commitid	10044E25D6841FC583E;

1.48.2.2
date	2006.08.18.19.04.34;	author tg;	state Exp;
branches;
next	1.48.2.3;
commitid	10044E60F4E50D3F577;

1.48.2.3
date	2006.08.24.20.15.01;	author tg;	state Exp;
branches;
next	1.48.2.4;
commitid	10044EE08D04234D990;

1.48.2.4
date	2006.08.24.20.52.08;	author tg;	state Exp;
branches;
next	1.48.2.5;
commitid	10044EE117A130AF943;

1.48.2.5
date	2006.08.28.01.26.49;	author tg;	state Exp;
branches;
next	1.48.2.6;
commitid	10044F2466702B104A5;

1.48.2.6
date	2006.08.28.01.49.14;	author tg;	state Exp;
branches;
next	;
commitid	10044F24B9666020C36;


desc
@@


1.747
log
@add explicit support for lacc as compiler; fix vv $CC --version mis-called

 https://github.com/larmel/lacc
@
text
@#!/bin/sh
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.744 2019/09/05 14:32:04 tg Exp $'
#-
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
#		2011, 2012, 2013, 2014, 2015, 2016, 2017, 2019,
#		2020
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# People analysing the output must whitelist conftest.c for any kind
# of compiler warning checks (mirtoconf is by design not quiet).
#
# Used environment documentation is at the end of this file.

LC_ALL=C; LANGUAGE=C
export LC_ALL; unset LANGUAGE

case $ZSH_VERSION:$VERSION in
:zsh*) ZSH_VERSION=2 ;;
esac

if test -n "${ZSH_VERSION+x}" && (emulate sh) >/dev/null 2>&1; then
	emulate sh
	NULLCMD=:
fi

if test -d /usr/xpg4/bin/. >/dev/null 2>&1; then
	# Solaris: some of the tools have weird behaviour, use portable ones
	PATH=/usr/xpg4/bin:$PATH
	export PATH
fi

nl='
'
safeIFS='	'
safeIFS=" $safeIFS$nl"
IFS=$safeIFS
allu=QWERTYUIOPASDFGHJKLZXCVBNM
alll=qwertyuiopasdfghjklzxcvbnm
alln=0123456789
alls=______________________________________________________________

case `echo a | tr '\201' X` in
X)
	# EBCDIC build system
	lfcr='\n\r'
	;;
*)
	lfcr='\012\015'
	;;
esac

genopt_die() {
	if test -n "$1"; then
		echo >&2 "E: $*"
		echo >&2 "E: in '$srcfile': '$line'"
	else
		echo >&2 "E: invalid input in '$srcfile': '$line'"
	fi
	rm -f "$bn.gen"
	exit 1
}

genopt_soptc() {
	optc=`echo "$line" | sed 's/^[<>]\(.\).*$/\1/'`
	test x"$optc" = x'|' && return
	optclo=`echo "$optc" | tr $allu $alll`
	if test x"$optc" = x"$optclo"; then
		islo=1
	else
		islo=0
	fi
	sym=`echo "$line" | sed 's/^[<>]/|/'`
	o_str=$o_str$nl"<$optclo$islo$sym"
}

genopt_scond() {
	case x$cond in
	x)
		cond=
		;;
	x*' '*)
		cond=`echo "$cond" | sed 's/^ //'`
		cond="#if $cond"
		;;
	x'!'*)
		cond=`echo "$cond" | sed 's/^!//'`
		cond="#ifndef $cond"
		;;
	x*)
		cond="#ifdef $cond"
		;;
	esac
}

do_genopt() {
	srcfile=$1
	test -f "$srcfile" || genopt_die Source file \$srcfile not set.
	bn=`basename "$srcfile" | sed 's/.opt$//'`
	o_hdr='/* +++ GENERATED FILE +++ DO NOT EDIT +++ */'
	o_gen=
	o_str=
	o_sym=
	ddefs=
	state=0
	exec <"$srcfile"
	IFS=
	while IFS= read line; do
		IFS=$safeIFS
		case $state:$line in
		2:'|'*)
			# end of input
			o_sym=`echo "$line" | sed 's/^.//'`
			o_gen=$o_gen$nl"#undef F0"
			o_gen=$o_gen$nl"#undef FN"
			o_gen=$o_gen$ddefs
			state=3
			;;
		1:@@@@)
			# start of data block
			o_gen=$o_gen$nl"#endif"
			o_gen=$o_gen$nl"#ifndef F0"
			o_gen=$o_gen$nl"#define F0 FN"
			o_gen=$o_gen$nl"#endif"
			state=2
			;;
		*:@@@@*)
			genopt_die ;;
		0:/\*-|0:\ \**|0:)
			o_hdr=$o_hdr$nl$line
			;;
		0:@@*|1:@@*)
			# start of a definition block
			sym=`echo "$line" | sed 's/^@@//'`
			if test $state = 0; then
				o_gen=$o_gen$nl"#if defined($sym)"
			else
				o_gen=$o_gen$nl"#elif defined($sym)"
			fi
			ddefs="$ddefs$nl#undef $sym"
			state=1
			;;
		0:*|3:*)
			genopt_die ;;
		1:*)
			# definition line
			o_gen=$o_gen$nl$line
			;;
		2:'<'*'|'*)
			genopt_soptc
			;;
		2:'>'*'|'*)
			genopt_soptc
			cond=`echo "$line" | sed 's/^[^|]*|//'`
			genopt_scond
			case $optc in
			'|') optc=0 ;;
			*) optc=\'$optc\' ;;
			esac
			IFS= read line || genopt_die Unexpected EOF
			IFS=$safeIFS
			test -n "$cond" && o_gen=$o_gen$nl"$cond"
			o_gen=$o_gen$nl"$line, $optc)"
			test -n "$cond" && o_gen=$o_gen$nl"#endif"
			;;
		esac
	done
	case $state:$o_sym in
	3:) genopt_die Expected optc sym at EOF ;;
	3:*) ;;
	*) genopt_die Missing EOF marker ;;
	esac
	echo "$o_str" | sort | while IFS='|' read x opts cond; do
		IFS=$safeIFS
		test -n "$x" || continue
		genopt_scond
		test -n "$cond" && echo "$cond"
		echo "\"$opts\""
		test -n "$cond" && echo "#endif"
	done | {
		echo "$o_hdr"
		echo "#ifndef $o_sym$o_gen"
		echo "#else"
		cat
		echo "#undef $o_sym"
		echo "#endif"
	} >"$bn.gen"
	IFS=$safeIFS
	return 0
}

if test x"$BUILDSH_RUN_GENOPT" = x"1"; then
	set x -G "$srcfile"
	shift
fi
if test x"$1" = x"-G"; then
	do_genopt "$2"
	exit $?
fi

echo "For the build logs, demonstrate that /dev/null and /dev/tty exist:"
ls -l /dev/null /dev/tty

v() {
	$e "$*"
	eval "$@@"
}

vv() {
	_c=$1
	shift
	$e "\$ $*" 2>&1
	eval "$@@" >vv.out 2>&1
	sed "s^${_c} " <vv.out
}

vq() {
	eval "$@@"
}

rmf() {
	for _f in "$@@"; do
		case $_f in
		*.1|*.ico) ;;
		*) rm -f "$_f" ;;
		esac
	done
}

tcfn=no
bi=
ui=
ao=
fx=
me=`basename "$0"`
orig_CFLAGS=$CFLAGS
phase=x
oldish_ed=stdout-ed,no-stderr-ed

if test -t 1; then
	bi='[1m'
	ui='[4m'
	ao='[0m'
fi

upper() {
	echo :"$@@" | sed 's/^://' | tr $alll $allu
}

# clean up after ac_testrun()
ac_testdone() {
	eval HAVE_$fu=$fv
	fr=no
	test 0 = $fv || fr=yes
	$e "$bi==> $fd...$ao $ui$fr$ao$fx"
	fx=
}

# ac_cache label: sets f, fu, fv?=0
ac_cache() {
	f=$1
	fu=`upper $f`
	eval fv=\$HAVE_$fu
	case $fv in
	0|1)
		fx=' (cached)'
		return 0
		;;
	esac
	fv=0
	return 1
}

# ac_testinit label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
# returns 1 if value was cached/implied, 0 otherwise: call ac_testdone
ac_testinit() {
	if ac_cache $1; then
		test x"$2" = x"!" && shift
		test x"$2" = x"" || shift
		fd=${3-$f}
		ac_testdone
		return 1
	fi
	fc=0
	if test x"$2" = x""; then
		ft=1
	else
		if test x"$2" = x"!"; then
			fc=1
			shift
		fi
		eval ft=\$HAVE_`upper $2`
		shift
	fi
	fd=${3-$f}
	if test $fc = "$ft"; then
		fv=$2
		fx=' (implied)'
		ac_testdone
		return 1
	fi
	$e ... $fd
	return 0
}

# pipe .c | ac_test[n] [!] label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
ac_testnnd() {
	if test x"$1" = x"!"; then
		fr=1
		shift
	else
		fr=0
	fi
	ac_testinit "$@@" || return 1
	cat >conftest.c
	vv ']' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN conftest.c $LIBS $ccpr"
	test $tcfn = no && test -f a.out && tcfn=a.out
	test $tcfn = no && test -f a.exe && tcfn=a.exe
	test $tcfn = no && test -f conftest.exe && tcfn=conftest.exe
	test $tcfn = no && test -f conftest && tcfn=conftest
	if test -f $tcfn; then
		test 1 = $fr || fv=1
	else
		test 0 = $fr || fv=1
	fi
	vscan=
	if test $phase = u; then
		test $ct = gcc && vscan='unrecogni[sz]ed'
		test $ct = hpcc && vscan='unsupported'
		test $ct = pcc && vscan='unsupported'
		test $ct = sunpro && vscan='-e ignored -e turned.off'
	fi
	test -n "$vscan" && grep $vscan vv.out >/dev/null 2>&1 && fv=$fr
	return 0
}
ac_testn() {
	ac_testnnd "$@@" || return
	rmf conftest.c conftest.o ${tcfn}* vv.out
	ac_testdone
}

# ac_ifcpp cppexpr [!] label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
ac_ifcpp() {
	expr=$1; shift
	ac_testn "$@@" <<-EOF
		#include <unistd.h>
		extern int thiswillneverbedefinedIhope(void);
		int main(void) { return (isatty(0) +
		#$expr
		    0
		#else
		/* force a failure: expr is false */
		    thiswillneverbedefinedIhope()
		#endif
		    ); }
EOF
	test x"$1" = x"!" && shift
	f=$1
	fu=`upper $f`
	eval fv=\$HAVE_$fu
	test x"$fv" = x"1"
}

add_cppflags() {
	CPPFLAGS="$CPPFLAGS $*"
}

ac_cppflags() {
	test x"$1" = x"" || fu=$1
	fv=$2
	test x"$2" = x"" && eval fv=\$HAVE_$fu
	add_cppflags -DHAVE_$fu=$fv
}

ac_test() {
	ac_testn "$@@"
	ac_cppflags
}

# ac_flags [-] add varname cflags [text] [ldflags]
ac_flags() {
	if test x"$1" = x"-"; then
		shift
		hf=1
	else
		hf=0
	fi
	fa=$1
	vn=$2
	f=$3
	ft=$4
	fl=$5
	test x"$ft" = x"" && ft="if $f can be used"
	save_CFLAGS=$CFLAGS
	CFLAGS="$CFLAGS $f"
	if test -n "$fl"; then
		save_LDFLAGS=$LDFLAGS
		LDFLAGS="$LDFLAGS $fl"
	fi
	if test 1 = $hf; then
		ac_testn can_$vn '' "$ft"
	else
		ac_testn can_$vn '' "$ft" <<-'EOF'
			/* evil apo'stroph in comment test */
			#include <unistd.h>
			int main(void) { return (isatty(0)); }
		EOF
		#'
	fi
	eval fv=\$HAVE_CAN_`upper $vn`
	if test -n "$fl"; then
		test 11 = $fa$fv || LDFLAGS=$save_LDFLAGS
	fi
	test 11 = $fa$fv || CFLAGS=$save_CFLAGS
}

# ac_header [!] header [prereq ...]
ac_header() {
	if test x"$1" = x"!"; then
		na=1
		shift
	else
		na=0
	fi
	hf=$1; shift
	hv=`echo "$hf" | tr -d "$lfcr" | tr -c $alll$allu$alln $alls`
	echo "/* NeXTstep bug workaround */" >x
	for i
	do
		case $i in
		_time)
			echo '#if HAVE_BOTH_TIME_H' >>x
			echo '#include <sys/time.h>' >>x
			echo '#include <time.h>' >>x
			echo '#elif HAVE_SYS_TIME_H' >>x
			echo '#include <sys/time.h>' >>x
			echo '#elif HAVE_TIME_H' >>x
			echo '#include <time.h>' >>x
			echo '#endif' >>x
			;;
		*)
			echo "#include <$i>" >>x
			;;
		esac
	done
	echo "#include <$hf>" >>x
	echo '#include <unistd.h>' >>x
	echo 'int main(void) { return (isatty(0)); }' >>x
	ac_testn "$hv" "" "<$hf>" <x
	rmf x
	test 1 = $na || ac_cppflags
}

addsrcs() {
	if test x"$1" = x"!"; then
		fr=0
		shift
	else
		fr=1
	fi
	eval i=\$$1
	test $fr = "$i" && case " $SRCS " in
	*\ $2\ *)	;;
	*)		SRCS="$SRCS $2" ;;
	esac
}


curdir=`pwd` srcdir=`dirname "$0" 2>/dev/null`
case x$srcdir in
x)
	srcdir=.
	;;
*\ *|*"	"*|*"$nl"*)
	echo >&2 Source directory should not contain space or tab or newline.
	echo >&2 Errors may occur.
	;;
*"'"*)
	echo Source directory must not contain single quotes.
	exit 1
	;;
esac
dstversion=`sed -n '/define MKSH_VERSION/s/^.*"\([^"]*\)".*$/\1/p' "$srcdir/sh.h"`
add_cppflags -DMKSH_BUILDSH

e=echo
r=0
eq=0
pm=0
cm=normal
optflags=-std-compile-opts
check_categories=
last=
tfn=
legacy=0
textmode=0
ebcdic=false

for i
do
	case $last:$i in
	c:dragonegg|c:llvm)
		cm=$i
		last=
		;;
	c:*)
		echo "$me: Unknown option -c '$i'!" >&2
		exit 1
		;;
	o:*)
		optflags=$i
		last=
		;;
	:-c)
		last=c
		;;
	:-E)
		ebcdic=true
		;;
	:-G)
		echo "$me: Do not call me with '-G'!" >&2
		exit 1
		;;
	:-g)
		# checker, debug, valgrind build
		add_cppflags -DDEBUG
		CFLAGS="$CFLAGS -g3 -fno-builtin"
		;;
	:-j)
		pm=1
		;;
	:-L)
		legacy=1
		;;
	:+L)
		legacy=0
		;;
	:-M)
		cm=makefile
		;;
	:-O)
		optflags=-std-compile-opts
		;;
	:-o)
		last=o
		;;
	:-Q)
		eq=1
		;;
	:-r)
		r=1
		;;
	:-T)
		textmode=1
		;;
	:+T)
		textmode=0
		;;
	:-v)
		echo "Build.sh $srcversion"
		echo "for mksh $dstversion"
		exit 0
		;;
	:*)
		echo "$me: Unknown option '$i'!" >&2
		exit 1
		;;
	*)
		echo "$me: Unknown option -'$last' '$i'!" >&2
		exit 1
		;;
	esac
done
if test -n "$last"; then
	echo "$me: Option -'$last' not followed by argument!" >&2
	exit 1
fi

test -z "$tfn" && if test $legacy = 0; then
	tfn=mksh
else
	tfn=lksh
fi
if test -d $tfn || test -d $tfn.exe; then
	echo "$me: Error: ./$tfn is a directory!" >&2
	exit 1
fi
rmf a.exe* a.out* conftest.c conftest.exe* *core core.* ${tfn}* *.bc *.dbg \
    *.ll *.o *.gen *.cat1 Rebuild.sh lft no signames.inc test.sh x vv.out

SRCS="lalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c jobs.c"
SRCS="$SRCS lex.c main.c misc.c shf.c syn.c tree.c var.c"

if test $legacy = 0; then
	check_categories="$check_categories shell:legacy-no int:32"
else
	check_categories="$check_categories shell:legacy-yes"
	add_cppflags -DMKSH_LEGACY_MODE
fi

if $ebcdic; then
	add_cppflags -DMKSH_EBCDIC
fi

if test $textmode = 0; then
	check_categories="$check_categories shell:textmode-no shell:binmode-yes"
else
	check_categories="$check_categories shell:textmode-yes shell:binmode-no"
	add_cppflags -DMKSH_WITH_TEXTMODE
fi

if test x"$srcdir" = x"."; then
	CPPFLAGS="-I. $CPPFLAGS"
else
	CPPFLAGS="-I. -I'$srcdir' $CPPFLAGS"
fi
test -n "$LDSTATIC" && if test -n "$LDFLAGS"; then
	LDFLAGS="$LDFLAGS $LDSTATIC"
else
	LDFLAGS=$LDSTATIC
fi

if test -z "$TARGET_OS"; then
	x=`uname -s 2>/dev/null || uname`
	test x"$x" = x"`uname -n 2>/dev/null`" || TARGET_OS=$x
fi
if test -z "$TARGET_OS"; then
	echo "$me: Set TARGET_OS, your uname is broken!" >&2
	exit 1
fi
oswarn=
ccpc=-Wc,
ccpl=-Wl,
tsts=
ccpr='|| for _f in ${tcfn}*; do case $_f in *.1|*.ico) ;; *) rm -f "$_f" ;; esac; done'

# Evil hack
if test x"$TARGET_OS" = x"Android"; then
	check_categories="$check_categories android"
	TARGET_OS=Linux
fi

# Evil OS
if test x"$TARGET_OS" = x"Minix"; then
	echo >&2 "
WARNING: additional checks before running Build.sh required!
You can avoid these by calling Build.sh correctly, see below.
"
	cat >conftest.c <<'EOF'
#include <sys/types.h>
const char *
#ifdef _NETBSD_SOURCE
ct="Ninix3"
#else
ct="Minix3"
#endif
;
EOF
	ct=unknown
	vv ']' "${CC-cc} -E $CFLAGS $CPPFLAGS $NOWARN conftest.c | grep ct= | tr -d \\\\015 >x"
	sed 's/^/[ /' x
	eval `cat x`
	rmf x vv.out
	case $ct in
	Minix3|Ninix3)
		echo >&2 "
Warning: you set TARGET_OS to $TARGET_OS but that is ambiguous.
Please set it to either Minix3 or Ninix3, whereas the latter is
all versions of Minix with even partial NetBSD(R) userland. The
value determined from your compiler for the current compilation
(which may be wrong) is: $ct
"
		TARGET_OS=$ct
		;;
	*)
		echo >&2 "
Warning: you set TARGET_OS to $TARGET_OS but that is ambiguous.
Please set it to either Minix3 or Ninix3, whereas the latter is
all versions of Minix with even partial NetBSD(R) userland. The
proper value couldn't be determined, continue at your own risk.
"
		;;
	esac
fi

# Configuration depending on OS revision, on OSes that need them
case $TARGET_OS in
NEXTSTEP)
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`hostinfo 2>&1 | \
	    grep 'NeXT Mach [0-9][0-9.]*:' | \
	    sed 's/^.*NeXT Mach \([0-9][0-9.]*\):.*$/\1/'`
	;;
QNX|SCO_SV)
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`uname -r`
	;;
esac

# Configuration depending on OS name
case $TARGET_OS in
386BSD)
	: "${HAVE_CAN_OTWO=0}"
	add_cppflags -DMKSH_NO_SIGSETJMP
	add_cppflags -DMKSH_TYPEDEF_SIG_ATOMIC_T=int
	;;
AIX)
	add_cppflags -D_ALL_SOURCE
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
BeOS)
	case $KSH_VERSION in
	*MIRBSD\ KSH*)
		oswarn="; it has minor issues"
		;;
	*)
		oswarn="; you must recompile mksh with"
		oswarn="$oswarn${nl}itself in a second stage"
		;;
	esac
	# BeOS has no real tty either
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_DISABLE_TTY_WARNING
	# BeOS doesn't have different UIDs and GIDs
	add_cppflags -DMKSH__NO_SETEUGID
	;;
BSD/OS)
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
Coherent)
	oswarn="; it has major issues"
	add_cppflags -DMKSH__NO_SYMLINK
	check_categories="$check_categories nosymlink"
	add_cppflags -DMKSH__NO_SETEUGID
	add_cppflags -DMKSH_DISABLE_TTY_WARNING
	;;
CYGWIN*)
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
Darwin)
	add_cppflags -D_DARWIN_C_SOURCE
	;;
DragonFly)
	;;
FreeBSD)
	;;
FreeMiNT)
	oswarn="; it has minor issues"
	add_cppflags -D_GNU_SOURCE
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
GNU)
	case $CC in
	*tendracc*) ;;
	*) add_cppflags -D_GNU_SOURCE ;;
	esac
	add_cppflags -DSETUID_CAN_FAIL_WITH_EAGAIN
	# define MKSH__NO_PATH_MAX to use Hurd-only functions
	add_cppflags -DMKSH__NO_PATH_MAX
	;;
GNU/kFreeBSD)
	case $CC in
	*tendracc*) ;;
	*) add_cppflags -D_GNU_SOURCE ;;
	esac
	add_cppflags -DSETUID_CAN_FAIL_WITH_EAGAIN
	;;
Haiku)
	add_cppflags -DMKSH_ASSUME_UTF8
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=0
	;;
Harvey)
	add_cppflags -D_POSIX_SOURCE
	add_cppflags -D_LIMITS_EXTENSION
	add_cppflags -D_BSD_EXTENSION
	add_cppflags -D_SUSV2_SOURCE
	add_cppflags -D_GNU_SOURCE
	add_cppflags -DMKSH_ASSUME_UTF8
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=0
	add_cppflags -DMKSH__NO_SYMLINK
	check_categories="$check_categories nosymlink"
	add_cppflags -DMKSH_NO_CMDLINE_EDITING
	add_cppflags -DMKSH__NO_SETEUGID
	oswarn=' and will currently not work'
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_NOPROSPECTOFWORK
	# these taken from Harvey-OS github and need re-checking
	add_cppflags -D_setjmp=setjmp -D_longjmp=longjmp
	: "${HAVE_CAN_NO_EH_FRAME=0}"
	: "${HAVE_CAN_FNOSTRICTALIASING=0}"
	: "${HAVE_CAN_FSTACKPROTECTORSTRONG=0}"
	;;
HP-UX)
	;;
Interix)
	ccpc='-X '
	ccpl='-Y '
	add_cppflags -D_ALL_SOURCE
	: "${LIBS=-lcrypt}"
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
IRIX*)
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
Jehanne)
	add_cppflags -DMKSH_ASSUME_UTF8
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=0
	add_cppflags -DMKSH__NO_SYMLINK
	check_categories="$check_categories nosymlink"
	add_cppflags -DMKSH_NO_CMDLINE_EDITING
	add_cppflags -DMKSH_DISABLE_REVOKE_WARNING
	add_cppflags '-D_PATH_DEFPATH=\"/cmd\"'
	add_cppflags '-DMKSH_DEFAULT_EXECSHELL=\"/cmd/mksh\"'
	add_cppflags '-DMKSH_DEFAULT_PROFILEDIR=\"/cfg/mksh\"'
	add_cppflags '-DMKSH_ENVDIR=\"/env\"'
	SRCS="$SRCS jehanne.c"
	;;
Linux)
	case $CC in
	*tendracc*) ;;
	*) add_cppflags -D_GNU_SOURCE ;;
	esac
	add_cppflags -DSETUID_CAN_FAIL_WITH_EAGAIN
	: "${HAVE_REVOKE=0}"
	;;
LynxOS)
	oswarn="; it has minor issues"
	;;
midipix)
	add_cppflags -D_GNU_SOURCE
	# their Perl (currently) identifies as os:linux 
	check_categories="$check_categories os:midipix"
	;;
MidnightBSD)
	;;
Minix-vmd)
	add_cppflags -DMKSH__NO_SETEUGID
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -D_MINIX_SOURCE
	oldish_ed=no-stderr-ed		# no /bin/ed, maybe see below
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
Minix3)
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_NO_LIMITS
	add_cppflags -D_POSIX_SOURCE -D_POSIX_1_SOURCE=2 -D_MINIX
	oldish_ed=no-stderr-ed		# /usr/bin/ed(!) is broken
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
MirBSD)
	;;
MSYS_*)
	add_cppflags -DMKSH_ASSUME_UTF8=0
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=1
	# almost same as CYGWIN* (from RT|Chatzilla)
	: "${HAVE_SETLOCALE_CTYPE=0}"
	# broken on this OE (from ir0nh34d)
	: "${HAVE_STDINT_H=0}"
	;;
NetBSD)
	;;
NEXTSTEP)
	add_cppflags -D_NEXT_SOURCE
	add_cppflags -D_POSIX_SOURCE
	: "${AWK=gawk}"
	: "${CC=cc -posix}"
	add_cppflags -DMKSH_NO_SIGSETJMP
	# NeXTstep cannot get a controlling tty
	add_cppflags -DMKSH_UNEMPLOYED
	case $TARGET_OSREV in
	4.2*)
		# OpenStep 4.2 is broken by default
		oswarn="; it needs libposix.a"
		;;
	esac
	;;
Ninix3)
	# similar to Minix3
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_NO_LIMITS
	# but no idea what else could be needed
	oswarn="; it has unknown issues"
	;;
OpenBSD)
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
OS/2)
	add_cppflags -DMKSH_ASSUME_UTF8=0
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=1
	HAVE_TERMIOS_H=0
	HAVE_MKNOD=0	# setmode() incompatible
	oswarn="; it is being ported"
	check_categories="$check_categories nosymlink"
	: "${CC=gcc}"
	: "${SIZE=: size}"
	SRCS="$SRCS os2.c"
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_NOPROSPECTOFWORK
	add_cppflags -DMKSH_NO_LIMITS
	add_cppflags -DMKSH_DOSPATH
	if test $textmode = 0; then
		x='dis'
		y='standard OS/2 tools'
	else
		x='en'
		y='standard Unix mksh and other tools'
	fi
	echo >&2 "
OS/2 Note: mksh can be built with or without 'textmode'.
Without 'textmode' it will behave like a standard Unix utility,
compatible to mksh on all other platforms, using only ASCII LF
(0x0A) as line ending character. This is supported by the mksh
upstream developer.
With 'textmode', mksh will be modified to behave more like other
OS/2 utilities, supporting ASCII CR+LF (0x0D 0x0A) as line ending
at the cost of deviation from standard mksh. This is supported by
the mksh-os2 porter.

] You are currently compiling with textmode ${x}abled, introducing
] incompatibilities with $y.
"
	;;
OS/390)
	add_cppflags -DMKSH_ASSUME_UTF8=0
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=1
	: "${CC=xlc}"
	: "${SIZE=: size}"
	add_cppflags -DMKSH_FOR_Z_OS
	add_cppflags -D_ALL_SOURCE
	oswarn='; EBCDIC support is incomplete'
	;;
OSF1)
	HAVE_SIG_T=0	# incompatible
	add_cppflags -D_OSF_SOURCE
	add_cppflags -D_POSIX_C_SOURCE=200112L
	add_cppflags -D_XOPEN_SOURCE=600
	add_cppflags -D_XOPEN_SOURCE_EXTENDED
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
Plan9)
	add_cppflags -D_POSIX_SOURCE
	add_cppflags -D_LIMITS_EXTENSION
	add_cppflags -D_BSD_EXTENSION
	add_cppflags -D_SUSV2_SOURCE
	add_cppflags -DMKSH_ASSUME_UTF8
	HAVE_ISSET_MKSH_ASSUME_UTF8=1
	HAVE_ISOFF_MKSH_ASSUME_UTF8=0
	add_cppflags -DMKSH__NO_SYMLINK
	check_categories="$check_categories nosymlink"
	add_cppflags -DMKSH_NO_CMDLINE_EDITING
	add_cppflags -DMKSH__NO_SETEUGID
	oswarn=' and will currently not work'
	add_cppflags -DMKSH_UNEMPLOYED
	# this is for detecting kencc
	add_cppflags -DMKSH_MAYBE_KENCC
	;;
PW32*)
	HAVE_SIG_T=0	# incompatible
	oswarn=' and will currently not work'
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
QNX)
	add_cppflags -D__NO_EXT_QNX
	add_cppflags -D__EXT_UNIX_MISC
	case $TARGET_OSREV in
	[012345].*|6.[0123].*|6.4.[01])
		oldish_ed=no-stderr-ed		# oldish /bin/ed is broken
		;;
	esac
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
SCO_SV)
	case $TARGET_OSREV in
	3.2*)
		# SCO OpenServer 5
		add_cppflags -DMKSH_UNEMPLOYED
		;;
	5*)
		# SCO OpenServer 6
		;;
	*)
		oswarn='; this is an unknown version of'
		oswarn="$oswarn$nl$TARGET_OS ${TARGET_OSREV}, please tell me what to do"
		;;
	esac
	: "${HAVE_SYS_SIGLIST=0}${HAVE__SYS_SIGLIST=0}"
	;;
skyos)
	oswarn="; it has minor issues"
	;;
SunOS)
	add_cppflags -D_BSD_SOURCE
	add_cppflags -D__EXTENSIONS__
	;;
syllable)
	add_cppflags -D_GNU_SOURCE
	add_cppflags -DMKSH_NO_SIGSUSPEND
	oswarn=' and will currently not work'
	;;
ULTRIX)
	: "${CC=cc -YPOSIX}"
	add_cppflags -DMKSH_TYPEDEF_SSIZE_T=int
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
UnixWare|UNIX_SV)
	# SCO UnixWare
	: "${HAVE_SYS_SIGLIST=0}${HAVE__SYS_SIGLIST=0}"
	;;
UWIN*)
	ccpc='-Yc,'
	ccpl='-Yl,'
	tsts=" 3<>/dev/tty"
	oswarn="; it will compile, but the target"
	oswarn="$oswarn${nl}platform itself is very flakey/unreliable"
	: "${HAVE_SETLOCALE_CTYPE=0}"
	;;
_svr4)
	# generic target for SVR4 Unix with uname -s = uname -n
	# this duplicates the * target below
	oswarn='; it may or may not work'
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`uname -r`
	;;
*)
	oswarn='; it may or may not work'
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`uname -r`
	;;
esac

: "${HAVE_MKNOD=0}"

: "${AWK=awk}${CC=cc}${NROFF=nroff}${SIZE=size}"
test 0 = $r && echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && \
    echo | $NROFF -c >/dev/null 2>&1 && NROFF="$NROFF -c"

# this aids me in tracing FTBFSen without access to the buildd
$e "Hi from$ao $bi$srcversion$ao on:"
case $TARGET_OS in
AIX)
	vv '|' "oslevel >&2"
	vv '|' "uname -a >&2"
	;;
Darwin)
	vv '|' "hwprefs machine_type os_type os_class >&2"
	vv '|' "sw_vers >&2"
	vv '|' "system_profiler -detailLevel mini SPSoftwareDataType SPHardwareDataType >&2"
	vv '|' "/bin/sh --version >&2"
	vv '|' "xcodebuild -version >&2"
	vv '|' "uname -a >&2"
	vv '|' "sysctl kern.version hw.machine hw.model hw.memsize hw.availcpu hw.ncpu hw.cpufrequency hw.byteorder hw.cpu64bit_capable >&2"
	vv '|' "sysctl hw.cpufrequency hw.byteorder hw.cpu64bit_capable hw.ncpu >&2"
	;;
IRIX*)
	vv '|' "uname -a >&2"
	vv '|' "hinv -v >&2"
	;;
OSF1)
	vv '|' "uname -a >&2"
	vv '|' "/usr/sbin/sizer -v >&2"
	;;
SCO_SV|UnixWare|UNIX_SV)
	vv '|' "uname -a >&2"
	vv '|' "uname -X >&2"
	;;
*)
	vv '|' "uname -a >&2"
	;;
esac
test -z "$oswarn" || echo >&2 "
Warning: mksh has not yet been ported to or tested on your
operating system '$TARGET_OS'$oswarn. If you can provide
a shell account to the developer, this may improve; please
drop us a success or failure notice or even send in diffs,
at the very least, complete logs (Build.sh + test.sh) will help.
"
$e "$bi$me: Building the MirBSD Korn Shell$ao $ui$dstversion$ao on $TARGET_OS ${TARGET_OSREV}..."

#
# Start of mirtoconf checks
#
$e $bi$me: Scanning for functions... please ignore any errors.$ao

#
# Compiler: which one?
#
# notes:
# - ICC defines __GNUC__ too
# - GCC defines __hpux too
# - LLVM+clang defines __GNUC__ too
# - nwcc defines __GNUC__ too
CPP="$CC -E"
$e ... which compiler type seems to be used
cat >conftest.c <<'EOF'
const char *
#if defined(__ICC) || defined(__INTEL_COMPILER)
ct="icc"
#elif defined(__xlC__) || defined(__IBMC__)
ct="xlc"
#elif defined(__SUNPRO_C)
ct="sunpro"
#elif defined(__neatcc__)
ct="neatcc"
#elif defined(__lacc__)
ct="lacc"
#elif defined(__ACK__)
ct="ack"
#elif defined(__BORLANDC__)
ct="bcc"
#elif defined(__WATCOMC__)
ct="watcom"
#elif defined(__MWERKS__)
ct="metrowerks"
#elif defined(__HP_cc)
ct="hpcc"
#elif defined(__DECC) || (defined(__osf__) && !defined(__GNUC__))
ct="dec"
#elif defined(__PGI)
ct="pgi"
#elif defined(__DMC__)
ct="dmc"
#elif defined(_MSC_VER)
ct="msc"
#elif defined(__ADSPBLACKFIN__) || defined(__ADSPTS__) || defined(__ADSP21000__)
ct="adsp"
#elif defined(__IAR_SYSTEMS_ICC__)
ct="iar"
#elif defined(SDCC)
ct="sdcc"
#elif defined(__PCC__)
ct="pcc"
#elif defined(__TenDRA__)
ct="tendra"
#elif defined(__TINYC__)
ct="tcc"
#elif defined(__llvm__) && defined(__clang__)
ct="clang"
#elif defined(__NWCC__)
ct="nwcc"
#elif defined(__GNUC__)
ct="gcc"
#elif defined(_COMPILER_VERSION)
ct="mipspro"
#elif defined(__sgi)
ct="mipspro"
#elif defined(__hpux) || defined(__hpua)
ct="hpcc"
#elif defined(__ultrix)
ct="ucode"
#elif defined(__USLC__)
ct="uslc"
#elif defined(__LCC__)
ct="lcc"
#elif defined(MKSH_MAYBE_KENCC)
/* and none of the above matches */
ct="kencc"
#else
ct="unknown"
#endif
;
const char *
#if defined(__KLIBC__) && !defined(__OS2__)
et="klibc"
#else
et="unknown"
#endif
;
EOF
ct=untested
et=untested
vv ']' "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c | \
    sed -n '/^ *[ce]t *= */s/^ *\([ce]t\) *= */\1=/p' | tr -d \\\\015 >x"
sed 's/^/[ /' x
eval `cat x`
rmf x vv.out
cat >conftest.c <<'EOF'
#include <unistd.h>
int main(void) { return (isatty(0)); }
EOF
case $ct in
ack)
	# work around "the famous ACK const bug"
	CPPFLAGS="-Dconst= $CPPFLAGS"
	;;
adsp)
	echo >&2 'Warning: Analog Devices C++ compiler for Blackfin, TigerSHARC
    and SHARC (21000) DSPs detected. This compiler has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
	;;
bcc)
	echo >&2 "Warning: Borland C++ Builder detected. This compiler might
    produce broken executables. Continue at your own risk,
    please report success/failure to the developers."
	;;
clang)
	# does not work with current "ccc" compiler driver
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -version"
	# one of these two works, for now
	vv '|' "${CLANG-clang} -version"
	vv '|' "${CLANG-clang} --version"
	# ensure compiler and linker are in sync unless overridden
	case $CCC_CC:$CCC_LD in
	:*)	;;
	*:)	CCC_LD=$CCC_CC; export CCC_LD ;;
	esac
	: "${HAVE_STRING_POOLING=i1}"
	;;
dec)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -V"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -Wl,-V conftest.c $LIBS"
	;;
dmc)
	echo >&2 "Warning: Digital Mars Compiler detected. When running under"
	echo >&2 "    UWIN, mksh tends to be unstable due to the limitations"
	echo >&2 "    of this platform. Continue at your own risk,"
	echo >&2 "    please report success/failure to the developers."
	;;
gcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	vv '|' 'eval echo "\`$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -dumpmachine\`" \
		 "gcc\`$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -dumpversion\`"'
	: "${HAVE_STRING_POOLING=i2}"
	;;
hpcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
	;;
iar)
	echo >&2 'Warning: IAR Systems (http://www.iar.com) compiler for embedded
    systems detected. This unsupported compiler has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
	;;
icc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -V"
	;;
kencc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	;;
lacc)
	# no version information
	;;
lcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	add_cppflags -D__inline__=__inline
	;;
metrowerks)
	echo >&2 'Warning: Metrowerks C compiler detected. This has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
	;;
mipspro)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -version"
	;;
msc)
	ccpr=		# errorlevels are not reliable
	case $TARGET_OS in
	Interix)
		if [[ -n $C89_COMPILER ]]; then
			C89_COMPILER=`ntpath2posix -c "$C89_COMPILER"`
		else
			C89_COMPILER=CL.EXE
		fi
		if [[ -n $C89_LINKER ]]; then
			C89_LINKER=`ntpath2posix -c "$C89_LINKER"`
		else
			C89_LINKER=LINK.EXE
		fi
		vv '|' "$C89_COMPILER /HELP >&2"
		vv '|' "$C89_LINKER /LINK >&2"
		;;
	esac
	;;
neatcc)
	add_cppflags -DMKSH_DONT_EMIT_IDSTRING
	add_cppflags -DMKSH_NO_SIGSETJMP
	add_cppflags -Dsig_atomic_t=int
	vv '|' "$CC"
	;;
nwcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -version"
	;;
pcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -v"
	;;
pgi)
	echo >&2 'Warning: PGI detected. This unknown compiler has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
	;;
sdcc)
	echo >&2 'Warning: sdcc (http://sdcc.sourceforge.net), the small devices
    C compiler for embedded systems detected. This has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
	;;
sunpro)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
	;;
tcc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -v"
	;;
tendra)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -V 2>&1 | \
	    grep -F -i -e version -e release"
	;;
ucode)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -V"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -Wl,-V conftest.c $LIBS"
	;;
uslc)
	case $TARGET_OS:$TARGET_OSREV in
	SCO_SV:3.2*)
		# SCO OpenServer 5
		CFLAGS="$CFLAGS -g"
		: "${HAVE_CAN_OTWO=0}${HAVE_CAN_OPTIMISE=0}"
		;;
	esac
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
	;;
watcom)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	;;
xlc)
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -qversion"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS -qversion=verbose"
	vv '|' "ld -V"
	;;
*)
	test x"$ct" = x"untested" && $e "!!! detecting preprocessor failed"
	ct=unknown
	vv '|' "$CC --version"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
	;;
esac
case $cm in
dragonegg|llvm)
	vv '|' "llc -version"
	;;
esac
etd=" on $et"
case $et in
klibc)
	add_cppflags -DMKSH_NO_LIMITS
	;;
unknown)
	# nothing special detected, dont worry
	etd=
	;;
*)
	# huh?
	;;
esac
$e "$bi==> which compiler type seems to be used...$ao $ui$ct$etd$ao"
rmf conftest.c conftest.o conftest a.out* a.exe* conftest.exe* vv.out

#
# Compiler: works as-is, with -Wno-error and -Werror
#
save_NOWARN=$NOWARN
NOWARN=
DOWARN=
ac_flags 0 compiler_works '' 'if the compiler works'
test 1 = $HAVE_CAN_COMPILER_WORKS || exit 1
HAVE_COMPILER_KNOWN=0
test $ct = unknown || HAVE_COMPILER_KNOWN=1
if ac_ifcpp 'if 0' compiler_fails '' \
    'if the compiler does not fail correctly'; then
	save_CFLAGS=$CFLAGS
	: "${HAVE_CAN_DELEXE=x}"
	case $ct in
	dec)
		CFLAGS="$CFLAGS ${ccpl}-non_shared"
		ac_testn can_delexe compiler_fails 0 'for the -non_shared linker option' <<-'EOF'
			#include <unistd.h>
			int main(void) { return (isatty(0)); }
		EOF
		;;
	dmc)
		CFLAGS="$CFLAGS ${ccpl}/DELEXECUTABLE"
		ac_testn can_delexe compiler_fails 0 'for the /DELEXECUTABLE linker option' <<-'EOF'
			#include <unistd.h>
			int main(void) { return (isatty(0)); }
		EOF
		;;
	*)
		exit 1
		;;
	esac
	test 1 = $HAVE_CAN_DELEXE || CFLAGS=$save_CFLAGS
	ac_ifcpp 'if 0' compiler_still_fails \
	    'if the compiler still does not fail correctly' && exit 1
fi
if ac_ifcpp 'ifdef __TINYC__' couldbe_tcc '!' compiler_known 0 \
    'if this could be tcc'; then
	ct=tcc
	CPP='cpp -D__TINYC__'
	HAVE_COMPILER_KNOWN=1
fi

case $ct in
bcc)
	save_NOWARN="${ccpc}-w"
	DOWARN="${ccpc}-w!"
	;;
dec)
	# -msg_* flags not used yet, or is -w2 correct?
	;;
dmc)
	save_NOWARN="${ccpc}-w"
	DOWARN="${ccpc}-wx"
	;;
hpcc)
	save_NOWARN=
	DOWARN=+We
	;;
kencc)
	save_NOWARN=
	DOWARN=
	;;
mipspro)
	save_NOWARN=
	DOWARN="-diag_error 1-10000"
	;;
msc)
	save_NOWARN="${ccpc}/w"
	DOWARN="${ccpc}/WX"
	;;
sunpro)
	test x"$save_NOWARN" = x"" && save_NOWARN='-errwarn=%none'
	ac_flags 0 errwarnnone "$save_NOWARN"
	test 1 = $HAVE_CAN_ERRWARNNONE || save_NOWARN=
	ac_flags 0 errwarnall "-errwarn=%all"
	test 1 = $HAVE_CAN_ERRWARNALL && DOWARN="-errwarn=%all"
	;;
tendra)
	save_NOWARN=-w
	;;
ucode)
	save_NOWARN=
	DOWARN=-w2
	;;
watcom)
	save_NOWARN=
	DOWARN=-Wc,-we
	;;
xlc)
	case $TARGET_OS in
	OS/390)
		save_NOWARN=-qflag=e
		DOWARN=-qflag=i
		;;
	*)
		save_NOWARN=-qflag=i:e
		DOWARN=-qflag=i:i
		;;
	esac
	;;
*)
	test x"$save_NOWARN" = x"" && save_NOWARN=-Wno-error
	ac_flags 0 wnoerror "$save_NOWARN"
	test 1 = $HAVE_CAN_WNOERROR || save_NOWARN=
	ac_flags 0 werror -Werror
	test 1 = $HAVE_CAN_WERROR && DOWARN=-Werror
	test $ct = icc && DOWARN="$DOWARN -wd1419"
	;;
esac
NOWARN=$save_NOWARN

#
# Compiler: extra flags (-O2 -f* -W* etc.)
#
i=`echo :"$orig_CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln`
# optimisation: only if orig_CFLAGS is empty
test x"$i" = x"" && case $ct in
hpcc)
	phase=u
	ac_flags 1 otwo +O2
	phase=x
	;;
kencc|tcc|tendra)
	# no special optimisation
	;;
sunpro)
	cat >x <<-'EOF'
		#include <unistd.h>
		int main(void) { return (isatty(0)); }
		#define __IDSTRING_CONCAT(l,p)	__LINTED__ ## l ## _ ## p
		#define __IDSTRING_EXPAND(l,p)	__IDSTRING_CONCAT(l,p)
		#define pad			void __IDSTRING_EXPAND(__LINE__,x)(void) { }
	EOF
	yes pad | head -n 256 >>x
	ac_flags - 1 otwo -xO2 <x
	rmf x
	;;
xlc)
	ac_flags 1 othree "-O3 -qstrict"
	test 1 = $HAVE_CAN_OTHREE || ac_flags 1 otwo -O2
	;;
*)
	ac_flags 1 otwo -O2
	test 1 = $HAVE_CAN_OTWO || ac_flags 1 optimise -O
	;;
esac
# other flags: just add them if they are supported
i=0
case $ct in
bcc)
	ac_flags 1 strpool "${ccpc}-d" 'if string pooling can be enabled'
	;;
clang)
	i=1
	;;
dec)
	ac_flags 0 verb -verbose
	ac_flags 1 rodata -readonly_strings
	;;
dmc)
	ac_flags 1 decl "${ccpc}-r" 'for strict prototype checks'
	ac_flags 1 schk "${ccpc}-s" 'for stack overflow checking'
	;;
gcc)
	ac_flags 1 fnolto -fno-lto 'whether we can explicitly disable buggy GCC LTO' -fno-lto
	# The following tests run with -Werror (gcc only) if possible
	NOWARN=$DOWARN; phase=u
	ac_flags 1 wnodeprecateddecls -Wno-deprecated-declarations
	# mksh is not written in CFrustFrust!
	ac_flags 1 no_eh_frame -fno-asynchronous-unwind-tables
	ac_flags 1 fnostrictaliasing -fno-strict-aliasing
	ac_flags 1 fstackprotectorstrong -fstack-protector-strong
	test 1 = $HAVE_CAN_FSTACKPROTECTORSTRONG || \
	    ac_flags 1 fstackprotectorall -fstack-protector-all
	test $cm = dragonegg && case " $CC $CFLAGS $LDFLAGS " in
	*\ -fplugin=*dragonegg*) ;;
	*) ac_flags 1 fplugin_dragonegg -fplugin=dragonegg ;;
	esac
	case $cm in
	combine)
		fv=0
		checks='7 8'
		;;
	lto)
		fv=0
		checks='1 2 3 4 5 6 7 8'
		;;
	*)
		fv=1
		;;
	esac
	test $fv = 1 || for what in $checks; do
		test $fv = 1 && break
		case $what in
		1)	t_cflags='-flto=jobserver'
			t_ldflags='-fuse-linker-plugin'
			t_use=1 t_name=fltojs_lp ;;
		2)	t_cflags='-flto=jobserver' t_ldflags=''
			t_use=1 t_name=fltojs_nn ;;
		3)	t_cflags='-flto=jobserver'
			t_ldflags='-fno-use-linker-plugin -fwhole-program'
			t_use=1 t_name=fltojs_np ;;
		4)	t_cflags='-flto'
			t_ldflags='-fuse-linker-plugin'
			t_use=1 t_name=fltons_lp ;;
		5)	t_cflags='-flto' t_ldflags=''
			t_use=1 t_name=fltons_nn ;;
		6)	t_cflags='-flto'
			t_ldflags='-fno-use-linker-plugin -fwhole-program'
			t_use=1 t_name=fltons_np ;;
		7)	t_cflags='-fwhole-program --combine' t_ldflags=''
			t_use=0 t_name=combine cm=combine ;;
		8)	fv=1 cm=normal ;;
		esac
		test $fv = 1 && break
		ac_flags $t_use $t_name "$t_cflags" \
		    "if gcc supports $t_cflags $t_ldflags" "$t_ldflags"
	done
	ac_flags 1 data_abi_align -malign-data=abi
	i=1
	;;
hpcc)
	phase=u
	# probably not needed
	#ac_flags 1 agcc -Agcc 'for support of GCC extensions'
	phase=x
	;;
icc)
	ac_flags 1 fnobuiltinsetmode -fno-builtin-setmode
	ac_flags 1 fnostrictaliasing -fno-strict-aliasing
	ac_flags 1 fstacksecuritycheck -fstack-security-check
	i=1
	;;
mipspro)
	ac_flags 1 fullwarn -fullwarn 'for remark output support'
	;;
msc)
	ac_flags 1 strpool "${ccpc}/GF" 'if string pooling can be enabled'
	echo 'int main(void) { char test[64] = ""; return (*test); }' >x
	ac_flags - 1 stackon "${ccpc}/GZ" 'if stack checks can be enabled' <x
	ac_flags - 1 stckall "${ccpc}/Ge" 'stack checks for all functions' <x
	ac_flags - 1 secuchk "${ccpc}/GS" 'for compiler security checks' <x
	rmf x
	ac_flags 1 wall "${ccpc}/Wall" 'to enable all warnings'
	ac_flags 1 wp64 "${ccpc}/Wp64" 'to enable 64-bit warnings'
	;;
nwcc)
	#broken# ac_flags 1 ssp -stackprotect
	i=1
	;;
pcc)
	ac_flags 1 fstackprotectorall -fstack-protector-all
	i=1
	;;
sunpro)
	phase=u
	ac_flags 1 v -v
	ac_flags 1 ipo -xipo 'for cross-module optimisation'
	phase=x
	;;
tcc)
	: #broken# ac_flags 1 boundschk -b
	;;
tendra)
	ac_flags 0 ysystem -Ysystem
	test 1 = $HAVE_CAN_YSYSTEM && CPPFLAGS="-Ysystem $CPPFLAGS"
	ac_flags 1 extansi -Xa
	;;
xlc)
	case $TARGET_OS in
	OS/390)
		# On IBM z/OS, the following are warnings by default:
		# CCN3296: #include file <foo.h> not found.
		# CCN3944: Attribute "__foo__" is not supported and is ignored.
		# CCN3963: The attribute "foo" is not a valid variable attribute and is ignored.
		ac_flags 1 halton '-qhaltonmsg=CCN3296 -qhaltonmsg=CCN3944 -qhaltonmsg=CCN3963'
		# CCN3290: Unknown macro name FOO on #undef directive.
		# CCN4108: The use of keyword '__attribute__' is non-portable.
		ac_flags 1 supprss '-qsuppress=CCN3290 -qsuppress=CCN4108'
		;;
	*)
		ac_flags 1 rodata '-qro -qroconst -qroptr'
		ac_flags 1 rtcheck -qcheck=all
		#ac_flags 1 rtchkc -qextchk	# reported broken
		ac_flags 1 wformat '-qformat=all -qformat=nozln'
		;;
	esac
	#ac_flags 1 wp64 -qwarn64	# too verbose for now
	;;
esac
# flags common to a subset of compilers (run with -Werror on gcc)
if test 1 = $i; then
	ac_flags 1 wall -Wall
	ac_flags 1 fwrapv -fwrapv
fi

# on demand means: GCC version >= 4
fd='if to rely on compiler for string pooling'
ac_cache string_pooling || case $HAVE_STRING_POOLING in
2) fx=' (on demand, cached)' ;;
i1) fv=1 ;;
i2) fv=2; fx=' (on demand)' ;;
esac
ac_testdone
test x"$HAVE_STRING_POOLING" = x"0" || ac_cppflags

phase=x
# The following tests run with -Werror or similar (all compilers) if possible
NOWARN=$DOWARN
test $ct = pcc && phase=u

#
# Compiler: check for stuff that only generates warnings
#
ac_test attribute_bounded '' 'for __attribute__((__bounded__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <string.h>
	#undef __attribute__
	int xcopy(const void *, void *, size_t)
	    __attribute__((__bounded__(__buffer__, 1, 3)))
	    __attribute__((__bounded__(__buffer__, 2, 3)));
	int main(int ac, char *av[]) { return (xcopy(av[0], av[--ac], 1)); }
	int xcopy(const void *s, void *d, size_t n) {
		/*
		 * if memmove does not exist, we are not on a system
		 * with GCC with __bounded__ attribute either so poo
		 */
		memmove(d, s, n); return ((int)n);
	}
	#endif
EOF
ac_test attribute_format '' 'for __attribute__((__format__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#define fprintf printfoo
	#include <stdio.h>
	#undef __attribute__
	#undef fprintf
	extern int fprintf(FILE *, const char *format, ...)
	    __attribute__((__format__(__printf__, 2, 3)));
	int main(int ac, char *av[]) { return (fprintf(stderr, "%s%d", *av, ac)); }
	#endif
EOF
ac_test attribute_noreturn '' 'for __attribute__((__noreturn__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <stdlib.h>
	#undef __attribute__
	void fnord(void) __attribute__((__noreturn__));
	int main(void) { fnord(); }
	void fnord(void) { exit(0); }
	#endif
EOF
ac_test attribute_pure '' 'for __attribute__((__pure__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <unistd.h>
	#undef __attribute__
	int foo(const char *) __attribute__((__pure__));
	int main(int ac, char *av[]) { return (foo(av[ac - 1]) + isatty(0)); }
	int foo(const char *s) { return ((int)s[0]); }
	#endif
EOF
ac_test attribute_unused '' 'for __attribute__((__unused__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <unistd.h>
	#undef __attribute__
	int main(int ac __attribute__((__unused__)), char *av[]
	    __attribute__((__unused__))) { return (isatty(0)); }
	#endif
EOF
ac_test attribute_used '' 'for __attribute__((__used__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	extern int thiswillneverbedefinedIhope(void);
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <unistd.h>
	#undef __attribute__
	static const char fnord[] __attribute__((__used__)) = "42";
	int main(void) { return (isatty(0)); }
	#endif
EOF

# End of tests run with -Werror
NOWARN=$save_NOWARN
phase=x

#
# mksh: flavours (full/small mksh, omit certain stuff)
#
if ac_ifcpp 'ifdef MKSH_SMALL' isset_MKSH_SMALL '' \
    "if a reduced-feature mksh is requested"; then
	: "${HAVE_NICE=0}"
	: "${HAVE_PERSISTENT_HISTORY=0}"
	check_categories="$check_categories smksh"
fi
ac_ifcpp 'if defined(MKSH_BINSHPOSIX) || defined(MKSH_BINSHREDUCED)' \
    isset_MKSH_BINSH '' 'if invoking as sh should be handled specially' && \
    check_categories="$check_categories binsh"
ac_ifcpp 'ifdef MKSH_UNEMPLOYED' isset_MKSH_UNEMPLOYED '' \
    "if mksh will be built without job control" && \
    check_categories="$check_categories arge"
ac_ifcpp 'ifdef MKSH_NOPROSPECTOFWORK' isset_MKSH_NOPROSPECTOFWORK '' \
    "if mksh will be built without job signals" && \
    check_categories="$check_categories arge nojsig"
ac_ifcpp 'ifdef MKSH_ASSUME_UTF8' isset_MKSH_ASSUME_UTF8 '' \
    'if the default UTF-8 mode is specified' && : "${HAVE_SETLOCALE_CTYPE=0}"
ac_ifcpp 'if !MKSH_ASSUME_UTF8' isoff_MKSH_ASSUME_UTF8 \
    isset_MKSH_ASSUME_UTF8 0 \
    'if the default UTF-8 mode is disabled' && \
    check_categories="$check_categories noutf8"
#ac_ifcpp 'ifdef MKSH_DISABLE_DEPRECATED' isset_MKSH_DISABLE_DEPRECATED '' \
#    "if deprecated features are to be omitted" && \
#    check_categories="$check_categories nodeprecated"
#ac_ifcpp 'ifdef MKSH_DISABLE_EXPERIMENTAL' isset_MKSH_DISABLE_EXPERIMENTAL '' \
#    "if experimental features are to be omitted" && \
#    check_categories="$check_categories noexperimental"
ac_ifcpp 'ifdef MKSH_MIDNIGHTBSD01ASH_COMPAT' isset_MKSH_MIDNIGHTBSD01ASH_COMPAT '' \
    'if the MidnightBSD 0.1 ash compatibility mode is requested' && \
    check_categories="$check_categories mnbsdash"

#
# Environment: headers
#
ac_header sys/time.h sys/types.h
ac_header time.h sys/types.h
test "11" = "$HAVE_SYS_TIME_H$HAVE_TIME_H" || HAVE_BOTH_TIME_H=0
ac_test both_time_h '' 'whether <sys/time.h> and <time.h> can both be included' <<-'EOF'
	#include <sys/types.h>
	#include <sys/time.h>
	#include <time.h>
	#include <unistd.h>
	int main(void) { struct tm tm; return ((int)sizeof(tm) + isatty(0)); }
EOF
ac_header sys/bsdtypes.h
ac_header sys/file.h sys/types.h
ac_header sys/mkdev.h sys/types.h
ac_header sys/mman.h sys/types.h
ac_header sys/param.h
ac_header sys/resource.h sys/types.h _time
ac_header sys/select.h sys/types.h
ac_header sys/sysmacros.h
ac_header bstring.h
ac_header grp.h sys/types.h
ac_header io.h
ac_header libgen.h
ac_header libutil.h sys/types.h
ac_header paths.h
ac_header stdint.h stdarg.h
# include strings.h only if compatible with string.h
ac_header strings.h sys/types.h string.h
ac_header termios.h
ac_header ulimit.h sys/types.h
ac_header values.h

#
# Environment: definitions
#
echo '#include <sys/types.h>
#include <unistd.h>
/* check that off_t can represent 2^63-1 correctly, thx FSF */
#define LARGE_OFF_T ((((off_t)1 << 31) << 31) - 1 + (((off_t)1 << 31) << 31))
int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721 &&
    LARGE_OFF_T % 2147483647 == 1) ? 1 : -1];
int main(void) { return (isatty(0)); }' >lft.c
ac_testn can_lfs '' "for large file support" <lft.c
save_CPPFLAGS=$CPPFLAGS
add_cppflags -D_FILE_OFFSET_BITS=64
ac_testn can_lfs_sus '!' can_lfs 0 "... with -D_FILE_OFFSET_BITS=64" <lft.c
if test 0 = $HAVE_CAN_LFS_SUS; then
	CPPFLAGS=$save_CPPFLAGS
	add_cppflags -D_LARGE_FILES=1
	ac_testn can_lfs_aix '!' can_lfs 0 "... with -D_LARGE_FILES=1" <lft.c
	test 1 = $HAVE_CAN_LFS_AIX || CPPFLAGS=$save_CPPFLAGS
fi
rm -f lft.c
rmf lft*	# end of large file support test

#
# Environment: types
#
ac_test can_inttypes '!' stdint_h 1 "for standard 32-bit integer types" <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	int main(int ac, char *av[]) { return ((uint32_t)(size_t)*av + (int32_t)ac); }
EOF
ac_test can_ucbints '!' can_inttypes 1 "for UCB 32-bit integer types" <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	int main(int ac, char *av[]) { return ((u_int32_t)(size_t)*av + (int32_t)ac); }
EOF
ac_test can_int8type '!' stdint_h 1 "for standard 8-bit integer type" <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	int main(int ac, char *av[]) { return ((uint8_t)(size_t)av[ac]); }
EOF
ac_test can_ucbint8 '!' can_int8type 1 "for UCB 8-bit integer type" <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	int main(int ac, char *av[]) { return ((u_int8_t)(size_t)av[ac]); }
EOF

ac_test rlim_t <<-'EOF'
	#include <sys/types.h>
	#if HAVE_BOTH_TIME_H
	#include <sys/time.h>
	#include <time.h>
	#elif HAVE_SYS_TIME_H
	#include <sys/time.h>
	#elif HAVE_TIME_H
	#include <time.h>
	#endif
	#if HAVE_SYS_RESOURCE_H
	#include <sys/resource.h>
	#endif
	#include <unistd.h>
	int main(void) { return (((int)(rlim_t)0) + isatty(0)); }
EOF

# only testn: added later below
ac_testn sig_t <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	#include <stddef.h>
	volatile sig_t foo = (sig_t)0;
	int main(void) { return (foo == (sig_t)0); }
EOF

ac_testn sighandler_t '!' sig_t 0 <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	#include <stddef.h>
	volatile sighandler_t foo = (sighandler_t)0;
	int main(void) { return (foo == (sighandler_t)0); }
EOF
if test 1 = $HAVE_SIGHANDLER_T; then
	add_cppflags -Dsig_t=sighandler_t
	HAVE_SIG_T=1
fi

ac_testn __sighandler_t '!' sig_t 0 <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	#include <stddef.h>
	volatile __sighandler_t foo = (__sighandler_t)0;
	int main(void) { return (foo == (__sighandler_t)0); }
EOF
if test 1 = $HAVE___SIGHANDLER_T; then
	add_cppflags -Dsig_t=__sighandler_t
	HAVE_SIG_T=1
fi

test 1 = $HAVE_SIG_T || add_cppflags -Dsig_t=nosig_t
ac_cppflags SIG_T

#
# check whether whatever we use for the final link will succeed
#
if test $cm = makefile; then
	: nothing to check
else
	HAVE_LINK_WORKS=x
	ac_testinit link_works '' 'checking if the final link command may succeed'
	fv=1
	cat >conftest.c <<-EOF
		#define EXTERN
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		__RCSID("$srcversion");
		int main(void) {
			struct timeval tv;
			printf("Hello, World!\\n");
			return (time(&tv.tv_sec));
		}
EOF
	case $cm in
	llvm)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -emit-llvm -c conftest.c" || fv=0
		rmf $tfn.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o $tfn.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn $tfn.s $LIBS $ccpr"
		;;
	dragonegg)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -S -flto conftest.c" || fv=0
		test $fv = 0 || v "mv conftest.s conftest.ll"
		test $fv = 0 || v "llvm-as conftest.ll" || fv=0
		rmf $tfn.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o $tfn.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn $tfn.s $LIBS $ccpr"
		;;
	combine)
		v "$CC $CFLAGS $CPPFLAGS $LDFLAGS -fwhole-program --combine $NOWARN -o $tcfn conftest.c $LIBS $ccpr"
		;;
	lto|normal)
		cm=normal
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -c conftest.c" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn conftest.o $LIBS $ccpr"
		;;
	esac
	test -f $tcfn || fv=0
	ac_testdone
	test $fv = 1 || exit 1
fi

#
# Environment: errors and signals
#
test x"NetBSD" = x"$TARGET_OS" && $e Ignore the compatibility warning.

ac_testn sys_errlist '' "the sys_errlist[] array and sys_nerr" <<-'EOF'
	extern const int sys_nerr;
	extern const char * const sys_errlist[];
	extern int isatty(int);
	int main(void) { return (*sys_errlist[sys_nerr - 1] + isatty(0)); }
EOF
ac_testn _sys_errlist '!' sys_errlist 0 "the _sys_errlist[] array and _sys_nerr" <<-'EOF'
	extern const int _sys_nerr;
	extern const char * const _sys_errlist[];
	extern int isatty(int);
	int main(void) { return (*_sys_errlist[_sys_nerr - 1] + isatty(0)); }
EOF
if test 1 = "$HAVE__SYS_ERRLIST"; then
	add_cppflags -Dsys_nerr=_sys_nerr
	add_cppflags -Dsys_errlist=_sys_errlist
	HAVE_SYS_ERRLIST=1
fi
ac_cppflags SYS_ERRLIST

for what in name list; do
	uwhat=`upper $what`
	ac_testn sys_sig$what '' "the sys_sig$what[] array" <<-EOF
		extern const char * const sys_sig$what[];
		extern int isatty(int);
		int main(void) { return (sys_sig$what[0][0] + isatty(0)); }
	EOF
	ac_testn _sys_sig$what '!' sys_sig$what 0 "the _sys_sig$what[] array" <<-EOF
		extern const char * const _sys_sig$what[];
		extern int isatty(int);
		int main(void) { return (_sys_sig$what[0][0] + isatty(0)); }
	EOF
	eval uwhat_v=\$HAVE__SYS_SIG$uwhat
	if test 1 = "$uwhat_v"; then
		add_cppflags -Dsys_sig$what=_sys_sig$what
		eval HAVE_SYS_SIG$uwhat=1
	fi
	ac_cppflags SYS_SIG$uwhat
done

#
# Environment: library functions
#
ac_test flock <<-'EOF'
	#include <sys/types.h>
	#include <fcntl.h>
	#undef flock
	#if HAVE_SYS_FILE_H
	#include <sys/file.h>
	#endif
	int main(void) { return (flock(0, LOCK_EX | LOCK_UN)); }
EOF

ac_test lock_fcntl '!' flock 1 'whether we can lock files with fcntl' <<-'EOF'
	#include <fcntl.h>
	#undef flock
	int main(void) {
		struct flock lks;
		lks.l_type = F_WRLCK | F_UNLCK;
		return (fcntl(0, F_SETLKW, &lks));
	}
EOF

ac_test getrusage <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(void) {
		struct rusage ru;
		return (getrusage(RUSAGE_SELF, &ru) +
		    getrusage(RUSAGE_CHILDREN, &ru));
	}
EOF

ac_test getsid <<-'EOF'
	#include <unistd.h>
	int main(void) { return ((int)getsid(0)); }
EOF

ac_test gettimeofday <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(void) { struct timeval tv; return (gettimeofday(&tv, NULL)); }
EOF

ac_test killpg <<-'EOF'
	#include <signal.h>
	int main(int ac, char *av[]) { return (av[0][killpg(123, ac)]); }
EOF

ac_test memmove <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	#include <string.h>
	#if HAVE_STRINGS_H
	#include <strings.h>
	#endif
	int main(int ac, char *av[]) {
		return (*(int *)(void *)memmove(av[0], av[1], (size_t)ac));
	}
EOF

ac_test mknod '' 'if to use mknod(), makedev() and friends' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(int ac, char *av[]) {
		dev_t dv;
		dv = makedev((unsigned int)ac, (unsigned int)av[0][0]);
		return (mknod(av[0], (mode_t)0, dv) ? (int)major(dv) :
		    (int)minor(dv));
	}
EOF

ac_test mmap lock_fcntl 0 'for mmap and munmap' <<-'EOF'
	#include <sys/types.h>
	#if HAVE_SYS_FILE_H
	#include <sys/file.h>
	#endif
	#if HAVE_SYS_MMAN_H
	#include <sys/mman.h>
	#endif
	#include <stddef.h>
	#include <stdlib.h>
	int main(void) { return ((void *)mmap(NULL, (size_t)0,
	    PROT_READ, MAP_PRIVATE, 0, (off_t)0) == (void *)NULL ? 1 :
	    munmap(NULL, 0)); }
EOF

ac_test ftruncate mmap 0 'for ftruncate' <<-'EOF'
	#include <unistd.h>
	int main(void) { return (ftruncate(0, 0)); }
EOF

ac_test nice <<-'EOF'
	#include <unistd.h>
	int main(void) { return (nice(4)); }
EOF

ac_test revoke <<-'EOF'
	#include <sys/types.h>
	#if HAVE_LIBUTIL_H
	#include <libutil.h>
	#endif
	#include <unistd.h>
	int main(int ac, char *av[]) { return (ac + revoke(av[0])); }
EOF

ac_test setlocale_ctype '' 'setlocale(LC_CTYPE, "")' <<-'EOF'
	#include <locale.h>
	#include <stddef.h>
	int main(void) { return ((int)(size_t)(void *)setlocale(LC_CTYPE, "")); }
EOF

ac_test langinfo_codeset setlocale_ctype 0 'nl_langinfo(CODESET)' <<-'EOF'
	#include <langinfo.h>
	#include <stddef.h>
	int main(void) { return ((int)(size_t)(void *)nl_langinfo(CODESET)); }
EOF

ac_test select <<-'EOF'
	#include <sys/types.h>
	#if HAVE_BOTH_TIME_H
	#include <sys/time.h>
	#include <time.h>
	#elif HAVE_SYS_TIME_H
	#include <sys/time.h>
	#elif HAVE_TIME_H
	#include <time.h>
	#endif
	#if HAVE_SYS_BSDTYPES_H
	#include <sys/bsdtypes.h>
	#endif
	#if HAVE_SYS_SELECT_H
	#include <sys/select.h>
	#endif
	#if HAVE_BSTRING_H
	#include <bstring.h>
	#endif
	#include <stddef.h>
	#include <stdlib.h>
	#include <string.h>
	#if HAVE_STRINGS_H
	#include <strings.h>
	#endif
	#include <unistd.h>
	int main(void) {
		struct timeval tv = { 1, 200000 };
		fd_set fds; FD_ZERO(&fds); FD_SET(0, &fds);
		return (select(FD_SETSIZE, &fds, NULL, NULL, &tv));
	}
EOF

ac_test setresugid <<-'EOF'
	#include <sys/types.h>
	#include <unistd.h>
	int main(void) { return (setresuid(0,0,0) + setresgid(0,0,0)); }
EOF

ac_test setgroups setresugid 0 <<-'EOF'
	#include <sys/types.h>
	#if HAVE_GRP_H
	#include <grp.h>
	#endif
	#include <unistd.h>
	int main(void) { gid_t gid = 0; return (setgroups(0, &gid)); }
EOF

if test x"$et" = x"klibc"; then

	ac_testn __rt_sigsuspend '' 'whether klibc uses RT signals' <<-'EOF'
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		extern int __rt_sigsuspend(const sigset_t *, size_t);
		int main(void) { return (__rt_sigsuspend(NULL, 0)); }
EOF

	# no? damn! legacy crap ahead!

	ac_testn __sigsuspend_s '!' __rt_sigsuspend 1 \
	    'whether sigsuspend is usable (1/2)' <<-'EOF'
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		extern int __sigsuspend_s(sigset_t);
		int main(void) { return (__sigsuspend_s(0)); }
EOF
	ac_testn __sigsuspend_xxs '!' __sigsuspend_s 1 \
	    'whether sigsuspend is usable (2/2)' <<-'EOF'
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		extern int __sigsuspend_xxs(int, int, sigset_t);
		int main(void) { return (__sigsuspend_xxs(0, 0, 0)); }
EOF

	if test "000" = "$HAVE___RT_SIGSUSPEND$HAVE___SIGSUSPEND_S$HAVE___SIGSUSPEND_XXS"; then
		# no usable sigsuspend(), use pause() *ugh*
		add_cppflags -DMKSH_NO_SIGSUSPEND
	fi
fi

ac_test strerror '!' sys_errlist 0 <<-'EOF'
	extern char *strerror(int);
	int main(int ac, char *av[]) { return (*strerror(*av[ac])); }
EOF

ac_test strsignal '!' sys_siglist 0 <<-'EOF'
	#include <string.h>
	#include <signal.h>
	int main(void) { return (strsignal(1)[0]); }
EOF

ac_test strlcpy <<-'EOF'
	#include <string.h>
	int main(int ac, char *av[]) { return (strlcpy(*av, av[1],
	    (size_t)ac)); }
EOF

#
# check headers for declarations
#
ac_test flock_decl flock 1 'for declaration of flock()' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	#if HAVE_SYS_FILE_H
	#include <sys/file.h>
	#endif
	int main(void) { return ((flock)(0, 0)); }
EOF
ac_test revoke_decl revoke 1 'for declaration of revoke()' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(void) { return ((revoke)("")); }
EOF
ac_test sys_errlist_decl sys_errlist 0 "for declaration of sys_errlist[] and sys_nerr" <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(void) { return (*sys_errlist[sys_nerr - 1] + isatty(0)); }
EOF
ac_test sys_siglist_decl sys_siglist 0 'for declaration of sys_siglist[]' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(void) { return (sys_siglist[0][0] + isatty(0)); }
EOF

#
# other checks
#
fd='if to use persistent history'
ac_cache PERSISTENT_HISTORY || case $HAVE_FTRUNCATE$HAVE_MMAP$HAVE_FLOCK$HAVE_LOCK_FCNTL in
111*|1101) fv=1 ;;
esac
test 1 = $fv || check_categories="$check_categories no-histfile"
ac_testdone
ac_cppflags

#
# extra checks for legacy mksh
#
if test $legacy = 1; then
	ac_test long_32bit '' 'whether long is 32 bit wide' <<-'EOF'
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		#ifndef CHAR_BIT
		#define CHAR_BIT 0
		#endif
		struct ctasserts {
		#define cta(name, assertion) char name[(assertion) ? 1 : -1]
			cta(char_is_8_bits, (CHAR_BIT) == 8);
			cta(long_is_32_bits, sizeof(long) == 4);
		};
		int main(void) { return (sizeof(struct ctasserts)); }
EOF

	ac_test long_64bit '!' long_32bit 0 'whether long is 64 bit wide' <<-'EOF'
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		#ifndef CHAR_BIT
		#define CHAR_BIT 0
		#endif
		struct ctasserts {
		#define cta(name, assertion) char name[(assertion) ? 1 : -1]
			cta(char_is_8_bits, (CHAR_BIT) == 8);
			cta(long_is_64_bits, sizeof(long) == 8);
		};
		int main(void) { return (sizeof(struct ctasserts)); }
EOF

	case $HAVE_LONG_32BIT$HAVE_LONG_64BIT in
	10) check_categories="$check_categories int:32" ;;
	01) check_categories="$check_categories int:64" ;;
	*) check_categories="$check_categories int:u" ;;
	esac
fi

#
# Compiler: Praeprocessor (only if needed)
#
test 0 = $HAVE_SYS_SIGNAME && if ac_testinit cpp_dd '' \
    'checking if the C Preprocessor supports -dD'; then
	echo '#define foo bar' >conftest.c
	vv ']' "$CPP $CFLAGS $CPPFLAGS $NOWARN -dD conftest.c >x"
	grep '#define foo bar' x >/dev/null 2>&1 && fv=1
	rmf conftest.c x vv.out
	ac_testdone
fi

#
# End of mirtoconf checks
#
$e ... done.

# Some operating systems have ancient versions of ed(1) writing
# the character count to standard output; cope for that
echo wq >x
ed x <x 2>/dev/null | grep 3 >/dev/null 2>&1 && \
    check_categories="$check_categories $oldish_ed"
rmf x vv.out

if test 0 = $HAVE_SYS_SIGNAME; then
	if test 1 = $HAVE_CPP_DD; then
		$e Generating list of signal names...
	else
		$e No list of signal names available via cpp. Falling back...
	fi
	sigseenone=:
	sigseentwo=:
	echo '#include <signal.h>
#if defined(NSIG_MAX)
#define cfg_NSIG NSIG_MAX
#elif defined(NSIG)
#define cfg_NSIG NSIG
#elif defined(_NSIG)
#define cfg_NSIG _NSIG
#elif defined(SIGMAX)
#define cfg_NSIG (SIGMAX + 1)
#elif defined(_SIGMAX)
#define cfg_NSIG (_SIGMAX + 1)
#else
/*XXX better error out, see sh.h */
#define cfg_NSIG 64
#endif
int
mksh_cfg= cfg_NSIG
;' >conftest.c
	# GNU sed 2.03 segfaults when optimising this to sed -n
	NSIG=`vq "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c" | \
	    grep -v '^#' | \
	    sed '/mksh_cfg.*= *$/{
		N
		s/\n/ /
		}' | \
	    grep '^ *mksh_cfg *=' | \
	    sed 's/^ *mksh_cfg *=[	 ]*\([()0-9x+-][()0-9x+	 -]*\).*$/\1/'`
	case $NSIG in
	*mksh_cfg*) $e "Error: NSIG='$NSIG'"; NSIG=0 ;;
	*[\ \(\)+-]*) NSIG=`"$AWK" "BEGIN { print $NSIG }" </dev/null` ;;
	esac
	printf=printf
	(printf hallo) >/dev/null 2>&1 || printf=echo
	test $printf = echo || test "`printf %d 42`" = 42 || printf=echo
	test $printf = echo || NSIG=`printf %d "$NSIG" 2>/dev/null`
	$printf "NSIG=$NSIG ... "
	sigs="ABRT FPE ILL INT SEGV TERM ALRM BUS CHLD CONT HUP KILL PIPE QUIT"
	sigs="$sigs STOP TSTP TTIN TTOU USR1 USR2 POLL PROF SYS TRAP URG VTALRM"
	sigs="$sigs XCPU XFSZ INFO WINCH EMT IO DIL LOST PWR SAK CLD IOT STKFLT"
	sigs="$sigs ABND DCE DUMP IOERR TRACE DANGER THCONT THSTOP RESV UNUSED"
	test 1 = $HAVE_CPP_DD && test $NSIG -gt 1 && sigs="$sigs "`vq \
	    "$CPP $CFLAGS $CPPFLAGS $NOWARN -dD conftest.c" | \
	    grep '[	 ]SIG[A-Z0-9][A-Z0-9]*[	 ]' | \
	    sed 's/^.*[	 ]SIG\([A-Z0-9][A-Z0-9]*\)[	 ].*$/\1/' | sort`
	test $NSIG -gt 1 || sigs=
	for name in $sigs; do
		case $sigseenone in
		*:$name:*) continue ;;
		esac
		sigseenone=$sigseenone$name:
		echo '#include <signal.h>' >conftest.c
		echo int >>conftest.c
		echo mksh_cfg= SIG$name >>conftest.c
		echo ';' >>conftest.c
		# GNU sed 2.03 croaks on optimising this, too
		vq "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c" | \
		    grep -v '^#' | \
		    sed '/mksh_cfg.*= *$/{
			N
			s/\n/ /
			}' | \
		    grep '^ *mksh_cfg *=' | \
		    sed 's/^ *mksh_cfg *=[	 ]*\([0-9][0-9x]*\).*$/:\1 '$name/
	done | sed -n '/^:[^ ]/s/^://p' | while read nr name; do
		test $printf = echo || nr=`printf %d "$nr" 2>/dev/null`
		test $nr -gt 0 && test $nr -lt $NSIG || continue
		case $sigseentwo in
		*:$nr:*) ;;
		*)	echo "		{ \"$name\", $nr },"
			sigseentwo=$sigseentwo$nr:
			$printf "$name=$nr " >&2
			;;
		esac
	done 2>&1 >signames.inc
	rmf conftest.c
	$e done.
fi

addsrcs '!' HAVE_STRLCPY strlcpy.c
addsrcs USE_PRINTF_BUILTIN printf.c
test 1 = "$USE_PRINTF_BUILTIN" && add_cppflags -DMKSH_PRINTF_BUILTIN
test 1 = "$HAVE_CAN_VERB" && CFLAGS="$CFLAGS -verbose"
add_cppflags -DMKSH_BUILD_R=571

$e $bi$me: Finished configuration testing, now producing output.$ao

files=
objs=
sp=
case $tcfn in
a.exe|conftest.exe)
	mkshexe=$tfn.exe
	add_cppflags -DMKSH_EXE_EXT
	;;
*)
	mkshexe=$tfn
	;;
esac
case $curdir in
*\ *)	mkshshebang="#!./$mkshexe" ;;
*)	mkshshebang="#!$curdir/$mkshexe" ;;
esac
cat >test.sh <<-EOF
	$mkshshebang
	LC_ALL=C PATH='$PATH'; export LC_ALL PATH
	test -n "\$KSH_VERSION" || exit 1
	set -A check_categories -- $check_categories
	pflag='$curdir/$mkshexe'
	sflag='$srcdir/check.t'
	usee=0 useU=0 Pflag=0 Sflag=0 uset=0 vflag=1 xflag=0
	while getopts "C:e:fPp:QSs:t:U:v" ch; do case \$ch {
	(C)	check_categories[\${#check_categories[*]}]=\$OPTARG ;;
	(e)	usee=1; eflag=\$OPTARG ;;
	(f)	check_categories[\${#check_categories[*]}]=fastbox ;;
	(P)	Pflag=1 ;;
	(+P)	Pflag=0 ;;
	(p)	pflag=\$OPTARG ;;
	(Q)	vflag=0 ;;
	(+Q)	vflag=1 ;;
	(S)	Sflag=1 ;;
	(+S)	Sflag=0 ;;
	(s)	sflag=\$OPTARG ;;
	(t)	uset=1; tflag=\$OPTARG ;;
	(U)	useU=1; Uflag=\$OPTARG ;;
	(v)	vflag=1 ;;
	(+v)	vflag=0 ;;
	(*)	xflag=1 ;;
	}
	done
	shift \$((OPTIND - 1))
	set -A args -- '$srcdir/check.pl' -p "\$pflag"
	if $ebcdic; then
		args[\${#args[*]}]=-E
	fi
	x=
	for y in "\${check_categories[@@]}"; do
		x=\$x,\$y
	done
	if [[ -n \$x ]]; then
		args[\${#args[*]}]=-C
		args[\${#args[*]}]=\${x#,}
	fi
	if (( usee )); then
		args[\${#args[*]}]=-e
		args[\${#args[*]}]=\$eflag
	fi
	(( Pflag )) && args[\${#args[*]}]=-P
	if (( uset )); then
		args[\${#args[*]}]=-t
		args[\${#args[*]}]=\$tflag
	fi
	if (( useU )); then
		args[\${#args[*]}]=-U
		args[\${#args[*]}]=\$Uflag
	fi
	(( vflag )) && args[\${#args[*]}]=-v
	(( xflag )) && args[\${#args[*]}]=-x	# force usage by synerr
	if [[ -n \$TMPDIR && -d \$TMPDIR/. ]]; then
		args[\${#args[*]}]=-T
		args[\${#args[*]}]=\$TMPDIR
	fi
	print Testing mksh for conformance:
	grep -F -e Mir''OS: -e MIRBSD "\$sflag"
	print "This shell is actually:\\n\\t\$KSH_VERSION"
	print 'test.sh built for mksh $dstversion'
	cstr='\$os = defined \$^O ? \$^O : "unknown";'
	cstr="\$cstr"'print \$os . ", Perl version " . \$];'
	for perli in \$PERL perl5 perl no; do
		if [[ \$perli = no ]]; then
			print Cannot find a working Perl interpreter, aborting.
			exit 1
		fi
		print "Trying Perl interpreter '\$perli'..."
		perlos=\$(\$perli -e "\$cstr")
		rv=\$?
		print "Errorlevel \$rv, running on '\$perlos'"
		if (( rv )); then
			print "=> not using"
			continue
		fi
		if [[ -n \$perlos ]]; then
			print "=> using it"
			break
		fi
	done
	(( Sflag )) || echo + \$perli "\${args[@@]}" -s "\$sflag" "\$@@"
	(( Sflag )) || exec \$perli "\${args[@@]}" -s "\$sflag" "\$@@"$tsts
	# use of the -S option for check.t split into multiple chunks
	rv=0
	for s in "\$sflag".*; do
		echo + \$perli "\${args[@@]}" -s "\$s" "\$@@"
		\$perli "\${args[@@]}" -s "\$s" "\$@@"$tsts
		rc=\$?
		(( rv = rv ? rv : rc ))
	done
	exit \$rv
EOF
chmod 755 test.sh
case $cm in
dragonegg)
	emitbc="-S -flto"
	;;
llvm)
	emitbc="-emit-llvm -c"
	;;
*)
	emitbc=-c
	;;
esac
echo ": # work around NeXTstep bug" >Rebuild.sh
cd "$srcdir"
optfiles=`echo *.opt`
cd "$curdir"
for file in $optfiles; do
	echo "echo + Running genopt on '$file'..."
	echo "(srcfile='$srcdir/$file'; BUILDSH_RUN_GENOPT=1; . '$srcdir/Build.sh')"
done >>Rebuild.sh
echo set -x >>Rebuild.sh
for file in $SRCS; do
	op=`echo x"$file" | sed 's/^x\(.*\)\.c$/\1./'`
	test -f $file || file=$srcdir/$file
	files="$files$sp$file"
	sp=' '
	echo "$CC $CFLAGS $CPPFLAGS $emitbc $file || exit 1" >>Rebuild.sh
	if test $cm = dragonegg; then
		echo "mv ${op}s ${op}ll" >>Rebuild.sh
		echo "llvm-as ${op}ll || exit 1" >>Rebuild.sh
		objs="$objs$sp${op}bc"
	else
		objs="$objs$sp${op}o"
	fi
done
case $cm in
dragonegg|llvm)
	echo "rm -f $tfn.s" >>Rebuild.sh
	echo "llvm-link -o - $objs | opt $optflags | llc -o $tfn.s" >>Rebuild.sh
	lobjs=$tfn.s
	;;
*)
	lobjs=$objs
	;;
esac
echo tcfn=$mkshexe >>Rebuild.sh
echo "$CC $CFLAGS $LDFLAGS -o \$tcfn $lobjs $LIBS $ccpr" >>Rebuild.sh
echo "test -f \$tcfn || exit 1; $SIZE \$tcfn" >>Rebuild.sh
if test $cm = makefile; then
	extras='emacsfn.h exprtok.h rlimits.opt sh.h sh_flags.opt var_spec.h'
	test 0 = $HAVE_SYS_SIGNAME && extras="$extras signames.inc"
	gens= genq=
	for file in $optfiles; do
		genf=`basename "$file" | sed 's/.opt$/.gen/'`
		gens="$gens $genf"
		genq="$genq$nl$genf: $srcdir/Build.sh $srcdir/$file
			srcfile=$srcdir/$file; BUILDSH_RUN_GENOPT=1; . $srcdir/Build.sh"
	done
	cat >Makefrag.inc <<EOF
# Makefile fragment for building mksh $dstversion

PROG=		$mkshexe
MAN=		mksh.1
SRCS=		$SRCS
SRCS_FP=	$files
OBJS_BP=	$objs
INDSRCS=	$extras
NONSRCS_INST=	dot.mkshrc \$(MAN)
NONSRCS_NOINST=	Build.sh Makefile Rebuild.sh check.pl check.t test.sh
CC=		$CC
CPPFLAGS=	$CPPFLAGS
CFLAGS=		$CFLAGS
LDFLAGS=	$LDFLAGS
LIBS=		$LIBS

.depend \$(OBJS_BP):$gens$genq

# not BSD make only:
#VPATH=		$srcdir
#all: \$(PROG)
#\$(PROG): \$(OBJS_BP)
#	\$(CC) \$(CFLAGS) \$(LDFLAGS) -o \$@@ \$(OBJS_BP) \$(LIBS)
#\$(OBJS_BP): \$(SRCS_FP) \$(NONSRCS)
#.c.o:
#	\$(CC) \$(CFLAGS) \$(CPPFLAGS) -c \$<

# for all make variants:
#REGRESS_FLAGS=	-f
#regress:
#	./test.sh \$(REGRESS_FLAGS)
check_categories=$check_categories

# for BSD make only:
#.PATH: $srcdir
#.include <bsd.prog.mk>
EOF
	$e
	$e Generated Makefrag.inc successfully.
	exit 0
fi
for file in $optfiles; do
	$e "+ Running genopt on '$file'..."
	do_genopt "$srcdir/$file" || exit 1
done
if test $cm = combine; then
	objs="-o $mkshexe"
	for file in $SRCS; do
		test -f $file || file=$srcdir/$file
		objs="$objs $file"
	done
	emitbc="-fwhole-program --combine"
	v "$CC $CFLAGS $CPPFLAGS $LDFLAGS $emitbc $objs $LIBS $ccpr"
elif test 1 = $pm; then
	for file in $SRCS; do
		test -f $file || file=$srcdir/$file
		v "$CC $CFLAGS $CPPFLAGS $emitbc $file" &
	done
	wait
else
	for file in $SRCS; do
		test $cm = dragonegg && \
		    op=`echo x"$file" | sed 's/^x\(.*\)\.c$/\1./'`
		test -f $file || file=$srcdir/$file
		v "$CC $CFLAGS $CPPFLAGS $emitbc $file" || exit 1
		if test $cm = dragonegg; then
			v "mv ${op}s ${op}ll"
			v "llvm-as ${op}ll" || exit 1
		fi
	done
fi
case $cm in
dragonegg|llvm)
	rmf $tfn.s
	v "llvm-link -o - $objs | opt $optflags | llc -o $tfn.s"
	;;
esac
tcfn=$mkshexe
test $cm = combine || v "$CC $CFLAGS $LDFLAGS -o $tcfn $lobjs $LIBS $ccpr"
test -f $tcfn || exit 1
test 1 = $r || v "$NROFF -mdoc <'$srcdir/lksh.1' >lksh.cat1" || rmf lksh.cat1
test 1 = $r || v "$NROFF -mdoc <'$srcdir/mksh.1' >mksh.cat1" || rmf mksh.cat1
test 0 = $eq && v $SIZE $tcfn
i=install
test -f /usr/ucb/$i && i=/usr/ucb/$i
test 1 = $eq && e=:
$e
$e Installing the shell:
$e "# $i -c -s -o root -g bin -m 555 $tfn /bin/$tfn"
if test $legacy = 0; then
	$e "# grep -x /bin/$tfn /etc/shells >/dev/null || echo /bin/$tfn >>/etc/shells"
	$e "# $i -c -o root -g bin -m 444 dot.mkshrc /usr/share/doc/mksh/examples/"
fi
$e
$e Installing the manual:
if test -f mksh.cat1; then
	$e "# $i -c -o root -g bin -m 444 lksh.cat1" \
	    "/usr/share/man/cat1/lksh.0"
	$e "# $i -c -o root -g bin -m 444 mksh.cat1" \
	    "/usr/share/man/cat1/mksh.0"
	$e or
fi
$e "# $i -c -o root -g bin -m 444 lksh.1 mksh.1 /usr/share/man/man1/"
$e
$e Run the regression test suite: ./test.sh
$e Please also read the sample file dot.mkshrc and the fine manual.
exit 0

: <<'EOD'

=== Environment used ===

==== build environment ====
AWK				default: awk
CC				default: cc
CFLAGS				if empty, defaults to -xO2 or +O2
				or -O3 -qstrict or -O2, per compiler
CPPFLAGS			default empty
LDFLAGS				default empty; added before sources
LDSTATIC			set this to '-static'; default unset
LIBS				default empty; added after sources
				[Interix] default: -lcrypt (XXX still needed?)
NOWARN				-Wno-error or similar
NROFF				default: nroff
TARGET_OS			default: $(uname -s || uname)
TARGET_OSREV			[QNX] default: $(uname -r)

==== feature selectors ====
USE_PRINTF_BUILTIN		1 to include (unsupported) printf(1) as builtin
===== general format =====
HAVE_STRLEN			ac_test
HAVE_STRING_H			ac_header
HAVE_CAN_FSTACKPROTECTORALL	ac_flags

==== cpp definitions ====
DEBUG				dont use in production, wants gcc, implies:
DEBUG_LEAKS			enable freeing resources before exiting
KSH_VERSIONNAME_VENDOR_EXT	when patching; space+plus+word (e.g. " +SuSE")
MKSHRC_PATH			"~/.mkshrc" (do not change)
MKSH_A4PB			force use of arc4random_pushb
MKSH_ASSUME_UTF8		(0=disabled, 1=enabled; default: unset)
MKSH_BINSHPOSIX			if */sh or */-sh, enable set -o posix
MKSH_BINSHREDUCED		if */sh or */-sh, enable set -o sh
MKSH_CLS_STRING			KSH_ESC_STRING "[;H" KSH_ESC_STRING "[J"
MKSH_DEFAULT_EXECSHELL		"/bin/sh" (do not change)
MKSH_DEFAULT_PROFILEDIR		"/etc" (do not change)
MKSH_DEFAULT_TMPDIR		"/tmp" (do not change)
MKSH_DISABLE_DEPRECATED		disable code paths scheduled for later removal
MKSH_DISABLE_EXPERIMENTAL	disable code not yet comfy for (LTS) snapshots
MKSH_DISABLE_TTY_WARNING	shut up warning about ctty if OS cant be fixed
MKSH_DONT_EMIT_IDSTRING		omit RCS IDs from binary
MKSH_EARLY_LOCALE_TRACKING	track utf8-mode from POSIX locale, for SuSE
MKSH_MIDNIGHTBSD01ASH_COMPAT	set -o sh: additional compatibility quirk
MKSH_NOPROSPECTOFWORK		disable jobs, co-processes, etc. (do not use)
MKSH_NOPWNAM			skip PAM calls, for -static on glibc or Solaris
MKSH_NO_CMDLINE_EDITING		disable command line editing code entirely
MKSH_NO_DEPRECATED_WARNING	omit warning when deprecated stuff is run
MKSH_NO_LIMITS			omit ulimit code
MKSH_NO_SIGSETJMP		define if sigsetjmp is broken or not available
MKSH_NO_SIGSUSPEND		use sigprocmask+pause instead of sigsuspend
MKSH_SMALL			omit some code, optimise hard for size (slower)
MKSH_SMALL_BUT_FAST		disable some hard-for-size optim. (modern sys.)
MKSH_S_NOVI=1			disable Vi editing mode (default if MKSH_SMALL)
MKSH_TYPEDEF_SIG_ATOMIC_T	define to e.g. 'int' if sig_atomic_t is missing
MKSH_TYPEDEF_SSIZE_T		define to e.g. 'long' if your OS has no ssize_t
MKSH_UNEMPLOYED			disable job control (but not jobs/co-processes)
USE_REALLOC_MALLOC		define as 0 to not use realloc as malloc

=== generic installation instructions ===

Set CC and possibly CFLAGS, CPPFLAGS, LDFLAGS, LIBS. If cross-compiling,
also set TARGET_OS. To disable tests, set e.g. HAVE_STRLCPY=0; to enable
them, set to a value other than 0 or 1. Ensure /bin/ed is installed. For
MKSH_SMALL but with Vi mode, add -DMKSH_S_NOVI=0 to CPPFLAGS as well.

Normally, the following command is what you want to run, then:
$ (sh Build.sh -r && ./test.sh -f) 2>&1 | tee log

Copy dot.mkshrc to /etc/skel/.mkshrc; install mksh into $prefix/bin; or
/bin; install the manpage, if omitting the -r flag a catmanpage is made
using $NROFF. Consider using a forward script as /etc/skel/.mkshrc like
http://anonscm.debian.org/cgit/collab-maint/mksh.git/plain/debian/.mkshrc
and put dot.mkshrc as /etc/mkshrc so users need not keep up their HOME.

You may also want to install the lksh binary (also as /bin/sh) built by:
$ CPPFLAGS="$CPPFLAGS -DMKSH_BINSHPOSIX" sh Build.sh -L -r

EOD
@


1.746
log
@document another arcane knob
@
text
@d5 2
a6 1
#		2011, 2012, 2013, 2014, 2015, 2016, 2017, 2019
d1120 2
d1256 3
d1348 1
a1348 1
	vv "$CC --version"
@


1.745
log
@add beginning neatcc support, not working yet
@
text
@d2782 1
@


1.744
log
@forcibly disable LTO if GCC is used: unbreaks build on
OpenSuSE:Factory, who blindly enabled LTO by default,
which might make others follow (whichs why I disable
LTO at upstream level)

https://en.opensuse.org/openSUSE:LTO shows a distro-
level disablement, but
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.741 2019/08/01 19:53:05 tg Exp $'
d1117 2
d1284 6
@


1.743
log
@try to fail earlier if selk mispatched his GCC:

have a function-local variable in main() in checking if the final
link command may succeed so we dont misdetect gettimeofday, plus
others, as absent and error out misleadingly later in getrusage
@
text
@d1526 1
@


1.742
log
@disable LTO (both -fwhole-program --combine and -flto*)

cf. https://lists.debian.org/debian-devel/2019/07/msg00610.html
and thread context
@
text
@d1948 5
a1952 1
		int main(void) { printf("Hello, World!\\n"); return (isatty(0)); }
@


1.741
log
@updates from MagicPoint packaging
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.739 2019/07/25 17:11:00 tg Exp $'
d515 1
a515 1
	c:combine|c:dragonegg|c:llvm|c:lto)
d2778 1
a2778 1
$ (sh Build.sh -r -c lto && ./test.sh -f) 2>&1 | tee log
d2787 1
a2787 1
$ CPPFLAGS="$CPPFLAGS -DMKSH_BINSHPOSIX" sh Build.sh -L -r -c lto
@


1.740
log
@fix rmf() not cleaning up conftest.c; also nukes mksh/Build.sh -t tgtname

we ensure tgtname is now always lksh or mksh, or paxpax (hardcoded)

also fixup some char **av into char *av[]
@
text
@d28 2
a29 2
LC_ALL=C
export LC_ALL
d1089 2
a1090 1
drop us a success or failure notice or even send in diffs.
d2614 1
a2615 1
CPPFLAGS=	$CPPFLAGS
@


1.739
log
@some shellology; sync mksh/1.739 with pax/1.9
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.737 2019/04/26 15:53:15 tg Exp $'
d237 1
a237 1
		Build.sh|check.pl|check.t|dot.mkshrc|*.1|*.c|*.h|*.ico|*.opt) ;;
a526 4
	t:*)
		tfn=$i
		last=
		;;
a571 3
	:-t)
		last=t
		;;
d648 1
a648 1
ccpr='|| for _f in ${tcfn}*; do case $_f in Build.sh|check.pl|check.t|dot.mkshrc|*.1|*.c|*.h|*.ico|*.opt) ;; *) rm -f "$_f" ;; esac; done'
d1707 1
a1707 1
	int main(int ac, char **av) { return (fprintf(stderr, "%s%d", *av, ac)); }
d1732 1
a1732 1
	int main(int ac, char **av) { return (foo(av[ac - 1]) + isatty(0)); }
d1744 1
a1744 1
	int main(int ac __attribute__((__unused__)), char **av
d1862 1
a1862 1
	int main(int ac, char **av) { return ((uint32_t)(size_t)*av + (int32_t)ac); }
d1867 1
a1867 1
	int main(int ac, char **av) { return ((u_int32_t)(size_t)*av + (int32_t)ac); }
d1872 1
a1872 1
	int main(int ac, char **av) { return ((uint8_t)(size_t)av[ac]); }
d1877 1
a1877 1
	int main(int ac, char **av) { return ((u_int8_t)(size_t)av[ac]); }
@


1.738
log
@fix midipix build warning for setresugid
@
text
@d1383 1
a1383 1
		ac_testn can_delexe compiler_fails 0 'for the -non_shared linker option' <<-EOF
d1390 1
a1390 1
		ac_testn can_delexe compiler_fails 0 'for the /DELEXECUTABLE linker option' <<-EOF
d1400 2
a1401 3
	ac_testn compiler_still_fails '' 'if the compiler still does not fail correctly' <<-EOF
	EOF
	test 1 = $HAVE_COMPILER_STILL_FAILS && exit 1
d2011 2
a2012 2
	ac_testn sys_sig$what '' "the sys_sig${what}[] array" <<-EOF
		extern const char * const sys_sig${what}[];
d2014 1
a2014 1
		int main(void) { return (sys_sig${what}[0][0] + isatty(0)); }
d2016 2
a2017 2
	ac_testn _sys_sig$what '!' sys_sig$what 0 "the _sys_sig${what}[] array" <<-EOF
		extern const char * const _sys_sig${what}[];
d2019 1
a2019 1
		int main(void) { return (_sys_sig${what}[0][0] + isatty(0)); }
@


1.737
log
@add support for Midipix, with only a hack for the testsuite
17:35Redfoxmoon also works without NOPROSPECTOFWORK and UNEMPLOYED
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.736 2019/04/09 16:19:52 tg Exp $'
d851 1
@


1.736
log
@document KSH_VERSIONNAME_VENDOR_EXT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.735 2019/04/09 16:15:41 tg Exp $'
d850 4
@


1.735
log
@fix gcc dump{machine,version} shell escaping level

detected on OpenSuSE Buildservice:
[   89s] | gcc: error: openSUSE\": No such file or directory
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.733 2018/12/12 10:41:23 tg Exp $'
d2742 1
@


1.734
log
@bump
@
text
@d5 1
a5 1
#		2011, 2012, 2013, 2014, 2015, 2016, 2017
d1233 2
a1234 3
	vv '|' 'echo `$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN $LIBS \
	    -dumpmachine` gcc`$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN \
	    $LIBS -dumpversion`'
@


1.733
log
@some more tweaks
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.731 2018/01/13 21:38:06 tg Exp $'
d2432 1
a2432 1
add_cppflags -DMKSH_BUILD_R=563
@


1.732
log
@Macintosh-specific updates from gecko2@@

also, their sysctl(8) sucks:
13:31gecko naja, sysctl bricht die ausgabe bei nicht vorhandenen parametern ab
13:32gecko der listet aktuell nur bis hw.memsize auf
@
text
@d421 1
@


1.731
log
@implement early (medival) locale tracking, as a compile-time option,
for SuSE; slightly inspired by the original patch submitted by
From: Dr. Werner Fink <werner@@suse.de>
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.729 2017/12/22 18:36:21 tg Exp $'
d1063 1
a1063 1
	vv '|' "system_profiler SPSoftwareDataType SPHardwareDataType >&2"
d1067 2
a1068 1
	vv '|' "sysctl kern.version hw.machine hw.model hw.memsize hw.availcpu hw.cpufrequency hw.byteorder hw.cpu64bit_capable >&2"
@


1.730
log
@merge Jehanne cleanup patch
From: Giacomo Tesio <giacomo@@tesio.it>
@
text
@d2430 1
a2430 1
add_cppflags -DMKSH_BUILD_R=562
d2754 1
@


1.729
log
@turns out that Plan 9 does *not* have symlink(7)s

cf. https://github.com/brho/plan9/blob/master/sys/src/ape/lib/ap/plan9/dirtostat.c
despite https://github.com/brho/plan9/blob/master/sys/include/ape/sys/stat.h

see http://static.usenix.org/events/usenix2000/general/full_papers/pikelex/pikelex.pdf though
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.727 2017/08/29 13:38:28 tg Exp $'
a824 3
	: "${HAVE_TERMIOS_H=1}"
	: "${HAVE_GETRUSAGE=1}"
	: "${LDSTATIC=-static}"
@


1.728
log
@add patch for the Jehanne operating system, from Shamar on IRC
@
text
@d799 2
d828 1
d831 2
a832 1
	add_cppflags -DMKSH_ASSUME_UTF8
d969 2
@


1.727
log
@monkey-patch offsetof for a klibc/dietlibc warning; bump to R56b (bugfixes)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.726 2017/08/07 20:40:56 tg Exp $'
d822 15
@


1.726
log
@plug part of the history problems until we can do better:
do not change the underlying file when truncating; rather,
copy everything back from the tmpfile to histfd while the
latter is locked
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.715 2017/04/12 16:01:44 tg Exp $'
d2412 1
a2412 1
add_cppflags -DMKSH_BUILD_R=561
@


1.725
log
@merge commit b0a2ea76327760a7ecf35172fe525f8aa39320b2 from Harvey-OS:

Until sigsuspend could work propery[sic]
@
text
@d2093 5
d2252 2
a2253 2
ac_cache PERSISTENT_HISTORY || case $HAVE_MMAP$HAVE_FLOCK$HAVE_LOCK_FCNTL in
11*|101) fv=1 ;;
d2412 1
a2412 1
add_cppflags -DMKSH_BUILD_R=551
@


1.724
log
@oops, reverted not enough in commitid 1005909EE7C16B07DC3
@
text
@d803 1
@


1.723
log
@move more EBCDIC logic into check.pl
@
text
@d2458 1
d2464 1
a2464 1
		args[\${#args[*]}]=\$x
@


1.722
log
@handle EBCDIC in the testsuite runner (error display)

- move categories for that to test.sh, simplifying it
- $ebcdic in Build.sh is now for the target, not the buildhost
@
text
@a2456 3
		x=shell:ebcdic-yes,shell:ascii-no
	else
		x=shell:ebcdic-no,shell:ascii-yes
@


1.721
log
@add -U to test.sh as well, oops
@
text
@d58 1
a58 1
	ebcdic=true
a61 1
	ebcdic=false
d509 1
a509 1
ebcdic=0
d534 1
a534 1
		ebcdic=1
d620 1
a620 4
if test $ebcdic = 0; then
	check_categories="$check_categories shell:ebcdic-no shell:ascii-yes"
else
	check_categories="$check_categories shell:ebcdic-yes shell:ascii-no"
d2455 6
a2460 1
	x=
d2466 1
a2466 1
		args[\${#args[*]}]=\${x#,}
@


1.720
log
@clarify; default to xlc(1) as $CC on z/OS
@
text
@d2437 2
a2438 2
	usee=0 Pflag=0 Sflag=0 uset=0 vflag=1 xflag=0
	while getopts "C:e:fPp:QSs:t:v" ch; do case \$ch {
d2451 1
d2476 4
@


1.719
log
@handle expected utf8opt-2a failures better (i.e. dont even try)
@
text
@d931 1
d1092 1
a1092 1
$e ... which compiler seems to be used
d1342 1
a1342 1
$e "$bi==> which compiler seems to be used...$ao $ui$ct$etd$ao"
@


1.718
log
@apply most of the remaining parts of the EBCDIC patch, sans the CTRL() changes
@
text
@d790 3
a792 1
	add_cppflags -DMKSH_ASSUME_UTF8; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d800 3
a802 1
	add_cppflags -DMKSH_ASSUME_UTF8; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d855 3
a857 1
	add_cppflags -DMKSH_ASSUME_UTF8=0; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d891 3
a893 1
	add_cppflags -DMKSH_ASSUME_UTF8=0; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d928 3
a930 1
	add_cppflags -DMKSH_ASSUME_UTF8=0; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d949 3
a951 1
	add_cppflags -DMKSH_ASSUME_UTF8; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d1771 4
@


1.717
log
@prepare for EBCDIC target environments (with -E option)

this differs from EBCDIC build hosts which can be autodetected
@
text
@d56 11
d439 1
a439 1
	hv=`echo "$hf" | tr -d '\012\015' | tr -c $alll$allu$alln $alls`
d919 7
d1424 10
a1433 2
	save_NOWARN=-qflag=i:e
	DOWARN=-qflag=i:i
d1603 18
a1620 4
	ac_flags 1 rodata "-qro -qroconst -qroptr"
	ac_flags 1 rtcheck -qcheck=all
	#ac_flags 1 rtchkc -qextchk	# reported broken
	ac_flags 1 wformat "-qformat=all -qformat=nozln"
d2701 1
a2701 1
MKSH_CLS_STRING			"\033[;H\033[J"
@


1.716
log
@R55
@
text
@d499 1
d523 3
d610 7
@


1.715
log
@now we have cheap cta move them into compile time
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.711 2017/04/02 14:14:03 tg Exp $'
d2342 1
a2342 1
add_cppflags -DMKSH_BUILD_R=549
@


1.714
log
@make compile-time asserts simpler
@
text
@a2188 55
save_CFLAGS=$CFLAGS
ac_testn compile_time_asserts_$$ '' 'whether compile-time assertions pass' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	#ifndef CHAR_BIT
	#define CHAR_BIT 8	/* defuse this test on really legacy systems */
	#endif
	#define cta(name, assertion) struct cta_ ## name { char t[(assertion) ? 1 : -1]; }
/* this one should be defined by the standard */
cta(char_is_1_char, (sizeof(char) == 1) && (sizeof(signed char) == 1) &&
    (sizeof(unsigned char) == 1));
cta(char_is_8_bits, ((CHAR_BIT) == 8) && ((int)(unsigned char)0xFF == 0xFF) &&
    ((int)(unsigned char)0x100 == 0) && ((int)(unsigned char)(int)-1 == 0xFF));
/* the next assertion is probably not really needed */
cta(short_is_2_char, sizeof(short) == 2);
cta(short_size_no_matter_of_signedness, sizeof(short) == sizeof(unsigned short));
/* the next assertion is probably not really needed */
cta(int_is_4_char, sizeof(int) == 4);
cta(int_size_no_matter_of_signedness, sizeof(int) == sizeof(unsigned int));

cta(long_ge_int, sizeof(long) >= sizeof(int));
cta(long_size_no_matter_of_signedness, sizeof(long) == sizeof(unsigned long));

#ifndef MKSH_LEGACY_MODE
/* the next assertion is probably not really needed */
cta(ari_is_4_char, sizeof(mksh_ari_t) == 4);
/* but this is */
cta(ari_has_31_bit, 0 < (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 1));
/* the next assertion is probably not really needed */
cta(uari_is_4_char, sizeof(mksh_uari_t) == 4);
/* but the next three are; we REQUIRE unsigned integer wraparound */
cta(uari_has_31_bit, 0 < (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 2 + 1));
cta(uari_has_32_bit, 0 < (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 3));
cta(uari_wrap_32_bit,
    (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 3) >
    (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 4));
#endif
/* these are always required */
cta(ari_is_signed, (mksh_ari_t)-1 < (mksh_ari_t)0);
cta(uari_is_unsigned, (mksh_uari_t)-1 > (mksh_uari_t)0);
/* we require these to have the precisely same size and assume 2s complement */
cta(ari_size_no_matter_of_signedness, sizeof(mksh_ari_t) == sizeof(mksh_uari_t));

cta(sizet_size_no_matter_of_signedness, sizeof(ssize_t) == sizeof(size_t));
cta(sizet_voidptr_same_size, sizeof(size_t) == sizeof(void *));
cta(sizet_funcptr_same_size, sizeof(size_t) == sizeof(void (*)(void)));
/* our formatting routines assume this */
cta(ptr_fits_in_long, sizeof(size_t) <= sizeof(long));
cta(ari_fits_in_long, sizeof(mksh_ari_t) <= sizeof(long));

	int main(void) { return (isatty(0)); }
EOF
CFLAGS=$save_CFLAGS
eval test 1 = \$HAVE_COMPILE_TIME_ASSERTS_$$ || exit 1

@


1.713
log
@komh reports that OS/2 has no chance of supporting UTF-8 (like MSYS)
@
text
@d2196 1
a2196 2
	struct ctasserts {
	#define cta(name, assertion) char name[(assertion) ? 1 : -1]
a2224 3
#define NUM 22
#else
#define NUM 16
d2238 2
a2239 5
/* for struct alignment people */
		char padding[64 - NUM];
	};
char ctasserts_dblcheck[sizeof(struct ctasserts) == 64 ? 1 : -1];
	int main(void) { return (sizeof(ctasserts_dblcheck) + isatty(0)); }
@


1.712
log
@merge mksh-os2 by KO Myung-Hun <komh@@chollian.net> from https://github.com/komh/mksh-os2
@
text
@d863 1
@


1.711
log
@introduce the -T flag to set TEXTMODE (ASCII CR+LF newline support)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.695 2016/01/02 20:11:31 tg Exp $'
d865 1
a865 2
	oswarn="; it is currently being ported, get it from"
	oswarn="$oswarn${nl}https://github.com/komh/mksh-os2 in the meanwhile"
d869 1
@


1.710
log
@POSuX demands persistent history support, so permit it in lksh

also, use http for links, its less demanding than https
@
text
@d498 1
d555 6
d606 7
d873 22
d2403 1
a2403 1
add_cppflags -DMKSH_BUILD_R=541
@


1.709
log
@Harvey-OS fixed APEX, this is reported to work now
@
text
@a596 1
	HAVE_PERSISTENT_HISTORY=0
@


1.708
log
@fixup relation between lksh and mksh (somewhat minimal delta)
@
text
@d5 1
a5 1
#		2011, 2012, 2013, 2014, 2015, 2016
a767 1
	add_cppflags -DMKSH_NOPROSPECTOFWORK
@


1.707
log
@collective R54 release preparation multi-merger:

install both lksh and mksh manpages from Build.sh (Martijn Dekker)
spelling fixes (Larry Hynes)
manpage improvements (Martijn Dekker)
initial port to Harvey-OS APEX (Ronald G. Minnich, Elbing Miss, lvaro Jurado)
more from komhs OS/2 port (KO Myung-Hun)
@
text
@d589 1
a589 1
SRCS="lalloc.c eval.c exec.c expr.c funcs.c histrap.c jobs.c"
a592 1
	SRCS="$SRCS edit.c"
@


1.706
log
@apply patch from Brian Callahan <bcallah@@devio.us> for better pcc support
@
text
@d587 1
a587 1
    *.ll *.o *.gen Rebuild.sh lft no signames.inc test.sh x vv.out
d758 18
d854 2
a855 1
	oswarn="; it is currently being ported"
d861 1
d2370 1
a2370 1
add_cppflags -DMKSH_BUILD_R=539
d2616 2
a2617 2
test 1 = $r || v "$NROFF -mdoc <'$srcdir/mksh.1' >$tfn.cat1" || \
    rmf $tfn.cat1
d2631 5
a2635 3
if test -f $tfn.cat1; then
	$e "# $i -c -o root -g bin -m 444 $tfn.cat1" \
	    "/usr/share/man/cat1/$tfn.0"
d2638 1
a2638 1
$e "# $i -c -o root -g bin -m 444 $tfn.1 /usr/share/man/man1/$tfn.1"
@


1.705
log
@fix English (thanks to Andreas Buschka); TIL:
 to start  a start
 to begin  a beginning
@
text
@d1490 5
a1495 1
	#broken# ac_flags 1 ssp -stackprotect
d2350 1
a2350 1
add_cppflags -DMKSH_BUILD_R=531
@


1.704
log
@outstanding bumps
@
text
@d123 1
a123 1
			# begin of data block
d136 1
a136 1
			# begin of a definition block
d983 1
a983 1
# Begin of mirtoconf checks
@


1.703
log
@experiment with GCC 5s new -malign-data=abi
@
text
@d2346 1
a2346 1
add_cppflags -DMKSH_BUILD_R=530
@


1.702
log
@bump, required by XTaran
@
text
@d1461 1
@


1.701
log
@shave off 12 bytes (with fixed gcc) by making the definitions more legible
(and dropping struct padding, tbh)
@
text
@d2345 1
a2345 1
add_cppflags -DMKSH_BUILD_R=529
@


1.700
log
@remove fd>9 support in favour of upcoming named file descriptors; bump
@
text
@d2501 1
a2501 1
	extras='emacsfn.h rlimits.opt sh.h sh_flags.opt var_spec.h'
@


1.699
log
@rework string pooling; disable our own (rely on compilers)
 if HAVE_STRING_POOLING is set to 1
 if HAVE_STRING_POOLING is set to 2 and not GCC < 4 is used
 if HAVE_STRING_POOLING is not set to 0 and LLVM or GCC >= 4 is used

Closes: LP#1580348
@
text
@a598 1
	HAVE_ISSET_MKSH_CONSERVATIVE_FDS=1	# from sh.h
a692 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a721 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a736 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a785 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a791 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a821 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a825 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a892 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a909 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
a913 1
	add_cppflags -DMKSH_CONSERVATIVE_FDS
d1528 1
a1528 1
ac_cppflags
a1636 1
	HAVE_ISSET_MKSH_CONSERVATIVE_FDS=1	# from sh.h
a1648 6
if ac_ifcpp 'ifdef MKSH_CONSERVATIVE_FDS' isset_MKSH_CONSERVATIVE_FDS '' \
    'if traditional/conservative fd use is requested'; then
	check_categories="$check_categories convfds"
else
	echo >&2 "WARNING: not building with -DMKSH_CONSERVATIVE_FDS is deprecated"
fi
d2345 1
a2345 1
add_cppflags -DMKSH_BUILD_R=523
a2650 1
MKSH_CLRTOEOL_STRING		"\033[K"
a2651 1
MKSH_CONSERVATIVE_FDS		fd 0-9 for scripts, shell only up to 31 (soon default)
@


1.698
log
@deprecate *not* using MKSH_CONSERVATIVE_FDS; named fds coming soon

partially reverts commitid 10048752E6271CABA24 (the manpage, mostly)
and adds a deprecation warning at build time; suggested by izabera
@
text
@d1117 1
d1134 1
d1531 10
@


1.697
log
@document upcoming set +o changes; bump
@
text
@d1649 6
a1654 3
ac_ifcpp 'ifdef MKSH_CONSERVATIVE_FDS' isset_MKSH_CONSERVATIVE_FDS '' \
    'if traditional/conservative fd use is requested' && \
    check_categories="$check_categories convfds"
d2659 1
a2659 1
MKSH_CONSERVATIVE_FDS		fd 0-9 for scripts, shell only up to 31
@


1.696
log
@save 200 bytes off .text by revisiting string pooling

also, forgotten version bump
@
text
@d2348 1
a2348 1
add_cppflags -DMKSH_BUILD_R=522
@


1.695
log
@glibc now causes warnings with set[ug]id also on kFreeBSD and Hurd
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.694 2015/12/31 21:16:20 tg Exp $'
d2348 1
a2348 1
add_cppflags -DMKSH_BUILD_R=521
@


1.694
log
@dont use unset in portable code either, thanks autoconf texinfo manual
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.680 2015/07/05 15:45:16 tg Exp $'
d5 1
a5 1
#		2011, 2012, 2013, 2014, 2015
d748 1
d757 1
@


1.693
log
@update for recent changes
@
text
@d1240 1
d1247 1
a1247 1
	unset et
d1253 1
a1253 1
$e "$bi==> which compiler seems to be used...$ao $ui$ct${et+ on $et}$ao"
@


1.692
log
@while fgreps easier on the eyes, grep -Fs more well-known
@
text
@d103 1
d132 3
d184 1
d2345 1
a2345 1
add_cppflags -DMKSH_BUILD_R=511
@


1.691
log
@stop using issetugid(2) for p check as its probably not the right tool
@
text
@d1198 1
a1198 1
	    fgrep -i -e version -e release"
d2412 1
a2412 1
	fgrep -e Mir''OS: -e MIRBSD "\$sflag"
@


1.690
log
@oksh sync, simplify *all* if(x)free(x); constructs, simplify x_push() and sync boilerplate while here
@
text
@d6 1
a6 1
#	mirabilos <tg@@mirbsd.org>
a1920 5
ac_test issetugid <<-'EOF'
	#include <unistd.h>
	int main(void) { return (issetugid()); }
EOF

@


1.689
log
@git@@github.com:komh/pdksh-os2 commit 590f2b19b0ff92a9a373295bce914654f9f5bf22
says to use <termio.h> not <termios.h> on OS/2

From: Ilya Zakharevich <ilya@@math.ohio-state.edu>
@
text
@d6 1
a6 1
#	Thorsten mirabilos Glaser <tg@@mirbsd.org>
d2417 1
a2417 1
	fgrep -e MirOS: -e MIRBSD "\$sflag"
@


1.688
log
@harden the crlf vs lf tests even more; use binary mode explicitly on OS/2
@
text
@d835 1
@


1.687
log
@SECURITY: quote the arguments to true
@
text
@d1676 1
d2344 1
a2344 1
add_cppflags -DMKSH_BUILD_R=510
@


1.686
log
@more mksh-os2 inspired hackery
@
text
@d686 1
a686 1
	: ${HAVE_CAN_OTWO=0}
d693 1
a693 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d712 1
a712 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d723 1
a723 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d736 1
a736 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d761 2
a762 2
	: ${LIBS='-lcrypt'}
	: ${HAVE_SETLOCALE_CTYPE=0}
d765 1
a765 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d773 1
a773 1
	: ${HAVE_REVOKE=0}
d786 1
a786 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d794 1
a794 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d801 1
a801 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d803 1
a803 1
	: ${HAVE_STDINT_H=0}
d810 2
a811 1
	: ${AWK=gawk} ${CC=cc -posix}
d832 1
a832 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d838 2
a839 2
	: ${CC=gcc}
	: ${SIZE=: size}
d849 1
a849 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d867 1
a867 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d877 1
a877 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d894 1
a894 1
	: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
d909 1
a909 1
	: ${CC=cc -YPOSIX}
d912 1
a912 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d917 1
a917 1
	: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
d925 1
a925 1
	: ${HAVE_SETLOCALE_CTYPE=0}
d939 1
a939 1
: ${HAVE_MKNOD=0}
d941 1
a941 1
: ${AWK=awk} ${CC=cc} ${NROFF=nroff} ${SIZE=size}
d1208 1
a1208 1
		: ${HAVE_CAN_OTWO=0} ${HAVE_CAN_OPTIMISE=0}
d1262 1
a1262 1
	: ${HAVE_CAN_DELEXE=x}
d1624 2
a1625 2
	: ${HAVE_NICE=0}
	: ${HAVE_PERSISTENT_HISTORY=0}
d1639 1
a1639 1
    'if the default UTF-8 mode is specified' && : ${HAVE_SETLOCALE_CTYPE=0}
@


1.685
log
@more easy OS/2 fixes

From: KO Myung-Hun <komh@@chollian.net>
@
text
@d1063 1
a1063 1
#if defined(__KLIBC__)
@


1.684
log
@a few more mksh-os2 inspired fixes
@
text
@d839 2
@


1.683
log
@add a few generic fixes from mksh-os2

From: KO Myung-Hun <komh@@chollian.net>
@
text
@d581 2
a582 2
rmf a.exe* a.out* conftest.c *core core.* ${tfn}* *.bc *.dbg *.ll *.o *.gen \
    Rebuild.sh lft no signames.inc test.sh x vv.out
d834 3
d838 1
d1244 1
a1244 1
rmf conftest.c conftest.o conftest a.out* a.exe* vv.out
d2348 7
a2354 2
a.exe|conftest.exe) mkshexe=$tfn.exe ;;
*) mkshexe=$tfn ;;
@


1.682
log
@merge from git@@github.com:komh/mksh-os2

Use gcc on OS/2

From: KO Myung-Hun <komh@@chollian.net>
@
text
@d317 1
d2344 2
a2345 2
a.exe)	mkshexe=$tfn.exe ;;
*)	mkshexe=$tfn ;;
@


1.681
log
@ revert the cat hack for realpath and rename
   I was convinced by several that more magic is never the solution
 fix a comment: function cat already had precedence
 change cat loader to look for existence, FPATH included, before
  ditching the builtin; note that in manpage
@
text
@d832 3
@


1.680
log
@implement cat thing for realpath and rename too: if flag, call external
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.671 2014/11/25 21:13:18 tg Exp $'
a2647 3
MKSH_NO_EXTERNAL_CAT		omit hack to skip cat builtin when flags passed
MKSH_NO_EXTERNAL_REALPATH	same for realpath builtin
MKSH_NO_EXTERNAL_RENAME		same for rename builtin
@


1.679
log
@sync with actual z/OS <signal.h> contents
@
text
@d2649 2
@


1.678
log
@overhaul the signal handling:
 support NSIG_MAX from http://austingroupbugs.net/view.php?id=741
  and make a TODO for later to use sysconf(_SC_NSIG) at runtime
 bounds-check signals (e.g. no smaller than 1, but smaller than NSIG)
 align trap errorlevel with other shells
 make trap match whats in POSIX and fixup the manpage
 refactor some code related to signals
 hide from kill builtin both EXIT and ERR pseudo-signals
@
text
@d2288 2
a2289 2
	sigs="$sigs XCPU XFSZ INFO WINCH EMT IO DIL LOST PWR SAK CLD IOT RESV"
	sigs="$sigs STKFLT ABND DCE DUMP IOERR TRACE DANGER UNUSED"
@


1.677
log
@improve install notes, mention lksh, as requested by Ypnose via IRC
@
text
@d2251 6
a2256 3
#ifndef NSIG
#if defined(_NSIG)
#define NSIG _NSIG
d2258 1
a2258 1
#define NSIG (SIGMAX+1)
d2260 1
a2260 1
#define NSIG (_SIGMAX+1)
d2262 2
a2263 3
/* XXX better error out, see sh.h */
#define NSIG 64
#endif
d2266 1
a2266 1
mksh_cfg= NSIG
d2315 1
a2315 1
		test $nr -gt 0 && test $nr -le $NSIG || continue
@


1.676
log
@more OS/390 issues
@
text
@d2673 3
@


1.675
log
@EBCDIC helpers and OS/390 signals
@
text
@d580 2
a581 2
rmf a.exe* a.out* conftest.c *core core.* lft ${tfn}* no *.bc *.ll *.o *.gen \
    Rebuild.sh signames.inc test.sh x vv.out
d932 1
a932 1
    NROFF="$NROFF -c"
@


1.674
log
@ordinarily, lineno must be mksh_uari_t, but edit.c most of all isnt ready,
so we mitigate a bit (in var.c mostly) and tweak another type already, and
add some checks (mksh_{,u}ari_t must fit into {,unsigned }long) and print
line numbers with %lu already
@
text
@d2287 1
a2287 1
	sigs="$sigs STKFLT UNUSED"
@


1.673
log
@Implement the FKSH functions have local scope for shell options feature
for mksh but not lksh; bump to R51-alpha.

While here, tweak build scripts a bit, fixup MirBSD-specific Makefile
things, remove part of a comment thats uninteresting.
@
text
@d2154 1
a2154 1
#define NUM 21
d2156 1
a2156 1
#define NUM 15
d2169 1
@


1.672
log
@port this to GNU bash 1.12.1 from http://www.qemu-advent-calendar.org/#day-1
@
text
@d5 2
a6 2
#		2011, 2012, 2013, 2014
#	Thorsten Glaser <tg@@mirbsd.org>
d1695 1
d1784 1
a1784 1
	cat >conftest.c <<-'EOF'
d1788 2
a1789 2
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.671 2014/11/25 21:13:18 tg Exp $");
		int main(void) { printf("Hello, World!\n"); return (isatty(0)); }
d2329 1
a2329 1
add_cppflags -DMKSH_BUILD_R=509
@


1.671
log
@ Build.sh: fix NSIG detection for gcc-snapshot
 all: bump version to R50-current; add more comments; whitespace
 all: remove all mkssert(); well do full re-runs of scan-build and,
  hopefully, Coverity Scan/Prevent
 check.t: fix a testcase (sed could exit false, but we dont care)
 eval.c: fix tilde_ok data type (only unsigned may shl constantly)
 exec.c: fix shebang buf array accesses to always go via uint8_t *
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.669 2014/10/07 15:22:12 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.669 2014/10/07 15:22:12 tg Exp $");
d2443 4
a2446 1
for file in "$srcdir"/*.opt; do
d2448 1
a2448 1
	echo "(srcfile='$file'; BUILDSH_RUN_GENOPT=1; . '$srcdir/Build.sh')"
d2482 1
a2482 1
	for file in "$srcdir"/*.opt; do
d2485 2
a2486 2
		genq="$genq$nl$genf: $srcdir/Build.sh $file
			srcfile=$file; BUILDSH_RUN_GENOPT=1; . $srcdir/Build.sh"
d2530 1
a2530 1
for file in "$srcdir"/*.opt; do
d2532 1
a2532 1
	do_genopt "$file" || exit 1
@


1.670
log
@stop using ptrdiff_t
@
text
@d2266 5
d2302 5
d2328 1
a2328 1
add_cppflags -DMKSH_BUILD_R=504
@


1.669
log
@fix severe regression in field splitting (LP#1378208)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.668 2014/10/03 17:32:07 tg Exp $'
d1703 1
a1703 1
	int main(int ac, char **av) { return ((uint32_t)(ptrdiff_t)*av + (int32_t)ac); }
d1708 1
a1708 1
	int main(int ac, char **av) { return ((u_int32_t)(ptrdiff_t)*av + (int32_t)ac); }
d1713 1
a1713 1
	int main(int ac, char **av) { return ((uint8_t)(ptrdiff_t)av[ac]); }
d1718 1
a1718 1
	int main(int ac, char **av) { return ((u_int8_t)(ptrdiff_t)av[ac]); }
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.668 2014/10/03 17:32:07 tg Exp $");
d1972 1
a1972 1
	int main(void) { return ((int)(ptrdiff_t)(void *)setlocale(LC_CTYPE, "")); }
d1978 1
a1978 1
	int main(void) { return ((int)(ptrdiff_t)(void *)nl_langinfo(CODESET)); }
d2153 1
a2153 1
#define NUM 22
d2155 1
a2155 1
#define NUM 16
d2164 2
a2165 3
cta(ptrdifft_sizet_same_size, sizeof(ptrdiff_t) == sizeof(size_t));
cta(ptrdifft_voidptr_same_size, sizeof(ptrdiff_t) == sizeof(void *));
cta(ptrdifft_funcptr_same_size, sizeof(ptrdiff_t) == sizeof(void (*)(void)));
d2167 1
a2167 1
cta(ptr_fits_in_long, sizeof(ptrdiff_t) <= sizeof(long));
@


1.669.2.1
log
@MFC:
 portability improvements and bugfixes (ptrdiff_t  size_t,
  newer GCC, older GNU bash, no printf(1) use in testsuite,
  rename tilde function, setugid ordering)
 drop old/useless asserts
 manpage fixes
 missing brace in syn.c
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.669 2014/10/07 15:22:12 tg Exp $'
d1703 1
a1703 1
	int main(int ac, char **av) { return ((uint32_t)(size_t)*av + (int32_t)ac); }
d1708 1
a1708 1
	int main(int ac, char **av) { return ((u_int32_t)(size_t)*av + (int32_t)ac); }
d1713 1
a1713 1
	int main(int ac, char **av) { return ((uint8_t)(size_t)av[ac]); }
d1718 1
a1718 1
	int main(int ac, char **av) { return ((u_int8_t)(size_t)av[ac]); }
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.669 2014/10/07 15:22:12 tg Exp $");
d1972 1
a1972 1
	int main(void) { return ((int)(size_t)(void *)setlocale(LC_CTYPE, "")); }
d1978 1
a1978 1
	int main(void) { return ((int)(size_t)(void *)nl_langinfo(CODESET)); }
d2153 1
a2153 1
#define NUM 21
d2155 1
a2155 1
#define NUM 15
d2164 3
a2166 2
cta(sizet_voidptr_same_size, sizeof(size_t) == sizeof(void *));
cta(sizet_funcptr_same_size, sizeof(size_t) == sizeof(void (*)(void)));
d2168 1
a2168 1
cta(ptr_fits_in_long, sizeof(size_t) <= sizeof(long));
a2266 5
	    grep -v '^#' | \
	    sed '/mksh_cfg.*= *$/{
		N
		s/\n/ /
		}' | \
a2297 5
		    grep -v '^#' | \
		    sed '/mksh_cfg.*= *$/{
			N
			s/\n/ /
			}' | \
d2434 1
a2434 4
cd "$srcdir"
optfiles=`echo *.opt`
cd "$curdir"
for file in $optfiles; do
d2436 1
a2436 1
	echo "(srcfile='$srcdir/$file'; BUILDSH_RUN_GENOPT=1; . '$srcdir/Build.sh')"
d2470 1
a2470 1
	for file in $optfiles; do
d2473 2
a2474 2
		genq="$genq$nl$genf: $srcdir/Build.sh $srcdir/$file
			srcfile=$srcdir/$file; BUILDSH_RUN_GENOPT=1; . $srcdir/Build.sh"
d2518 1
a2518 1
for file in $optfiles; do
d2520 1
a2520 1
	do_genopt "$srcdir/$file" || exit 1
@


1.669.2.2
log
@MFC everything except the igli-inspired changes to jobs.c and the
.Ox Ns -inspired integer base changes .
That means: bugfixes, plus the new arguments to exec (feature)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.669.2.1 2015/01/25 15:35:34 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.669.2.1 2015/01/25 15:35:34 tg Exp $");
d2328 1
a2328 1
add_cppflags -DMKSH_BUILD_R=505
@


1.669.2.3
log
@MFC most things (see mksh.hts) to R50-stable; sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.669.2.2 2015/03/01 15:42:50 tg Exp $'
d5 2
a6 2
#		2011, 2012, 2013, 2014, 2015
#	Thorsten mirabilos Glaser <tg@@mirbsd.org>
a1694 1
rm -f lft.c
d1783 1
a1783 1
	cat >conftest.c <<-EOF
d1787 2
a1788 2
		__RCSID("$srcversion");
		int main(void) { printf("Hello, World!\\n"); return (isatty(0)); }
d2328 1
a2328 1
add_cppflags -DMKSH_BUILD_R=506
@


1.669.2.4
log
@MFC remaining fixes; tested locally a lot, plus remotely with
GNU C11 (Debian 20150413-1) version 5.0.1 20150413 (prerelease) [gcc-5-branch revision 222050] (x86_64-linux-gnu)
including ASan (testsuite) and Valgrind (short)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.669.2.3 2015/04/12 22:32:14 tg Exp $'
d2154 1
a2154 1
#define NUM 22
d2156 1
a2156 1
#define NUM 16
a2168 1
cta(ari_fits_in_long, sizeof(mksh_ari_t) <= sizeof(long));
@


1.668
log
@overhaul IFS handling, fix bugs reported by Stephane Chazelas and mikeserv

now were at: 486 passed testsuite items, 0 failed
ifs.sh still: # tests 6856 passed 6856 failed 0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.666 2014/09/29 18:57:00 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.666 2014/09/29 18:57:00 tg Exp $");
d2319 1
a2319 1
add_cppflags -DMKSH_BUILD_R=503
@


1.667
log
@use issetugid(2) as additional aid in determining if we are FPRIVILEGED
@
text
@d2319 1
a2319 1
add_cppflags -DMKSH_BUILD_R=502
@


1.666
log
@fix link; found by zacts
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.665 2014/09/04 23:06:51 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.665 2014/09/04 23:06:51 tg Exp $");
d1907 5
@


1.665
log
@more rare signals
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.664 2014/09/03 19:22:48 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.664 2014/09/03 19:22:48 tg Exp $");
d2651 1
a2651 1
https://www.mirbsd.org/cvs.cgi/contrib/hosted/tg/deb/mksh/debian/.mkshrc?rev=HEAD
@


1.664
log
@permit $1, $!, etc. to be namerefd again ($_ was); spotted by Jb_boin, 10x!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.663 2014/07/04 11:03:52 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.663 2014/07/04 11:03:52 tg Exp $");
d2276 1
@


1.663
log
@eglibc is merged back into glibc; adjust comment
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.662 2014/06/29 10:56:08 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.662 2014/06/29 10:56:08 tg Exp $");
d2313 1
a2313 1
add_cppflags -DMKSH_BUILD_R=501
@


1.662
log
@use -fstack-protector-strong in favour of -fstack-protector-all if we can
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.660 2014/06/09 13:25:49 tg Exp $'
d1787 1
a1787 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.660 2014/06/09 13:25:49 tg Exp $");
d2623 1
a2623 1
MKSH_NOPWNAM			skip PAM calls, for -static on eglibc, Solaris
@


1.661
log
@bump
@
text
@d1403 3
a1405 1
	ac_flags 1 fstackprotectorall -fstack-protector-all
@


1.660
log
@fix some of the signal stuff (still didnt get rid of awk(1) and printf(1)
calls in Build.sh, we need HOSTCC for that which we should do, using BER
or something encoded for integers, and pregenerated hashtables as planned)

also, bump to R50 beta, due to todays language changes
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.658 2014/05/27 13:22:41 tg Exp $'
d1785 1
a1785 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.658 2014/05/27 13:22:41 tg Exp $");
d2311 1
a2311 1
add_cppflags -DMKSH_BUILD_R=500
@


1.659
log
@improved OE reporting for newer Darwin/OSX, by Ryan Schmidt <ryandesign@@macports.org>
@
text
@d2250 3
d2271 3
a2273 3
	sigs="INT SEGV ABRT KILL ALRM BUS CHLD CLD CONT DIL EMT FPE HUP ILL"
	sigs="$sigs INFO IO IOT LOST PIPE PROF PWR QUIT RESV SAK STOP SYS TERM"
	sigs="$sigs TRAP TSTP TTIN TTOU URG USR1 USR2 VTALRM WINCH XCPU XFSZ"
d2311 1
a2311 1
add_cppflags -DMKSH_BUILD_R=499
@


1.658
log
@fix LP#1277691 (nameref RHS not syntax checked) and the inability to
use errorf() while nameref states were being changed (by almost completely
eliminating the global variable) and the readonly first array variable
bypass (typo/refactoro); also, whitespace, one int  bool, and add a
comment wrt. the parser rewrite talked about with igli during a fever ;)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.657 2014/03/28 12:08:25 tg Exp $'
d943 4
d948 1
d1785 1
a1785 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.657 2014/03/28 12:08:25 tg Exp $");
@


1.657
log
@avoid UB in LFS test (Debian #742780)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.656 2014/02/08 20:20:17 tg Exp $'
d1780 1
a1780 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.656 2014/02/08 20:20:17 tg Exp $");
d2303 1
a2303 1
add_cppflags -DMKSH_BUILD_R=491
@


1.656
log
@honour $TMPDIR in test.sh for use as scratch space
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.655 2014/01/05 21:57:21 tg Exp $'
d1674 1
a1674 1
#define LARGE_OFF_T (((off_t)1 << 62) - 1 + ((off_t)1 << 62))
d1780 1
a1780 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.655 2014/01/05 21:57:21 tg Exp $");
@


1.655
log
@ fix ${12345678901234567890} segfault (OOB access / integer overflow)
   not like oksh did, but using mkshs built-in features
 handle suggested __pure additions
 revert cid 1004F7F096867C83CF0
   always use our wcwidth code
   only use our strlcpy code if none found
 fix a couple of gcc-snapshot and clang/scan-build warnings
 mksh R49~rc1
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.653 2013/11/30 17:41:31 tg Exp $'
d1780 1
a1780 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.653 2013/11/30 17:41:31 tg Exp $");
d2365 4
@


1.654
log
@reads -r option is not portable; discovered by RT
@
text
@d5 1
a5 1
#		2011, 2012, 2013
d343 1
d345 1
a345 1
		int main(void) { return (
d402 2
a403 1
			int main(void) { return (0); }
d443 2
a444 1
	echo 'int main(void) { return (0); }' >>x
a450 6
	addsrcs_s=0
	if test x"$1" = x"-s"; then
		# optstatic
		addsrcs_s=1
		shift
	fi
a457 7
	if test $addsrcs_s = 1; then
		if test -f "$2" || test -f "$srcdir/$2"; then
			# always add $2, since it exists
			fr=1
			i=1
		fi
	fi
d1062 4
a1065 1
echo 'int main(void) { return (0); }' >conftest.c
d1251 2
a1252 1
			int main(void) { return (0); }
d1258 2
a1259 1
			int main(void) { return (0); }
d1355 2
a1356 1
		int main(void) { return (0); }
d1559 13
d1578 2
d1581 1
a1581 1
	    __attribute__((__unused__))) { return (0); }
d1590 2
d1593 1
a1593 1
	int main(void) { return (0); }
d1645 2
a1646 1
	int main(void) { struct tm tm; return ((int)sizeof(tm)); }
d1672 1
d1677 1
a1677 1
int main(void) { return (0); }' >lft.c
d1728 1
a1728 1
	int main(void) { return ((int)(rlim_t)0); }
d1781 1
a1781 1
		int main(void) { printf("Hello, World!\n"); return (0); }
d1820 2
a1821 1
	int main(void) { return (*sys_errlist[sys_nerr - 1]); }
d1826 2
a1827 1
	int main(void) { return (*_sys_errlist[_sys_nerr - 1]); }
d1840 2
a1841 1
		int main(void) { return (sys_sig${what}[0][0]); }
d1845 2
a1846 1
		int main(void) { return (_sys_sig${what}[0][0]); }
d1913 1
a1913 1
		return (*(int *)(void *)memmove(av[0], av[1], ac));
d2085 1
a2085 1
	int main(void) { return (*sys_errlist[sys_nerr - 1]); }
d2090 1
a2090 1
	int main(void) { return (sys_siglist[0][0]); }
d2161 1
a2161 1
	int main(void) { return (sizeof(ctasserts_dblcheck)); }
d2299 1
a2299 1
addsrcs -s '!' HAVE_STRLCPY strlcpy.c
d2303 1
a2303 2
test -n "$LDSTATIC" && add_cppflags -DMKSH_OPTSTATIC
add_cppflags -DMKSH_BUILD_R=489
@


1.653
log
@detect getsid(2), also spotted by RT, this on MSYS
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.652 2013/11/30 15:42:18 tg Exp $'
d110 1
a110 1
	while IFS= read -r line; do
d159 1
a159 1
			IFS= read -r line || genopt_die Unexpected EOF
d172 1
a172 1
	echo "$o_str" | sort | while IFS='|' read -r x opts cond; do
d1765 1
a1765 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.652 2013/11/30 15:42:18 tg Exp $");
@


1.652
log
@zsh on BeOS calls sigsuspend() on dot, which fails; work around it

tested by RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.651 2013/11/20 21:14:49 tg Exp $'
d1765 1
a1765 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.651 2013/11/20 21:14:49 tg Exp $");
d1870 5
@


1.651
log
@make this actually call getopt.sh, correctly, and Heirloom sh compatible
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.650 2013/11/17 22:22:50 tg Exp $'
a30 3
echo "For the build logs, demonstrate that /dev/null and /dev/tty exist:"
ls -l /dev/null /dev/tty

d46 156
d222 1
a222 1
		Build.sh|check.pl|check.t|dot.mkshrc|genopt.sh|*.1|*.c|*.h|*.ico|*.opt) ;;
a227 6
allu=QWERTYUIOPASDFGHJKLZXCVBNM
alll=qwertyuiopasdfghjklzxcvbnm
alln=0123456789
alls=______________________________________________________________
nl='
'
d525 4
d629 1
a629 1
ccpr='|| for _f in ${tcfn}*; do case $_f in Build.sh|check.pl|check.t|dot.mkshrc|genopt.sh|*.1|*.c|*.h|*.ico|*.opt) ;; *) rm -f "$_f" ;; esac; done'
d1765 1
a1765 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.650 2013/11/17 22:22:50 tg Exp $");
d2392 2
a2393 2
	echo "echo + Running \\\$srcdir/genopt.sh on '$file'..."
	echo "(srcfile='$file'; . '$srcdir/genopt.sh')"
d2424 1
a2424 1
	extras='emacsfn.h genopt.sh rlimits.opt sh.h sh_flags.opt var_spec.h'
d2430 2
a2431 2
		genq="$genq$nl$genf: $srcdir/genopt.sh $file
			srcfile=$file; . $srcdir/genopt.sh"
d2476 2
a2477 1
	v "(srcfile='$file'; . '$srcdir/genopt.sh')" || exit 1
@


1.650
log
@static option creating for cmdline and set, too
(in preparation of doing something real with set p)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.647 2013/09/10 17:32:56 tg Exp $'
d69 1
a69 1
		Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|*.ico|*.1) ;;
d330 11
a340 2
x) srcdir=. ;;
*"'"*) echo Source directory must not contain single quotes.; exit 1 ;;
d439 1
a439 1
rmf a.exe* a.out* conftest.c *core core.* lft ${tfn}* no *.bc *.ll *.o \
d478 1
a478 1
ccpr='|| for _f in ${tcfn}*; do case $_f in Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|*.ico|*.1) ;; *) rm -f "$_f" ;; esac; done'
d1614 1
a1614 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.647 2013/09/10 17:32:56 tg Exp $");
d2240 4
d2275 7
d2299 2
d2324 3
@


1.649
log
@more clueful (automatic) getopt string generation
@
text
@d2260 1
a2260 1
	extras='emacsfn.h genopt.sh rlimits.opt sh.h sh_flags.h var_spec.h'
@


1.648
log
@adapt most __attribute__(()) occurrences to new KNF style(9)
@
text
@d328 6
a333 3
curdir=`pwd` srcdir=`dirname "$0" 2>/dev/null` check_categories=
test -n "$srcdir" || srcdir=. # in case dirname does not exist
dstversion=`sed -n '/define MKSH_VERSION/s/^.*"\([^"]*\)".*$/\1/p' $srcdir/sh.h`
d342 1
d2260 1
a2260 1
	extras='emacsfn.h sh.h sh_flags.h var_spec.h'
@


1.647
log
@integrate latest changes from oksh: Wed Sep 4 15:49:19 2013 UTC by millert

Add a proper suspend builtin that saves/restores the tty and pgrp
as needed instead of an alias that just sends SIGSTOP.  Login shells
may be suspended if they are not running in an orphan process group.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.645 2013/08/10 13:44:25 tg Exp $'
d1359 2
a1360 2
	    __attribute__((__bounded__ (__buffer__, 1, 3)))
	    __attribute__((__bounded__ (__buffer__, 2, 3)));
d1382 1
a1382 1
	    __attribute__((__format__ (__printf__, 2, 3)));
d1601 1
a1601 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.645 2013/08/10 13:44:25 tg Exp $");
@


1.646
log
@SECURITY: Unbreak set +p, broken by OpenBSD ksh change.

TODO: I am seriously considering following Chet and changing
the way this works, by explicitly dropping privs unless the
shell is run with -p. Every other shell does it like mksh,
except Heirloom sh, which on the other hand doesnt know any
explicit set -p or set +p (though it doesnt know set +foo
for any foo either).

 QUESTION: Do we need the ability to do this:
 tg@@blau:~ $ ./suidmksh -p -c 'whoami; set +p; whoami'
 root
 tg

If not, Im seriously considering to drop set p as well,
only parse -p on the command line, with +p being the default,
and dropping FPRIVILEGED.

Thanks to RT for noticing and jilles for initial follow-up
discussion, as well as Chet Ramey for doing the sane/secure
thing instead of following Debian.
@
text
@d2116 1
a2116 1
add_cppflags -DMKSH_BUILD_R=483
@


1.645
log
@reduce amount of .bss memory needed; initialise via AEDIT at x_init
or even first run of x_vi
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.644 2013/07/25 17:01:03 tg Exp $'
d1601 1
a1601 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.644 2013/07/25 17:01:03 tg Exp $");
d2116 1
a2116 1
add_cppflags -DMKSH_BUILD_R=481
@


1.644
log
@also protect the icon file from accidental deletion, and merge the cases
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.639 2013/07/08 10:12:45 tg Exp $'
d1601 1
a1601 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.639 2013/07/08 10:12:45 tg Exp $");
d2116 1
a2116 1
add_cppflags -DMKSH_BUILD_R=471
@


1.643
log
@rewrite lots of elif test into case statements

(except those where the condition isnt related)
@
text
@d69 1
a69 1
		Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|lksh.1|mksh.1) ;;
d465 1
a465 1
ccpr='|| for _f in ${tcfn}*; do case $_f in Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|lksh.1|mksh.1) ;; *) rm -f "$_f" ;; esac; done'
@


1.642
log
@Plan 9 support patch from Jens Staal
@
text
@d1090 8
a1097 1
	if test $ct = dmc; then
d1102 2
a1103 6
	elif test $ct = dec; then
		CFLAGS="$CFLAGS ${ccpl}-non_shared"
		ac_testn can_delexe compiler_fails 0 'for the -non_shared linker option' <<-EOF
			int main(void) { return (0); }
		EOF
	else
d1105 2
a1106 1
	fi
d1119 13
a1131 7
if test $ct = sunpro; then
	test x"$save_NOWARN" = x"" && save_NOWARN='-errwarn=%none'
	ac_flags 0 errwarnnone "$save_NOWARN"
	test 1 = $HAVE_CAN_ERRWARNNONE || save_NOWARN=
	ac_flags 0 errwarnall "-errwarn=%all"
	test 1 = $HAVE_CAN_ERRWARNALL && DOWARN="-errwarn=%all"
elif test $ct = hpcc; then
d1134 6
a1139 1
elif test $ct = mipspro; then
d1142 2
a1143 1
elif test $ct = msc; then
d1146 9
a1154 15
elif test $ct = dmc; then
	save_NOWARN="${ccpc}-w"
	DOWARN="${ccpc}-wx"
elif test $ct = bcc; then
	save_NOWARN="${ccpc}-w"
	DOWARN="${ccpc}-w!"
elif test $ct = dec; then
	: -msg_* flags not used yet, or is -w2 correct?
elif test $ct = kencc; then
	save_NOWARN=
	DOWARN=
elif test $ct = xlc; then
	save_NOWARN=-qflag=i:e
	DOWARN=-qflag=i:i
elif test $ct = tendra; then
d1156 2
a1157 1
elif test $ct = ucode; then
d1160 2
a1161 1
elif test $ct = watcom; then
d1164 6
a1169 1
else
d1175 3
a1177 3
fi

test $ct = icc && DOWARN="$DOWARN -wd1419"
d1185 10
a1194 1
test x"$i" = x"" && if test $ct = sunpro; then
d1204 2
a1205 5
elif test $ct = hpcc; then
	phase=u
	ac_flags 1 otwo +O2
	phase=x
elif test $ct = xlc; then
d1208 2
a1209 3
elif test $ct = kencc || test $ct = tcc || test $ct = tendra; then
	: no special optimisation
else
d1212 2
a1213 1
fi
d1216 16
a1231 1
if test $ct = gcc; then
d1243 6
a1248 1
	if test $cm = lto; then
d1251 2
a1252 4
	elif test $cm = combine; then
		fv=0
		checks='7 8'
	else
d1254 2
a1255 1
	fi
d1284 8
a1291 1
elif test $ct = icc; then
d1296 2
a1297 19
elif test $ct = sunpro; then
	phase=u
	ac_flags 1 v -v
	ac_flags 1 ipo -xipo 'for cross-module optimisation'
	phase=x
elif test $ct = hpcc; then
	phase=u
	# probably not needed
	#ac_flags 1 agcc -Agcc 'for support of GCC extensions'
	phase=x
elif test $ct = dec; then
	ac_flags 0 verb -verbose
	ac_flags 1 rodata -readonly_strings
elif test $ct = dmc; then
	ac_flags 1 decl "${ccpc}-r" 'for strict prototype checks'
	ac_flags 1 schk "${ccpc}-s" 'for stack overflow checking'
elif test $ct = bcc; then
	ac_flags 1 strpool "${ccpc}-d" 'if string pooling can be enabled'
elif test $ct = mipspro; then
d1299 2
a1300 1
elif test $ct = msc; then
d1309 20
a1328 1
elif test $ct = xlc; then
d1334 2
a1335 12
elif test $ct = tendra; then
	ac_flags 0 ysystem -Ysystem
	test 1 = $HAVE_CAN_YSYSTEM && CPPFLAGS="-Ysystem $CPPFLAGS"
	ac_flags 1 extansi -Xa
elif test $ct = tcc; then
	: #broken# ac_flags 1 boundschk -b
elif test $ct = clang; then
	i=1
elif test $ct = nwcc; then
	i=1
	: #broken# ac_flags 1 ssp -stackprotect
fi
d2215 5
a2219 1
if test $cm = llvm; then
d2221 2
a2222 3
elif test $cm = dragonegg; then
	emitbc="-S -flto"
else
d2224 2
a2225 1
fi
@


1.641
log
@align the compile-time asserts double-check struct size with padding
@
text
@d693 1
d696 2
d886 3
d965 3
d1138 3
d1185 1
a1185 1
elif test $ct = tcc || test $ct = tendra; then
@


1.640
log
@Fix most set -x problems (LP#1179287)

 set -x manually (cmdline too) snapshots fd#2 now
 set -o inherit-xtrace introduced; default still enabled
 reverted iodup printing to pre-R45 behaviour
 made Flag(FXTRACE) a proper state machine
@
text
@d1899 3
d1915 2
d1918 1
a1918 6
#ifndef MKSH_LEGACY_MODE
#define NUM 22
#else
#define NUM 16
#endif
char ctasserts_dblcheck[sizeof(struct ctasserts) == NUM ? 1 : -1];
@


1.639
log
@use ${SIZE-size} for lewellyns cross
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.638 2013/06/03 22:27:15 tg Exp $'
d1547 1
a1547 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.638 2013/06/03 22:27:15 tg Exp $");
d2062 1
a2062 1
add_cppflags -DMKSH_BUILD_R=469
@


1.638
log
@replace warnings for sig_t detection
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.635 2013/05/22 19:24:32 tg Exp $'
d773 1
a773 1
: ${AWK=awk} ${CC=cc} ${NROFF=nroff}
d1547 1
a1547 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.635 2013/05/22 19:24:32 tg Exp $");
d2196 1
a2196 1
echo 'test -f $tcfn || exit 1; size $tcfn' >>Rebuild.sh
d2277 1
a2277 1
test 0 = $eq && v size $tcfn
@


1.637
log
@fix a number of warnings and other issues:
 sig_t detection was a bit insane, it is a function-pointer type after all
 fix uninitialised variable in c_select which led to mistakenly accepting
  invalid (nn-numeric) input and acting, randomly, upon it
 keep SIGCHLD blocked in child after forking longer, for job list manip
 block SIGCHLD ifdef DEBUG_LEAKS to not run job foo during/after afreeall
 fix annoying ISO C90 vs. C99 (un)signed constant warning
@
text
@d1503 2
a1504 3
	#include <stdlib.h>
	volatile sig_t foo = NULL;
	int main(void) { return (foo == NULL); }
d1511 2
a1512 3
	#include <stdlib.h>
	volatile sighandler_t foo = NULL;
	int main(void) { return (foo == NULL); }
d1523 2
a1524 3
	#include <stdlib.h>
	volatile __sighandler_t foo = NULL;
	int main(void) { return (foo == NULL); }
@


1.636
log
@Replace wcwidth code by mine based on Unicode 6.2.0
@
text
@d1503 3
a1505 1
	int main(void) { return ((int)(ptrdiff_t)(sig_t)(ptrdiff_t)kill(0,0)); }
d1512 3
a1514 1
	int main(void) { return ((int)(ptrdiff_t)(sighandler_t)(ptrdiff_t)kill(0,0)); }
d1525 3
a1527 1
	int main(void) { return ((int)(ptrdiff_t)(__sighandler_t)(ptrdiff_t)kill(0,0)); }
@


1.635
log
@meh, wrong gcc flag
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.633 2013/05/08 11:30:45 tg Exp $'
d1544 1
a1544 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.633 2013/05/08 11:30:45 tg Exp $");
d2059 1
a2059 1
add_cppflags -DMKSH_BUILD_R=461
@


1.634
log
@ fix error in warning fix (hah!)
 if GCC add -Wno-deprecated for dietlibc (and others) idiocy
@
text
@d1184 1
a1184 1
	ac_flags 1 wnodeprecated -Wno-deprecated
@


1.633
log
@also from Sylvestre Ledrus clang-using Debian buildd, quieten another configure time warning; log before running that /dev/{null,tty} exist (with ls -l, so we see theyre actual devices)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.631 2013/05/05 13:38:00 tg Exp $'
d196 1
a196 1
		extern void thiswillneverbedefinedIhope(void);
d1184 1
d1298 1
a1298 1
	extern void thiswillneverbedefinedIhope(void);
d1319 1
a1319 1
	extern void thiswillneverbedefinedIhope(void);
d1334 1
a1334 1
	extern void thiswillneverbedefinedIhope(void);
d1347 1
a1347 1
	extern void thiswillneverbedefinedIhope(void);
d1357 1
a1357 1
	extern void thiswillneverbedefinedIhope(void);
d1544 1
a1544 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.631 2013/05/05 13:38:00 tg Exp $");
@


1.632
log
@declare thiswillneverbedefinedIhope to silence some configure time warnings
@
text
@d31 3
d1759 1
a1759 1
	int main(void) { setresuid(0,0,0); return (setresgid(0,0,0)); }
@


1.631
log
@ dont accidentally remove lksh.1 from the srcdir for in-srcdir builds
 fix post-build non--Q output for lksh

both discovered in Fedora; thanks rsc
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.628 2013/04/27 18:12:37 tg Exp $'
d193 1
d1294 1
d1315 1
d1330 1
d1343 1
d1353 1
d1540 1
a1540 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.628 2013/04/27 18:12:37 tg Exp $");
@


1.630
log
@implement VALSUBs
@
text
@d66 1
a66 1
		Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|mksh.1) ;;
d461 1
a461 1
ccpr='|| for _f in ${tcfn}*; do case $_f in Build.sh|check.pl|check.t|dot.mkshrc|*.c|*.h|mksh.1) ;; *) rm -f "$_f" ;; esac; done'
d2271 4
a2274 2
$e "# grep -x /bin/$tfn /etc/shells >/dev/null || echo /bin/$tfn >>/etc/shells"
$e "# $i -c -o root -g bin -m 444 dot.mkshrc /usr/share/doc/mksh/examples/"
d2282 1
a2282 1
$e "# $i -c -o root -g bin -m 444 mksh.1 /usr/share/man/man1/$tfn.1"
@


1.629
log
@ Allow setting both -o posix and -o sh (although only in the same
  command; setting one still unsets the other at first)
 Change subst_exstat to be conformant unless -o sh is set and -o posix isnt
 In lksh, make subst_exstat (newly) conformant if -o posix
 New MKSH_BINSHPOSIX to accompany MKSH_BINSHREDUCED
 Sync lksh manpage precisely
@
text
@d2049 1
a2049 1
add_cppflags -DMKSH_BUILD_R=459
@


1.628
log
@start next development iteration
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.627 2013/04/26 21:22:39 tg Exp $'
d1370 2
a1371 2
ac_ifcpp 'ifdef MKSH_BINSHREDUCED' isset_MKSH_BINSHREDUCED '' \
    "if a reduced-feature sh is requested" && \
d1534 1
a1534 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.627 2013/04/26 21:22:39 tg Exp $");
d2318 1
@


1.627
log
@Oh well this looks well, is done done, and gcc-snapshot doesnt complain:
 correct order of built-in commands; use POSIX special versus all others
  plus keeps assignments as distinction, no longer play POSIX regular vs.
  others game; sync manpage
 fix LP#1156707: map (( internally to let] which is no valid function
  name and so cant be overridden but is unlikely to be used otherwhere
  and not strictly permitted (by POSIX) anyway
 we do not need -Wno-overflow any more, either
 bump to R45
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.626 2013/04/26 19:40:07 tg Exp $'
d1534 1
a1534 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.626 2013/04/26 19:40:07 tg Exp $");
d2049 1
a2049 1
add_cppflags -DMKSH_BUILD_R=451
@


1.626
log
@now get rid of the run-time check, the idivwrapv nonsense, and straighten out lksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.625 2013/03/24 00:56:17 tg Exp $'
a1179 1
	ac_flags 0 wnooverflow -Wno-overflow
d1534 1
a1534 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.625 2013/03/24 00:56:17 tg Exp $");
a1849 1
test x1 = x$HAVE_CAN_WNOOVERFLOW && CFLAGS="$CFLAGS -Wno-overflow"
d2049 1
a2049 1
add_cppflags -DMKSH_BUILD_R=449
@


1.625
log
@ let mksh set -x print whole TCOM trees
 plug some memory leaks in debug (set -x) and warning paths while here
 one from Florian (friend of Natureshadow) for WTF
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.624 2013/03/05 15:41:39 tg Exp $'
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.624 2013/03/05 15:41:39 tg Exp $");
d1878 1
a1878 1
/* but the next two are; we REQUIRE signed integer wraparound */
a1879 5
#ifndef MKSH_GCC55009
cta(ari_sign_32_bit_and_wrap,
    (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 1) >
    (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 2));
#endif
d1892 2
a1902 1
#ifndef MKSH_GCC55009
d1905 1
a1905 4
#define NUM 21
#endif
#else
#define NUM 15
a1952 65
# runtime checks
# once this is more than one, check if we can do runtime
# checks (not cross-compiling) first to save on warnings
#
$e "${bi}run-time checks follow$ao, please ignore any weird errors"

if ac_testnnd silent_idivwrapv '' '(run-time) whether signed integer division overflows wrap silently' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	#if !defined(MKSH_LEGACY_MODE) || HAVE_LONG_32BIT
	#define IDIVWRAPV_VL	(mksh_uari_t)0x80000000UL
	#elif HAVE_LONG_64BIT
	#define IDIVWRAPV_VL	(mksh_uari_t)0x8000000000000000UL
	#else
	# error "cannot check this"
	#endif
	#ifdef SIGFPE
	static void fpe_catcher(int) MKSH_A_NORETURN;
	#endif
	int main(int ac, char **av) {
		mksh_ari_t o1, o2, r1, r2;

	#ifdef SIGFPE
		signal(SIGFPE, fpe_catcher);
	#endif
		o1 = (mksh_ari_t)IDIVWRAPV_VL;
		o2 = -ac;
		r1 = o1 / o2;
		r2 = o1 % o2;
		if (r1 == o1 && r2 == 0) {
			printf("si");
			return (0);
		}
		printf("no %d %d %d %d %s", (int)o1, (int)o2, (int)r1,
		    (int)r2, av[0]);
		return (1);
	}
	#ifdef SIGFPE
	static const char fpe_msg[] = "no, got SIGFPE, what were they smoking?";
	#define fpe_msglen (sizeof(fpe_msg) - 1)
	static void fpe_catcher(int sig MKSH_A_UNUSED) {
		_exit(write(1, fpe_msg, fpe_msglen) == fpe_msglen ? 2 : 3);
	}
	#endif
EOF
then
	if test $fv = 0; then
		echo "| hrm, compiling this failed, but we will just failback"
	else
		echo "| running test programme; this will fail if cross-compiling"
		echo "| in which case we will gracefully degrade to the default"
		./$tcfn >vv.out 2>&1
		rv=$?
		echo "| result: `cat vv.out`"
		fv=0
		test $rv = 0 && test x"`cat vv.out`" = x"si" && fv=1
	fi
	rmf conftest.c conftest.o ${tcfn}* vv.out
	ac_testdone
fi
ac_cppflags

$e "${bi}end of run-time checks$ao"

#
a2330 1
MKSH_GCC55009			DANGER! see http://www.mirbsd.org/mksh.htm#p41
@


1.624
log
@bump
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.623 2013/02/23 20:03:25 tg Exp $'
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.623 2013/02/23 20:03:25 tg Exp $");
d2123 1
a2123 1
add_cppflags -DMKSH_BUILD_R=441
@


1.623
log
@both mksh(1) and POSIX say: "$@@" should always generate multiple words
issue in pdksh reported in IRC by engla, thanks!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.622 2013/02/19 18:45:15 tg Exp $'
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.622 2013/02/19 18:45:15 tg Exp $");
d2123 1
a2123 1
add_cppflags -DMKSH_BUILD_R=440
@


1.622
log
@one more int  bool; mention set -o sh may (on raare OSes) be enabled
automatically (and it differs between targets); test MidnightBSD 0.1 ash
compat code and adjust the testsuite so it passes with it enabled
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.621 2013/02/18 22:55:35 tg Exp $'
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.621 2013/02/18 22:55:35 tg Exp $");
d2123 1
a2123 1
add_cppflags -DMKSH_BUILD_R=431
@


1.621
log
@put list of check_categories into Makefrag.inc generated; bump patchlevel
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.620 2013/02/17 07:06:15 tg Exp $'
d1391 3
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.620 2013/02/17 07:06:15 tg Exp $");
@


1.620
log
@revert cid 10050DD0C8519194AE9 and 100511FC81525949AF7
AT&T SVR4 broke 'cc -c -o foo.o foo.c' totally

switch to an alternative method of finding out the prototypes
provided in IRC by dalias (thanks); RT says this fixes his
issues on SVR4  lets just ignore the ominous message from
cid 1004713D70A5362BACF about needing to be a compile-time
check unless something else pops up, I cant think of something
that isnt already covered
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.619 2013/02/17 05:40:11 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.619 2013/02/17 05:40:11 tg Exp $");
d2120 1
a2120 1
add_cppflags -DMKSH_BUILD_R=430
d2288 1
@


1.619
log
@backpedal with $'' and $"" interpolation

it turns out this breaks more legacy scripts than anticipated
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.618 2013/02/16 17:55:51 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.618 2013/02/16 17:55:51 tg Exp $");
d1812 1
a1812 4
save_tcfn=$tcfn; save_CC=$CC; save_LDFLAGS=$LDFLAGS; save_LIBS=$LIBS
tcfn=conftest.o; CC="$CC -c -o $tcfn"; LDFLAGS=; LIBS=
rm -f conftest.o
ac_test '!' flock_decl flock 1 'if flock() does not need to be declared' <<-'EOF'
d1818 1
a1818 2
	long flock(void);		/* this clashes if defined before */
	int main(void) { return ((int)flock()); }
d1820 1
a1820 2
rm -f conftest.o
ac_test '!' revoke_decl revoke 1 'if revoke() does not need to be declared' <<-'EOF'
d1823 1
a1823 2
	long revoke(void);		/* this clashes if defined before */
	int main(void) { return ((int)revoke()); }
a1824 1
rm -f conftest.o
a1829 1
rm -f conftest.o
a1834 1
tcfn=$save_tcfn; CC=$save_CC; LDFLAGS=$save_LDFLAGS; LIBS=$save_LIBS
@


1.618
log
@SVR4 cc doesnt like -c -o conftest.o when conftest.o already exists:
it errors out with -o would overwrite conftest.o (thanks RT for reporting)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.617 2013/02/16 00:21:55 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.617 2013/02/16 00:21:55 tg Exp $");
d2129 1
a2129 1
add_cppflags -DMKSH_BUILD_R=429
@


1.617
log
@ I fsckd up and built R42b from MAIN ipv mksh-R42stable oh well.

TODO: convert enum to something like uint8_t to save even more space
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.616 2013/02/11 16:27:56 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.616 2013/02/11 16:27:56 tg Exp $");
d1814 1
d1824 1
d1831 1
d1837 1
@


1.616
log
@ test.sh now is -v (verbose) by default, new option -Q to quieten (like Build.sh)
 test.sh handles +P, +Q, +S, +v properly
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.615 2013/02/10 21:20:57 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.615 2013/02/10 21:20:57 tg Exp $");
d2125 1
a2125 1
add_cppflags -DMKSH_BUILD_R=419
@


1.616.2.1
log
@bump version
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.616 2013/02/11 16:27:56 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.616 2013/02/11 16:27:56 tg Exp $");
d2125 1
a2125 1
add_cppflags -DMKSH_BUILD_R=421
@


1.615
log
@doc update
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.614 2013/02/10 18:17:28 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.614 2013/02/10 18:17:28 tg Exp $");
d2147 2
a2148 2
	usee=0 Pflag=0 Sflag=0 uset=0 vflag=0 xflag=0
	while getopts "C:e:fPp:Ss:t:v" ch; do case \$ch {
d2153 1
d2155 2
d2158 1
d2162 1
d2290 1
a2290 1
#REGRESS_FLAGS=	-v
d2429 1
a2429 1
$ (sh Build.sh -r -c lto && ./test.sh -v) 2>&1 | tee log
@


1.614
log
@make DEBUG_LEAKS safely free all resources before the main shell exits
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.613 2013/01/12 02:25:01 tg Exp $'
d5 1
a5 1
#		2011, 2012
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.613 2013/01/12 02:25:01 tg Exp $");
d2383 1
a2383 1
DEBUG				enable debugging (want gcc), implies:
@


1.613
log
@Unbreak linking on AIX, reported (with fix) by Torsten Sillke, 10x!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.612 2013/01/01 21:19:36 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.612 2013/01/01 21:19:36 tg Exp $");
d2383 2
@


1.612
log
@if you have to look *this* up, danger ahead; point to porter's info
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.611 2012/12/28 04:58:13 tg Exp $'
d1263 1
a1263 1
	ac_flags 1 rtchkc -qextchk
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.611 2012/12/28 04:58:13 tg Exp $");
@


1.611
log
@carefully begin owcc (Watcom Cs POSIX cc wrapper) support
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.607 2012/12/28 02:28:29 tg Exp $'
d1532 1
a1532 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.607 2012/12/28 02:28:29 tg Exp $");
d2397 1
@


1.610
log
@RT says QNX 4 has _SIGMAX not SIGMAX or NSIG
@
text
@d1028 1
a1028 3
	echo >&2 'Warning: Watcom C Compiler detected. This compiler has not yet
    been tested for compatibility with mksh. Continue at your
    own risk, please report success/failure to the developers.'
d1133 3
@


1.609
log
@now that we found out the root case for the recent QNX problem
03:11RT|AO:#!/bin/mksh YES it WORKS now!
 theres no reason for sys_nerr to not be const, either 
@
text
@d2063 2
@


1.608
log
@AIEEE!
03:00RT|AO:#!/bin/mksh cc -c -o a.out does not output a.out but conftest.o (!!)
evil just use tcfn=conftest.o for now, cf. cid 1004713D70A5362BACF (but why must it be one?)
@
text
@d1569 1
a1569 1
	extern int sys_nerr;
d1574 1
a1574 1
	extern int _sys_nerr;
@


1.607
log
@harmonise sys_{sig,err}list  checks,  uses,  _decl values when not needed,  prototypes;  const is a keyword and thus space-separated from the preceding * pointer indicator
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.606 2012/12/27 15:52:47 tg Exp $'
d1531 1
a1531 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.606 2012/12/27 15:52:47 tg Exp $");
d1811 2
a1812 2
save_CC=$CC; save_LDFLAGS=$LDFLAGS; save_LIBS=$LIBS
CC="$CC -c -o $tcfn"; LDFLAGS=; LIBS=
d1838 1
a1838 1
CC=$save_CC; LDFLAGS=$save_LDFLAGS; LIBS=$save_LIBS
@


1.606
log
@-D__EXT_UNIX_MISC needed for extern const char * const sys_errlist[]; on QNX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.605 2012/12/24 17:50:10 tg Exp $'
d1531 1
a1531 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.605 2012/12/24 17:50:10 tg Exp $");
d1570 1
a1570 1
	extern char *sys_errlist[];
d1575 1
a1575 1
	extern char *_sys_errlist[];
d1588 1
a1588 1
		extern const char *const sys_sig${what}[];
d1592 1
a1592 1
		extern const char *const _sys_sig${what}[];
d1833 1
a1833 1
ac_test sys_siglist_decl sys_siglist 1 'for declaration of sys_siglist[]' <<-'EOF'
@


1.605
log
@16:39RT|Chatzilla:#!/bin/mksh ok, tested cc -E outputs preprocessed out with leading space(!).
16:49<mirabilos:#!/bin/mksh> that's like NeXTstep which insers spaces around =
16:49<mirabilos:#!/bin/mksh> but we can sed that away I guess.
16:49RT|Chatzilla:#!/bin/mksh yeah, modifying grep/sed lines adding " *" works
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.604 2012/12/22 00:03:37 tg Exp $'
d699 1
d1531 1
a1531 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.604 2012/12/22 00:03:37 tg Exp $");
@


1.604
log
@gcc-snapshot (see below) issued a clobber warning, and both it and mgcc
yowled about the memmove test until I found a compromise
gcc version 4.8.0 20121120 (experimental) [trunk revision 193662] (Debian 20121120-1)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.603 2012/12/17 23:31:30 tg Exp $'
d893 1
a893 1
    sed -n '/^[ce]t *= */s/\([ce]t\) *= */\1=/p' | tr -d \\\\015 >x"
d1530 1
a1530 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.603 2012/12/17 23:31:30 tg Exp $");
d2069 2
a2070 2
	    grep '^mksh_cfg *=' | \
	    sed 's/^mksh_cfg *=[	 ]*\([()0-9x+-][()0-9x+	 -]*\).*$/\1/'`
d2099 2
a2100 2
		    grep '^mksh_cfg *=' | \
		    sed 's/^mksh_cfg *=[	 ]*\([0-9][0-9x]*\).*$/:\1 '$name/
@


1.603
log
@now we can actually prefer sys_errlist[] (oh, and _sys_errlist[] also exists, and fix a pasto) over strerror(3) like we do for sys_siglist[] and strsignal(3); our implementation is smaller and does more code reuse than even MirBSD libcs after all
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.600 2012/12/17 22:14:24 tg Exp $'
d1530 1
a1530 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.600 2012/12/17 22:14:24 tg Exp $");
d1647 2
d1654 1
a1654 1
		return ((int)memmove(av[0], av[1], ac));
@


1.602
log
@thanks to ISC (Interactive) Unix, we now know a few samples of errnos
that get used, plus one for the realpath-1 regression test; also make
sys_siglist_decl detection nicer and poison strerror() with non-const
return value ifdef DEBUG, make it always const
@
text
@d1563 1
a1563 1
# Environment: signals
d1567 17
a1601 6
ac_test strsignal '!' sys_siglist 0 <<-'EOF'
	#include <string.h>
	#include <signal.h>
	int main(void) { return (strsignal(1)[0]); }
EOF

d1788 1
a1788 1
ac_test strerror <<-'EOF'
d1793 4
a1796 4
ac_test sys_errlist '!' strerror 0 "the sys_signame[] array and sys_nerr" <<-'EOF'
	extern int sys_nerr;
	extern char *sys_errlist[];
	int main(void) { return (*sys_errlist[sys_nerr - 1]); }
@


1.601
log
@fix whitespace; ACK RTs Minix-vmd stmts
@
text
@d1782 6
d1814 6
a1819 1
ac_test '!' sys_siglist_decl sys_siglist 1 'if sys_siglist[] does not need to be declared' <<-'EOF'
d1822 1
a1822 2
	extern int sys_siglist[5][5][5][5][5];	/* this clashes happily */
	int main(void) { return (sys_siglist[0][0][0][0][0]); }
@


1.600
log
@RT also said what was missing on SunOS 4.1.1 (it also needs -DMKSH_UNEMPLOYED?)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.599 2012/12/17 21:55:04 tg Exp $'
a621 1
	#XXX @@RT: really?
a624 3
	#XXX added from Minix3; RT didn't use this, why?
	add_cppflags -DMKSH_NO_LIMITS
	#XXX why the deviation from Minix3?
a625 1
	#XXX two copied from Minix3
d1530 1
a1530 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.599 2012/12/17 21:55:04 tg Exp $");
@


1.599
log
@merge/genericise RTs port to Minix-vmd
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.598 2012/12/05 19:38:05 tg Exp $'
d1307 4
d1535 1
a1535 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.598 2012/12/05 19:38:05 tg Exp $");
d1640 10
d1782 5
@


1.598
log
@add -fno-asynchronous-unwind-tables for all GCC builds, as suggested by dalias and chris2
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.597 2012/12/03 22:10:02 tg Exp $'
d273 15
a287 1
		echo "#include <$i>" >>x
d621 13
d1394 9
d1408 1
d1470 4
d1475 4
d1480 1
d1531 1
a1531 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.597 2012/12/03 22:10:02 tg Exp $");
d1690 1
d1692 6
@


1.597
log
@revert cid 100506499941EC578A6: musl has _ALL_SOURCE now, aliased to
_GNU_SOURCE which we already define for convenience; thanks to dalias
and chris2 on IRC for discussion and being accomodating!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.596 2012/12/03 13:07:11 tg Exp $'
d1157 2
d1485 1
a1485 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.596 2012/12/03 13:07:11 tg Exp $");
@


1.596
log
@how many times can you botch a gettimeofday mirtoconf check?
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.595 2012/12/01 14:22:09 tg Exp $'
a596 1
	*/musl-gcc*) add_cppflags -D_GNU_SOURCE -D_BSD_SOURCE ;;
d1483 1
a1483 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.595 2012/12/01 14:22:09 tg Exp $");
@


1.595
log
@catch MSYS dash printf builtin not working
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.594 2012/12/01 01:36:16 tg Exp $'
d1484 1
a1484 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.594 2012/12/01 01:36:16 tg Exp $");
d1581 1
a1581 1
	int main(void) { struct timeval; return (gettimeofday(&tv, NULL)); }
@


1.594
log
@remove *all* nonnull assertions and other workarounds for clang scan-build

this beast evolved in the last 2 years, and weve had trouble with
some of them earlier
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.593 2012/11/30 22:17:32 tg Exp $'
d1484 1
a1484 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.593 2012/11/30 22:17:32 tg Exp $");
d1986 1
@


1.593
log
@fix null argument where non-null required warning
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.592 2012/11/30 20:49:16 tg Exp $'
a1296 14
ac_test attribute_nonnull '' 'for __attribute__((__nonnull__))' <<-'EOF'
	#if defined(__TenDRA__) || (defined(__GNUC__) && (__GNUC__ < 2))
	/* force a failure: TenDRA and gcc 1.42 have false positive here */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	int foo(char *s1, char *s2) __attribute__((__nonnull__));
	int bar(char *s1, char *s2) __attribute__((__nonnull__ (1, 2)));
	int baz(char *s) __attribute__((__nonnull__ (1)));
	int foo(char *s1, char *s2) { return (bar(s2, s1)); }
	int bar(char *s1, char *s2) { return (baz(s1) - baz(s2)); }
	int baz(char *s) { return (*s); }
	int main(int ac, char **av) { return (ac == foo(av[0], av[ac-1])); }
	#endif
EOF
d1484 1
a1484 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.592 2012/11/30 20:49:16 tg Exp $");
@


1.592
log
@regenerate Makefiles
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590 2012/11/20 18:50:41 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590 2012/11/20 18:50:41 tg Exp $");
d1595 1
a1595 1
	int main(void) { return (gettimeofday(NULL, NULL)); }
@


1.591
log
@MKSH_DISABLE_EXPERIMENTAL is a NOP again; use ${precmd;} in dot.mkshrc
@
text
@d2043 1
a2043 1
add_cppflags -DMKSH_BUILD_R=409
@


1.590
log
@RT tells me Minix 2 (i386) also doesnt have gettimeofday(2)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.589 2012/10/22 20:19:08 tg Exp $'
d1373 3
a1375 3
ac_ifcpp 'ifdef MKSH_DISABLE_EXPERIMENTAL' isset_MKSH_DISABLE_EXPERIMENTAL '' \
    "if experimental features are to be omitted" && \
    check_categories="$check_categories noexperimental"
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.589 2012/10/22 20:19:08 tg Exp $");
@


1.590.2.1
log
@regenerate Makefiles
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590 2012/11/20 18:50:41 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590 2012/11/20 18:50:41 tg Exp $");
d2043 1
a2043 1
add_cppflags -DMKSH_BUILD_R=411
@


1.590.2.2
log
@fix null argument where non-null required warning
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.1 2012/11/30 20:49:10 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.1 2012/11/30 20:49:10 tg Exp $");
d1595 1
a1595 1
	int main(void) { struct timeval; return (gettimeofday(&tv, NULL)); }
@


1.590.2.3
log
@catch MSYS dash printf builtin not working
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.2 2012/11/30 22:17:34 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.2 2012/11/30 22:17:34 tg Exp $");
a1999 1
	test $printf = echo || test "`printf %d 42`" = 42 || printf=echo
@


1.590.2.4
log
@how many times can you botch a gettimeofday mirtoconf check?
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.3 2012/12/01 14:22:12 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.3 2012/12/01 14:22:12 tg Exp $");
d1595 1
a1595 1
	int main(void) { struct timeval tv; return (gettimeofday(&tv, NULL)); }
@


1.590.2.5
log
@revert cid 100506499941EC578A6: musl has _ALL_SOURCE now, aliased to
_GNU_SOURCE which we already define for convenience; thanks to dalias
and chris2 on IRC for discussion and being accomodating!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.4 2012/12/03 13:07:13 tg Exp $'
d597 1
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.4 2012/12/03 13:07:13 tg Exp $");
@


1.590.2.6
log
@MFC the LLVM+Clang scan-build fixes: cid 10050B95F03690E9DEE 10050BD4DA30C3ED2E7 10050BD4DCC1620D535 10050BD4E043FF1DB7C 10050BD4F7642624FD1
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.5 2012/12/03 22:10:04 tg Exp $'
d1296 14
d1497 1
a1497 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.5 2012/12/03 22:10:04 tg Exp $");
@


1.590.2.7
log
@MFC todays batch of build/warning fixes: cid 10050BF986807E3B0C1 10050BFA2B54D772FB3 10050BFA2C0046FB3B9
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.6 2012/12/04 01:26:12 tg Exp $'
a1156 2
	# mksh is not written in CFrustFrust!
	ac_flags 1 no_eh_frame -fno-asynchronous-unwind-tables
d1483 1
a1483 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.6 2012/12/04 01:26:12 tg Exp $");
@


1.590.2.8
log
@MFC all bugfixes and most portability fixes (but not changes / new targets)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.7 2012/12/05 19:58:23 tg Exp $'
d273 1
a273 15
		case $i in
		_time)
			echo '#if HAVE_BOTH_TIME_H' >>x
			echo '#include <sys/time.h>' >>x
			echo '#include <time.h>' >>x
			echo '#elif HAVE_SYS_TIME_H' >>x
			echo '#include <sys/time.h>' >>x
			echo '#elif HAVE_TIME_H' >>x
			echo '#include <time.h>' >>x
			echo '#endif' >>x
			;;
		*)
			echo "#include <$i>" >>x
			;;
		esac
a676 1
	add_cppflags -D__EXT_UNIX_MISC
d871 1
a871 1
    sed -n '/^ *[ce]t *= */s/^ *\([ce]t\) *= */\1=/p' | tr -d \\\\015 >x"
a1111 3
elif test $ct = watcom; then
	save_NOWARN=
	DOWARN=-Wc,-we
a1279 4
		/*
		 * if memmove does not exist, we are not on a system
		 * with GCC with __bounded__ attribute either so poo
		 */
a1366 9
ac_header sys/time.h sys/types.h
ac_header time.h sys/types.h
test "11" = "$HAVE_SYS_TIME_H$HAVE_TIME_H" || HAVE_BOTH_TIME_H=0
ac_test both_time_h '' 'whether <sys/time.h> and <time.h> can both be included' <<-'EOF'
	#include <sys/types.h>
	#include <sys/time.h>
	#include <time.h>
	int main(void) { struct tm tm; return ((int)sizeof(tm)); }
EOF
a1371 1
ac_header sys/resource.h sys/types.h _time
a1432 4
	#if HAVE_BOTH_TIME_H
	#include <sys/time.h>
	#include <time.h>
	#elif HAVE_SYS_TIME_H
a1433 4
	#elif HAVE_TIME_H
	#include <time.h>
	#endif
	#if HAVE_SYS_RESOURCE_H
a1434 1
	#endif
d1485 1
a1485 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.7 2012/12/05 19:58:23 tg Exp $");
a1589 12
ac_test memmove <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	#include <string.h>
	#if HAVE_STRINGS_H
	#include <strings.h>
	#endif
	int main(int ac, char *av[]) {
		return (*(int *)(void *)memmove(av[0], av[1], ac));
	}
EOF

a1643 1
	#if HAVE_BOTH_TIME_H
a1644 6
	#include <time.h>
	#elif HAVE_SYS_TIME_H
	#include <sys/time.h>
	#elif HAVE_TIME_H
	#include <time.h>
	#endif
d1724 2
a1725 2
save_tcfn=$tcfn; save_CC=$CC; save_LDFLAGS=$LDFLAGS; save_LIBS=$LIBS
tcfn=conftest.o; CC="$CC -c -o $tcfn"; LDFLAGS=; LIBS=
d1747 1
a1747 1
tcfn=$save_tcfn; CC=$save_CC; LDFLAGS=$save_LDFLAGS; LIBS=$save_LIBS
a1971 2
#elif defined(_SIGMAX)
#define NSIG (_SIGMAX+1)
d1979 2
a1980 2
	    grep '^ *mksh_cfg *=' | \
	    sed 's/^ *mksh_cfg *=[	 ]*\([()0-9x+-][()0-9x+	 -]*\).*$/\1/'`
d2009 2
a2010 2
		    grep '^ *mksh_cfg *=' | \
		    sed 's/^ *mksh_cfg *=[	 ]*\([0-9][0-9x]*\).*$/:\1 '$name/
a2302 1
MKSH_GCC55009			DANGER! see http://www.mirbsd.org/mksh.htm#p41
@


1.590.2.9
log
@Unbreak linking on AIX, reported (with fix) by Torsten Sillke, 10x!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.8 2013/01/01 21:19:53 tg Exp $'
d1257 1
a1257 1
	#ac_flags 1 rtchkc -qextchk	# reported broken
d1526 1
a1526 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.8 2013/01/01 21:19:53 tg Exp $");
@


1.590.2.10
log
@reduce diff against mksh-R41

http://thread.gmane.org/gmane.comp.version-control.bazaar-ng.general/74809
learned me to release more often again, so Im keeping the bugfixes here
to a minimum and will instead release an R42 more quickly with those fixes
harder to backport or less necessary (such as ports to ancient Unics)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.590.2.9 2013/01/12 02:25:05 tg Exp $'
d1298 4
d1526 1
a1526 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.590.2.9 2013/01/12 02:25:05 tg Exp $");
@


1.589
log
@bring back ${ foo;} sans dot.mkshrc patch, using a temporary file, and as experimental feature
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.587 2012/10/21 17:38:21 tg Exp $'
d1498 1
a1498 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.587 2012/10/21 17:38:21 tg Exp $");
d1592 6
@


1.588
log
@introduce MKSH_DISABLE_EXPERIMENTAL and wrap the new feature introduced
in cid 1005084678C510CF7E4 in it
@
text
@d1373 3
@


1.587
log
@this is now http://gcc.gnu.org/bugzilla/show_bug.cgi?id=55009
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.586 2012/10/14 14:02:10 tg Exp $'
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.586 2012/10/14 14:02:10 tg Exp $");
d2303 1
@


1.586
log
@fix detection of penguin flocks
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.585 2012/10/03 17:24:13 tg Exp $'
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.585 2012/10/03 17:24:13 tg Exp $");
d1794 1
a1794 1
#ifndef MKSH_GCC565048
d1820 1
a1820 1
#ifndef MKSH_GCC565048
@


1.585
log
@even more hacks to pass -O666 -fstrict-overflow -Wstrict-overflow=9 -flto=jobserver with gcc version 4.8.0 20120930 (experimental) [trunk revision 191865] (Debian 20120930-1)  plus make the rtchecks mandatory
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.584 2012/09/28 18:57:49 tg Exp $'
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.584 2012/09/28 18:57:49 tg Exp $");
d1560 1
d1563 3
d1733 3
@


1.584
log
@make char_is_8_bits assertion more anal
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.583 2012/09/27 18:23:43 tg Exp $'
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.583 2012/09/27 18:23:43 tg Exp $");
d1787 1
d1791 1
d1812 11
a1822 1
	int main(void) { return (sizeof(struct ctasserts)); }
@


1.583
log
@add workaround for musl (define _BSD_SOURCE as well) which is even *more*
ugly than the one for dietlibc (the other one misunderstanding the *real*
meaning of that flag), by $CC divining, until such time as all the Linux
C libraries will honour _ALL_SOURCE (I wish)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.582 2012/09/18 14:18:59 tg Exp $'
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.582 2012/09/18 14:18:59 tg Exp $");
d1770 2
a1771 1
cta(char_is_8_bits, (CHAR_BIT) == 8);
@


1.582
log
@detect zsh 2.5.02 as found on NeXTstep 3.3; thanks to ft (Frank Terbeck) and chris2 (Christian Neukirchen)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.581 2012/08/24 19:09:09 tg Exp $'
d597 1
d1495 1
a1495 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.581 2012/08/24 19:09:09 tg Exp $");
@


1.581
log
@allow overriding /etc location (LP#1039713), but dont do it
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.580 2012/08/03 18:16:43 tg Exp $'
d31 4
d1494 1
a1494 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.580 2012/08/03 18:16:43 tg Exp $");
@


1.580
log
@add -D_DARWIN_C_SOURCE on OSX; should help bsiegert@@s problem
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.579 2012/07/01 15:54:49 tg Exp $'
d1490 1
a1490 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.579 2012/07/01 15:54:49 tg Exp $");
d2275 1
@


1.579
log
@lesson learned from http://k1024.org/~iusty/blog/entry/perf-null/  add -DMKSH_SMALL_BUT_FAST which gives more speed (8/20K less cycles, 5/9K less insns, 1.8/2.4k less branches, 65/275 less branch misses) on Debian/amd64 (klibc-static/eglibc) at cost of 0/2 more page faults and 6K/6K more text size
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.577 2012/06/28 20:17:33 tg Exp $'
d549 1
d1490 1
a1490 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.577 2012/06/28 20:17:33 tg Exp $");
@


1.578
log
@-L implies convfds now
@
text
@d2288 1
@


1.578.2.1
log
@add patch from 40.9.20120630-3ubuntu1 (LP#1058035)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.578+ubuntu1 2012/07/01 15:51:24 tg Exp $'
d1489 1
a1489 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.578 2012/07/01 15:51:24 tg Exp $");
d1775 1
a1775 1
#if !defined(MKSH_LEGACY_MODE) && !defined(MKSH_GCC565048)
@


1.577
log
@(mksh) tighten 32-bit requirements; (lksh) switch to long; allow any bitness
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.576 2012/06/26 19:33:29 tg Exp $'
d417 1
d1489 1
a1489 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.576 2012/06/26 19:33:29 tg Exp $");
@


1.576
log
@mh all Im gonna hack on upstream today fix -t for manpage generation and cleanup code snippets; bump vsn; sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.575 2012/06/26 19:15:11 tg Exp $'
d412 1
a412 1
	check_categories="$check_categories shell:legacy-no"
d1488 1
a1488 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.575 2012/06/26 19:15:11 tg Exp $");
d1755 3
d1763 1
d1772 1
d1774 1
d1777 1
a1777 2
/* but the next three are; we REQUIRE signed integer wraparound */
cta(ari_is_signed, (mksh_ari_t)-1 < (mksh_ari_t)0);
d1784 1
a1784 2
/* but the next four are; we REQUIRE unsigned integer wraparound */
cta(uari_is_unsigned, (mksh_uari_t)-1 > (mksh_uari_t)0);
d1790 4
d1808 39
d1856 7
d1872 1
a1872 1
		o1 = ((mksh_ari_t)1 << 31);
d2088 1
d2093 1
@


1.575
log
@one more thing to implicitly disable (nonsensical anyway) for lksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.574 2012/06/25 16:05:06 tg Exp $'
d61 3
a63 3
		case ${_f} in
		mksh.1) ;;
		*) rm -f "${_f}" ;;
d442 1
a442 1
ccpr='|| for _f in ${tcfn}*; do test x"${_f}" = x"mksh.1" || rm -f "${_f}"; done'
d1488 1
a1488 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.574 2012/06/25 16:05:06 tg Exp $");
d2158 2
a2159 2
test 1 = $r || v "$NROFF -mdoc <'$srcdir/mksh.1' >mksh.cat1" || \
    rmf mksh.cat1
d2171 3
a2173 3
if test -f mksh.cat1; then
	$e "# $i -c -o root -g bin -m 444 mksh.cat1" \
	    "/usr/share/man/cat1/mksh.0"
d2176 1
a2176 1
$e "# $i -c -o root -g bin -m 444 mksh.1 /usr/share/man/man1/mksh.1"
@


1.574
log
@add basic LEGACY KSH mode (Build.sh -L), no changes yet
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.573 2012/06/24 20:47:07 tg Exp $'
d416 1
d1488 1
a1488 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.573 2012/06/24 20:47:07 tg Exp $");
@


1.573
log
@define $tfn default late (for Things To Come)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.572 2012/06/24 20:46:07 tg Exp $'
d319 1
d351 6
d395 5
a399 1
test -z "$tfn" && tfn=mksh
d407 10
a416 2
SRCS="lalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
SRCS="$SRCS jobs.c lex.c main.c misc.c shf.c syn.c tree.c var.c"
d1487 1
a1487 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.572 2012/06/24 20:46:07 tg Exp $");
@


1.572
log
@new option -t (target shell filename)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.571 2012/05/18 01:38:04 tg Exp $'
d318 1
a318 1
tfn=mksh
d388 1
d1468 1
a1468 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.571 2012/05/18 01:38:04 tg Exp $");
@


1.571
log
@RT says: libc5 uses __inline__ for its inline stuff, but lcc doesn't support __inline__ but __inline
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.570 2012/05/17 19:36:41 tg Exp $'
a305 7
if test -d mksh || test -d mksh.exe; then
	echo "$me: Error: ./mksh is a directory!" >&2
	exit 1
fi
rmf a.exe* a.out* conftest.c *core core.* lft mksh* no *.bc *.ll *.o \
    Rebuild.sh signames.inc test.sh x vv.out

d318 1
d335 4
d365 3
d388 7
d1467 1
a1467 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.570 2012/05/17 19:36:41 tg Exp $");
d1473 3
a1475 3
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
d1481 3
a1483 3
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
d1940 2
a1941 2
a.exe)	mkshexe=mksh.exe ;;
*)	mkshexe=mksh ;;
d2049 3
a2051 3
	echo "rm -f mksh.s" >>Rebuild.sh
	echo "llvm-link -o - $objs | opt $optflags | llc -o mksh.s" >>Rebuild.sh
	lobjs=mksh.s
d2130 2
a2131 2
	rmf mksh.s
	v "llvm-link -o - $objs | opt $optflags | llc -o mksh.s"
d2145 2
a2146 2
$e "# $i -c -s -o root -g bin -m 555 mksh /bin/mksh"
$e "# grep -x /bin/mksh /etc/shells >/dev/null || echo /bin/mksh >>/etc/shells"
@


1.570
log
@check whether klibc sigsuspend() is usable: RT or hpas two new methods; if not, deactivate it
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.569 2012/05/17 19:14:07 tg Exp $'
d897 4
d1459 1
a1459 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.569 2012/05/17 19:14:07 tg Exp $");
@


1.569
log
@add a way to detect varying C libraries or other stuff extra type
(for now klibc) alongside compiler type

if klibc, add -DMKSH_NO_LIMITS automatically
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.568 2012/05/17 18:54:28 tg Exp $'
d1455 1
a1455 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.568 2012/05/17 18:54:28 tg Exp $");
d1643 32
@


1.568
log
@recognise (but dont do anything with, yet) lcc (from RT)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.567 2012/05/09 23:20:42 tg Exp $'
d825 7
d834 3
a836 1
vv ']' "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c | sed -n '/^ct *= */s//ct=/p' | tr -d \\\\015 >x"
d988 13
a1000 1
$e "$bi==> which compiler seems to be used...$ao $ui$ct$ao"
d1455 1
a1455 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.567 2012/05/09 23:20:42 tg Exp $");
@


1.567
log
@RT says not using sigsuspend helps Syllable (but is still buggy, see http://forum.syllable.org/viewtopic.php?p=8171 and probably (doesnt work for me) http://pyro-os.org/?section=Forum&forum=Bugs&zpbw_postKey=NUgSMp85XGHKbF751zJ6Ww which show the bug affects all shells)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.566 2012/05/07 17:03:03 tg Exp $'
d819 2
d1434 1
a1434 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.566 2012/05/07 17:03:03 tg Exp $");
@


1.566
log
@ sync clog
 write more notes on klibc, BeOS, Coherent, PW32, Syllable, Xenix
 sort DOS OE section to where it belongs
 add TARGET_OS=_svr4 for Dell UNIX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.565 2012/05/06 15:40:31 tg Exp $'
d675 1
d1432 1
a1432 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.565 2012/05/06 15:40:31 tg Exp $");
@


1.565
log
@overhaul the grep(1)s and sed(1)s  see re_format(7)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.564 2012/05/05 17:37:42 tg Exp $'
d696 6
d1431 1
a1431 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.564 2012/05/05 17:37:42 tg Exp $");
@


1.564
log
@sprinkle CONSERVATIVE_FDS for many older OSes; DISABLE_TTY_WARNING for BeOS and Coherent (probably more to come); NO_CMDLINE_EDITING to Plan 9; put Hurd NO_PATH_MAX into MKSH__ private namespace
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.563 2012/05/04 22:34:49 tg Exp $'
d315 1
a315 1
dstversion=`sed -n '/define MKSH_VERSION/s/^.*"\(.*\)".*$/\1/p' $srcdir/sh.h`
d467 3
a469 1
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`hostinfo 2>&1 | grep 'NeXT Mach [0-9.]*:' | sed 's/^.*NeXT Mach \([0-9.]*\):.*$/\1/'`
d1425 1
a1425 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.563 2012/05/04 22:34:49 tg Exp $");
d1807 2
a1808 2
	    grep '^mksh_cfg *=[	 ]*[0-9x ()+-]*.*$' | \
	    sed 's/^mksh_cfg *=[	 ]*\([0-9x ()+-][0-9x	 ()+-]*\).*$/\1/'`
d1810 1
d1822 2
a1823 2
	    grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
	    sed 's/^\(.*[	 ]SIG\)\([A-Z0-9]*\)\([	 ].*\)$/\2/' | sort`
d1836 3
a1838 3
		    grep '^mksh_cfg *=[	 ]*[0-9x]*.*$' | \
		    sed 's/^mksh_cfg *=[	 ]*\([0-9x]*\).*$/\1:'$name/
	done | sed -e '/^:/d' -e 's/:/ /g' | while read nr name; do
d1957 1
a1957 1
echo "# work around NeXTstep bug" >Rebuild.sh
@


1.563
log
@new MKSH_DISABLE_TTY_WARNING for ports that just cant help it

TODO: add_cppflags this automatically in the TARGET_OS switch for some
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.554 2012/05/04 21:28:06 tg Exp $'
d480 1
d498 1
d510 2
d525 1
d533 2
a534 2
	# define NO_PATH_MAX to use Hurd-only functions
	add_cppflags -DNO_PATH_MAX
d602 1
d629 1
d661 1
d678 1
d683 1
d1423 1
a1423 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.554 2012/05/04 21:28:06 tg Exp $");
@


1.562
log
@last parts of Coherent patchkit: O_ACCMODE and termio
@
text
@d2111 1
@


1.561
log
@more symlink(7) nonexistence support code
@
text
@d1310 1
@


1.560
log
@generalise the skipping sete{u,g}id() case for Coherent, not just BeOS
@
text
@d505 1
@


1.559
log
@introduce a nosymlink check category (idea by RT); pass it to test.sh; use cp if ln -s fails (me)
@
text
@d497 2
d506 1
@


1.558
log
@do not use $(uname -s || uname) as TARGET_OS if its the same as $(uname -n), to weave around many ancient unics; idea discussed with RT
@
text
@d501 4
@


1.557
log
@another awk(1) compatibility fix from RT
@
text
@d401 5
a405 2
test x"$TARGET_OS" = x"" && TARGET_OS=`uname -s 2>/dev/null || uname`
if test x"$TARGET_OS" = x""; then
@


1.556
log
@RT points out there may be a tab inside the NSIG expansion
@
text
@d1786 1
a1786 1
	*[\ \(\)+-]*) NSIG=`"$AWK" "BEGIN { print $NSIG }"` ;;
@


1.555
log
@fix copy/paste accident; found by RT
@
text
@d1784 1
a1784 1
	    sed 's/^mksh_cfg *=[	 ]*\([0-9x ()+-]*\).*$/\1/'`
@


1.554
log
@patch test.sh to support check.t split into multiple chunks
which is apparently needed on Coherent due to OS limits

inspired by a patched test.sh from RT, except I require a
dot before the sequence number for easier globbing, made
the splitting use -S, and the errorlevel is more correct
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.553 2012/05/04 20:49:00 tg Exp $'
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.553 2012/05/04 20:49:00 tg Exp $");
d1783 1
a1783 1
	    grep '^mksh_cfg *=[	 ]*\([0-9x ()+-]*\).*$' | \
d1811 1
a1811 1
		    grep '^mksh_cfg *=[	 ]*\([0-9x]*\).*$' | \
@


1.553
log
@new MKSH_NO_CMDLINE_EDITING to disable command line editing in its entirety

mainly for the Plan 9 port though it may also help the WinAPI variant,
other porting efforts, as well as a new project I cannot say yet
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.552 2012/04/27 16:16:19 tg Exp $'
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.552 2012/04/27 16:16:19 tg Exp $");
d1855 2
a1856 2
	usee=0 Pflag=0 uset=0 vflag=0 xflag=0
	while getopts "C:e:fPp:s:t:v" ch; do case \$ch {
d1862 1
d1870 1
a1870 1
	set -A args -- '$srcdir/check.pl' -p "\$pflag" -s "\$sflag"
d1891 1
a1891 2
	fgrep MirOS: '$srcdir/check.t'
	fgrep MIRBSD '$srcdir/check.t'
d1914 9
a1922 1
	exec \$perli "\${args[@@]}" "\$@@"$tsts
@


1.552
log
@add experimental code to use sigprocmask+pause+sigprocmask ipv sigsuspend (and harden j_sigchld handler for that) to improve working on BeOS 5.0 and Coherent UNIX, found by RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.551 2012/04/16 17:49:40 tg Exp $'
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.551 2012/04/16 17:49:40 tg Exp $");
d2095 1
@


1.551
log
@work around segfault bug in GNU sed 2.03, spotted by RT on Debian 0.91
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.550 2012/04/14 19:35:43 tg Exp $'
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.550 2012/04/14 19:35:43 tg Exp $");
d2099 1
@


1.550
log
@write a bit about pcc, 386BSD, klibc
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.549 2012/04/14 16:07:43 tg Exp $'
d464 1
a464 1
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`hostinfo 2>&1 | sed -n '/^.*NeXT Mach \([0-9.]*\):.*$/s//\1/p'`
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.549 2012/04/14 16:07:43 tg Exp $");
d1781 1
d1783 2
a1784 1
	    sed -n '/^mksh_cfg *=[	 ]*\([0-9x ()+-]*\).*$/s//\1/p'`
d1809 1
d1811 2
a1812 1
		    sed -n '/^mksh_cfg *=[	 ]*\([0-9x]*\).*$/s//\1:'$name/p
@


1.549
log
@rewrite maketemp() obsoleting tempnam(3) and mkstemp(3) external deps
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.548 2012/04/14 14:11:07 tg Exp $'
a473 4
	# required fixes for 386BSD-0.0new are:
	# http://groups.google.com/group/comp.unix.bsd/browse_thread/thread/1c6397039f10e76b?hl=en
	# http://groups.google.com/group/comp.unix.bsd/browse_thread/thread/cb899f7ccb81550b?hl=en
	# from 386BSD-0.1 on, it works out of the box
d1401 1
a1401 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.548 2012/04/14 14:11:07 tg Exp $");
@


1.548
log
@add 386BSD, thanks to the unbelievable RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.546 2012/04/14 14:04:13 tg Exp $'
d1405 1
a1405 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.546 2012/04/14 14:04:13 tg Exp $");
a1510 6
ac_test mkstemp <<-'EOF'
	#include <stdlib.h>
	#include <unistd.h>
	int main(void) { char tmpl[] = "X"; return (mkstemp(tmpl)); }
EOF

d2100 1
a2100 1
MKSH_S_NOVI			disable Vi editing mode (default if MKSH_SMALL)
@


1.547
log
@genericise MKSH_NO_SIGSETJMP
@
text
@d473 9
@


1.546
log
@sometimes <stdlib.h> doesnt provide NULL but <stddef.h> does (386BSD)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.545 2012/04/14 14:02:39 tg Exp $'
d572 1
d1396 1
a1396 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.545 2012/04/14 14:02:39 tg Exp $");
d2095 1
@


1.545
log
@if the OS does not provide sig_atomic_t and/or ssize_t, you can now define
MKSH_TYPEDEF_SIG_ATOMIC_T and MKSH_TYPEDEF_SSIZE_T via CPPFLAGS to the
*correct* definitions (its absolutely critical they be correct!)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.544 2012/04/08 20:02:33 tg Exp $'
d1395 1
a1395 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.544 2012/04/08 20:02:33 tg Exp $");
d1515 1
@


1.544
log
@make -fwrapv common; at least clang also can do it
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.543 2012/04/07 11:19:45 tg Exp $'
d652 1
a652 1
	add_cppflags -Dssize_t=int
d1395 1
a1395 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.543 2012/04/07 11:19:45 tg Exp $");
d2095 2
@


1.543
log
@drop all deprecated code, you have been warned
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.542 2012/04/06 23:10:50 tg Exp $'
a1060 1
	ac_flags 1 fwrapv -fwrapv
d1157 1
d1395 1
a1395 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.542 2012/04/06 23:10:50 tg Exp $");
@


1.542
log
@cant forget LynxOS, although its still preliminary
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.541 2012/04/06 15:20:41 tg Exp $'
d1271 3
a1273 3
ac_ifcpp 'ifdef MKSH_DISABLE_DEPRECATED' isset_MKSH_DISABLE_DEPRECATED '' \
    "if deprecated features are to be omitted" && \
    check_categories="$check_categories nodeprecated"
d1395 1
a1395 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.541 2012/04/06 15:20:41 tg Exp $");
@


1.541
log
@if LDSTATIC is not empty (i.e. "-static" or " "), always add our sources:
 strlcpy
 utf_wcwidth
note strchr/strstr from misc.c are still #ifdef DEBUG only, as they are
not eligible: theyre for const-cleanliness debugging purposes

XXX get rid of multiple occurrences of binary search code, too
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.539 2012/04/06 13:25:51 tg Exp $'
d544 3
d1395 1
a1395 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.539 2012/04/06 13:25:51 tg Exp $");
@


1.540
log
@bring back $LDSTATIC support
@
text
@d279 6
d292 7
d1820 1
a1820 1
addsrcs '!' HAVE_STRLCPY strlcpy.c
d1824 1
@


1.539
log
@use a reverse test for sys_siglist_decl  this one works on Dell UNIX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.535 2012/04/01 17:17:45 tg Exp $'
d382 5
d1379 1
a1379 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.535 2012/04/01 17:17:45 tg Exp $");
d2043 1
@


1.538
log
@drop the need for strcasestr: just uppercase a copy and compare with uppercased
@
text
@d1590 1
a1590 1
ac_test sys_siglist_decl sys_siglist 1 'if sys_siglist[] does not need to be declared' <<-'EOF'
d1593 2
a1594 1
	int main(void) { return (sys_siglist[0][0]); }
@


1.537
log
@bring back -DMKSH_UNEMPLOYED default on BeOS as its less usable otherwise
@
text
@a1566 12
ac_test strcasestr <<-'EOF'
	#include <sys/types.h>
	#include <stddef.h>
	#include <string.h>
	#if HAVE_STRINGS_H
	#include <strings.h>
	#endif
	int main(int ac, char *av[]) {
		return ((int)(ptrdiff_t)(void *)strcasestr(*av, av[ac]));
	}
EOF

@


1.536
log
@disabling jobs just when there is no ctty isnt needed, at least for BeOS
XXX recheck this with all the others, e.g. NeXTstep
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.532 2012/04/01 04:57:24 tg Exp $'
d469 2
d1374 1
a1374 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.532 2012/04/01 04:57:24 tg Exp $");
@


1.535
log
@change signal probing order: prefer e.g. SEGV over BUS when same Nr. (BeOS)
@
text
@a468 2
	# BeOS has no real tty either
	add_cppflags -DMKSH_UNEMPLOYED
@


1.534
log
@BeOS has no tty nor uid/gid other than 0, and a broken /bin/sh
@
text
@d1779 2
a1780 2
	sigs="ABRT ALRM BUS CHLD CLD CONT DIL EMT FPE HUP ILL INFO INT IO IOT"
	sigs="$sigs KILL LOST PIPE PROF PWR QUIT RESV SAK SEGV STOP SYS TERM"
@


1.533
log
@speed up Generating list of signal names (XXX can we wrap this into one compile, anyway?)
@
text
@d460 11
a470 1
	oswarn="; it has some issues"
@


1.532
log
@found the actual reason cc -E does syntax check and wrap with whitespace 
also we can only do NeXTstep 3.3 with -posix, but not 3rdpty egcs or OS 4.2
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.530 2012/03/31 18:33:16 tg Exp $'
d1364 1
a1364 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.530 2012/03/31 18:33:16 tg Exp $");
d1747 2
a1748 1
	sigseen=:
d1778 4
d1791 1
a1791 1
		case $sigseen in
d1794 1
a1794 1
			sigseen=$sigseen$nr:
@


1.531
log
@ move behavioural changes topmost (locale, zsh emulate sh, solaris xpg)
 attempt to handle cpp on nextstep by using -save-temps
 work around another nextstep bug that may or may not hit us, found by RT:
   http://lists.gnu.org/archive/html/autoconf/2003-11/msg00094.html
 hide "dirname: command not found", scary even if it might help debugging
@
text
@a93 6
use_save_temps() {
	(set -x; eval "$CC" -c -save-temps "$@@") >&2
	cat conftest.i 2>/dev/null
	rm -f conftest.i conftest.o conftest.s
}

d297 1
a297 1
rmf a.exe* a.out* conftest.* *core core.* lft mksh* no *.bc *.ll *.o \
d445 3
d538 11
a548 4
	# NeXTstep works, OpenStep 4.2 is broken and needs LIBS to have
	# http://www.math.unl.edu/~rdieter1/OpenStep/Developer/PortingTips/posix1.txt
	# with sigprocmask adapted for the omask==NULL case (thanks RT)
	oswarn="; it has minor issues"
d758 1
a758 1
vv ']' "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c | grep ct= | tr -d \\\\015 >x"
a950 6
if ac_ifcpp 'ifdef __GNUC__' couldbe_gcc '!' compiler_known 0 \
    'if this could be a hidden gcc'; then
	ct=gcc
	CPP=use_save_temps
	HAVE_COMPILER_KNOWN=1
fi
d1760 1
a1760 1
	    grep mksh_cfg= | sed 's/^mksh_cfg=[	 ]*\([0-9x ()+-]*\).*$/\1/'`
d1782 2
a1783 3
		    grep mksh_cfg= | \
		    sed 's/^mksh_cfg=[	 ]*\([0-9x]*\).*$/\1:'$name/
	done | grep -v '^:' | sed 's/:/ /g' | while read nr name; do
d1794 1
a1796 1
rmf conftest.*
@


1.530
log
@add NeXTstep, OpenStep notes
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.529 2012/03/31 17:42:58 tg Exp $'
d31 11
a67 11
if test -d /usr/xpg4/bin/. >/dev/null 2>&1; then
	# Solaris: some of the tools have weird behaviour, use portable ones
	PATH=/usr/xpg4/bin:$PATH
	export PATH
fi

if test -n "${ZSH_VERSION+x}" && (emulate sh) >/dev/null 2>&1; then
	emulate sh
	NULLCMD=:
fi

d94 6
d272 1
d303 1
a303 1
rmf a.exe* a.out* conftest.c *core core.* lft mksh* no *.bc *.ll *.o \
d306 2
a307 2
curdir=`pwd` srcdir=`dirname "$0"` check_categories=
test -n "$srcdir" || srcdir=.
d753 1
a753 1
ct=unknown
d894 1
d945 7
d1366 1
a1366 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.529 2012/03/31 17:42:58 tg Exp $");
a1796 1
	rmf conftest.c
d1799 1
d1817 2
a1818 2
*\ *)	echo "#!./$mkshexe" >test.sh ;;
*)	echo "#!$curdir/$mkshexe" >test.sh ;;
d1820 2
a1821 1
cat >>test.sh <<-EOF
d1896 2
a1897 1
echo set -x >Rebuild.sh
@


1.529
log
@one more case of cpp(1) wanting C syntax on NeXTstep
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.528 2012/03/31 17:37:03 tg Exp $'
d533 6
d1351 1
a1351 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.528 2012/03/31 17:37:03 tg Exp $");
@


1.528
log
@Use proper C code for determining the compiler type even though we use
only cpp for this: NeXTstep things otherwise:
] conftest.c:42: illegal external declaration, missing ;' after `gcc'
| NeXT Computer, Inc. version cc-437.2.6, gcc version 2.5.8
| NeXT DevKit-based CPP 3.1
| GNU Objective-C version 2.5.8 (80386, BSD syntax) compiled by GNU C version 2.5.8.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.527 2012/03/30 10:24:45 tg Exp $'
d1345 1
a1345 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.527 2012/03/30 10:24:45 tg Exp $");
d1737 3
a1739 1
mksh_cfg: NSIG' >conftest.c
d1741 1
a1741 1
	    grep mksh_cfg: | sed 's/^mksh_cfg:[	 ]*\([0-9x ()+-]*\).*$/\1/'`
d1759 3
a1761 1
		echo mksh_cfg: SIG$name >>conftest.c
d1763 2
a1764 2
		    grep mksh_cfg: | \
		    sed 's/^mksh_cfg:[	 ]*\([0-9x]*\).*$/\1:'$name/
@


1.527
log
@RT suggests to drop sys_siglist and _sys_siglist on *all* SCO products, for now, and whitelist those that do need it (no strsignal)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.526 2012/03/30 09:27:19 tg Exp $'
d407 1
d409 1
a409 1
ct=Ninix3
d411 1
a411 1
ct=Minix3
d413 1
d682 1
d684 1
a684 1
ct=icc
d686 1
a686 1
ct=xlc
d688 1
a688 1
ct=sunpro
d690 1
a690 1
ct=ack
d692 1
a692 1
ct=bcc
d694 1
a694 1
ct=watcom
d696 1
a696 1
ct=metrowerks
d698 1
a698 1
ct=hpcc
d700 1
a700 1
ct=dec
d702 1
a702 1
ct=pgi
d704 1
a704 1
ct=dmc
d706 1
a706 1
ct=msc
d708 1
a708 1
ct=adsp
d710 1
a710 1
ct=iar
d712 1
a712 1
ct=sdcc
d714 1
a714 1
ct=pcc
d716 1
a716 1
ct=tendra
d718 1
a718 1
ct=tcc
d720 1
a720 1
ct=clang
d722 1
a722 1
ct=nwcc
d724 1
a724 1
ct=gcc
d726 1
a726 1
ct=mipspro
d728 1
a728 1
ct=mipspro
d730 1
a730 1
ct=hpcc
d732 1
a732 1
ct=ucode
d734 1
a734 1
ct=uslc
d736 1
a736 1
ct=unknown
d738 1
d1345 1
a1345 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.526 2012/03/30 09:27:19 tg Exp $");
@


1.526
log
@RT wants to make the awk used configurable, apparently OpenStep 4.2 has a broken default one
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.525 2012/03/29 19:22:54 tg Exp $'
a580 2
		# sys_siglist[] is broken (returns non mappable address)
		: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
d587 1
d607 1
d1341 1
a1341 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.525 2012/03/29 19:22:54 tg Exp $");
@


1.525
log
@couple of minor/cosmetic fixes from RTs compile farm:

 promote SCO OpenServer and UnixWare to !oswarn
 omit trying -O2/-O on OpenServer 5 and USL C
 cast mksh_ari_t to int, mksh_uari_t to unsigned int for printf
 skip ulimit-1 on syllable (which is still too broken)
 write ((mksh_ari_t)-2147483648) ipv UB ((mksh_ari_t)1 << 31)
  and add a comment that that is actually meant
 rewrite functions returning !void ending in NOTREACHED
  so theyve got a jump target returning an error at the
  end, to aid older compilers and just to be safe
 cast struct stat.st_size to off_t or size_t explicitly when needed
 shorten struct env by two bytes and an alignment, at least

also, optimise control flow and fix more paren matching cases
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.524 2012/03/28 11:15:04 tg Exp $'
d625 1
a625 1
: ${CC=cc} ${NROFF=nroff}
d1341 1
a1341 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.524 2012/03/28 11:15:04 tg Exp $");
d1737 1
a1737 1
	*[\ \(\)+-]*) NSIG=`awk "BEGIN { print $NSIG }"` ;;
d2000 1
@


1.524
log
@move USL C detection to after GCC detection, apparently the latter
masquerades as the former on SCO systems
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.523 2012/03/28 11:14:20 tg Exp $'
a573 1
	oswarn='; it may actually work'
a607 1
	oswarn='; it may work well'
d861 1
d1341 1
a1341 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.523 2012/03/28 11:14:20 tg Exp $");
d1663 2
a1664 1
		printf("no %d %d %d %d %s", o1, o2, r1, r2, av[0]);
@


1.523
log
@fix embarrassing typo (and I thought I had tested them all), 10x RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.522 2012/03/28 11:13:45 tg Exp $'
a705 2
#elif defined(__USLC__)
ct=uslc
d732 2
d1342 1
a1342 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.522 2012/03/28 11:13:45 tg Exp $");
@


1.522
log
@drop call to "custom", SCO says to use it to identify system,
but RT says it opens a GUI window, and we obviously cannot have this
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.521 2012/03/27 23:13:40 tg Exp $'
d1342 1
a1342 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.521 2012/03/27 23:13:40 tg Exp $");
d1581 1
a1581 1
ac_cache PERSISTENT_HISTORY || case $HAVE_MMAP$HAVE_FLOCK$HAVE_LOCL_FCNTL in
@


1.521
log
@pass the version to avoid stale Makefile.inc files
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.520 2012/03/27 23:01:51 tg Exp $'
a652 1
	vv '|' "custom >&2"
d1342 1
a1342 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.520 2012/03/27 23:01:51 tg Exp $");
@


1.520
log
@unknown OS or compiler? be loud!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.519 2012/03/27 22:41:16 tg Exp $'
d302 1
d586 2
a587 2
		oswarn='; this is an unknown version'
		oswarn="$oswarn${nl}of ${TARGET_OS} ${TARGET_OSREV}, please tell me"
d1343 1
a1343 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.519 2012/03/27 22:41:16 tg Exp $");
d1777 1
a1777 1
add_cppflags -DMKSH_BUILDSH
@


1.519
log
@#undef flock (LP: #912691)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.518 2012/03/27 22:36:48 tg Exp $'
d620 1
d879 3
d1342 1
a1342 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.518 2012/03/27 22:36:48 tg Exp $");
@


1.518
log
@ implement fcntl(2)-based advisory locking as an alternative iff flock(2)
  is not found, from a suggestion by RT (LP: #912691)
 try harder (in a loop) to acquire a file lock if the locking mechanism
  documents EINTR is a possibility (fcntl always, flock on Linux not .Ox)
 use -std=c99 not -std=gnu99 if it must be at all
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.517 2012/03/27 21:23:50 tg Exp $'
d1338 1
a1338 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.517 2012/03/27 21:23:50 tg Exp $");
d1404 1
d1410 1
@


1.517
log
@You have this  guy a lot to thank for.
00:45 -!- variable [root@@freebsd/developer/variable] has joined #!/bin/mksh

 +b *!*root@@*, +b $a:root, +b $r:root on one more channel
 certain checks to prevent:
00:47 < variable> wjcw: sh.h:308: error: conflicting types for 'getrusage'
01:19 < variable> oh
01:19 < variable> I needed to run Build.sh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.516 2012/03/27 21:01:55 tg Exp $'
d1338 1
a1338 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.516 2012/03/27 21:01:55 tg Exp $");
d1402 6
a1407 8
ac_testn flock_ex '' 'flock and mmap' <<-'EOF'
	#include <sys/types.h>
	#if HAVE_SYS_FILE_H
	#include <sys/file.h>
	#endif
	#if HAVE_SYS_MMAN_H
	#include <sys/mman.h>
	#endif
d1409 5
a1413 4
	#include <stdlib.h>
	int main(void) { return ((void *)mmap(NULL, (size_t)flock(0, LOCK_EX),
	    PROT_READ, MAP_PRIVATE, 0, (off_t)0) == (void *)NULL ? 1 :
	    munmap(NULL, 0)); }
d1448 14
d1552 1
a1552 1
ac_test '!' flock_decl flock_ex 1 'if flock() does not need to be declared' <<-'EOF'
d1575 3
a1577 1
ac_cache PERSISTENT_HISTORY || test 0 = $HAVE_FLOCK_EX || fv=1
@


1.516
log
@update on SCO OpenServer, SCO UnixWare and USL C, from RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.515 2012/03/26 20:14:58 tg Exp $'
d1338 1
a1338 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.515 2012/03/26 20:14:58 tg Exp $");
d1755 1
@


1.515
log
@be more loud in Build.sh to aid me
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.514 2012/03/26 19:54:54 tg Exp $'
d441 1
a441 1
QNX)
d573 16
a588 5
	# <RT|AO> it is quite sure that sys_siglist[] is broken
	# (it returns non mappable address)
	: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
	# need test logs
	oswarn='; it may or may not work'
d606 4
d648 5
d705 2
d857 9
d1338 1
a1338 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.514 2012/03/26 19:54:54 tg Exp $");
@


1.514
log
@RT confirmed we need this workaround on SCO OpenServer 6.0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.513 2012/03/26 19:48:06 tg Exp $'
d643 1
a643 1
$e "$bi$me: Building the MirBSD Korn Shell$ao $ui$dstversion$ao"
d1307 1
a1307 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.513 2012/03/26 19:48:06 tg Exp $");
@


1.513
log
@BeOS has quite some issues by now, several minor combined, no major
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.512 2012/03/03 21:30:13 tg Exp $'
d572 7
d1307 1
a1307 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.512 2012/03/03 21:30:13 tg Exp $");
@


1.512
log
@distinguish between Minix 3 and Ninix 3
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.511 2012/03/03 19:27:07 tg Exp $'
d453 1
a453 1
	oswarn=' and will currently not work'
d1300 1
a1300 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.511 2012/03/03 19:27:07 tg Exp $");
@


1.511
log
@-DMKSH_SMALL no longer implies -fno-inline
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.510 2012/02/17 13:59:56 tg Exp $'
d296 1
a296 1
rmf a.exe* a.out* conftest.c *core lft mksh* no *.bc *.ll *.o \
d398 41
d511 1
a511 1
Minix)
d530 8
d1300 1
a1300 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.510 2012/02/17 13:59:56 tg Exp $");
@


1.510
log
@fix regression in mirtoconf output introduced in cid 1004EFE6D783E94B328
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.509 2012/02/17 09:49:45 tg Exp $'
a1107 18
	#XXX this sucks; fix it for *all* compilers
	case $ct in
	clang|icc|nwcc)
		ac_flags 1 fnoinline -fno-inline
		;;
	gcc)
		NOWARN=$DOWARN; phase=u
		ac_flags 1 fnoinline -fno-inline
		NOWARN=$save_NOWARN; phase=x
		;;
	sunpro)
		ac_flags 1 fnoinline -xinline=
		;;
	xlc)
		ac_flags 1 fnoinline -qnoinline
		;;
	esac

d1251 1
a1251 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.509 2012/02/17 09:49:45 tg Exp $");
@


1.509
log
@10:41RT|Chatzilla:#!/bin/mksh mira|AO: 12:08 < RT|AO> a bit fun compiling mksh in SkyOS 5.0.6753 ;-)
         http://pastebin.com/GHPm1B7B
10:41<mira|AO:#!/bin/mksh> .oO(wtf is SkyOS?)
10:42<mira|AO:#!/bin/mksh> shf.c:453: warning: format '%zd' expects type 'signed size_t', but argument 4
         has type 'ssize_t'
10:42<mira|AO:#!/bin/mksh> lol
10:42<mira|AO:#!/bin/mksh> Ive seen (and fixed!) that in dietlibc too, recently
10:43RT|Chatzilla:#!/bin/mksh http://en.wikipedia.org/wiki/SkyOS
10:43<mira|AO:#!/bin/mksh> shell-init: error retrieving current directory: getcwd: cannot access parent
         directories: Not a character device  huh?!?!?!
10:46<mira|AO:#!/bin/mksh> looks like their POSIX layer has got issues (other than this shell-init
         thing, umask and checks for existence upon open() are broken)
10:46<mira|AO:#!/bin/mksh> but mksh is usable, I'd say
10:46<mira|AO:#!/bin/mksh> mostly
10:46<mira|AO:#!/bin/mksh> let me commit that
10:46RT|Chatzilla:#!/bin/mksh funny posix layer bug, just like "unexpected exit status 1 (signal 1),
         expected 1" signal bug in BeOS5
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.508 2012/01/04 08:56:27 tg Exp $'
d158 1
a158 1
	ac_testinit "$@@" || return
d177 1
d180 1
a180 1
	ac_testnnd "$@@"
d1269 1
a1269 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.508 2012/01/04 08:56:27 tg Exp $");
d1554 1
a1554 1
ac_testnnd silent_idivwrapv '' '(run-time) whether signed integer division overflows wrap silently' <<-'EOF'
d1585 14
a1598 10
if test $fv = 0; then
	echo "| hrm, compiling this failed, but we will just failback"
else
	echo "| running test programme; this will fail if cross-compiling"
	echo "| in which case we will gracefully degrade to the default"
	./$tcfn >vv.out 2>&1
	rv=$?
	echo "| result: `cat vv.out`"
	fv=0
	test $rv = 0 && test x"`cat vv.out`" = x"si" && fv=1
a1599 2
rmf conftest.c conftest.o ${tcfn}* vv.out
ac_testdone
@


1.508
log
@DTRT when commenting out the only instruction in an if block; spotted by RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.507 2012/01/03 16:14:39 tg Exp $'
d522 3
d1268 1
a1268 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.507 2012/01/03 16:14:39 tg Exp $");
@


1.507
log
@disable tccs bounds checker for now; fixes SIGSEGV-on-start on i386 (Total failed: 0; Total passed: 424)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.506 2012/01/03 16:03:22 tg Exp $'
d1000 1
a1000 1
	#broken# ac_flags 1 boundschk -b
d1005 1
a1005 1
	#broken# ac_flags 1 ssp -stackprotect
d1265 1
a1265 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.506 2012/01/03 16:03:22 tg Exp $");
@


1.506
log
@fix gccism; found during testing with tcc
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.505 2012/01/03 01:40:13 tg Exp $'
d1000 1
a1000 1
	ac_flags 1 boundschk -b
d1265 1
a1265 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.505 2012/01/03 01:40:13 tg Exp $");
@


1.505
log
@MSYS implies -DMKSH_ASSUME_UTF8=0 and thus can skip the test thatd fail
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.504 2012/01/03 01:30:16 tg Exp $'
d1265 1
a1265 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.504 2012/01/03 01:30:16 tg Exp $");
d1495 1
a1495 1
test 1 = $HAVE_CAN_WNOOVERFLOW && CFLAGS="$CFLAGS -Wno-overflow"
@


1.504
log
@if tcfn=a.exe pass mksh.exe, not mksh, to check.pl

also spotted by RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.503 2012/01/03 00:58:06 tg Exp $'
d445 1
a445 1
	add_cppflags -DMKSH_ASSUME_UTF8
d480 1
d504 1
a504 1
	add_cppflags -DMKSH_ASSUME_UTF8
d1265 1
a1265 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.503 2012/01/03 00:58:06 tg Exp $");
@


1.503
log
@move linkage check (which uses sh.h INCLUDES_ONLY) to when all of its
prerequisites are actually fulfilled, i.e. evrn further down than with
the last commit doing this, and move some prerequisites of stuff that
has wandered outside the !INCLUDES_ONLY block with the compile-time
assert changes to the outside, too

fixes FTBFS on MSYS which has neither <stdint.h> nor uint32_t
reported by RT
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.502 2011/12/31 02:54:15 tg Exp $'
d1264 1
a1264 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.502 2011/12/31 02:54:15 tg Exp $");
d1685 4
d1690 2
a1691 2
*\ *)	echo "#!./mksh" >test.sh ;;
*)	echo "#!$curdir/mksh" >test.sh ;;
d1697 1
a1697 1
	pflag='$curdir/mksh'
a1792 4
case $tcfn in
a.exe)	mkshexe=mksh.exe ;;
*)	mkshexe=mksh ;;
esac
@


1.502
log
@bunch of warning fixes
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.501 2011/12/31 02:04:16 tg Exp $'
d4 2
a5 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011
a1165 45
# check whether whatever we use for the final link will succeed
#
if test $cm = makefile; then
	: nothing to check
else
	HAVE_LINK_WORKS=x
	ac_testinit link_works '' 'checking if the final link command may succeed'
	fv=1
	cat >conftest.c <<-'EOF'
		#define EXTERN
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.501 2011/12/31 02:04:16 tg Exp $");
		int main(void) { printf("Hello, World!\n"); return (0); }
EOF
	case $cm in
	llvm)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -emit-llvm -c conftest.c" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	dragonegg)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -S -flto conftest.c" || fv=0
		test $fv = 0 || v "mv conftest.s conftest.ll"
		test $fv = 0 || v "llvm-as conftest.ll" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	combine)
		v "$CC $CFLAGS $CPPFLAGS $LDFLAGS -fwhole-program --combine $NOWARN -o $tcfn conftest.c $LIBS $ccpr"
		;;
	lto|normal)
		cm=normal
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -c conftest.c" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn conftest.o $LIBS $ccpr"
		;;
	esac
	test -f $tcfn || fv=0
	ac_testdone
	test $fv = 1 || exit 1
fi

#
d1252 45
@


1.501
log
@followup for cid 1004EE408E1382C1752 and 1004EE40DDD498FBB0D:
do a mirtoconf run-time check (ugh) to see whether the CPU designers
smoked/were brain-dead or if we dont actually need the manual check
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.500 2011/12/31 00:31:25 tg Exp $'
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.500 2011/12/31 00:31:25 tg Exp $");
d1573 1
d1575 1
a1575 2
		write(1, fpe_msg, sizeof(fpe_msg) - 1);
		_exit(2);
@


1.500
log
@clang doesnt decide whether -version or --version is to be used, grml
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.499 2011/12/18 02:20:09 tg Exp $'
d150 1
a150 1
ac_testn() {
d176 3
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.499 2011/12/18 02:20:09 tg Exp $");
d1542 55
@


1.499
log
@disable looking for C99 support flag in compilers (and GCC extensions)

laffer1 just pointed me to n1570 and I must say I am shocked but not surprised
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.498 2011/12/10 14:16:09 tg Exp $'
d675 1
a675 1
	# this works, for now
d677 1
d1174 1
a1174 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.498 2011/12/10 14:16:09 tg Exp $");
@


1.498
log
@clearer messages
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.497 2011/12/08 22:19:03 tg Exp $'
a956 1
	ac_flags 1 xc99 -xc99 'for support of ISO C99'
d961 2
a962 2
	ac_flags 1 agcc -Agcc 'for support of GCC extensions'
	ac_flags 1 ac99 -AC99 'for support of ISO C99'
a972 1
	ac_flags 1 xc99 -c99 'for support of ISO C99'
a983 2
	ac_flags 1 x99 -qlanglvl=extc99
	test 1 = $HAVE_CAN_X99 || ac_flags 1 c99 -qlanglvl=stdc99
a1002 3
	ac_flags 1 stdg99 -std=gnu99 'for support of ISO C99 + GCC extensions'
	test 1 = $HAVE_CAN_STDG99 || \
	    ac_flags 1 stdc99 -std=c99 'for support of ISO C99'
d1173 1
a1173 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.497 2011/12/08 22:19:03 tg Exp $");
@


1.497
log
@MKSH_DISABLE_DEPRECATED needs testsuite handling
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.496 2011/12/08 22:16:42 tg Exp $'
d1180 1
a1180 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.496 2011/12/08 22:16:42 tg Exp $");
d1692 8
a1699 2
		(( rv )) && continue
		[[ -n \$perlos ]] && break
@


1.496
log
@rework Perl interpreter finding logic; *buntu/dietlibc-arm{el,hf} are broken
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.495 2011/12/04 19:59:33 tg Exp $'
d1142 3
d1180 1
a1180 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.495 2011/12/04 19:59:33 tg Exp $");
@


1.495
log
@MFC recent changes to R40-stable, validate it, fix a pedantic warning
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.494 2011/12/04 19:38:36 tg Exp $'
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.494 2011/12/04 19:38:36 tg Exp $");
d1681 9
a1689 3
		[[ \$perli = no ]] && exit 1
		perlos=\$(\$perli -e "\$cstr") 2>/dev/null || continue
		print "Perl interpreter '\$perli' running on '\$perlos'"
@


1.494
log
@improve installation instructions
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.493 2011/12/03 00:01:26 tg Exp $'
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.493 2011/12/03 00:01:26 tg Exp $");
d1532 1
a1532 1
cta(ptrdifft_funcptr_same_size, sizeof(ptrdiff_t) == sizeof(void (*)()));
@


1.493
log
@move compile-time assertions out of misc.c(#ifdef DEBUG) into Build.sh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.492 2011/12/02 22:55:45 tg Exp $'
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.492 2011/12/02 22:55:45 tg Exp $");
d1875 16
@


1.492
log
@ improve comments
 do shave off 20 bytes from c_test() and get rid of the ugly stack
  variable and double using despite not parsing
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.491 2011/11/26 17:56:29 tg Exp $'
d904 1
d1177 1
a1177 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.491 2011/11/26 17:56:29 tg Exp $");
d1492 49
@


1.491
log
@#ifdef MKSH_DISABLE_DEPRECATED do not compile in features scheduled for removal
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.490 2011/11/25 23:29:30 tg Exp $'
d25 1
a25 11
# Environment used:	CC CFLAGS CPPFLAGS LDFLAGS LIBS NOWARN NROFF
#			TARGET_OS TARGET_OSREV
# Feature selectors:	USE_PRINTF_BUILTIN
# CPPFLAGS recognised:	MKSH_MIDNIGHTBSD01ASH_COMPAT MKSH_CONSERVATIVE_FDS
#			MKSH_DONT_EMIT_IDSTRING MKSH_NO_DEPRECATED_WARNING
#			MKSH_DISABLE_DEPRECATED MKSH_ASSUME_UTF8 MKSH_A4PB
#			MKSH_SMALL MKSH_BINSHREDUCED MKSH_NOPROSPECTOFWORK
#			MKSH_UNEMPLOYED MKSH_NO_LIMITS MKSH_DEFAULT_TMPDIR
#			MKSH_DEFAULT_EXECSHELL MKSHRC_PATH MKSH_CLS_STRING
#			MKSH_CLRTOEOL_STRING MKSH_NO_EXTERNAL_CAT
#			MKSH_NOPWNAM MKSH_S_NOVI
d1176 1
a1176 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.490 2011/11/25 23:29:30 tg Exp $");
d1778 48
@


1.490
log
@add a -f option to test.sh that runs tests of class fastbox
plus a test in that category for a bug spotted during development of
https://evolvis.org/plugins/scmgit/cgi-bin/gitweb.cgi?p=shellsnippets/shellsnippets.git;a=blob;f=mksh/sysadmin/getjpics.cgi;h=d74018cbc1ae4e88408267ecc73a6df19aa4c99a;hb=HEAD
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.489 2011/11/05 23:39:01 tg Exp $'
d28 8
a35 7
# CPPFLAGS recognised:	MKSH_ASSUME_UTF8 MKSH_BINSHREDUCED MKSH_CLS_STRING
#			MKSH_CONSERVATIVE_FDS MKSH_MIDNIGHTBSD01ASH_COMPAT
#			MKSH_NOPWNAM MKSH_NO_LIMITS MKSH_SMALL MKSH_S_NOVI
#			MKSH_UNEMPLOYED MKSH_DEFAULT_EXECSHELL MKSHRC_PATH
#			MKSH_DEFAULT_TMPDIR MKSH_CLRTOEOL_STRING MKSH_A4PB
#			MKSH_NO_DEPRECATED_WARNING MKSH_DONT_EMIT_IDSTRING
#			MKSH_NOPROSPECTOFWORK MKSH_NO_EXTERNAL_CAT
d1186 1
a1186 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.489 2011/11/05 23:39:01 tg Exp $");
@


1.489
log
@make MSYS match Cygwin more closely; ignore its broken <stdint.h>
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.488 2011/10/07 19:51:41 tg Exp $'
d1185 1
a1185 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.488 2011/10/07 19:51:41 tg Exp $");
d1599 1
a1599 1
	while getopts "C:e:Pp:s:t:v" ch; do case \$ch {
d1602 1
@


1.488
log
@better handling of eval and CPPFLAGS in build system
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.487 2011/08/26 10:24:51 tg Exp $'
d485 4
a488 2
	# probably same as CYGWIN*  need to test; from RT|Chatzilla
	oswarn='but will probably work'
d1185 1
a1185 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.487 2011/08/26 10:24:51 tg Exp $");
@


1.487
log
@12:23<cnuke:#bosng> angefangen damit, dass es kein uname unter OPENSTEP gibt :)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.486 2011/08/26 10:20:28 tg Exp $'
d209 4
d217 1
a217 1
	CPPFLAGS="$CPPFLAGS -DHAVE_$fu=$fv"
d335 1
a335 1
		CPPFLAGS="$CPPFLAGS -DDEBUG"
d412 1
a412 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d432 1
a432 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
d438 1
a438 1
	*) CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE" ;;
d441 1
a441 1
	CPPFLAGS="$CPPFLAGS -DNO_PATH_MAX"
d446 1
a446 1
	*) CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE" ;;
d450 1
a450 1
	CPPFLAGS="$CPPFLAGS -DMKSH_ASSUME_UTF8"
d457 1
a457 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d467 1
a467 1
	*) CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE" ;;
d469 1
a469 1
	CPPFLAGS="$CPPFLAGS -DSETUID_CAN_FAIL_WITH_EAGAIN"
d475 4
a478 3
	CPPFLAGS="$CPPFLAGS -DMKSH_UNEMPLOYED -DMKSH_CONSERVATIVE_FDS"
	CPPFLAGS="$CPPFLAGS -DMKSH_NO_LIMITS"
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE -D_POSIX_1_SOURCE=2 -D_MINIX"
d495 4
a498 2
	CPPFLAGS="$CPPFLAGS -D_OSF_SOURCE -D_POSIX_C_SOURCE=200112L"
	CPPFLAGS="$CPPFLAGS -D_XOPEN_SOURCE=600 -D_XOPEN_SOURCE_EXTENDED"
d502 5
a506 2
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE -D_LIMITS_EXTENSION"
	CPPFLAGS="$CPPFLAGS -D_BSD_EXTENSION -D_SUSV2_SOURCE"
d508 1
a508 1
	CPPFLAGS="$CPPFLAGS -DMKSH_ASSUME_UTF8 -DMKSH_UNEMPLOYED"
d516 1
a516 1
	CPPFLAGS="$CPPFLAGS -D__NO_EXT_QNX"
d525 2
a526 1
	CPPFLAGS="$CPPFLAGS -D_BSD_SOURCE -D__EXTENSIONS__"
d529 1
a529 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
d534 1
a534 1
	CPPFLAGS="$CPPFLAGS -Dssize_t=int"
d1183 1
a1183 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.486 2011/08/26 10:20:28 tg Exp $");
d1226 1
a1226 1
CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64"
d1229 2
a1230 1
	CPPFLAGS="$save_CPPFLAGS -D_LARGE_FILES=1"
d1283 1
a1283 1
	CPPFLAGS="$CPPFLAGS -Dsig_t=sighandler_t"
d1294 1
a1294 1
	CPPFLAGS="$CPPFLAGS -Dsig_t=__sighandler_t"
d1298 1
a1298 1
test 1 = $HAVE_SIG_T || CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t"
d1316 4
a1319 3
	if eval "test 1 = \$HAVE__SYS_SIG$uwhat"; then
		CPPFLAGS="$CPPFLAGS -Dsys_sig$what=_sys_sig$what"
		eval "HAVE_SYS_SIG$uwhat=1"
d1578 1
a1578 1
test 1 = "$USE_PRINTF_BUILTIN" && CPPFLAGS="$CPPFLAGS -DMKSH_PRINTF_BUILTIN"
@


1.486
log
@fix pasto, I think, from some time ago, spotted by cnuke@@
12:17<cnuke:#bosng> OPENSTEP hat kein dirname und $srcdir/sh.h wird dann /sh.h
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.485 2011/07/16 18:03:04 tg Exp $'
d382 4
d1172 1
a1172 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.485 2011/07/16 18:03:04 tg Exp $");
@


1.485
log
@check later whether the final link may succeed, and include "sh.h"  catch inlining bugs in system headers fighting with -c combine
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484 2011/07/07 21:24:51 tg Exp $'
d300 1
a300 1
test -n "$dirname" || dirname=.
d1168 1
a1168 1
		__RCSID("$MirOS: src/bin/mksh/sh.h,v 1.484.2.3 2011/07/16 16:04:16 tg Exp $");
@


1.484
log
@introduce MKSH_NO_EXTERNAL_CAT skipping the call /bin/cat if we have an
option nonsense, intended for Android, Plan 9, and other systems which
honour that cat -v is deemed harmful
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.483 2011/06/12 15:54:42 tg Exp $'
a1003 40
# check whether whatever we use for the final link will succeed
if test $cm = makefile; then
	: nothing to check
else
	HAVE_LINK_WORKS=x
	ac_testinit link_works '' 'checking if the final link command may succeed'
	fv=1
	cat >conftest.c <<-'EOF'
		#include <stdio.h>
		int main(void) { printf("Hello, World!\n"); return (0); }
EOF
	case $cm in
	llvm)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -emit-llvm -c conftest.c" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	dragonegg)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -S -flto conftest.c" || fv=0
		test $fv = 0 || v "mv conftest.s conftest.ll"
		test $fv = 0 || v "llvm-as conftest.ll" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	combine)
		v "$CC $CFLAGS $CPPFLAGS $LDFLAGS -fwhole-program --combine $NOWARN -o $tcfn conftest.c $LIBS $ccpr"
		;;
	lto|normal)
		cm=normal
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -c conftest.c" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn conftest.o $LIBS $ccpr"
		;;
	esac
	test -f $tcfn || fv=0
	ac_testdone
	test $fv = 1 || exit 1
fi

d1156 45
@


1.484.2.1
log
@time to open the mksh R40-stable branch:
 bring back deprecated {build options,set o arc4random,OAAT1 internal hash}
 change version number in TFM
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484 2011/07/07 21:24:51 tg Exp $'
a328 4
	:-combine)
		cm=combine
		echo "$me: Warning: '$i' is deprecated, use '-c combine' instead!" >&2
		;;
a336 10
	:-llvm)
		cm=llvm
		optflags=-std-compile-opts
		echo "$me: Warning: '$i' is deprecated, use '-c llvm -O' instead!" >&2
		;;
	:-llvm=*)
		cm=llvm
		optflags=`echo "x$i" | sed 's/^x-llvm=//'`
		echo "$me: Warning: '$i' is deprecated, use '-c llvm -o $llvm' instead!" >&2
		;;
@


1.484.2.2
log
@check later whether the final link may succeed, and include "sh.h"  catch inlining bugs in system headers fighting with -c combine
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.1 2011/07/07 21:42:08 tg Exp $'
d1018 40
a1209 45
# check whether whatever we use for the final link will succeed
#
if test $cm = makefile; then
	: nothing to check
else
	HAVE_LINK_WORKS=x
	ac_testinit link_works '' 'checking if the final link command may succeed'
	fv=1
	cat >conftest.c <<-'EOF'
		#define EXTERN
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		__RCSID("$MirOS: src/bin/mksh/sh.h,v 1.484.2.3 2011/07/16 16:04:16 tg Exp $");
		int main(void) { printf("Hello, World!\n"); return (0); }
EOF
	case $cm in
	llvm)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -emit-llvm -c conftest.c" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	dragonegg)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -S -flto conftest.c" || fv=0
		test $fv = 0 || v "mv conftest.s conftest.ll"
		test $fv = 0 || v "llvm-as conftest.ll" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	combine)
		v "$CC $CFLAGS $CPPFLAGS $LDFLAGS -fwhole-program --combine $NOWARN -o $tcfn conftest.c $LIBS $ccpr"
		;;
	lto|normal)
		cm=normal
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -c conftest.c" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn conftest.o $LIBS $ccpr"
		;;
	esac
	test -f $tcfn || fv=0
	ac_testdone
	test $fv = 1 || exit 1
fi

#
@


1.484.2.3
log
@MFC from HEAD and adjust version

Build.sh:
- better handling of eval and CPPFLAGS in build system
- partial OPENSTEP support
- fix typo

check.t:
- mark utf8opt-2a as need-pass: no (1.481)

dot.mkshrc:
- do not close stderr (1.65)
- use only printable characters (1.65)

edit.c:
- upper bound Emacs mode command repeat by input line length

funcs.c, sh.h:
- optimise an if away, and possibly even the function bodies

misc.c:
- jg71 reported -DMKSH_ASSUME_UTF8=* breaks defining stristr

mksh.1, sh.h. var.c:
- fix spelling

mksh.1:
- document "export -"

sh.h:
- undef optarg, optind in case the OE predefines them (1.493)

shf.c:
- handle %zu (size_t), %zd (ssize_t), etc. (1.43)

syn.c:
- avoid (not-)function-local externs (1.68)

multiple:
- do not use macros or identifiers ending with an underscore
- more {,s}size_t, type, lint, other cleanups (edit.c 1.220; eval.c 1.107;
  exec.c 1.95; expr.c 1.48; funcs.c 1.196; histrap.c 1.110; jobs.c 1.81;
  lalloc.c 1.18; lex.c 1.155; main.c 1.198; misc.c 1.171; sh.h 1.493;
  shf.c 1.43; tree.c 1.50; var.c 1.131)
- wrap access(2) (edit.c 1.221; exec.c 1.96; expr.c 1.49; funcs.c 1.197;
  histrap.c 1.111; sh.h 1.494)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.2 2011/07/16 18:03:01 tg Exp $'
a208 4
add_cppflags() {
	CPPFLAGS="$CPPFLAGS $*"
}

d213 1
a213 1
	add_cppflags -DHAVE_$fu=$fv
d300 1
a300 1
test -n "$srcdir" || srcdir=.
d335 1
a335 1
		add_cppflags -DDEBUG
a395 4
if test x"$TARGET_OS" = x""; then
	echo "$me: Set TARGET_OS, your uname is broken!" >&2
	exit 1
fi
d418 1
a418 1
	add_cppflags -D_ALL_SOURCE
d438 1
a438 1
	add_cppflags -D_GNU_SOURCE
d444 1
a444 1
	*) add_cppflags -D_GNU_SOURCE ;;
d447 1
a447 1
	add_cppflags -DNO_PATH_MAX
d452 1
a452 1
	*) add_cppflags -D_GNU_SOURCE ;;
d456 1
a456 1
	add_cppflags -DMKSH_ASSUME_UTF8
d463 1
a463 1
	add_cppflags -D_ALL_SOURCE
d473 1
a473 1
	*) add_cppflags -D_GNU_SOURCE ;;
d475 1
a475 1
	add_cppflags -DSETUID_CAN_FAIL_WITH_EAGAIN
d481 3
a483 4
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_CONSERVATIVE_FDS
	add_cppflags -DMKSH_NO_LIMITS
	add_cppflags -D_POSIX_SOURCE -D_POSIX_1_SOURCE=2 -D_MINIX
d500 2
a501 4
	add_cppflags -D_OSF_SOURCE
	add_cppflags -D_POSIX_C_SOURCE=200112L
	add_cppflags -D_XOPEN_SOURCE=600
	add_cppflags -D_XOPEN_SOURCE_EXTENDED
d505 2
a506 5
	add_cppflags -D_POSIX_SOURCE
	add_cppflags -D_LIMITS_EXTENSION
	add_cppflags -D_BSD_EXTENSION
	add_cppflags -D_SUSV2_SOURCE
	add_cppflags -DMKSH_ASSUME_UTF8
d508 1
a508 1
	add_cppflags -DMKSH_UNEMPLOYED
d516 1
a516 1
	add_cppflags -D__NO_EXT_QNX
d525 1
a525 2
	add_cppflags -D_BSD_SOURCE
	add_cppflags -D__EXTENSIONS__
d528 1
a528 1
	add_cppflags -D_GNU_SOURCE
d533 1
a533 1
	add_cppflags -Dssize_t=int
d1182 1
a1182 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.2 2011/07/16 18:03:01 tg Exp $");
d1225 1
a1225 1
add_cppflags -D_FILE_OFFSET_BITS=64
d1228 1
a1228 2
	CPPFLAGS=$save_CPPFLAGS
	add_cppflags -D_LARGE_FILES=1
d1281 1
a1281 1
	add_cppflags -Dsig_t=sighandler_t
d1292 1
a1292 1
	add_cppflags -Dsig_t=__sighandler_t
d1296 1
a1296 1
test 1 = $HAVE_SIG_T || add_cppflags -Dsig_t=nosig_t
d1314 3
a1316 4
	eval uwhat_v=\$HAVE__SYS_SIG$uwhat
	if test 1 = "$uwhat_v"; then
		add_cppflags -Dsys_sig$what=_sys_sig$what
		eval HAVE_SYS_SIG$uwhat=1
d1575 1
a1575 1
test 1 = "$USE_PRINTF_BUILTIN" && add_cppflags -DMKSH_PRINTF_BUILTIN
@


1.484.2.4
log
@MFC mksh-current fixes and upcoming deprecation and promotion; sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.3 2011/10/25 22:50:27 tg Exp $'
d499 2
a500 4
	# almost same as CYGWIN* (from RT|Chatzilla)
	: ${HAVE_SETLOCALE_CTYPE=0}
	# broken on this OE (from ir0nh34d)
	: ${HAVE_STDINT_H=0}
d1197 1
a1197 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.3 2011/10/25 22:50:27 tg Exp $");
@


1.484.2.5
log
@ MFC this weeks bag of misc fixes
 mark set o arc4random MKSH_DISABLE_DEPRECATED (for e.g. Android)
@
text
@d28 7
a34 8
# CPPFLAGS recognised:	MKSH_MIDNIGHTBSD01ASH_COMPAT MKSH_CONSERVATIVE_FDS
#			MKSH_DONT_EMIT_IDSTRING MKSH_NO_DEPRECATED_WARNING
#			MKSH_DISABLE_DEPRECATED MKSH_ASSUME_UTF8 MKSH_A4PB
#			MKSH_SMALL MKSH_BINSHREDUCED MKSH_NOPROSPECTOFWORK
#			MKSH_UNEMPLOYED MKSH_NO_LIMITS MKSH_DEFAULT_TMPDIR
#			MKSH_DEFAULT_EXECSHELL MKSHRC_PATH MKSH_CLS_STRING
#			MKSH_CLRTOEOL_STRING MKSH_NO_EXTERNAL_CAT
#			MKSH_NOPWNAM MKSH_S_NOVI
d1613 1
a1613 1
	while getopts "C:e:fPp:s:t:v" ch; do case \$ch {
a1615 1
	(f)	check_categories[\${#check_categories[*]}]=fastbox ;;
@


1.484.2.6
log
@MFC recent changes to R40-stable, validate it, fix a pedantic warning
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.5 2011/11/26 18:23:14 tg Exp $'
d25 11
a35 1
# Used environment documentation is at the end of this file.
a927 1
	ac_flags 0 wnooverflow -Wno-overflow
d1200 1
a1200 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.5 2011/11/26 18:23:14 tg Exp $");
a1514 49
save_CFLAGS=$CFLAGS
test 1 = $HAVE_CAN_WNOOVERFLOW && CFLAGS="$CFLAGS -Wno-overflow"
ac_testn compile_time_asserts_$$ '' 'whether compile-time assertions pass' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	struct ctasserts {
	#define cta(name, assertion) char name[(assertion) ? 1 : -1]
/* this one should be defined by the standard */
cta(char_is_1_char, (sizeof(char) == 1) && (sizeof(signed char) == 1) &&
    (sizeof(unsigned char) == 1));
/* the next assertion is probably not really needed */
cta(short_is_2_char, sizeof(short) == 2);
cta(short_size_no_matter_of_signedness, sizeof(short) == sizeof(unsigned short));
/* the next assertion is probably not really needed */
cta(int_is_4_char, sizeof(int) == 4);
cta(int_size_no_matter_of_signedness, sizeof(int) == sizeof(unsigned int));

cta(long_ge_int, sizeof(long) >= sizeof(int));

/* the next assertion is probably not really needed */
cta(ari_is_4_char, sizeof(mksh_ari_t) == 4);
/* but the next three are; we REQUIRE signed integer wraparound */
cta(ari_is_signed, (mksh_ari_t)-1 < (mksh_ari_t)0);
cta(ari_has_31_bit, 0 < (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 1));
cta(ari_sign_32_bit_and_wrap,
    (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 1) >
    (mksh_ari_t)(((((mksh_ari_t)1 << 15) << 15) - 1) * 2 + 2));
/* the next assertion is probably not really needed */
cta(uari_is_4_char, sizeof(mksh_uari_t) == 4);
/* but the next four are; we REQUIRE unsigned integer wraparound */
cta(uari_is_unsigned, (mksh_uari_t)-1 > (mksh_uari_t)0);
cta(uari_has_31_bit, 0 < (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 2 + 1));
cta(uari_has_32_bit, 0 < (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 3));
cta(uari_wrap_32_bit,
    (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 3) >
    (mksh_uari_t)(((((mksh_uari_t)1 << 15) << 15) - 1) * 4 + 4));

cta(sizet_size_no_matter_of_signedness, sizeof(ssize_t) == sizeof(size_t));
cta(ptrdifft_sizet_same_size, sizeof(ptrdiff_t) == sizeof(size_t));
cta(ptrdifft_voidptr_same_size, sizeof(ptrdiff_t) == sizeof(void *));
cta(ptrdifft_funcptr_same_size, sizeof(ptrdiff_t) == sizeof(void (*)(void)));
/* our formatting routines assume this */
cta(ptr_fits_in_long, sizeof(ptrdiff_t) <= sizeof(long));
	};
	int main(void) { return (sizeof(struct ctasserts)); }
EOF
CFLAGS=$save_CFLAGS
eval test 1 = \$HAVE_COMPILE_TIME_ASSERTS_$$ || exit 1

a1801 64

: <<'EOD'

=== Environment used ===

==== build environment ====
CC				default: cc
CFLAGS				if empty, defaults to -xO2 or +O2
				or -O3 -qstrict or -O2, per compiler
CPPFLAGS			default empty
LDFLAGS				default empty; added before sources
LIBS				default empty; added after sources
				[Interix] default: -lcrypt (XXX still needed?)
NOWARN				-Wno-error or similar
NROFF				default: nroff
TARGET_OS			default: $(uname -s || uname)
TARGET_OSREV			[QNX] default: $(uname -r)

==== feature selectors ====
USE_PRINTF_BUILTIN		1 to include (unsupported) printf(1) as builtin
===== general format =====
HAVE_STRLEN			ac_test
HAVE_STRING_H			ac_header
HAVE_CAN_FSTACKPROTECTORALL	ac_flags

==== cpp definitions ====
MKSHRC_PATH			"~/.mkshrc" (do not change)
MKSH_A4PB			force use of arc4random_pushb
MKSH_ASSUME_UTF8		(0=disabled, 1=enabled; default: unset)
MKSH_BINSHREDUCED		if */sh or */-sh, enable set -o sh
MKSH_CLRTOEOL_STRING		"\033[K"
MKSH_CLS_STRING			"\033[;H\033[J"
MKSH_CONSERVATIVE_FDS		fd 0-9 for scripts, shell only up to 31
MKSH_DEFAULT_EXECSHELL		"/bin/sh" (do not change)
MKSH_DEFAULT_TMPDIR		"/tmp" (do not change)
MKSH_DISABLE_DEPRECATED		disable code paths scheduled for later removal
MKSH_DONT_EMIT_IDSTRING		omit RCS IDs from binary
MKSH_MIDNIGHTBSD01ASH_COMPAT	set -o sh: additional compatibility quirk
MKSH_NOPROSPECTOFWORK		disable jobs, co-processes, etc. (do not use)
MKSH_NOPWNAM			skip PAM calls, for -static on eglibc, Solaris
MKSH_NO_DEPRECATED_WARNING	omit warning when deprecated stuff is run
MKSH_NO_EXTERNAL_CAT		omit hack to skip cat builtin when flags passed
MKSH_NO_LIMITS			omit ulimit code
MKSH_SMALL			omit some code, optimise hard for size (slower)
MKSH_S_NOVI			disable Vi editing mode (default if MKSH_SMALL)
MKSH_UNEMPLOYED			disable job control (but not jobs/co-processes)

=== generic installation instructions ===

Set CC and possibly CFLAGS, CPPFLAGS, LDFLAGS, LIBS. If cross-compiling,
also set TARGET_OS. To disable tests, set e.g. HAVE_STRLCPY=0; to enable
them, set to a value other than 0 or 1. Ensure /bin/ed is installed. For
MKSH_SMALL but with Vi mode, add -DMKSH_S_NOVI=0 to CPPFLAGS as well.

Normally, the following command is what you want to run, then:
$ (sh Build.sh -r -c lto && ./test.sh -v) 2>&1 | tee log

Copy dot.mkshrc to /etc/skel/.mkshrc; install mksh into $prefix/bin; or
/bin; install the manpage, if omitting the -r flag a catmanpage is made
using $NROFF. Consider using a forward script as /etc/skel/.mkshrc like
https://www.mirbsd.org/cvs.cgi/contrib/hosted/tg/deb/mksh/debian/.mkshrc?rev=HEAD
and put dot.mkshrc as /etc/mkshrc so users need not keep up their HOME.

EOD
@


1.484.2.7
log
@MFC
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.6 2011/12/04 19:59:37 tg Exp $'
a1155 3
ac_ifcpp 'ifdef MKSH_DISABLE_DEPRECATED' isset_MKSH_DISABLE_DEPRECATED '' \
    "if deprecated features are to be omitted" && \
    check_categories="$check_categories nodeprecated"
d1191 1
a1191 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.6 2011/12/04 19:59:37 tg Exp $");
d1695 4
a1698 16
		if [[ \$perli = no ]]; then
			print Cannot find a working Perl interpreter, aborting.
			exit 1
		fi
		print "Trying Perl interpreter '\$perli'..."
		perlos=\$(\$perli -e "\$cstr")
		rv=\$?
		print "Errorlevel \$rv, running on '\$perlos'"
		if (( rv )); then
			print "=> not using"
			continue
		fi
		if [[ -n \$perlos ]]; then
			print "=> using it"
			break
		fi
@


1.484.2.8
log
@MFC all those nice things (not all parts, by now); sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.501 2011/12/31 02:04:16 tg Exp $'
d150 1
a150 1
ac_testnnd() {
a175 3
}
ac_testn() {
	ac_testnnd "$@@"
d689 1
a689 1
	# one of these two works, for now
a690 1
	vv '|' "${CLANG-clang} --version"
d971 1
d976 2
a977 2
	# probably not needed
	#ac_flags 1 agcc -Agcc 'for support of GCC extensions'
d988 1
d1000 2
d1021 3
d1194 1
a1194 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.501 2011/12/31 02:04:16 tg Exp $");
a1558 55
# runtime checks
# once this is more than one, check if we can do runtime
# checks (not cross-compiling) first to save on warnings
#
$e "${bi}run-time checks follow$ao, please ignore any weird errors"

ac_testnnd silent_idivwrapv '' '(run-time) whether signed integer division overflows wrap silently' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	#ifdef SIGFPE
	static void fpe_catcher(int) MKSH_A_NORETURN;
	#endif
	int main(int ac, char **av) {
		mksh_ari_t o1, o2, r1, r2;

	#ifdef SIGFPE
		signal(SIGFPE, fpe_catcher);
	#endif
		o1 = ((mksh_ari_t)1 << 31);
		o2 = -ac;
		r1 = o1 / o2;
		r2 = o1 % o2;
		if (r1 == o1 && r2 == 0) {
			printf("si");
			return (0);
		}
		printf("no %d %d %d %d %s", o1, o2, r1, r2, av[0]);
		return (1);
	}
	#ifdef SIGFPE
	static const char fpe_msg[] = "no, got SIGFPE, what were they smoking?";
	static void fpe_catcher(int sig MKSH_A_UNUSED) {
		write(1, fpe_msg, sizeof(fpe_msg) - 1);
		_exit(2);
	}
	#endif
EOF
if test $fv = 0; then
	echo "| hrm, compiling this failed, but we will just failback"
else
	echo "| running test programme; this will fail if cross-compiling"
	echo "| in which case we will gracefully degrade to the default"
	./$tcfn >vv.out 2>&1
	rv=$?
	echo "| result: `cat vv.out`"
	fv=0
	test $rv = 0 && test x"`cat vv.out`" = x"si" && fv=1
fi
rmf conftest.c conftest.o ${tcfn}* vv.out
ac_testdone
ac_cppflags

$e "${bi}end of run-time checks$ao"

#
@


1.484.2.9
log
@bunch of warning fixes
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.8 2011/12/31 02:25:21 tg Exp $'
d1191 1
a1191 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.8 2011/12/31 02:25:21 tg Exp $");
a1586 1
	#define fpe_msglen (sizeof(fpe_msg) - 1)
d1588 2
a1589 1
		_exit(write(1, fpe_msg, fpe_msglen) == fpe_msglen ? 2 : 3);
@


1.484.2.10
log
@MFC pending stuff into mksh R40-stable branch
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.508 2012/01/04 08:56:27 tg Exp $'
d4 1
a4 2
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
#		2011, 2012
d458 1
a458 1
	add_cppflags -DMKSH_ASSUME_UTF8; HAVE_ISSET_MKSH_ASSUME_UTF8=1
a492 1
	add_cppflags -DMKSH_ASSUME_UTF8=0; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d516 1
a516 1
	add_cppflags -DMKSH_ASSUME_UTF8; HAVE_ISSET_MKSH_ASSUME_UTF8=1
d1012 1
a1012 1
	: #broken# ac_flags 1 boundschk -b
d1017 1
a1017 1
	: #broken# ac_flags 1 ssp -stackprotect
d1179 45
a1309 45
# check whether whatever we use for the final link will succeed
#
if test $cm = makefile; then
	: nothing to check
else
	HAVE_LINK_WORKS=x
	ac_testinit link_works '' 'checking if the final link command may succeed'
	fv=1
	cat >conftest.c <<-'EOF'
		#define EXTERN
		#define MKSH_INCLUDES_ONLY
		#include "sh.h"
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.508 2012/01/04 08:56:27 tg Exp $");
		int main(void) { printf("Hello, World!\n"); return (0); }
EOF
	case $cm in
	llvm)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -emit-llvm -c conftest.c" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.o | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	dragonegg)
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -S -flto conftest.c" || fv=0
		test $fv = 0 || v "mv conftest.s conftest.ll"
		test $fv = 0 || v "llvm-as conftest.ll" || fv=0
		rmf mksh.s
		test $fv = 0 || v "llvm-link -o - conftest.bc | opt $optflags | llc -o mksh.s" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn mksh.s $LIBS $ccpr"
		;;
	combine)
		v "$CC $CFLAGS $CPPFLAGS $LDFLAGS -fwhole-program --combine $NOWARN -o $tcfn conftest.c $LIBS $ccpr"
		;;
	lto|normal)
		cm=normal
		v "$CC $CFLAGS $CPPFLAGS $NOWARN -c conftest.c" || fv=0
		test $fv = 0 || v "$CC $CFLAGS $LDFLAGS -o $tcfn conftest.o $LIBS $ccpr"
		;;
	esac
	test -f $tcfn || fv=0
	ac_testdone
	test $fv = 1 || exit 1
fi

#
d1507 1
a1507 1
test x1 = x$HAVE_CAN_WNOOVERFLOW && CFLAGS="$CFLAGS -Wno-overflow"
a1697 4
case $tcfn in
a.exe)	mkshexe=mksh.exe ;;
*)	mkshexe=mksh ;;
esac
d1699 2
a1700 2
*\ *)	echo "#!./$mkshexe" >test.sh ;;
*)	echo "#!$curdir/$mkshexe" >test.sh ;;
d1706 1
a1706 1
	pflag='$curdir/$mkshexe'
d1802 4
@


1.484.2.11
log
@MFC the Build.sh bugfix and the SkyOS and Minix stuff
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.10 2012/02/11 15:25:26 tg Exp $'
d158 1
a158 1
	ac_testinit "$@@" || return 1
a176 1
	return 0
d179 1
a179 1
	ac_testnnd "$@@" || return
d295 1
a295 1
rmf a.exe* a.out* conftest.c *core core.* lft mksh* no *.bc *.ll *.o \
a410 41
# Evil OS
if test x"$TARGET_OS" = x"Minix"; then
	echo >&2 "
WARNING: additional checks before running Build.sh required!
You can avoid these by calling Build.sh correctly, see below.
"
	cat >conftest.c <<'EOF'
#include <sys/types.h>
#ifdef _NETBSD_SOURCE
ct=Ninix3
#else
ct=Minix3
#endif
EOF
	ct=unknown
	vv ']' "${CC-cc} -E $CFLAGS $CPPFLAGS $NOWARN conftest.c | grep ct= | tr -d \\\\015 >x"
	sed 's/^/[ /' x
	eval `cat x`
	rmf x vv.out
	case $ct in
	Minix3|Ninix3)
		echo >&2 "
Warning: you set TARGET_OS to $TARGET_OS but that is ambiguous.
Please set it to either Minix3 or Ninix3, whereas the latter is
all versions of Minix with even partial NetBSD(R) userland. The
value determined from your compiler for the current compilation
(which may be wrong) is: $ct
"
		TARGET_OS=$ct
		;;
	*)
		echo >&2 "
Warning: you set TARGET_OS to $TARGET_OS but that is ambiguous.
Please set it to either Minix3 or Ninix3, whereas the latter is
all versions of Minix with even partial NetBSD(R) userland. The
proper value couldn't be determined, continue at your own risk.
"
		;;
	esac
fi

d483 1
a483 1
Minix3)
a501 8
Ninix3)
	# similar to Minix3
	add_cppflags -DMKSH_UNEMPLOYED
	add_cppflags -DMKSH_CONSERVATIVE_FDS
	add_cppflags -DMKSH_NO_LIMITS
	# but no idea what else could be needed
	oswarn="; it has unknown issues"
	;;
a535 3
skyos)
	oswarn="; it has minor issues"
	;;
d1279 1
a1279 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.10 2012/02/11 15:25:26 tg Exp $");
d1564 1
a1564 1
if ac_testnnd silent_idivwrapv '' '(run-time) whether signed integer division overflows wrap silently' <<-'EOF'
d1595 10
a1604 14
then
	if test $fv = 0; then
		echo "| hrm, compiling this failed, but we will just failback"
	else
		echo "| running test programme; this will fail if cross-compiling"
		echo "| in which case we will gracefully degrade to the default"
		./$tcfn >vv.out 2>&1
		rv=$?
		echo "| result: `cat vv.out`"
		fv=0
		test $rv = 0 && test x"`cat vv.out`" = x"si" && fv=1
	fi
	rmf conftest.c conftest.o ${tcfn}* vv.out
	ac_testdone
d1606 2
@


1.484.2.12
log
@ MFC almost everything not breaking backwards compatibility or introducing
  deep changes into R40-stable branch
 Version accordingly: HEAD gets 2012/03/24 (hi Eddy/Chris) so we backdate
  $KSH_VERSION for R40-stable to 2012/03/20 (hi David) as that comes before
  even though it includes todays latest fixes
 Also, sync clog (including MFC indicators)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.11 2012/03/03 21:41:37 tg Exp $'
d1171 1
a1171 1
	# removed in R41
d1332 1
a1332 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.11 2012/03/03 21:41:37 tg Exp $");
@


1.484.2.13
log
@MFC fixes from HEAD
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.539 2012/04/06 13:25:51 tg Exp $'
a30 11
if test -n "${ZSH_VERSION+x}" && (emulate sh) >/dev/null 2>&1; then
	emulate sh
	NULLCMD=:
fi

if test -d /usr/xpg4/bin/. >/dev/null 2>&1; then
	# Solaris: some of the tools have weird behaviour, use portable ones
	PATH=/usr/xpg4/bin:$PATH
	export PATH
fi

d57 11
a265 1
	echo "/* NeXTstep bug workaround */" >x
d299 2
a300 2
curdir=`pwd` srcdir=`dirname "$0" 2>/dev/null` check_categories=
test -n "$srcdir" || srcdir=. # in case dirname does not exist
a301 1
add_cppflags -DMKSH_BUILDSH
a419 1
const char *
d421 1
a421 1
ct="Ninix3"
d423 1
a423 1
ct="Minix3"
a424 1
;
d455 1
a455 4
NEXTSTEP)
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`hostinfo 2>&1 | sed -n '/^.*NeXT Mach \([0-9.]*\):.*$/s//\1/p'`
	;;
QNX|SCO_SV)
d467 1
a467 11
	case $KSH_VERSION in
	*MIRBSD\ KSH*)
		oswarn="; it has minor issues"
		;;
	*)
		oswarn="; you must recompile mksh with"
		oswarn="$oswarn${nl}itself in a second stage"
		;;
	esac
	# BeOS has no real tty either
	add_cppflags -DMKSH_UNEMPLOYED
a543 13
NEXTSTEP)
	add_cppflags -D_NEXT_SOURCE
	add_cppflags -D_POSIX_SOURCE
	: ${AWK=gawk} ${CC=cc -posix}
	# NeXTstep cannot get a controlling tty
	add_cppflags -DMKSH_UNEMPLOYED
	case $TARGET_OSREV in
	4.2*)
		# OpenStep 4.2 is broken by default
		oswarn="; it needs libposix.a"
		;;
	esac
	;;
a585 16
SCO_SV)
	case $TARGET_OSREV in
	3.2*)
		# SCO OpenServer 5
		add_cppflags -DMKSH_UNEMPLOYED
		;;
	5*)
		# SCO OpenServer 6
		;;
	*)
		oswarn='; this is an unknown version of'
		oswarn="$oswarn$nl$TARGET_OS ${TARGET_OSREV}, please tell me what to do"
		;;
	esac
	: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
	;;
a601 4
UnixWare|UNIX_SV)
	# SCO UnixWare
	: ${HAVE_SYS_SIGLIST=0} ${HAVE__SYS_SIGLIST=0}
	;;
a611 1
	test x"$TARGET_OSREV" = x"" && TARGET_OSREV=`uname -r`
d617 1
a617 1
: ${AWK=awk} ${CC=cc} ${NROFF=nroff}
a639 4
SCO_SV|UnixWare|UNIX_SV)
	vv '|' "uname -a >&2"
	vv '|' "uname -X >&2"
	;;
d650 1
a650 1
$e "$bi$me: Building the MirBSD Korn Shell$ao $ui$dstversion$ao on $TARGET_OS ${TARGET_OSREV}..."
a667 1
const char *
d669 1
a669 1
ct="icc"
d671 1
a671 1
ct="xlc"
d673 1
a673 1
ct="sunpro"
d675 1
a675 1
ct="ack"
d677 1
a677 1
ct="bcc"
d679 1
a679 1
ct="watcom"
d681 1
a681 1
ct="metrowerks"
d683 1
a683 1
ct="hpcc"
d685 1
a685 1
ct="dec"
d687 1
a687 1
ct="pgi"
d689 1
a689 1
ct="dmc"
d691 1
a691 1
ct="msc"
d693 1
a693 1
ct="adsp"
d695 1
a695 1
ct="iar"
d697 1
a697 1
ct="sdcc"
d699 1
a699 1
ct="pcc"
d701 1
a701 1
ct="tendra"
d703 1
a703 1
ct="tcc"
d705 1
a705 1
ct="clang"
d707 1
a707 1
ct="nwcc"
d709 1
a709 1
ct="gcc"
d711 1
a711 1
ct="mipspro"
d713 1
a713 1
ct="mipspro"
d715 1
a715 1
ct="hpcc"
d717 1
a717 3
ct="ucode"
#elif defined(__USLC__)
ct="uslc"
d719 1
a719 1
ct="unknown"
a720 1
;
d722 2
a723 2
ct=untested
vv ']' "$CPP $CFLAGS $CPPFLAGS $NOWARN conftest.c | sed -n '/^ct *= */s//ct=/p' | tr -d \\\\015 >x"
a841 10
uslc)
	case $TARGET_OS:$TARGET_OSREV in
	SCO_SV:3.2*)
		# SCO OpenServer 5
		CFLAGS="$CFLAGS -g"
		: ${HAVE_CAN_OTWO=0} ${HAVE_CAN_OPTIMISE=0}
		;;
	esac
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
	;;
a852 1
	test x"$ct" = x"untested" && $e "!!! detecting preprocessor failed"
a853 3
	vv "$CC --version"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v conftest.c $LIBS"
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V conftest.c $LIBS"
a899 1
	HAVE_COMPILER_KNOWN=1
d1332 1
a1332 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.539 2012/04/06 13:25:51 tg Exp $");
d1396 8
a1403 1
ac_test flock <<-'EOF'
d1405 4
a1408 12
	#undef flock
	int main(void) { return (flock(0, LOCK_EX | LOCK_UN)); }
EOF

ac_test lock_fcntl '!' flock 1 'whether we can lock files with fcntl' <<-'EOF'
	#include <fcntl.h>
	#undef flock
	int main(void) {
		struct flock lks;
		lks.l_type = F_WRLCK | F_UNLCK;
		return (fcntl(0, F_SETLKW, &lks));
	}
a1442 14
ac_test mmap lock_fcntl 0 'for mmap and munmap' <<-'EOF'
	#include <sys/types.h>
	#if HAVE_SYS_FILE_H
	#include <sys/file.h>
	#endif
	#if HAVE_SYS_MMAN_H
	#include <sys/mman.h>
	#endif
	#include <stdlib.h>
	int main(void) { return ((void *)mmap(NULL, (size_t)0,
	    PROT_READ, MAP_PRIVATE, 0, (off_t)0) == (void *)NULL ? 1 :
	    munmap(NULL, 0)); }
EOF

d1510 12
d1533 1
a1533 1
ac_test '!' flock_decl flock 1 'if flock() does not need to be declared' <<-'EOF'
d1545 1
a1545 1
ac_test '!' sys_siglist_decl sys_siglist 1 'if sys_siglist[] does not need to be declared' <<-'EOF'
d1548 1
a1548 2
	extern int sys_siglist[5][5][5][5][5];	/* this clashes happily */
	int main(void) { return (sys_siglist[0][0][0][0][0]); }
d1556 1
a1556 3
ac_cache PERSISTENT_HISTORY || case $HAVE_MMAP$HAVE_FLOCK$HAVE_LOCK_FCNTL in
11*|101) fv=1 ;;
esac
d1637 1
a1637 2
		printf("no %d %d %d %d %s", (int)o1, (int)o2, (int)r1,
		    (int)r2, av[0]);
d1697 1
a1697 2
	sigseenone=:
	sigseentwo=:
d1706 1
a1706 3
int
mksh_cfg= NSIG
;' >conftest.c
d1708 1
a1708 1
	    sed -n '/^mksh_cfg *=[	 ]*\([0-9x ()+-]*\).*$/s//\1/p'`
d1710 1
a1710 1
	*[\ \(\)+-]*) NSIG=`"$AWK" "BEGIN { print $NSIG }"` ;;
d1716 2
a1717 2
	sigs="INT SEGV ABRT KILL ALRM BUS CHLD CLD CONT DIL EMT FPE HUP ILL"
	sigs="$sigs INFO IO IOT LOST PIPE PROF PWR QUIT RESV SAK STOP SYS TERM"
a1724 4
		case $sigseenone in
		*:$name:*) continue ;;
		esac
		sigseenone=$sigseenone$name:
d1726 1
a1726 3
		echo int >>conftest.c
		echo mksh_cfg= SIG$name >>conftest.c
		echo ';' >>conftest.c
d1728 3
a1730 2
		    sed -n '/^mksh_cfg *=[	 ]*\([0-9x]*\).*$/s//\1:'$name/p
	done | sed -e '/^:/d' -e 's/:/ /g' | while read nr name; do
d1733 1
a1733 1
		case $sigseentwo in
d1736 1
a1736 1
			sigseentwo=$sigseentwo$nr:
a1748 1
add_cppflags -DMKSH_BUILD_R=406
d1760 2
a1761 2
*\ *)	mkshshebang="#!./$mkshexe" ;;
*)	mkshshebang="#!$curdir/$mkshexe" ;;
d1763 1
a1763 2
cat >test.sh <<-EOF
	$mkshshebang
d1838 1
a1838 2
echo "# work around NeXTstep bug" >Rebuild.sh
echo set -x >>Rebuild.sh
a1971 1
AWK				default: awk
@


1.484.2.14
log
@cant forget LynxOS, although its still preliminary
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.484.2.13 2012/04/06 14:40:08 tg Exp $'
a539 3
LynxOS)
	oswarn="; it has minor issues"
	;;
d1406 1
a1406 1
		__RCSID("$MirOS: src/bin/mksh/Build.sh,v 1.484.2.13 2012/04/06 14:40:08 tg Exp $");
@


1.483
log
@drop more long-deprecated things
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.482 2011/06/12 14:37:00 tg Exp $'
d34 1
a34 1
#			MKSH_NOPROSPECTOFWORK
@


1.482
log
@Minix 3 has no _setrlimit (XXX mirtoconf that in R41)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.481 2011/06/05 19:55:22 tg Exp $'
a328 4
	:-combine)
		cm=combine
		echo "$me: Warning: '$i' is deprecated, use '-c combine' instead!" >&2
		;;
a336 10
	:-llvm)
		cm=llvm
		optflags=-std-compile-opts
		echo "$me: Warning: '$i' is deprecated, use '-c llvm -O' instead!" >&2
		;;
	:-llvm=*)
		cm=llvm
		optflags=`echo "x$i" | sed 's/^x-llvm=//'`
		echo "$me: Warning: '$i' is deprecated, use '-c llvm -o $llvm' instead!" >&2
		;;
@


1.481
log
@TenDRA on Debian workaround
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.480 2011/06/05 18:23:43 tg Exp $'
d482 1
@


1.480
log
@automatically add -fplugin=dragonegg if not there
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.479 2011/06/05 18:16:19 tg Exp $'
d442 4
d447 1
a447 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -DNO_PATH_MAX"
d450 4
a453 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
d471 5
a475 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -DSETUID_CAN_FAIL_WITH_EAGAIN"
d1066 2
a1067 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
d1082 2
a1083 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
d1096 2
a1097 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
d1110 2
a1111 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
d1122 2
a1123 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
d1131 2
a1132 2
	#if defined(__GNUC__) && (__GNUC__ < 2)
	/* force a failure: gcc 1.42 has a false positive here */
@


1.479
log
@new "-c lto" (with fallback to "-c combine"), and catch build failures (lto broken, llc ENOENT, ) early
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.478 2011/05/29 16:31:38 tg Exp $'
d901 4
@


1.478
log
@ AIX: display OS version better (tested on 5.3 by cnuke@@)
 IBM XL C: display version better (tested on V7.0 by cnuke@@)
 do not 'IFS=: read nr name', Cygwin 1.7 dash fails it
 disable cd-pe, glob-range-3 on Cygwin (the former cannot
  succeed because the mv fails, the latter fails from 1.7 on)
 mark heredoc-tmpfile-8 as need-pass: no
 apply __attribute__ only to a function prototype, not to
  the body (even if static), since xlC fails that
 bump version to R40 (beta)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.477 2011/04/09 21:00:58 tg Exp $'
d221 1
a221 1
# ac_flags [-] add varname flags [text]
d233 1
d237 4
d250 3
d314 1
a314 1
	c:combine|c:dragonegg|c:llvm)
d901 36
a936 3
	test $cm = combine && ac_flags 0 combine \
	    '-fwhole-program --combine' \
	    'if gcc supports -fwhole-program --combine'
d1001 41
a1042 1

a1620 1
test $HAVE_CAN_COMBINE$cm = 0combine && cm=normal
@


1.477
log
@avoid namespace conflicts with __attribute__()
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.476 2011/04/09 15:14:51 tg Exp $'
d538 4
d761 1
d1456 1
a1456 1
	done | grep -v '^:' | while IFS=: read nr name; do
@


1.476
log
@ no longer use <stdbool.h> even if its available
 ensure that bool/true/false are cpp macros, overriding any pre-defined
 document the requirement that tobool(x) must map any-type 'x' into bool
 document the requirement that a bool must only be true or false, and
  that it (tobool() rather) must have an identity mapping to 'short'
 possibly fix ksh_func for/and fpFUNCTf  maybe spotted by cnuke@@
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.475 2011/03/28 21:15:04 tg Exp $'
d964 1
a964 1
ac_test attribute_bounded '' 'for __attribute__((bounded))' <<-'EOF'
d972 2
a973 2
	    __attribute__((bounded (buffer, 1, 3)))
	    __attribute__((bounded (buffer, 2, 3)));
d980 1
a980 1
ac_test attribute_format '' 'for __attribute__((format))' <<-'EOF'
d990 1
a990 1
	    __attribute__((format (printf, 2, 3)));
d994 1
a994 1
ac_test attribute_nonnull '' 'for __attribute__((nonnull))' <<-'EOF'
d999 3
a1001 3
	int foo(char *s1, char *s2) __attribute__((nonnull));
	int bar(char *s1, char *s2) __attribute__((nonnull (1, 2)));
	int baz(char *s) __attribute__((nonnull (1)));
d1008 1
a1008 1
ac_test attribute_noreturn '' 'for __attribute__((noreturn))' <<-'EOF'
d1015 1
a1015 1
	void fnord(void) __attribute__((noreturn));
d1020 1
a1020 1
ac_test attribute_unused '' 'for __attribute__((unused))' <<-'EOF'
d1025 2
a1026 2
	int main(int ac __attribute__((unused)), char **av
	    __attribute__((unused))) { return (0); }
d1029 1
a1029 1
ac_test attribute_used '' 'for __attribute__((used))' <<-'EOF'
d1034 1
a1034 1
	static const char fnord[] __attribute__((used)) = "42";
@


1.475
log
@ use mksh getopts to parse options in test.sh, collapse multiple -C args
 sort arguments
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.474 2011/03/16 20:26:33 tg Exp $'
a1100 1
ac_header stdbool.h
@


1.474
log
@ introduce a virtual TARGET_OS=Android that just sets a check category
  and switches to the TARGET_OS=Linux
 introduce android as regression test suite category
 add an android specific standard alias
 clean up redundant -o sh arg in a few checks
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.473 2011/03/16 20:03:21 tg Exp $'
d396 1
a396 1
	check_categories=$check_categories,android
d1068 1
a1068 1
	check_categories=$check_categories,smksh
d1073 1
a1073 1
    check_categories=$check_categories,binsh
d1076 1
a1076 1
    check_categories=$check_categories,arge
d1079 1
a1079 1
    check_categories=$check_categories,arge,nojsig
d1084 1
a1084 1
    check_categories=$check_categories,convfds
d1385 1
a1385 1
test 1 = $fv || check_categories=$check_categories,no-histfile
d1410 1
a1410 1
    check_categories=$check_categories,$oldish_ed
d1484 36
a1519 1
	check_categories=$check_categories
d1533 1
a1533 1
	exec \$perli '$srcdir/check.pl' -s '$srcdir/check.t' -p '$curdir/mksh' \${check_categories:+-C} \${check_categories#,} \$*$tsts
@


1.473
log
@__attribute__((format (printf, 1, 2))) and #define printf printfoo
dont play well with each other  Bionic uses the former, unlike most
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.472 2011/02/27 19:29:18 tg Exp $'
d394 6
@


1.472
log
@port to FreeMiNT: add OS uname and flags; 2>&- is evil; $UNIXMODE must be preserved; unlink(2) is weird
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.471 2011/02/11 00:49:03 tg Exp $'
d979 1
a979 1
	#define printf printfoo
d982 4
a985 4
	#undef printf
	extern int printf(const char *format, ...)
	    __attribute__((format (printf, 1, 2)));
	int main(int ac, char **av) { return (printf("%s%d", *av, ac)); }
@


1.471
log
@quell a warning when running with __CRAZY=Yes MKC_DEBG=cpp
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.470 2011/02/09 19:32:26 tg Exp $'
d422 5
d1488 1
a1488 1
		perlos=\$(\$perli -e "\$cstr") 2>&- || continue
@


1.470
log
@query for select(2) in preparation of sleep and read-with-timeout builtins; ualarm(3) and friends are too awkward to use so we ifdef these builtins on select support 
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.469 2011/01/30 02:18:19 tg Exp $'
d974 1
@


1.469
log
@Scan for existence of <sys/file.h> which is not ubiquitous; allows
klibc-mksh (despite no hope to get a signal of a job) persistent history
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.468 2011/01/30 01:35:29 tg Exp $'
d1077 1
a1077 1
ac_header sys/param.h
d1081 2
d1084 1
d1091 2
a1092 1
ac_header strings.h sys/types.h
d1285 26
@


1.468
log
@introduce MKSH_NOPROSPECTOFWORK which is like pdkshs JOB_SIGS in reverse, like MKSH_UNEMPLOYED is pdkshs JOBS in reverse; allows mksh to work (hah! no pun intended) with klibc (and possibly, Syllable Desktop and Plan 9) for now, until they fix their bugs
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.467 2011/01/29 19:07:15 tg Exp $'
d1078 1
d1210 1
d1212 1
@


1.467
log
@-DIN_MKSH is not used by anything
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.466 2011/01/21 20:51:56 tg Exp $'
d34 1
d1065 3
@


1.466
log
@use header only if found
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.465 2011/01/15 21:56:36 tg Exp $'
a1424 1
CPPFLAGS="$CPPFLAGS -DIN_MKSH"
@


1.465
log
@RT|Chatzilla said in #!/bin/mksh that MSYS probably does mksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.464 2010/12/12 14:06:35 tg Exp $'
d4 1
a4 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
d1206 1
d1208 1
@


1.464
log
@MKSH_SMALL need not imply !HAVE_REVOKE as default
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.463 2010/10/08 17:56:55 tg Exp $'
d457 4
@


1.463
log
@mknods now demoted and only used as special-case builtin, in MirBSD only
built for the installer, to save time, as the original OpenBSD hack wanted
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.462 2010/10/01 19:04:35 tg Exp $'
a1049 1
	: ${HAVE_REVOKE=0}
@


1.462
log
@ Build.sh: fix a compiler warning which, had it not been irrelevant in
  a mirtoconf check, wouldve been a real problem on an LP64 platform
 sh.h: work around a bad interaction between -Wformat on gcc and manual
  string pooling for T_synerr, which is used in place of a format string
  in some places
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.461 2010/09/14 21:26:04 tg Exp $'
d513 2
a1048 1
	: ${HAVE_MKNOD=0}
a1268 14
ac_test setmode mknod 1 <<-'EOF'
	/* XXX imake style */
	/* XXX conditions correct? */
	#if defined(__MSVCRT__) || defined(__CYGWIN__)
	/* force a failure: Win32 setmode() is not what we want... */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	#include <sys/types.h>
	#include <unistd.h>
	int main(int ac, char *av[]) { return (getmode(setmode(av[0]),
	    (mode_t)ac)); }
	#endif
EOF

a1412 1
addsrcs '!' HAVE_SETMODE setmode.c
@


1.461
log
@ Address concerns of Chris Palmer from the Android security team
   possible integer overflows in memory allocation, mostly
     multiplication: all are checked now
     addition: reviewed them, most were proven or guessed to be
      almost impossible to run over (e.g. when we have a string
      whose length is taken it is assumed that the length will be
      more than only a few bytes below SIZE_MAX, since code and
      stack have to fit); some are checked now (e.g. when one of
      the summands is an off_t); most of the unchecked ones are
      annotated now
     cost (MirBSD/i386 static): +76 .text
     cost (Debian sid/i386): +779 .text  -4 .data
   on Linux targets, setuid() setresuid() setresgid() can fail
    with EAGAIN; check for that and, if so, warn once and retry
    infinitely (other targets to be added later once we know that
    they are insane)
     cost (Debian sid/i386): +192 .text (includes .rodata)
 setmode.c: Do overflow checking for realloc() too; switch back
  from calloc() to a checked malloc() for simplification while there
 define -DIN_MKSH and let setmode.c look a tad nicer while here
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.460 2010/09/14 21:15:09 tg Exp $'
d1140 1
a1140 1
	int main(void) { return ((int)(ptrdiff_t)(sig_t)kill(0,0)); }
d1147 1
a1147 1
	int main(void) { return ((int)(ptrdiff_t)(sighandler_t)kill(0,0)); }
d1158 1
a1158 1
	int main(void) { return ((int)(ptrdiff_t)(__sighandler_t)kill(0,0)); }
@


1.460
log
@add size optimisation hacks by me from Android except ifdefd
(note, Id prefer everyone to keep IDSTRINGs around though)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.459 2010/08/24 15:46:06 tg Exp $'
d444 1
a444 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
a1429 1
test 0 = "$HAVE_SETMODE" && CPPFLAGS="$CPPFLAGS -DHAVE_CONFIG_H -DCONFIG_H_FILENAME=\\\"sh.h\\\""
d1434 1
@


1.459
log
@avoid more compiler warnings in mirtoconf phase
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.458 2010/08/24 15:19:52 tg Exp $'
d33 1
@


1.458
log
@its ugly to write a ./stdint.h file if we can instead define the
types from sh.h; sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.457 2010/08/15 00:43:55 tg Exp $'
d1107 2
a1108 1
	int main(int ac, char **av) { return ((uint32_t)*av + (int32_t)ac); }
d1112 2
a1113 1
	int main(int ac, char **av) { return ((u_int32_t)*av + (int32_t)ac); }
d1117 2
a1118 1
	int main(int ac, char **av) { return ((uint8_t)av[ac]); }
d1122 2
a1123 1
	int main(int ac, char **av) { return ((u_int8_t)av[ac]); }
@


1.457
log
@u_int32_t was only ever needed for OpenBSDs pre-ISO-C arc4random API
since we dont have that any longer, nuke it
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.456 2010/08/15 00:41:05 tg Exp $'
d287 1
a287 1
    Rebuild.sh signames.inc stdint.h test.sh x vv.out
d1072 1
d1077 1
a1078 1
ac_header grp.h sys/types.h
a1081 29
ac_header '!' stdint.h stdarg.h
ac_testn can_inttypes '!' stdint_h 1 "for standard 32-bit integer types" <<-'EOF'
	#include <sys/types.h>
	int main(int ac, char **av) { return ((uint32_t)*av + (int32_t)ac); }
EOF
ac_testn can_ucbints '!' can_inttypes 1 "for UCB 32-bit integer types" <<-'EOF'
	#include <sys/types.h>
	int main(int ac, char **av) { return ((u_int32_t)*av + (int32_t)ac); }
EOF
ac_testn can_int8type '!' stdint_h 1 "for standard 8-bit integer type" <<-'EOF'
	#include <sys/types.h>
	int main(int ac, char **av) { return ((uint8_t)av[ac]); }
EOF
ac_testn can_ucbint8 '!' can_int8type 1 "for UCB 8-bit integer type" <<-'EOF'
	#include <sys/types.h>
	int main(int ac, char **av) { return ((u_int8_t)av[ac]); }
EOF
case $HAVE_CAN_INTTYPES$HAVE_CAN_UCBINTS in
01)	echo 'typedef u_int32_t uint32_t;' >>stdint.h ;;
00)	echo 'typedef signed int int32_t;' >>stdint.h
	echo 'typedef unsigned int uint32_t;' >>stdint.h ;;
esac
case $HAVE_CAN_INT8TYPE$HAVE_CAN_UCBINT8 in
01)	echo 'typedef u_int8_t uint8_t;' >>stdint.h ;;
00)	echo 'typedef unsigned char uint8_t;' >>stdint.h ;;
esac
test -f stdint.h && HAVE_STDINT_H=1
ac_cppflags STDINT_H

d1105 17
@


1.456
log
@Tonnerre says his Linux 1.2 doesnt have uint8_t, so check for it
and provide if necessary
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.455 2010/07/18 17:29:49 tg Exp $'
d1099 1
a1099 2
01)	HAVE_U_INT32_T=1
	echo 'typedef u_int32_t uint32_t;' >>stdint.h ;;
a1173 9
ac_testn u_int32_t <<-'EOF'
	#include <sys/types.h>
	#if HAVE_STDINT_H
	#include <stdint.h>
	#endif
	int main(void) { return ((int)(u_int32_t)0); }
EOF
test 1 = $HAVE_U_INT32_T || CPPFLAGS="$CPPFLAGS -Du_int32_t=uint32_t"

@


1.455
log
@new MKSH_A4PB cppflag: force use of arc4random_pushb(3) during seeding
just the way sysctl KERN_ARND currently is used on OpenBSD/MirBSD (for
manual packager overrides only, no mirtoconf check; e.g. for Cygwin)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.454 2010/07/04 17:45:10 tg Exp $'
d1090 8
d1104 4
@


1.454
log
@implement live SIGWINCH handling in the Emacs editing mode
for winstonw from IRC #!/bin/mksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.453 2010/07/04 17:33:53 tg Exp $'
d32 1
a32 1
#			MKSH_DEFAULT_TMPDIR MKSH_CLRTOEOL_STRING
@


1.453
log
@to speed up mksh, get rid of arc4random(3) uses and use the LCG always;
depend on ASLR for seeding
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.452 2010/05/13 18:41:13 tg Exp $'
d32 1
a32 1
#			MKSH_DEFAULT_TMPDIR
@


1.452
log
@ deprecate -longoptions in favour of short options
   -combine  -c combine
   -llvm  -c llvm -O
   -llvm=x  -c llvm -o x
   -valgrind  -g
 new option -v (version)
 new options -c (compile mode), -o (opt flags), -O (reset opt flags)
 opt flags default to -std-compile-opts (llvm) now
 support the LLVM dragonegg plugin for GCC
 sync list of removed files (*.bc, *.ll, add missing Rebuild.sh)

 old options still valid but emit a warning
 except this one
 compile modes are:
   normal
   makefile (-M)
   combine (old -combine, new -c combine)
   dragonegg (new -c dragonegg)
   llvm (old -llvm, old -llvm=*, new -c llvm)
  the first two are not settable via -c though
 sample use:
  tg@@seduxbox:~/x$ export PATH=$PATH:/opt/llvm/bin
  tg@@seduxbox:~/x$ CC='/opt/gcc-4.5.1/bin/gcc-4.5.1 -fplugin=/opt/llvm/lib/dragonegg.so' sh ../mksh/Build.sh -c dragonegg -r

Thanks to dileX:#grml for giving ssh access.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.451 2010/04/20 17:28:20 tg Exp $'
a1202 45
ac_testn arc4random <<-'EOF'
	#include <sys/types.h>
	#if HAVE_STDINT_H
	#include <stdint.h>
	#endif
	extern u_int32_t arc4random(void);
	int main(void) { return ((int)(arc4random() & 0xFF)); }
EOF

save_LIBS=$LIBS
if test 0 = $HAVE_ARC4RANDOM; then
	test -f arc4random.c || if test -f "$srcdir/arc4random.c"; then
		# ensure isolation of source directory from build directory
		cp "$srcdir/arc4random.c" .
	fi
	if test -f arc4random.c; then
		ac_testn can_uint8t '' "for uint8_t" <<-'EOF'
			#include <sys/types.h>
			#if HAVE_STDINT_H
			#include <stdint.h>
			#endif
			int main(void) { return (1 - (uint8_t)1); }
		EOF
		test $HAVE_CAN_UINT8T = 1 || \
		    CPPFLAGS="$CPPFLAGS -D\"uint8_t=unsigned char\""

		ac_header sys/sysctl.h
		addsrcs '!' HAVE_ARC4RANDOM arc4random.c
		HAVE_ARC4RANDOM=1
		LIBS="$LIBS arc4random.c"
	fi
fi
ac_cppflags ARC4RANDOM

ac_test arc4random_pushb arc4random 0 <<-'EOF'
	#include <sys/types.h>
	#if HAVE_STDINT_H
	#include <stdint.h>
	#endif
	extern uint32_t arc4random_pushb(void *, size_t);
	int main(int ac, char *av[]) { return ((int)(arc4random_pushb(*av,
	    (size_t)ac)) & 0xFF); }
EOF
LIBS=$save_LIBS

a1323 12
ac_test '!' arc4random_decl arc4random 1 'if arc4random() does not need to be declared' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	long arc4random(void);		/* this clashes if defined before */
	int main(void) { return ((int)arc4random()); }
EOF
ac_test '!' arc4random_pushb_decl arc4random_pushb 1 'if arc4random_pushb() does not need to be declared' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int arc4random_pushb(char, int); /* this clashes if defined before */
	int main(int ac, char *av[]) { return ((int)arc4random_pushb(**av, ac)); }
EOF
@


1.451
log
@add MKSH_DEFAULT_TMPDIR
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.450 2010/03/30 13:29:03 tg Exp $'
d286 2
a287 2
rmf a.exe* a.out* conftest.c *core lft mksh* no *.o \
    signames.inc stdint.h test.sh x vv.out
d291 1
d298 2
a299 1
llvm=
d303 15
a317 3
	case $i in
	-j)
		pm=1
d319 1
a319 1
	-combine)
d321 1
d323 9
a331 1
	-llvm)
d333 2
a334 1
		llvm=-std-compile-opts
d336 1
a336 1
	-llvm=*)
d338 2
a339 1
		llvm=`echo "x$i" | sed 's/^x-llvm=//'`
d341 1
a341 1
	-M)
d344 7
a350 1
	-Q)
d353 1
a353 1
	-r)
d356 8
a363 3
	-valgrind)
		CPPFLAGS="$CPPFLAGS -DDEBUG"
		CFLAGS="$CFLAGS -g3 -fno-builtin"
d366 1
a366 1
		echo "$me: Unknown option '$i'!" >&2
d371 4
a516 1
dstversion=`sed -n '/define MKSH_VERSION/s/^.*"\(.*\)".*$/\1/p' $srcdir/sh.h`
d745 5
a749 1
test $cm = llvm && vv '|' "llc -version"
d1526 2
d1533 1
a1533 2
	of=`echo x"$file" | sed 's/^x\(.*\)\.c$/\1.o/'`
	objs="$objs$sp$of"
d1538 7
d1546 2
a1547 1
if test $cm = llvm; then
d1549 1
a1549 1
	echo "llvm-link -o - $objs | opt $llvm | llc -o mksh.s" >>Rebuild.sh
d1551 2
a1552 1
else
d1554 2
a1555 1
fi
d1621 2
d1625 4
d1631 2
a1632 1
if test $cm = llvm; then
d1634 3
a1636 2
	v "llvm-link -o - $objs | opt $llvm | llc -o mksh.s"
fi
@


1.450
log
@newer SUNWcc has different error messages 
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.449 2010/03/27 20:36:25 tg Exp $'
d32 1
@


1.449
log
@allow MKSHRC_PATH to change from "~/.mkshrc", for Android &c.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.448 2010/03/27 15:32:58 tg Exp $'
d179 1
a179 1
		test $ct = sunpro && vscan='ignored'
d181 1
a181 1
	test -n "$vscan" && grep "$vscan" vv.out >/dev/null 2>&1 && fv=$fr
@


1.448
log
@disable BGNICE by default for MKSH_SMALL
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.447 2010/03/27 15:28:59 tg Exp $'
d31 1
a31 1
#			MKSH_UNEMPLOYED MKSH_DEFAULT_EXECSHELL
@


1.447
log
@make MKSH_DEFAULT_EXECSHELL (/bin/sh) configurable, for Android
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.446 2010/03/14 11:58:29 tg Exp $'
d1003 1
@


1.446
log
@even better on Haiku:
* let ulimits work
* add a Haiku-specific ulimit
* always use UTF-8, they have no locales but a UTF-8 terminal
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.445 2010/03/14 11:56:07 tg Exp $'
d31 1
a31 1
#			MKSH_UNEMPLOYED
@


1.445
log
@work when there is no dirname(1), e.g. 4.3 BSD Quasijarus VAX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.444 2010/03/01 08:57:45 tg Exp $'
d364 1
a364 1
BeOS|Haiku)
d386 3
@


1.444
log
@now, skip LDFLAGS and LIBS when using $CPP _for real_ this time
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.443 2010/02/23 22:02:35 tg Exp $'
d289 1
@


1.443
log
@here no LDFLAGS, LIBS (for cpp)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.441 2010/02/18 17:21:19 tg Exp $'
d1366 1
a1366 1
	vv ']' "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -dD conftest.c $LIBS >x"
d1400 1
a1400 1
	NSIG=`vq "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN conftest.c $LIBS" | \
d1413 1
a1413 1
	    "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -dD conftest.c $LIBS" | \
d1420 1
a1420 1
		vq "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN conftest.c $LIBS" | \
@


1.442
log
@(semi-tested) clean up removing; prevent accidental rm of mksh.1
@
text
@d570 1
a570 2
vv ']' "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN conftest.c $LIBS | \
    grep ct= | tr -d \\\\015 >x"
@


1.441
log
@no longer pull in libcrypt on AIX, only Interix (where it has arc4random)
tested by cnuke@@  10x
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.440 2010/02/16 23:53:28 tg Exp $'
d53 9
d182 1
a182 1
	rm -f conftest.c conftest.o ${tcfn}* vv.out
d262 1
a262 1
	rm -f x
d285 2
a286 2
rm -f a.exe* a.out* *core lft mksh mksh.cat1 mksh.exe mksh.s \
    no *.o conftest.c signames.inc stdint.h test.sh x vv.out
d348 1
a348 1
ccpr='|| rm -f ${tcfn}*'
d574 1
a574 1
rm -f x vv.out
d704 1
a704 1
rm -f conftest.c conftest.o conftest a.out* a.exe* vv.out
d800 1
a800 1
	rm -f x
d859 1
a859 1
	rm -f x
d1069 1
a1069 1
rm -f lft.c lft.o	# end of large file support test
d1369 1
a1369 1
	rm -f conftest.c x vv.out
d1383 1
a1383 1
rm -f x vv.out
d1435 1
a1435 1
	rm -f conftest.c
d1567 1
a1567 1
	rm -f mksh.s
d1574 1
a1574 1
    rm -f mksh.cat1
@


1.440
log
@revert 1.371 and just tell people to whitelist conftest.c
now that we use the same name as quiet-by-design autoconf
to please ccache anyway (and no we will not become quiet,
I can't usually get my hand on a buildd's conftest.log)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.439 2010/01/28 19:46:53 tg Exp $'
d276 1
a276 1
rm -f a.exe* a.out* *core crypt.exp lft mksh mksh.cat1 mksh.exe mksh.s \
a351 8
	if test x"$LDFLAGS" = x""; then
		LDFLAGS="${ccpl}-bI:crypt.exp"
		echo '#!
__crypt_r
__encrypt_r
__setkey_r' >crypt.exp
	fi
	: ${LIBS='-lcrypt'}
@


1.439
log
@place -xipo check at right position
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.438 2010/01/28 17:03:22 tg Exp $'
d22 3
d156 1
a156 3
	vv ']' \
	    "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN conftest.c $LIBS $ccpr" | \
	    sed 's^\] conftest.c:\([0-9]*\):\] mirtoconf(\1):'
@


1.438
log
@provide -valgrind Build.sh option which defines -g3 -DDEBUG -fno-builtin;
the latter is required to work around gccs strlen() reading past end of
buffer (multi-byte reads)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.437 2010/01/28 15:12:34 tg Exp $'
a798 3
	phase=u
	ac_flags 1 ipo -xipo 'for cross-module optimisation'
	phase=x
d830 1
d833 2
@


1.437
log
@check for -xipo on SUNWcc (needs -xO4 though, which I refuse to enable
automatically)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.436 2010/01/25 12:16:04 tg Exp $'
d313 4
@


1.436
log
@use conftest.c ipv scn.c since thats recognised by at least ccache as magic
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.435 2010/01/19 14:26:24 tg Exp $'
d169 1
d795 3
@


1.435
log
@add an explicit message when mirtoconf+siglist generation are done
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.434 2010/01/01 18:27:42 tg Exp $'
d4 1
a4 1
# Copyright (c) 2003, 2004, 2005, 2006, 2007, 2008, 2009
d152 4
a155 3
	cat >scn.c
	vv ']' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS $ccpr" | \
	    sed 's^\] scn.c:\([0-9]*\):\] mirtoconf(\1):'
d158 1
a158 1
	test $tcfn = no && test -f scn && tcfn=scn
d171 1
a171 1
	rm -f scn.c scn.o ${tcfn}* vv.out
d275 1
a275 1
    no *.o scn.c signames.inc stdint.h test.sh x vv.out
d507 1
a507 1
cat >scn.c <<'EOF'
d563 1
a563 1
vv ']' "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS | \
d568 1
a568 1
echo 'int main(void) { return (0); }' >scn.c
d598 1
a598 1
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -Wl,-V scn.c $LIBS"
d607 1
a607 1
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -v scn.c $LIBS"
d613 1
a613 1
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V scn.c $LIBS"
d669 1
a669 1
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -V scn.c $LIBS"
d680 1
a680 1
	vv '|' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -Wl,-V scn.c $LIBS"
d697 1
a697 1
rm -f scn.c scn.o scn a.out* a.exe* vv.out
d1356 2
a1357 2
	echo '#define foo bar' >scn.c
	vv ']' "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -dD scn.c $LIBS >x"
d1359 1
a1359 1
	rm -f scn.c x vv.out
d1390 2
a1391 2
mksh_cfg: NSIG' >scn.c
	NSIG=`vq "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS" | \
d1404 1
a1404 1
	    "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -dD scn.c $LIBS" | \
d1409 3
a1411 3
		echo '#include <signal.h>' >scn.c
		echo mksh_cfg: SIG$name >>scn.c
		vq "$CPP $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS" | \
d1425 1
a1425 1
	rm -f scn.c
d1436 1
a1436 1
$e $bi$me: Finished configuration, now producing output.$ao
@


1.434
log
@__attribute__((used)) is not for pcc (but unused works)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.433 2009/12/12 22:27:02 tg Exp $'
d1435 2
@


1.433
log
@re-vamp __attribute__ handling; let this pass on HP-UX bundled compiler
as well as HP aCC
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.432 2009/12/12 21:17:25 tg Exp $'
d42 2
a43 1
	eval "$@@" 2>&1 | sed "s^${_c} "
d163 8
a170 5
	test ugcc=$phase$ct && $CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c \
	    $LIBS 2>&1 | grep 'unrecogni[sz]ed' >/dev/null 2>&1 && fv=$fr
	test uhpcc=$phase$ct && $CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c \
	    $LIBS 2>&1 | grep 'unsupported' >/dev/null 2>&1 && fv=$fr
	rm -f scn.c scn.o ${tcfn}*
d274 1
a274 1
    no *.o scn.c signames.inc stdint.h test.sh x
d566 1
a566 1
rm -f x
d696 1
a696 1
rm -f scn.c scn.o scn a.out* a.exe*
d882 1
d963 1
d1358 1
a1358 1
	rm -f scn.c x
d1372 1
a1372 1
rm -f x
@


1.432
log
@HP-UX IA64: +DD64 is no longer necessary with aCC (no gcc available)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.431 2009/12/05 16:19:59 tg Exp $'
d164 2
d790 1
d792 1
d823 1
d826 1
d882 1
a882 1
ac_test attribute '' 'for basic __attribute__((...)) support' <<-'EOF'
a886 9
	#include <stdlib.h>
	#undef __attribute__
	void fnord(void) __attribute__((noreturn));
	int main(void) { fnord(); }
	void fnord(void) { exit(0); }
	#endif
EOF

ac_test attribute_bounded attribute 0 'for __attribute__((bounded))' <<-'EOF'
d896 1
d898 53
a950 2

ac_test attribute_used attribute 0 'for __attribute__((used))' <<-'EOF'
d953 1
@


1.431
log
@unbreak test.sh in some cases
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.430 2009/10/27 16:59:59 tg Exp $'
a691 9
case $TARGET_OS in
HP-UX)
	case $ct:`uname -m` in
	gcc:ia64) : ${CFLAGS='-mlp64'} ;;
	hpcc:ia64) : ${CFLAGS='+DD64'} ;;
	esac
	;;
esac

@


1.430
log
@do not use PATH_MAX on GNU/Hurd (even if it *was* defined), but use
some glibc-only functions that dont require its use instead

tested on gnubber, where (admittedly) sysconf(_PC_PATH_MAX) == 1024
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.429 2009/10/16 18:51:30 tg Exp $'
d1412 1
a1412 1
	exec \$perli '$srcdir/check.pl' -s '$srcdir/check.t' -p '$curdir/mksh' -C \${check_categories#,} \$*$tsts
@


1.429
log
@GNU make needs VPATH with the for-all-make(1)s thing (at least if
the sources are in different directories, despite being listed in
${SRCS_FP} with full paths) - XXX can this work with nmake or so?
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.428 2009/10/16 18:45:31 tg Exp $'
d365 2
a366 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE"
@


1.428
log
@tentatively add new -M option to generate a "Makefrag.inc" instead
of doing the actual compile (along with the usual Rebuild.sh, test.sh
and, if necessary, things such as signames.inc) for Android integration
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.427 2009/10/15 16:50:21 tg Exp $'
a1443 1
	of=Makefrag.inc
d1446 1
a1446 1
	cat >$of <<EOF
a1462 2
EOF
	cat >>$of <<'EOF'
d1464 5
a1468 4
#all: $(PROG)
#$(PROG): $(OBJS_BP)
#	$(CC) $(CFLAGS) $(LDFLAGS) -o $@@ $(OBJS_BP) $(LIBS)
#$(OBJS_BP): $(SRCS_FP) $(NONSRCS)
d1470 1
a1470 1
#	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<
d1475 1
a1475 1
#	./test.sh $(REGRESS_FLAGS)
a1476 2
EOF
	cat >>$of <<EOF
d1482 1
a1482 1
	$e Generated $of successfully.
@


1.427
log
@since mksh uses /* comments with apo'strophes */ both in the copyright
and code, we MUST check if they work, since C99 apparently forbids it
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.426 2009/10/15 12:58:34 tg Exp $'
d276 2
a277 1
llvm=NO
d286 1
a286 1
		llvm=COMBINE
d289 1
d293 1
d296 3
d687 1
a687 1
test x"$llvm" = x"NO" || test x"$llvm" = x"COMBINE" || vv '|' "llc -version"
d814 1
a814 1
	test x"$llvm" = x"COMBINE" && ac_flags 0 combine \
d1387 1
d1389 1
d1414 4
a1417 2
test "$HAVE_CAN_COMBINE$llvm" = "0COMBINE" && llvm=NO
if test x"$llvm" = x"NO"; then
a1418 4
elif test x"$llvm" = x"COMBINE"; then
	emitbc="-fwhole-program --combine"
else
	emitbc="-emit-llvm -c"
d1423 1
a1423 1
	objs="$objs $of"
d1425 2
d1429 1
a1429 3
if test x"$llvm" = x"NO" || test x"$llvm" = x"COMBINE"; then
	lobjs=$objs
else
d1433 2
d1437 2
a1438 2
a.exe)	echo tcfn=mksh.exe >>Rebuild.sh ;;
*)	echo tcfn=mksh >>Rebuild.sh ;;
d1440 1
d1443 48
a1490 5
if test x"$llvm" = x"COMBINE"; then
	case $tcfn in
	a.exe)	objs="-o mksh.exe" ;;
	*)	objs="-o mksh" ;;
	esac
d1495 1
d1509 1
a1509 1
if test x"$emitbc" = x"-emit-llvm -c"; then
d1513 2
a1514 6
case $tcfn in
a.exe)	tcfn=mksh.exe ;;
*)	tcfn=mksh ;;
esac
test x"$llvm" = x"COMBINE" || \
    v "$CC $CFLAGS $LDFLAGS -o $tcfn $lobjs $LIBS $ccpr"
@


1.426
log
@AIX {,/usr}/bin/bsh is an SVR3 Bourne Shell, according to Sven Mascheck,
so I must not use foo="`""`" at all
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.425 2009/09/24 17:15:28 tg Exp $'
d219 1
@


1.425
log
@change undef/def MKSH_NOVI into 0/1 MKSH_S_NOVI flag (with more to come:
MKSH_S_EDIT for small (Emacs) editing mode, MKSH_S_FEAT for all the dis-
abled language features), which can be set to 0 despite MKSH_SMALL being
defined to re-enable the Vi command line editing mode (which I wouldn't,
but fits into the general mastermind scheme)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.424 2009/09/23 18:22:37 tg Exp $'
d1415 2
a1416 1
	objs="$objs `echo x"$file" | sed 's/^x\(.*\)\.c$/\1.o/'`"
@


1.424
log
@SUNWcc related fixes for normal and MKSH_SMALL
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.423 2009/08/30 13:22:37 tg Exp $'
d25 1
a25 2
# CPPFLAGS recognised:	MKSH_SMALL MKSH_ASSUME_UTF8 MKSH_NOPWNAM MKSH_NOVI
#			MKSH_CLS_STRING MKSH_BINSHREDUCED MKSH_UNEMPLOYED
d27 2
a28 1
#			MKSH_NO_LIMITS
@


1.423
log
@add a do_realpath() implementation replacing the use of the external
libc function realpath(3) which may not be available on the target
system; compile the realpath builtin unconditionally

looks fine to me, but review is appreciated; this is (very) lightly
based upon MirBSD libcs realpath(3) and pdkshs get_phys_path()
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.422 2009/08/28 17:37:47 tg Exp $'
d915 14
a928 1
	if test $ct = xlc; then
d930 2
a931 3
	else
		ac_flags 1 fnoinline -fno-inline
	fi
@


1.422
log
@rpmlint says that one scn.c is compiled without rpms $CFLAGS
its probably right, except, maybe it was from a CPP invocation
nevertheless it now will never call $CC without $CFLAGS et al.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.421 2009/08/08 13:52:35 tg Exp $'
a921 1
	: ${HAVE_REALPATH=0}
a1169 17
ac_test realpath <<-'EOF'
	#if HAVE_SYS_PARAM_H
	#include <sys/param.h>
	#endif
	#include <stdlib.h>
	#include <unistd.h>
	#ifndef PATH_MAX
	#define PATH_MAX 1024
	#endif
	char *res, dst[PATH_MAX];
	const char src[] = ".";
	int main(void) {
		res = realpath(src, dst);
		return (res == NULL ? 1 : 0);
	}
EOF

@


1.421
log
@need <sys/types.h> for mode_t
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.420 2009/08/08 13:08:48 tg Exp $'
d548 2
a549 1
vv ']' "$CPP scn.c | grep ct= | tr -d \\\\015 >x"
d572 1
a572 1
	vv '|' "$CC -version"
d582 2
a583 2
	vv '|' "$CC -V"
	vv '|' "$CC -Wl,-V scn.c"
d592 4
a595 2
	vv '|' "$CC -v scn.c"
	vv '|' 'echo `$CC -dumpmachine` gcc`$CC -dumpversion`'
d598 1
a598 1
	vv '|' "$CC -V scn.c"
d607 1
a607 1
	vv '|' "$CC -V"
d615 1
a615 1
	vv '|' "$CC -version"
d637 1
a637 1
	vv '|' "$CC -version"
d640 1
a640 1
	vv '|' "$CC -v"
d654 1
a654 1
	vv '|' "$CC -V scn.c"
d657 1
a657 1
	vv '|' "$CC -v"
d660 2
a661 1
	vv '|' "$CC -V 2>&1 | fgrep -i -e version -e release"
d664 2
a665 2
	vv '|' "$CC -V"
	vv '|' "$CC -Wl,-V scn.c"
d673 1
a673 1
	vv '|' "$CC -qversion=verbose"
d1307 1
a1307 1
	vv ']' "$CPP -dD scn.c >x"
d1341 2
a1342 2
	NSIG=`vq "$CPP $CPPFLAGS scn.c" | grep mksh_cfg: | \
	    sed 's/^mksh_cfg:[	 ]*\([0-9x ()+-]*\).*$/\1/'`
d1354 2
a1355 1
	    "$CPP $CPPFLAGS -dD scn.c" | grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
d1361 2
a1362 1
		vq "$CPP $CPPFLAGS scn.c" | grep mksh_cfg: | \
@


1.420
log
@While mksh R39 builds fine on MirOS #7s8E on my trusty sparc, pgcc 2.95.3
throws out quite some warnings  fix most of them except most emitted via
-Wconversion; work around some others; discard bogus warnings.

sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.419 2009/08/01 21:58:06 tg Stab $'
d1212 1
@


1.419
log
@Linux libc5 has some function protos in weird places
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.418 2009/08/01 21:52:02 tg Exp $'
d975 1
a975 1
#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
d1126 1
a1126 1
	    PROT_READ, MAP_PRIVATE, 0, 0) == (void *)NULL ? 1 :
d1150 3
a1152 2
		dv = makedev((unsigned int)ac, 1);
		return (mknod(av[0], 0, dv) ? (int)major(dv) : (int)minor(dv));
d1213 2
a1214 1
	int main(int ac, char *av[]) { return (getmode(setmode(av[0]), ac)); }
d1247 2
a1248 1
	int main(int ac, char *av[]) { return (strlcpy(*av, av[1], ac)); }
@


1.418
log
@ULTRIX, OSF/1, Tru64, Linux 2.0: uint8_t check must come *before* the
arc4random.c source file is added to $LIBS (and related checks)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.416 2009/08/01 20:58:07 tg Exp $'
d1157 1
d1171 1
@


1.417
log
@ash 0.2 (ecce!GNU/Linux 1.05) chokes on such "long" echo statements...
@
text
@a1089 5
		ac_header sys/sysctl.h
		addsrcs '!' HAVE_ARC4RANDOM arc4random.c
		HAVE_ARC4RANDOM=1
		LIBS="$LIBS arc4random.c"

d1099 5
@


1.416
log
@*curses* ensure all ! are quoted, ash 0.2, ecce!GNU/Linux 1.05
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.415 2009/08/01 20:29:02 tg Exp $'
d492 2
a493 1
echo '#if defined(__ICC) || defined(__INTEL_COMPILER)
d545 2
a546 1
#endif' >scn.c
@


1.415
log
@arc4random.c needs uint8_t
tested on ULTRIX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.414 2009/08/01 14:12:13 tg Exp $'
d1089 1
a1089 1
		addsrcs ! HAVE_ARC4RANDOM arc4random.c
d1365 2
a1366 2
addsrcs ! HAVE_SETMODE setmode.c
addsrcs ! HAVE_STRLCPY strlcpy.c
@


1.414
log
@oops, fix adding arc4random.c to SRCS
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.413 2009/07/30 19:11:09 tg Exp $'
d1092 10
@


1.413
log
@"official" but unsupported printf-as-builtin code, cleaner API than
in the branch; USE_PRINTF_BUILTIN=1 to enable it (Build.sh + Makefile)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.412 2009/07/25 21:31:23 tg Exp $'
d1089 1
a1089 1
		addsrcs HAVE_ARC4RANDOM arc4random.c
@


1.412
log
@* improve CPPFLAGS vs #define handling again: do not touch CPPFLAGS from
  Build.sh but use 'if defined(PRECOND) && !defined(TOBEDEFINED)'if possible
* for all of the source code, drop annotations "imake style" (if we check
  for specific OSes, bad, instead of using mirtoconf checks proper) and
  "conditions correct?" (if I'm not entirely sure if that #if catches all
  cases and no false positives) where I can see it by grepping immediately
* bump mksh patchlevel
* refresh Makefiles
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.411 2009/07/25 20:52:39 tg Exp $'
d24 1
d248 6
d255 1
a255 1
	test 0 = $i && case " $SRCS " in
d1355 4
a1358 2
addsrcs HAVE_SETMODE setmode.c
addsrcs HAVE_STRLCPY strlcpy.c
@


1.411
log
@in an interesting piece of self humour, remove the stop and suspend
aliases from shells requiring the Arbeitsamt to get a job ;-)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.410 2009/07/25 20:18:13 tg Exp $'
d913 1
a913 1
	CPPFLAGS="$CPPFLAGS -DMKSH_CONSERVATIVE_FDS"
d1184 2
@


1.410
log
@simplify MKSH_SMALL => MKSH_CONSERVATIVE_FDS handling
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.409 2009/07/25 20:04:09 tg Exp $'
d918 3
@


1.409
log
@allow overriding -DMKSH_SMALL with HAVE_PERSISTENT_HISTORY=x too
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.408 2009/07/19 14:59:40 tg Exp $'
a760 9
# CPPFLAGS: which ones are (pre-)set?
#
ac_ifcpp 'ifdef MKSH_ASSUME_UTF8' isset_MKSH_ASSUME_UTF8 '' \
    'if MKSH_ASSUME_UTF8 is set' && : ${HAVE_SETLOCALE_CTYPE=0}
ac_ifcpp 'ifdef MKSH_CONSERVATIVE_FDS' isset_MKSH_CONSERVATIVE_FDS '' \
    'if MKSH_CONSERVATIVE_FDS is set' && \
    check_categories=$check_categories,convfds

#
d913 1
a913 1
	check_categories=$check_categories,convfds
d918 5
@


1.408
log
@restructure the build system: new ac_ifcpp macro for _reliably_ determining
the state of the C Prprocessor at configuration time (simple checks, i.e.
set/unset, set+1/set+!1/unset, and more complex checks), including verbose
output; related cosmetics and variable naming cleanup
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.407 2009/07/07 20:36:58 tg Exp $'
d920 1
d1266 1
a1266 2
ac_cache PERSISTENT_HISTORY || \
    test 10 != $HAVE_FLOCK_EX$HAVE_ISSET_MKSH_SMALL || fv=1
@


1.407
log
@Nils Weller says to not use nwcc -stackprotect
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.406 2009/07/07 18:42:47 tg Exp $'
d167 20
d308 1
a308 1
warn=
d336 1
a336 1
	warn=' and will currently not work'
d396 1
a396 1
	warn=' and will currently not work'
d401 1
a401 1
	warn=' and will currently not work'
d418 1
a418 1
	warn=' and will currently not work'
d429 2
a430 2
	warn="; it will compile, but the target"
	warn="$warn${nl}platform itself is very flakey/unreliable"
d434 1
a434 1
	warn='; it may or may not work'
a437 18
case " $CPPFLAGS " in
*\ -DMKSH_ASSUME_UTF8\ *|*\ -DMKSH_ASSUME_UTF8=*)
	: ${HAVE_SETLOCALE_CTYPE=0}
	;;
esac
case " $CPPFLAGS " in
*\ -DMKSH_CONSERVATIVE_FDS\ *|*\ -DMKSH_CONSERVATIVE_FDS=*)
	check_categories=$check_categories,convfds
	;;
esac

if test -n "$warn"; then
	echo "Warning: mksh has not yet been ported to or tested on your" >&2
	echo "operating system '$TARGET_OS'$warn. If you can provide" >&2
	echo "a shell account to the developer, this may improve; please" >&2
	echo "drop us a success or failure notice or even send in diffs." >&2
fi

d462 6
d690 2
a691 4
ac_testn compiler_fails '' 'if the compiler does not fail correctly' <<-EOF
	int main(void) { return (thiswillneverbedefinedIhope()); }
EOF
if test 1 = $HAVE_COMPILER_FAILS; then
d712 2
a713 9
ac_testn couldbe_tcc '!' compiler_known 0 'if this could be tcc' <<-EOF
	#ifdef __TINYC__
	int main(void) { return (0); }
	#else
	/* force a failure: __TINYC__ not defined */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#endif
EOF
if test 1 = $HAVE_COULDBE_TCC; then
d761 9
d909 2
a910 20
ac_testn mksh_full '' "if a full-featured mksh is requested" <<-'EOF'
	#ifdef MKSH_SMALL
	/* force a failure: we want a small mksh */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#else
	/* force a success: we want a full mksh */
	int main(void) { return (0); }
	#endif
EOF
ac_testn mksh_reduced '' "if a reduced-feature sh is requested" <<-'EOF'
	#ifdef MKSH_BINSHREDUCED
	/* force a success: we want a reduced mksh-as-bin-sh */
	int main(void) { return (0); }
	#else
	/* force a failure: we want a full mksh, always */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#endif
EOF

if test 0 = $HAVE_MKSH_FULL; then
d923 3
a925 3
if test 1 = $HAVE_MKSH_REDUCED; then
	check_categories=$check_categories,binsh
fi
d1265 2
a1266 1
ac_cache PERSISTENT_HISTORY || test 11 != $HAVE_FLOCK_EX$HAVE_MKSH_FULL || fv=1
@


1.406
log
@nwcc accepts -std=gnu99 (but doesn't process it yet) and -Wall
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.405 2009/07/07 18:39:51 tg Exp $'
d848 1
a848 1
	ac_flags 1 ssp -stackprotect
@


1.405
log
@fix cast warnings discovered by nwcc, and work around const optimisation
related over-zealous warnings by using a non-const integer value
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.404 2009/07/07 18:38:49 tg Exp $'
d847 1
@


1.404
log
@remove tack workarounds, for now
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.402 2009/06/10 21:25:39 tg Exp $'
d1006 1
a1006 1
	int main(void) { return ((ptrdiff_t)(sig_t)0); }
d1013 1
a1013 1
	int main(void) { return ((ptrdiff_t)(sighandler_t)0); }
d1024 1
a1024 1
	int main(void) { return ((ptrdiff_t)(__sighandler_t)0); }
@


1.403
log
@prepare for ACK on GNU/Linux
@
text
@a154 1
	test $tcfn = no && test -f linux386.exe && tcfn=linux386.exe
d239 1
a239 2
rm -f a.exe* a.out* *core crypt.exp lft linux386.exe* \
    mksh mksh.cat1 mksh.exe mksh.s \
d661 1
a661 1
rm -f scn.c scn.o scn a.out* a.exe* linux386.exe*
@


1.402
log
@die, gcc, die! if main is called with 2 args, I can very well
use just the first one, grml...
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.401 2009/06/08 20:52:28 tg Stab $'
d155 1
d240 2
a241 1
rm -f a.exe* a.out* *core crypt.exp lft mksh mksh.cat1 mksh.exe mksh.s \
d663 1
a663 1
rm -f scn.c scn.o scn a.out* a.exe*
@


1.401
log
@Add MKSH_NO_LIMITS, to define which has the same effect as the
absence of RLIM_INFINITY, namely make c_ulimit() into a true
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.400 2009/06/08 20:34:37 tg Exp $'
d1132 1
a1132 1
	int main(int ac) { return (killpg(123, ac)); }
@


1.400
log
@ Check if killpg(3) is available; if not, use kill(2) with negative
  process ID and hope it works (is POSIXly killpg-endowed)
 bump version
 sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.399 2009/06/07 22:26:00 tg Exp $'
d27 1
@


1.399
log
@allow HAVE_REALPATH=x in the environment if MKSH_SMALL to enable the
feature if possible, like HAVE_MKNOD does. same for revoke.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.398 2009/06/07 22:21:39 tg Exp $'
a380 1
	# missing: killpg()
d1129 5
@


1.398
log
@MKSH_BINSHREDUCED is independent from MKSH_SMALL, has been for a while
this is to accomodate e.g. Debian
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.397 2009/06/07 14:50:58 tg Exp $'
d927 2
d1150 1
a1150 1
ac_test realpath mksh_full 0 <<-'EOF'
d1166 1
a1166 1
ac_test revoke mksh_full 0 <<-'EOF'
@


1.397
log
@naaina provided me with a patch from Sean Boudreau, QNX Software Systems,
which I applied slightly tuned: QNX 6.4.2 ed(1) is said to fix the issues
that made it unusable by our regression test suite
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.396 2009/05/29 14:41:37 tg Exp $'
d909 1
a909 1
ac_testn mksh_reduced mksh_full 0 "if a reduced-feature sh is requested" <<-'EOF'
@


1.396
log
@From Andr naaina Wsten via IRC:

QNX 6.4 is out, which has a different waitfor() in <libutil.h>, which
we by definition of __NO_EXT_QNX do not want to use. They are in the
process of porting the NetBSD pkgsrc repository to it.

The /bin/ed situation hasnt improved yet though.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.394 2009/05/20 10:10:35 tg Exp $'
d22 2
a23 1
# Environment used: CC CFLAGS CPPFLAGS LDFLAGS LIBS NOWARN NROFF TARGET_OS
d292 9
d386 5
a390 1
	oldish_ed=no-stderr-ed		# oldish /bin/ed is broken
@


1.395
log
@ Build.sh, strlcpy.c: gcc-current conversion &c. warnings cleanup
 histrap.c, lex.c, misc.c: get average stack frame size to <= 768 bytes
 check.t, sh.h: bump version
@
text
@d375 1
@


1.394
log
@were getting closer, but even a jobless mksh behaves the same
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.393 2009/05/16 18:40:03 tg Stab $'
d870 1
a870 1
		memmove(d, s, n); return (n);
d1063 1
a1063 1
	int main(void) { return (arc4random()); }
d1087 2
a1088 1
	int main(int ac, char *av[]) { return (arc4random_pushb(*av, ac)); }
d1098 1
a1098 1
	int main(void) { return ((void *)mmap(NULL, flock(0, LOCK_EX),
d1108 2
a1109 1
		return (getrusage(RUSAGE_SELF + RUSAGE_CHILDREN, &ru));
d1118 1
a1118 1
		dv = makedev(ac, 1);
d1161 1
a1161 1
	int main(void) { return ((ptrdiff_t)(void *)setlocale(LC_CTYPE, "")); }
d1167 1
a1167 1
	int main(void) { return ((ptrdiff_t)(void *)nl_langinfo(CODESET)); }
d1203 1
a1203 1
		return ((ptrdiff_t)(void *)strcasestr(*av, av[ac]));
d1221 1
a1221 1
	int main(void) { return (arc4random()); }
d1227 1
a1227 1
	int main(int ac, char *av[]) { return (arc4random_pushb(**av, ac)); }
d1233 1
a1233 1
	int main(void) { return (flock()); }
d1239 1
a1239 1
	int main(void) { return (revoke()); }
@


1.393
log
@ remove #if 0 and #ifdef notdef style old debugging code
 expose #ifdef MKSH_MIDNIGHTBSD01ASH_COMPAT just in case they decide to
  require it and show it in the ksh version automatically
 sync the use of non-ASCII characters over files (unification)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.392 2009/05/16 16:59:31 tg Exp $'
d382 1
a382 1
	: ${HAVE_FLOCK_EX=0}
@


1.392
log
@ sync distrib/special/mksh/Makefile with bin/mksh/Build.sh and
  fix the regression tests results while here, which have been
  broken since cid 10049D9BE5254CE65B8
 get rid of separate copyright file which was intended for De-
  bian; track down commits in all files of oksh-mirbsd and mksh
  to get correct copyright years per-file, as is BSD custom
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.391 2009/04/10 16:09:53 tg Exp $'
d25 1
a25 1
#			MKSH_CONSERVATIVE_FDS
d456 2
a457 2
#  ICC defines __GNUC__ too
#  GCC defines __hpux too
d523 1
a523 1
	# work around the famous ACK const bug
d1170 1
a1170 1
	/* force a failure: Win32 setmode() is not what we want */
@


1.391
log
@since <libutil.h> needs <sys/types.h> e.g. on mnbsd, use it later too
when checking for revoke()
@
text
@d2 19
a20 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.390 2009/04/07 18:41:32 tg Exp $'
@


1.390
log
@try to do some optimum struct packing except for struct env
(pointers, longs, size_t first; time_t next; int etc. then enum, bool)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.389 2009/04/06 08:37:42 tg Exp $'
d1130 1
d1176 1
@


1.389
log
@apply workaround given to me in IRC yesternight, just define away the
const keyword to not trigger the famous ACK const bug (no chance itll
get fixed, not even in Minix 3s ACK version)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.388 2009/04/06 08:33:36 tg Exp $'
d1301 1
a1301 1
		*)	echo "		{ $nr, \"$name\" },"
@


1.388
log
@decouple conservative file descriptor use from MKSH_SMALL, with the
new MKSH_CONSERVATIVE_FDS prprocessor flag, because Minix 3, for
example, needs it (otherwise mksh Build.sh fails)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.387 2009/04/06 08:29:21 tg Exp $'
a327 2
	warn=" but will probably work with GCC"
	warn="$warn${nl}but not with ACK - /usr/bin/cc - yet)"
d505 2
a506 1
	echo >&2 'Warning: the Amsterdam Compiler Kit is buggy.'
@


1.387
log
@fix CPPFLAGS detection logic for MKSH_ASSUME_UTF8
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.386 2009/04/06 08:24:57 tg Exp $'
d7 1
d326 2
a327 2
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE -D_POSIX_1_SOURCE=2"
	CPPFLAGS="$CPPFLAGS -DMKSH_UNEMPLOYED -D_MINIX"
d392 5
d896 1
@


1.386
log
@on Minix 3, <strings.h> needs <ansi.h> (via <sys/types.h>)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.385 2009/04/05 13:07:06 tg Exp $'
d387 1
a387 3
*\ -DMKSH_ASSUME_UTF8=0\ *)
	;;
*\ -DMKSH_ASSUME_UTF8*)
@


1.385
log
@replaced cannot sort
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.384 2009/04/05 12:35:28 tg Exp $'
d908 1
a908 1
ac_header strings.h
@


1.384
log
@fix jobless mksh so much to make it work on Minix 3
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.383 2009/04/05 12:21:14 tg Exp $'
d285 3
a290 3
BeOS|Haiku)
	warn=' and will currently not work'
	;;
@


1.383
log
@assume Plan 9 will also want a jobless mksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.382 2009/04/03 10:56:32 tg Exp $'
d327 3
a329 3
	warn=' and will currently not work'
#	warn=" but might work with the GNU tools"
#	warn="$warn${nl}but not with ACK - /usr/bin/cc - yet)"
@


1.382
log
@persistent history needs munmap, not just mmap (Minix 3 lacks only the former, WTF?)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.381 2009/04/03 09:45:22 tg Exp $'
d349 1
a349 1
	CPPFLAGS="$CPPFLAGS -DMKSH_ASSUME_UTF8"
@


1.381
log
@make {get,set}rlimit code depend on RLIM_INFINITY existence (PW32, Minix 3)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.380 2009/04/03 09:42:37 tg Exp $'
d1076 2
a1077 1
	    PROT_READ, MAP_PRIVATE, 0, 0) == (void *)NULL ? 1 : 0); }
@


1.380
log
@detect ACK, handle Minix better
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.379 2009/04/03 09:39:01 tg Exp $'
d354 1
a354 1
	# missing: killpg() getrlimit()
@


1.379
log
@(experimental) implement getrusage via times if not found
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.378 2009/03/29 17:50:45 tg Exp $'
d6 1
a6 1
#			MKSH_CLS_STRING MKSH_BINSHREDUCED
d326 1
d448 2
d502 3
@


1.378
log
@add some CPPFLAGS only if setmode.c
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.377 2009/03/23 08:54:12 tg Exp $'
d1073 9
@


1.377
log
@make buildable again after memory allocator change
(why didnt anybody report this?)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.376 2009/03/22 16:55:37 tg Exp $'
d1293 1
a1294 1
CPPFLAGS="$CPPFLAGS -DHAVE_CONFIG_H -DCONFIG_H_FILENAME=\\\"sh.h\\\""
@


1.376
log
@remove espie's double-linked-list based allocator and write a
similarily simple one from scratch, which however performs
better than espie's with AFREE_DEBUG enabled which took away
the benefit of the double-linked-list approach

all of (core) mksh is now MirOS licenced
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.375 2008/12/31 16:09:51 tg Exp $'
d257 1
a257 1
SRCS="alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
@


1.375
log
@with Build.sh -combine, only do it if it is usable (gcc only too)
XXX do other compilers support such thing?

sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.374 2008/12/20 20:39:05 tg Exp $'
d6 1
a6 1
#			MKSH_CLS_STRING MKSH_AFREE_DEBUG MKSH_BINSHREDUCED
@


1.374
log
@new option -combine (complementary to -llvm):
compile all source files at once using -fwhole-program --combine,
similarily to how it used to be done in older mksh versions, except
that the flags are now hardcoded; tested with llvm-gcc4.2 from MirPorts
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.373 2008/11/13 00:36:07 tg Exp $'
d753 3
d1321 1
@


1.373
log
@this was NOT intended to be committed; my sincere apologies
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.371 2008/11/11 23:20:08 tg Exp $'
d235 3
d617 1
a617 1
test x"$llvm" = x"NO" || vv '|' "llc -version"
d1320 2
d1331 1
a1331 1
if test x"$llvm" = x"NO"; then
d1344 11
a1354 1
if test 1 = $pm; then
d1374 2
a1375 1
v "$CC $CFLAGS $LDFLAGS -o $tcfn $lobjs $LIBS $ccpr"
@


1.373.2.1
log
@still broken
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.373 2008/11/13 00:36:07 tg Exp $'
d254 1
a254 1
SRCS="aalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
@


1.372
log
@leave at least a working tree, with zero-penalty -DAALLOC_NO_COOKIES
XXX cookies are still broken?

cost for aalloc.c: data -= (4, 0, 4, 0); text += (1665, ?, 2115, 2217)
@
text
@d254 1
a254 1
SRCS="aalloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
@


1.371
log
@add the workaround for Debian #492377 into the main mirtoconf function,
because Hanno Bck has something similar triggered on Gentoo as well
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.370 2008/11/11 21:52:51 tg Exp $'
d254 1
a254 1
SRCS="alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
@


1.370
log
@if -DMKSH_ASSUME_UTF8, default HAVE_SETLOCALE_CTYPE to 0 since its
unused then anyway, to save two followup mirtoconf checks and headers
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.369 2008/11/10 20:25:04 tg Exp $'
d130 2
a131 1
	vv ']' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS $ccpr"
@


1.369
log
@add new Build.sh option -llvm for bytecode compilation and link-time
intra-module optimisation
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.368 2008/11/08 17:36:35 tg Exp $'
d381 8
@


1.368
log
@the QNX /bin/ed problem is worse than thought; use a new mechanism,
because categories in check.t are ORd:
 no-stderr-ed disables the newish-ed tests (tried using testcase)
 stdout-ed enables the oldish-ed tests (variable, if the above
  testcase succeeds, its added, but QNX overrides the variable)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.367 2008/11/02 23:06:36 tg Exp $'
d217 2
a218 2
rm -f a.exe* a.out* *core crypt.exp lft mksh mksh.cat1 mksh.exe no *.o \
    scn.c signames.inc stdint.h test.sh x
d226 1
d234 6
d501 7
d605 1
d1306 5
d1315 1
a1315 1
	echo "$CC $CFLAGS $CPPFLAGS -c $file || exit 1" >>Rebuild.sh
d1317 7
d1328 1
a1328 1
echo "$CC $CFLAGS $LDFLAGS -o \$tcfn $objs $LIBS $ccpr" >>Rebuild.sh
d1333 1
a1333 1
		v "$CC $CFLAGS $CPPFLAGS -c $file" &
d1339 1
a1339 1
		v "$CC $CFLAGS $CPPFLAGS -c $file" || exit 1
d1342 4
d1350 1
a1350 1
v "$CC $CFLAGS $LDFLAGS -o $tcfn $objs $LIBS $ccpr"
@


1.367
log
@say hello to QNX, sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.366 2008/11/02 22:29:34 tg Exp $'
d52 1
d346 1
d1206 1
a1206 1
    check_categories=$check_categories,oldish-ed
@


1.366
log
@experimental support for <strings.h>
cf. http://www.opengroup.org/onlinepubs/009695399/basedefs/strings.h.html
QNX seems to bury some functions in there
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.365 2008/10/30 17:11:14 tg Exp $'
d344 3
@


1.365
log
@say hello to nwcc, slightly b0rken though
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.364 2008/10/28 14:32:36 tg Exp $'
d867 1
d1122 3
@


1.364
log
@ rewrite code to no longer use statements-as-expressions
 optimise a little
 Build.sh: remove HAVE_EXPSTMT test
 Build.sh, */Makefile: sort tests, regenerate
 mksh.hts: sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.363 2008/10/26 21:57:47 ahoka Exp $'
d414 1
d453 2
d543 3
d769 2
@


1.363
log
@Add BeOS/Haiku platform.

Compiles OK on Haiku pre-alpha as of 2008 October,
but currently hangs for unknown reason (could be OS bug).
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.362 2008/10/26 21:51:25 ahoka Exp $'
a708 1
phase=u
d710 2
a711 1
	NOWARN=$DOWARN		# scan for flags with -Werror
d764 1
a764 1
# flags common to a subset of compilers
a771 9
NOWARN=$save_NOWARN	# gcc runs with -Werror until here
ac_test expstmt '' "if the compiler supports statements as expressions" <<-'EOF'
	#define ksh_isspace(c)	({					\
		unsigned int ksh_isspace_c = (c);			\
		(ksh_isspace_c >= 0x09 && ksh_isspace_c <= 0x0D) ||	\
		    (ksh_isspace_c == 0x20);				\
	})
	int main(int ac, char *av[]) { return (ksh_isspace(ac + **av)); }
EOF
d773 1
a773 1
# The following tests are run with -Werror if possible
d1029 10
a1048 22
ac_test setlocale_ctype '' 'setlocale(LC_CTYPE, "")' <<-'EOF'
	#include <locale.h>
	#include <stddef.h>
	int main(void) { return ((ptrdiff_t)(void *)setlocale(LC_CTYPE, "")); }
EOF

ac_test langinfo_codeset setlocale_ctype 0 'nl_langinfo(CODESET)' <<-'EOF'
	#include <langinfo.h>
	#include <stddef.h>
	int main(void) { return ((ptrdiff_t)(void *)nl_langinfo(CODESET)); }
EOF

ac_test mknod '' 'if to use mknod(), makedev() and friends' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int main(int ac, char *av[]) {
		dev_t dv;
		dv = makedev(ac, 1);
		return (mknod(av[0], 0, dv) ? (int)major(dv) : (int)minor(dv));
	}
EOF

d1073 12
@


1.362
log
@Add check for the nice(3) system call.
It may be not implemented on some plaforms, though it's usually present.

Required to compile on Haiku as of 2008 October.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.361 2008/10/25 12:58:41 tg Exp $'
d276 3
@


1.361
log
@12:51replaced:#!/bin/mksh mirabilos: btw haiku port?
12:51<mirabilos:#!/bin/mksh> dunno, I run no haiku
12:51<mirabilos:#!/bin/mksh> I don't know anyone who does, either
12:51replaced:#!/bin/mksh only caveat it creates nor .aout. nor a.exe by deafult
12:52<mirabilos:#!/bin/mksh> so I focus on more widely-used things such as DEC ULTRIX 4.5 and Digital UNIX
         2.0 ;)
12:52replaced:#!/bin/mksh the problem was
12:52replaced:#!/bin/mksh it creates src when you give hime src.c
12:53replaced:#!/bin/mksh and it confused your Build.sh
12:54<mirabilos:#!/bin/mksh> which compiler does it use?
12:55replaced:#!/bin/mksh gcc 2.95

this might(!) be enough to support this weirdity. untested.

12:57replaced:#!/bin/mksh can you commit that?
12:57replaced:#!/bin/mksh i will try it
12:57replaced:#!/bin/mksh but a bit later
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.360 2008/10/24 21:35:21 tg Exp $'
d1040 5
@


1.360
log
@replace some cat with echo for speed
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.359 2008/10/24 20:01:42 tg Exp $'
d132 1
@


1.359
log
@fix mis-reporting gcc on OSF/1 V5.1 as dec due to the
rule we need to use to identify dec c on OSF/1 V2.0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.358 2008/10/24 19:59:54 tg Exp $'
d264 4
a267 6
		cat >crypt.exp <<-EOF
			#!
			__crypt_r
			__encrypt_r
			__setkey_r
		EOF
d412 49
a460 51
cat >scn.c <<-'EOF'
	#if defined(__ICC) || defined(__INTEL_COMPILER)
	ct=icc
	#elif defined(__xlC__) || defined(__IBMC__)
	ct=xlc
	#elif defined(__SUNPRO_C)
	ct=sunpro
	#elif defined(__BORLANDC__)
	ct=bcc
	#elif defined(__WATCOMC__)
	ct=watcom
	#elif defined(__MWERKS__)
	ct=metrowerks
	#elif defined(__HP_cc)
	ct=hpcc
	#elif defined(__DECC) || (defined(__osf__) && !defined(__GNUC__))
	ct=dec
	#elif defined(__PGI)
	ct=pgi
	#elif defined(__DMC__)
	ct=dmc
	#elif defined(_MSC_VER)
	ct=msc
	#elif defined(__ADSPBLACKFIN__) || defined(__ADSPTS__) || defined(__ADSP21000__)
	ct=adsp
	#elif defined(__IAR_SYSTEMS_ICC__)
	ct=iar
	#elif defined(SDCC)
	ct=sdcc
	#elif defined(__PCC__)
	ct=pcc
	#elif defined(__TenDRA__)
	ct=tendra
	#elif defined(__TINYC__)
	ct=tcc
	#elif defined(__llvm__) && defined(__clang__)
	ct=clang
	#elif defined(__GNUC__)
	ct=gcc
	#elif defined(_COMPILER_VERSION)
	ct=mipspro
	#elif defined(__sgi)
	ct=mipspro
	#elif defined(__hpux) || defined(__hpua)
	ct=hpcc
	#elif defined(__ultrix)
	ct=ucode
	#else
	ct=unknown
	#endif
EOF
d466 1
a466 3
cat >scn.c <<-'EOF'
	int main(void) { return (0); }
EOF
d469 4
a472 6
	cat >&2 <<-'EOF'
		Warning: Analog Devices C++ compiler for Blackfin, TigerSHARC
		    and SHARC (21000) DSPs detected. This compiler has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d475 3
a477 3
	echo >&2 "Warning: Borland C++ Builder detected. This compiler might"
	echo >&2 "    produce broken executables. Continue at your own risk,"
	echo >&2 "    please report success/failure to the developers."
d501 4
a504 6
	cat >&2 <<-'EOF'
		Warning: IAR Systems (http://www.iar.com) compiler for embedded
		    systems detected. This unsupported compiler has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d510 3
a512 5
	cat >&2 <<-'EOF'
		Warning: Metrowerks C compiler detected. This has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d540 3
a542 5
	cat >&2 <<-'EOF'
		Warning: PGI detected. This unknown compiler has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d545 4
a548 6
	cat >&2 <<-'EOF'
		Warning: sdcc (http://sdcc.sourceforge.net), the small devices
		    C compiler for embedded systems detected. This has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d564 3
a566 5
	cat >&2 <<-'EOF'
		Warning: Watcom C Compiler detected. This compiler has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
d736 1
a736 3
	cat >x <<-'EOF'
		int main(void) { char test[64] = ""; return (*test); }
	EOF
d889 6
a894 8
cat >lft.c <<-'EOF'
	#include <sys/types.h>
	/* check that off_t can represent 2^63-1 correctly, thx FSF */
	#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
	int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721 &&
	    LARGE_OFF_T % 2147483647 == 1) ? 1 : -1];
	int main(void) { return (0); }
EOF
d1199 9
a1207 11
	cat >scn.c <<-'EOF'
		#include <signal.h>
		#ifndef NSIG
		#if defined(_NSIG)
		#define NSIG _NSIG
		#elif defined(SIGMAX)
		#define NSIG (SIGMAX+1)
		#endif
		#endif
		mksh_cfg: NSIG
	EOF
@


1.358
log
@ucode is very similar to dec c; improve version reporting
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.357 2008/10/24 19:55:35 tg Exp $'
d429 1
a429 1
	#elif defined(__DECC) || defined(__osf__)
@


1.357
log
@say hello to mksh on OSF/1 V2.0
the trick is to use static linking
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.355 2008/10/20 19:29:22 tg Exp $'
d577 1
@


1.356
log
@/bin/sh on DEC OSF/1 V2.0 (Digital UNIX) is a true Bourne Shell, so it sucks
@
text
@d429 1
a429 1
	#elif defined(__DECC)
d493 1
d620 1
d626 5
a630 1
		test 1 = $HAVE_CAN_DELEXE || CFLAGS=$save_CFLAGS
d634 1
@


1.355
log
@ change mksh to only then behave more POSuXish when called as /bin/sh or
  -sh if -DMKSH_BINSHREDUCED was passed during compilation, for example
  for Debian, but definitively not for MirBSD
 split up regression test to force this behaviour
 remove the gunk from our MirBSD startup scripts again
 mention arc4random.c changes on website, sync clog, warn packagers
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.354 2008/10/10 21:57:16 tg Exp $'
d1230 1
a1230 1
	printf hallo >/dev/null 2>&1 || printf=echo
@


1.354
log
@improve version reporting on modern AIX/xlC

XXX both cc -qversion and ld -V give errors on AIX 5.2 / xlC V7.0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.353 2008/10/10 21:36:04 tg Exp $'
d6 1
a6 1
#			MKSH_CLS_STRING MKSH_AFREE_DEBUG
d841 9
d861 3
@


1.353
log
@AIX has no UTF-8 locale:

aixuser@@pscp520v5:~/bcc $ locale -a
C
POSIX
en_US
en_US.8859-15
en_US.ISO8859-1
aixuser@@pscp520v5:~/bcc $ uname -a
AIX pscp520v5 3 5 00C56E7D4C00
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.352 2008/10/04 19:13:22 tg Exp $'
d586 1
@


1.352
log
@miwi noticed that <libutil.h> on ViehBSE has a prerequisite header, but
didnt tell me which one (T H A N K S !) since I have no FleaBSD shell
account, I tried on DragonFly and MidnightBSD, which both are content
when adding <sys/types.h> first lets hope this fixes all 386BSD derivates
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.351 2008/09/30 17:34:25 tg Exp $'
d272 1
@


1.351
log
@remove the problematic -q option, which causes trouble under unclear
circumstances, like some FreeBSD 8 (beta) incarnations (yet not others)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.350 2008/07/21 21:00:25 tg Exp $'
d859 1
a859 1
ac_header libutil.h
@


1.350
log
@heirloom-sh and Solaris /bin/sh caught use of $NROFF before definition
10x Elias Pipping for noticing
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.349 2008/07/18 11:42:52 tg Exp $'
d19 2
a20 2
	eval '$e "\$ $*" 2>&'$h
	eval 'eval "$@@" 2>&'$h | sed "s^${_c} "
a220 1
h=1
a233 4
	-q)
		e=:
		h=-
		;;
d466 1
a466 1
test 1 = $h && sed 's/^/[ /' x
d1218 1
a1218 1
	test 1 = $h && $printf "NSIG=$NSIG ... "
d1238 1
a1238 1
			test 1 = $h && $printf "$name=$nr " >&2
d1308 1
a1308 1
test 0 = $eq && test 1 = $h && v size $tcfn
@


1.349
log
@ptrdiff_t needs <stddef.h>
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.348 2008/07/18 11:34:20 tg Exp $'
a251 2
test 0 = $r && echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && \
    NROFF="$NROFF -c"
a257 1

d379 2
a380 1

@


1.348
log
@(possible) warning cleanup
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.347 2008/07/17 15:17:46 tg Exp $'
d928 1
d935 1
d946 1
@


1.347
log
@this isn't needed, from pdksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.346 2008/07/17 14:50:24 tg Exp $'
d928 1
a928 1
	int main(void) { return ((int)(sig_t)0); }
d934 1
a934 1
	int main(void) { return ((int)(sighandler_t)0); }
d944 1
a944 1
	int main(void) { return ((int)(__sighandler_t)0); }
@


1.346
log
@add some cppflags from pdksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.345 2008/07/15 23:44:51 tg Exp $'
d318 1
a318 1
	CPPFLAGS="$CPPFLAGS -D_MINIX -D_POSIX_SOURCE -D_POSIX_1_SOURCE=2"
@


1.345
log
@BSDi BSD/OS 3.1s /bin/ksh (PD KSH v5.2.8 96/08/19) is horridly broken and
removes the \n part of a \\\n sequence, but not the backslash  we cant
use line continuation in a here document

someone might want to add this to *(autoconf) Portable Shell::
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.344 2008/07/15 20:54:47 tg Exp $'
d269 1
d318 1
a318 1
	CPPFLAGS="$CPPFLAGS -D_MINIX -D_POSIX_SOURCE"
@


1.344
log
@with dietlibc, <ulimit.h> requires <sys/types.h>, and as we unconditionally
include the latter anyway, just add it as a scan time requirement header

from Debian package
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.343 2008/07/14 15:06:02 tg Exp $'
d1276 1
a1276 2
	exec \$perli '$srcdir/check.pl' -s '$srcdir/check.t' \\
	    -p '$curdir/mksh' -C \${check_categories#,} \$*$tsts
@


1.343
log
@better
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.342 2008/07/14 14:59:20 tg Exp $'
d869 1
a869 1
ac_header ulimit.h
@


1.342
log
@ handle perls without $^O better
 allow user to specify $PERL environment variable containing path to the
  perl5 interpreter to use, for Elias Pipping
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.341 2008/07/14 14:40:47 tg Exp $'
d1268 2
a1269 1
	cstr='\$os = defined \$^O ? \$^O : "unknown"; print \$os;'
d1272 1
a1272 1
		perlos=\$(\$perli -e "\$cstr") || continue
@


1.341
log
@protect test.sh some from being called by !mksh, as homsn did
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.340 2008/07/13 16:43:54 tg Exp $'
d1268 8
a1275 6
	perl=perl5
	\$perl -e print >/dev/null 2>&1 || perl=perl
	perlos=\$(\$perl -e 'print "\$^O";') || exit 1
	print "Perl interpreter '\$perl' running on '\$perlos'"
	[[ -n \$perlos ]] || exit 1
	exec \$perl '$srcdir/check.pl' -s '$srcdir/check.t' \\
@


1.340
log
@if MKSH_AFREE_DEBUG is defined, guard against wrong frees
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.339 2008/07/11 19:51:22 tg Exp $'
d1260 2
a1261 1
	export LC_ALL=C PATH='$PATH'
@


1.339
log
@ Build.sh, check.t: bring back the 'smksh' check category, which was
  missing for a while yet its disappearance was unnoticed because
 distrib/special/mksh/Makefile: sync check categories, this was missed
 mksh.hts: sync clog
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.338 2008/07/11 18:31:10 tg Exp $'
d6 1
a6 1
#			MKSH_CLS_STRING
@


1.338
log
@IRIX also does not have any UTF-8 locale at all
confirmed by Elias Pipping, 10x
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.337 2008/07/10 18:55:43 tg Exp $'
d854 1
@


1.337
log
@no UTF-8 locales on OSF/1 V5.1B, either
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.336 2008/07/10 18:49:22 tg Exp $'
d308 1
@


1.336
log
@lets find sizer on OSF/1 if its not in the PATH
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.335 2008/07/08 21:14:42 tg Exp $'
d333 1
@


1.335
log
@gcc -v also accepts a file argument, and 'diet gcc -v' croaks, so
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.334 2008/07/08 21:05:01 tg Exp $'
d395 1
a395 1
	vv '|' "sizer -v >&2"
@


1.334
log
@dump the perl $^O string in the logs all Debian GNU/kFreeBSD developers
I can ping right now need to refresh their keys on io/asdfasdf or have
their machines unreachable and I lost my VM to fsck recently (remember)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.333 2008/07/06 23:19:31 tg Exp $'
d504 1
a504 1
	vv '|' "$CC -v"
@


1.333
log
@fix HP aCC compiler version identification
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.332 2008/06/29 19:46:56 tg Exp $'
d1266 3
a1268 1
	\$perl -e print >/dev/null 2>&1 || exit 1
@


1.332
log
@support arc4random.c in build but not src dir, too
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.331 2008/06/29 18:18:56 tg Exp $'
d508 1
a508 1
	vv '|' "$CC -V"
@


1.331
log
@some basic LLVM+clang (with ccc driver example) support
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.330 2008/06/29 18:08:55 tg Exp $'
d1000 11
a1010 7
if test 0 = $HAVE_ARC4RANDOM && test -f "$srcdir/arc4random.c"; then
	ac_header sys/sysctl.h
	addsrcs HAVE_ARC4RANDOM arc4random.c
	HAVE_ARC4RANDOM=1
	# ensure isolation of source directory from build directory
	test -f arc4random.c || cp "$srcdir/arc4random.c" .
	LIBS="$LIBS arc4random.c"
@


1.330
log
@remove llvm-clang artefacts in more places
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.329 2008/06/28 23:00:43 tg Exp $'
d414 1
d452 2
d490 4
d771 2
@


1.329
log
@remove a.out.s and a.out.bc (llvm-clang fallout) too
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.328 2008/06/22 20:51:31 tg Exp $'
d139 1
a139 1
	rm -f scn.c scn.o $tcfn
d215 1
a215 1
rm -f a.exe a.out* *core crypt.exp lft mksh mksh.cat1 mksh.exe no *.o \
d266 1
a266 1
ccpr='|| rm -f $tcfn'
d588 1
a588 1
rm -f scn.c scn.o scn a.out a.exe
@


1.328
log
@improve Mac OSX version reporting
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.327 2008/06/21 19:38:41 tg Exp $'
d215 1
a215 1
rm -f a.exe a.out *core crypt.exp lft mksh mksh.cat1 mksh.exe no *.o \
@


1.327
log
@SUNw,cc is one of the compilers whose version reporting works better when
compiling a demo programme at the same time
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.326 2008/06/21 19:20:14 tg Exp $'
d386 1
a386 1
	vv '|' "hwprefs os_type >&2"
@


1.326
log
@remove check_category pdksh, it starts to make trouble and was never
taken seriously anyway, just historic ballast
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.325 2008/05/20 18:47:06 tg Exp $'
d562 1
a562 1
	vv '|' "$CC -v"
@


1.325
log
@What is valid for Build.sh should be valid for test.sh too.
In this case: reset the locale to C at start.
Otherwise, perl/OpenBSD fails in an UTF-8 environment, just
because OpenBSD 4.3/zaurus still has no locales in 2008.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.324 2008/05/17 18:27:53 tg Exp $'
d218 1
a218 1
curdir=`pwd` srcdir=`dirname "$0"` check_categories=pdksh
d1255 1
a1255 1
	    -p '$curdir/mksh' -C \$check_categories \$*$tsts
@


1.324
log
@add new builtin realpath calling realpath(3) on its argument, skipping
over -- for compatibility to Debian realpath(1) and possibly busybox

sounds handy replaced@@TNF
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.322 2008/05/13 00:08:12 tg Exp $'
d1244 1
a1244 1
	export PATH='$PATH'
@


1.323
log
@beauty error: clear LDFLAGS and LIBS while using -c
@
text
@d1048 16
@


1.322
log
@* default to no setlocale for a couple more platforms
* default to UTF-8 on Plan 9
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.321 2008/05/11 14:47:04 tg Exp $'
d1097 2
a1098 2
save_CC=$CC
CC="$CC -c -o $tcfn"
d1128 1
a1128 1
CC=$save_CC
@


1.321
log
@ GNU/Cygwin has, according to G**gle, only stubbed locale support, like
  OpenBSD
 update testsuite results and clog, again
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.320 2008/05/10 03:16:07 tg Exp $'
d281 1
d305 1
d320 1
d338 1
d344 1
d356 1
d364 1
@


1.320
log
@ on OpenBSD, default to HAVE_SETLOCALE_CTYPE=0 I wonder if thatll ever
  change  this might affect other OSes too in time for R34
 one of the regression tests had an unexpected failure if running as root
 www: sync clog; log newer mksh built on newer OpenBSD works fine
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.319 2008/05/04 01:59:44 tg Exp $'
d283 1
@


1.319
log
@remove more dead mirtoconf code
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.318 2008/05/04 01:58:14 tg Exp $'
d323 1
@


1.318
log
@if we don't have setlocale(), just look at the env vars ourselves
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.317 2008/05/04 01:51:28 tg Exp $'
a833 1
	check_categories=$check_categories,smksh
@


1.317
log
@remove dead code and ifdefs, speed up configuring
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.316 2008/05/04 00:55:18 tg Exp $'
d833 1
a833 1
	: ${HAVE_MKNOD=0} ${HAVE_SETLOCALE_CTYPE=0}
d1073 1
a1073 1
ac_test strcasestr setlocale_ctype 1 <<-'EOF'
@


1.316
log
@set the "C" locale during runs otherwise, some OSes tr(1) or so might
act strange 10x Adam replaced Hoka for helping to find this
00:51<replaced_> it needs -A
00:52<mirabilos> heh. locale?
00:52<replaced_>            -A             Translates on a byte-by-byte basis. When this flag
00:52<replaced_>                           is specified tr does not support extended
00:52<replaced_>                           characters.
00:52<replaced_> LC_CTYPE=en_US.utf8
00:52<mirabilos> hmmm
00:52<mirabilos> but that is weird too
00:52<mirabilos> I don't see why it shouldn't work
00:52<replaced_> yeah, it should act the same
00:53<mirabilos> try this please:
00:53<mirabilos> without -A
00:53<mirabilos> echo sys/param.h | env LC_ALL=C /bin/tr -c
         qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789
         ______________________________________________________________
00:53<replaced_> this works of course
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.315 2008/04/20 02:15:12 tg Exp $'
a825 10
ac_testn mksh_defutf8 '' "if to assume UTF-8 is enabled" <<-'EOF'
	#ifdef MKSH_ASSUME_UTF8
	/* force a success: we assume UTF-8 by default */
	int main(void) { return (0); }
	#else
	/* force a failure: use setlocale() and nl_langinfo(CODESET) */
	int main(void) { return (thiswillneverbedefinedIhope()); }
	#endif
EOF

a834 1
	test 0 = $HAVE_MKSH_DEFUTF8 || check_categories=$check_categories,dutf
d1018 1
a1018 1
ac_test setlocale_ctype '!' mksh_defutf8 0 'setlocale(LC_CTYPE, "")' <<-'EOF'
@


1.315
log
@clean up unused defines
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.314 2008/04/19 22:15:00 tg Exp $'
d8 3
@


1.314
log
@ more unsigned  unsigned int
 more int  bool
 more regression tests: check if the utf8-hack flag is really disabled
  at non-interactive startup, enabled at interactive startup, if the
  current locale is a UTF-8 one
 make the mksh-local multibyte handling functions globally accessible,
  change their names, syntax and semantics a little (XXX more work needed)
 optimise
 utf_wctomb: src  dst, as were writing to that char array (pasto?)
 edit.c:x_e_getmbc(): if the second byte of a 2- or 3-byte multibyte
  sequence is invalid utf-8, ungetc it (not possible for the 3rd byte yet)
 edit.c:x_zotc3(): easier (and faster) handling of UTF-8
 implement, document and test for base-1 numbers: they just get the
  ASCII (8-bit) or Unicode (UTF-8) value of the octet(s) after the 1#,
  or do the same as print \x## or \u#### (depending on the utf8-hack flag),
  plus support the PUA assignment of EF80EFFF for the MirBSD encoding hack
  (print doesnt, as it has \x## and \u#### to distinguish, but we cannot use
  base-0 numbers which I had planned to use for raw octets first, as they are
  used internally): http://thread.gmane.org/gmane.os.miros.general/7938
 as an application example, add a hexdumper to the regression tests 
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.313 2008/04/02 16:55:05 tg Exp $'
d6 1
d1011 1
a1011 1
ac_test flock_ex '' 'flock and mmap' <<-'EOF'
@


1.313
log
@ Ultrix doesnt define MAP_FAILED either
 on Ultrix, mmap() returns a caddr_t instead of a void*, so cast
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.312 2008/04/01 20:40:20 tg Exp $'
d763 1
a763 1
		unsigned ksh_isspace_c = (c);				\
@


1.312
log
@ unify ksh_dup2() usage, use bool where appropriate
 apply diff from mirbsdksh-1.11:
  #ifdef DUP2_BROKEN
  /* Ultrix systems like to preserve the close-on-exec flag */
   XXX we do #ifdef __ultrix here (imake-style) instead of mirtoconfing it
    (but does anyone know of any other OS with the same problem? plus wed
    see it as we now know the symptoms)
 remove ultrix Build.hs warn=' but might work' in the hope it DOES
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.311 2008/04/01 17:25:36 tg Exp $'
d1016 2
a1017 2
	int main(void) { return (mmap(NULL, flock(0, LOCK_EX), PROT_READ,
	    MAP_PRIVATE, 0, 0) == NULL ? 1 : 0); }
@


1.311
log
@easier way to fix it, WFM on BSD/OS
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.309 2008/04/01 17:14:31 tg Exp $'
a344 2
	warn=' but might work. I think that I/O'
	warn="$warn${nl}redirs are kaput: child affects parent"
@


1.310
log
@work around problems with old perl
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.307 2008/03/28 22:56:15 tg Exp $'
a1238 3
	print '\\ufeffprint "moien";' >test.tmp
	[[ \$(\$perl test.tmp 2>&1) = moien ]] || \\
	    check_categories=\$check_categories,oldish-perl
@


1.309
log
@abort if perl is not working in test.sh
@
text
@d1230 1
d1239 3
d1243 1
a1243 1
	    -p '$curdir/mksh' -C $check_categories \$*$tsts
@


1.308
log
@use cat with here document instead of a couple of echos for
generation of test.sh (which grew...)
@
text
@d1237 1
@


1.307
log
@yaloki just mentioned IBM VisualAge, and I found out that its
not, as I thought, their Wintel compiler but AIXs xlC

no breakage, just redundancy.
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.306 2008/03/28 14:04:23 tg Exp $'
d1228 12
a1239 10
echo "export PATH='$PATH'" >>test.sh
echo "print Testing mksh for conformance:" >>test.sh
echo "fgrep MirOS: '$srcdir/check.t'" >>test.sh
echo "fgrep MIRBSD '$srcdir/check.t'" >>test.sh
echo 'print "This shell is actually:\n\t$KSH_VERSION"' >>test.sh
echo "print 'test.sh built for mksh $dstversion'" >>test.sh
echo "perl=perl5" >>test.sh
echo "\$perl -e print >/dev/null 2>&1 || perl=perl" >>test.sh
echo "exec \$perl '$srcdir/check.pl' -s '$srcdir/check.t'" \
    "-p '$curdir/mksh' -C $check_categories \$*$tsts" >>test.sh
@


1.306
log
@more detailled gcc output, idea from Elias Pipping
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.305 2008/03/28 13:55:11 tg Exp $'
d408 1
a408 1
	#elif defined(__xlC__)
a421 2
	#elif defined(__IBMC__)
	ct=visualage
a561 7
visualage)
	cat >&2 <<-'EOF'
		Warning: IBM VisualAge detected. This compiler has not yet
		    been tested for compatibility with mksh. Continue at your
		    own risk, please report success/failure to the developers.
	EOF
	;;
@


1.305
log
@dont use #error: MIPSpro only warns, but doesnt abort compilation
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.304 2008/03/27 22:44:16 tg Exp $'
d489 1
@


1.304
log
@ Build.sh: be a little more explicit about the unknown compilers
 Build.sh: add another one
 */Makefile: sync CPPFLAGS
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.303 2008/03/27 22:17:01 tg Exp $'
a605 10
ac_testn couldbe_tcc '!' compiler_known 0 'if this could be tcc' <<-EOF
	#ifndef __TINYC__
	#error No, cannot be tcc.
	#endif
	int main(void) { return (0); }
EOF
if test 1 = $HAVE_COULDBE_TCC; then
	ct=tcc
	CPP='cpp -D__TINYC__'
fi
a620 1
		int main(void) { return (thiswillneverbedefinedIhope()); }
d624 12
d788 3
a790 2
	#error gcc 1.42 has no -Werror, disabling
	#endif
d796 1
d824 5
a828 1
	#error Nope, MKSH_SMALL is defined.
a829 1
	int main(void) { return (0); }
d833 6
a838 2
	#ifndef MKSH_ASSUME_UTF8
	#error Nope, check with setlocale() and nl_langinfo(CODESET)
a839 1
	int main(void) { return (0); }
d1067 3
a1069 2
	#error Win32 setmode() is different from what is needed
	#endif
d1072 1
@


1.303
log
@tentatively commit support for
 detecting a lot more compilers (stolen from CMake, admittedly, as they
  were the first coming up at G**gle with usable #ifdefs)
 handling MIPSpro
 more system info on IRIX
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.302 2008/03/27 17:59:27 tg Exp $'
d416 2
d465 12
a476 1
adsp|bcc)
d482 4
d494 6
d504 7
d536 6
a541 1
pgi|sdcc)
d543 12
a554 1
sunpro|tcc)
d563 13
a575 1
visualage|watcom)
@


1.302
log
@ignore failure to define MAP_FILE
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.301 2008/03/27 17:55:31 tg Exp $'
d378 4
d414 4
d420 4
d428 6
d442 5
a446 1
	#elif defined(__hpux)
d463 1
a463 1
bcc)
d473 6
a478 1
hpcc|icc)
d481 3
d503 6
a508 1
pcc|sunpro|tcc)
d517 2
d587 3
d674 3
@


1.301
log
@From: Elias Pipping <elias@@pipping.org>
| >Maybe add <sys/types.h> as first line? I could imagine that.
|
| That did the trick indeed (that's where dev_t is defined).
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.300 2008/03/27 13:08:37 tg Exp $'
d917 1
a917 1
	    MAP_FILE | MAP_PRIVATE, 0, 0) == NULL ? 1 : 0); }
@


1.300
log
@Elias Pipping reports success of mksh R33 on IRIX64 mips-sgi-irix6.5 gcc3.4.1
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.299 2008/03/25 21:34:42 tg Exp $'
d748 1
a748 1
ac_header sys/mkdev.h
@


1.299
log
@ Add support for Ultrix 4.5 and ucode cc (?)
   I/O redirection seems broken:
    $ (date; date >/dev/null; date) | wc -l
    1 (expected: 2)
   other than that: working fine
   -YBSD (default) and -YSYSTEM_FIVE dont work, just -YPOSIX, somehow
 Fix $() to `` for OSF/1 V2.0 /bin/sh
   this compiler is FUBAR though:
	$ cat >t.c
	main() { return (foo()); }
	$ cc t.c
	ld:
	Unresolved :
	foo
	$ echo $?
	0
	$ ls -l a.out
	-rwxr-xr-x   1 mirbsd   users      10835 Jul 21 17:12 a.out
   it seems to have ucode, but man is not installed
 new mirtoconf check: mkstemp(3)
 if !HAVE_MKSTEMP (Ultrix), use tempnam(3)
 only use printf(1) if it exists (it doesnt on Ultrix)
 a few more signals
 add S_ISLNK if the OS doesnt define it
 add strcasecmp(3) proto for Ultrix (it _is_ in <portability.h>, but
  only for -YBSD I think)
 fgrep(1) on Ultrix doesnt do -e  -e 

10x DEChengst:#UnixNL for giving access
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.298 2008/03/25 20:25:27 tg Exp $'
d300 2
@


1.298
log
@set MI default values after MD default values
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.297 2008/03/23 21:53:36 tg Exp $'
d340 6
d424 2
d457 1
a457 1
			C89_COMPILER=$(ntpath2posix -c "$C89_COMPILER")
d462 1
a462 1
			C89_LINKER=$(ntpath2posix -c "$C89_LINKER")
d477 3
d564 3
d918 5
d1081 8
a1088 6
	NSIG=`printf %d "$NSIG" 2>/dev/null`
	test 1 = $h && printf "NSIG=$NSIG ... "
	signames="ABRT ALRM BUS CHLD CLD CONT EMT FPE HUP ILL INFO INT IO IOT"
	signames="$signames KILL PIPE PROF PWR QUIT SAK SEGV STOP SYS TERM"
	signames="$signames TRAP TSTP TTIN TTOU URG USR1 USR2 WINCH XCPU XFSZ"
	test 1 = $HAVE_CPP_DD && test $NSIG -gt 1 && signames="$signames "`vq \
d1091 2
a1092 2
	test $NSIG -gt 1 || signames=
	for name in $signames; do
d1098 1
a1098 1
		nr=`printf %d "$nr" 2>/dev/null`
d1104 1
a1104 1
			test 1 = $h && printf "$name=$nr " >&2
d1124 2
a1125 1
echo "fgrep -e MirOS: -e MIRBSD '$srcdir/check.t'" >>test.sh
@


1.297
log
@support gcc 1.42: it only can __attribute__((aligned (1))) but no others,
it cant do -Werror, thats why it mis-detects attribute support.
ignore the warnings (unused variables, uninitialised values, control flow)
as I checked them and they are not valid. gcc 1.42 (BSDi modified) compiles
a very fine mksh
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.296 2008/03/23 20:55:17 tg Exp $'
a213 1
: ${CC=cc} ${NROFF=nroff}
d359 2
@


1.296
log
@support BSD/OS 3.1 with gcc2, 10x replaced@@tnf
except MAP_FAILED not being defined, no issues
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.295 2008/03/23 20:21:24 tg Exp $'
d668 3
@


1.295
log
@choose perl5 over perl, which can be perl 4.0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.294 2008/03/23 20:19:26 tg Exp $'
d277 2
@


1.294
log
@fix Rebuild.sh generation
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.293 2008/03/14 21:34:55 tg Exp $'
d1100 3
a1102 1
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t'" \
@


1.293
log
@much improve the Syllable situation  now en par with Plan 9
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.292 2008/03/06 18:12:58 tg Exp $'
d1114 1
a1114 1
echo 'test -f \$tcfn || exit 1; size \$tcfn' >>Rebuild.sh
@


1.292
log
@attempt version report on msc/interix
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.291 2008/03/06 18:02:33 tg Exp $'
d335 4
@


1.291
log
@more hw info, 10x penpen
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.290 2008/03/05 19:59:27 tg Exp $'
d439 16
@


1.290
log
@make gcc not nn-silently accept -std=gnu99 if it cant
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.289 2008/03/05 19:14:19 tg Exp $'
d363 4
@


1.289
log
@-Wl,+k is no longer needed on HP-sUX with the native linker now that we
check the errorlevel
XXX TODO: Digital Mars
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.288 2008/03/05 18:49:14 tg Exp $'
d47 1
d133 2
d565 1
d624 1
@


1.288
log
@ check for flock decl too (weird on OSF/1: if !POSIX and BSD)
 un-experimental Tru64
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.287 2008/03/05 18:25:57 tg Exp $'
d490 1
a490 5
		CFLAGS="$CFLAGS ${ccpl}+k"
		ac_testn can_plusk compiler_fails 0 'for the +k linker option' <<-EOF
			int main(void) { return (0); }
		EOF
		test 1 = $HAVE_CAN_PLUSK || CFLAGS=$save_CFLAGS
@


1.287
log
@yeah,sure
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.286 2008/03/05 18:21:44 tg Exp $'
a317 1
	warn=' and is still experimental'
d956 6
@


1.286
log
@ now this builds fine on DEChengsts Tru64 box:
  | OSF1 rubbereendje.dechengst.nl V5.1 2650 alpha
  with the vendor compiler:
  | Compaq C V6.5-011 on HP Tru64 UNIX V5.1B (Rev. 2650)
  | Compiler Driver V6.5-003 (sys) cc Driver
 the platforms sig_t is incompatible too (simplify check)
 no compile warnings at all
 results in:
  $ size mksh
  | text    data    bss     dec     hex
  | 327680  16384   17808   361872  58590
  $ file mksh
  | mksh:   COFF format alpha dynamically linked, demand paged executable or object module not stripped - version 3.13-14
  $ ldd mksh
  |
  |         Main  =>   mksh
  |         libc.so  =>   /usr/shlib/libc.so
  $ ls -l mksh
  | -rwxr-xr-x   1 mirbsd   users     395200 Mar  5 19:18 mksh
 minor testsuite issues:
  FAIL ./check.t:regression-13
        unexpected stderr - got too much output
        wanted nothing
        got:
                Successful
                cat: output error
   probably harmless
 works like a charm!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.285 2008/03/05 17:52:43 tg Exp $'
d1057 1
a1057 1
test $HAVE_CAN_VERB=1 && CFLAGS="$CFLAGS -verbose"
@


1.285
log
@somehow magically make it seem to work
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.284 2008/03/05 17:30:10 tg Exp $'
d315 3
a317 2
	HAVE_SIG_T=0; HAVE_SIGHANDLER_T=0; HAVE___SIGHANDLER_T=0
	CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t -D_XOPEN_SOURCE_EXTENDED"
d326 1
a326 2
	HAVE_SIG_T=0; HAVE_SIGHANDLER_T=0; HAVE___SIGHANDLER_T=0
	CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t"
d432 1
a432 1
	ccpr=
d585 1
a585 1
	ac_flags 1 verb -verbose
d791 1
d1013 1
d1015 3
d1057 1
d1102 1
a1102 1
test -f $ccpr || exit 1
@


1.284
log
@Tru64 aka OSF/1 5.1 (10x DEChengst@@#UnixNL) is more nice than OSF/1 4.0
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.283 2008/03/05 17:12:08 tg Exp $'
d124 3
a126 4
	vv ']' "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS"
	rv=$?; test $ct = msc || test 0 = $rv || rm -f a.out a.exe
	test x"$tcfn" = x"no" && test -f a.out && tcfn=a.out
	test x"$tcfn" = x"no" && test -f a.exe && tcfn=a.exe
d260 1
d432 1
d1073 6
a1078 4
echo "$CC $CFLAGS $LDFLAGS -o mksh $objs $LIBS" >>Rebuild.sh
test $ct = msc || echo 'test 0 = $? || exit 1' >>Rebuild.sh
echo 'result=mksh; test -f mksh.exe && result=mksh.exe' >>Rebuild.sh
echo 'test -f $result || exit 1; size $result' >>Rebuild.sh
d1091 6
a1096 5
v "$CC $CFLAGS $LDFLAGS -o mksh $objs $LIBS"
rv=$?; test $ct = msc || test 0 = $rv || exit 1
result=mksh
test -f mksh.exe && result=mksh.exe
test -f $result || exit 1
d1099 1
a1099 1
test 0 = $eq && test 1 = $h && v size $result
@


1.283
log
@ OSF/1, PW32: speed up mirtoconf test for sig_t (which does not exist)
 OSF/1: need _XOPEN_SOURCE_EXTENDED for mknod(2) decl
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.282 2008/03/05 17:06:49 tg Exp $'
d421 1
a421 1
	vv '|' "$CC -V | fgrep 'DEC C'"
@


1.282
log
@OSF/1 doesnt seem to declare revoke(2) anywhere
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.281 2008/03/05 17:00:33 tg Exp $'
d315 2
a316 1
	HAVE_SIG_T=0; CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t"
d325 2
a326 1
	HAVE_SIG_T=0; CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t"
@


1.281
log
@try to support
 DEC C on OSF/1 (10x Jupp the IceWM coffee pot maintainer)
 other stuff which doesnt nuke a.out on failure

XXX this must be tested on *ALL* supported platforms!
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.280 2008/03/03 19:40:08 tg Exp $'
d953 6
@


1.280
log
@report OE and compiler versions inside the build script now, where methods
to query them are known (missing: bcc/dmc/msc compilers; additional OS info
besides uname -a and Darwins hwprefs os_type  please tell me!)
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.279 2008/03/01 15:07:50 tg Rel $'
d125 1
d387 2
d416 6
a421 1
bcc|dmc)
d518 2
d581 3
@


1.279
log
@better debugging aid: print versions at several places
@
text
@d2 1
a2 1
srcversion='$MirOS: src/bin/mksh/Build.sh,v 1.278 2008/02/29 16:38:40 tg Exp $'
d12 7
d124 1
a124 2
	eval 'v "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS" 2>&'$h | \
	    sed 's/^/] /'
d352 10
a361 1
$e "Hello from$ao $bi$srcversion$ao"
d405 1
a405 1
eval 'v "$CPP scn.c | grep ct= | tr -d \\\\015 >x" 2>&'$h | sed 's/^/] /'
d409 3
d413 22
a434 2
bcc|dmc|gcc|hpcc|icc|msc|pcc|sunpro|tcc|tendra|xlc) ;;
*) ct=unknown ;;
d437 1
a437 1
rm -f scn.c scn.o
d962 1
a962 1
	eval 'v "$CPP -dD scn.c >x" 2>&'$h | sed 's/^/] /'
@


1.278
log
@fix on Interix, where tr(1) is more weird than even Solaris XPG4 one
just do not use ranges, no matter what.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.277 2008/02/29 11:57:30 tg Exp $
d344 5
d1000 4
@


1.277
log
@fix passing of env var to regression tests
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.276 2008/02/29 11:48:31 tg Exp $
a20 2
tr=/usr/ucb/tr	# Solaris: /usr/xpg4/bin/tr fails the rot13 tr command
test -f $tr || tr=tr
d48 1
a48 1
	echo :"$@@" | sed 's/^://' | $tr $alll $allu
d177 1
a177 1
	hv=`echo "$hf" | $tr -d '\012\015' | $tr -c $alll$allu$alln $alls`
d385 1
a385 1
eval 'v "$CPP scn.c | grep ct= | $tr -d \\\\015 >x" 2>&'$h | sed 's/^/] /'
d486 1
a486 1
i=`echo :"$orig_CFLAGS" | sed 's/^://' | $tr -c -d $alll$allu$alln`
d995 1
a995 1
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t' -e 'tr=$tr'" \
@


1.276
log
@handle slowlaris idiotic /usr/xpg4/bin/tr(1)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.275 2007/10/25 15:23:08 tg Exp $
a995 1
echo "export tr=$tr" >>test.sh
d997 1
a997 1
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t'" \
@


1.275
log
@get rid of u_char, u_int, u_long
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.274 2007/10/25 14:26:52 tg Exp $
d21 2
d50 1
a50 1
	echo :"$@@" | sed 's/^://' | tr $alll $allu
d179 1
a179 1
	hv=`echo "$hf" | tr -d '\012\015' | tr -c $alll$allu$alln $alls`
d387 1
a387 1
eval 'v "$CPP scn.c | grep ct= | tr -d \\\\015 >x" 2>&'$h | sed 's/^/] /'
d488 1
a488 1
i=`echo :"$orig_CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln`
d996 1
@


1.274
log
@even better: don't require 64-bit types at all
also, improve wording of Build.sh (passive terms)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.273 2007/10/25 14:18:55 tg Exp $
a662 6
ac_testn can_uinttypes '!' stdint_h 1 "for u_char, u_int, u_long" <<-'EOF'
	#include <sys/types.h>
	int main(int ac, char **av) { u_int x = (u_int)**av;
		return (x == (u_int)(u_long)(u_char)ac);
	}
EOF
a668 5
test 1 = $HAVE_CAN_UINTTYPES || cat >>stdint.h <<-'EOF'
	typedef unsigned char u_char;
	typedef unsigned int u_int;
	typedef unsigned long u_long;
EOF
@


1.273
log
@only check for 64-bit integer types if needed (arc4random support)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.272 2007/10/15 21:09:51 tg Exp $
a914 16
if test 10 = $HAVE_ARC4RANDOM$HAVE_STDINT_H; then
	ac_testn uint64_t <<-'EOF'
		#include <sys/types.h>
		int main(void) { return ((int)(uint64_t)0); }
	EOF
	ac_testn u_int64_t '!' uint64_t 0 'if u_int64_t can be used instead' <<-'EOF'
		#include <sys/types.h>
		int main(void) { return ((int)(u_int64_t)0); }
	EOF
	if test 1 = $HAVE_U_INT64_T; then
		CPPFLAGS="$CPPFLAGS -Duint64_t=u_int64_t"
		HAVE_UINT64_T=1
	fi
	ac_cppflags UINT64_T
fi

@


1.272
log
@ the check headers for declarations block must be a compile-time check,
  not a link-time check (the only one in mirtoconf, and there are, still,
  no run-time checks, thank goddess)
 NEED_ARC4RANDOM is thusly superfluous
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.271 2007/10/14 13:31:01 tg Exp $
d356 1
a356 1
$e ... which compiler we seem to use
d393 1
a393 1
$e "$bi==> which compiler we seem to use...$ao $ui$ct$ao"
d532 1
a532 1
	ac_flags 1 strpool "${ccpc}-d" 'if we can enable string pooling'
d534 1
a534 1
	ac_flags 1 strpool "${ccpc}/GF" 'if we can enable string pooling'
d538 1
a538 1
	ac_flags - 1 stackon "${ccpc}/GZ" 'if we can enable stack checks' <x
d582 1
a582 1
ac_test attribute '' 'if we have __attribute__((...)) at all' <<-'EOF'
d613 1
a613 1
ac_testn mksh_full '' "if we're building a full-featured mksh" <<-'EOF'
d620 1
a620 1
ac_testn mksh_defutf8 '' "if we assume UTF-8 is enabled" <<-'EOF'
d622 1
a622 1
	#error Nope, we shall check with setlocale() and nl_langinfo(CODESET)
d655 1
a655 1
ac_testn can_inttyp32 '!' stdint_h 1 "if we have standard 32-bit integer types" <<-'EOF'
d659 1
a659 1
ac_testn can_inttyb32 '!' can_inttyp32 1 "if we have UCB 32-bit integer types" <<-'EOF'
d663 1
a663 9
ac_testn can_inttyp64 '!' stdint_h 1 "if we have standard 64-bit integer types" <<-'EOF'
	#include <sys/types.h>
	int main(void) { return ((int)(uint64_t)0); }
EOF
ac_testn can_inttyb64 '!' can_inttyp64 1 "if we have UCB 64-bit integer types" <<-'EOF'
	#include <sys/types.h>
	int main(void) { return ((int)(u_int64_t)0); }
EOF
ac_testn can_uinttypes '!' stdint_h 1 "if we have u_char, u_int, u_long" <<-'EOF'
d669 1
a669 1
case $HAVE_CAN_INTTYP32$HAVE_CAN_INTTYB32 in
a674 4
case $HAVE_CAN_INTTYP64$HAVE_CAN_INTTYB64 in
01)	echo 'typedef u_int64_t uint64_t;' >>stdint.h ;;
00)	echo 'typedef unsigned long long uint64_t;' >>stdint.h ;;
esac
d694 1
a694 1
ac_testn can_lfs '' "if we support large files" <lft.c
d837 1
a837 1
ac_test mknod '' 'if we use mknod(), makedev() and friends' <<-'EOF'
d857 1
a857 1
	#error Win32 setmode() is different from what we need
d915 16
@


1.271
log
@ we dont need -D__Plan9__ at the moment
 finish with exit 0 for good measure
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.270 2007/10/10 11:42:24 tg Exp $
a39 1
NEED_ARC4RANDOM=0
a812 1
	NEED_ARC4RANDOM=1
d906 2
a907 2
save_LIBS=$LIBS
test 1 = $NEED_ARC4RANDOM && LIBS="$LIBS arc4random.c"
a919 1
LIBS=$save_LIBS
d925 1
@


1.270
log
@fix warning and simplify one case
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.269 2007/10/10 11:32:49 tg Exp $
d314 1
a314 1
	CPPFLAGS="$CPPFLAGS -D_BSD_EXTENSION -D_SUSV2_SOURCE -D__Plan9__"
d1072 1
@


1.269
log
@improve integer type detection, as some OSes may lack only some types
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.268 2007/10/09 14:29:42 tg Exp $
d666 1
a666 1
	int main(int ac) { return ((int)((uint64_t)ac)); }
d670 1
a670 1
	int main(int ac) { return ((int)((u_int64_t)ac)); }
d679 2
a680 1
01)	echo 'typedef u_int32_t uint32_t;' >>stdint.h ;;
@


1.268
log
@implement parallel make (Build.sh -j)
this is for the 16-fold Itanium  box with 64 GiB RAM 
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.267 2007/10/09 14:21:54 tg Exp $
a650 1
ac_header '!' stdint.h stdarg.h
d655 2
a656 1
ac_testn can_inttypes '!' stdint_h 1 "if we have standard integer types" <<-'EOF'
d658 18
a675 2
	int main(int ac, char **av) { uint32_t x = (uint32_t)**av;
		return (x == (uint64_t)(int32_t)ac);
d678 15
a692 19
if test 0 = $HAVE_CAN_INTTYPES; then
	ac_testn can_uinttypes '' "if we have u_char, u_int, u_long" <<-'EOF'
		#include <sys/types.h>
		int main(int ac, char **av) { u_int x = (u_int)**av;
			return (x == (u_int)(u_long)(u_char)ac);
		}
	EOF
	cat >stdint.h <<-'EOF'
		typedef signed int int32_t;
		typedef unsigned int uint32_t;
		typedef unsigned long long uint64_t;
	EOF
	test 1 = $HAVE_CAN_UINTTYPES || cat >>stdint.h <<-'EOF'
		typedef unsigned char u_char;
		typedef unsigned int u_int;
		typedef unsigned long u_long;
	EOF
	HAVE_STDINT_H=1
fi
@


1.267
log
@remove the deprecated -DMKSH_DO_MKNOD
instead, use the environment variable
 HAVE_MKNOD=0  force off
 HAVE_MKNOD=1  force on
 HAVE_MKNOD=x  force detection (on even if -DMKSH_SMALL)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.266 2007/09/21 10:46:56 tg Exp $
d213 1
d218 3
d1020 12
a1031 4
for file in $SRCS; do
	test -f $file || file=$srcdir/$file
	v "$CC $CFLAGS $CPPFLAGS -c $file" || exit 1
done
@


1.266
log
@initial support pcc (somewhat)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.265 2007/09/11 18:38:29 tg Exp $
d5 1
a5 2
# CPPFLAGS recognised:	MKSH_SMALL MKSH_ASSUME_UTF8 MKSH_NEED_MKNOD MKSH_NOPWNAM
#			MKSH_NOVI
d631 1
a631 1
	: ${HAVE_SETLOCALE_CTYPE=0}
a836 3
	#if defined(MKSH_SMALL) && !defined(MKSH_NEED_MKNOD)
	#error We do not want to include the mknod builtin.
	#endif
@


1.265
log
@mksh R31c
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.264 2007/09/11 18:12:16 tg Exp $
d368 2
d388 1
a388 1
bcc|dmc|gcc|hpcc|icc|msc|sunpro|tcc|tendra|xlc) ;;
@


1.264
log
@ scanning for integer types: only scan for these we need,
  i.e. uint32_t and uint64_t
 faking <stdint.h>: u_int32_t is not part of ISO C99, so
  do not add it there
 add a test if u_int32_t is declared, for the sake of the
  fucked up OpenBSD standard arc4random(3) declaration, and
  define it to uint32_t if the former type is not available,
  e.g. on Solaris or if we fake <stdint.h>
 fix detection of arc4random_pushb(3) and the prototypes
  if one of the things above applied to our system
 fix detection of arc4random function suite prototypes if
  they are added via an arc4random.c file in the srcdir, and
  copy that file into builddir (if it does not already exist)
  to keep these isolated from each other

based on a real-life bug report by cnuke@@ at the Croatian restaurant 
unbreaks set o arc4random on Solaris, both SUNpro and GCC
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.261 2007/09/10 20:16:47 tg Exp $
d654 1
a654 1
		return (x == (uint64_t)ac);
a664 2
		typedef signed char int8_t;
		typedef signed short int16_t;
a665 3
		typedef signed long long int64_t;
		typedef unsigned char uint8_t;
		typedef unsigned short uint16_t;
@


1.263
log
@do not use test  -o 
@
text
@d41 1
d654 1
a654 1
		return (x == (u_int32_t)ac);
d658 1
a658 1
	ac_testn can_inttypes2 '' "if we have u_char, u_int, u_long" <<-'EOF'
a672 1
		typedef unsigned int u_int32_t;
d745 9
d794 1
d799 4
a802 2
	HAVE_ARC4RANDOM_DECL=0
	HAVE_ARC4RANDOM_PUSH=0
d814 1
d898 2
d912 1
@


1.262
log
@make "test $x = 1" into "test 1 = $x" consistently
@
text
@d1012 1
a1012 1
rv=$?; test $ct = msc -o 0 = $rv || exit 1
@


1.261
log
@extend the scope of tests run with -Werror for gcc
otherwise, gcc4 on non-propolice-capable targets doesnt find __attribute__
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.260 2007/09/09 19:24:58 tg Exp $
d123 1
a123 1
		test $fr = 1 || fv=1
d125 1
a125 1
		test $fr = 0 || fv=1
d158 1
a158 1
	if test $hf = 1; then
d187 1
a187 1
	test $na = 1 || ac_cppflags
d237 1
a237 1
test $r = 0 && echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && \
d381 1
a381 1
test $h = 1 && sed 's/^/[ /' x
d416 1
a416 1
if test $HAVE_COULDBE_TCC = 1; then
d423 1
a423 1
if test $HAVE_COMPILER_FAILS = 1; then
d430 1
a430 1
		test $HAVE_CAN_DELEXE = 1 || CFLAGS=$save_CFLAGS
d436 1
a436 1
		test $HAVE_CAN_PLUSK = 1 || CFLAGS=$save_CFLAGS
d441 1
a441 1
	test $HAVE_COMPILER_STILL_FAILS = 1 && exit 1
d549 1
a549 1
	test $HAVE_CAN_YSYSTEM = 1 && CPPFLAGS="-Ysystem $CPPFLAGS"
d674 1
a674 1
	test 1 = $HAVE_CAN_INTTYPES2 || cat >>stdint.h <<-'EOF'
d785 1
a785 1
if test $HAVE_ARC4RANDOM = 0 && test -f "$srcdir/arc4random.c"; then
d956 1
a956 1
	test $h = 1 && printf "NSIG=$NSIG ... "
d976 1
a976 1
			test $h = 1 && printf "$name=$nr " >&2
d1004 1
a1004 1
test $ct = msc || echo 'test $? = 0 || exit 1' >>Rebuild.sh
d1012 1
a1012 1
rv=$?; test $ct = msc -o $rv = 0 || exit 1
d1016 1
a1016 1
test $r = 1 || v "$NROFF -mdoc <'$srcdir/mksh.1' >mksh.cat1" || \
d1018 1
a1018 1
test $eq = 0 && test $h = 1 && v size $result
d1021 1
a1021 1
test $eq = 1 && e=:
@


1.260
log
@ plug in some Digital Taugtnix support, with help from the IceWM coffee pot
  maintainer, or, From: Josef 'Jupp' Schugt <schugt@@cip.physik.uni-bonn.de>
 www: sync changelog
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.259 2007/09/09 18:31:41 tg Exp $
d507 1
d561 1
@


1.259
log
@more cosmetics
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.258 2007/09/09 18:30:04 tg Exp $
d304 4
@


1.258
log
@cosmetics - fix missing variable name
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.257 2007/09/09 18:21:52 tg Exp $
d310 1
a310 2
	HAVE_SIG_T=0
	CPPFLAGS="$CPPFLAGS -Dsig_t=nosig_t"
@


1.257
log
@clean up our own junk
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.256 2007/09/09 12:02:38 tg Exp $
d82 1
a82 1
		fd=$3
d97 1
a97 2
	fd=$3
	test x"$fd" = x"" && fd=$f
@


1.256
log
@some have u_int but not uint32_t
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.255 2007/09/09 11:55:44 tg Exp $
d205 1
a205 1
    scn.c signames.inc test.sh x
@


1.255
log
@-std=foo cant be made fatal even with -Werror, live with it
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.254 2007/09/09 11:04:30 tg Exp $
d653 6
d668 3
a673 1
		typedef unsigned int u_int32_t;
@


1.254
log
@autoscan for uint32_t et al. if <stdint.h> not present
this un-special-cases PW32 and should help OSF/1
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.253 2007/09/09 10:49:20 tg Exp $
a552 1
	NOWARN=$DOWARN		# run block with -Werror...
a555 1
	NOWARN=$save_NOWARN	# ... until here
@


1.253
log
@gcc 2.8.1 (on Digital Taugtnix a.k.a. alpha-dec-osf4.0d) makes -std=foo
failures a warning only
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.252 2007/09/07 21:58:40 tg Exp $
d170 1
a170 1
# ac_header header [prereq ...]
d172 6
d186 1
a186 1
	ac_test "$hv" "" "<$hf>" <x
d188 1
a310 13
	cat >stdint.h <<-'EOF'
		typedef signed char int8_t;
		typedef signed short int16_t;
		typedef signed int int32_t;
		typedef signed long long int64_t;
		typedef unsigned char uint8_t;
		typedef unsigned short uint16_t;
		typedef unsigned int uint32_t;
		typedef unsigned long long uint64_t;
		typedef unsigned char u_char;
		typedef unsigned int u_int;
		typedef unsigned long u_long;
	EOF
d643 1
a643 1
ac_header stdint.h stdarg.h
d648 25
@


1.252
log
@testing with the Heirloom sh found this doh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.251 2007/08/12 13:42:19 tg Exp $
d559 1
d563 1
@


1.251
log
@add set -o arc4random, RTFM for details
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.250 2007/07/31 11:11:23 tg Exp $
d502 1
a502 1
elif test $ct = tcc || $ct = tendra; then
@


1.250
log
@ new way of checking for mknod & friends, due to tcc vs glibc weirdness
 bump vsn for the code restructuring
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.249 2007/07/31 10:42:14 tg Exp $
d763 7
a769 3
ac_test arc4random_push arc4random 0 <<-'EOF'
	extern void arc4random_push(int);
	int main(void) { arc4random_push(1); return (0); }
d860 1
a860 1
ac_test '!' arc4random_push_decl arc4random_push 1 'if arc4random_push() does not need to be declared' <<-'EOF'
d863 2
a864 2
	void arc4random_push(long);	/* this clashes if defined before */
	int main(void) { arc4random_push(1); return (0); }
@


1.249
log
@some steps towards building with tcc
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.248 2007/07/31 10:17:52 tg Exp $
a623 7
ac_testn mksh_need_mknod '!' mksh_full 1 'if we still want c_mknod()' <<-'EOF'
	#ifndef MKSH_NEED_MKNOD
	#error Nope, the user really wants it teensy.
	#endif
	int main(void) { return (0); }
EOF

d790 13
d811 1
a811 1
ac_test setmode mksh_need_mknod 1 <<-'EOF'
@


1.248
log
@ implement some (not yet tested) kludges for tcc
 define $CPP internally
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.247 2007/07/31 10:04:46 tg Exp $
d422 1
a422 1
	CPP=cpp
@


1.247
log
@ TenDRA (testsuite pass)
 Fabrice Bellards tcc (not supported yet, may follow later)

reminded by tarzeau (Grkan Sengn)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.246 2007/07/26 22:38:31 tg Exp $
d356 1
d384 1
a384 1
eval 'v "$CC -E scn.c | grep ct= | tr -d \\\\015 >x" 2>&'$h | sed 's/^/] /'
a391 4
# kludge; tcc still isn't really supported though
case $CC:$ct in
*tcc:unknown) ct=tcc ;;
esac
d412 12
d877 1
a877 1
	eval 'v "$CC -dD -E scn.c >x" 2>&'$h | sed 's/^/] /'
d909 1
a909 1
	NSIG=`vq "$CC $CPPFLAGS -E scn.c" | grep mksh_cfg: | \
d920 1
a920 1
	    "$CC $CPPFLAGS -dD -E scn.c" | grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
d926 1
a926 1
		vq "$CC $CPPFLAGS -E scn.c" | grep mksh_cfg: | \
@


1.246
log
@these are actually cool people, I think
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.245 2007/07/24 21:54:46 tg Exp $
d370 4
d388 1
a388 1
bcc|dmc|gcc|hpcc|icc|msc|sunpro|xlc) ;;
d391 4
d460 2
d493 2
d541 6
@


1.245
log
@some more not-so working platforms
can't extend the working ones better since my UWIN decided to break
after MSVC++ Expre seems to have upgraded some libraries *sigh*
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.244 2007/07/24 21:47:13 tg Exp $
d284 2
@


1.244
log
@initial support for PW32, not quite working yet (same issues as Minix 3 and Plan 9, I think)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.243 2007/07/22 13:47:10 tg Exp $
d296 5
@


1.243
log
@de-experimental AIX
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.242 2007/07/22 13:46:13 tg Exp $
d296 19
@


1.242
log
@ Build.sh: always prepend well-known signal names, so that some signals
  will not come up weirdly (e.g. on AIX: SIGSAK (SIGMAX?), SIGIO (SIGAIO?),
  SIGURG (SIGIOINT?)), and add a few more while here
 check.t, sh.h: bump
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.241 2007/07/22 13:34:48 tg Exp $
a246 1
	warn=' and is still experimental'
@


1.241
log
@ support IBM xlC on AIX
 fix all bugs it could find 
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.240 2007/07/22 13:08:54 tg Exp $
d864 6
a869 10
	if test 1 = $HAVE_CPP_DD && test $NSIG -gt 1; then
		signames=`vq "$CC $CPPFLAGS -dD -E scn.c" | \
		    grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
		    sed 's/^\(.*[	 ]SIG\)\([A-Z0-9]*\)\([	 ].*\)$/\2/' | \
		    sort`
	else
		signames="ABRT ALRM BUS CHLD CLD CONT EMT FPE HUP ILL INT IO"
		signames="$signames IOT KILL PIPE PWR QUIT SEGV SYS STOP TERM"
		signames="$signames TRAP TSTP TTIN TTOU URG USR1 USR2 WINCH"
	fi
@


1.240
log
@ move __GNUC__ test quite to the bottom, since I fear other compilers,
  such as icc, define it too
 provide a Rebuild.sh skipping the mirtoconf checks  devel only!
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.239 2007/07/17 19:41:26 tg Exp $
d335 2
d359 1
a359 1
bcc|dmc|gcc|hpcc|icc|msc|sunpro) ;;
d424 3
d455 3
d496 8
d580 5
a584 1
	ac_flags 1 fnoinline -fno-inline
@


1.239
log
@switch $CC default from gcc to cc, as we support most native compilers now,
and  with Daniel's words  das ist doch kein Rumgeleenockse hier!
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.238 2007/07/09 11:19:55 tg Exp $
a334 2
	#elif defined(__GNUC__)
	ct=gcc
a336 2
	#elif defined(__hpux)
	ct=hpcc
d343 4
d880 9
d892 8
a909 8
case $curdir in
*\ *)	echo "#!./mksh" >test.sh ;;
*)	echo "#!$curdir/mksh" >test.sh ;;
esac
echo "export PATH='$PATH'" >>test.sh
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t'" \
    "-p '$curdir/mksh' -C $check_categories \$*$tsts" >>test.sh
chmod 755 test.sh
@


1.238
log
@hopefully fix large file stuff for real
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.237 2007/07/04 14:53:19 tg Exp $
d200 1
a200 1
: ${CC=gcc} ${NROFF=nroff}
@


1.237
log
@fix what happens after we check for -D_FILE_OFFSET_BITS=64  actually
use it. discovered in debian 29.6-2 by hondza via IRC, thanks a lot!
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.236 2007/07/01 21:59:10 tg Exp $
d602 5
a606 5
test 1 = $HAVE_CAN_LFS_SUS || CPPFLAGS=$save_CPPFLAGS
save_CPPFLAGS=$CPPFLAGS
CPPFLAGS="$CPPFLAGS -D_LARGE_FILES=1"
ac_testn can_lfs_aix '!' can_lfs 0 "... with -D_LARGE_FILES=1" <lft.c
test 1 = $HAVE_CAN_LFS_AIX || CPPFLAGS=$save_CPPFLAGS
@


1.236
log
@fix temp files not being cleaned up correctly
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.235 2007/07/01 21:52:20 tg Exp $
d602 2
a603 5
if test 1 = $HAVE_CAN_LFS_SUS; then
	HAVE_CAN_LFS=1
else
	CPPFLAGS=$save_CPPFLAGS
fi
@


1.235
log
@fix NOWARN stuff
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.234 2007/07/01 21:47:07 tg Exp $
d447 1
d485 1
@


1.234
log
@ fix display problem
 add <libutil.h> if it exists  revoke(2) on UWIN
 add <stdlib.h> for NULL in test of mmap(2)
 regen CPPFLAGS for MirBSD native builds
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.233 2007/07/01 21:27:02 tg Exp $
d405 1
a405 1
	: ${save_NOWARN='-errwarn=%none'}
d423 1
a423 1
	: ${save_NOWARN='-Wno-error'}
@


1.233
log
@ add support for the Borland C++ Builder (on UWIN)
 add support for the Digital Mars compiler (on UWIN)
 clean up
 describe new build targets and that UWIN sucks
 bump vsn
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.232 2007/07/01 19:24:11 tg Exp $
d80 3
d577 1
d709 1
d727 3
@


1.232
log
@ ugh, CR-LF line endings
 reduce number of temp files used
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.231 2007/07/01 19:04:52 tg Exp $
d239 2
a240 1
mscx=-Wc,
d246 1
a246 1
		LDFLAGS="-Wl,-bI:crypt.exp"
d273 2
a274 1
	mscx='-X '
d286 1
a286 1
#	warn="$warn$nl but not with ACK - /usr/bin/cc - yet)"
d298 2
a299 1
	mscx='-Yc,'
d301 2
d338 4
d354 1
a354 1
gcc|hpcc|icc|msc|sunpro) ;;
d380 20
a399 6
save_CFLAGS=$CFLAGS
CFLAGS="$CFLAGS -Wl,+k"
ac_testn can_plusk compiler_fails 0 'for the +k linker option' <<-EOF
	int main(void) { return (0); }
EOF
test $HAVE_CAN_PLUSK = 1 || CFLAGS=$save_CFLAGS
d411 8
a418 2
	save_NOWARN="${mscx}/w"
	DOWARN="${mscx}/WX"
d468 5
d474 1
d478 5
a482 6
	ac_flags 1 strpool "${mscx}/GF" 'if we can enable string pooling'
	ac_flags - 1 stackon "${mscx}/GZ" 'if we can enable stack checks' <x
	ac_flags - 1 stckall "${mscx}/Ge" 'stack checks for all functions' <x
	ac_flags - 1 secuchk "${mscx}/GS" 'for compiler security checks' <x
	ac_flags 1 wall "${mscx}/Wall" 'to enable all warnings'
	ac_flags 1 wp64 "${mscx}/Wp64" 'to enable 64-bit warnings'
@


1.231
log
@coerce this into running on UWIN - or rather sort of. Ugly.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.230 2007/07/01 18:00:18 tg Exp $
d195 1
a195 1
    scn.c signames.inc test.sh x y
d239 1
a239 1
mscx=-Wc,
d296 1
a296 1
	mscx='-Yc,'
d440 1
a440 1
	cat >y <<-'EOF'
d444 3
a446 3
	ac_flags - 1 stackon "${mscx}/GZ" 'if we can enable stack checks' <y
	ac_flags - 1 stckall "${mscx}/Ge" 'stack checks for all functions' <y
	ac_flags - 1 secuchk "${mscx}/GS" 'for compiler security checks' <y
@


1.230
log
@MSC improvements
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.229 2007/07/01 17:22:07 tg Exp $
d239 2
a240 1
mscx=-Wc,
d296 2
a297 1
	mscx='-Yc,'
d858 1
a858 1
    "-p '$curdir/mksh' -C $check_categories \$*" >>test.sh
@


1.229
log
@ mirtoconf if MS C security checks work (with our C library)
 simplify "-Wc," ./. "-X " ./. "-Yc," separation
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.228 2007/07/01 17:19:15 tg Exp $
d438 1
a438 4
	ac_flags 1 strpool "${mscx}/GF" 'if we can enable string pooling'
	ac_flags 1 stackon "${mscx}/GZ" 'if we can enable stack checks'
	ac_flags 1 stckall "${mscx}/Ge" 'stack checks for all functions'
	ac_flags - 1 secuchk "${mscx}/GS" 'if security checks work' <<-'EOF'
d441 4
@


1.228
log
@mirtoconf for mmap(2), UWIN doesn't have it
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.227 2007/07/01 16:57:00 tg Exp $
d239 1
d271 1
a273 2
	# MSC externs that are not library functions
	: ${HAVE_CAN_SECUCHK=0}
d295 1
a385 11
	case $TARGET_OS in
	Interix)
		mscx="-X "
		;;
	UWIN*)
		mscx="-Yc,"
		;;
	*)
		mscx="-Wc,"
		;;
	esac
d441 3
a443 1
	ac_flags 1 secuchk "${mscx}/GS" 'if we can enable security checks'
@


1.227
log
@some vendors' cc(1) doesn't support -E from stdin like cpp(1)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.226 2007/07/01 16:47:05 tg Exp $
d671 1
a671 1
ac_test flock_ex '' 'flock and LOCK_EX' <<-'EOF'
d674 1
d676 2
a677 1
	int main(void) { return (flock(0, LOCK_EX)); }
@


1.226
log
@ enable UWIN as operating environment
 cover for differences in UWIN's and Interix' cc(1) wrapper
 AT&T tr(1) is defective, just skip + and - chars
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.224 2007/06/30 22:02:50 tg Exp $
d195 1
a195 1
    scn.c signames.inc test.sh x
d766 2
a767 2
	eval '( echo "#define foo bar" | v "$CC -dD -E - >x" ) 2>&'$h | \
	    sed 's/^/] /'
d769 1
a769 1
	rm -f x
d792 8
a799 3
	NSIG=`( echo '#include <signal.h>'; echo '#ifndef NSIG'; \
	    echo '#define NSIG _NSIG'; echo '#endif'; echo mksh_cfg: NSIG ) | \
	    vq "$CC $CPPFLAGS -E -" | grep mksh_cfg: | \
d807 1
a807 2
		signames=`echo '#include <signal.h>' | \
		    vq "$CC $CPPFLAGS -dD -E -" | \
d818 3
a820 2
		( echo '#include <signal.h>'; echo mksh_cfg: SIG$name ) | \
		    vq "$CC $CPPFLAGS -E -" | grep mksh_cfg: | \
d833 1
@


1.225
log
@ fix AIX variant of large files
 use DOWARN semantically correct
 support the Microsoft C Compiler
 on Interix, disable msc's security checks, as it relies on
  library functions not provided by Interix' libc (XXX mirtoconf this)
@
text
@d294 2
d385 13
a397 2
	save_NOWARN='-X /w'
	DOWARN='-X /WX'
d412 1
a412 1
i=`echo :"$orig_CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln+-`
d448 6
a453 6
	ac_flags 1 strpool '-X /GF' 'if we can enable string pooling'
	ac_flags 1 stackon '-X /GZ' 'if we can enable stack checks'
	ac_flags 1 stckall '-X /Ge' 'stack checks for all functions'
	ac_flags 1 secuchk '-X /GS' 'if we can enable security checks'
	ac_flags 1 wall '-X /Wall' 'to enable all warnings'
	ac_flags 1 wp64 '-X /Wp64' 'to enable 64-bit warnings'
@


1.224
log
@oops (quoting)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.223 2007/06/30 21:34:23 tg Exp $
d272 2
d328 2
d335 1
a335 1
eval 'v "$CC -E scn.c | grep ct= >x" 2>&'$h | sed 's/^/] /'
d340 1
a340 1
icc|gcc|hpcc|sunpro) ;;
d360 1
d378 1
a378 1
	test 1 = $HAVE_CAN_ERRWARNALL && NOWARN="-errwarn=%all"
d381 4
a384 1
	NOWARN=+We
d390 1
a390 1
	test 1 = $HAVE_CAN_WERROR && NOWARN=-Werror
d393 1
a393 2
test $ct = icc && NOWARN="$NOWARN -wd1419"
DOWARN=$NOWARN
d434 7
d559 1
a559 1
CPPFLAGS="$CPPFLAGS _LARGE_FILES=1"
d828 2
a829 1
v "$CC $CFLAGS $LDFLAGS -o mksh $objs $LIBS" || exit 1
@


1.223
log
@optimise, fix quoting, modularise even more
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.222 2007/06/30 21:01:42 tg Exp $
d417 2
a418 2
	ac_flags 1 fnobuiltinsetmode -fno-builtin-setmode"
	ac_flags 1 fnostrictaliasing -fno-strict-aliasing"
d503 1
a503 1
	ac_flags 1 fnoinline "-fno-inline"
@


1.222
log
@improve wording and remove a dead check
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.221 2007/06/30 20:57:55 tg Exp $
d40 1
d109 1
a109 1
		reverse=1
d112 1
a112 1
		reverse=0
d121 1
a121 1
		test $reverse = 1 || fv=1
d123 1
a123 1
		test $reverse = 0 || fv=1
d129 7
d138 1
a138 1
	eval CPPFLAGS=\"\$CPPFLAGS -DHAVE_$fu=\$HAVE_$fu\"
d251 1
a251 1
	: ${LIBS=-lcrypt}
d271 1
a271 1
	: ${LIBS=-lcrypt}
d345 2
a346 2
	gcc:ia64) : ${CFLAGS='-O2 -mlp64'} ;;
	hpcc:ia64) : ${CFLAGS='+O2 +DD64'} ;;
a353 1
orig_CFLAGS=$CFLAGS
d369 1
a369 1
	test x"$save_NOWARN" = x"" && save_NOWARN='-errwarn=%none'
d373 1
a374 1
	HAVE_CAN_WERROR=0
d376 1
d378 1
a378 1
	test x"$save_NOWARN" = x"" && save_NOWARN=-Wno-error
d381 2
a382 1
	ac_flags 0 werror "-Werror"
a384 3
test $ct != sunpro && test 1 = $HAVE_CAN_WERROR && NOWARN=-Werror
test $ct = sunpro && test 1 = $HAVE_CAN_ERRWARNALL && NOWARN='-errwarn=%all'
test $ct = hpcc && NOWARN=+We
d392 11
a402 12
i=`echo :"$orig_CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln-`
if test $ct = sunpro; then
	if test x"$i" = x""; then
		cat >x <<-'EOF'
			int main(void) { return (0); }
			#define __IDSTRING_CONCAT(l,p)	__LINTED__ ## l ## _ ## p
			#define __IDSTRING_EXPAND(l,p)	__IDSTRING_CONCAT(l,p)
			#define pad			void __IDSTRING_EXPAND(__LINE__,x)(void) { }
		EOF
		yes pad | head -n 256 >>x
		ac_flags - 1 otwo "-xO2" <x
	fi
d404 1
a404 3
	test x"$i" = x"" && ac_flags 1 otwo "+O2"
	ac_flags 1 agcc "-Agcc"
	ac_flags 1 ac99 "-AC99"
d406 2
a407 1
	test x"$i" = x"" && ac_flags 1 otwo "-O2"
d409 2
d412 4
a415 7
	ac_flags 1 fnostrictaliasing "-fno-strict-aliasing"
	ac_flags 1 fstackprotectorall "-fstack-protector-all"
	ac_flags 1 fwrapv "-fwrapv"
	# I'd use -std=c99 but this wrecks havoc on glibc and cygwin based
	# systems (at least) because their system headers are so broken...
	ac_flags 1 stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'
	ac_flags 1 wall "-Wall"
d417 14
a430 4
	ac_flags 1 fnobuiltinsetmode "-fno-builtin-setmode"
	ac_flags 1 fnostrictaliasing "-fno-strict-aliasing"
	ac_flags 1 fstacksecuritycheck "-fstack-security-check"
	ac_flags 1 stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'
d432 2
a433 5
	    ac_flags 1 stdc99 "-std=c99" 'if -std=c99 can be used'
	ac_flags 1 wall "-Wall"
elif test $ct = sunpro; then
	ac_flags 1 v "-v"
	ac_flags 1 xc99 "-xc99"
d588 1
a588 1
CPPFLAGS="$CPPFLAGS -DHAVE_SIG_T=$HAVE_SIG_T"
d609 1
a609 1
	eval CPPFLAGS=\"\$CPPFLAGS -DHAVE_SYS_SIG$uwhat=\$HAVE_SYS_SIG$uwhat\"
d637 1
a637 1
CPPFLAGS="$CPPFLAGS -DHAVE_ARC4RANDOM=$HAVE_ARC4RANDOM"
a729 1
CPPFLAGS="$CPPFLAGS -DHAVE_PERSISTENT_HISTORY=$fv"
d732 1
@


1.221
log
@modularise, optimise, upgrade coding style(9), display nicer
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.220 2007/06/30 20:04:23 tg Exp $
d471 1
a471 1
ac_testn mksh_full '' "if we're building without MKSH_SMALL" <<-'EOF'
d473 1
a473 1
	#error OK, we are building an extra small mksh.
a491 7
ac_testn mksh_nopam mksh_full 1 'if the user wants to omit getpwnam()' <<-'EOF'
	#ifndef MKSH_NOPWNAM
	#error No, the user wants to pull in getpwnam.
	#endif
	int main(void) { return (0); }
EOF

@


1.220
log
@nuke $tcbo (unused)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.219 2007/06/30 19:58:51 tg Exp $
d8 1
a8 2
v()
{
d13 1
a13 2
vq()
{
a27 10
if test -t 1; then
	bi='[1m'
	ui='[4m'
	ao='[0m'
else
	bi=
	ui=
	ao=
fi

d35 11
d47 1
a47 2
upper()
{
d51 11
a61 9
# pipe .c | ac_test[n] [!] label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
ac_testn()
{
	if test x"$1" = x"!"; then
		reverse=1
		shift
	else
		reverse=0
	fi
d64 18
a94 9
	eval fv=\$HAVE_$fu
	if test 0 = "$fv"; then
		$e "$bi==> $fd...$ao ${ui}no$ao (cached)"
		return
	fi
	if test 1 = "$fv"; then
		$e "$bi==> $fd...$ao ${ui}yes$ao (cached)"
		return
	fi
d97 3
a99 5
		eval HAVE_$fu=$fv
		test 0 = "$fv" && fv=no
		test 1 = "$fv" && fv=yes
		$e "$bi==> $fd...$ao $ui$fv$ao (implied)"
		return
d102 12
a118 1
	fr=0
d120 1
a120 1
		test $reverse = 1 || fr=1
d122 1
a122 8
		test $reverse = 0 || fr=1
	fi
	if test $fr = 1; then
		eval HAVE_$fu=1
		$e "$bi==> $fd...$ao ${ui}yes$ao"
	else
		eval HAVE_$fu=0
		$e "$bi==> $fd...$ao ${ui}no$ao"
d125 1
d128 1
a128 2
ac_test()
{
d134 1
a134 2
ac_flags()
{
d160 1
a160 2
ac_header()
{
d173 1
a173 2
addsrcs()
{
d182 2
a183 2
if test -d mksh; then
	echo "$0: Error: ./mksh is a directory!" >&2
d211 1
a211 1
		echo "$0: Unknown option '$i'!" >&2
d300 1
a300 1
$e ${ao}Scanning for functions... please ignore any errors.
d725 5
a729 20
case $HAVE_PERSISTENT_HISTORY:$HAVE_FLOCK_EX$HAVE_MKSH_FULL in
0:*)
	fv="yes$ao (cached)"
	;;
1:*)
	fv="no$ao (cached)"
	;;
*:11)
	HAVE_PERSISTENT_HISTORY=1
	fv=yes$ao
	;;
*)
	HAVE_PERSISTENT_HISTORY=0
	fv=no$ao
	;;
esac
$e "$bi==> if to use persistent history...$ao $ui$fv"
CPPFLAGS="$CPPFLAGS -DHAVE_PERSISTENT_HISTORY=$HAVE_PERSISTENT_HISTORY"
test 1 = $HAVE_PERSISTENT_HISTORY || \
    check_categories=$check_categories,no-histfile
d734 7
a740 21
if test 0 = $HAVE_SYS_SIGNAME; then
	fd='checking if the C Preprocessor supports -dD'
	if test 0 = "$HAVE_CPP_DD"; then
		$e "$bi==> $fd...$ao ${ui}no$ao (cached)"
	elif test 1 = "$HAVE_CPP_DD"; then
		$e "$bi==> $fd...$ao ${ui}yes$ao (cached)"
	else
		$e ... $fd
		eval '( echo "#define foo bar" | \
		    v "$CC -dD -E - >x" ) 2>&'$h | \
		    sed 's/^/] /'
		if grep '#define foo bar' x >/dev/null 2>&1; then
			HAVE_CPP_DD=1
			fv=yes
		else
			HAVE_CPP_DD=0
			fv=no
		fi
		rm -f x
		$e "$bi==> $fd...$ao $ui$fv$ao"
	fi
@


1.219
log
@make HAVE_CPP_DD a 0/1/undef mirtoconf value like the others
XXX maybe generalise the logic from there and ac_testn
XXX offer the user to give list of known signal names (and NSIG? or ignore?)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.218 2007/06/30 19:48:04 tg Exp $
a45 1
tcbo=
a99 1
	test x"$tcbo" = x"1" && return
@


1.218
log
@ bugfix  "printf %d '(1)'" is a syntax error too, enhance character class
 speed up  I don't worry about embedded control characters in the source,
  as jupp(1) handles these just fine [http://mirbsd.de/jupp]
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.217 2007/06/23 20:51:21 tg Exp $
a742 1
HAVE_CPP_DD=yes
d744 20
a763 6
	$e ... checking if the C Preprocessor supports -dD
	eval '( echo "#define foo bar" | v "$CC -dD -E - >x" ) 2>&'$h | \
	    sed 's/^/] /'
	grep '#define foo bar' x >/dev/null 2>&1 || HAVE_CPP_DD=no
	$e "$bi==> checking if the C Preprocessor supports -dD...$ao $ui$HAVE_CPP_DD$ao"
	rm -f x
d779 1
a779 1
	if test $HAVE_CPP_DD = yes; then
d794 1
a794 1
	if test $HAVE_CPP_DD = yes && test $NSIG -gt 1; then
@


1.217
log
@kludge for intel's c(rap) compiler
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.216 2007/06/21 16:11:37 tg Exp $
d31 3
a33 3
	bi=`printf '\033[1m'`
	ui=`printf '\033[4m'`
	ao=`printf '\033[0m'`
d777 1
a777 1
	*[\ +-]*) NSIG=`awk "BEGIN { print $NSIG }"` ;;
@


1.216
log
@solve the ugly warnings, be more consistent, allow __attribute__ to depend
on compiler option features, etc.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.215 2007/06/21 15:53:14 tg Exp $
d373 1
@


1.215
log
@this solves
| HP-UX td193 B.11.31 U ia64 2909796781 unlimited-user license
| cc: HP C/aC++ B3910B A.06.14 [Feb 22 2007]
| ld: 92453-07 linker ld HP Itanium(R) B.12.43  IPF/IPF
| Total failed: 1 (as expected)
| Total passed: 220
except for an ugly warning
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.214 2007/06/21 15:43:33 tg Exp $
d332 1
a332 1
	hpcc:ia64) : ${CFLAGS='-O2 +DD64'} ;;
d340 1
a369 1
# The following tests are run with -Werror if possible
d372 2
a373 30

#
# Compiler: check for stuff that only generates warnings
#
ac_test attribute '' 'if we have __attribute__((...)) at all' <<-'EOF'
	#include <stdlib.h>
	#undef __attribute__
	void fnord(void) __attribute__((noreturn));
	int main(void) { fnord(); }
	void fnord(void) { exit(0); }
EOF

ac_test attribute_bounded attribute 0 'for __attribute__((bounded))' <<-'EOF'
	#include <string.h>
	#undef __attribute__
	int xcopy(const void *, void *, size_t)
	    __attribute__((bounded (buffer, 1, 3)))
	    __attribute__((bounded (buffer, 2, 3)));
	int main(int ac, char *av[]) { return (xcopy(av[0], av[--ac], 1)); }
	int xcopy(const void *s, void *d, size_t n) {
		memmove(d, s, n); return (n);
	}
EOF

ac_test attribute_used attribute 0 'for __attribute__((used))' <<-'EOF'
	static const char fnord[] __attribute__((used)) = "42";
	int main(void) { return (0); }
EOF

# End of tests run with -Werror
d379 1
a379 1
i=`echo :"$CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln-`
d391 4
d427 34
@


1.214
log
@make this build with
| cpp.ansi: HP92453-01 B.11.31.01 HP C Preprocessor (ANSI)
| ccom: HP92453-01 B.11.X.36086-36089-36092.GP HP C Compiler
| /usr/ccs/bin/ld: 92453-07 linker linker ld B.11.60 070209
on
| mirbsd@@td191:~/mksh $ uname -a
| HP-UX td191 B.11.31 U 9000/800 3397116299 unlimited-user license
resulting in
| Total failed: 1 (as expected)
| Total passed: 220

so I suppose it's no longer experimental on HP-UX it also works on/with
| HP-UX td192 B.11.11 U 9000/800 1839940656 unlimited-user license
| gcc version 3.4.2
| Can't locate POSIX.pm in @@INC
and
| HP-UX td192 B.11.11 U 9000/800 1839940656 unlimited-user license
| cpp.ansi: HP92453-01 B.11.X.35175-35176.GP HP C Preprocessor (ANSI)
| ccom: HP92453-01 B.11.X.36086-36089-36092.GP HP C Compiler
| /usr/ccs/bin/ld: 92453-07 linker linker ld B.11.60 070209
and
| HP-UX td176 B.11.23 U ia64 1928826293 unlimited-user license
| Reading specs from /usr/local/lib/gcc/ia64-hp-hpux11.23/3.4.3/specs
| Total failed: 1 (as expected)
| Total passed: 219

still work to do for HP C on IA64
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.213 2007/06/15 21:55:18 tg Exp $
a253 3
	case `uname -m` in
	ia64) : ${CFLAGS='-O2 -mlp64'} ;;
	esac
d297 1
a297 1
# Compiler: works as-is, with -Wno-error and -Werror
a298 14
save_NOWARN=$NOWARN
NOWARN=
ac_flags 0 compiler_works '' 'if the compiler works'
test 1 = $HAVE_CAN_COMPILER_WORKS || exit 1
ac_testn compiler_fails '' 'if the compiler does not fail correctly' <<-EOF
	int main(void) { return (thiswillneverbedefinedIhope()); }
EOF
save_CFLAGS=$CFLAGS
CFLAGS="$CFLAGS -Wl,+k"
ac_testn can_plusk compiler_fails 0 'for the +k linker option' <<-EOF
	int main(void) { return (0); }
EOF
test $HAVE_CAN_PLUSK = 1 || CFLAGS=$save_CFLAGS

d328 26
a361 1
	NOWARN=
@


1.213
log
@ check.t: add some FPOSIX regression tests (1 still fails)
 all: remove vi editing mode #if defined(MKSH_SMALL) || defined(MKSH_NOVI)
  saves 12608 byts on i386
 check.t: add $0 quoting
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.212 2007/06/10 17:06:07 tg Exp $
a253 1
	warn=' and is still experimental'
d306 9
d316 3
d327 2
d339 1
a339 1
icc|gcc|sunpro) ;;
d350 4
@


1.212
log
@from my change in debian mksh-29.6-2: if arc4random exists, use it
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.211 2007/06/09 22:06:55 tg Exp $
d5 2
a6 1
# CPPFLAGS recognised: MKSH_SMALL MKSH_ASSUME_UTF8 MKSH_NEED_MKNOD MKSH_NOPWNAM
@


1.211
log
@fix -xO2 to environment addition, discovered by cnuke@@
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.210 2007/06/09 22:01:40 tg Exp $
d575 1
a575 1
ac_test arc4random <<-'EOF'
d584 9
@


1.210
log
@don't use __extension__, cought by sunpro on linux
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.209 2007/06/06 23:25:28 tg Exp $
d383 2
a384 2
	test x"$i" = x"" && (
		cat <<-'EOF'
d390 3
a392 2
		yes pad | head -n 256
	) | ac_flags - 1 otwo "-xO2"
@


1.209
log
@ugh (no comment)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.208 2007/06/06 22:03:24 tg Exp $
d416 1
a416 1
	#define ksh_isspace(c)	__extension__({				\
@


1.208
log
@oops
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.207 2007/06/06 21:59:38 tg Exp $
d404 1
@


1.207
log
@remove support for $CPP, just use $CC -E (-) instead consistently
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.206 2007/06/06 21:56:12 tg Exp $
d325 1
a325 1
gcc|sunpro) ;;
@


1.206
log
@part 1 of the icc support diff (experimental, untested)
icc sucks
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.205 2007/06/06 21:36:29 tg Exp $
d4 1
a4 1
# Environment used: CC CFLAGS CPP CPPFLAGS LDFLAGS LIBS NOWARN NROFF TARGET_OS
d182 1
a182 1
: ${CC=gcc} ${CPP=false} ${NROFF=nroff}
a696 17
	$e ... checking how to run the C Preprocessor
	save_CPP=$CPP
	for i in "$save_CPP" "$CC -E -" "cpp" "/usr/libexec/cpp" "/lib/cpp"; do
		CPP=$i
		test x"$CPP" = x"false" && continue
		eval '( ( echo "#if (23 * 2 - 2) == (fnord + 2)"
		    echo mksh_rules: fnord
		    echo "#endif"
		  ) | v "$CPP $CPPFLAGS -Dfnord=42 >x" ) 2>&'$h | \
		    sed 's/^/] /'
		grep '^mksh_rules:.*42' x >/dev/null 2>&1 || CPP=false
		rm -f x
		test x"$CPP" = x"false" || break
	done
	$e "$bi==> checking how to run the C Preprocessor...$ao $ui$CPP$ao"
	test x"$CPP" = x"false" && exit 1

d698 1
a698 1
	eval '( echo "#define foo bar" | v "$CPP -dD >x" ) 2>&'$h | \
d726 1
a726 1
	    vq "$CPP $CPPFLAGS" | grep mksh_cfg: | \
d735 1
a735 1
		    vq "$CPP $CPPFLAGS -dD" | \
d747 1
a747 1
		    vq "$CPP $CPPFLAGS" | grep mksh_cfg: | \
@


1.205
log
@first part of the Intel C Compiler (Linux) shaddap
| tglaser@@hephaistos:~ $ /usr/local/intel/cc/9.1.042/bin/icc -V
| Intel(R) C Compiler for 32-bit applications, Version 9.1    Build 20060706Z Package ID: l_cc_c_9.1.042
this one is muuuuch too verbose IMHO, _and_ it #defines __GNUC__ (eek)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.204 2007/06/05 23:10:51 tg Exp $
d309 3
a311 1
	#if defined(__GNUC__)
d403 7
@


1.204
log
@even if Solaris 10 still doesn't have the mdoc libraries, don't make it
impossible to, e.g. by setenv NROFF, create catman pages on it
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.203 2007/06/05 21:47:48 tg Exp $
d407 1
a407 1
		unsigned char ksh_isspace_c = (c);			\
@


1.203
log
@with this, we don't need the special list of pre-known signal names
any more either, and can make use of code sharing between detection
of sys_siglist and sys_signame (and the underscored variants); nuke
the now-useless signames.c file too (merge struct into histrap.c)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.201 2007/06/05 21:10:52 tg Exp $
a279 1
	r=1
@


1.202
log
@HAVE_PERSISTENT_HISTORY is req'd in CPPFLAGS, oops
@
text
@d539 16
a554 38
ac_test mksh_signame '' 'our own list of signal names' <<-'EOF'
	#include <stdlib.h>	/* for NULL */
	#define MKSH_SIGNAMES_CHECK
	#include "signames.c"
	int main(void) { return (mksh_sigpairs[0].nr); }
EOF

ac_test sys_signame '!' mksh_signame 0 'the sys_signame[] array' <<-'EOF'
	extern const char *const sys_signame[];
	int main(void) { return (sys_signame[0][0]); }
EOF

ac_test _sys_signame '!' sys_signame 0 'the _sys_signame[] array' <<-'EOF'
	extern const char *const _sys_signame[];
	int main(void) { return (_sys_signame[0][0]); }
EOF

if test 000 = $HAVE_SYS_SIGNAME$HAVE__SYS_SIGNAME$HAVE_MKSH_SIGNAME; then
	NEED_MKSH_SIGNAME=1
else
	NEED_MKSH_SIGNAME=0
fi

# only testn: added later below
ac_testn sys_siglist '' 'the sys_siglist[] array' <<-'EOF'
	extern const char *const sys_siglist[];
	int main(void) { return (sys_siglist[0][0]); }
EOF

ac_testn _sys_siglist '!' sys_siglist 0 'the _sys_siglist[] array' <<-'EOF'
	extern const char *const _sys_siglist[];
	int main(void) { return (_sys_siglist[0][0]); }
EOF
if test 1 = $HAVE__SYS_SIGLIST; then
	CPPFLAGS="$CPPFLAGS -Dsys_siglist=_sys_siglist"
	HAVE_SYS_SIGLIST=1
fi
CPPFLAGS="$CPPFLAGS -DHAVE_SYS_SIGLIST=$HAVE_SYS_SIGLIST"
d688 1
a688 1
if test 1 = $NEED_MKSH_SIGNAME; then
d726 1
a726 1
if test 1 = $NEED_MKSH_SIGNAME; then
@


1.201
log
@even without cpp -dD scan for a number of common signal names
enables kill -TERM 1 on solaris with the SUNpro 5.8 compiler
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.198 2007/06/05 20:01:26 tg Exp $
d702 1
@


1.200
log
@ignore any whitespace between preprocessor output tokens
@
text
@d747 6
a752 2
test 1 = $NEED_MKSH_SIGNAME && if test $HAVE_CPP_DD = yes; then
	$e Generating list of signal names...
d763 13
a775 5
	test $NSIG -gt 1 || exit 1
	echo '#include <signal.h>' | vq "$CPP $CPPFLAGS -dD" | \
	    grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
	    sed 's/^\(.*[	 ]SIG\)\([A-Z0-9]*\)\([	 ].*\)$/\2/' | \
	    sort | while read name; do
d786 1
a786 1
			test $h = 1 && printf "$nr " >&2
a789 1
	grep ', ' signames.inc >/dev/null 2>&1 || exit 1
a790 3
else
	$e No list of signal names available via cpp.
	printf >signames.inc
@


1.199
log
@sort the signals list; this has the effect to, on Solaris, prefer
SIGABRT to SIGIOT (good), SIGCHLD to SIGCLD (necessary and reason),
SIGIO to SIGPOLL (the former also exists on mirbsd so okay); changes
on other OSes should be monitored by porters
@
text
@d753 1
a753 1
	    sed 's/^mksh_cfg: \([0-9x ()+-]*\).*$/\1/'`
d766 1
a766 1
		    sed 's/^mksh_cfg: \([0-9x]*\).*$/\1:'$name/
@


1.198
log
@shortcut
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.197 2007/06/05 19:48:45 tg Exp $
d763 1
a763 1
	    while read name; do
@


1.197
log
@fix for the SUNpro 8 on yofuh's E420:
cc: Sun C 5.8 Patch 121015-04 2007/01/10
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.196 2007/06/05 19:39:20 tg Exp $
d685 17
a701 6
ac_test persistent_history mksh_full 0 'if to use persistent history' <<-'EOF'
	#if !HAVE_FLOCK_EX || defined(MKSH_SMALL)
	#error No, some prerequisites are missing.
	#endif
	int main(void) { return (0); }
EOF
@


1.196
log
@ugh, echo -n is NOT portable
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.195 2007/06/04 21:27:53 tg Exp $
d319 4
a322 1
eval `$CC -E scn.c | grep ct=`
d404 1
d406 8
d451 1
@


1.195
log
@When compiling native MirOS BSD binaries with SUNpro 12 (don't look like a
car only slower, yes this is possible, and the resulting binary passes the
testsuite just fine), the definition of __RCSID() in <sys/cdefs.h> expands
to something with __attribute__((used)), which triggers a warning, because
__attribute__ in general is supported but the used attribute isn't. Thusly
always use our own strings and get rid of the MULTI_RCSID test (introduced
because __RCSID() on Darwin is inferiour).

Maybe we should fix <sys/cdefs.h> too? #ifdef __SUNPRO_C helps here.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.194 2007/06/04 21:15:27 tg Exp $
d758 1
a758 1
	echo -n >signames.inc
@


1.194
log
@remove the .o files too
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.193 2007/06/04 20:26:47 tg Exp $
a680 9
# Should be the _last_ one
ac_test multi_idstring '' 'if we can use __RCSID(x) multiple times' <<-'EOF'
	#define HAVE_MULTI_IDSTRING 1
	#include "sh.h"
	__RCSID("one");
	__RCSID("two");
	int main(void) { return (0); }
EOF

@


1.193
log
@glibc headers with SUNpro make this test pass incorrectly
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.192 2007/06/04 20:22:08 tg Exp $
d114 1
a114 1
	rm -f scn.c $tcfn
d179 2
a180 2
rm -f a.exe a.out *core crypt.exp lft mksh mksh.cat1 mksh.exe no scn.c \
    signames.inc test.sh x
d325 1
a325 1
rm -f scn.c
d479 1
a479 1
rm -f lft.c	# end of large file support test
@


1.192
log
@use our includes first
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.191 2007/06/04 20:14:34 tg Exp $
d348 1
d356 1
@


1.191
log
@do not compile all files at once any more; collect .o files in $curdir rather
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.190 2007/06/04 20:00:50 tg Exp $
d215 5
a219 1
CPPFLAGS="$CPPFLAGS -I. -I'$srcdir'"
@


1.190
log
@work around a fucking bug in the fuckin' optimiser (hi )
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.189 2007/06/03 17:29:29 tg Exp $
d96 2
a97 2
	eval 'v "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -I'\''$srcdir'\' \
	    'scn.c $LIBS" 2>&'$h | sed 's/^/] /'
d215 1
a289 2
CPPFLAGS="$CPPFLAGS -I'$curdir'"

d768 7
a774 2
(v "cd '$srcdir' && exec $CC $CFLAGS $CPPFLAGS" \
    "$LDFLAGS -o '$curdir/mksh' $SRCS $LIBS") || exit 1
@


1.189
log
@we don't need to check for -fno-tree-vrp any longer either
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.188 2007/05/31 21:25:25 tg Exp $
d123 1
a123 1
# ac_flags add varname flags [text]
d126 6
d139 7
a145 3
	ac_testn can_$vn '' "$ft" <<-'EOF'
		int main(void) { return (0); }
	EOF
d374 9
a382 1
	test x"$i" = x"" && ac_flags 1 otwo "-xO2"
@


1.188
log
@first stage of adaption to SUNpro CC (Sun Studio 12, to be released on next
Monday, running under Linuxulator) 
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.187 2007/05/28 13:47:09 tg Exp $
a368 38
	ac_flags 0 fnotreevrp "-fno-tree-vrp"
	if test 1 = $HAVE_CAN_FNOTREEVRP; then
		tcbo=1
		ac_testn need_fnotreevrp '' "if to use it to prevent a gcc bug" <<-'EOF'
			typedef unsigned size_t;
			char *strncpy(char *, const char *, size_t);
			char *
			strncpy(char *d, const char *s, size_t n)
			{
				if (!d || !s) {
					if (d)
						*d = n;
					return (d);
				}
				return (*d = 1, d);
			}
			int
			main(void)
			{
				char a[] = "t";
				strncpy(a, (void *)0, 2);
				return (*a);
			}
		EOF
		tcbo=
		if test -f $tcfn; then
			./$tcfn >/dev/null 2>&1
			rv=$?
			rs=no
		else
			rv=0
			rs="yes (assumed; cannot run ./$tcfn)"
		fi
		test 1 = $rv && rs=yes
		test 2 = $rv || CFLAGS="$CFLAGS -fno-tree-vrp"
		$e "$bi==> $fd...$ao ${ui}$rs$ao"
		rm -f scn.c $tcfn
	fi
a370 1
	#ac_flags 1 fwholepgm "-fwhole-program --combine"
@


1.187
log
@by packager request from gecko2, add option -Q which makes the
post-build a little bit more quiet
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.186 2007/05/24 23:07:18 tg Exp $
a289 1
test x"$NOWARN" = x"" && NOWARN=-Wno-error
d294 31
a324 3
ac_flags 0 wnoerror "$save_NOWARN"
test 1 = $HAVE_CAN_WNOERROR || save_NOWARN=
ac_flags 0 werror "-Werror"
d327 2
a328 1
test 1 = $HAVE_CAN_WERROR && NOWARN=-Werror
d363 28
a390 14
test x"$i" = x"" && ac_flags 1 otwo "-O2"
ac_flags 0 fnotreevrp "-fno-tree-vrp"
if test 1 = $HAVE_CAN_FNOTREEVRP; then
	tcbo=1
	ac_testn need_fnotreevrp '' "if to use it to prevent a gcc bug" <<-'EOF'
		typedef unsigned size_t;
		char *strncpy(char *, const char *, size_t);
		char *
		strncpy(char *d, const char *s, size_t n)
		{
			if (!d || !s) {
				if (d)
					*d = n;
				return (d);
d392 14
a405 18
			return (*d = 1, d);
		}
		int
		main(void)
		{
			char a[] = "t";
			strncpy(a, (void *)0, 2);
			return (*a);
		}
	EOF
	tcbo=
	if test -f $tcfn; then
		./$tcfn >/dev/null 2>&1
		rv=$?
		rs=no
	else
		rv=0
		rs="yes (assumed; cannot run ./$tcfn)"
d407 10
a416 4
	test 1 = $rv && rs=yes
	test 2 = $rv || CFLAGS="$CFLAGS -fno-tree-vrp"
	$e "$bi==> $fd...$ao ${ui}$rs$ao"
	rm -f scn.c $tcfn
a417 8
ac_flags 1 fnostrictaliasing "-fno-strict-aliasing"
ac_flags 1 fstackprotectorall "-fstack-protector-all"
#ac_flags 1 fwholepgm "-fwhole-program --combine"
ac_flags 1 fwrapv "-fwrapv"
# I'd use -std=c99 but this wrecks havoc on glibc and cygwin based
# systems (at least) because their system headers are so broken...
ac_flags 1 stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'
ac_flags 1 wall "-Wall"
d709 1
d727 7
d748 1
a748 1
if test 1 = $NEED_MKSH_SIGNAME; then
d781 3
@


1.186
log
@for R30, don't check for confstr() declaration any more
it was #if solaris'd in R28, and the system I have access
on does declare it now (still Solaris 8)

this can be put back if anyone complains, of course.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.185 2007/05/24 09:22:58 tg Exp $
d178 1
d183 3
d750 1
a750 1
test $h = 1 && v size $result
d761 1
@


1.185
log
@fix detection of function prototypes which, in contrast to data prototypes,
don't give an error if they're missing
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.184 2007/05/02 20:02:07 tg Exp $
a638 12
ac_test '!' confstr_decl '' 'if confstr() does not need to be declared' <<-'EOF'
	#define MKSH_INCLUDES_ONLY
	#include "sh.h"
	int confstr(long, void *, int);	/* this clashes if defined before */
	int main(int ac, char *av[]) {
	#if !defined(_PATH_DEFPATH) && defined(_CS_PATH)
		return (confstr(ac, *av, 0));
	#else
		return (ac + **av);
	#endif
	}
EOF
@


1.184
log
@we only require strcasestr if setlocale() is used at the moment
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.183 2007/04/30 19:50:09 tg Exp $
d53 1
a53 1
# pipe .c | ac_test[n] label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
d56 6
d101 1
d103 5
d627 1
a627 1
ac_test arc4random_decl arc4random 1 'if arc4random() does not need to be declared' <<-'EOF'
d630 1
d633 1
a633 1
ac_test arc4random_push_decl arc4random_push 1 'if arc4random_push() does not need to be declared' <<-'EOF'
d636 1
d639 1
a639 1
ac_test confstr_decl '' 'if confstr() does not need to be declared' <<-'EOF'
d642 1
@


1.183
log
@mksh R30 will no longer build a statically linked shell by default;
does not try, nor provide any means; user has to use LDFLAGS instead.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.182 2007/04/30 19:18:37 tg Exp $
d599 1
a599 1
ac_test strcasestr <<-'EOF'
@


1.182
log
@retain Build.sh path for test.sh (e.g. if /bin/ed != /usr/xpg4/bin/ed  on
Solaris some tools are weird, I recommend to prefix /usr/xpg4/bin to $PATH
even for dot.mkshrc because /usr/bin/id sucks, /usr/xpg4/bin/id works)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.181 2007/04/30 19:12:18 tg Exp $
a165 1
s=def
a169 6
	-d)
		s=dyn
		;;
	-nd)
		s=sta
		;;
a207 1
	test def = $s && s=pam
a209 1
	test def = $s && s=pam
a222 1
	test def = $s && s=dyn
a232 1
	test def = $s && s=pam
a248 1
	test def = $s && s=pam
a735 4
case $s:$HAVE_MKSH_NOPAM in
def:*|sta:*|pam:1)
	LDFLAGS="$LDFLAGS -static" ;;
esac
@


1.182.2.1
log
@MFC most of the bugfixes from post-R29d to the R29stable branch (which
is tagged off R29d), i.e. the following commitids:
 1004638EE466466C614
 100464368A065F40C08
 10046436B6D392D622C
 10046436DC35AC3B04F
 100464370BA2BF5141D
 10046474FB1292DF336
 100464753C139AD7515
 100464755C253EE3EA9
 100464759DE15635029
 10046475DAE4D3D3C05
 100464760593612AAF2
 100464763537E100BDF
 1004647649434DA3FE1
but not
 1004636486176FDA6FF
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.182 2007/04/30 19:18:37 tg Exp $
d611 1
a611 1
ac_test strcasestr setlocale_ctype 1 <<-'EOF'
@


1.182.2.2
log
@MFC commitid 100465559530388675D
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.185 2007/05/24 09:22:58 tg Exp $
d53 1
a53 1
# pipe .c | ac_test[n] [!] label [!] checkif[!]0 [setlabelifcheckis[!]0] useroutput
a55 6
	if test x"$1" = x"!"; then
		reverse=1
		shift
	else
		reverse=0
	fi
a94 1
	fr=0
a95 5
		test $reverse = 1 || fr=1
	else
		test $reverse = 0 || fr=1
	fi
	if test $fr = 1; then
d627 1
a627 1
ac_test '!' arc4random_decl arc4random 1 'if arc4random() does not need to be declared' <<-'EOF'
a629 1
	long arc4random(void);		/* this clashes if defined before */
d632 1
a632 1
ac_test '!' arc4random_push_decl arc4random_push 1 'if arc4random_push() does not need to be declared' <<-'EOF'
a634 1
	void arc4random_push(long);	/* this clashes if defined before */
d637 1
a637 1
ac_test '!' confstr_decl '' 'if confstr() does not need to be declared' <<-'EOF'
a639 1
	int confstr(long, void *, int);	/* this clashes if defined before */
@


1.182.2.3
log
@MFC:
 some harmless optimisations
 remove the -fno-tree-vrp and -fwhole-program --combine stuff
 fix a typo
 fix check for __attribute__
 remove the multi idstring check, always use ours
 fix signal stuff
 fix types
 pick up arc4random.c
 don't execute ELF, ECOFF, a.out, PE, gzip, etc. as shell script
 some regression test fixes
 fix large file support

bump version, this is gonna be R29g, but we've got to test that first
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.182.2.2 2007/05/24 10:53:58 tg Exp $
d30 3
a32 3
	bi='[1m'
	ui='[4m'
	ao='[0m'
d45 1
a46 1
me=`basename "$0"`
d100 1
d166 1
a166 1
	echo "$me: Error: ./mksh is a directory!" >&2
d197 1
a197 1
		echo "$me: Unknown option '$i'!" >&2
d293 1
a293 1
$e $bi$me: Scanning for functions... please ignore any errors.$ao
a314 1
	#undef __attribute__
a321 1
	#undef __attribute__
d344 38
d384 1
d459 6
a464 3
test 1 = $HAVE_CAN_LFS_SUS || CPPFLAGS=$save_CPPFLAGS
save_CPPFLAGS=$CPPFLAGS
CPPFLAGS="$CPPFLAGS -D_LARGE_FILES=1"
d562 1
a562 1
ac_testn arc4random <<-'EOF'
a570 9
if test $HAVE_ARC4RANDOM = 0 && test -f "$srcdir/arc4random.c"; then
	ac_header sys/sysctl.h
	addsrcs HAVE_ARC4RANDOM arc4random.c
	HAVE_ARC4RANDOM=1
	HAVE_ARC4RANDOM_DECL=0
	HAVE_ARC4RANDOM_PUSH=0
fi
CPPFLAGS="$CPPFLAGS -DHAVE_ARC4RANDOM=$HAVE_ARC4RANDOM"

d576 1
a576 1
ac_test flock_ex '' 'flock and mmap' <<-'EOF'
a578 1
	#include <sys/mman.h>
d580 1
a580 3
	#include <stdlib.h>
	int main(void) { return (mmap(NULL, flock(0, LOCK_EX), PROT_READ,
	    MAP_FILE | MAP_PRIVATE, 0, 0) == NULL ? 1 : 0); }
d681 9
d730 1
a730 1
	    sed 's/^mksh_cfg:[	 ]*\([0-9x ()+-]*\).*$/\1/'`
d732 1
a732 1
	*[\ \(\)+-]*) NSIG=`awk "BEGIN { print $NSIG }"` ;;
d740 1
a740 1
	    sort | while read name; do
d743 1
a743 1
		    sed 's/^mksh_cfg:[	 ]*\([0-9x]*\).*$/\1:'$name/
@


1.181
log
@do not -fwhole-program --combine since it at least breaks FORTIFY_SOURCE
on SuSE and causes http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=408850
so I'll assume it's a gcc bug

thanks to Pascal loki Bleser (yaloki), darix, Martin Zobel-Helas, Steve
Langasek (vorlon) for tracking this bug down in two different instances
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.180 2007/04/24 10:44:58 tg Exp $
d764 1
@


1.180
log
@some wording and #if 0 cleanup
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.179 2007/04/24 10:42:02 tg Exp $
d372 1
a372 1
ac_flags 1 fwholepgm "-fwhole-program --combine"
@


1.179
log
@ arc4random, arc4random_push: use our own protos to check
  XXX u_int32_t is not ISO C99, but seems to work well enough
  XXX if it fails anywhere, we'll see in the build logs
  XXX apple doesn't have the standard uint32_t and API doesn't specify it
 sys_siglist_defn: rename to sys_siglist_decl as we're really checking
  for the declaration in the headers; change wording to check if  does
  not need to be declared since we don't need to declare if we don't use
 scan for arc4random, arc4random_push, confstr declarations too
 sh.h: confstr declaration is no longer #ifdef __sun__; sort
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.178 2007/04/23 22:33:20 tg Exp $
d625 1
a625 1
# checks for function definitions in headers
a627 3
	#if 0
	#include <stdlib.h>
	#else
a629 1
	#endif
@


1.178
log
@ mention HP-UX, AIX success
 mention Darwin failure in R29c, fix in -current
 also clean up core dump file
 on HP-UX 11i v2, <stdint.h> requires <stdarg.h> because it pulls in
  a <wchar.h> generated from gcc's fixincludes dunno, but it works
 HP-UX 11i v2 on ia64 only works with -mlp64; the default seems to be
  -milp32 which generates SIGBUS due to misalignment (due to optimisation?)

-> in theory, HP-UX works on both PA-RISC and IA64 in R29c
-> R29c doesn't contain support for AIX or Mac OSX though
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.177 2007/04/23 21:36:02 tg Exp $
d551 5
a555 1
	#include <stdlib.h>
d560 1
a560 1
	#include <stdlib.h>
d627 26
a652 1
ac_test sys_siglist_defn sys_siglist 1 'if sys_siglist[] is defined' <<-'EOF'
@


1.177
log
@fix multi-rcsid test broken in 100462D18E37B6B8D16
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.176 2007/04/23 21:31:58 tg Exp $
d157 2
a204 1
		rm -f crypt.exp
d232 4
a280 1
rm -f a.exe a.out lft mksh mksh.cat1 mksh.exe no scn.c signames.inc test.sh x
d427 1
a427 1
ac_header stdint.h
@


1.176
log
@fix case matching
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.175 2007/04/23 21:15:44 tg Exp $
d639 1
a639 1
	#define MKSH_INCLUDES_ONLY
@


1.175
log
@clean up used files better
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.174 2007/04/23 20:57:50 tg Exp $
d688 1
a688 1
	*[ ()+-]*) NSIG=`awk "BEGIN { print $NSIG }"` ;;
@


1.174
log
@possibly fix the last issue on AIX: NSIG is (63 +1)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.173 2007/04/23 20:37:15 tg Exp $
d203 1
a230 1
	#XXX FIXME: required CPPFLAGS?
d276 1
a276 1
rm -f scn.c a.out a.exe x no lft
@


1.173
log
@AIX has sys_siglist[] but doesn't define it anywhere, so add a means to
scan for defns and use it here; bug reported by Kurt Telep
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.172 2007/04/23 20:17:58 tg Exp $
d686 4
a689 1
	    sed 's/^mksh_cfg: \([0-9x]*\).*$/\1/'`
@


1.172
log
@according to Kurt Telep, AIX _does_ require -lcrypt, and, when using
it, apps are expected to export certain symbols; thanks for the help
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.171 2007/04/23 14:06:47 tg Exp $
d617 9
d639 1
a639 1
	#define HAVE_MULTI_IDSTRING 1
@


1.171
log
@when we're starting to talk sensible default values, begin here:
if $LIBS is empty (i.e. not " " or so), use "-lcrypt" on Interix

AIX seems to require some too
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.170 2007/04/23 12:13:03 tg Exp $
d199 13
@


1.170
log
@$ uname -a; (gcc -v) 2>&1 | tail -1; echo $KSH_VERSION
HP-UX td192 B.11.11 U 9000/800 1839940656 unlimited-user license
gcc version 3.4.2
@@(#)MIRBSD KSH R29 2007/04/17

it apparently works, but there's no POSIX.pm, and the backspace
key acts as abort key (probably all things that can be fixed)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.169 2007/04/23 11:33:25 tg Exp $
d221 1
@


1.169
log
@ strlcpy.c: remove superfluous rcs ids in comments
 Build.sh: NetBSD gives an ignorable link-time warning in mirtoconf
 Build.sh: GNU (HURD) and GNU/kFreeBSD are no longer experimental, I think
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.168 2007/04/01 01:48:31 tg Exp $
d215 4
@


1.168
log
@support crazy ones that still haven't gotten rid of zsh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.167 2007/03/19 22:58:19 tg Exp $
a209 1
	warn=' but should work'
a212 1
	warn=' but should work'
d478 2
@


1.167
log
@mirtoconf for large file support vars, requested by bsiegert@@
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.166 2007/03/10 19:19:12 tg Exp $
d24 5
@


1.166
log
@ improve description why we use -fno-tree-vrp; this is thanks
  to http://blog.fefe.de/?ts=bb2654d4 by the way
 simplify a.out / a.exe distinguishation
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.165 2007/03/10 18:51:59 tg Exp $
a197 1
	CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64"
d206 1
a206 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
d210 1
a210 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
d216 1
a216 1
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
a233 1
	CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64"
d255 1
a255 1
rm -f scn.c a.out a.exe x no
d408 25
@


1.165
log
@check for -fno-tree-vrp (existence and if it is required to wrg around a gcc 4.1.1 bug)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.164 2007/03/10 17:29:53 tg Exp $
d40 2
a41 1
tcbo=0
d87 2
d90 1
a90 1
	if test -f a.out || test -f a.exe; then
d97 1
a97 1
	rm -f scn.c a.out a.exe
d257 1
a257 1
rm -f scn.c a.out a.exe x
d312 1
a312 1
	ac_testn need_fnotreevrp '' "if -fno-tree-vrp is needed" <<-'EOF'
d333 3
a335 5
	tcbo=0
	f=a.exe
	test -f $f || f=a.out
	if test -f $f; then
		./$f >/dev/null 2>&1
d340 1
a340 1
		rs="yes (assumed; cannot run ./$f)"
d345 1
a345 1
	rm -f scn.c a.out a.exe
@


1.164
log
@try to add -fstack-protector-all  it's in gcc 4.1+, so why not
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.163 2007/03/04 05:14:09 tg Exp $
d40 1
d86 1
d306 40
@


1.163
log
@Minix 3 has no S_ISSOCK (probably not even UNIX domain sockets)
and lacks other things (rlimit stuff), so it won't make it today
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.162 2007/03/04 05:03:57 tg Exp $
d305 1
@


1.162
log
@better tr, better descr
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.161 2007/03/04 04:53:06 tg Exp $
d218 3
a220 2
	warn=" but might work with the GNU tools"
	warn="$warn$nl but not with ACK - /usr/bin/cc - yet)"
@


1.161
log
@ _NSIG seems to be more standard than NSIG (non-POSIX)
 allow off-by-one (sigmax eq NSIG not NSIG-1)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.159 2007/03/04 04:45:36 tg Exp $
d38 2
d122 1
a122 3
	n='
'
	hv=`echo "$hf" | tr -d $n$(printf '\r') | tr -c $alll$allu$alln $alls`
d218 2
a219 2
	warn=' but might work with gcc
	(not with ACK yet)'
@


1.160
log
@some tr(1) are more weird than others
@
text
@d217 1
a217 1
	CPPFLAGS="$CPPFLAGS -DNSIG=_NSIG -D_MINIX -D_POSIX_SOURCE"
d583 2
a584 1
	NSIG=`( echo '#include <signal.h>'; echo mksh_cfg: NSIG ) | \
d599 1
a599 1
		test $nr -gt 0 && test $nr -lt $NSIG || continue
@


1.159
log
@cppflags for Minix 3
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.158 2007/03/04 04:36:45 tg Exp $
d120 3
a122 1
	hv=`echo "$hf" | tr -d '\r\n' | tr -c $alll$allu$alln $alls`
@


1.158
log
@ Minix 3 doesn't have <sys/mman.h>
 Some OSes might need <stdint.h> for int32_t (Minix 3 with GCC)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.157 2007/03/04 04:28:58 tg Exp $
d214 5
@


1.157
log
@Support old versions of ash
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.156 2007/03/04 03:48:50 tg Exp $
d347 1
d352 1
@


1.156
log
@fix a warning
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.155 2007/03/04 03:04:22 tg Exp $
d81 2
a82 2
	v "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN -I'$srcdir' scn.c $LIBS" \
	    2>&$h | sed 's/^/] /'
d546 1
a546 1
		( ( echo '#if (23 * 2 - 2) == (fnord + 2)'
d548 3
a550 2
		    echo '#endif'
		  ) | v "$CPP $CPPFLAGS -Dfnord=42 >x" ) 2>&$h | sed 's/^/] /'
@


1.155
log
@ remove strcasestr.c, use home-grown implementation, call it stricmp,
  and have it return an API-correct const char *
 enhance and stylify comments
 a little KNF and simplifications
 #ifdef DEBUG: replace strchr and strstr with ucstrchr and ucstrstr
  that take and return a non-const char *, and fix the violations
 new cstrchr, cstrstr (take and give const char *)
 new vstrchr, vstrstr (take const or not, give boolean value)
 new afreechk(x) = afreechv(x,x) = if (x1) afree(x2, ATEMP)
 new ksh_isdash(str) = (str != NULL) && !strcmp(str, "-")
 replace the only use of strrchr with inlined code to shrink
 minor man page fixes
 Minix 3 signames are autogenerated with gcc
 rename strlfun.c to strlcpy.c since we don't do strlcat(3) anyway,
  only strlcpy(3), and shorten it
 dot.mkshrc: move MKSH= down to the export line
  to not disturb the PS1 visual impression 
 dot.mkshrc: Lstripcom(): optimise
 bump version

) side effect from creating API-correct cstrchr, cstrstr, etc.
   uses goto so it must be better 

tested on mirbsd-current via both Makefile and Build.sh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.154 2007/03/03 21:36:06 tg Exp $
a518 7
ac_test multi_idstring '' 'if we can use __RCSID(x) multiple times' <<-'EOF'
	#include "sh.h"
	__RCSID("one");
	__RCSID("two");
	int main(void) { return (0); }
EOF

d528 9
@


1.154
log
@mirtoconf the checks if to use persistent history support
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.153 2007/02/27 00:31:17 tg Exp $
d4 1
a4 1
# Env: CC, CFLAGS, CPP, CPPFLAGS, LDFLAGS, LIBS, NOWARN, NROFF, TARGET_OS
d600 1
a600 2
addsrcs HAVE_STRCASESTR strcasestr.c
addsrcs HAVE_STRLCPY strlfun.c
@


1.153
log
@* From the Solaris tr(1) manual page:
        o  Each input character found in the array  specified  by
           string1 is replaced by the character in the same rela-
           tive position in the array specified by string2.  When
           the array specified by string2 is shorter that the one
           specified by string1, the results are unspecified.
  So give tr <everythingbutalphanum> _ the appropriate number of underscores.
* Also strip dashes from header names.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.152 2007/02/27 00:23:20 tg Exp $
a461 2
test 11 = $HAVE_FLOCK_EX$HAVE_MKSH_FULL || \
    check_categories=$check_categories,no-histfile
d526 9
@


1.152
log
@/usr/ucb/tr chokes to freeze state on tr -d -c
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.151 2007/02/18 16:24:13 tg Exp $
d37 1
d120 1
a120 1
	hv=`echo "$hf" | tr -d '\r\n' | tr -c $alll$allu$alln- _`
@


1.151
log
@ embed MKSH_ASSUME_UTF8 and MKSH_NEED_MKNOD in Build.sh
 have mksh with BSD makefiles always enable MKSH_ASSUME_UTF8
 sync BSD makefiles with Build.sh output
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.150 2007/02/13 12:26:46 tg Exp $
d18 6
@


1.150
log
@add CPPFLAGS for The HURD
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.149 2007/02/02 10:27:21 tg Exp $
d5 1
a5 1
# CPPFLAGS recognised: MKSH_SMALL MKSH_NOPWNAM
d307 14
d458 1
a458 1
ac_test setlocale_ctype '' 'setlocale(LC_CTYPE, "")' <<-'EOF'
d475 1
a475 1
ac_test setmode mksh_full 1 <<-'EOF'
@


1.149
log
@* _POSIX_C_SOURCE=2 is redundant and _BSD_SOURCE makes ancient BSD have
  precedence over POSIX/SUSv3 stuff and requires libbsd-compat which is
  something we don't desire; _GNU_SOURCE even in Linux libc5 always has
  included _POSIX_C_SOURCE=2 and BSD functions since at least Feb 1995.
* sync GNU/kFreeBSD with GNU/Linux, it uses glibc2

First mentioned and second response on inquiry by Bastian "waldi" Blank
Thanks!
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.148 2007/01/28 20:05:29 tg Exp $
d178 1
d191 4
d196 1
a196 3
	echo Warning: mksh has not yet been ported to $TARGET_OS >&2
	echo but should work. If you can provide a shell account >&2
	echo to the developer, the situation may improve. >&2
d220 1
a220 3
	echo Warning: mksh has not yet been tested on your operating >&2
	echo system "'$TARGET_OS';" it may or may not work. Please drop >&2
	echo us a notice if it works or not or send diffs to make it work. >&2
d224 7
@


1.148
log
@* GNU/kFreeBSD: seems to work, except for missing defns of
  strcasestr, setres[ug]id - probably needs same cflags as linux
* Linux: default HAVE_REVOKE to 0 since it's unimplemented anyway
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.147 2007/01/26 18:25:01 tg Exp $
a190 1
	# XXX probably the same as Linux?
d194 1
a194 1
	CPPFLAGS="$CPPFLAGS -D_BSD_SOURCE"
d200 1
a200 2
	CPPFLAGS="$CPPFLAGS -D_POSIX_C_SOURCE=2 -D_BSD_SOURCE -D_GNU_SOURCE"
	CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64"
@


1.147
log
@don't scan for revoke() if mksh_small since use_chvt isn't used then
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.146 2007/01/18 20:40:39 tg Exp $
d190 7
d204 1
@


1.146
log
@fix test for flock() on Debian 4.0
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.145 2007/01/18 16:06:22 tg Exp $
d442 1
a442 1
ac_test revoke <<-'EOF'
@


1.145
log
@oops, persistent history also depends on MKSH_FULL
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.144 2007/01/18 16:05:04 tg Exp $
d422 2
@


1.144
log
@autoscan for persistent history support
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.143 2007/01/18 15:50:31 tg Exp $
d425 2
a426 1
test 1 = $HAVE_FLOCK_EX || check_categories=$check_categories,no-histfile
@


1.143
log
@header overhaul: replace all #ifdef __OS__ with mirtoconf checks
(except the persistent history one)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.142 2007/01/18 03:31:50 tg Exp $
d421 6
@


1.142
log
@remove a line which shows the other possible values of $s
separate commit for educational & hysteric purposes
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.141 2007/01/18 03:31:24 tg Exp $
d28 4
d34 1
a34 2
	echo :"$@@" | sed 's/^://' | \
	    tr qwertyuiopasdfghjklzxcvbnm QWERTYUIOPASDFGHJKLZXCVBNM
d109 15
d223 1
d273 1
a273 2
i=`echo :"$CFLAGS" | sed 's/^://' | \
    tr -c -d qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789-`
d310 9
a318 19
ac_test sys_param_h '' '<sys/param.h>' <<-'EOF'
	#include <sys/param.h>
	int main(void) { return (0); }
EOF

ac_test sys_sysmacros_h '' '<sys/sysmacros.h>' <<-'EOF'
	#include <sys/sysmacros.h>
	int main(void) { return (0); }
EOF

ac_test libgen_h '' '<libgen.h>' <<-'EOF'
	#include <libgen.h>
	int main(void) { return (0); }
EOF

ac_test stdbool_h '' '<stdbool.h>' <<-'EOF'
	#include <stdbool.h>
	int main(void) { return (0); }
EOF
d454 1
d456 1
a488 1
	rm -f x
a511 1
rm -f x
@


1.141
log
@more ldstatic fuckup, late night reverse logic errors
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.140 2007/01/18 02:54:19 tg Exp $
a547 1
dyn:*|pam:0)	;;
@


1.140
log
@simplify this LDSTATIC shit and fix -nd in the process *sigh*

found on ecce!GNU/Linux 1.0, all tests pass, mksh-current
is exactly half the size of bash 2.01.1(1)r, both dynamic
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.139 2007/01/18 01:10:55 tg Exp $
d127 1
a127 1
LDSTATIC=default
d133 1
a133 1
		LDSTATIC=dynamic
d136 1
a136 1
		LDSTATIC=static
d162 1
a162 1
	test x"default" = x"$LDSTATIC" || LDSTATIC=pwnam
a164 1
	test x"default" = x"$LDSTATIC" || LDSTATIC=pwnam
d166 1
d178 1
a178 1
	test x"default" = x"$LDSTATIC" || LDSTATIC=pwnam
d189 1
a189 1
	test x"default" = x"$LDSTATIC" || LDSTATIC=pwnam
d545 4
a548 5
case $LDSTATIC:$HAVE_MKSH_NOPAM in
default:*|static:*|pwnam:1)
	LDSTATIC=-static ;;
dynamic:*|pwnam:0)
	LDSTATIC= ;;
d551 1
a551 1
    "$LDFLAGS $LDSTATIC -o '$curdir/mksh' $SRCS $LIBS") || exit 1
@


1.139
log
@autoscan for the correct ed(1) type

XXX amend check_categories with stuff like persist history, etc.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.138 2007/01/18 00:16:26 tg Exp $
d127 1
a127 1
LDSTATIC=-static
d133 1
a133 1
		LDSTATIC=@@@@
d136 1
a136 1
		LDSTATIC=@@@@@@
d162 1
a162 1
	test x"@@@@" = x"$LDSTATIC" || LDSTATIC=@@
d165 1
a165 1
	test x"@@@@" = x"$LDSTATIC" || LDSTATIC=@@
d178 1
a178 1
	test x"@@@@" = x"$LDSTATIC" || LDSTATIC=@@
d189 1
a189 1
	test x"@@@@" = x"$LDSTATIC" || LDSTATIC=@@
d545 5
a549 9
case $LDSTATIC in
@@)	if test 1 = $HAVE_MKSH_NOPAM; then
		LDSTATIC=-static
	else
		LDSTATIC=
	fi
	;;
@@@@)	LDSTATIC=	 ;;
@@@@@@)	LDSTATIC=-static ;;
@


1.138
log
@pasto, and add more comments
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.137 2007/01/18 00:10:16 tg Exp $
d501 7
@


1.137
log
@bring back sig_t as void pointer in the rare case we
don't have sighandler_t or __sighandler_t either
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.136 2007/01/17 23:54:39 tg Exp $
d323 1
d345 1
a345 1
if test 1 = $HAVE_SIGHANDLER_T; then
d378 1
@


1.136
log
@scan for sig_t (and friends)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.135 2007/01/17 23:50:26 tg Exp $
d349 2
@


1.135
log
@prevent confusion
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.134 2007/01/17 23:47:14 tg Exp $
d323 26
d385 1
a386 1
	CPPFLAGS="$CPPFLAGS -Dsys_siglist=_sys_siglist"
@


1.134
log
@* Build.sh, histrap.c: prevent testing of strsignal() if we have sys_siglist[]
* mksh.1: .Nm is never used with "" as argument, fixes GNU groff 1.15
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.133 2007/01/17 23:27:47 tg Exp $
d349 1
a349 1
ac_test sys_siglist '' 'the sys_siglist[] array' <<-'EOF'
d360 1
a360 1
	CPPFLAGS="$CPPFLAGS -DHAVE_SYS_SIGLIST -Dsys_siglist=_sys_siglist"
d362 1
@


1.133
log
@scan for revoke()
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.132 2007/01/17 23:18:55 tg Exp $
d354 1
a354 1
ac_test _sys_siglist '!' sys_siglist 0 'the _sys_siglist[] array' <<-'EOF'
d358 4
d363 1
a363 1
ac_test strsignal '!' _sys_siglist 0 <<-'EOF'
@


1.132
log
@if we don't have rlim_t, assume it's long
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.131 2007/01/17 23:04:19 tg Exp $
d390 5
@


1.131
log
@<sys/sysmacros.h> contains major/minor/makedev on Linux 2.0
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.130 2007/01/17 22:59:25 tg Exp $
d292 1
a292 1
ac_test sys_param_h '' '<sys/param.h>' <<'EOF'
d297 1
a297 1
ac_test sys_sysmacros_h '' '<sys/sysmacros.h>' <<'EOF'
d302 1
a302 1
ac_test libgen_h '' '<libgen.h>' <<'EOF'
d307 1
a307 1
ac_test stdbool_h '' '<stdbool.h>' <<'EOF'
d313 11
@


1.130
log
@new option -nd to force static linking of mksh but not mirtoconf tests
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.129 2007/01/17 22:55:47 tg Exp $
d297 5
@


1.129
log
@remove -x (cross-build) option, use -d instead, it does the same
side effect: TARGET_OS is now honoured without -x too
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.128 2007/01/17 22:51:45 tg Exp $
d135 3
d482 10
a491 6
test x"@@@@" = x"$LDSTATIC" && LDSTATIC=
test x"@@" = x"$LDSTATIC" && if test 1 = $HAVE_MKSH_NOPAM; then
	LDSTATIC=-static
else
	LDSTATIC=
fi
@


1.128
log
@* support old environments without libgen.h (ancient GNU/Linux)
  and stdbool.h (ancient GNU/Linux; NetBSD 1.6.1)
* __dead must come after, not before, to accomodate gcc 2.7.2.3
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.127 2007/01/17 22:35:09 tg Exp $
d4 1
a4 2
# Environment: CC, CFLAGS, CPP, CPPFLAGS, LDFLAGS, LIBS, NOWARN, NROFF
# With -x (cross compile): TARGET_OS (default: uname -s)
a126 1
x=0
a141 4
	-x)
		x=1
		LDSTATIC=@@@@
		;;
d156 1
a156 1
test $x = 0 && TARGET_OS=`uname -s 2>/dev/null || uname`
@


1.127
log
@we need "$CC -E -" as cpp, not "$CC -E"

found on
Linux ecce 2.0.38 #1 Wed Jul 26 22:05:46 2000 i686 unknown
Reading specs from /usr/lib/gcc-lib/i386-linux/2.7.2.3/specs
gcc version 2.7.2.3

Note: during the entire compile, there are warnings like
| gcc: unrecognized option `-std=gnu99'
but these won't trigger -Werror since they are in the driver,
not in the front-end, so they are harmless, I guess. (I don't
know of a way to make them vanish, either.)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.126 2007/01/17 21:42:23 tg Exp $
d300 10
@


1.126
log
@check if __RCSID() can be used multiple times; req'd eg. on Mac
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.125 2007/01/17 17:57:31 tg Exp $
d418 1
a418 1
	for i in "$save_CPP" "$CC -E" "cpp" "/usr/libexec/cpp" "/lib/cpp"; do
@


1.125
log
@only call nroff to see if it's gnroff if -r is not given
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.124 2007/01/17 17:46:18 tg Exp $
d402 10
@


1.124
log
@list all "known good" OSes in the $TARGET_OS switch,
echo a warning (but continue) for unknown OSes, with
the desire the porter should send in diffs
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.123 2007/01/17 17:42:22 tg Exp $
a123 1
echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && NROFF="$NROFF -c"
d158 3
@


1.123
log
@* add #ifdef MKSH_NOPWNAM to prevent pulling in getpwnam()
* document possible "functionality omission defines" in Build.sh
* sort and sectionise mirtoconf checks; add big comments
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.122 2007/01/17 17:31:59 tg Exp $
d169 4
d181 6
d193 5
@


1.122
log
@* order tests: we want to use correct NOWARN as much as possible
* "$e" and "echo" fixes for if the stuff begins with a -, and
  quoting cleanup (where feasible, feel free to send diffs)
* cosmetics

I hereby name this baby "Mirtoconf".
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.121 2007/01/17 17:14:25 tg Exp $
d6 1
d116 1
d159 1
d186 5
d193 3
d208 3
d237 3
d244 1
d246 3
d251 3
d261 7
d275 3
a277 6
# I'd use -std=c99 but this wrecks havoc on glibc and cygwin based
# systems (at least) because their system headers are so broken...
ac_flags 1 stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'

ac_flags 1 fwholepgm "-fwhole-program --combine"

d283 3
d325 3
d384 3
d406 3
d411 1
d449 1
a449 1
test x"@@" = x"$LDSTATIC" && if test 0 = $HAVE_MKSH_FULL; then
@


1.121
log
@if both "$CPP" (from parent) and "$CC -E" fail, try "cpp" (from $PATH) and
"/usr/libexec/cpp" and "/lib/cpp" last
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.120 2007/01/17 17:12:43 tg Exp $
d30 2
a31 1
	echo "$@@" | tr qwertyuiopasdfghjklzxcvbnm QWERTYUIOPASDFGHJKLZXCVBNM
d120 1
a120 1
: ${CPP=false} ${CC=gcc} ${NROFF=nroff}
a192 5
i=`echo "$CFLAGS" | tr -c -d qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789-`
test x"$i" = x"" && ac_flags 1 otwo "-O2"
ac_flags 1 fnostrictaliasing "-fno-strict-aliasing"
ac_flags 1 fwrapv "-fwrapv"
ac_flags 1 wall "-Wall"
d223 7
d351 1
a351 1
	$e "... checking how to run the C Preprocessor"
d374 1
a374 1
	NSIG=`( echo '#include <signal.h>'; echo "mksh_cfg: NSIG" ) | \
d384 1
a384 1
		( echo '#include <signal.h>'; echo "mksh_cfg: SIG$name" ) | \
d433 1
a433 1
$e "# grep -qx /bin/mksh /etc/shells || echo /bin/mksh >>/etc/shells"
@


1.120
log
@make a loop (removes dup code)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.119 2007/01/17 17:08:34 tg Exp $
d351 1
a351 1
	for i in "$save_CPP" "$CC -E"; do
@


1.119
log
@autoscan for c prprocessor now prefers $CPP to "$CC -E"
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.118 2007/01/17 17:03:59 tg Exp $
d350 4
a353 1
	if test x"$CPP" != x"false"; then
d360 2
a361 10
	fi
	if test x"$CPP" = x"false"; then
		CPP="$CC -E"
		( ( echo '#if (23 * 2 - 2) == (fnord + 2)'
		    echo mksh_rules: fnord
		    echo '#endif'
		  ) | v "$CPP $CPPFLAGS -Dfnord=42 >x" ) 2>&$h | sed 's/^/] /'
		grep '^mksh_rules:.*42' x >/dev/null 2>&1 || CPP=false
		rm -f x
	fi
@


1.118
log
@autoconf for -O2 (if CFLAGS is _empty_), -Wall, -fwrapv, -fno-strict-aliasing
XXX untested
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.117 2007/01/17 16:57:41 tg Exp $
d119 1
a119 2
# XXX autoconf for gcc:-cc and $CPP
: ${CC=gcc} ${NROFF=nroff}
d350 6
a355 7
	( ( echo '#if (23 * 2 - 2) == (fnord + 2)'
	    echo mksh_rules: fnord
	    echo '#endif'
	  ) | v "$CC -E - $CPPFLAGS -Dfnord=42 >x" ) 2>&$h | sed 's/^/] /'
	if grep '^mksh_rules:.*42' x >/dev/null 2>&1; then
		CPP="$CC -E -"
	else
d357 3
d364 2
a365 1
		grep '^mksh_rules:.*42' x >/dev/null 2>&1 || CPP=no
a366 1
	rm -f x
d368 1
a368 1
	test x"$CPP" = x"no" && exit 1
@


1.117
log
@simplify
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.116 2007/01/17 16:52:00 tg Exp $
a118 2
# XXX autoconf for these
: ${CFLAGS='-O2 -fno-strict-aliasing -fwrapv -Wall'}
d193 5
@


1.116
log
@more creative use of ac_flags()
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.115 2007/01/17 16:44:19 tg Exp $
d88 1
a88 1
# ac_flags varname flags [text]
d91 4
a94 3
	vn=$1
	f=$2
	ft=$3
d102 1
a102 1
	test 1 = $fv || CFLAGS=$save_CFLAGS
d188 1
a188 2
given_CFLAGS=$CFLAGS
given_NOWARN=$NOWARN
d190 1
a190 2
ac_flags compiler_works '' 'if the compiler works'
CFLAGS=$given_CFLAGS
d192 3
a194 5
ac_flags wnoerror "$given_NOWARN"
CFLAGS=$given_CFLAGS
test 1 = $HAVE_CAN_WNOERROR || given_NOWARN=
ac_flags werror "-Werror"
CFLAGS=$given_CFLAGS
d223 1
a223 1
NOWARN=$given_NOWARN
d233 1
a233 1
	ac_flags fnoinline "-fno-inline"
d241 1
a241 1
ac_flags stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'
d243 1
a243 1
ac_flags fwholepgm "-fwhole-program --combine"
@


1.115
log
@thinko
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.114 2007/01/17 16:39:55 tg Exp $
a185 5
ac_testn compiler_works '' 'if the compiler works' <<-'EOF'
	int main(void) { return (0); }
EOF
test 1 = $HAVE_COMPILER_WORKS || exit 1

d187 11
a197 4
ac_testn can_wnoerror '' "if '$NOWARN' can be used" <<-'EOF'
	int main(void) { return (0); }
EOF
test 1 = $HAVE_CAN_WNOERROR || NOWARN=
d199 2
a200 6
save_NOWARN=$NOWARN
NOWARN=-Werror
ac_testn can_werror '' "if -Werror can be used" <<-'EOF'
	int main(void) { return (0); }
EOF
test 1 = $HAVE_CAN_WERROR || NOWARN=
d225 2
a226 1
NOWARN=$save_NOWARN
@


1.114
log
@new shell function for autoconfing compiler flags, reduces redundancy
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.113 2007/01/17 01:59:38 tg Exp $
d100 1
a100 1
	eval fv=\$HAVE_`upper $vn`
@


1.113
log
@add two TODOs
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.112 2007/01/17 01:24:28 tg Exp $
d88 16
d237 1
a237 6
	save_CFLAGS=$CFLAGS
	CFLAGS="$CFLAGS -fno-inline"
	ac_testn can_fnoinline '' 'if -fno-inline can be used' <<-'EOF'
		int main(void) { return (0); }
	EOF
	test 1 = $HAVE_CAN_FNOINLINE || CFLAGS=$save_CFLAGS
d245 1
a245 6
save_CFLAGS=$CFLAGS
CFLAGS="$CFLAGS -std=gnu99"
ac_testn can_stdg99 '' 'if -std=gnu99 (ISO C99) can be used' <<-'EOF'
	int main(void) { return (0); }
EOF
test 1 = $HAVE_CAN_STDG99 || CFLAGS=$save_CFLAGS
d247 1
a247 6
save_CFLAGS=$CFLAGS
CFLAGS="$CFLAGS -fwhole-program --combine"
ac_testn can_fwholepgm '' 'if -fwhole-program --combine can be used' <<-'EOF'
	int main(void) { return (0); }
EOF
test 1 = $HAVE_CAN_FWHOLEPGM || CFLAGS=$save_CFLAGS
@


1.112
log
@* Build.sh: add -fwrapv to standard CFLAGS, just to be on the safe
  side (I don't have capacities to scan 71711 files in MirOS for a
  standards-compliance whack)
* copyright: mention CVS changelogs as place of contributors' name
  and credit information, too
* check.t, sh.h: bump
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.111 2007/01/14 21:38:25 tg Exp $
d102 1
d104 1
@


1.111
log
@autoconf for -std=gnu99 (not c99 because of brokenness in the field)
from ankon -> solaris 10 with gcc 3.4.6 from sunfreeware
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.110 2007/01/12 03:30:40 tg Exp $
d102 1
a102 1
: ${CFLAGS='-O2 -fno-strict-aliasing -Wall'}
@


1.111.2.1
log
@merge -rHEAD as of now into the const-correctness branch
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.154 2007/03/03 21:36:06 tg Exp $
d4 2
a5 2
# Env: CC, CFLAGS, CPP, CPPFLAGS, LDFLAGS, LIBS, NOWARN, NROFF, TARGET_OS
# CPPFLAGS recognised: MKSH_SMALL MKSH_ASSUME_UTF8 MKSH_NEED_MKNOD MKSH_NOPWNAM
a17 6
if test -d /usr/xpg4/bin/. >/dev/null 2>&1; then
	# Solaris: some of the tools have weird behaviour, use portable ones
	PATH=/usr/xpg4/bin:$PATH
	export PATH
fi

a27 5
allu=QWERTYUIOPASDFGHJKLZXCVBNM
alll=qwertyuiopasdfghjklzxcvbnm
alln=0123456789
alls=______________________________________________________________

d30 1
a30 1
	echo :"$@@" | sed 's/^://' | tr $alll $allu
a87 32
# ac_flags add varname flags [text]
ac_flags()
{
	fa=$1
	vn=$2
	f=$3
	ft=$4
	test x"$ft" = x"" && ft="if $f can be used"
	save_CFLAGS=$CFLAGS
	CFLAGS="$CFLAGS $f"
	ac_testn can_$vn '' "$ft" <<-'EOF'
		int main(void) { return (0); }
	EOF
	eval fv=\$HAVE_CAN_`upper $vn`
	test 11 = $fa$fv || CFLAGS=$save_CFLAGS
}

# ac_header header [prereq ...]
ac_header()
{
	hf=$1; shift
	hv=`echo "$hf" | tr -d '\r\n' | tr -c $alll$allu$alln $alls`
	for i
	do
		echo "#include <$i>" >>x
	done
	echo "#include <$hf>" >>x
	echo 'int main(void) { return (0); }' >>x
	ac_test "$hv" "" "<$hf>" <x
	rm -f x
}

a96 1

d102 2
a103 1
: ${CC=gcc} ${CPP=false} ${NROFF=nroff}
d105 1
d110 2
a111 1
s=def
d117 1
a117 4
		s=dyn
		;;
	-nd)
		s=sta
d126 4
d140 1
a140 6
test $r = 0 && echo | $NROFF -v 2>&1 | grep GNU >/dev/null 2>&1 && \
    NROFF="$NROFF -c"


test x"$TARGET_OS" = x"" && TARGET_OS=`uname -s 2>/dev/null || uname`
warn=
d143 1
a143 1
	test def = $s && s=pam
d146 1
a147 13
	test def = $s && s=pam
	;;
DragonFly)
	;;
FreeBSD)
	;;
GNU)
	warn=' but should work'
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
	;;
GNU/kFreeBSD)
	warn=' but should work'
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
d153 3
a155 9
	CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64"
	test def = $s && s=pam
	: ${HAVE_REVOKE=0}
	;;
MirBSD)
	;;
NetBSD)
	;;
OpenBSD)
d160 1
a160 1
	test def = $s && s=pam
a162 3
*)
	warn='; it may or may not work'
	;;
a164 7
if test -n "$warn"; then
	echo "Warning: mksh has not yet been ported to or tested on your" >&2
	echo "operating system '$TARGET_OS'$warn. If you can provide" >&2
	echo "a shell account to the developer, this may improve; please" >&2
	echo "drop us a success or failure notice or even send in diffs." >&2
fi

d166 1
d168 4
d173 5
a177 5
#
# Begin of mirtoconf checks
#
rm -f scn.c a.out a.exe x
$e ${ao}Scanning for functions... please ignore any errors.
a178 4
#
# Compiler: works as-is, with -Wno-error and -Werror
#
test x"$NOWARN" = x"" && NOWARN=-Wno-error
d180 6
a185 13
NOWARN=
ac_flags 0 compiler_works '' 'if the compiler works'
test 1 = $HAVE_CAN_COMPILER_WORKS || exit 1
ac_flags 0 wnoerror "$save_NOWARN"
test 1 = $HAVE_CAN_WNOERROR || save_NOWARN=
ac_flags 0 werror "-Werror"

# The following tests are run with -Werror if possible
test 1 = $HAVE_CAN_WERROR && NOWARN=-Werror

#
# Compiler: check for stuff that only generates warnings
#
a208 1
# End of tests run with -Werror
a210 16
#
# Compiler: extra flags (-O2 -f* -W* etc.)
#
i=`echo :"$CFLAGS" | sed 's/^://' | tr -c -d $alll$allu$alln-`
test x"$i" = x"" && ac_flags 1 otwo "-O2"
ac_flags 1 fnostrictaliasing "-fno-strict-aliasing"
ac_flags 1 fwholepgm "-fwhole-program --combine"
ac_flags 1 fwrapv "-fwrapv"
# I'd use -std=c99 but this wrecks havoc on glibc and cygwin based
# systems (at least) because their system headers are so broken...
ac_flags 1 stdg99 "-std=gnu99" 'if -std=gnu99 (ISO C99) can be used'
ac_flags 1 wall "-Wall"

#
# mksh: flavours (full/small mksh, omit certain stuff)
#
a217 21
ac_testn mksh_defutf8 '' "if we assume UTF-8 is enabled" <<-'EOF'
	#ifndef MKSH_ASSUME_UTF8
	#error Nope, we shall check with setlocale() and nl_langinfo(CODESET)
	#endif
	int main(void) { return (0); }
EOF

ac_testn mksh_need_mknod '!' mksh_full 1 'if we still want c_mknod()' <<-'EOF'
	#ifndef MKSH_NEED_MKNOD
	#error Nope, the user really wants it teensy.
	#endif
	int main(void) { return (0); }
EOF

ac_testn mksh_nopam mksh_full 1 'if the user wants to omit getpwnam()' <<-'EOF'
	#ifndef MKSH_NOPWNAM
	#error No, the user wants to pull in getpwnam.
	#endif
	int main(void) { return (0); }
EOF

d219 6
a224 1
	ac_flags 1 fnoinline "-fno-inline"
d230 6
a235 22
#
# Environment: headers
#
ac_header sys/param.h
ac_header sys/mkdev.h
ac_header sys/sysmacros.h
ac_header libgen.h
ac_header paths.h
ac_header stdbool.h
ac_header grp.h sys/types.h
ac_header ulimit.h
ac_header values.h

#
# Environment: types
#
ac_test rlim_t <<-'EOF'
	#include <sys/types.h>
	#include <sys/time.h>
	#include <sys/resource.h>
	#include <unistd.h>
	int main(void) { return ((int)(rlim_t)0); }
d237 1
d239 4
a242 5
# only testn: added later below
ac_testn sig_t <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	int main(void) { return ((int)(sig_t)0); }
d244 1
d246 3
a248 14
ac_testn sighandler_t '!' sig_t 0 <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	int main(void) { return ((int)(sighandler_t)0); }
EOF
if test 1 = $HAVE_SIGHANDLER_T; then
	CPPFLAGS="$CPPFLAGS -Dsig_t=sighandler_t"
	HAVE_SIG_T=1
fi

ac_testn __sighandler_t '!' sig_t 0 <<-'EOF'
	#include <sys/types.h>
	#include <signal.h>
	int main(void) { return ((int)(__sighandler_t)0); }
a249 6
if test 1 = $HAVE___SIGHANDLER_T; then
	CPPFLAGS="$CPPFLAGS -Dsig_t=__sighandler_t"
	HAVE_SIG_T=1
fi

CPPFLAGS="$CPPFLAGS -DHAVE_SIG_T=$HAVE_SIG_T"
a250 3
#
# Environment: signals
#
d274 1
a274 2
# only testn: added later below
ac_testn sys_siglist '' 'the sys_siglist[] array' <<-'EOF'
d279 1
a279 1
ac_testn _sys_siglist '!' sys_siglist 0 'the _sys_siglist[] array' <<-'EOF'
a282 5
if test 1 = $HAVE__SYS_SIGLIST; then
	CPPFLAGS="$CPPFLAGS -Dsys_siglist=_sys_siglist"
	HAVE_SYS_SIGLIST=1
fi
CPPFLAGS="$CPPFLAGS -DHAVE_SYS_SIGLIST=$HAVE_SYS_SIGLIST"
d284 1
a284 1
ac_test strsignal '!' sys_siglist 0 <<-'EOF'
a289 3
#
# Environment: library functions
#
d300 1
a300 8
ac_test flock_ex '' 'flock and LOCK_EX' <<-'EOF'
	#include <sys/types.h>
	#include <sys/file.h>
	#include <fcntl.h>
	int main(void) { return (flock(0, LOCK_EX)); }
EOF

ac_test setlocale_ctype '!' mksh_defutf8 0 'setlocale(LC_CTYPE, "")' <<-'EOF'
d312 1
a312 6
ac_test revoke mksh_full 0 <<-'EOF'
	#include <unistd.h>
	int main(int ac, char *av[]) { return (ac + revoke(av[0])); }
EOF

ac_test setmode mksh_need_mknod 1 <<-'EOF'
a327 1
	#if HAVE_GRP_H
a328 1
	#endif
a345 22
#
# other checks
#
ac_test multi_idstring '' 'if we can use __RCSID(x) multiple times' <<-'EOF'
	#include "sh.h"
	__RCSID("one");
	__RCSID("two");
	int main(void) { return (0); }
EOF

ac_test persistent_history mksh_full 0 'if to use persistent history' <<-'EOF'
	#if !HAVE_FLOCK_EX || defined(MKSH_SMALL)
	#error No, some prerequisites are missing.
	#endif
	int main(void) { return (0); }
EOF
test 1 = $HAVE_PERSISTENT_HISTORY || \
    check_categories=$check_categories,no-histfile

#
# Compiler: Praeprocessor (only if needed)
#
d347 10
a356 5
	$e ... checking how to run the C Preprocessor
	save_CPP=$CPP
	for i in "$save_CPP" "$CC -E -" "cpp" "/usr/libexec/cpp" "/lib/cpp"; do
		CPP=$i
		test x"$CPP" = x"false" && continue
d361 3
a363 4
		grep '^mksh_rules:.*42' x >/dev/null 2>&1 || CPP=false
		rm -f x
		test x"$CPP" = x"false" || break
	done
d365 1
a365 1
	test x"$CPP" = x"false" && exit 1
a367 3
#
# End of mirtoconf checks
#
a369 7
# Some operating systems have ancient versions of ed(1) writing
# the character count to standard output; cope for that
echo wq >x
ed x <x 2>/dev/null | grep 3 >/dev/null 2>&1 && \
    check_categories=$check_categories,oldish-ed
rm -f x

d373 1
a373 1
	NSIG=`( echo '#include <signal.h>'; echo mksh_cfg: NSIG ) | \
d383 1
a383 1
		( echo '#include <signal.h>'; echo mksh_cfg: SIG$name ) | \
d406 6
a411 4
case $s:$HAVE_MKSH_NOPAM in
def:*|sta:*|pam:1)
	LDFLAGS="$LDFLAGS -static" ;;
esac
d413 1
a413 1
    "$LDFLAGS -o '$curdir/mksh' $SRCS $LIBS") || exit 1
d432 1
a432 1
$e "# grep -x /bin/mksh /etc/shells >/dev/null || echo /bin/mksh >>/etc/shells"
@


1.110
log
@CPP is honoured now as well (but only needed for the siglist)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.109 2007/01/12 03:20:07 tg Exp $
d230 9
@


1.109
log
@oops really unbreak -d
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.108 2007/01/12 03:17:08 tg Exp $
d4 1
a4 1
# Environment: CC, CFLAGS, CPPFLAGS, LDFLAGS, LIBS, NOWARN, NROFF
@


1.108
log
@unbreak -d
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.107 2007/01/12 02:46:27 tg Exp $
d143 1
a143 1
	LDSTATIC=@@
d146 1
a146 1
	LDSTATIC=@@
d155 1
a155 1
	LDSTATIC=@@
d160 1
a160 1
	LDSTATIC=@@
@


1.107
log
@user should be able to override if he wants setlocale calls in his
extra small mksh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.106 2007/01/12 02:40:18 tg Exp $
d117 1
a117 1
		LDSTATIC=
d128 1
a128 1
		LDSTATIC=
d397 1
@


1.106
log
@] scn.c:1: warning: ISO C forbids an empty source file
yeaaah, we #error out anyway, but
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.105 2007/01/12 02:37:32 tg Exp $
d226 1
a226 1
	HAVE_SETLOCALE_CTYPE=0
@


1.105
log
@gcc 4.1.2 pedantic warning free configure
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.104 2007/01/12 02:34:46 tg Exp $
d214 1
a214 1
	#else
a215 1
	#endif
d306 1
a306 1
	#else
a308 1
	#endif
@


1.104
log
@* instead of setting LDSTATIC='' for OSes which did not support it
  until now, set it to '@@'
* if LDSTATIC is '@@' make it '-static' if MKSH_SMALL, '' otherwise

Yep, this might break, e.g. Darwin or Cygwin. But let's test that.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.103 2007/01/12 02:27:40 tg Exp $
d198 1
a198 1
	int main(int ac, char *av[]) { return (xcopy(av[0], av[1], 1)); }
@


1.103
log
@disallow the user to specify (overload) SRCS, if there is special
target platform specific crap, it belongs into LIBS instead
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.102 2007/01/12 02:12:16 tg Exp $
d143 1
a143 1
	LDSTATIC=
d146 1
a146 1
	LDSTATIC=
d155 1
a155 1
	LDSTATIC=
d160 1
a160 1
	LDSTATIC=
d399 5
@


1.102
log
@interesting way to break things oeps 
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.101 2007/01/12 02:09:10 tg Exp $
d5 1
a5 1
# With -x: SRCS (extra), TARGET_OS (uname -s)
d137 1
a137 5
if test $x = 0; then
	SRCS=
	TARGET_OS=`uname -s 2>/dev/null || uname`
fi
SRCS="$SRCS alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
d140 1
@


1.101
log
@more verbose
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.100 2007/01/12 02:01:48 tg Exp $
d389 1
a389 1
			test $h = 1 && printf "$nr "
d392 1
a392 1
	done >signames.inc
@


1.100
log
@fix configuration on solaris 8 with whitespaces in both curdir and
srcdir, mostly due to 'eval' issues and a picky /bin/sh (yeaaah)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.99 2007/01/12 01:49:26 tg Exp $
d373 1
d389 1
@


1.99
log
@* Scan for __attribute__((...)) in general (the earliest was 2.5,
  where we had 'noreturn' etc. but no '__noreturn__')
* Scan for __attribute__((bounded)) and __attribute__((used))
  if we have __attribute__((noreturn))
* To be able to scan if certain attributes give warnings,
  scan for -Werror with a simple programme which hopefully triggers none
* Convert __attribute__((unused)) to __unused, noreturn -> __dead
* Unify other attributes
* Clean up typography a little more
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.94 2007/01/12 00:25:38 tg Exp $
d13 5
d105 1
a105 1
echo | $NROFF -v 2>&1 | grep GNU >&- 2>&- && NROFF="$NROFF -c"
d344 1
a344 1
	rm -f a.out
d348 2
a349 2
	  ) | $CC -E - $CPPFLAGS -Dfnord=42 >a.out ) 2>&$h | sed 's/^/] /'
	if grep '^mksh_rules:.*42' a.out >&- 2>&-; then
d352 1
a352 1
		rm -f a.out
d356 2
a357 2
		  ) | $CPP $CPPFLAGS -Dfnord=42 >a.out ) 2>&$h | sed 's/^/] /'
		grep '^mksh_rules:.*42' a.out >&- 2>&- || CPP=no
d359 1
a359 1
	rm -f a.out
d370 1
a370 1
	    $CPP $CPPFLAGS | grep mksh_cfg: | \
d372 1
a372 1
	NSIG=`printf %d "$NSIG" 2>&-`
d374 1
a374 1
	echo '#include <signal.h>' | $CPP $CPPFLAGS -dD | \
d379 1
a379 1
		    $CPP $CPPFLAGS | grep mksh_cfg: | \
d382 1
a382 1
		nr=`printf %d "$nr" 2>&-`
d391 1
a391 1
	grep ', ' signames.inc || exit 1
@


1.98
log
@solaris /bin/sh:
| v() { ... }
| v=1
undefines v()
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.97 2007/01/12 01:32:27 tg Exp $
a6 6
# XXX TODO: check for __attribute__ (Minix 3 ACK probably doesn't)
# and other gccisms in the code, handle appropriately. Note that I
# sometimes _want_ gccisms, because of the improved error checks.

# XXX TODO: check for $CPP -dD and if that works

d177 32
@


1.97
log
@underline actual autoconf results (test names are in bold)

FWIW, works ATM, even with spaces in directory name
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.96 2007/01/12 01:27:28 tg Exp $
d72 1
a72 1
	    2>&$v | sed 's/^/] /'
d109 1
a109 1
v=1
d122 1
a122 1
		v=-
d317 1
a317 1
	  ) | $CC -E - $CPPFLAGS -Dfnord=42 >a.out ) 2>&$v | sed 's/^/] /'
d325 1
a325 1
		  ) | $CPP $CPPFLAGS -Dfnord=42 >a.out ) 2>&$v | sed 's/^/] /'
d376 1
a376 1
test $v = 1 && v size $result
@


1.96
log
@* typo
* include path
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.95 2007/01/12 01:17:10 tg Exp $
d21 2
a22 1
	bo=`printf '\033[0m'`
d25 2
a26 1
	bo=
d54 1
a54 1
		$e "$bi==> $fd...$bo no (cached)"
d58 1
a58 1
		$e "$bi==> $fd...$bo yes (cached)"
d66 1
a66 1
		$e "$bi==> $fd...$bo $fv (implied)"
d75 1
a75 1
		$e "$bi==> $fd...$bo yes"
d78 1
a78 1
		$e "$bi==> $fd...$bo no"
d170 1
a170 1
$e ${bo}Scanning for functions... please ignore any errors.
d329 1
a329 1
	$e "$bi==> checking how to run the C Preprocessor...$bo $CPP"
@


1.95
log
@implement colouring of "autoconf" output. yay!
NB: only if stdout isatty
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.94 2007/01/12 00:25:38 tg Exp $
d69 2
a70 2
	v "$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS" 2>&$v | \
	    sed 's/^/] /'
d167 1
d217 1
a217 1
	int main(void) { return (mksh_sigpair[0].nr); }
d365 1
d367 1
a367 2
(v "cd '$srcdir' && exec $CC $CFLAGS -I'$curdir' $CPPFLAGS" \
    "-DHAVE_CONFIG_H -DCONFIG_H_FILENAME=\\\"sh.h\\\"" \
@


1.94
log
@Clean up the signal mess, saves 172 Bytes:
* 'sigseen' in Build.sh goes away
* Signal name existence is checked in this order:
  have our own -> sys_signame[] -> _sys_signame[] -> build our own
* Signal description existence is checked in this order:
  sys_siglist[] -> _sys_siglist[] -> strsignal() -> NULL
 Predefined list of items, for operating systems where we
  cannot build them, i.e. Plan 9 and Minix 3 (e.g. no $CPP -dD)
 The usual cpp(1) stuff
 Changed later, see below
* Make $CPP test dependent on $NEED_MKSH_SIGNAME (others can
  be added here, this is not absolute)
* Make signal name list generation dependent on $NEED_MKSH_SIGNAME
* Fix check if the generation worked
* Guarantee that sigtraps[*].name and sigtraps[*].mess are valid
  C strings; this makes the code shorter *and* removes a few pos-
  sible nil pointer dereferences
* Embed autoconf'd usages of sys_sig* / strsignal / mksh_sigpairs
  into inittraps()
* Check for each signal 0<=i<=NSIG that
  name is not NULL or "" -> replace with ("%d", i)
  mess is not NULL or "" -> replace with ("Signal %d", i)
  name does not start (case-insensitive) with "SIG" -> name += 3
* In gettrap(), fix check if signal name starts, case-sensitive
  or case-insensitive, depending on need, with "SIG" (bug from millert@@)

Other changes:
* Build.sh: ac_test[n]() are documented
* Build.sh: ac_test[n]() can have negative prereqs as well now
* Build.sh: use <<-'EOF' consistently
* bump patchlevel to today
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.93 2007/01/11 03:03:34 tg Exp $
d19 8
d52 1
a52 1
		$e "==> $fd... no (cached)"
d56 1
a56 1
		$e "==> $fd... yes (cached)"
d64 1
a64 1
		$e "==> $fd... $fv (implied)"
d73 1
a73 1
		$e "==> $fd... yes"
d76 1
a76 1
		$e "==> $fd... no"
d167 1
a167 1
$e Scanning for functions... please ignore any errors.
d326 1
a326 1
	$e "==> checking how to run the C Preprocessor... $CPP"
@


1.93
log
@* pasto (patcho?)
* improve output readability

I wonder if I should use ANSI escapes to make the results
from the configuration bold but then, this'd look worse
in e.g. mc or less. Suggestions?
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.92 2007/01/11 02:41:53 tg Exp $
d5 1
a5 1
# With -x: SRCS (extra), sigseen (XXX go away), TARGET_OS (uname -s)
d24 1
d29 1
d33 4
d51 1
a51 1
	if test 0 = "$ft"; then
a129 1
	sigseen=
a137 1
	sigseen=:
a149 1
	sigseen=:
a154 1
	sigseen=:
d204 39
d253 1
a253 1
ac_test setlocale_ctype '' 'setlocale(LC_CTYPE, "")' <<'EOF'
d259 1
a259 1
ac_test langinfo_codeset setlocale_ctype 0 'nl_langinfo(CODESET)' <<'EOF'
d300 1
a300 6
if test x"$sigseen" = x:; then	# XXX for now
	HAVE_SYS_SIGNAME=0	# XXX
else				# XXX
	HAVE_SYS_SIGNAME=1	# XXX
fi				# XXX
if test 0 = $HAVE_SYS_SIGNAME; then
d324 1
a324 1
if test x"$sigseen" = x:; then
d326 1
d349 1
a349 1
	test -f signames.inc || exit 1
@


1.92
log
@make use of the new $CPP variable (and enable the cpp check if needed)

@@Benny:	this is why I don't use GNU autoconf: writing configure.in
	files is, supposedly, easy - but nobody teaches you which
	changes you have to apply to your source files. Here I know.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.91 2007/01/11 02:37:40 tg Exp $
d270 1
a270 1
	  ) | $CC -E - $CPPFLAGS >a.out ) 2>&$v | sed 's/^/] /'
d278 1
a278 1
		  ) | $CPP $CPPFLAGS >a.out ) 2>&$v | sed 's/^/] /'
d289 1
a289 1
	$e Generating list of signal names
d313 1
@


1.91
log
@add test how to run the C preprocessor and fix the $NOWARN check and docs
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.90 2007/01/11 02:11:46 tg Exp $
d11 2
a156 27
if test x"$sigseen" = x:; then
	$e Generating list of signal names
	NSIG=`( echo '#include <signal.h>'; echo "mksh_cfg: NSIG" ) | \
	    $CC $CPPFLAGS -E - | grep mksh_cfg | \
	    sed 's/^mksh_cfg: \([0-9x]*\).*$/\1/'`
	NSIG=`printf %d "$NSIG" 2>&-`
	test $NSIG -gt 1 || exit 1
	echo '#include <signal.h>' | $CC $CPPFLAGS -E -dD - | \
	    grep '[	 ]SIG[A-Z0-9]*[	 ]' | \
	    sed 's/^\(.*[	 ]SIG\)\([A-Z0-9]*\)\([	 ].*\)$/\2/' | \
	    while read name; do
		( echo '#include <signal.h>'; echo "mksh_cfg: SIG$name" ) | \
		    $CC $CPPFLAGS -E - | grep mksh_cfg: | \
		    sed 's/^mksh_cfg: \([0-9x]*\).*$/\1:'$name/
	done | grep -v '^:' | while IFS=: read nr name; do
		nr=`printf %d "$nr" 2>&-`
		test $nr -gt 0 && test $nr -lt $NSIG || continue
		case $sigseen in
		*:$nr:*) ;;
		*)	echo "		{ $nr, \"$name\" },"
			sigseen=$sigseen$nr:
			;;
		esac
	done >signames.inc
	test -f signames.inc || exit 1
fi

d259 5
d287 28
@


1.90
log
@small mkshs also shouldn't pull in the entire locale package,
so don't even call setlocale, lest alone nl_langinfo (already
disabled before)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.89 2007/01/11 02:08:49 tg Exp $
d4 2
a5 2
# Environment: CC, CFLAGS, CPPFLAGS, LDFLAGS, LIBS, NROFF
# With -x: SRCS (extra), sigseen (XXX go away), TARGET_OS
d188 6
a193 7
if test x"$NOWARN" = x""; then
	NOWARN=-Wno-error
	ac_testn can_wnoerror '' 'if -Wno-error can be used' <<-'EOF'
		int main(void) { return (0); }
	EOF
	test 1 = $HAVE_CAN_WNOERROR || NOWARN=
fi
d284 22
@


1.89
log
@if building a small mksh, don't check for persistent history,
since it's not supported anyway; makes regression tests pass there
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.88 2007/01/11 00:57:56 tg Exp $
d212 1
a212 1
	HAVE_LANGINFO_CODESET=0
@


1.88
log
@introduce TARGET_OS, for crossbuilds, contains uname -s output
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.87 2007/01/11 00:47:40 tg Exp $
d87 1
a87 1
curdir=`pwd` srcdir=`dirname "$0"`
d213 1
d304 1
a304 1
    "-p '$curdir/mksh' -C pdksh \$*" >>test.sh
@


1.87
log
@this double-backtick in double-backtick (SunOS /bin/sh) stuff
looked waay too weird to me, use a temporary variable instead
and make the two occurencies of the code look more alike
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.86 2007/01/11 00:44:08 tg Exp $
d5 1
d123 1
d128 1
a128 1
test $x = 1 || case `uname -s 2>/dev/null || uname` in
@


1.86
log
@use the same matching for NSIG as for the others - cut off
everything which doesn't look like a dec/hex/oct number
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.85 2007/01/11 00:38:37 tg Exp $
d155 1
a155 1
	NSIG=`printf %d "\`(echo '#include <signal.h>';echo mksh_cfg: NSIG) | \
d157 2
a158 1
	    sed 's/^mksh_cfg: \([0-9x]*\).*$/\1/'\`" 2>&-`
@


1.85
log
@oops, match hex numbers; seen while looking at ankon's (FreeBSD) problem
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.84 2006/12/11 19:58:37 tg Exp $
d156 2
a157 1
	    $CC $CPPFLAGS -E - | grep mksh_cfg | sed 's/^mksh_cfg: //'\`" 2>&-`
@


1.84
log
@add a TODO here
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.83 2006/11/21 21:45:24 tg Exp $
d164 1
a164 1
		    sed 's/^mksh_cfg: \([0-9]*\).*$/\1:'$name/
@


1.83
log
@fix bitching of: gcc version 3.3.5 (Debian 1:3.3.5-13)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.82 2006/11/12 13:49:22 tg Exp $
d6 4
@


1.82
log
@__CRAZY=Yes clean autoconf functions
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.81 2006/11/12 13:38:40 tg Exp $
d190 1
a190 1
	#error OK, we're building an extra small mksh.
@


1.81
log
@oops, wrong protos
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.80 2006/11/12 13:35:29 tg Exp $
d231 2
a232 1
	int main(void) { return ((int)setlocale(LC_CTYPE, "")); }
d237 2
a238 1
	int main(void) { return ((int)nl_langinfo(CODESET)); }
d264 1
d266 3
a268 1
	int main(int ac, char *av[]) { return ((int)strcasestr(*av, av[ac])); }
@


1.80
log
@* fix CR-LF accident
* fix gcc4 warnings in autoconf tests
* Debian needs <grp.h> for setgroups, which seems fairly POSIX

Testsuite succeeds on Debian testing/unstable (i386)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.79 2006/11/12 13:15:26 tg Exp $
d244 1
a244 1
	int main(int ac, char *av[]) { return (setmode(getmode(av[0], ac))); }
@


1.79
log
@unbelievably, cygwin doesn't have strcasestr(3)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.78 2006/11/12 13:09:09 tg Exp $
d221 1
a221 1
	int main(void) { arc4random(); return (0); }
d231 1
a231 1
	int main(void) { setlocale(LC_CTYPE, ""); return (0); }
d236 1
a236 1
	int main(void) { nl_langinfo(CODESET); return (0); }
d240 3
a242 3
	#if defined(__MSVCRT__) || defined(__CYGWIN__)
	#error Win32 setmode() is different from what we need
	#else
d244 1
a244 1
	int main(int ac, char *av[]) { return (setmode(getmode(av[0], ac))); }
d256 1
d263 1
a263 1
	int main(int ac, char *av[]) { strcasestr(av[0], av[1]); return (ac); }
d268 1
a268 1
	int main(int ac, char *av[]) { strlcpy(av[0], av[1], 1); return (ac); }
@


1.78
log
@header checks before function checks
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.77 2006/11/12 13:08:30 tg Exp $
d260 5
d272 1
@


1.77
log
@check for getmode as well when checking for setmode;
disable this check on winapi systems since their setmode is something else
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.76 2006/11/12 12:56:09 tg Exp $
d214 5
a264 5
ac_test sys_param_h '' '<sys/param.h>' <<'EOF'
	#include <sys/param.h>
	int main(void) { return (0); }
EOF

@


1.76
log
@scan for setresuid/setresgid and setgroups
no alternative implementation yet
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.75 2006/11/10 07:18:56 tg Exp $
d235 3
d239 2
a240 1
	int main(int ac, char *av[]) { setmode(av[0]); return (ac); }
@


1.75
log
@* use only macros for ctype stuff any more
  XXX one of these uses a gcc extension, ok for now tho
* don't include <ctype.h> any more at all
* don't try nl_langinfo in small mode, just check locale

saves 171 .text, 4 .data, 256 .bss, 1 import
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.74 2006/11/09 23:09:05 tg Exp $
d239 12
@


1.74
log
@make autoconf checks more verbose as well
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.73 2006/11/09 23:04:34 tg Exp $
a20 2
	test 0 = "$HAVE_$fu" && return
	test 1 = "$HAVE_$fu" && return
d29 9
d39 5
a43 2
		eval HAVE_$fu=$2
		$e "==> $fd... not checked ($2)"
d203 2
@


1.73
log
@check for a few more things
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.72 2006/11/09 22:56:55 tg Exp $
d38 2
a39 1
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS 2>&1 | sed 's/^/] /'
d76 1
a76 1
q=0
d89 1
a89 1
		q=1
d249 1
a249 1
test $q = 1 || v size $result
@


1.72
log
@simplify
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.71 2006/11/09 22:56:09 tg Exp $
a106 1
	NOWARN=-Wno-error
d165 12
d185 16
@


1.71
log
@new function ac_testn() does the same as ac_test() but doesn't amend CPPFLAGS
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.70 2006/11/09 22:53:21 tg Exp $
a50 2
	f=$1
	fu=`upper $f`
@


1.70
log
@unbreak -d (was broken in R28)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.69 2006/11/09 22:51:49 tg Exp $
d17 1
a17 1
ac_test()
d26 1
a26 2
		ft=`upper $2`
		eval ft=\$HAVE_$ft
a32 1
		eval CPPFLAGS=\"\$CPPFLAGS -DHAVE_$fu=$2\"
d47 7
d168 1
a168 1
ac_test mksh_full '' "if we're building without MKSH_SMALL" <<-'EOF'
@


1.69
log
@ac_test for MKSH_SMALL presence in CPPFLAGS
if present, don't even look for setmode as it's only used by mknod builtin
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.68 2006/11/09 15:02:30 tg Exp $
d75 1
d92 1
a101 1
	LDSTATIC=-static
@


1.68
log
@get rid of the need of strlcat() altogether (only one use was left)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.67 2006/11/09 00:13:27 tg Exp $
a20 2
	fd=$3
	test x"$fd" = x"" && fd=$f
d28 1
d30 2
d33 3
a35 2
		eval HAVE_$fu=0 CPPFLAGS=\"\$CPPFLAGS -DHAVE_$fu=0\"
		$e "==> $fd... no"
d162 8
d175 1
a175 1
ac_test arc4random_push arc4random <<-'EOF'
d185 1
a185 1
ac_test langinfo_codeset setlocale_ctype 'nl_langinfo(CODESET)' <<'EOF'
d190 1
a190 1
ac_test setmode <<-'EOF'
@


1.67
log
@optic sugar
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.66 2006/11/09 00:11:38 tg Exp $
a184 5
ac_test strlcat <<-'EOF'
	#include <string.h>
	int main(int ac, char *av[]) { strlcat(av[0], av[1], 1); return (ac); }
EOF

a196 1
addsrcs HAVE_STRLCAT strlfun.c
@


1.66
log
@* instead of including <sys/cdefs.h> (not in Solaris), we hope <sys/types.h>
  includes it for us
* autoconf-test for <sys/param.h> (not in SUSv3) existence
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.65 2006/11/09 00:08:25 tg Exp $
d33 1
@


1.65
log
@oops, missed syntactic change
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.64 2006/11/09 00:06:33 tg Exp $
d194 5
@


1.64
log
@use \u0060...\u0060 instead of $(...)
demanded by solaris /bin/sh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.63 2006/11/09 00:03:37 tg Exp $
d164 1
a164 1
ac_test arc4random_push HAVE_ARC4RANDOM <<-'EOF'
d174 1
a174 1
ac_test langinfo_codeset HAVE_SETLOCALE_CTYPE 'nl_langinfo(CODESET)' <<'EOF'
@


1.63
log
@there is no compat.c any more
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.62 2006/11/09 00:01:04 tg Exp $
d20 1
a20 1
	fu=$(upper $f)
d28 1
a28 1
		ft=$(upper $2)
@


1.62
log
@some build issues
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.61 2006/11/08 23:45:46 tg Exp $
a117 1
	SRCS="$SRCS compat.c strlfun.c"
a123 1
	SRCS="$SRCS compat.c"
@


1.61
log
@implement autoconf tests for langstuff; sync date
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.60 2006/11/08 23:38:28 tg Exp $
d12 5
d20 1
a20 1
	fu=$(echo $f | tr qwertyuiopasdfghjklzxcvbnm QWERTYUIOPASDFGHJKLZXCVBNM)
d28 2
a29 1
		eval ft=\$$2
d32 1
a32 1
		eval HAVE_$fu=0
d37 1
a37 1
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
d46 1
a46 8
}

addcppf()
{
	for i
	do
		eval CPPFLAGS=\"\$CPPFLAGS -D$i=\$$i\"
	done
d163 1
a163 1
	int main() { arc4random(); return (0); }
d168 1
a168 1
	int main() { arc4random_push(1); return (0); }
d173 1
a173 1
	int main() { setlocale(LC_CTYPE, ""); return (0); }
d178 1
a178 1
	int main() { nl_langinfo(CODESET); return (0); }
d183 1
a183 1
	int main(int ac, char *av[]) { setmode(av[0]); return (0); }
d188 1
a188 1
	int main(int ac, char *av[]) { strlcat(av[0], av[1], 1); return (0); }
d193 1
a193 1
	int main(int ac, char *av[]) { strlcpy(av[0], av[1], 1); return (0); }
a196 2
addcppf HAVE_ARC4RANDOM HAVE_ARC4RANDOM_PUSH HAVE_SETMODE \
    HAVE_STRLCAT HAVE_STRLCPY
@


1.60
log
@use shell macros instead of dupe code
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.59 2006/11/08 23:23:40 tg Exp $
d15 3
a17 1
	fu=$(echo $f | tr '[a-z]' '[A-Z]')
d29 1
a29 1
	$e ... $f
d34 1
a34 1
		$e "==> $f... yes"
d37 1
a37 1
		$e "==> $f... no"
d172 10
@


1.59
log
@first attempts at more autoconf'isation
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.58 2006/09/29 19:33:48 tg Exp $
d12 28
d48 9
d160 24
a183 104
f=arc4random
fu=$(echo $f | tr '[a-z]' '[A-Z]')
test 0 = "$HAVE_$fu" || test 1 = "$HAVE_$fu" ||
{
	$e ... $f
	cat >scn.c <<-'EOF'
		#include <stdlib.h>
		int main() { arc4random(); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		eval HAVE_$fu=1
		$e "==> $f... yes"
	else
		eval HAVE_$fu=0
		$e "==> $f... no"
	fi
	rm -f scn.c a.out a.exe
}

f=arc4random_push
fu=$(echo $f | tr '[a-z]' '[A-Z]')
test 0 = "$HAVE_$fu" || test 1 = "$HAVE_$fu" ||
if test 1 = "$HAVE_ARC4RANDOM"; then
	$e ... $f
	cat >scn.c <<-'EOF'
		#include <stdlib.h>
		int main() { arc4random_push(1); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		eval HAVE_$fu=1
		$e "==> $f... yes"
	else
		eval HAVE_$fu=0
		$e "==> $f... no"
	fi
	rm -f scn.c a.out a.exe
else
	HAVE_ARC4RANDOM_PUSH=0
fi

f=setmode
fu=$(echo $f | tr '[a-z]' '[A-Z]')
test 0 = "$HAVE_$fu" || test 1 = "$HAVE_$fu" ||
{
	$e ... $f
	cat >scn.c <<-'EOF'
		#include <unistd.h>
		int main(int ac, char *av[]) { setmode(av[0]); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		eval HAVE_$fu=1
		$e "==> $f... yes"
	else
		eval HAVE_$fu=0
		SRCS="$SRCS setmode.c"
		$e "==> $f... no"
	fi
	rm -f scn.c a.out a.exe
}

f=strlcat
fu=$(echo $f | tr '[a-z]' '[A-Z]')
test 0 = "$HAVE_$fu" || test 1 = "$HAVE_$fu" ||
{
	$e ... $f
	cat >scn.c <<-'EOF'
		#include <string.h>
		int main(int ac, char *av[]) { strlcat(av[0], av[1], 1); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		eval HAVE_$fu=1
		$e "==> $f... yes"
	else
		eval HAVE_$fu=0
		SRCS="$SRCS strlfun.c"
		$e "==> $f... no"
	fi
	rm -f scn.c a.out a.exe
}

f=strlcpy
fu=$(echo $f | tr '[a-z]' '[A-Z]')
test 0 = "$HAVE_$fu" || test 1 = "$HAVE_$fu" ||
{
	$e ... $f
	cat >scn.c <<-'EOF'
		#include <string.h>
		int main(int ac, char *av[]) { strlcpy(av[0], av[1], 1); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		eval HAVE_$fu=1
		$e "==> $f... yes"
	else
		eval HAVE_$fu=0
		SRCS="$SRCS strlfun.c"
		$e "==> $f... no"
	fi
	rm -f scn.c a.out a.exe
}
d188 3
@


1.58
log
@something about the strength-reduce bug being fixed
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.57 2006/09/21 22:12:05 tg Exp $
a69 2
	SRCS="$SRCS compat.c"
	CPPFLAGS="$CPPFLAGS -DNEED_COMPAT"
d77 1
a77 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE -DNEED_COMPAT"
d82 1
a82 1
	CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64 -DNEED_COMPAT"
d89 1
a89 1
	CPPFLAGS="$CPPFLAGS -D_FILE_OFFSET_BITS=64 -DNEED_COMPAT"
d121 1
a121 1
$e Scanning for functions...
d123 3
a125 1
test 0 = "$HAVE_ARC4RANDOM" || test 1 = "$HAVE_ARC4RANDOM" ||
d127 1
a127 1
	$e ... arc4random
d134 2
a135 2
		HAVE_ARC4RANDOM=1
		$e "==> arc4random... yes"
d137 2
a138 2
		HAVE_ARC4RANDOM=0
		$e "==> arc4random... no"
d143 3
a145 1
test 0 = "$HAVE_ARC4RANDOM_PUSH" || test 1 = "$HAVE_ARC4RANDOM_PUSH" ||
d147 1
a147 1
	$e ... arc4random_push
d154 2
a155 2
		HAVE_ARC4RANDOM_PUSH=1
		$e "==> arc4random_push... yes"
d157 2
a158 2
		HAVE_ARC4RANDOM_PUSH=0
		$e "==> arc4random_push... no"
d165 63
d229 2
a230 1
addcppf HAVE_ARC4RANDOM HAVE_ARC4RANDOM_PUSH
d233 1
@


1.57
log
@of course, I had to screw up

tested on Debian stale:
| Total failed: 1 (as expected)
| Total passed: 213
| tg@@flyingfish:~/mk b $ uname -a
| Linux flyingfish 2.6.13.1-grsec-aurisp #1 Wed Sep 28 15:13:07 CEST 2005 i686 GNU/Linux
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.56 2006/09/21 22:09:41 tg Exp $
d25 1
a25 1
: ${CFLAGS='-O2 -fno-strict-aliasing -fno-strength-reduce -Wall'}
@


1.56
log
@shebang, she don't work with spaces
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.55 2006/09/13 23:07:10 tg Exp $
d175 1
a175 1
* *)	echo "#!./mksh" >test.sh ;;
@


1.55
log
@no _POSIX_C_SOURCE=200112L for now, it works without on Solaris 8
and only without on "opensolaris build47 x86 32-bit"

reported in irc #ksh by <IvanR_> ivan@@babylon-5.seppuku.net (Ivan Richwalski)
thanks
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.54 2006/08/28 01:37:29 tg Exp $
d174 4
a177 1
echo "#!$curdir/mksh" >test.sh
@


1.54
log
@in the case of BSD software, the F in RTFM is not vulgar...
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.53 2006/08/28 01:30:37 tg Exp $
d90 1
a90 2
	CPPFLAGS="$CPPFLAGS -D_BSD_SOURCE -D_POSIX_C_SOURCE=200112L"
	CPPFLAGS="$CPPFLAGS -D__EXTENSIONS__"
@


1.53
log
@* move functions to top
* remove a few immature or redundant comments
* variablise better; use /usr/ucb/install on Solaris
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.52 2006/08/26 20:48:29 tg Exp $
d196 1
a196 1
$e Please also read the sample file dot.mkshrc and the manual.
@


1.52
log
@Solaris 8 friendliness
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.51 2006/08/26 20:30:27 tg Exp $
d6 6
a57 6
v()
{
	$e "$*"
	eval "$@@"
}

d62 1
d69 1
a69 1
	LDSTATIC= # they don't want it
d75 1
a75 1
	LDSTATIC= # never works
a81 1
	# Hello Mr Drepper, we all like you too...</sarcasm>
d85 1
a85 1
	LDSTATIC= # glibc dlopens the PAM library with getpwnam at runtime
d93 1
a93 1
	LDSTATIC= # alternatively you need libdl... same suckage as above
d133 1
a133 1
	$CC $CFLAGS $CPPFLAGS $LDFLAGS -Wno-error scn.c $LIBS
d151 1
a151 1
	$CC $CFLAGS $CPPFLAGS $LDFLAGS -Wno-error scn.c $LIBS
d179 2
d183 1
a183 1
$e "# install -c -s -o root -g bin -m 555 mksh /bin/mksh"
d185 1
a185 1
$e "# install -c -o root -g bin -m 444 dot.mkshrc /usr/share/doc/mksh/examples/"
d189 1
a189 1
	$e "# install -c -o root -g bin -m 444 mksh.cat1" \
d193 1
a193 1
$e "# install -c -o root -g bin -m 444 mksh.1 /usr/share/man/man1/mksh.1"
@


1.51
log
@use an autoconf-like approach to check for arc4random(3)
after gecko2 told me his mac recently has it and I found
out that Interix has it in -lcrypt and soon -lmirmake (:
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.50 2006/08/24 20:32:52 tg Exp $
d6 8
d95 1
d113 1
a113 1
		test $nr -gt 0 -a $nr -lt $NSIG || continue
d121 1
a121 1
	test -s signames.inc || exit 1
d126 1
a126 1
test 0 = "$HAVE_ARC4RANDOM" -o 0 = "$HAVE_ARC4RANDOM" ||
d134 1
a134 1
	if test -e a.out -o -e a.exe; then
d144 1
a144 1
test 0 = "$HAVE_ARC4RANDOM_PUSH" -o 0 = "$HAVE_ARC4RANDOM_PUSH" ||
d152 1
a152 1
	if test -e a.out -o -e a.exe; then
d165 1
a165 2
CPPFLAGS="$CPPFLAGS -DHAVE_ARC4RANDOM=$HAVE_ARC4RANDOM \
	-DHAVE_ARC4RANDOM_PUSH=$HAVE_ARC4RANDOM_PUSH"
d169 3
a171 1
test -x mksh || exit 1
d174 1
a174 1
test $q = 1 || v size mksh
d186 1
a186 1
if test -s mksh.cat1; then
@


1.50
log
@merge non-Plan9-specific stuff from the branch, add KNF, etc.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.49 2006/08/22 22:01:59 tg Exp $
d114 45
@


1.49
log
@* rename the (generated) Test.sh to test.sh
* point to it, TFM and the sample more
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.48 2006/08/12 20:30:22 tg Exp $
d6 5
@


1.48
log
@fix quoting levels of backthingies
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.47 2006/08/12 20:19:36 tg Exp $
d4 1
a4 1
# This script recognises CC, CFLAGS, CPPFLAGS, LDFLAGS, LIBS and NROFF.
d115 1
a115 1
echo "#!$curdir/mksh" >Test.sh
d117 2
a118 4
    "-p '$curdir/mksh' -C pdksh \$*" >>Test.sh
chmod 755 Test.sh
$e
$e To test mksh, execute ./Test.sh
d132 3
@


1.48.2.1
log
@initial attempt at porting mksh to the Plan 9 ANSI'n'POSIX Environment
struck dumb at SIGWINCH/TIOCGWINSZ, we'll have to ifdef out all of the
command line editing code as a next measure

incidentally, my qemu just crashed (not the guest OS - Plan 9 - no, it
really crashed the "outside" qemu programme, won't redraw or catch the
mouse any more), so I'll call it a day
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.48 2006/08/12 20:30:22 tg Exp $
a74 10
Plan9)
	SRCS="$SRCS compat.c strlfun.c"
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE -D_LIMITS_EXTENSION"
	CPPFLAGS="$CPPFLAGS -D_BSD_EXTENSION -D_SUSV2_SOURCE"
	CPPFLAGS="$CPPFLAGS -DNEED_COMPAT -D__Plan9__"
	LDSTATIC=
	# this is for the APE, gcc users might want to differ
	CC=cc
	CFLAGS=-O
	;;
@


1.48.2.2
log
@bring back Plan 9 specific stuff; we only do APE, not xterm
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.48.2.1 2006/08/15 23:49:51 tg Exp $
d81 1
@


1.48.2.3
log
@YAY, it works!

disallow build if it can't succeed
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.48.2.2 2006/08/18 19:04:34 tg Exp $
a5 5
if test -d mksh; then
	echo "$0: Error: ./mksh is a directory!" >&2
	exit 1
fi

@


1.48.2.4
log
@move tg-mksh-plan9ape_BASE to current cvs HEAD and sync tg-mksh-plan9ape branch
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.50 2006/08/24 20:32:52 tg Exp $
d4 1
a4 1
# Environment: CC, CFLAGS, CPPFLAGS, LDFLAGS, LIBS, NROFF
d129 1
a129 1
echo "#!$curdir/mksh" >test.sh
d131 4
a134 2
    "-p '$curdir/mksh' -C pdksh \$*" >>test.sh
chmod 755 test.sh
a147 3
$e
$e Run the regression test suite: ./test.sh
$e Please also read the sample file dot.mkshrc and the manual.
@


1.48.2.5
log
@don't even try to build the manpage, they don't have -mdoc macros
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.48.2.4 2006/08/24 20:52:08 tg Exp $
a87 1
	r=1
@


1.48.2.6
log
@merge the latest results of HEAD in here
and bring back the probably-problematic
chunk with a fat comment
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.54 2006/08/28 01:37:29 tg Exp $
a5 14
v()
{
	$e "$*"
	eval "$@@"
}

addcppf()
{
	for i
	do
		eval CPPFLAGS=\"\$CPPFLAGS -D$i=\$$i\"
	done
}

d44 6
a53 1
	NOWARN=-Wno-error
d60 1
a60 1
	LDSTATIC=
d66 1
a66 1
	LDSTATIC=
d73 1
d77 1
a77 1
	LDSTATIC=
a87 1
	NOWARN=
d95 1
a95 1
	LDSTATIC=
a96 1
	r=1
d114 1
a114 1
		test $nr -gt 0 && test $nr -lt $NSIG || continue
d122 1
a122 41
	test -f signames.inc || exit 1
fi

$e Scanning for functions...

test 0 = "$HAVE_ARC4RANDOM" || test 1 = "$HAVE_ARC4RANDOM" ||
{
	$e ... arc4random
	cat >scn.c <<-'EOF'
		#include <stdlib.h>
		int main() { arc4random(); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		HAVE_ARC4RANDOM=1
		$e "==> arc4random... yes"
	else
		HAVE_ARC4RANDOM=0
		$e "==> arc4random... no"
	fi
	rm -f scn.c a.out a.exe
}

test 0 = "$HAVE_ARC4RANDOM_PUSH" || test 1 = "$HAVE_ARC4RANDOM_PUSH" ||
if test 1 = "$HAVE_ARC4RANDOM"; then
	$e ... arc4random_push
	cat >scn.c <<-'EOF'
		#include <stdlib.h>
		int main() { arc4random_push(1); return (0); }
	EOF
	$CC $CFLAGS $CPPFLAGS $LDFLAGS $NOWARN scn.c $LIBS
	if test -f a.out || test -f a.exe; then
		HAVE_ARC4RANDOM_PUSH=1
		$e "==> arc4random_push... yes"
	else
		HAVE_ARC4RANDOM_PUSH=0
		$e "==> arc4random_push... no"
	fi
	rm -f scn.c a.out a.exe
else
	HAVE_ARC4RANDOM_PUSH=0
a123 4

$e ... done.
addcppf HAVE_ARC4RANDOM HAVE_ARC4RANDOM_PUSH

d126 1
a126 3
result=mksh
test -f mksh.exe && result=mksh.exe
test -f $result || exit 1
d129 1
a129 1
test $q = 1 || v size $result
a133 2
i=install
test -f /usr/ucb/$i && i=/usr/ucb/$i
d136 1
a136 1
$e "# $i -c -s -o root -g bin -m 555 mksh /bin/mksh"
d138 1
a138 1
$e "# $i -c -o root -g bin -m 444 dot.mkshrc /usr/share/doc/mksh/examples/"
d141 2
a142 2
if test -f mksh.cat1; then
	$e "# $i -c -o root -g bin -m 444 mksh.cat1" \
d146 1
a146 1
$e "# $i -c -o root -g bin -m 444 mksh.1 /usr/share/man/man1/mksh.1"
d149 1
a149 1
$e Please also read the sample file dot.mkshrc and the fine manual.
@


1.47
log
@some help from the autoconf portable shell docs
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.46 2006/08/12 20:01:35 tg Stab $
d87 2
a88 2
	NSIG=`printf %d "`(echo '#include <signal.h>'; echo mksh_test: NSIG) | \
	    $CC $CPPFLAGS -E - | grep mksh_test | sed 's/^mksh_test: //'`" 2>&-`
d94 3
a96 3
		( echo '#include <signal.h>'; echo "mksh_test: SIG$name" ) | \
		    $CC $CPPFLAGS -E - | grep mksh_test: | \
		    sed 's/^mksh_test: \([0-9]*\).*$/\1:'$name/
@


1.46
log
@fix and simplify further
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.45 2006/08/12 19:53:39 tg Exp $
d6 3
a8 3
: ${CFLAGS=-O2 -fno-strict-aliasing -fno-strength-reduce -Wall}
: ${CC:=gcc} ${srcdir:=`dirname "$0"`} ${NROFF:=nroff}
curdir=`pwd`
d16 3
a18 2
while test -n "$1"; do
	case $1 in
d33 1
a33 1
		echo "$0: Unknown option '$1'!" >&2
a36 1
	shift
d53 1
a53 1
test $x = 1 || case "`uname -s 2>/dev/null || uname`" in
d87 2
a88 3
	NSIG=`( echo '#include <signal.h>'; echo "mksh_test: NSIG" ) | \
	    $CC $CPPFLAGS -E - | grep mksh_test: | sed 's/^mksh_test: //'`
	NSIG=`printf %d "$NSIG" 2>&-`
@


1.45
log
@simplify further
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.44 2006/08/12 19:51:08 tg Exp $
d6 4
a9 5
CC="${CC:-gcc}"
CFLAGS="${CFLAGS--O2 -fno-strict-aliasing -fno-strength-reduce -Wall}"
srcdir="${srcdir:-`dirname "$0"`}"
curdir="`pwd`"
echo | ${NROFF:=nroff} -v 2>&1 | grep GNU >&- 2>&- && NROFF="$NROFF -c"
@


1.44
log
@a probably-Solaris-/bin/sh-workable improved algorithm
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.43 2006/08/12 19:38:44 tg Exp $
d10 1
a10 3

: ${NROFF:=nroff}
echo | $NROFF -v 2>&1 | grep GNU >&- 2>&- && NROFF="$NROFF -c"
@


1.43
log
@optimise signames.inc output (shrinks binary size)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.42 2006/08/12 19:26:20 tg Exp $
d12 1
a12 1
echo | $NROFF -v 2>&1 | fgrep GNU >&- 2>&- && NROFF="$NROFF -c"
d19 1
a19 1
while [ -n "$1" ]; do
d48 5
a52 2
[ $x = 1 ] || LDSTATIC=-static
[ $x = 1 ] || SRCS=
d56 1
a56 1
[ $x = 1 ] || case "`uname -s 2>/dev/null || uname`" in
d61 1
d76 1
d84 1
d88 25
a112 22
sigseen=:; $e Generating list of signal names
NSIG=`( echo '#include <signal.h>'; echo "__mksh_test: NSIG" ) \
    | $CC $CPPFLAGS -E - | grep __mksh_test: | sed 's/^__mksh_test: //'`
NSIG=`printf %d "$NSIG"`
echo '#include <signal.h>' | $CC $CPPFLAGS -E -dD - \
    | grep '[	 ]SIG[A-Z0-9]*[	 ]' \
    | sed 's/^\(.*[	 ]SIG\)\([A-Z0-9]*\)\([	 ].*\)$/\2/' \
    | while read name; do
	( echo '#include <signal.h>'; echo "__mksh_test: SIG$name" ) \
	    | $CC $CPPFLAGS -E - | grep __mksh_test: | sed \
	    's/^__mksh_test: \([0-9]*\).*$/\1:'$name/
done | grep -v '^:' | while IFS=: read number name; do
	nr=`printf %d "$number"`
	test $nr -gt 0 -a $nr -lt $NSIG || continue
	case $sigseen in
	*:$nr:*) ;;
	*)	echo "		{ $nr, \"$name\" },"
		sigseen=$sigseen$nr:
		;;
	esac
done >signames.inc
test -s signames.inc || exit 1
d116 3
a118 3
[ $r = 1 ] || v "$NROFF -mdoc <'$srcdir/mksh.1' >mksh.cat1" \
    || rm -f mksh.cat1
[ $q = 1 ] || v size mksh
d128 1
a128 1
$e "# fgrep -qx /bin/mksh /etc/shells || echo /bin/mksh >>/etc/shells"
@


1.42
log
@-D_ANSI_SOURCE no longer needed, verified on all platforms which
actually need signame.inc
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.41 2006/08/12 18:49:21 tg Exp $
d82 5
a86 1
(echo '#include <signal.h>' | $CC $CPPFLAGS -E -dD - \
d91 13
a103 3
	    | $CC $CPPFLAGS -E - | fgrep __mksh_test: | sed \
	    's/^__mksh_test: \([0-9]*\).*$/		{ \1, "'$name'" },/'
done | fgrep -v '{ ,' >signames.inc) || exit 1
@


1.41
log
@mirbsdksh -> mksh
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.40 2006/08/12 18:48:39 tg Exp $
d82 1
a82 1
(echo '#include <signal.h>' | $CC $CPPFLAGS -E -dD -D_ANSI_SOURCE - \
@


1.40
log
@sanitise variable handling and nroff vs gnroff detection
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.39 2006/08/12 18:43:55 tg Exp $
d101 1
a101 1
$e To test mirbsdksh, execute ./Test.sh
d103 1
a103 1
$e Installing mirbsdksh:
@


1.39
log
@gensigs.sh was called with $SHELL (or /bin/sh if $SHELL was a csh),
which failed for Han Boetes using zsh as user shell (to test). Now,
the code is integrated into Build.sh as-is, and Test.sh uses $SHELL
no longer either but the mksh just built, in the shebang line.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.38 2006/08/02 14:17:13 tg Exp $
d11 3
d50 1
a50 1
SRCS="alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c $SRCS"
a57 1
	: ${NROFF:=nroff -c}
a81 1
export CC CPPFLAGS
d93 1
a93 1
[ $r = 1 ] || v "${NROFF:-nroff} -mdoc <'$srcdir/mksh.1' >mksh.cat1" \
@


1.38
log
@use $SHELL for Test.sh too
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.37 2006/08/02 11:50:28 tg Exp $
a5 4
SHELL="${SHELL:-/bin/sh}"
case $SHELL in
*csh*)	SHELL=/bin/sh ;;
esac
a7 1
export SHELL
d81 8
a88 1
v $SHELL "'$srcdir/gensigs.sh'" || exit 1
d95 3
a97 2
echo "#!$SHELL" >Test.sh
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t' -p '$curdir/mksh' -C pdksh \$*" >>Test.sh
@


1.37
log
@* Build.sh: fix manpage generation defaults under Cygwin
* mksh.1: rework prompt ($PS1) section, simplify example,
  point to packaged dot.mkshrc example
* mksh.1: fix description of 'redraw' regarding redrawal
  of prompts longer than one screen line
* all: bump version/date
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.36 2006/08/02 10:41:03 tg Exp $
d93 1
a93 1
echo '#!/bin/sh' >Test.sh
@


1.36
log
@* Build.sh: fix accidental CR-LF catastrophe
  (yeah, that's what you get from developing with a
  16-bit MS-DOS(R) executable of your favourite text editor)
* lex.c, mksh.1: do not print the delimiting character for
  not-to-be-counted character sequences (i.e. ANSI escapes)
  in prompts any more, mostly because ASCII 01h is printable
  on both Interix and Cygwin and I'm lazy
  (this also fixes prompt width counting if a printable character
  such as 'x' is used as delimiting character)
* lex.c: through printing the prompt character by character,
  also print the delimited sequences if skipping, fixes some
  prompt redrawal not honouring colours stuff while not totally
  redrawing the entire prompt
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.35 2006/08/02 10:02:21 tg Exp $
d60 1
@


1.35
log
@fix build on Cygwin, has been broken for quite some time apparently
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.34 2006/08/01 12:57:07 tg Exp $
d56 1
a56 1
CYGWIN*)
d60 1
a60 1
	;;
@


1.34
log
@* use strsignal(3) not strerror(3), oops
* on GNU, that needs -D_GNU_SOURCE
* a little style(9) KNF while here
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.33 2006/07/23 18:44:22 tg Exp $
d56 5
@


1.33
log
@* get dot.mkshrc sample from Debian mksh-27.4-2
* sync dot.mkshrc sample with FreeWRT r383
* add some stuff from src/etc/profile and contrib/samples/etc_profile
* sync the latter two with reality and shorten
* teach the user in the mksh installation instructions to install the sample

NB: the sample is also covered by the MirOS licence
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.32 2006/07/03 12:17:08 tg Exp $
d66 1
a66 1
	CPPFLAGS="$CPPFLAGS -D_POSIX_C_SOURCE=2 -D_BSD_SOURCE"
@


1.32
log
@allow Test.sh to be passed arguments
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.31 2006/07/01 14:39:41 tg Exp $
d96 1
@


1.31
log
@adding -Wno-char-subscripts for Solaris is wrong
- I saw it on NetBSD/alpha too
- these ought to be fixed

I've got to investigate that later.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.30 2006/06/23 15:05:39 tg Exp $
d88 1
a88 1
echo "exec perl '$srcdir/check.pl' -s '$srcdir/check.t' -p '$curdir/mksh' -C pdksh" >>Test.sh
@


1.30
log
@add a little portability
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.29 2006/05/27 20:33:01 tg Exp $
a74 1
	CFLAGS="$CFLAGS -Wno-char-subscripts"
@


1.29
log
@move -D_FILE_OFFSET_BITS=64 (not on interix tho, sadly) - XXX where else?
and -DNEED_COMPAT
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.28 2006/05/27 11:30:07 tg Exp $
d12 1
a12 1
export SHELL CC
d19 1
a19 1
LDSTATIC=-static
d33 3
d47 1
a47 1
	eval "$*"
d50 3
a52 1
SRCS="alloc.c edit.c eval.c exec.c expr.c funcs.c histrap.c"
d55 1
a55 1
case "`uname -s 2>/dev/null || uname`" in
d80 1
d90 1
a90 1
chmod 555 Test.sh
@


1.28
log
@fix build under Solaris 10
From: Tonnerre LOMBARD <tonnerre@@bsdprojects.net>

doesn't break Solaris 8 on stinky.trash.net (tested)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.27 2006/05/26 22:24:20 tg Exp $
d11 1
a11 1
CFLAGS="${CFLAGS--O2 -fno-strict-aliasing -fno-strength-reduce -Wall -D_FILE_OFFSET_BITS=64}"
d53 1
d56 1
a56 1
	CPPFLAGS="$CPPFLAGS -D_ALL_SOURCE"
d62 1
d69 1
d76 1
a76 1
(v "cd '$srcdir' && exec $CC $CFLAGS -I'$curdir' $CPPFLAGS" -DNEED_COMPAT \
@


1.27
log
@need confstr proto on Debian
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.26 2006/05/10 20:34:28 tg Exp $
d65 2
a66 1
	CPPFLAGS="$CPPFLAGS -D_BSD_SOURCE"
@


1.26
log
@why do I suddenly need -D_BSD_SOURCE on GNU where I didn't before?
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.25 2006/03/19 18:06:31 tg Exp $
d60 1
a60 1
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE -D_BSD_SOURCE"
@


1.25
log
@* shuffle around _*_SOURCE definitions (sh.h -> Build.sh), per OS
* Tonnerre Lombard reports that Solaris 10 needs _BSD_SOURCE
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.24 2006/01/27 00:50:12 tg Exp $
d60 1
a60 1
	CPPFLAGS="$CPPFLAGS -D_POSIX_SOURCE"
@


1.24
log
@flesh out regression test into an on-the-fly-generated ./Test.sh
so that the user doesn't have to copy and paste a super-long line

idea by Han Boetes and others
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.23 2005/10/26 08:47:19 tg Exp $
d54 3
d60 1
d65 1
@


1.23
log
@only add /bin/mksh to /etc/shells once, hint from Han Boetes
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.22 2005/10/25 21:07:21 tg Exp $
d73 3
d77 1
a77 2
$e Testing mirbsdksh:
$e "$ perl '$srcdir/check.pl' -s '$srcdir/check.t' -p '$curdir/mksh' -C pdksh"
@


1.22
log
@this commentary is no longer needed
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.21 2005/10/25 20:59:00 tg Exp $
d79 1
a79 1
$e "# echo /bin/mksh >>/etc/shells"
@


1.21
log
@Solaris and GNU/Linux have fucked up PAM, so no -static there
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.20 2005/10/25 20:54:29 tg Exp $
d4 1
a4 2
# This script recognises CC, CFLAGS, CPPFLAGS, LDFLAGS, LIBS and
# NROFF. Add -d for dynamic linkage (on Mac, GNU/Linux and Solaris).
@


1.20
log
@no LDSTATIC on Darwin
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.19 2005/10/25 19:46:52 tg Exp $
d58 1
d63 1
@


1.19
log
@if we have some C shell, use /bin/sh instead
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.18 2005/10/25 19:46:10 tg Exp $
d52 3
@


1.18
log
@Shuffle some stuff around to the compat functions and add glue
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.17 2005/08/21 13:02:16 tg Exp $
d8 3
@


1.17
log
@* make 64-bit clean on GNU/Linux by default
* clean up and remove some .Xr from the man page
* bump version
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.16 2005/07/07 23:27:52 tg Exp $
d51 5
a55 1
	SRCS="$SRCS strlfun.c"
d60 1
a60 1
(v "cd '$srcdir' && exec $CC $CFLAGS -I'$curdir' $CPPFLAGS" \
@


1.16
log
@* move <sys/param.h> include to sh.h
* fix compilation and invocation of test suite with whitespace in
  the pathnames for real, this time
* clean up (especially whitespace)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.15 2005/06/08 23:02:08 tg Exp $
d4 2
a5 8
# Recognised environment variables and their defaults:
#	CC		gcc
#	CFLAGS		-O2 -fno-strict-aliasing -fno-strength-reduce
#	CPPFLAGS	(empty)
#	LDFLAGS		-static
#	LIBS		(empty)
#	NROFF		nroff		# (ignored if -r option given)
# GNU/Linux, Mac, Solaris: add -d, CPPFLAGS='-D_FILE_OFFSET_BITS=64'
d9 1
a9 1
CFLAGS="${CFLAGS--O2 -fno-strict-aliasing -fno-strength-reduce}"
d20 1
a20 1
	case "$1" in
@


1.15
log
@adjust "hints"
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.14 2005/06/08 22:47:54 tg Exp $
a9 1
#	srcdir		(path of script)
d11 1
a11 1
# GNU/Linux, Mac, Solaris: add -d, maybe -r, CPPFLAGS='-D_FILE_OFFSET_BITS=64'
@


1.14
log
@error messages to stderr
from Han Boetes
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.13 2005/06/08 22:46:06 tg Exp $
d12 1
a12 4
# Hints (WFM; don't take them seriously):
#	GNU/Linux	CPPFLAGS='-D_FILE_OFFSET_BITS=64'
#	Mac OSX		LDFLAGS=
#	Solaris		LDFLAGS=
@


1.13
log
@fix -r logic
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.12 2005/06/08 22:42:31 tg Exp $
d42 1
a42 1
		echo "$0: Unknown option '$1'!"
@


1.12
log
@Han Boetes wants a parameter for dynamically linked binaries
so I'll re-code a getopt clone

This _still_ works with Solaris /bin/sh, even if both source
and build (current) directory contain spaces.
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.11 2005/06/08 21:51:20 tg Exp $
d69 2
a70 1
v "${NROFF:-nroff} -mdoc <'$srcdir/mksh.1' >mksh.cat1" || rm -f mksh.cat1
@


1.11
log
@* major revamp of build system
* whitespace cleanup; junk comment removal
* syndicate debian/copyright file from my port (shrinks sh.h)
* bump to R23
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.10 2005/06/08 10:19:33 tg Exp $
a19 1
LDFLAGS="${LDFLAGS--static}"
d24 22
a45 3
if [ x"$1" = x"-q" ]; then
	e=:
	q=1
d47 1
a47 10
else
	e=echo
	q=0
fi
if [ x"$1" = x"-r" ]; then
	r=1
	shift
else
	r=0
fi
d66 2
a67 2
(v "cd '$srcdir' && exec $CC $CFLAGS -I'$curdir' $CPPFLAGS $LDFLAGS" \
    "-o '$curdir/mksh' $SRCS $LIBS") || exit 1
@


1.10
log
@adjust comments
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.9 2005/06/05 16:38:19 tg Exp $
d11 2
a12 2
#	NROFF		nroff	# (ignored if -r option given)
# Hints (don't take tgem seriously, WFM rather):
a17 2
srcdir="${srcdir:-`dirname $0`}"
curdir="`pwd`"
a20 2
NROFF="${NROFF:-nroff}"
OS="`uname -s || uname`"
d22 3
d40 6
d49 6
a54 2
# Hello Mr Drepper, we all like you too...</sarcasm>
[ x"$OS" = x"Linux" ] && SRCS="$SRCS strlfun.c"
d56 3
a58 8
$e Generating prerequisites...
$SHELL "$srcdir/gensigs.sh"
for hdr in errno signal; do
	h2ph -d . /usr/include/$hdr.h && mv _h2ph_pre.ph $hdr.ph
done
$e Building...
( cd "$srcdir" && exec $CC $CFLAGS -I "$curdir" $CPPFLAGS $LDFLAGS \
    -o $curdir/mksh $SRCS $LIBS )
d60 2
a61 4
$e Finalising...
[ $r = 1 ] || $NROFF -mdoc <"$srcdir/mksh.1" >mksh.cat1 || rm -f mksh.cat1
[ $q = 1 ] || size mksh
$e done.
@


1.9
log
@mksh R22d
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.8 2005/06/05 16:34:59 tg Exp $
d4 1
a4 1
# Recognised command line parameters and their defaults:
d11 1
a11 1
#	NROFF		nroff
@


1.8
log
@* allow build without nroff
* /usr/share/man except in some very weird GNU distributions
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.7 2005/05/30 07:05:29 tg Exp $
d15 1
a15 1
# 	Solaris		LDFLAGS=
@


1.7
log
@this commit made my dedicated server reboot spontaneously,
but the Pentium 120 with a Hercules graphics card (anno 1981)
survives it:

allow building and running the testsuite if the source or
build directory contain spaces (not unusual on Windows)
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.6 2005/05/28 21:30:32 tg Exp $
d29 1
d34 6
d57 1
a57 1
$NROFF -mdoc <"$srcdir/mksh.1" >mksh.cat1 || rm -f mksh.cat1
d74 1
a74 1
$e "# install -c -o root -g bin -m 444 mksh.1 /usr/man/man1/mksh.1"
@


1.6
log
@fix building in separate directory under non-MirOS
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.5 2005/05/25 23:44:50 tg Exp $
a21 1
CPPFLAGS="-I $curdir $CPPFLAGS"
d41 1
a41 1
$SHELL $srcdir/gensigs.sh
d46 2
a47 1
( cd $srcdir; $CC $CFLAGS $CPPFLAGS $LDFLAGS -o $curdir/mksh $SRCS $LIBS )
d50 1
a50 1
$NROFF -mdoc <$srcdir/mksh.1 >mksh.cat1 || rm -f mksh.cat1
d55 1
a55 1
$e "$ perl $srcdir/check.pl -s $srcdir/check.t -p $curdir/mksh -C pdksh"
@


1.5
log
@add a "quiet mode" to the build script
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.4 2005/05/25 09:53:02 tg Exp $
d18 2
d22 1
a23 2
srcdir="${srcdir:-`dirname $0`}"
curdir="`pwd`"
@


1.4
log
@need -D_FILE_OFFSET_BITS=64 on some weird OS
Debian PR 237038
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.3 2005/05/23 17:24:23 tg Exp $
d12 1
a12 1
# Hints:
d26 7
d40 1
a40 1
echo Generating prerequisites...
d45 1
a45 1
echo Building...
d48 1
a48 1
echo Finalising...
d50 11
a60 11
size mksh
echo done.
echo
echo Testing mirbsdksh:
echo "$ perl $srcdir/check.pl -s $srcdir/check.t -p $curdir/mksh -C pdksh"
echo
echo Installing mirbsdksh:
echo "# install -c -s -o root -g bin -m 555 mksh /bin/mksh"
echo "# echo /bin/mksh >>/etc/shells"
echo
echo Installing the manual:
d62 1
a62 1
	echo "# install -c -o root -g bin -m 444 mksh.cat1" \
d64 1
a64 1
	echo or
d66 1
a66 1
echo "# install -c -o root -g bin -m 444 mksh.1 /usr/man/man1/mksh.1"
@


1.3
log
@* Mac OSX 10.4 "Tiger"
	- has an antiquated ed(1)
	  (I'm lucky it has one, some GNU/Linux don't...)
	- cannot build mksh statically linked
* Solaris (SunOS 5.8)
	- needs libdl when statically linked (NSSwitch problem)
	- /bin/sh is not XPG.4 compatible, don't use test -e
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.2 2005/05/23 16:56:22 tg Exp $
d13 1
@


1.2
log
@though shalt not leave in debugging blahblah
@
text
@d2 1
a2 1
# $MirOS: src/bin/mksh/Build.sh,v 1.1 2005/05/23 16:48:52 tg Exp $
d12 3
d18 2
a19 2
CFLAGS="${CFLAGS:--O2 -fno-strict-aliasing -fno-strength-reduce}"
LDFLAGS="${LDFLAGS:--static}"
d39 1
a39 1
test -e mksh || exit 1
@


1.1
log
@add a new, easier, faster build script
@
text
@d2 2
a3 2
# $MirOS$

d26 1
d35 1
a35 1
#( cd $srcdir; $CC $CFLAGS $CPPFLAGS $LDFLAGS -o $curdir/mksh $SRCS $LIBS )
@

