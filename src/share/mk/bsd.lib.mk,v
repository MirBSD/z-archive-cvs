head	1.85;
access;
symbols
	MIRBSD_10:1.70.0.2
	MIRBSD_10_BASE:1.70
	MIRBSD_9_BASE:1.39
	MIRBSD_8:1.33.0.2
	MIRBSD_8_BASE:1.33
	cvs-200507211800:1.1.1.2
	cvs-200507040220:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.85
date	2013.03.18.19.14.50;	author tg;	state Exp;
branches;
next	1.84;
commitid	1005147677453E2E982;

1.84
date	2009.09.12.12.44.41;	author tg;	state Exp;
branches;
next	1.83;
commitid	1004AAB97BC3C4E07FA;

1.83
date	2009.09.12.09.47.34;	author tg;	state Exp;
branches;
next	1.82;
commitid	1004AAB6E3D4BCF3154;

1.82
date	2009.08.30.22.06.40;	author tg;	state Exp;
branches;
next	1.81;
commitid	1004A9AF7CA21768AFE;

1.81
date	2009.08.30.18.04.09;	author tg;	state Exp;
branches;
next	1.80;
commitid	1004A9ABF0C29F10D97;

1.80
date	2009.08.30.16.21.20;	author tg;	state Exp;
branches;
next	1.79;
commitid	1004A9AA70313BAF7F1;

1.79
date	2008.12.10.21.46.26;	author tg;	state Exp;
branches;
next	1.78;
commitid	100494038A97D264953;

1.78
date	2008.11.10.21.10.22;	author tg;	state Exp;
branches;
next	1.77;
commitid	1004918A32F7C57CF28;

1.77
date	2008.10.27.21.12.19;	author tg;	state Exp;
branches;
next	1.76;
commitid	10049062E955474273A;

1.76
date	2008.10.05.20.14.30;	author tg;	state Exp;
branches;
next	1.75;
commitid	10048E9203C1320A0A1;

1.75
date	2008.08.25.19.00.43;	author tg;	state Exp;
branches;
next	1.74;
commitid	10048B3015E77D49461;

1.74
date	2008.08.08.12.42.49;	author tg;	state Exp;
branches;
next	1.73;
commitid	100489C3F546CE5EC26;

1.73
date	2008.08.08.12.40.44;	author tg;	state Exp;
branches;
next	1.72;
commitid	100489C3E7E2B7D00B4;

1.72
date	2008.04.10.14.07.45;	author tg;	state Exp;
branches;
next	1.71;
commitid	10047FE1F455D192B1C;

1.71
date	2008.04.10.13.55.55;	author tg;	state Exp;
branches;
next	1.70;
commitid	10047FE1C7755F47616;

1.70
date	2007.08.28.19.21.17;	author tg;	state Exp;
branches;
next	1.69;
commitid	10046D4758063426FF4;

1.69
date	2007.07.02.14.43.53;	author tg;	state Exp;
branches;
next	1.68;
commitid	10046890EF96DC54F01;

1.68
date	2007.06.28.16.07.28;	author tg;	state Exp;
branches;
next	1.67;
commitid	1004683DCD20D626F9F;

1.67
date	2007.06.26.19.05.51;	author tg;	state Exp;
branches;
next	1.66;
commitid	100468163A43FCC24E6;

1.66
date	2007.06.26.18.32.42;	author tg;	state Exp;
branches;
next	1.65;
commitid	10046815BCB7327E435;

1.65
date	2007.06.12.11.52.11;	author tg;	state Exp;
branches;
next	1.64;
commitid	100466E88F530DF0688;

1.64
date	2007.06.12.09.41.58;	author tg;	state Exp;
branches;
next	1.63;
commitid	100466E6A7C5119E9ED;

1.63
date	2007.06.07.17.22.38;	author tg;	state Exp;
branches;
next	1.62;
commitid	10046683EF46F9D9C3A;

1.62
date	2007.06.07.17.19.51;	author tg;	state Exp;
branches;
next	1.61;
commitid	10046683E4A2DD4D6C8;

1.61
date	2007.06.07.17.18.18;	author tg;	state Exp;
branches;
next	1.60;
commitid	10046683DEA26CF2929;

1.60
date	2007.06.07.17.08.16;	author tg;	state Exp;
branches;
next	1.59;
commitid	10046683B7D40BBFA77;

1.59
date	2007.05.17.18.38.36;	author tg;	state Exp;
branches;
next	1.58;
commitid	100464CA0BC3310E768;

1.58
date	2007.05.17.17.48.06;	author tg;	state Exp;
branches;
next	1.57;
commitid	100464C95676BC63469;

1.57
date	2007.05.17.17.39.37;	author tg;	state Exp;
branches;
next	1.56;
commitid	100464C93645EED22FE;

1.56
date	2007.05.17.17.25.28;	author tg;	state Exp;
branches;
next	1.55;
commitid	100464C901A0709553E;

1.55
date	2007.05.17.17.21.44;	author tg;	state Exp;
branches;
next	1.54;
commitid	100464C8F0D00B2CCA7;

1.54
date	2007.04.28.00.12.46;	author tg;	state Exp;
branches;
next	1.53;
commitid	1004632918E6CE6474D;

1.53
date	2007.03.10.22.18.29;	author tg;	state Exp;
branches;
next	1.52;
commitid	10045F32EAA5AD91B4E;

1.52
date	2007.03.08.10.07.02;	author tg;	state Exp;
branches;
next	1.51;
commitid	10045EFE05510C5611E;

1.51
date	2007.03.02.02.58.57;	author tg;	state Exp;
branches;
next	1.50;
commitid	10045E792E976231AAA;

1.50
date	2006.10.28.19.52.51;	author tg;	state Exp;
branches;
next	1.49;
commitid	1004543B4F81120B887;

1.49
date	2006.10.06.22.05.59;	author tg;	state Exp;
branches;
next	1.48;
commitid	1004526D3546BB9311A;

1.48
date	2006.09.30.23.11.13;	author tg;	state Exp;
branches;
next	1.47;
commitid	100451EF97B210B0D28;

1.47
date	2006.09.29.21.57.08;	author tg;	state Exp;
branches;
next	1.46;
commitid	100451D96C32DE231BC;

1.46
date	2006.09.29.21.51.31;	author tg;	state Exp;
branches;
next	1.45;
commitid	100451D956655D32719;

1.45
date	2006.09.25.22.09.21;	author tg;	state Exp;
branches;
next	1.44;
commitid	100451853A12063D843;

1.44
date	2006.09.16.07.27.41;	author tg;	state Exp;
branches;
next	1.43;
commitid	100450BA77D04EFF13E;

1.43
date	2006.08.27.01.08.59;	author tg;	state Exp;
branches;
next	1.42;
commitid	10044F0F0A77810D654;

1.42
date	2006.07.03.02.29.03;	author tg;	state Exp;
branches;
next	1.41;
commitid	10044A880EF2F439C03;

1.41
date	2006.07.03.01.36.36;	author tg;	state Exp;
branches;
next	1.40;
commitid	10044A874B92DB7679F;

1.40
date	2006.07.02.23.31.50;	author tg;	state Exp;
branches;
next	1.39;
commitid	10044A8575760F61F97;

1.39
date	2006.06.17.20.08.08;	author tg;	state Exp;
branches;
next	1.38;
commitid	1004494613562439DA0;

1.38
date	2006.05.27.11.07.02;	author tg;	state Exp;
branches;
next	1.37;
commitid	100447832992D9C2351;

1.37
date	2006.05.21.13.04.45;	author tg;	state Exp;
branches;
next	1.36;
commitid	1004470657A1B781CB7;

1.36
date	2006.03.19.20.10.13;	author tg;	state Exp;
branches;
next	1.35;
commitid	100441DBABB7ACA9932;

1.35
date	2005.12.29.23.32.37;	author tg;	state Exp;
branches;
next	1.34;
commitid	10043B472173FBF75BB;

1.34
date	2005.12.29.23.16.09;	author tg;	state Exp;
branches;
next	1.33;
commitid	10043B46E3F11DB93E5;

1.33
date	2005.12.16.22.04.17;	author tg;	state Exp;
branches;
next	1.32;
commitid	10043A339F018DB22F3;

1.32
date	2005.12.16.21.57.23;	author tg;	state Exp;
branches;
next	1.31;
commitid	10043A33850251E0115;

1.31
date	2005.12.16.21.48.45;	author tg;	state Exp;
branches;
next	1.30;
commitid	10043A33616407103C3;

1.30
date	2005.12.15.01.28.37;	author tg;	state Exp;
branches;
next	1.29;
commitid	10043A0C6C66D3269DA;

1.29
date	2005.12.04.19.32.36;	author tg;	state Exp;
branches;
next	1.28;
commitid	5e1543934467fe32;

1.28
date	2005.11.19.12.34.57;	author tg;	state Exp;
branches;
next	1.27;
commitid	604d437f1bef96f7;

1.27
date	2005.11.19.12.27.54;	author tg;	state Exp;
branches;
next	1.26;
commitid	229c437f1a5d6e8f;

1.26
date	2005.10.26.17.51.27;	author tg;	state Exp;
branches;
next	1.25;
commitid	6ce0435fc22b67c9;

1.25
date	2005.10.20.12.47.06;	author tg;	state Exp;
branches;
next	1.24;
commitid	5e10435791d7157c;

1.24
date	2005.10.06.22.04.21;	author tg;	state Exp;
branches;
next	1.23;
commitid	173543459f72ef77;

1.23
date	2005.10.06.22.02.47;	author tg;	state Exp;
branches;
next	1.22;
commitid	177043459f08f7b5;

1.22
date	2005.10.06.21.47.56;	author tg;	state Exp;
branches;
next	1.21;
commitid	337843459b963360;

1.21
date	2005.09.19.19.11.06;	author tg;	state Exp;
branches;
next	1.20;
commitid	6bde432f0d4a8b60;

1.20
date	2005.08.28.19.39.01;	author tg;	state Exp;
branches;
next	1.19;
commitid	6ba3431212b764dc;

1.19
date	2005.08.20.12.46.49;	author bsiegert;	state Exp;
branches;
next	1.18;
commitid	5af64307255fb73d;

1.18
date	2005.07.04.02.37.18;	author tg;	state Exp;
branches;
next	1.17;
commitid	5a3342c8a0eed80e;

1.17
date	2005.06.14.13.47.38;	author tg;	state Exp;
branches;
next	1.16;
commitid	7c9942aedfb6942d;

1.16
date	2005.06.09.21.34.30;	author tg;	state Exp;
branches;
next	1.15;
commitid	5d9042a8b5bdac4c;

1.15
date	2005.05.21.14.45.16;	author tg;	state Exp;
branches;
next	1.14;
commitid	529f428f4989141d;

1.14
date	2005.04.16.21.24.06;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2005.04.16.21.22.32;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2005.04.16.21.03.01;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2005.04.16.20.16.43;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2005.04.10.20.31.37;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2005.04.10.20.20.22;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2005.04.10.20.09.25;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2005.04.10.20.04.26;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2005.04.10.20.00.51;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2005.04.10.19.58.08;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2005.04.10.19.54.00;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.05.12.02.29;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.02.14.18.57.46;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.27.17;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.27.17;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.07.04.02.25.10;	author tg;	state Exp;
branches;
next	;
commitid	5c2f42c89e13d7c7;


desc
@@


1.85
log
@invent a new library type ‚Äúextension‚Äù that is between DLL and plugin:
usually versioned, has LDADD and no-undefined, but not normally¬π -lc

‚ë† for now it has, but we add --as-needed here

XXX maybe, eventually, we should always use --as-needed?
XXX bsd makefiles as we know them are not suitable for today's environment
XXX anyway; in addition, using gcc adds -lc for SSP which pcc doesn't, etc
@
text
@# $MirOS: src/share/mk/bsd.lib.mk,v 1.84 2009/09/12 12:44:41 tg Exp $
# $OpenBSD: bsd.lib.mk,v 1.43 2004/09/20 18:52:38 espie Exp $
# $NetBSD: bsd.lib.mk,v 1.67 1996/01/17 20:39:26 mycroft Exp $
# @@(#)bsd.lib.mk	5.26 (Berkeley) 5/2/91

.if !defined(BSD_LIB_MK)
BSD_LIB_MK=1

.if exists(${.CURDIR}/../Makefile.inc)
.  include "${.CURDIR}/../Makefile.inc"
.endif

.if !defined(BSD_OWN_MK)
.  include <bsd.own.mk>
.endif

.if ${LTMIRMAKE:L} == "yes"
.  include <bsd.lt.mk>
.endif

.if defined(SHLIB_MAJOR) && !empty(SHLIB_MAJOR) \
    && defined(SHLIB_MINOR) && !empty(SHLIB_MINOR)
SHLIB_VERSION=	${SHLIB_MAJOR}.${SHLIB_MINOR}
.elif exists(${.CURDIR}/shlib_version)
.  include "${.CURDIR}/shlib_version"
SHLIB_VERSION?=	${major}.${minor}
.endif

SHLIB_TYPE?=	DLL
.ifdef SHLIB_VERSION
.  if empty(SHLIB_VERSION) || (${SHLIB_VERSION} == ".")
.    undef SHLIB_VERSION
.  endif
.endif
.ifndef SHLIB_VERSION
SHLIB_TYPE=	none
.endif

.if defined(SHLIB_VERSION) && ${NOPIC:L} == "no"
.  if ${RTLD_TYPE} == "dyld"
.    if ${SHLIB_TYPE:L} == "plugin"
_OSX_TYPE=	-bundle -undefined dynamic_lookup
.      if ${SHLIB_VERSION} == "-"
# DyLD, unversioned plugin
SHLIB_SONAME?=	lib${LIB}.bundle
.      else
# DyLD, versioned plugin
SHLIB_SONAME?=	lib${LIB}.${SHLIB_VERSION}.0.bundle
.      endif
.    else
_OSX_TYPE=	-dynamiclib -undefined error
.      if ${SHLIB_VERSION} == "-"
# DyLD, unversioned DLL
SHLIB_SONAME?=	lib${LIB}.dylib
.      else
# DyLD, versioned DLL
SHLIB_SONAME?=	lib${LIB}.${SHLIB_VERSION}.0.dylib
SHLIB_LINKS?=	lib${LIB}.${SHLIB_VERSION:R}.dylib lib${LIB}.dylib
.      endif
.    endif
.  elif ${RTLD_TYPE} == "GNU"
.    if (${SHLIB_VERSION} == "-") && ((${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension"))
SHLIB_SONAME?=	lib${LIB}.so
.    else
SHLIB_SONAME?=	lib${LIB}.so.${SHLIB_VERSION}.0
.    endif
.    if ${SHLIB_TYPE:U} == "DLL"
SHLIB_LINKS?=	lib${LIB}.so.${SHLIB_VERSION:R} lib${LIB}.so
.    endif
.  else
.    if (${SHLIB_VERSION} == "-") && ((${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension"))
SHLIB_SONAME?=	lib${LIB}.so
.    else
SHLIB_SONAME?=	lib${LIB}.so.${SHLIB_VERSION}
.    endif
.  endif
.  if ${OBJECT_FMT} == "PE"
.    if ${SHLIB_TYPE:U} == "DLL"
SHLIB_FLAGS?=	-Wl,--image-base,$$((RANDOM % 0x1000 / 4 * 0x40000 + 0x40000000))
.    else
.      warning I do not know how to do extensions or plugins on Interix
.    endif
.  else
SHLIB_FLAGS?=	${PICFLAG}
.  endif
.  if (${SHLIB_TYPE:U} == "DLL") && (${RTLD_TYPE} != "dyld") && \
    (${LTMIRMAKE:L} != "yes") && !defined(BSD_LIB_MK__nodefs)
# GNU or BSD, DLL
SHLIB_FLAGS+=	-Wl,--no-undefined
.    if ${LIB} != "c"
#XXX this should eventually go away
LDADD+=		-lc
.    endif
.  endif
.  if (${SHLIB_TYPE:L} == "extension") && (${RTLD_TYPE} != "dyld") && \
    (${LTMIRMAKE:L} != "yes")
# GNU or BSD, extension (in between DLL and plugin: for dlopen, no -lc,
#XXX (not yet: no -lc)
# no static/lint libs, no undefined symbols, uses DT_NEEDED records)
SHLIB_FLAGS+=	-Wl,--no-undefined
.    if ${LIB} != "c"
#XXX this should eventually go away
LDADD+=		-Wl,--as-needed -lc
.    endif
.  endif
SHLIB_FLAGS+=	${LDFLAGS}
.  if ${LTMIRMAKE:L} == "yes"
SHLIB_SONAME=	lib${LIB}.la
SHLIB_FLAGS+=	-rpath ${LIBDIR}
.  elif (${OBJECT_FMT} == "ELF") || (${OBJECT_FMT} == "PE")
SHLIB_FLAGS+=	-Wl,-rpath,${LIBDIR} -Wl,-rpath-link,${DESTDIR}${LIBDIR}
.  endif
.endif
SHLIB_LINKS?=

.if !empty(SRCS:M*.cc) || !empty(SRCS:M*.C) || \
    !empty(SRCS:M*.cxx) || !empty(SRCS:M*.cpp)
.  if ${LTMIRMAKE:L} == "yes"
LINKER?=	${LIBTOOL} --tag=CXX --mode=link ${CXX}
.  else
LINKER?=	${CXX}
.  endif
.elif !empty(SRCS:M*.F) || !empty(SRCS:M*.f)
.  if ${LTMIRMAKE:L} == "yes"
LINKER?=	${LIBTOOL} --tag=CC --mode=link ${FC}
.  else
LINKER?=	${FC}
.  endif
.else
.  if ${LTMIRMAKE:L} == "yes"
LINKER?=	${LIBTOOL} --tag=CC --mode=link ${CC}
.  else
LINKER?=	${CC}
.  endif
.endif

.if (${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension")
_LIBS_STATIC=	No
NOLINT=		Yes
.else
_LIBS_STATIC?=	Yes
.endif
.if ${NOPIC:L} == "no"
_LIBS_SHARED?=	Yes
.else
_LIBS_SHARED=	No
.endif

.if (${_LIBS_SHARED:L} != "yes") || (!defined(SHLIB_SONAME)) || \
    (defined(SHLIB_SONAME) && empty(SHLIB_SONAME))
.  undef SHLIB_SONAME
.  undef SHLIB_LINKS
.elif !defined(SHLIB_VERSION) || empty(SHLIB_VERSION)
.  error SHLIB_SONAME (${SHLIB_SONAME}) set, but SHLIB_VERSION unset
.elif ${LTMIRMAKE:L} == "yes"
.  if (${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension")
.    warning I do not know how to do plugins or extensions with LTMIRMAKE
.  endif
.  if ${SHLIB_VERSION} == "-"
# Libtool, unversioned DLLs
SHLIB_FLAGS+=	-avoid-version
.  else
# Libtool, versioned DLLs
# slow
#lt_current!=	print $$((${SHLIB_VERSION:R} + ${SHLIB_VERSION:E}))
lt_revision?=	0
#lt_age=	${SHLIB_VERSION:E}
#SHLIB_FLAGS+=	-version-info ${lt_current}:${lt_revision}:${lt_age}
SHLIB_FLAGS+=	-version-number ${SHLIB_VERSION:R}:${SHLIB_VERSION:E}:${lt_revision}
.  endif
.elif ${RTLD_TYPE} == "dyld"
.  if ${SHLIB_VERSION} == "-"
# DyLD, unversioned DLLs and plugins
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} ${_OSX_TYPE} \
		$$(${LORDER} ${SOBJS}|tsort -q) ${LDADD}
.  else
# DyLD, versioned DLLs and plugins
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} ${_OSX_TYPE} \
		$$(${LORDER} ${SOBJS}|tsort -q) ${LDADD} \
		-compatibility_version ${SHLIB_VERSION:R}.0 \
		-current_version ${SHLIB_VERSION}
.  endif
.elif ${RTLD_TYPE} == "GNU"
.  if ${SHLIB_VERSION} == "-"
# GNU, unversioned DLL or plugin
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} -shared \
		$$(${LORDER} ${SOBJS}|tsort -q) \
		-Wl,--start-group ${LDADD} -Wl,--end-group \
		-Wl,-soname,lib${LIB}.so
.  else
# GNU, versioned DLL or plugin
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} -shared \
		$$(${LORDER} ${SOBJS}|tsort -q) \
		-Wl,--start-group ${LDADD} -Wl,--end-group \
		-Wl,-soname,lib${LIB}.so.${SHLIB_VERSION:R}
.  endif
.else
# BSD, DLL or plugin
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} -shared \
		$$(${LORDER} ${SOBJS}|tsort -q) \
		-Wl,--start-group ${LDADD} -Wl,--end-group
.endif

.MAIN: all

# prefer .S to a .c, remove stuff not used in the BSD libraries.
# .so used for PIC object files.  .ln used for lint output files.
# .m for objective c files.
.SUFFIXES:
.SUFFIXES:	.out .o .so .lo .S .s .c .m .cc .C .cxx .cpp .y .l .i .ln .m4

.if (${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension")
.c.o .m.o:
	${COMPILE.c} ${CFLAGS_${.TARGET}:M*} -DPIC ${PICFLAG} -o $@@ $<

.cc.o .C.o .cxx.o .cpp.o:
	${COMPILE.cc} ${CXXFLAGS_${.TARGET}:M*} -DPIC ${PICFLAG} -o $@@ $<

.S.o .s.o:
	${COMPILE.S} ${AFLAGS_${.TARGET}:M*} -DPIC \
	    ${ASPICFLAG:S/^/-Wa,/} ${CFLAGS:M-[ID]*} ${AINC} -o $@@ $<
.else
.c.o .m.o:
	@@print -r -- ${COMPILE.c:Q} \
	    ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} ${.IMPSRC:Q} -o '$@@'
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} \
	    ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

.c.so .m.so:
	${COMPILE.c} ${CFLAGS_${.TARGET:.so=.o}:M*} -DPIC ${PICFLAG} -o $@@ $<

.c.ln:
	env CC=${_ORIG_CC:Q} ${LINT} ${LINTFLAGS} ${CFLAGS:M-[IDU]*} \
	    ${CPPFLAGS:M-[IDU]*} -i ${.IMPSRC}

.cc.o .C.o .cxx.o .cpp.o:
	@@print -r -- ${COMPILE.cc:Q} \
	    ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} ${.IMPSRC:Q} -o '$@@'
	@@${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} \
	    ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

.cc.so .C.so .cxx.so .cpp.so:
	${COMPILE.cc} ${CXXFLAGS_${.TARGET:.so=.o}:M*} -DPIC ${PICFLAG} -o $@@ $<

.S.o .s.o:
	@@print -r -- ${COMPILE.S:Q} \
	    ${AFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} ${CFLAGS:M-[ID]*:Q} \
	    ${AINC} ${.IMPSRC} -o '$@@'
	@@${COMPILE.S} ${AFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} \
	    ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

.S.so .s.so:
	${COMPILE.S} ${AFLAGS_${.TARGET:.so=.o}:M*} -DPIC \
	    ${ASPICFLAG:S/^/-Wa,/} ${CFLAGS:M-[ID]*} ${AINC} -o $@@ $<
.endif

.if ${WARNINGS:L} == "yes"
CFLAGS+=	${CDIAGFLAGS}
CXXFLAGS+=	${CXXDIAGFLAGS}
.endif
.if !${COPTS:M-fhonour-copts} || !${CFLAGS:M-fhonour-copts}
CFLAGS+=	${COPTS}
.endif
CXXFLAGS+=	${CXXOPTS} -fno-omit-frame-pointer
HOSTCFLAGS?=	${CFLAGS}

.if ${DEBUGLIBS:L} == "yes"
.  if !${CFLAGS:M-g*}
CFLAGS+=	-g1 -fno-omit-frame-pointer
CXXFLAGS+=	-g1
.  endif
DEBUG?=		-g
_DISCARD=	-X
_SODISCARD=	-X
.elif ${RTLD_TYPE} == "dyld"
_DISCARD=	-X
_SODISCARD=	-X
.else
_DISCARD=	-x
_SODISCARD=	-g -x
.endif

_LIBS=
.if ${LTMIRMAKE:L} == "yes"
_LIBS+=		lib${LIB}.la
.else
.  if ${_LIBS_STATIC:L} == "yes"
_LIBS+=		lib${LIB}.a
.  endif
.  if ${_LIBS_SHARED:L} == "yes"
_LIBS+=		lib${LIB}_pic.a ${SHLIB_SONAME}
.  endif
.endif
.if ${NOLINT:L} == "no"
_LIBS+=		llib-l${LIB}.ln
.endif

all: ${_LIBS} _SUBDIRUSE

.if ${LTMIRMAKE:L} == "yes"
OBJS+=		${SRCS:N*.h:R:S/$/.lo/g}
.elif (${SHLIB_TYPE:L} != "plugin") && (${SHLIB_TYPE:L} != "extension")
OBJS+=		${SRCS:N*.h:R:S/$/.o/g}
.endif
CLEANFILES+=	${SHLIB_LINKS}

.if ${LTMIRMAKE:L} == "yes"
lib${LIB}.la:: ${OBJS}
.  if defined(SHLIB_VERSION) && (${SHLIB_VERSION} != "-")
	@@print -r building libtool ${LIB} library \(version ${SHLIB_VERSION}\)
.  else
	@@print -r building libtool ${LIB} library
.  endif
	@@rm -f lib${LIB}.la
	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} ${OBJS} ${LDADD} -o $@@
.endif

.if (${SHLIB_TYPE:L} != "plugin") && (${SHLIB_TYPE:L} != "extension")
lib${LIB}.a:: ${OBJS}
	@@print -r building standard ${LIB} library
	@@rm -f lib${LIB}.a
	@@${AR} cq lib${LIB}.a $$(${LORDER} ${OBJS} | tsort -q)
.  if ${OBJECT_FMT} == "Mach-O"
	@@${RANLIB} lib${LIB}.a
.  endif
.endif

# If new-style debugging libraries are in effect, libFOO_pic.a
# contains debugging information - this is actually wanted.
.if (${SHLIB_TYPE:L} == "plugin") || (${SHLIB_TYPE:L} == "extension")
SOBJS+=		${SRCS:N*.h:R:S/$/.o/g}
.else
SOBJS+=		${OBJS:.o=.so}
.endif
lib${LIB}_pic.a:: ${SOBJS}
	@@print -r building shared object ${LIB} library
	@@rm -f lib${LIB}_pic.a
	@@${AR} cq lib${LIB}_pic.a $$(${LORDER} ${SOBJS} | tsort -q)
.if ${OBJECT_FMT} == "Mach-O"
	@@${RANLIB} lib${LIB}_pic.a
.endif

.if ${LTMIRMAKE:L} != "yes"
${SHLIB_SONAME}: ${CRTI} ${CRTBEGIN} ${SOBJS} ${DPADD} ${CRTEND} ${CRTN}
.  if defined(SHLIB_VERSION) && (${SHLIB_VERSION} != "-")
	@@print -r building ${SHLIB_TYPE} ${LIB} \(version ${SHLIB_VERSION}\)
.  else
	@@print -r building unversioned ${SHLIB_TYPE} ${SHLIB_SONAME}
.  endif
	@@rm -f ${SHLIB_SONAME}
	${LINK.shlib} -o $@@
.  for _i in ${SHLIB_LINKS}
	@@rm -f ${_i}
	ln -s ${SHLIB_SONAME} ${_i} || cp ${SHLIB_SONAME} ${_i}
.  endfor
.endif

LOBJS+=		${LSRCS:.c=.ln} ${SRCS:M*.c:.c=.ln} \
		${SRCS:M*.l:.l=.ln} ${SRCS:M*.y:.y=.ln}
LLIBS?=		-lc
llib-l${LIB}.ln: ${LOBJS}
	@@print -r building llib-l${LIB}.ln
	@@rm -f llib-l${LIB}.ln
	@@env CC=${_ORIG_CC:Q} ${LINT} -C${LIB} ${LOBJS} ${LLIBS}

.for _i in ${SRCS:M*.l} ${SRCS:M*.y}
CLEANFILES+=	${_i:R}.c
.endfor
.if ${YFLAGS:M-d}
.  for _i in ${SRCS:M*.y}
CLEANFILES+=	${_i:R}.h
.  endfor
.endif

.if !target(clean)
clean: _SUBDIRUSE
.  if ${LTMIRMAKE:L} == "yes"
	-${LIBTOOL} --mode=clean rm *.la *.lo
.  endif
	rm -f a.out [Ee]rrs mklog core *.core ${CLEANFILES}
	rm -f lib${LIB}.a ${OBJS}
	rm -f lib${LIB}_pic.a lib${LIB}.so.*.* lib${LIB}{,.*}.dylib ${SOBJS}
	rm -f llib-l${LIB}.ln ${LOBJS}
.endif

cleandir: _SUBDIRUSE clean

.if defined(SRCS)
afterdepend: .depend
.  if ${LTMIRMAKE:L} == "yes"
	@@print ',g/^\([^\.]*\).o[ ]*:/s//\1.o \1.lo:/\nwq' | ed -s .depend
.  else
	@@print ',g/^\([^\.]*\).o[ ]*:/s//\1.o \1.so:/\nwq' | ed -s .depend
.  endif
.endif

.if !target(install)
.  if !target(beforeinstall)
beforeinstall:
.  endif

realinstall:
.  if ${LTMIRMAKE:L} == "yes"
	${LIBTOOL} --mode=install ${INSTALL} ${INSTALL_COPY} -m ${LIBMODE} \
	    -o ${LIBOWN} -g ${LIBGRP} lib${LIB}.la ${DESTDIR}${LIBDIR}/
.  else
.    if ${_LIBS_STATIC:L} == "yes"
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
	    lib${LIB}.a ${DESTDIR}${LIBDIR}/
.      if ${OBJECT_FMT} == "Mach-O"
	chmod 600 ${DESTDIR}${LIBDIR}/lib${LIB}.a
	${RANLIB} ${DESTDIR}${LIBDIR}/lib${LIB}.a
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/lib${LIB}.a
.      endif
.    endif
.    ifdef SHLIB_SONAME
.      if (${OBJECT_FMT} == "Mach-O") && (${SHLIB_TYPE:L} != "plugin") && (${SHLIB_TYPE:L} != "extension")
	@@print -r Relinking dynamic ${LIB} library
	${LINK.shlib} -install_name ${LIBDIR}/${SHLIB_SONAME} -o ${SHLIB_SONAME}
.      endif
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 \
	    ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}~
.      if !defined(MKC_DEBG) || ${MKC_DEBG:L} == "no"
	${STRIP} ${_SODISCARD} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}~
.      endif
	cd ${DESTDIR}${LIBDIR} && \
	    chmod ${LIBMODE} ${SHLIB_SONAME}~ && \
	    mv -f ${SHLIB_SONAME}~ ${SHLIB_SONAME}
.      for _i in ${SHLIB_LINKS}
	@@rm -f ${DESTDIR}${LIBDIR}/${_i}
	cd ${DESTDIR}${LIBDIR}; \
	    ln -s ${SHLIB_SONAME} ${_i} || cp ${SHLIB_SONAME} ${_i}
.      endfor
.    elif ${_LIBS_SHARED:L} == "yes"
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
	    lib${LIB}_pic.a ${DESTDIR}${LIBDIR}/
.      if ${OBJECT_FMT} == "Mach-O"
	chmod 600 ${DESTDIR}${LIBDIR}/lib${LIB}_pic.a
	${RANLIB} ${DESTDIR}${LIBDIR}/lib${LIB}_pic.a
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/lib${LIB}_pic.a
.      endif
.    endif
.  endif
.  if ${NOLINT:L} == "no"
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${SHAREMODE} \
	    llib-l${LIB}.ln ${DESTDIR}${LINTLIBDIR}/
.  endif
.  if defined(LINKS) && !empty(LINKS)
.    for lnk file in ${LINKS}
	@@l=${DESTDIR}${lnk}; \
	 t=${DESTDIR}${file}; \
	 print -r -- $$t -\> $$l; \
	 rm -f $$t; ln $$l $$t || cp $$l $$t
.    endfor
.  endif

install: maninstall _SUBDIRUSE
maninstall: afterinstall
afterinstall: realinstall
realinstall: beforeinstall
.endif	# not target install

.if !target(tags)
tags: ${.CURDIR}/tags

${.CURDIR}/tags: ${SRCS}
	${CTAGS} -w -f $@@ ${.ALLSRC:N*.S:N*.s}
	egrep "^SYSENTRY(.*)|^ENTRY(.*)|^NENTRY(.*)|^ALTENTRY(.*)|^FUNC(.*)|^SYSCALL(.*)" \
	    /dev/null ${.ALLSRC:M*.S} ${.ALLSRC:M*.s} | sed \
	    "s;\([^:]*\):\([^(]*\)(\([^, )]*\)\(.*\);\3 \1 /^\2(\3\4$$/;" >>$@@
	sort -o $@@ $@@
.endif

.if ${NOMAN:L} == "no"
.  include <bsd.man.mk>
.endif

.include <bsd.obj.mk>
.include <bsd.dep.mk>
.include <bsd.subdir.mk>
.include <bsd.sys.mk>

.endif
@


1.84
log
@also do not add --no-undefined (-z defs) if BSD_LIB_MK__nodefs is defined,
for cases where we *must* manually override this
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.83 2009/09/12 09:47:34 tg Exp $
d62 1
a62 1
.    if (${SHLIB_TYPE:L} == "plugin") && (${SHLIB_VERSION} == "-")
d71 1
a71 1
.    if (${SHLIB_TYPE:L} == "plugin") && (${SHLIB_VERSION} == "-")
d81 1
a81 1
.      warning I do not know how to do plugins on Interix
d91 1
d95 11
d137 1
a137 1
.if ${SHLIB_TYPE:L} == "plugin"
d156 2
a157 2
.  if ${SHLIB_TYPE:L} == "plugin"
.    warning I do not know how to do plugins with LTMIRMAKE
d212 1
a212 1
.if ${SHLIB_TYPE:L} == "plugin"
d308 1
a308 1
.elif ${SHLIB_TYPE:L} != "plugin"
d324 1
a324 1
.if ${SHLIB_TYPE:L} != "plugin"
d336 1
a336 1
.if ${SHLIB_TYPE:L} == "plugin"
d423 1
a423 1
.      if (${OBJECT_FMT} == "Mach-O") && (${SHLIB_TYPE:L} != "plugin")
@


1.83
log
@no -Wl,--no-undefined for LTMIRMAKE ‚Äì unbreaks ports/devel/lrmi
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.82 2009/08/30 22:06:40 tg Exp $
d87 1
a87 1
    (${LTMIRMAKE:L} != "yes")
@


1.82
log
@‚Ä¢ Mach-O bundles (Benny: simply press F3 in mc to see the type ‚ò∫) do not
  need to be relinked, apparently
‚Ä¢ fix accidentally swapped lines

fixes Lua and its plugins for me, on anakin
need to test on macppc tho‚Ä¶
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.81 2009/08/30 18:04:09 tg Exp $
d86 2
a87 1
.  if (${SHLIB_TYPE:U} == "DLL") && (${RTLD_TYPE} != "dyld")
@


1.81
log
@add experimental support for distinguishing between DLLs and plugins
to <bsd.lib.mk> ‚Äì both versioned and unversioned

needs to be tested on GNU (Interix) and DyLD (Darwin, Mac OSX)

agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.80 2009/08/30 16:21:20 tg Exp $
d42 1
a42 1
_OSX_TYPE=	-dynamiclib -undefined error
d51 1
a51 1
_OSX_TYPE=	-bundle -undefined dynamic_lookup
d410 1
a410 1
.      if ${OBJECT_FMT} == "Mach-O"
@


1.80
log
@fix shlibs/bundles with no version number for Darwin
(note that bundles need to be fixed separately)

ok bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.79 2008/12/10 21:46:26 tg Exp $
d29 1
d35 3
d41 16
d59 2
d62 3
d66 2
d69 1
d71 3
d75 1
d78 1
d80 3
d86 7
d124 4
d129 1
d143 3
d147 1
d150 1
d160 2
a161 1
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} -dynamiclib \
d164 2
a165 1
LINK.shlib?=	${LINKER} ${CFLAGS:M*} ${SHLIB_FLAGS} -dynamiclib \
d172 1
d178 1
d185 1
d199 11
d248 1
d295 1
a295 1
.else
d311 1
d316 1
a316 1
.if ${OBJECT_FMT} == "Mach-O"
d318 1
d323 3
d327 1
d339 1
a339 1
	@@print -r building shared ${LIB} library \(version ${SHLIB_VERSION}\)
d341 1
a341 1
	@@print -r building shared library ${SHLIB_SONAME}
@


1.79
log
@same to ‚Äúmake lint‚Äù target
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.78 2008/11/10 21:10:22 tg Exp $
d106 4
d112 1
a112 1
		-compatibility_version ${SHLIB_VERSION} \
d114 1
@


1.78
log
@‚Ä¢ add minimal Fortran support to <sys.mk>, <bsd.prog.mk>, <bsd.lib.mk>
  ‚Ä£ untested except for 99 bottles of beer example
‚Ä¢ bump OS to MirBSD #10uA3, so that people can actually compile LLVM
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.77 2008/10/27 21:12:19 tg Exp $
d148 2
a149 1
	${LINT} ${LINTFLAGS} ${CFLAGS:M-[IDU]*} ${CPPFLAGS:M-[IDU]*} -i ${.IMPSRC}
d276 1
a276 1
	@@${LINT} -C${LIB} ${LOBJS} ${LLIBS}
@


1.77
log
@fix dependency information for the LTMIRMAKE case (shlibs)

XXX bsd.prog.mk does not have similar issues as we do not
XXX use libfool to build .lo files for executables (now)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.76 2008/10/05 20:14:30 tg Exp $
d67 6
@


1.76
log
@add experimental, discouraged LTMIRMAKE variable and modus operandi
sort of works for dylibs and programmes; does not consider bundles yet

shouldn‚Äôt affect normal operation at all

agreed to commit bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.75 2008/08/25 19:00:43 tg Exp $
d295 3
d299 1
@


1.75
log
@preparing in /usr/src/include/../lib/libncurses
AWK=/usr/bin/awk /bin/mksh /usr/src/lib/libncurses/src/include/MKkey_defs.sh  /usr/src/lib/libncurses/src/include/Caps >curses.keys
cat /usr/src/lib/libncurses/src/include/curses.head curses.keys  /usr/src/lib/libncurses/src/include/curses.wide  /usr/src/lib/libncurses/src/include/curses.tail >curses.h
/usr/bin/awk -f /usr/src/lib/libncurses/src/include/MKterm.h.awk /usr/src/lib/libncurses/src/include/Caps >term.h
preparing in /usr/src/include/../lib/librpcsvc
"/usr/share/mk/bsd.lib.mk", line 204: Malformed conditional (${SHLIB_VERSION} != "-")
"/usr/share/mk/bsd.lib.mk", line 329: if-less endif
"/usr/share/mk/bsd.lib.mk", line 329: Need an operator
Fatal errors encountered -- cannot continue
*** Error code 1

Stop in /usr/src/include (line 50 of Makefile).
*** Error code 1
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.74 2008/08/08 12:42:49 tg Exp $
d17 4
d51 4
a54 1
.  if (${OBJECT_FMT} == "ELF") || (${OBJECT_FMT} == "PE")
d62 3
d66 1
d68 3
d72 1
d88 11
d128 1
a128 1
.SUFFIXES:	.out .o .so .S .s .c .m .cc .C .cxx .cpp .y .l .i .ln .m4
d195 4
a198 1
.if ${_LIBS_STATIC:L} == "yes"
d200 2
a201 2
.endif
.if ${_LIBS_SHARED:L} == "yes"
d203 1
d211 3
d215 1
d218 11
d248 1
d250 1
a250 1
.if defined(SHLIB_VERSION) && (${SHLIB_VERSION} != "-")
d252 1
a252 1
.else
d254 1
a254 1
.endif
d257 1
a257 1
.for _i in ${SHLIB_LINKS}
d260 2
a261 1
.endfor
d282 3
d304 5
a308 1
.  if ${_LIBS_STATIC:L} == "yes"
d311 1
a311 1
.    if ${OBJECT_FMT} == "Mach-O"
d315 1
d317 2
a318 3
.  endif
.  ifdef SHLIB_SONAME
.    if ${OBJECT_FMT} == "Mach-O"
d321 1
a321 1
.    endif
d324 1
a324 1
.    if !defined(MKC_DEBG) || ${MKC_DEBG:L} == "no"
d326 1
a326 1
.    endif
d330 1
a330 1
.    for _i in ${SHLIB_LINKS}
d334 2
a335 2
.    endfor
.  elif ${_LIBS_SHARED:L} == "yes"
d338 1
a338 1
.    if ${OBJECT_FMT} == "Mach-O"
d342 1
@


1.74
log
@verbal fixes‚Ä¶ I should grok my own logic some time
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.73 2008/08/08 12:40:44 tg Exp $
d204 1
a204 1
.if ${SHLIB_VERSION} != "-"
@


1.73
log
@‚Ä¢ if SHLIB_VERSION is not set but building shared library, error out
  ‚Åç use SHLIB_VERSION=- for bundles/plugins
‚Ä¢ fix for RTLD_TYPE==GNU and SHLIB_VERSION=-

This work partially sponsored by SyGroup GmbH and GoTo navisend AG

‚Ä¢ bump mirmake vsn
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.72 2008/04/10 14:07:45 tg Exp $
d204 1
a204 1
.if defined(SHLIB_VERSION)
@


1.72
log
@optimise
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.71 2008/04/10 13:55:55 tg Exp $
d71 2
d79 6
d89 1
@


1.71
log
@fix C++ support: I‚Äôve seen distfiles with *.cpp and *.C files now
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.70 2007/08/28 19:21:17 tg Exp $
d96 2
a97 2
	@@echo ${COMPILE.c:Q} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} \
	    '${.IMPSRC} -o $@@'
d110 2
a111 2
	@@echo ${COMPILE.cc:Q} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} \
	    '${.IMPSRC} -o $@@'
d121 3
a123 2
	@@echo ${COMPILE.S:Q} ${AFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} \
	    '${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} -o $@@'
d176 1
a176 1
	@@echo building standard ${LIB} library
d187 1
a187 1
	@@echo building shared object ${LIB} library
d196 1
a196 1
	@@echo building shared ${LIB} library \(version ${SHLIB_VERSION}\)
d198 1
a198 1
	@@echo building shared library ${SHLIB_SONAME}
d211 1
a211 1
	@@echo building llib-l${LIB}.ln
d256 1
a256 1
	@@echo Relinking dynamic ${LIB} library
d289 1
a289 1
	 echo $$t -\> $$l; \
@


1.70
log
@GNU ed 0.3 doesn‚Äôt support the % short notation for ‚Äú1,$‚Äù any more,
relative to GNU ed 0.2 ‚Äì doesn‚Äôt this just suck?
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.69 2007/07/02 14:43:53 tg Exp $
d53 2
a54 1
.if !empty(SRCS:M*.C) || !empty(SRCS:M*.cc) || !empty(SRCS:M*.cxx)
d93 1
a93 1
.SUFFIXES:	.out .o .so .S .s .c .m .cc .cxx .y .l .i .ln .m4
d109 1
a109 1
.cc.o .cxx.o:
d117 1
a117 1
.cc.so .cxx.so:
@


1.69
log
@‚Ä¢ On Darwin / Mac OSX, ld fails if -x is used with
  | /usr/bin/ld: /Volumes/FreeWRT/freewrt/tools_build/w-mirmake-20070626-3/mirmake/build/libmirmake/libmirmake.a(getopt_long.o) malformed object (section (__TEXT,__textcoal_nt) no symbol at start of coalesced section)
  or something similar. Drop the -x, use -X which seems to work.
  (Note: on Solaris, -x also seems to make problems. Thanks joerg@@dragonfly)
‚Ä¢ The Darwin ld(1) doesn't support -g either.
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.68 2007/06/28 16:07:28 tg Exp $
d234 1
a234 1
	@@print '%g/^\([^\.]*\).o[ ]*:/s//\1.o \1.so:/\nwq' | ed -s .depend
@


1.68
log
@clean SHLIB_LINKS too
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.67 2007/06/26 19:05:51 tg Exp $
d149 3
@


1.67
log
@variablise strip
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.66 2007/06/26 18:32:42 tg Exp $
d168 1
@


1.66
log
@fix GNU ld-elf.so library sonaming, cought by FreeWRT openssl build with mmake
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.65 2007/06/12 11:52:11 tg Exp $
d256 1
a256 1
	strip ${_SODISCARD} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}~
@


1.65
log
@having libc.so 0600 for some time would be bad
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.64 2007/06/12 09:41:58 tg Exp $
d79 1
a79 1
		-Wl,-h,${SHLIB_SONAME:R}
@


1.64
log
@if MKC_DEBG, do not strip _anything_
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.63 2007/06/07 17:22:38 tg Exp $
d254 1
a254 1
	    ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/
d256 1
a256 1
	strip ${_SODISCARD} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}
d258 3
a260 1
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}
@


1.63
log
@GRAUGH!
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.62 2007/06/07 17:19:51 tg Exp $
d255 1
d257 1
@


1.62
log
@‚Ä¶ and the file extension
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.61 2007/06/07 17:18:18 tg Exp $
d255 1
a255 1
	${STRIP} ${_SODISCARD} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}
@


1.61
log
@damn, missing the .so targets
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.60 2007/06/07 17:08:16 tg Exp $
d103 1
a103 1
	${COMPILE.c} ${CFLAGS_${.TARGET:.so=.o}:M*} -DPIC ${PICFLAG} ${.IMPSRC}
d117 1
a117 1
	${COMPILE.cc} ${CXXFLAGS_${.TARGET:.so=.o}:M*} -DPIC ${PICFLAG} $<
d129 1
a129 1
	    ${ASPICFLAG:S/^/-Wa,/} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC}
@


1.60
log
@‚Ä¢ never strip the symbol table from shared libraries
‚Ä¢ we can optimise .so object build now
‚Ä¢ remove a useless if clause
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.59 2007/05/17 18:38:36 tg Exp $
d102 3
d116 3
d127 4
@


1.59
log
@more includes-target overhaul:
‚Ä¢ document it
‚Ä¢ do it for <bsd.prog.mk> too
‚Ä¢ move it to <bsd.sys.mk>, handle generation by <bsd.subdir.mk>
‚Ä¢ add /usr/include/openssl to mtree(8) base system tree file
‚Ä¢ have all libs and flex use the generic target
‚Ä¢ clean them up; repair a few bugs
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.58 2007/05/17 17:48:06 tg Exp $
a101 8
.c.so .m.so:
	@@echo ${COMPILE.c:Q} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} \
	    '-DPIC ${PICFLAG} ${.IMPSRC} -o $@@'
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} \
	    -DPIC ${PICFLAG} ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

a112 8
.cc.so .cxx.so:
	@@echo ${COMPILE.cc:Q} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} \
	    '-DPIC ${PICFLAG} ${.IMPSRC} -o $@@'
	@@${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} \
	    -DPIC ${PICFLAG} ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

a120 8
.S.so .s.so:
	@@echo ${COMPILE.S:Q} ${AFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*:Q} -DPIC \
	    '${ASPICFLAG:S/^/-Wa,/} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} -o $@@'
	@@${COMPILE.S} ${AFLAGS_${.TARGET:C/\.(g|s)o$/.o/}:M*} -DPIC \
	    ${ASPICFLAG:S/^/-Wa,/} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

d138 1
a138 1
INSTALL_STRIP=	#empty
d141 1
d243 4
a246 2
	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} -o ${LIBOWN} -g ${LIBGRP} \
	    -m ${LIBMODE} ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/
d249 2
a250 3
	cd ${DESTDIR}${LIBDIR} && if ! ln -s ${SHLIB_SONAME} ${_i}; then \
		cp ${SHLIB_SONAME} ${_i}; \
	fi
@


1.58
log
@show is-same output too
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.57 2007/05/17 17:39:37 tg Exp $
a312 35
.if (defined(HDRS) || defined(HDRS2)) && !target(includes)
HDRSRC?=${.CURDIR}
HDRDST?=${DESTDIR}/usr/include

afterincludes:
includes: _includes afterincludes

.PHONY: _includes afterincludes

_includes:
.  ifdef HDRS
	@@cd ${HDRSRC:Q}; for i in ${HDRS}; do \
		j=$${i##*/}; \
		if cmp -s "$$i" ${HDRDST:Q}/"$$j"; then \
			print Header ${HDRDST:Q}/"$$j <=> $$i"; \
		else \
			print Header ${HDRDST:Q}/"$$j <-- $$i"; \
			${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} \
			    -m ${NONBINMODE} "$$i" ${HDRDST:Q}/; \
		fi; \
	done
.  endif
.  ifdef HDRS2
.    for _i _j in ${HDRS2}
	@@if cmp -s ${HDRSRC:Q}/${_i:Q} ${HDRDST:Q}/${_j:Q}; then \
		print Header ${HDRDST:Q}/${_j:Q} '<=>' ${_i:Q}; \
	else \
		print Header ${HDRDST:Q}/${_j:Q} '<--' ${_i:Q}; \
		${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} \
		    -m ${NONBINMODE} ${HDRSRC:Q}/${_i:Q} ${HDRDST:Q}/${_j:Q}; \
	fi
.    endfor
.  endif
.endif

@


1.57
log
@some extensions for relative src/dst dir and pairs
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.56 2007/05/17 17:25:28 tg Exp $
d327 1
a327 1
			print Header ${HDRDST:Q}/"$$j" is up to date.; \
d338 1
a338 1
		print Header ${HDRDST:Q}/${_j:Q} is up to date.; \
@


1.56
log
@optional different source dir
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.55 2007/05/17 17:21:44 tg Exp $
d313 1
a313 1
.if defined(HDRS) && !target(includes)
d315 1
d317 11
a327 5
includes:
	@@cd ${HDRSRC}; for i in ${HDRS}; do \
		if cmp -s "$$i" ${DESTDIR:Q}/usr/include/"$$i"; then \
			print Header ${DESTDIR:Q}/usr/include/"$$i" \
			    is up to date.; \
d329 1
a329 2
			print Header ${DESTDIR:Q}/usr/include/"$$i" \
			    "<-- $$i"; \
d331 1
a331 1
			    -m ${NONBINMODE} "$$i" ${DESTDIR}/usr/include/; \
d334 12
@


1.55
log
@‚Ä¢ provide a generic ‚Äúincludes‚Äù target if HDRS given and none exists

  ‚Äúwurscht‚Äù bsiegert@@, ‚Äúk√§se‚Äù waldi@@, ‚Äúbrot‚Äù ssimon@@ ‚òª
‚Ä¢ bump mirmake vsn
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.54 2007/04/28 00:12:46 tg Exp $
d314 2
d317 1
a317 1
	@@cd ${.CURDIR}; for i in ${HDRS}; do \
@


1.54
log
@more lex/yacc overhaul, tentatively
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.53 2007/03/10 22:18:29 tg Exp $
d313 15
@


1.53
log
@‚Ä¢ uh oh, unassociated shell commands in <bsd.lib.mk> from the recent
  as-vs-cc dispute; how could've this worked at all?
‚Ä¢ fix ctags stuff while here
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.52 2007/03/08 10:07:02 tg Exp $
d214 2
a215 1
LOBJS+=		${LSRCS:.c=.ln} ${SRCS:M*.c:.c=.ln}
d222 9
@


1.52
log
@use about the same compile commands in all places
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.51 2007/03/02 02:58:57 tg Exp $
a136 7
	@@${CPP} -D_ASM_SOURCE ${AFLAGS:N-Wa,*:M*} ${CPPFLAGS} \
	    ${CFLAGS:M-[ID]*} ${AINC} ${AFLAGS_${.TARGET}:N-Wa,*:M*} $< | \
	    ${AS} ${AFLAGS:M-Wa,*:S/-Wa//:S/,/ /g} \
	    ${AFLAGS_${.TARGET}:M-Wa,*:S/-Wa//:S/,/ /g} -o $@@.o
	@@${LD} ${_DISCARD} -r $@@.o -o $@@
	@@rm -f $@@.o

d296 2
a297 2
	ctags -w -f $@@ ${.ALLSRC:N*.S:N*.s}
	egrep "^SYSENTRY(.*)|^ENTRY(.*)|^NENTRY(.*)|^FUNC(.*)|^SYSCALL(.*)" \
@


1.51
log
@fix building of .o/.so files for libraries from .s/.S files wrt <sys.mk>
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.50 2006/10/28 19:52:51 tg Exp $
d95 2
a96 2
	@@echo ${COMPILE.c:Q} ${CFLAGS_${.TARGET:C/(g|s)o$/.o/}:M*:Q} \
	    "${.IMPSRC} -o $@@"
d104 1
a104 1
	    -DPIC ${PICFLAG} "${.IMPSRC} -o $@@"
d115 1
a115 1
	    "${.IMPSRC} -o $@@"
d123 1
a123 1
	    -DPIC ${PICFLAG} "${.IMPSRC} -o $@@"
d130 7
a136 4
	@@echo "${CPP} -D_ASM_SOURCE ${AFLAGS:N-Wa,*:M*} ${CPPFLAGS}" \
	    "${CFLAGS:M-[ID]*} ${AINC} ${AFLAGS_${.TARGET}:N-Wa,*:M*} $< |" \
	    "${AS} ${AFLAGS:M-Wa,*:S/-Wa//:S/,/ /g}" \
	    "${AFLAGS_${.TARGET}:M-Wa,*:S/-Wa//:S/,/ /g} -o $@@"
d145 4
a148 8
	@@echo "${CPP} -DPIC -D_ASM_SOURCE ${AFLAGS:N-Wa,*:M*} ${CPPFLAGS}" \
	    "${CFLAGS:M-[ID]*} ${AINC} ${AFLAGS_${.TARGET}:N-Wa,*:M*} $< |" \
	    "${AS} ${ASPICFLAG} ${AFLAGS:M-Wa,*:S/-Wa//:S/,/ /g}" \
	    "${AFLAGS_${.TARGET}:M-Wa,*:S/-Wa//:S/,/ /g} -o $@@"
	@@${CPP} -DPIC -D_ASM_SOURCE ${AFLAGS:N-Wa,*:M*} ${CPPFLAGS} \
	    ${CFLAGS:M-[ID]*} ${AINC} ${AFLAGS_${.TARGET}:N-Wa,*:M*} $< | \
	    ${AS} ${ASPICFLAG} ${AFLAGS:M-Wa,*:S/-Wa//:S/,/ /g} \
	    ${AFLAGS_${.TARGET}:M-Wa,*:S/-Wa//:S/,/ /g} -o $@@.o
@


1.50
log
@* add new CONFGRP?=wheel (mirmake: same as BINGRP, unless BINGRP is the
  default of 'bin', in which case, it defaults to '0')
* sort logically, not alphabetically
* INSTALL_STRIP libs (while here)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.49 2006/10/06 22:05:59 tg Exp $
d130 8
a137 4
	@@echo "${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} |" \
	    "${AS} -o $@@"
	@@${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
	    ${AS} -o $@@.o
d142 8
a149 4
	@@echo "${CPP} -DPIC ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} $< |" \
	    "${AS} ${ASPICFLAG} -o $@@"
	@@${CPP} -DPIC ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
	    ${AS} ${ASPICFLAG} -o $@@.o
@


1.49
log
@add -fno-omit-frame-pointer to all C++ compilations, here too
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.48 2006/09/30 23:11:13 tg Exp $
d162 1
d256 2
a257 2
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
	    ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/
@


1.48
log
@don't duplicate -g1 -fno-omit-frame-pointer for libs, place them in the
right place on the command line, handle linking, assembly files, etc.
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.47 2006/09/29 21:57:08 tg Exp $
d152 1
a152 1
CXXFLAGS+=	${CXXOPTS}
d158 1
a158 1
CXXFLAGS+=	-g1 -fno-omit-frame-pointer
@


1.47
log
@:M* the CFLAGS and friends
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.46 2006/09/29 21:51:31 tg Exp $
d156 5
a160 1
DEBUG?=		-g1 -fno-omit-frame-pointer
@


1.46
log
@allow _LIBS_SHARED?=(NOPIC?No:Yes), _LIBS_STATIC?=Yes to be overwritten
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.45 2006/09/25 22:09:21 tg Exp $
d71 1
a71 1
LINK.shlib?=	${LINKER} ${CFLAGS} ${SHLIB_FLAGS} -dynamiclib \
d76 1
a76 1
LINK.shlib?=	${LINKER} ${CFLAGS} ${SHLIB_FLAGS} -shared \
d81 1
a81 1
LINK.shlib?=	${LINKER} ${CFLAGS} ${SHLIB_FLAGS} -shared \
d95 1
a95 1
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/(g|s)o$/.o/}}" \
d97 1
a97 1
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
d103 3
a105 3
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}}" \
	    "-DPIC ${PICFLAG} ${.IMPSRC} -o $@@"
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
d114 1
a114 1
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}}" \
d116 1
a116 1
	@@${COMPILE.cc}  ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
d122 3
a124 3
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}}" \
	    "-DPIC ${PICFLAG} ${.IMPSRC} -o $@@"
	@@${COMPILE.cc}  ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
@


1.45
log
@add -fno-omit-frame-pointer if DEBUGLIBS
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.44 2006/09/16 07:27:41 tg Exp $
d59 9
a67 1
.if defined(SHLIB_SONAME) && empty(SHLIB_SONAME)
d162 3
a164 4
_LIBS=		lib${LIB}.a

.if ${NOPIC:L} == "no"
_LIBS+=		lib${LIB}_pic.a
d166 2
a167 3

.ifdef SHLIB_SONAME
_LIBS+=		${SHLIB_SONAME}
a168 1

d237 1
d240 1
a240 1
.  if ${OBJECT_FMT} == "Mach-O"
d244 1
d259 1
a259 1
.  elif ${NOPIC:L} == "no"
@


1.44
log
@fix inclusion order, match <bsd.prog.mk>
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.43 2006/08/27 01:08:59 tg Exp $
d148 1
a148 1
DEBUG?=		-g1
@


1.43
log
@the f.cking macintosh needs ranlib, I give up for tonight
the new mirmake updates will have to wait a little more
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.42 2006/07/03 02:29:03 tg Exp $
d9 4
a16 4
.if exists(${.CURDIR}/../Makefile.inc)
.  include "${.CURDIR}/../Makefile.inc"
.endif

@


1.42
log
@revert adding libc dependency, there's no DT_NEED entry for it in the libs
discussion follows on the ML
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.41 2006/07/03 01:36:36 tg Exp $
d176 3
d187 3
d234 5
d255 5
@


1.41
log
@sync order
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.40 2006/07/02 23:31:50 tg Exp $
d185 1
a185 1
${SHLIB_SONAME}: ${CRTI} ${CRTBEGIN} ${SOBJS} ${LIBC} ${DPADD} ${CRTEND} ${CRTN}
@


1.40
log
@* depend all shared libraries on libc
* remove refs to a few obsolete libs
* we don't depend on libgcc since it's machdep and compiler-dependent
* bump mirmake vsn
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.39 2006/06/17 20:08:08 tg Exp $
d185 1
a185 1
${SHLIB_SONAME}: ${SOBJS} ${CRTBEGIN} ${CRTEND} ${CRTI} ${CRTN} ${LIBC} ${DPADD}
@


1.39
log
@can't do it the same in <bsd.cfwrap.mk>
so distinguish, again
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.38 2006/05/27 11:07:02 tg Exp $
d185 1
a185 1
${SHLIB_SONAME}: ${SOBJS} ${CRTBEGIN} ${CRTEND} ${CRTI} ${CRTN} ${DPADD}
@


1.38
log
@* not only has Darwin no GNU ld but cctools (which doesn't support
  -( ... -) options), but also we can't require it because binutils
  doesn't support configuring a Darwin ld(1), so adapt the defini-
  tions of LINK.prog and (see below) LINK.shlib to not frame ${LDADD}
  with these if not supported
* LINK.shlib didn't contain ${LDADD}, sync with LINK.prog
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.37 2006/05/21 13:04:45 tg Exp $
d145 1
@


1.37
log
@add a slightly refined tags target (for devs only)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.36 2006/03/19 20:10:13 tg Exp $
d64 1
a64 1
		$$(${LORDER} ${SOBJS}|tsort -q) \
d70 1
d74 2
a75 1
		$$(${LORDER} ${SOBJS}|tsort -q)
d191 1
a191 1
	${LINK.shlib} -Wl,--start-group ${LDADD} -Wl,--end-group -o $@@
d230 1
a230 2
	${LINK.shlib} -Wl,--start-group ${LDADD} -Wl,--end-group \
	    -install_name ${LIBDIR}/${SHLIB_SONAME} -o ${SHLIB_SONAME}
@


1.36
log
@+.if !${COPTS:M-fhonour-copts} || !${CFLAGS:M-fhonour-copts}
 CFLAGS+=       ${COPTS}
+.endif

This saves most of the "passed twice" problems of ports which
use our make and <bsd.prog.mk> and friends.
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.35 2005/12/29 23:32:37 tg Exp $
d262 11
@


1.35
log
@* only on PE and ELF, not a.out (or Mach-O)
* use -rpath-link too (thanks XFree86Æ for the hint)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.34 2005/12/29 23:16:09 tg Exp $
d139 1
d141 1
@


1.34
log
@add a DT_RPATH to all libraries built via make(1) and <bsd.lib.mk>
ok bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.33 2005/12/16 22:04:17 tg Exp $
d47 2
a48 2
.  if ${OBJECT_FMT} != "Mach-O"
SHLIB_FLAGS+=	-Wl,-rpath,${LIBDIR}
@


1.33
log
@remove LDADD_CYCLIC, just use the groups always, it's not that much a payoff
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.32 2005/12/16 21:57:23 tg Exp $
d47 3
@


1.32
log
@adjust -x/-X according to DEBUGLIBS
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.31 2005/12/16 21:48:45 tg Exp $
a55 5
.if defined(LDADD_CYCLIC) && defined(LDADD) && !empty(LDADD)
# This has "a significant performance cost", cf. ld(texinfo)
LDADD:=		-Wl,--start-group ${LDADD} -Wl,--end-group
.endif

d61 1
d63 1
a63 2
		-current_version ${SHLIB_VERSION} \
		$$(${LORDER} ${SOBJS}|tsort -q) ${LDADD}
d66 1
a66 1
		$$(${LORDER} ${SOBJS}|tsort -q) ${LDADD} \
d70 1
a70 1
		$$(${LORDER} ${SOBJS}|tsort -q) ${LDADD}
d184 1
a184 1
	${LINK.shlib} -o $@@
d223 2
a224 2
	${LINK.shlib} -install_name ${LIBDIR}/${SHLIB_SONAME} \
	    -o ${SHLIB_SONAME}
@


1.31
log
@DEBUGLIBS is back, defaulting to Yes (mirbsd) / No (mirmake),
adding -g1 (for now, later maybe -g) to shared+static library
builds to provide meaningful backtraces

XXX might change default for mirmake to Yes as well
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.30 2005/12/15 01:28:37 tg Exp $
d91 1
a91 1
	@@${LD} -X -r $@@.o -o $@@
d99 1
a99 1
	@@${LD} -X -r $@@.o -o $@@
d110 1
a110 1
	@@${LD} -X -r $@@.o -o $@@
d118 1
a118 1
	@@${LD} -X -r $@@.o -o $@@
d126 1
a126 1
	@@${LD} -X -r $@@.o -o $@@
d134 1
a134 1
	@@${LD} -X -r $@@.o -o $@@
d146 3
@


1.30
log
@remove hooks for DEBUGLIBS, DEBUGPROGS
gdb happily loaded $PROG.dbg but forgot libc.so.X.Y.dbg *sigh*
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.29 2005/12/04 19:32:36 tg Exp $
d84 1
a84 1
.SUFFIXES:	.out .o .go .so .S .s .c .m .cc .cxx .y .l .i .ln .m4
a90 8
	@@${LD} -x -r $@@.o -o $@@
	@@rm -f $@@.o

.c.go .m.go:
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}}" \
	    "-g ${.IMPSRC} -o $@@"
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
	    -g ${.IMPSRC} -o $@@.o
d99 1
a99 1
	@@${LD} -x -r $@@.o -o $@@
a109 8
	@@${LD} -x -r $@@.o -o $@@
	@@rm -f $@@.o

.cc.go .cxx.go:
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}}" \
	    "-g ${.IMPSRC} -o $@@"
	@@${COMPILE.cc}  ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} \
	    -g ${.IMPSRC} -o $@@.o
d118 1
a118 1
	@@${LD} -x -r $@@.o -o $@@
a125 8
	@@${LD} -x -r $@@.o -o $@@
	@@rm -f $@@.o

.S.go .s.go:
	@@echo "${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} |" \
	    "${AS} -o $@@"
	@@${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
	    ${AS} -o $@@.o
d134 1
a134 1
	@@${LD} -x -r $@@.o -o $@@
d144 4
a170 7
# This is an old-style debugging static library and no longer in use.
GOBJS+=		${OBJS:.o=.go}
lib${LIB}_g.a:: ${GOBJS}
	@@echo building debugging ${LIB} library
	@@rm -f lib${LIB}_g.a
	@@${AR} cq lib${LIB}_g.a $$(${LORDER} ${GOBJS} | tsort -q)

a202 1
	rm -f lib${LIB}_g.a ${GOBJS}
@


1.29
log
@deraadt says it's ok
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.28 2005/11/19 12:34:57 tg Exp $
a79 6
# If building new-style shared libraries with debugging information,
# add some debugging flags to the .so file compiling.
.if ${DEBUGLIBS:L} == "yes"
PICFLAG+=	-g
.endif

a106 3
.if ${DEBUGLIBS:L} == "yes"
	@@${LD} -X -r $@@.o -o $@@
.else
a107 1
.endif
a255 1
.    if ${DEBUGLIBS:L} != "yes"
a257 12
.    else
	-rm -f ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}.{dbg,tmp}
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 \
	    ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}.tmp
	objcopy --only-keep-debug ${SHLIB_SONAME} \
	    ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}.dbg && cd ${DESTDIR}${LIBDIR} \
	    && objcopy --strip-debug --add-gnu-debuglink=${SHLIB_SONAME}.dbg \
	    ${SHLIB_SONAME}.tmp && chmod ${SHAREMODE} ${SHLIB_SONAME}.dbg && \
	    chown ${LIBOWN}:${LIBGRP} ${SHLIB_SONAME}.dbg && ln -f \
	    ${SHLIB_SONAME}.tmp ${SHLIB_SONAME} && chmod ${LIBMODE} \
	    ${SHLIB_SONAME} && rm -f ${SHLIB_SONAME}.tmp
.    endif
@


1.28
log
@add (and, exceptionally, document) LDADD_CYCLIC
bump mirmake version
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.26 2005/10/26 17:51:27 tg Exp $
a229 1
# the following looks XXX to me... -- cgd
@


1.27
log
@fix indentation
@
text
@d56 5
@


1.26
log
@make DEBUG{LIBS,PROGS} work as user
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.25 2005/10/20 12:47:06 tg Exp $
d50 1
a50 1
.  if !empty(SRCS:M*.C) || !empty(SRCS:M*.cc) || !empty(SRCS:M*.cxx)
d52 1
a52 1
.  else
d54 1
a54 1
.  endif
@


1.25
log
@solve concurrency problems with DEBUG* installation
by using temporary files and ln -f
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.24 2005/10/06 22:04:21 tg Exp $
d267 1
a267 1
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
d274 2
a275 1
	    ${SHLIB_SONAME}.tmp ${SHLIB_SONAME} && rm -f ${SHLIB_SONAME}.tmp
@


1.24
log
@* typo fixes
* fix omission in .SUFFIXES
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.23 2005/10/06 22:02:47 tg Exp $
d262 1
d265 10
a274 7
.    if ${DEBUGLIBS:L} == "yes"
	-rm -f ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}.dbg
	cd ${DESTDIR}${LIBDIR} && \
	    objcopy --only-keep-debug ${SHLIB_SONAME} ${SHLIB_SONAME}.dbg && \
	    objcopy --strip-debug --add-gnu-debuglink=${SHLIB_SONAME}.dbg \
	    ${SHLIB_SONAME} && chmod ${SHAREMODE} ${SHLIB_SONAME}.dbg && \
	    chown ${LIBOWN}:${LIBGRP} ${SHLIB_SONAME}.dbg
@


1.23
log
@remove the $@@.dbg before attempting to create a new, just in case
(I don't trust GNU tools to DTRT)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.22 2005/10/06 21:47:56 tg Exp $
d265 1
a265 1
	-r -f ${DESTDIR}${LIBDIR}/${SHLIB_SONAME}.dbg
@


1.22
log
@this is how DEBUGLINK actually works... don't ask...
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.21 2005/09/19 19:11:06 tg Exp $
d265 1
@


1.21
log
@remove useless use of sed(1), replace with ed(1)
fixes a bunch of warnings if invoked as regular user, too.
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.20 2005/08/28 19:39:01 tg Exp $
a78 1
CLEANFILES+=	${SHLIB_SONAME}.dbg
a218 5
.if ${DEBUGLIBS:L} == "yes"
	objcopy --only-keep-debug $@@ $@@.dbg
	objcopy --strip-debug $@@
	objcopy --add-gnu-debuglink=$@@.dbg $@@
.endif
a260 5
.      if ${DEBUGLIBS:L} == "yes"
	objcopy --only-keep-debug ${SHLIB_SONAME} ${SHLIB_SONAME}.dbg
	objcopy --strip-debug ${SHLIB_SONAME}
	objcopy --add-gnu-debuglink=${SHLIB_SONAME}.dbg ${SHLIB_SONAME}
.      endif
d264 7
a276 4
.    if ${DEBUGLIBS:L} == "yes"
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${SHAREMODE} \
	    ${SHLIB_SONAME}.dbg ${DESTDIR}${LIBDIR}/
.    endif
@


1.20
log
@* no RANLIB needed for us any more
* remove old DEBUGLIBS (libFOO_g.a)
  still available by 'make libFOO_g.a', but ignored by make install
* add new DEBUGLIBS and DEBUGPROGS using .gnu.debuglink section
* fix display
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.19 2005/08/20 12:46:49 bsiegert Exp $
d251 1
a251 7
	@@(TMP=$$(mktemp -q /tmp/_dependXXXXXXXXXX); \
	  if [ $$? -ne 0 ]; then \
		echo "$$0: cannot create temp file, exiting..."; \
		exit 1; \
	  fi; \
	  sed -e 's/^\([^\.]*\).o[ ]*:/\1.o \1.so:/' \
	    <.depend >$$TMP; mv $$TMP .depend)
@


1.19
log
@Bugfix: For dyld and GNU platforms, generate shared libraries with a three-
component version, instead of to components as on BSD. The last part is
always 0.

Example: libpng is now called libpng.7.0.0.dylib instead of
libpng.7.0.dylib on Darwin.

Now that library dependencies with dyld mostly work, the other library
name is not found by the resolve-lib script.

tg@@: we need a new MirMake release. I can build one on Mac OS 10.3 if you
like. Is there a script available to do it?
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.18 2005/07/04 02:37:18 tg Exp $
d75 7
d89 1
a89 1
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/(g|s)o$/.o/}} " \
d97 1
a97 1
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} " \
d105 2
a106 2
	@@echo "${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} " \
	    "${PICFLAG} -DPIC ${.IMPSRC} -o $@@"
d108 4
a111 1
	    ${PICFLAG} -DPIC ${.IMPSRC} -o $@@.o
d113 1
d120 1
a120 1
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} " \
d128 1
a128 1
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} " \
d136 2
a137 2
	@@echo "${COMPILE.cc} ${CXXFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} " \
	    "${PICFLAG} -DPIC ${.IMPSRC} -o $@@"
d139 1
a139 1
	    ${PICFLAG} -DPIC ${.IMPSRC} -o $@@.o
d144 2
a145 2
	@@echo "${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
		${AS} -o $@@"
d152 2
a153 2
	@@echo "${CPP} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} |\
	    ${AS} -o $@@"
d160 2
a161 2
	@@echo "${CPP} -DPIC ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
	    ${AS} ${ASPICFLAG} -o $@@"
a174 3
.if ${DEBUGLIBS:L} == "yes"
_LIBS+=		lib${LIB}_g.a
.endif
a195 1
	${RANLIB} lib${LIB}.a
d197 1
a202 1
	${RANLIB} lib${LIB}_g.a
d204 2
a210 1
	${RANLIB} lib${LIB}_pic.a
d220 5
d266 2
a267 14
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 lib${LIB}.a \
	    ${DESTDIR}${LIBDIR}/
.  if ${INSTALL_COPY} != "-p"
	${RANLIB} -t ${DESTDIR}${LIBDIR}/lib${LIB}.a
.  endif
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/lib${LIB}.a
.  if ${DEBUGLIBS:L} == "yes"
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 \
	    lib${LIB}_g.a ${DESTDIR}${LIBDIR}/debug/lib${LIB}.a
.    if ${INSTALL_COPY} != "-p"
	${RANLIB} -t ${DESTDIR}${LIBDIR}/debug/lib${LIB}.a
.    endif
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/debug/lib${LIB}.a
.  endif
d273 5
d287 4
d292 1
a292 1
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 \
a293 4
.    if ${INSTALL_COPY} != "-p"
	${RANLIB} -t ${DESTDIR}${LIBDIR}/lib${LIB}_pic.a
.    endif
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/lib${LIB}_pic.a
d296 1
a296 1
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
@


1.18
log
@merge OpenBSD
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.17 2005/06/14 13:47:38 tg Exp $
d33 1
a33 1
SHLIB_SONAME?=	lib${LIB}.${SHLIB_VERSION}.dylib
d36 1
a36 1
SHLIB_SONAME?=	lib${LIB}.so.${SHLIB_VERSION}
@


1.17
log
@* use ${LINKER} not ${CC} in <bsd.lib.mk>, like <bsd.prog.mk>
* set LINKER to ${CXX} if ${SRCS} contains a C++ file
  (unused within MirOS source tree though)
  XXX could we add -lobjc to LDADD if SRCS contain an ObjC/ObjC++ file?
* enable DEBUGLIBS to show off that it isn't broken ;)
* bump patchlevel
@
text
@d1 2
a2 2
# $MirOS: src/share/mk/bsd.lib.mk,v 1.16 2005/06/09 21:34:30 tg Exp $
# $OpenBSD: bsd.lib.mk,v 1.38 2004/06/22 19:50:01 pvalchev Exp $
@


1.16
log
@* move PICFLAG into new variable SHLIB_FLAGS in LINK.shlib
* if PE object format, choose random image base from 0x40000000
  (lower than these of Libtool, and 1/2 the range only)
* add LDFLAGS to SHLIB_FLAGS, which were missed before

for -static, there is still LDSTATIC not LDFLAGS, just as a reminder...
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.15 2005/05/21 14:45:16 tg Exp $
d50 6
d60 1
a60 1
LINK.shlib?=	${CC} ${CFLAGS} ${SHLIB_FLAGS} -dynamiclib \
d65 1
a65 1
LINK.shlib?=	${CC} ${CFLAGS} ${SHLIB_FLAGS} -shared \
d69 1
a69 1
LINK.shlib?=	${CC} ${CFLAGS} ${SHLIB_FLAGS} -shared \
@


1.15
log
@support GNU rtld, used by Interix and MirOS Interix
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.14 2005/04/16 21:24:06 tg Exp $
d41 6
d54 1
a54 1
LINK.shlib?=	${CC} ${CFLAGS} ${PICFLAG} -dynamiclib \
d59 1
a59 1
LINK.shlib?=	${CC} ${CFLAGS} ${PICFLAG} -shared \
d63 1
a63 1
LINK.shlib?=	${CC} ${CFLAGS} ${PICFLAG} -shared \
@


1.14
log
@I do not believe .dylib needs to be in .SUFFIXES

If you encounter any breakage this one-liner reversed would fix,
please contact me and I will work it out
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.13 2005/04/16 21:22:32 tg Exp $
d32 1
a32 1
.  if ${OBJECT_FMT} == "Mach-O"
d35 3
d47 1
a47 1
.elif ${OBJECT_FMT} == "Mach-O"
d52 4
@


1.13
log
@change order of .SUFFIXES - don't sort!
partially inspired by NetBSD(R), most by OpenBSD, final decision by me
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.12 2005/04/16 21:03:01 tg Exp $
d60 1
a60 1
.SUFFIXES:	.out .o .go .so .S .s .c .m .cc .cxx .y .l .i .ln .dylib .m4
@


1.12
log
@oops, missed a backslash
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.11 2005/04/16 20:16:43 tg Exp $
d60 1
a60 1
.SUFFIXES:	.c .cc .cxx .dylib .go .i .l .ln .m .m4 .o .out .S .s .so .y
@


1.11
log
@ease the style
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.10 2005/04/10 20:31:37 tg Exp $
d81 1
a81 1
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} 
@


1.10
log
@generalise SHLIB_LINKS
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.9 2005/04/10 20:20:22 tg Exp $
d65 2
a66 2
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} ${.IMPSRC} \
	    -o $@@.o
d73 2
a74 2
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} -g ${.IMPSRC} \
	    -o $@@.o
d81 2
a82 2
	@@${COMPILE.c} ${CFLAGS_${.TARGET:C/\.(g|s)o$/.o/}} ${PICFLAG} \
	    -DPIC ${.IMPSRC} -o $@@.o
@


1.9
log
@* add dylib support for Mach-O targets
  - dylib for Darwin from bsiegert@@
  - with fixed clean target
  - corrected build of lib${LIB}_pic.a
    (yes, they need -fno-common)
* correct indentation
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.8 2005/04/10 20:09:25 tg Exp $
a36 1
SHLIB_LINKS?=
d39 1
@


1.8
log
@* support relinking shared libraries and dependent programmes on install
  on all Mach-O systems (Darwin diffs from bsiegert@@)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.7 2005/04/10 20:04:26 tg Exp $
d32 4
d37 2
d43 6
d193 4
d211 1
a211 1
	rm -f lib${LIB}_pic.a lib${LIB}.so.*.* ${SOBJS}
d249 1
a249 1
.      if ${OBJECT_FMT} == "Mach-O"
d253 1
a253 1
.      endif
d256 6
@


1.7
log
@* unify LINK.shlib and LINK.prog
* use $@@ not ${.TARGET}
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.6 2005/04/10 20:00:51 tg Exp $
d233 5
@


1.6
log
@* modularise linking of shlib
* add .dylib to suffixes

most dylib-diffs from bsiegert@@, heavily modified
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.5 2005/04/10 19:58:08 tg Exp $
d52 1
a52 1
	    "${.IMPSRC} -o ${.TARGET}"
d54 3
a56 3
	    -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d60 1
a60 1
	    "-g ${.IMPSRC} -o ${.TARGET}"
d62 3
a64 3
	    -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d68 1
a68 1
	    "${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}"
d70 3
a72 3
	    -DPIC ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d79 1
a79 1
	    "${.IMPSRC} -o ${.TARGET}"
d81 3
a83 3
	    ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d87 1
a87 1
	    "-g ${.IMPSRC} -o ${.TARGET}"
d89 3
a91 3
	    -g ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d95 1
a95 1
	    "${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}"
d97 3
a99 3
	    ${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d103 1
a103 1
		${AS} -o ${.TARGET}"
d105 3
a107 3
	    ${AS} -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d111 1
a111 1
	    ${AS} -o ${.TARGET}"
d113 3
a115 3
	    ${AS} -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d119 1
a119 1
	    ${AS} ${ASPICFLAG} -o ${.TARGET}"
d121 3
a123 3
	    ${AS} ${ASPICFLAG} -o ${.TARGET}.o
	@@${LD} -x -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o
d180 1
a180 1
	${LINK.shlib} -o ${SHLIB_SONAME}
@


1.5
log
@* simplify lib${LIB}_pic.a logic
* if setting SHLIB_SONAME manually, take care of NOPIC!
* prepare for next updates
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.4 2005/04/10 19:54:00 tg Exp $
d37 3
d48 1
a48 1
.SUFFIXES:	.c .cc .cxx .go .i .l .ln .m .m4 .o .out .S .s .so .y
d180 1
a180 3
	${CC} -shared ${PICFLAG} \
	    -o ${SHLIB_SONAME} \
	    $$(${LORDER} ${SOBJS}|tsort -q) ${LDADD}
@


1.4
log
@* employ SHLIB_SONAME as publically visible name of the
  shared library to build and install
* slightly change rules for SHLIB_VERSION
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.3 2005/03/05 12:02:29 tg Exp $
d31 1
a31 1
.ifdef SHLIB_VERSION
d136 3
a138 1
.  ifdef SHLIB_SONAME
a139 1
.  endif
d231 4
a234 2
.  if ${NOPIC:L} == "no"
.    if !defined(SHLIB_SONAME)
d237 1
a237 1
.      if ${INSTALL_COPY} != "-p"
d239 1
a239 1
.      endif
d241 1
a241 5
.    else
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m ${LIBMODE} \
	    ${SHLIB_SONAME} ${DESTDIR}${LIBDIR}/
.    endif
.  endif  # not NOPIC
@


1.3
log
@++Objective-C;
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.lib.mk,v 1.2 2005/02/14 18:57:46 tg Exp $
d25 12
a36 2
.if defined(SHLIB_VERSION) && ${SHLIB_VERSION} == "."
.  undef SHLIB_VERSION
d136 2
a137 2
.  ifdef SHLIB_VERSION
_LIBS+=		lib${LIB}.so.${SHLIB_VERSION}
d169 2
a170 1
lib${LIB}.so.${SHLIB_VERSION}: ${SOBJS} ${CRTBEGIN} ${CRTEND} ${CRTI} ${CRTN} ${DPADD}
d172 4
a175 1
	@@rm -f lib${LIB}.so.${SHLIB_VERSION}
d177 1
a177 1
	    -o lib${LIB}.so.${SHLIB_VERSION} \
d231 1
a231 1
.    if !defined(SHLIB_VERSION)
d238 1
a238 1
.    else   # ! ndef SHLIB_VERSION
d240 2
a241 2
	    lib${LIB}.so.${SHLIB_VERSION} ${DESTDIR}${LIBDIR}/
.    endif  # ! ndef SHLIB_VERSION
@


1.2
log
@merge these from ncvs 1
@
text
@d1 1
a1 1
# $MirOS$
d35 1
a35 1
.SUFFIXES: .out .o .go .so .S .s .c .cc .C .cxx .f .y .l .ln .m4 .m
d37 1
a37 1
.c.o:
d45 1
a45 1
.c.go:
d53 1
a53 1
.c.so:
d64 1
a64 1
.cc.o .C.o .cxx.o:
d72 1
a72 1
.cc.go .C.go .cxx.go:
d80 1
a80 1
.cc.so .C.so .cxx.so:
@


1.1
log
@Initial revision
@
text
@d1 4
a4 3
#	$OpenBSD: bsd.lib.mk,v 1.38 2004/06/22 19:50:01 pvalchev Exp $
#	$NetBSD: bsd.lib.mk,v 1.67 1996/01/17 20:39:26 mycroft Exp $
#	@@(#)bsd.lib.mk	5.26 (Berkeley) 5/2/91
d6 6
a11 1
.include <bsd.own.mk>				# for 'NOPIC' definition
d14 1
a14 1
.include "${.CURDIR}/../Makefile.inc"
d17 10
a26 4
.if exists(${.CURDIR}/shlib_version)
.include "${.CURDIR}/shlib_version"
SHLIB_MAJOR=${major}
SHLIB_MINOR=${minor}
d31 1
a31 1
# prefer .S to a .c, add .po, remove stuff not used in the BSD libraries.
d35 1
a35 1
.SUFFIXES: .out .o .go .po .so .S .s .c .cc .C .cxx .f .y .l .ln .m4 .m
d38 4
a41 2
	@@echo "${COMPILE.c} ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.c} ${.IMPSRC}  -o ${.TARGET}.o
d46 4
a49 8
	@@echo "${COMPILE.c} -g ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.c} -g ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o

.c.po:
	@@echo "${COMPILE.c} -p ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.c} -p ${.IMPSRC} -o ${.TARGET}.o
d54 4
a57 2
	@@echo "${COMPILE.c} ${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.c} ${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}.o
d62 1
a62 1
	${LINT} ${LINTFLAGS} ${CFLAGS:M-[IDU]*} -i ${.IMPSRC}
d65 4
a68 2
	@@echo "${COMPILE.cc} ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.cc} ${.IMPSRC} -o ${.TARGET}.o
d73 4
a76 8
	@@echo "${COMPILE.cc} -g ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.cc} -g ${.IMPSRC} -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o

.cc.po .C.po .cxx.po:
	@@echo "${COMPILE.cc} -p ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.cc} -p ${.IMPSRC} -o ${.TARGET}.o
d81 4
a84 2
	@@echo "${COMPILE.cc} ${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}"
	@@${COMPILE.cc} ${PICFLAG} -DPIC ${.IMPSRC} -o ${.TARGET}.o
a88 4
.if (${MACHINE_ARCH} == "arm")
	@@echo ${COMPILE.S:Q} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC}
	@@${COMPILE.S} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} -o ${.TARGET}.o
.else
a92 1
.endif
a103 8
.S.po .s.po:
	@@echo "${CPP} -DPROF ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} |\
	    ${AS} -o ${.TARGET}"
	@@${CPP} -DPROF ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC} | \
	    ${AS} -o ${.TARGET}.o
	@@${LD} -X -r ${.TARGET}.o -o ${.TARGET}
	@@rm -f ${.TARGET}.o

d119 3
a121 6
_LIBS=lib${LIB}.a
.if (${DEBUGLIBS:L} == "yes")
_LIBS+=lib${LIB}_g.a
.endif
.if !defined(NOPROFILE)
_LIBS+=lib${LIB}_p.a
d124 5
a128 7
.if !defined(NOPIC)
.if (${MACHINE_ARCH} != "mips")
_LIBS+=lib${LIB}_pic.a
.endif
.if defined(SHLIB_MAJOR) && defined(SHLIB_MINOR)
_LIBS+=lib${LIB}.so.${SHLIB_MAJOR}.${SHLIB_MINOR}
.endif
d131 2
a132 2
.if !defined(NOLINT)
_LIBS+=llib-l${LIB}.ln
d137 1
a137 1
OBJS+=	${SRCS:N*.h:R:S/$/.o/g}
d142 1
a142 1
	@@${AR} cq lib${LIB}.a `${LORDER} ${OBJS} | tsort -q`
d145 1
a145 1
GOBJS+=	${OBJS:.o=.go}
d149 1
a149 1
	@@${AR} cq lib${LIB}_g.a `${LORDER} ${GOBJS} | tsort -q`
d152 1
a152 8
POBJS+=	${OBJS:.o=.po}
lib${LIB}_p.a:: ${POBJS}
	@@echo building profiled ${LIB} library
	@@rm -f lib${LIB}_p.a
	@@${AR} cq lib${LIB}_p.a `${LORDER} ${POBJS} | tsort -q`
	${RANLIB} lib${LIB}_p.a

SOBJS+=	${OBJS:.o=.so}
d156 1
a156 1
	@@${AR} cq lib${LIB}_pic.a `${LORDER} ${SOBJS} | tsort -q`
d159 3
a161 3
lib${LIB}.so.${SHLIB_MAJOR}.${SHLIB_MINOR}: ${SOBJS} ${DPADD}
	@@echo building shared ${LIB} library \(version ${SHLIB_MAJOR}.${SHLIB_MINOR}\)
	@@rm -f lib${LIB}.so.${SHLIB_MAJOR}.${SHLIB_MINOR}
d163 2
a164 2
	    -o lib${LIB}.so.${SHLIB_MAJOR}.${SHLIB_MINOR} \
	    `${LORDER} ${SOBJS}|tsort -q` ${LDADD}
d166 1
a166 1
LOBJS+=	${LSRCS:.c=.ln} ${SRCS:M*.c:.c=.ln}
d168 1
a168 1
LLIBS?=	-lc
a178 1
	rm -f lib${LIB}_p.a ${POBJS}
d187 2
a188 2
	@@(TMP=`mktemp -q /tmp/_dependXXXXXXXXXX`; \
	if [ $$? -ne 0 ]; then \
d191 3
a193 4
	fi; \
	sed -e 's/^\([^\.]*\).o[ ]*:/\1.o \1.po \1.so:/' \
	      < .depend > $$TMP; \
	mv $$TMP .depend)
d197 1
a197 1
.if !target(beforeinstall)
d199 1
a199 1
.endif
a201 1
#	ranlib lib${LIB}.a
d203 2
a204 2
	    ${DESTDIR}${LIBDIR}
.if (${INSTALL_COPY} != "-p")
d206 1
a206 1
.endif
d208 1
a208 2
.if (${DEBUGLIBS:L} == "yes")
#	ranlib lib${LIB}_g.a
d211 1
a211 1
.if (${INSTALL_COPY} != "-p")
d213 1
a213 1
.endif
d215 3
a217 3
.endif
.if !defined(NOPROFILE)
#	ranlib lib${LIB}_p.a
d219 2
a220 11
	    lib${LIB}_p.a ${DESTDIR}${LIBDIR}
.if (${INSTALL_COPY} != "-p")
	${RANLIB} -t ${DESTDIR}${LIBDIR}/lib${LIB}_p.a
.endif
	chmod ${LIBMODE} ${DESTDIR}${LIBDIR}/lib${LIB}_p.a
.endif
.if !defined(NOPIC) && (${MACHINE_ARCH} != "mips") 
#	ranlib lib${LIB}_pic.a
	${INSTALL} ${INSTALL_COPY} -o ${LIBOWN} -g ${LIBGRP} -m 600 \
	    lib${LIB}_pic.a ${DESTDIR}${LIBDIR}
.if (${INSTALL_COPY} != "-p")
d222 1
a222 1
.endif
d224 1
a224 2
.endif
.if !defined(NOPIC) && defined(SHLIB_MAJOR) && defined(SHLIB_MINOR)
d226 4
a229 3
	    lib${LIB}.so.${SHLIB_MAJOR}.${SHLIB_MINOR} ${DESTDIR}${LIBDIR}
.endif
.if !defined(NOLINT)
d231 4
a234 4
	    llib-l${LIB}.ln ${DESTDIR}${LINTLIBDIR}
.endif
.if defined(LINKS) && !empty(LINKS)
.  for lnk file in ${LINKS}
d238 3
a240 3
	 rm -f $$t; ln $$l $$t
.  endfor
.endif
d246 1
a246 1
.endif
d248 2
a249 6
.if !defined(NOMAN)
.include <bsd.man.mk>
.endif

.if !defined(NONLS)
.include <bsd.nls.mk>
d256 2
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@the dreaded importer strikes again
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lib.mk,v 1.43 2004/09/20 18:52:38 espie Exp $
d50 1
a50 1
	${LINT} ${LINTFLAGS} ${CFLAGS:M-[IDU]*} ${CPPFLAGS:M-[IDU]*} -i ${.IMPSRC}
d78 1
a78 1
	@@echo ${COMPILE.S:Q} ${CPPFLAGS} ${CFLAGS:M-[ID]*} ${AINC} ${.IMPSRC}
d129 1
a129 1
.if (${MACHINE_ARCH} != "mips64")
d242 1
a242 1
.if !defined(NOPIC) && (${MACHINE_ARCH} != "mips64") 
@

