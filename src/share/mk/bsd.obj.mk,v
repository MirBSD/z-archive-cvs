head	1.9;
access;
symbols
	MIRBSD_10:1.8.0.2
	MIRBSD_10_BASE:1.8
	MIRBSD_9_BASE:1.5
	MIRBSD_8:1.5.0.2
	MIRBSD_8_BASE:1.5
	cvs-200507211800:1.1.1.1
	cvs-200507040220:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.9
date	2008.07.11.11.33.20;	author tg;	state Exp;
branches;
next	1.8;
commitid	100487745097D203730;

1.8
date	2008.03.09.13.38.15;	author tg;	state Exp;
branches;
next	1.7;
commitid	10047D3E8594216DF54;

1.7
date	2008.02.24.11.58.08;	author tg;	state Exp;
branches;
next	1.6;
commitid	10047C15BCB43C2D6EB;

1.6
date	2006.07.30.23.21.57;	author tg;	state Exp;
branches;
next	1.5;
commitid	10044CD3F2141065FEC;

1.5
date	2005.05.06.16.57.59;	author tg;	state Exp;
branches;
next	1.4;
commitid	33c5427ba226ed11;

1.4
date	2005.05.06.16.56.30;	author tg;	state Exp;
branches;
next	1.3;
commitid	20f1427ba1cedc3d;

1.3
date	2005.02.14.19.21.20;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.02.14.18.57.46;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.27.17;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.27.17;	author tg;	state Exp;
branches;
next	;


desc
@@


1.9
log
@now that we require mksh R34+, we can use realpath builtin ipv readlink(1)
@
text
@# $MirOS: src/share/mk/bsd.obj.mk,v 1.8 2008/03/09 13:38:15 tg Exp $
# $OpenBSD: bsd.obj.mk,v 1.12 2003/10/28 17:09:33 espie Exp $
# $NetBSD: bsd.obj.mk,v 1.9 1996/04/10 21:08:05 thorpej Exp $

.if !defined(BSD_OBJ_MK)
BSD_OBJ_MK=1

.if !defined(BSD_OWN_MK)
.  include <bsd.own.mk>
.endif

.if !target(obj)
.  if ${NOOBJ:L} != "no"
obj:
.  else

.    if defined(MAKEOBJDIR) && !empty(MAKEOBJDIR)
__baseobjdir=	${MAKEOBJDIR}
.    else
__baseobjdir=	obj
.    endif

.    if defined(OBJMACHINE)
__objdir=	${__baseobjdir}.${MACHINE}
.    else
__objdir=	${__baseobjdir}
.    endif

.    if defined(USR_OBJMACHINE)
__usrobjdir!=	realpath ${BSDOBJDIR}.${MACHINE} 2>&- || \
		    print -nr -- ${BSDOBJDIR:Q}.${MACHINE:Q}
__usrobjdirpf=
.    else
__usrobjdir!=	realpath ${BSDOBJDIR} 2>&- || print -nr -- ${BSDOBJDIR:Q}
.      if defined(OBJMACHINE)
__usrobjdirpf=	.${MACHINE}
.      else
__usrobjdirpf=
.      endif
.    endif

_SUBDIRUSE:

obj! _SUBDIRUSE
	@@cd ${.CURDIR}; \
	tryobjdir=0; here=.; \
	if bsdsrcdir=$$(realpath ${BSDSRCDIR} 2>&-); then \
		here=$$(realpath .); \
		subdir=$${here#$${bsdsrcdir}/}; \
		[[ $$here = $$subdir ]] || tryobjdir=1; \
	fi; \
	if [[ $$tryobjdir = 1 ]]; then \
		dest=${__usrobjdir}/$$subdir${__usrobjdirpf}; \
		print -r "$$here/${__objdir} -> $$dest"; \
		if [[ ! -L ${__objdir} \
		    || $$(readlink ${__objdir}) != $$dest ]]; then \
			[[ ! -e ${__objdir} ]] || rm -rf ${__objdir}; \
			ln -sf $$dest ${__objdir}; \
		fi; \
		[[ ! -d ${__usrobjdir} || -d $$dest ]] || mkdir -p $$dest; \
	elif [[ ! -d ${__objdir} ]]; then \
		print -r "making $$here/${__objdir}"; \
		mkdir ${__objdir}; \
	fi
.  endif
.endif	# ! not target obj

.endif
@


1.8
log
@cosmetics (for portable mirmake)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.7 2008/02/24 11:58:08 tg Exp $
d30 1
a30 1
__usrobjdir!=	readlink -nf ${BSDOBJDIR}.${MACHINE} 2>&- || \
d34 1
a34 1
__usrobjdir!=	readlink -nf ${BSDOBJDIR} 2>&- || print -nr -- ${BSDOBJDIR:Q}
d47 2
a48 2
	if bsdsrcdir=$$(readlink -nf ${BSDSRCDIR} 2>&-); then \
		here=$$(readlink -nf .); \
@


1.7
log
@fix the already long known cases of brokenness (or at least superfluous
warnings) when ${BSDSRCDIR} and/or ${BSDOBJDIR} donâ€™t exist
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.6 2006/07/30 23:21:57 tg Exp $
d46 1
a46 1
	tryobjdir=0; \
@


1.6
log
@ENOENT of BSDOBJDIR is non-fatal here
(seen on Debian)
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.5 2005/05/06 16:57:59 tg Exp $
d30 2
a31 2
__usrobjdir!=	readlink -nf ${BSDOBJDIR}.${MACHINE} || \
		    echo ${BSDOBJDIR:Q}.${MACHINE:Q}
d34 1
a34 1
__usrobjdir!=	readlink -nf ${BSDOBJDIR} || echo ${BSDOBJDIR:Q}
d45 8
a52 4
	@@cd ${.CURDIR}; here=$$(readlink -nf .); \
	bsdsrcdir=$$(readlink -nf ${BSDSRCDIR}); \
	subdir=$${here#$${bsdsrcdir}/}; \
	if [[ $$here != $$subdir ]]; then \
@


1.5
log
@this teaches me again: test before commit
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.4 2005/05/06 16:56:30 tg Exp $
d30 2
a31 1
__usrobjdir!=	readlink -nf ${BSDOBJDIR}.${MACHINE}
d34 1
a34 1
__usrobjdir!=	readlink -nf ${BSDOBJDIR}
@


1.4
log
@use shellish realpath; optimise
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.3 2005/02/14 19:21:20 tg Exp $
d33 1
a33 1
__usrobjdir=	readlink -nf ${BSDOBJDIR}
@


1.3
log
@all:		optimise a bit
obj/subdir:	rewrite using mksh features
@
text
@d1 1
a1 1
# $MirOS: src/share/mk/bsd.obj.mk,v 1.2 2005/02/14 18:57:46 tg Exp $
d30 1
a30 1
__usrobjdir=	${BSDOBJDIR}.${MACHINE}
d33 1
a33 1
__usrobjdir=	${BSDOBJDIR}
d44 2
a45 3
	@@cd ${.CURDIR}; here=$$(/bin/pwd); \
	bsdsrcdir=$$( (cd ${BSDSRCDIR} && /bin/pwd) 2>/dev/null \
	    || print '${BSDSRCDIR}'); \
d55 4
a58 11
		if [[ -d ${__usrobjdir} && ! -d $$dest ]]; then \
			mkdir -p $$dest; \
		else \
			true; \
		fi; \
	else \
		if [[ ! -d ${__objdir} ]]; then \
			dest=$$here/${__objdir}; \
			print -r "making $$dest"; \
			mkdir $$dest; \
		fi; \
@


1.2
log
@merge these from ncvs 1
@
text
@d1 1
a1 1
# $MirOS$
d44 3
a46 3
	@@cd ${.CURDIR}; \
	here=$$(/bin/pwd); bsdsrcdir=$$( (cd ${BSDSRCDIR} && /bin/pwd) \
	    2>/dev/null || print '${BSDSRCDIR}'); \
d48 6
a53 7
	if test $$here != $$subdir ; then \
		dest=${__usrobjdir}/$$subdir${__usrobjdirpf} ; \
		echo "$$here/${__objdir} -> $$dest"; \
		if test ! -L ${__objdir} -o \
		    X$$(readlink ${__objdir}) != X$$dest; \
		    then \
			if test -e ${__objdir}; then rm -rf ${__objdir}; fi; \
d56 1
a56 1
		if test -d ${__usrobjdir} -a ! -d $$dest; then \
d62 3
a64 4
		true ; \
		dest=$$here/${__objdir} ; \
		if test ! -d ${__objdir} ; then \
			echo "making $$dest" ; \
d66 2
a67 2
		fi ; \
	fi;
@


1.1
log
@Initial revision
@
text
@d1 10
a10 2
#	$OpenBSD: bsd.obj.mk,v 1.12 2003/10/28 17:09:33 espie Exp $
#	$NetBSD: bsd.obj.mk,v 1.9 1996/04/10 21:08:05 thorpej Exp $
d13 1
a13 1
.  if defined(NOOBJ)
d17 1
a17 1
.  if defined(MAKEOBJDIR)
d19 1
a19 1
.  else
d21 1
a21 1
.  endif
d23 1
a23 1
.  if defined(OBJMACHINE)
d25 1
a25 1
.  else
d27 1
a27 1
.  endif
d29 1
a29 1
.  if defined(USR_OBJMACHINE)
d31 2
a32 2
__usrobjdirpf=	
.  else
d34 1
a34 1
.    if defined(OBJMACHINE)
d36 1
a36 1
.    else
d38 1
a39 1
.  endif
d45 2
a46 1
	here=`/bin/pwd`; bsdsrcdir=`cd ${BSDSRCDIR}; /bin/pwd`; \
d52 1
a52 1
		    X`readlink ${__objdir}` != X$$dest; \
d71 2
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@
