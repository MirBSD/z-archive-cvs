head	1.10;
access;
symbols
	tg-beforemerge-ksrc10:1.1.1.2
	MIRBSD_10:1.7.0.2
	MIRBSD_10_BASE:1.7
	MIRBSD_9_BASE:1.5
	MIRBSD_8:1.3.0.2
	MIRBSD_8_BASE:1.3
	openbsd:1.1.1;
locks; strict;
comment	@ * @;


1.10
date	2014.01.11.18.16.17;	author tg;	state dead;
branches;
next	1.9;
commitid	10052D18A8038CC3F4D;

1.9
date	2010.09.19.18.55.41;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004C965C8F46717878;

1.8
date	2008.09.06.22.21.03;	author tg;	state Exp;
branches;
next	1.7;
commitid	10048C3024808C8EDD3;

1.7
date	2007.09.28.18.44.00;	author tg;	state Exp;
branches;
next	1.6;
commitid	10046FD4B7B40BB609F;

1.6
date	2007.03.13.00.35.59;	author tg;	state Exp;
branches;
next	1.5;
commitid	10045F5F20649A9FC58;

1.5
date	2006.05.28.13.19.13;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004479A3517746A8D0;

1.4
date	2006.02.23.01.18.20;	author tg;	state Exp;
branches;
next	1.3;
commitid	10043FD0CF30CCBD1F1;

1.3
date	2005.12.17.05.46.26;	author tg;	state Exp;
branches
	1.3.2.1;
next	1.2;
commitid	10043A3A3E65E20A413;

1.2
date	2005.03.06.21.28.05;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.28.55;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.3.2.1
date	2006.02.25.23.08.11;	author tg;	state Exp;
branches;
next	;
commitid	1004400E3661124ABDF;

1.1.1.1
date	2005.02.05.17.28.55;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.07.21.21.39.52;	author tg;	state Exp;
branches;
next	;
commitid	5f0d42e015f52f66;


desc
@@


1.10
log
@there is precisely zero reason to use random()/srandom() even in the kernel (since we initialise arc4random statically)
@
text
@/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.9 2010/09/19 18:55:41 tg Exp $ */

/*-
 * Copyright (c) 2007, 2010
 *	Thorsten Glaser <tg@@mirbsd.de>
 *
 * Provided that these terms and disclaimer and all copyright notices
 * are retained or reproduced in an accompanying document, permission
 * is granted to deal in this work without restriction, including un-
 * limited rights to use, publicly perform, distribute, sell, modify,
 * merge, give away, or sublicence.
 *
 * This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
 * the utmost extent permitted by applicable law, neither express nor
 * implied; without malicious intent or gross negligence. In no event
 * may a licensor, author or contributor be held liable for indirect,
 * direct, other damage, loss, or other issues arising in any way out
 * of dealing in the work, even if advised of the possibility of such
 * damage or existence of a defect, except proven that it results out
 * of said person's immediate fault when using the work as intended.
 */

#include <sys/systm.h>
#include <crypto/randimpl.h>

extern uint32_t _randseed;

void
srandom(u_long val)
{
	struct {
		u_long ov, nv;
	} x;

	x.ov = _randseed;
	x.nv = val;
	RNDEBUG(RD_SRANDOM, "srandom: %lu -> %lu\n", x.ov, x.nv);
	rnd_lopool_add(&x, sizeof(x));

	_randseed = val & 0x7FFFFFFF;
}
@


1.9
log
@the promised new RNG (play with RNDEBUG in crypto/randimpl.h to make
it verbose; I did, for a while and a bit of fine-tuning)
@
text
@d1 1
a1 1
/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.8 2008/09/06 22:21:03 tg Exp $ */
@


1.8
log
@move lib/libkern/libkern.h to sys/slibkern.h where it gets installed,
since other installed headers reference it (e.g. for building LKMs)
@
text
@d1 1
a1 1
/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.7 2007/09/28 18:44:00 tg Exp $ */
d4 1
a4 1
 * Copyright (c) 2007
d23 2
a24 1
#include <sys/slibkern.h>
d31 8
a38 1
	uint32_t tmp = _randseed;
a40 6
	tmp += val >> 31;
	while (tmp) {
		if (tmp & 1)
			random();
		tmp >>= 1;
	}
@


1.7
log
@• srandom.c: fix a calculation error
• init_main.c: add homepage
@
text
@d1 1
a1 1
/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.6 2007/03/13 00:35:59 tg Exp $ */
d23 1
a23 1
#include <lib/libkern/libkern.h>
@


1.6
log
@simplify
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $ */
d25 1
a25 1
extern u_long _randseed;
d30 1
a30 1
	u_long tmp = _randseed;
d33 1
a33 1
	tmp += val >> 30;
@


1.5
log
@* randomwrite() is always called after attach
* speed up srandom
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.7 2006/04/09 22:08:49 tg Rel $ */
d4 1
a4 1
 * Copyright (c) 2006
d7 5
a11 6
 * Licensee is hereby permitted to deal in this work without restric-
 * tion, including unlimited rights to use, publicly perform, modify,
 * merge, distribute, sell, give away or sublicence, provided all co-
 * pyright notices above, these terms and the disclaimer are retained
 * in all redistributions or reproduced in accompanying documentation
 * or other materials provided with binary redistributions.
d13 8
a20 10
 * Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
 * express, or implied, to the maximum extent permitted by applicable
 * law, without malicious intent or gross negligence; in no event may
 * licensor, an author or contributor be held liable for any indirect
 * or other damage, or direct damage except proven a consequence of a
 * direct error of said person and intended use of this work, loss or
 * other issues arising in any way out of its use, even if advised of
 * the possibility of such damage or existence of a nontrivial bug.
 *-
 * Reinitialise the 31-bit PRNG but retain a little state information
a22 1
#include <sys/types.h>
d28 1
a28 1
srandom(u_long newseed)
d30 1
a30 1
	u_long t = _randseed;
d32 6
a37 10
	_randseed ^= newseed;
	while (_randseed & ~0x7FFFFFFF)
		_randseed = (_randseed >> 31) + (_randseed & 0x7FFFFFFF);

	t ^= (random() << 1) | (random() & 1);
	_randseed = newseed & 0x7FFFFFFF;

	while (t) {
		random();
		t >>= 1;
@


1.4
log
@* make arc4maybeinit static
* initialise PRNG a little bit earlier
* always carry over a few old PRNG (random()) bits
* fix comments, update licence year
* improve srandom() logic
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.6 2006/01/24 22:24:02 tg Rel $ */
d4 1
a4 1
 * Copyright (c) 2003, 2006
d23 1
a23 3
 * Quick-Seed the pseudo-random number generator.
 * Here is no simple "let" operation, but an xor and rotation ops, so
 * nobody knows the exact state of the seed after this operation.
d27 1
a30 3
void	srandom(u_long);
u_long	random(void);

d32 1
a32 1
srandom(u_long seed)
d34 8
a41 1
	u_long s1, s2;
d43 1
a43 5
	s1 = (_randseed & 0xFF) << 24;
	s2 = s1 + (_randseed & 0xFFFFFF) + (seed & 0x0F);
	s1 = s2 ^ (seed & 0x000FFFF0);
	seed >>= 20;
	while (seed) {
d45 1
a45 3
		if (seed & 1)
			random();
		seed >>= 1;
a46 5
	s2 = (s1 & 0x7F) << 24;
	s1 = (s1 & 0xFFFFFF80) >> 7;
	_randseed ^= (s1 & 0x01FFFFFF);
	random();
	_randseed = (_randseed ^ s2) & 0x7FFFFFFF;
@


1.3
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d1 1
a1 1
/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.2 2005/03/06 21:28:05 tg Exp $ */
d4 2
a5 2
 * Copyright (c) 2003
 *	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d52 3
a54 3
	_randseed = (s1 & 0x01FFFFFF);
	s1 = random();
	_randseed = s1 ^ s2;
@


1.3.2.1
log
@MFC some of the recent randomness fixes

ok bsiegert@@
@
text
@d1 1
a1 1
/* $MirOS: src/sys/lib/libkern/srandom.c,v 1.4 2006/02/23 01:18:20 tg Exp $ */
d4 2
a5 2
 * Copyright (c) 2003, 2006
 *	Thorsten Glaser <tg@@mirbsd.de>
d52 3
a54 3
	_randseed ^= (s1 & 0x01FFFFFF);
	random();
	_randseed = (_randseed ^ s2) & 0x7FFFFFFF;
@


1.2
log
@* merge src/sys/
  (at least the better part of it)
* revert IPv6 networking to OpenBSD, since
  I didn't get IPV4_MAPPED addresses working :(
@
text
@d1 1
a1 1
/* $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $ */
d14 8
a21 7
 * Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
 * any kind, expressed or implied, to the maximum extent permitted by
 * applicable law, but with the warranty of being written without ma-
 * licious intent or gross negligence; in no event shall licensor, an
 * author or contributor be held liable for any damage, direct, indi-
 * rect or other, however caused, arising in any way out of the usage
 * of this work, even if advised of the possibility of such damage.
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
/*	$OpenBSD: srandom.c,v 1.3 2003/06/02 23:28:08 millert Exp $	*/
d4 2
a5 2
 * Copyright (c) 1992, 1993
 *	The Regents of the University of California.  All rights reserved.
d7 6
a12 11
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
d14 11
a24 13
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)random.c	8.1 (Berkeley) 6/10/93
d29 1
a29 1
#include <lib/libkern/libkern.h>
d31 2
a32 1
extern u_long _randseed;
d35 1
a35 2
srandom(seed)
	u_long seed;
d37 17
a53 1
	_randseed = seed;
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@merge more OpenBSD-HEAD stuff
@
text
@d1 1
a1 1
/*	$OpenBSD: srandom.c,v 1.4 2004/08/07 00:38:33 deraadt Exp $	*/
d41 2
a42 1
srandom(u_long seed)
@

