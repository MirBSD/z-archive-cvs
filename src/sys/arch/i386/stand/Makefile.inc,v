head	1.25;
access;
symbols
	tg-use_ldscript:1.24.0.2
	tg-beforemerge-ksrc10:1.1.1.3
	cvs-200808011000:1.1.1.3
	MIRBSD_10:1.12.0.2
	MIRBSD_10_BASE:1.12
	MIRBSD_9_BASE:1.8
	MIRBSD_8:1.8.0.2
	MIRBSD_8_BASE:1.8
	cvs-200507032030:1.1.1.2
	cvs-200505050030:1.1.1.2
	cvs-200504291700:1.1.1.2
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.25
date	2011.11.21.09.39.33;	author tg;	state Exp;
branches;
next	1.24;
commitid	1004ECA1C6A707CCC70;

1.24
date	2009.01.12.17.39.42;	author tg;	state Exp;
branches
	1.24.2.1;
next	1.23;
commitid	100496B80717A35DB66;

1.23
date	2009.01.10.13.41.17;	author tg;	state Exp;
branches;
next	1.22;
commitid	1004968A59443A02B58;

1.22
date	2009.01.10.13.26.49;	author tg;	state Exp;
branches;
next	1.21;
commitid	1004968A22E4B123344;

1.21
date	2009.01.10.11.58.00;	author tg;	state Exp;
branches;
next	1.20;
commitid	10049688D4C6703171F;

1.20
date	2008.08.03.21.02.03;	author tg;	state Exp;
branches;
next	1.19;
commitid	10048961CCE67B72AC5;

1.19
date	2008.08.02.16.59.22;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004894927E10CB8BAD;

1.18
date	2008.08.01.23.20.18;	author tg;	state Exp;
branches;
next	1.17;
commitid	10048939A430F923D5C;

1.17
date	2008.08.01.15.43.45;	author tg;	state Exp;
branches;
next	1.16;
commitid	10048932F424C3503E1;

1.16
date	2008.08.01.12.39.07;	author tg;	state Exp;
branches;
next	1.15;
commitid	100489303F432B4030A;

1.15
date	2008.08.01.12.21.34;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004892FFDF555A3FEA;

1.14
date	2008.08.01.11.56.55;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004892FA125E1A3A84;

1.13
date	2008.08.01.11.24.58;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004892F2924667C00D;

1.12
date	2007.05.24.21.03.52;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004655FDBB3A9243EA;

1.11
date	2007.02.08.07.42.10;	author tg;	state Exp;
branches;
next	1.10;
commitid	10045CAD464729BE439;

1.10
date	2007.01.26.19.33.11;	author tg;	state Exp;
branches;
next	1.9;
commitid	10045BA577D1DF64163;

1.9
date	2006.10.15.01.35.53;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004531907179DB61BE;

1.8
date	2005.12.05.16.59.02;	author tg;	state Exp;
branches;
next	1.7;
commitid	5aa4394719d2b24;

1.7
date	2005.12.04.17.50.20;	author tg;	state Exp;
branches;
next	1.6;
commitid	7a7843932c649625;

1.6
date	2005.10.20.12.47.50;	author tg;	state Exp;
branches;
next	1.5;
commitid	353f43579208719c;

1.5
date	2005.10.17.19.18.03;	author tg;	state Exp;
branches;
next	1.4;
commitid	a2b4353f8fd2ecb;

1.4
date	2005.04.29.18.34.57;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.14.22.12.38;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.06.21.27.02;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.27.28;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.24.2.1
date	2009.10.27.15.10.49;	author tg;	state Exp;
branches;
next	;
commitid	1004AE70D6303F6EF50;

1.1.1.1
date	2005.02.05.17.27.28;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2005.04.29.17.05.46;	author tg;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2008.08.01.10.28.37;	author tg;	state Exp;
branches;
next	;
commitid	1004892E54805BE97AB;


desc
@@


1.25
log
@fix bootloder vs. mirtime
@
text
@# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.24 2009/01/12 17:39:42 tg Exp $
# $OpenBSD: Makefile.inc,v 1.40 2007/11/26 10:26:02 deraadt Exp $

.ifndef MODSRC_SYS_ARCH_I386_STAND_MAKEFILE_INC
MODSRC_SYS_ARCH_I386_STAND_MAKEFILE_INC=1

.include <bsd.own.mk>

REAL_V!=	print '\#include <sys/param.h>\nMirBSD' | ${CC} -E - \
		    | tail -1 | sed s,0x,,
V?=		${REAL_V}
_V=		"${V}"

KERNBASE?=	$S/../kern
HOSTCFLAGS:=	${CFLAGS} ${COPTS}
COPTS+=		-fno-stack-protector -ffreestanding -Wall -Wno-packed -Os \
		-mpreferred-stack-boundary=2 -falign-functions=1 ${DEBUG} \
		-falign-jumps=1 -falign-loops=1 -fno-omit-frame-pointer
HOSTCPPFLAGS:=	${CPPFLAGS}
CPPFLAGS+=	-I${S} -I${SADIR}/libsa -I. -I${KERNBASE}/include \
		-I${.CURDIR} -D__BOOT_VER=${_V:Q}
SACFLAGS=	-D_STANDALONE
DEBUGFLAGS=
# DEBUGFLAGS+=-DDEBUG
# DEBUGFLAGS+=-DGIDT_DEBUG
# DEBUGFLAGS+=-DBIOS_DEBUG
# DEBUGFLAGS+=-DEXEC_DEBUG
# DEBUGFLAGS+=-DALLOC_TRACE
# DEBUGFLAGS+=-DUNIX_DEBUG
# DEBUGFLAGS+=-DBOOTP_DEBUG -DNETIF_DEBUG -DETHER_DEBUG
# DEBUGFLAGS+=-DNFS_DEBUG -DRPC_DEBUG -DRARP_DEBUG
CPPFLAGS+=	-DSA_LINKADDR=0x40000 -DSA_LINKSEG=0x4000
BOOTLDFLAGS=	-nostdlib -Bstatic --no-undefined \
		-Ttext 0x40000 -N -noinhibit-exec
HEAP_LIMIT=	0x90000
BOOTREL=	0x60000

CLEANFILES+=	machine

SACFLAGS+=	-nostdinc -fno-builtin -fpack-struct

.if !make(libdep) && !make(sadep) && !make(salibdir) && !make(kernlibdir) && !make(obj)
.BEGIN:
	@@([ X$(S) = X -o -h machine ] || ln -s $(S)/arch/i386/include machine)
.endif


.if exists(${SADIR}/etc/assym.h)
CPPFLAGS+=	-I${SADIR}/etc
.else
CPPFLAGS+=	-I${SADIR}/etc/${__objdir}
.endif
.if exists(${SADIR}/libsa/libsa.a)
DLIBSA=		${SADIR}/libsa/libsa.a
LLIBSA=		-L${SADIR}/libsa -lsa
.else
DLIBSA=		${SADIR}/libsa/${__objdir}/libsa.a
LLIBSA=		-L${SADIR}/libsa/${__objdir} -lsa
.endif

# NO_NET=no_net
BINDIR=		/usr/mdec

prereq: .NOTMAIN
# empty

.PHONY: prereq

.endif
@


1.24
log
@use CFLAGS from diet
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.23 2009/01/10 13:41:17 tg Exp $
d20 1
a20 1
CPPFLAGS+=	-I${S} -I${SADIR}/libsa -I. \
@


1.24.2.1
log
@attempt to move *all* of .bss to 3000:0000h and up
(when loaded via gPXE+PXELINUX, fighting memory corruption?)

XXX we *really* need a position-independent or relocatable boot
XXX loader; sadly, gcc’s idea of PIC/PIE cannot be of any help…
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.24 2009/01/12 17:39:42 tg Exp $
d34 1
a34 1
		-T ${S}/arch/${MACHINE_ARCH}/stand/boot/loader.ld
d36 1
@


1.23
log
@new memory layout, part 1
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.22 2009/01/10 13:26:49 tg Exp $
d16 3
a18 9
COPTS+=		-fno-stack-protector -ffreestanding -Wall -Wno-packed \
		-fno-align-loops -fno-align-jumps -fno-omit-frame-pointer \
		-Werror ${DEBUG}
.if ${COPTS:M-O*:N-Os}
COPTS+=		-Os
.endif
.if !${COPTS:M-Os}
COPTS+=		-Os
.endif
@


1.22
log
@SA_LOADADDR is dead
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.21 2009/01/10 11:58:00 tg Exp $
d38 3
a40 2
M_LINKADDR=	0x40120
CPPFLAGS+=	-DSA_LINKADDR=${M_LINKADDR} -DSA_LINKSEG=${M_LINKADDR:S/0$//}
@


1.21
log
@LINKADDR, LINKSEG, LOADADDR, LOADSEG, SA_{LINK,LOAD}{ADDR,SEG} cleanup
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.20 2008/08/03 21:02:03 tg Exp $
a38 1
M_LOADADDR=	0x40000
a39 1
CPPFLAGS+=	-DSA_LOADADDR=${M_LOADADDR} -DSA_LOADSEG=${M_LOADADDR:S/0$//}
@


1.20
log
@Hacked in the train to Zwitserland:

• new: memcpy()=bcopy()=memmove()
• new macro: __strong_alias (incidentally, TNF has exactly the same name
  and exactly (except an ‘a’ more) the same implementation)
• use __strong_alias and #ifdef lint instead of duplicate code via unifdef
  abuse
• sprinkle a few uses of _ALIGN_TEXT
• remove duplicate memmove, memcpy, bcopy and ovbcopy implementations
  from the i386 kernel
• _ALIGN_TEXT is a nop #ifdef SMALL
• remove more duplicate definitions, etc.
• remove more dead code from bootloader -D_TEST
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.19 2008/08/02 16:59:22 tg Exp $
d38 4
a41 2
LINKADDR=	0x40120
LOADADDR=	0x40000
a43 4
LINKSEG=	${LINKADDR:S/0$//}
LOADSEG=	${LOADADDR:S/0$//}
CPPFLAGS+=	-DSA_LINKSEG=${LINKSEG} -DSA_LOADSEG=${LOADSEG}
CPPFLAGS+=	-DSA_LINKADDR=${LINKADDR} -DSA_LOADADDR=${LOADADDR}
@


1.19
log
@remaining fixes
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.18 2008/08/01 23:20:18 tg Exp $
d26 1
a26 1
CPPFLAGS+=	-I${S} -I${SADIR}/libsa -I. -Dmemmove=memcpy \
a49 1
#SACFLAGS+=	-Dmemcmp=__builtin_memcmp -Dmemset=__builtin_memset
@


1.18
log
@I hope “-Dmemcmp=__builtin_memcmp -Dmemset=__builtin_memset” is redundant…
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.17 2008/08/01 15:43:45 tg Exp $
d11 1
a11 1
V?=		${REAL_V}p1
@


1.17
log
@switch i386 bootloader to kern zlib
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.16 2008/08/01 12:39:07 tg Exp $
d50 1
a50 1
SACFLAGS+=	-Dmemcmp=__builtin_memcmp -Dmemset=__builtin_memset
@


1.16
log
@remove unused code (for testing the bootloader on unix)
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.15 2008/08/01 12:21:34 tg Exp $
d15 1
d25 1
d27 1
a27 1
		-I${.CURDIR} -D__BOOT_VER=${_V:Q} -I${KERNBASE}/include
a69 7
.if exists(${SADIR}/libz/libz.a)
DLIBZ=		${SADIR}/libz/libz.a
LLIBZ=		-L${SADIR}/libz -lz
.else
DLIBZ=		${SADIR}/libz/${__objdir}/libz.a
LLIBZ=		-L${SADIR}/libz/${__objdir} -lz
.endif
@


1.15
log
@oops
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.14 2008/08/01 11:56:55 tg Exp $
a32 1
# DEBUGFLAGS+=-g -D_TEST
a46 1
.if empty(DEBUGFLAGS:M-D_TEST)
a48 1
.endif
@


1.14
log
@patchlevel for bootloader, since we do not bump in <sys/param.h> yet
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.13 2008/08/01 11:24:58 tg Exp $
d11 2
a12 2
V?=		${REAL_V}
_V=		\"${V}\"
d25 1
a25 1
		-I${.CURDIR} -D__BOOT_VER="${_V}p1" -I${KERNBASE}/include
@


1.13
log
@merge and reduce diff to obsd
XXX not yet tested
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.12 2007/05/24 21:03:52 tg Exp $
d25 1
a25 1
		-I${.CURDIR} -D__BOOT_VER="${_V}" -I${KERNBASE}/include
@


1.12
log
@maybe optimise for size: don't use /path/to/libfoo.a but -L/path/to -lfoo
@
text
@d1 2
a2 2
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.11 2007/02/08 07:42:10 tg Exp $
# $OpenBSD: Makefile.inc,v 1.36 2004/07/24 17:39:27 millert Exp $
d24 1
a24 1
CPPFLAGS+=	-I${S} -I${SADIR}/libsa -I. -Dmemmove=memcpy -Derrno=errno \
@


1.11
log
@include path issues
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.10 2007/01/26 19:33:11 tg Exp $
d65 2
a66 1
LIBSA=		${SADIR}/libsa/libsa.a
d68 2
a69 1
LIBSA=		${SADIR}/libsa/${__objdir}/libsa.a
d72 2
a73 1
LIBZ=		${SADIR}/libz/libz.a
d75 2
a76 1
LIBZ=		${SADIR}/libz/${__objdir}/libz.a
@


1.10
log
@same -Os handling: default to it, but don't overly add it
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.9 2006/10/15 01:35:53 tg Exp $
d14 1
d24 2
a25 2
CPPFLAGS+=	-I${S} -I${SADIR}/libsa -I. -Dmemmove=memcpy \
		-I${.CURDIR} -D__BOOT_VER="${_V}" -Derrno=errno
@


1.9
log
@* add -fno-omit-frame-pointer to boot blocks too -> unbreaks
* add COPTS and CFLAGS and CPPFLAGS correctly and in correct order
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.8 2005/12/05 16:59:02 tg Exp $
d14 1
a14 1
COPTS+=		-fno-stack-protector -ffreestanding -Wall -Wno-packed -Os \
d17 6
@


1.8
log
@build extra small kernel and bootloader (no align loops/jumps)
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.7 2005/12/04 17:50:20 tg Exp $
d14 3
a16 2
CFLAGS+=	-fno-stack-protector -ffreestanding -Wall -Wno-packed \
		-Os -fno-align-loops -fno-align-jumps -Werror ${DEBUG}
@


1.7
log
@make make include include under systrace
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.6 2005/10/20 12:47:50 tg Exp $
d14 2
a15 2
CFLAGS+=	-fno-stack-protector -ffreestanding \
		-Os -Wall -Werror -Wno-packed ${DEBUG}
@


1.6
log
@fix up DEBUGLIBS and DEBUGPROGS
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.5 2005/10/17 19:18:03 tg Exp $
d70 5
@


1.5
log
@no DEBUG* here!
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.4 2005/04/29 18:34:57 tg Exp $
a12 2
DEBUGLIBS=	No
DEBUGPROGS=	No
a18 1
DEBUGLIBS=	no
@


1.4
log
@(tentative) merge, more to come
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.3 2005/03/14 22:12:38 tg Exp $
d13 2
@


1.3
log
@move MBR loader and bootmanager here from sbin
doesn't belong there after all
@
text
@d1 2
a2 2
# $MirOS: src/sys/arch/i386/stand/Makefile.inc,v 1.2 2005/03/06 21:27:02 tg Exp $
# $OpenBSD: Makefile.inc,v 1.35 2004/07/13 21:03:38 marc Exp $
d48 1
a48 1
	@@([ X$(S) == X -o -h machine ] || ln -s $(S)/arch/i386/include machine)
@


1.2
log
@* merge src/sys/
  (at least the better part of it)
* revert IPv6 networking to OpenBSD, since
  I didn't get IPV4_MAPPED addresses working :(
@
text
@d1 1
a1 1
# $MirOS$
d9 1
a9 1
V!=		print '\#include <sys/param.h>\nMirBSD' | ${CC} -E - \
d11 1
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile.inc,v 1.35 2004/07/13 21:03:38 marc Exp $
d4 15
a18 5
CFLAGS=${DEBUG} ${COPTS} -Os -Wall -Werror
CFLAGS+=	-fno-stack-protector
CPPFLAGS+=-I${S} -I${SADIR}/libsa -I. -I${.CURDIR} -Derrno=errno
SACFLAGS=-D_STANDALONE
DEBUGLIBS=no
d29 9
a37 6
LINKADDR=0x40120
LOADADDR=0x40000
HEAP_LIMIT=0x90000
BOOTREL=0x60000
BOOTMAGIC=0xc001d00d
#ROM_SIZE=32768
d41 2
a42 1
SACFLAGS+=-nostdinc -fno-builtin -fpack-struct
d52 1
a52 1
CPPFLAGS+=-I${SADIR}/etc
d54 1
a54 1
CPPFLAGS+=-I${SADIR}/etc/${__objdir}
d57 1
a57 1
LIBSA=${SADIR}/libsa/libsa.a
d59 1
a59 1
LIBSA=${SADIR}/libsa/${__objdir}/libsa.a
d62 1
a62 1
LIBZ=${SADIR}/libz/libz.a
d64 1
a64 1
LIBZ=${SADIR}/libz/${__objdir}/libz.a
d68 1
a68 1
BINDIR=	/usr/mdec
d70 1
a70 1
MANSUBDIR=i386
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@improve my Frankenstein OS (*wink* you know who you are) further
sans wchar_t of course

this is the essence of reading >1200 commit messages which suck
due to not having the new format of ours...
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.inc,v 1.36 2004/07/24 17:39:27 millert Exp $
d32 1
a32 1
	@@([ X$(S) = X -o -h machine ] || ln -s $(S)/arch/i386/include machine)
@


1.1.1.3
log
@import bootloader-related pieces from openbsd, as first part of the
aspired 4.4 merge… and something else
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.inc,v 1.40 2007/11/26 10:26:02 deraadt Exp $
d5 1
a5 1
CPPFLAGS+=-I${S} -I${SADIR}/libsa -I. -I${.CURDIR}
d30 1
a30 1
.if !make(libdep) && !make(sadep) && !make(salibdir) && !make(obj)
@


