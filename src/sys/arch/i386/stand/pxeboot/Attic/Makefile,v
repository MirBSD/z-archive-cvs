head	1.13;
access;
symbols
	tg-beforemerge-ksrc10:1.1.1.2
	cvs-200808011000:1.1.1.2
	MIRBSD_10:1.7.0.2
	MIRBSD_10_BASE:1.7
	MIRBSD_9_BASE:1.4
	MIRBSD_8:1.3.0.2
	MIRBSD_8_BASE:1.3
	cvs-200507032030:1.1.1.1
	cvs-200505050030:1.1.1.1
	cvs-200504291700:1.1.1.1
	openbsd:1.1.1;
locks; strict;
comment	@# @;


1.13
date	2009.01.11.15.34.45;	author tg;	state dead;
branches;
next	1.12;
commitid	100496A119B31D04903;

1.12
date	2009.01.10.18.31.11;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004968E98600584814;

1.11
date	2009.01.10.13.41.19;	author tg;	state Exp;
branches;
next	1.10;
commitid	1004968A59443A02B58;

1.10
date	2009.01.10.11.58.01;	author tg;	state Exp;
branches;
next	1.9;
commitid	10049688D4C6703171F;

1.9
date	2008.08.01.15.43.46;	author tg;	state Exp;
branches;
next	1.8;
commitid	10048932F424C3503E1;

1.8
date	2008.08.01.11.25.01;	author tg;	state Exp;
branches;
next	1.7;
commitid	1004892F2924667C00D;

1.7
date	2007.05.24.21.03.53;	author tg;	state Exp;
branches;
next	1.6;
commitid	1004655FDBB3A9243EA;

1.6
date	2006.10.15.01.35.54;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004531907179DB61BE;

1.5
date	2006.06.30.23.18.05;	author tg;	state Exp;
branches;
next	1.4;
commitid	10044A5B12A66F53B0F;

1.4
date	2006.06.15.18.25.16;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004491A61A59C31B19;

1.3
date	2005.10.20.12.47.54;	author tg;	state Exp;
branches;
next	1.2;
commitid	353f43579208719c;

1.2
date	2005.03.06.21.27.09;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.02.05.17.27.29;	author tg;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.02.05.17.27.29;	author tg;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2008.08.01.10.28.38;	author tg;	state Exp;
branches;
next	;
commitid	1004892E54805BE97AB;


desc
@@


1.13
log
@nuke some of the pxeboot remnants
• net.c is needed (and included)
• pxeboot.8 and boot.8 need to be merged some time, later…
@
text
@# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.12 2009/01/10 18:31:11 tg Exp $
# $OpenBSD: Makefile,v 1.3 2007/11/25 18:25:32 deraadt Exp $

.include "${.CURDIR}/../Makefile.inc"

S=${.CURDIR}/../../../..
SADIR=${.CURDIR}/..

.include "${KERNBASE}/Makefile.inc"

CPPFLAGS+=	${DEBUGFLAGS} \
		-D__INTERNAL_LIBSA_CREAD -DIN_PXEBOOT
CPPFLAGS+=	${SACFLAGS:M-[DI]*}
COPTS+=		${SACFLAGS:N-[DI]*}

#AFLAGS+=	-Wa,-R
#AFLAGS+=	-Wa,-a

MAN=		pxeboot.8

.if ${MACHINE_ARCH} == "i386"
PROG=		pxeboot
LD?=		ld
SIZE?=		size
INSTALL_STRIP=

LDFLAGS+=	${BOOTLDFLAGS}
CLEANFILES+=	${PROG}.{elf,nm,tmp} ld.out
CLEANFILES+=	crt0.o
SRCS=		srt0.S

SRCS+=	boot.c cmd.c vars.c bootarg.c conf.c devopen.c net.c

LDADD+=		${LLIBSA}
DPADD+=		${DLIBSA}

.PATH:	${S}/stand/boot

${PROG}: $(OBJS) $(DPADD)
	$(LD) $(LDFLAGS) $(OBJS) --start-group $(LDADD) --end-group \
	    -o ${PROG}.elf 2>&1 | tee ld.out
	@@if fgrep 'undefined reference' ld.out; then \
		echo "*** Attention: undefined references found!"; \
		rm -f $@@; \
		exit 1; \
	fi
	objcopy -x ${PROG}.elf ${PROG}.tmp
	nm ${PROG}.tmp >${PROG}.nm
	@@$(SIZE) ${PROG}.elf
	strip --strip-all -R .comment ${PROG}.tmp
	objcopy -O binary ${PROG}.tmp ${PROG}
	@@-rm -f ${PROG}.tmp

.else
NOPROG=	yes
.endif

.include <bsd.prog.mk>
@


1.12
log
@use standard open function (merge functionality)
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.11 2009/01/10 13:41:19 tg Exp $
@


1.11
log
@new memory layout, part 1
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.10 2009/01/10 11:58:01 tg Exp $
d32 1
a32 1
SRCS+=	boot.c cmd.c vars.c bootarg.c conf.c devopen.c net.c open.c
@


1.10
log
@LINKADDR, LINKSEG, LOADADDR, LOADSEG, SA_{LINK,LOAD}{ADDR,SEG} cleanup
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.9 2008/08/01 15:43:46 tg Exp $
a24 1
LDFLAGS+=	-nostdlib -Bstatic
d27 2
a28 2
LDFLAGS+=	-Ttext $(M_LINKADDR) -N -x -noinhibit-exec
CLEANFILES+=	ld.out
d40 2
a41 1
	$(LD) $(LDFLAGS) -o ${PROG} $(OBJS) $(LDADD) 2>&1 | tee ld.out
d44 1
d46 7
a52 4
	  else exit 0; fi
	@@$(SIZE) ${PROG}
	strip --strip-all -R .comment ${PROG}
	objcopy -O binary ${PROG}
@


1.9
log
@switch i386 bootloader to kern zlib
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.8 2008/08/01 11:25:01 tg Exp $
d11 1
a11 1
CPPFLAGS+=	${DEBUGFLAGS} -DLINKADDR=${LINKADDR} \
d28 2
a29 2
LDFLAGS+=	-Ttext $(LINKADDR) -N -x -noinhibit-exec
CLEANFILES+=	${.CURDIR}/disasm ld.out
a49 5
disasm:	${.CURDIR}/disasm

${.CURDIR}/disasm:	${PROG}
	ndisasm -b16 -o${LINKADDR} ${PROG} >${.CURDIR}/disasm

@


1.8
log
@merge and reduce diff to obsd
XXX not yet tested
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.7 2007/05/24 21:03:53 tg Exp $
d9 2
d35 2
a36 2
LDADD+=		${LLIBSA} ${LLIBZ}
DPADD+=		${DLIBSA} ${DLIBZ}
@


1.7
log
@maybe optimise for size: don't use /path/to/libfoo.a but -L/path/to -lfoo
@
text
@d1 2
a2 2
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.6 2006/10/15 01:35:54 tg Exp $
# $OpenBSD: Makefile,v 1.1 2004/03/19 13:48:19 tom Exp $
@


1.6
log
@* add -fno-omit-frame-pointer to boot blocks too -> unbreaks
* add COPTS and CFLAGS and CPPFLAGS correctly and in correct order
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.5 2006/06/30 23:18:05 tg Exp $
d33 2
a34 2
LDADD=	${LIBSA} ${LIBZ}
DPADD=	${LIBSA} ${LIBZ}
@


1.5
log
@check MACHINE_ARCH not MACHINE for same-userland stuff
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.4 2006/06/15 18:25:16 tg Exp $
d10 3
a12 1
		${SACFLAGS} -D__INTERNAL_LIBSA_CREAD -DIN_PXEBOOT
@


1.4
log
@remove DEBUGPROGS remnants, that flag is long dead
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.3 2005/10/20 12:47:54 tg Exp $
d17 1
a17 1
.if ${MACHINE} == "i386"
@


1.3
log
@fix up DEBUGLIBS and DEBUGPROGS
@
text
@d1 1
a1 1
# $MirOS: src/sys/arch/i386/stand/pxeboot/Makefile,v 1.2 2005/03/06 21:27:09 tg Exp $
a21 1
DEBUGPROGS=	No
@


1.2
log
@* merge src/sys/
  (at least the better part of it)
* revert IPv6 networking to OpenBSD, since
  I didn't get IPV4_MAPPED addresses working :(
@
text
@d1 1
a1 1
# $MirOS$
d22 1
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
#	$OpenBSD: Makefile,v 1.1 2004/03/19 13:48:19 tom Exp $
d6 10
a15 1
MAN=	pxeboot.8
d18 4
a21 4
PROG=	pxeboot
LD?=	ld
SIZE?=	size
LDFLAGS+=-nostdlib -Bstatic
d24 2
a25 1
LDFLAGS+=-Ttext $(LINKADDR) -N -x -noinhibit-exec
d27 1
a27 1
SRCS=	srt0.S
a29 2
S	=${.CURDIR}/../../../..
SADIR=	${.CURDIR}/..
d37 5
a41 1
	$(LD) $(LDFLAGS) -o ${PROG} $(OBJS) $(LDADD)
d43 7
a49 5
	@@if [ -x ${.OBJDIR}/${PROG} ]; then \
		objcopy -O binary ${PROG} ${.OBJDIR}/.tmp;\
		mv -f ${.OBJDIR}/.tmp ${.OBJDIR}/${PROG}; \
		ls -l ${.OBJDIR}/${PROG}; \
	fi
d52 1
a52 1
NOPROG=
a55 6

CPPFLAGS+=-DBOOTMAGIC=$(BOOTMAGIC) ${DEBUGFLAGS}
CPPFLAGS+=-DLINKADDR=${LINKADDR}
CFLAGS+=${SACFLAGS} -D__INTERNAL_LIBSA_CREAD
#AFLAGS+=-Wa,-R
# AFLAGS+=-Wa,-a
@


1.1.1.1
log
@Import the OpenBSD foundation of MirOS BSD
@
text
@@


1.1.1.2
log
@import bootloader-related pieces from openbsd, as first part of the
aspired 4.4 merge… and something else
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2007/11/25 18:25:32 deraadt Exp $
a24 3
.PATH:	${S}/lib/libkern/arch/i386 ${S}/lib/libkern
SRCS+=	strlcpy.c moddi3.c divdi3.c qdivrem.c

@

