head	1.24;
access;
symbols
	MIRBSD_10:1.6.0.2
	MIRBSD_10_BASE:1.6;
locks; strict;
comment	@# @;


1.24
date	2018.05.01.19.18.36;	author tg;	state Exp;
branches;
next	1.23;
commitid	1005AE8BD617E7AD578;

1.23
date	2010.01.16.23.25.53;	author tg;	state Exp;
branches;
next	1.22;
commitid	1004B524AEB3AE97341;

1.22
date	2010.01.16.21.39.54;	author tg;	state Exp;
branches;
next	1.21;
commitid	1004B52321C72AB80F8;

1.21
date	2010.01.16.21.30.32;	author tg;	state Exp;
branches;
next	1.20;
commitid	1004B5230055E80EF25;

1.20
date	2010.01.16.21.12.26;	author tg;	state Exp;
branches;
next	1.19;
commitid	1004B522B9E2A448832;

1.19
date	2009.10.03.17.38.11;	author tg;	state Exp;
branches;
next	1.18;
commitid	1004AC78BE14BC9F752;

1.18
date	2009.07.24.16.45.11;	author tg;	state Exp;
branches;
next	1.17;
commitid	1004A69E4A74D9FA0DB;

1.17
date	2009.02.02.23.59.50;	author tg;	state Exp;
branches;
next	1.16;
commitid	1004987882B40CCE76D;

1.16
date	2009.02.02.23.39.02;	author tg;	state Exp;
branches;
next	1.15;
commitid	1004987842E5BD89C15;

1.15
date	2009.02.01.22.25.07;	author tg;	state Exp;
branches;
next	1.14;
commitid	1004986215059E725A2;

1.14
date	2009.02.01.16.19.57;	author tg;	state Exp;
branches;
next	1.13;
commitid	1004985CBC501439418;

1.13
date	2009.02.01.16.18.51;	author tg;	state Exp;
branches;
next	1.12;
commitid	1004985CB835D41E2A4;

1.12
date	2009.02.01.15.50.10;	author tg;	state Exp;
branches;
next	1.11;
commitid	1004985C48E6A4A6925;

1.11
date	2008.10.22.17.46.45;	author tg;	state Exp;
branches;
next	1.10;
commitid	10048FF670D0D046474;

1.10
date	2008.10.21.19.01.01;	author tg;	state Exp;
branches;
next	1.9;
commitid	10048FE26CA55B3C905;

1.9
date	2008.10.21.01.18.14;	author tg;	state Exp;
branches;
next	1.8;
commitid	10048FD2DD315AC4C0B;

1.8
date	2008.10.21.00.12.26;	author tg;	state Exp;
branches;
next	1.7;
commitid	10048FD1E63215400CA;

1.7
date	2008.10.20.23.15.39;	author tg;	state Exp;
branches;
next	1.6;
commitid	10048FD1115625F39EB;

1.6
date	2007.10.20.23.28.11;	author tg;	state Exp;
branches;
next	1.5;
commitid	100471A8F184C4BAFBF;

1.5
date	2007.10.20.23.25.17;	author tg;	state Exp;
branches;
next	1.4;
commitid	100471A8E68265D5DAD;

1.4
date	2007.10.20.23.18.03;	author tg;	state Exp;
branches;
next	1.3;
commitid	100471A8CAD11499B9C;

1.3
date	2007.10.20.22.40.18;	author tg;	state Exp;
branches;
next	1.2;
commitid	100471A83DA723D1788;

1.2
date	2007.10.20.20.25.32;	author tg;	state Exp;
branches;
next	1.1;
commitid	100471A644F2B758046;

1.1
date	2007.10.20.20.24.41;	author tg;	state Exp;
branches;
next	;
commitid	100471A64172DC591F6;


desc
@@


1.24
log
@embed the licence blurbs of any files the actual bootxx is a derivative of
to the i386 and sparc mkbxinst.sh generated-output-bxinst parts, for full
licence coverage (i386 is actually a nop since it is already contained)
@
text
@#!/bin/mksh
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.22 2010/01/16 21:39:54 tg Exp $'
#-
# Copyright (c) 2007, 2008, 2009, 2010
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# Create a self-installing bootxx for sparc (32 bit).
# Arguments: $1 = a.out (sparc OpenBOOT) bootxx, linked
# Output: shell script to stdout

function die {
	rv=$1; shift
	print -u2 -- "$@@"
	exit $rv
}

[[ -s $1 ]] || die 1 Cannot read input file "'$1'"

T=$(mktemp /tmp/bxinst.XXXXXXXXXX) || die 1 Cannot create temporary file
trap 'rm -f $T ; exit 0' 0
trap 'rm -f $T ; exit 1' 1 2 3 5 13 15

nm --target=a.out-sunos-big $1 |&
while read -p adr typ sym; do
	[[ $sym = _@@(_ustar_keep|block_start|start) ]] || continue
	eval typeset -i10 sym$sym=0x\$adr
done

set -A sect_text -- $(objdump -wh --target=a.out-sunos-big $1 | fgrep .text)
(( fofs_text = 0x${sect_text[5]} ))

(( fofs_text == 0x20 )) || die 1 Adjust fofs_text in srt0.S and here

typeset -Uui10 ofs tblsz
(( ofs = sym_block_start - sym_start + fofs_text ))
strip -F a.out-sunos-big -s -o $T $1
outsz=$(stat -f %z $T)
(( outsz <= (15 * 512) )) || die 1 bootxx too big
tblsz=$(dd if=$T bs=1 skip=$ofs count=4 2>/dev/null | \
    hexdump -ve '"0x" 4/1 "%02X"')
part1=$(dd if=$T bs=1 skip=8 count=$((ofs - 8)) 2>/dev/null | \
    hexdump -ve '1/1 "\\0%o"' | sed 's/\\00*/\\0/g')
part2=$(dd if=$T bs=1 skip=$((ofs + tblsz * 4 + 8)) 2>/dev/null | \
    hexdump -ve '1/1 "\\0%o"' | sed 's/\\00*/\\0/g')

print '#!/usr/bin/env mksh'
print "# $rcsid"
print "# \$miros:${rcsid#*:}"
cat <<'EOF'
#-
# Copyright (c) 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009,
#		2010, 2011, 2012, 2013, 2014, 2015, 2017, 2018
#	mirabilos <m@@mirbsd.org> (a.k.a. The MirOS Project)
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un‐
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.
#
# Additional licences for the actual boot code below; these apply to
# this entire resulting generated file.
#-
# Self-installing 32-bit sun4m/sun4c boot blocks for MirOS BSD/sparc
# Reads a list of extents (firstblock lastblock) from standard input
# and writes bootxx to standard output, which can subsequentially be
# stored past the SunOS disklabel directly on the disc.
# Other mode creates ustarfs leader from self and /usr/mdec/boot.fd.
#-
# Copyright (c) 1989, 1990, 1991 Carnegie Mellon University
# All Rights Reserved.
#
# Author: Alessandro Forin
#
# Permission to use, copy, modify and distribute this software and its
# documentation is hereby granted, provided that both the copyright
# notice and this permission notice appear in all copies of the
# software, derivative works or modified versions, and any portions
# thereof, and that both notices appear in supporting documentation.
#-
# Copyright (c) 2002 Marc Espie.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE OPENBSD PROJECT AND CONTRIBUTORS
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OPENBSD
# PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-
# Copyright (C) 1985 Regents of the University of California
# Copyright (c) 1993 Adam Glass
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by Adam Glass.
# 4. The name of the Author may not be used to endorse or promote products
#    derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY Adam Glass ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#-
# Copyright (c) 1993 John Brezak
# Copyright (c) 1993, 1994 Christopher G. Demetriou
# Copyright (c) 1993, 1994 Paul Kranenburg
# Copyright (c) 1995 Gordon W. Ross
# Copyright (c) 1997 Niklas Hallqvist
# Copyright (c) 1997 Theo de Raadt
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by Paul Kranenburg.
#	This product includes software developed by Gordon Ross
#	This product includes software developed by Christopher G. Demetriou.
# 4. The name of the author may not be used to endorse or promote products
#    derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-
# Copyright (c) 1982, 1986, 1988, 1989, 1990, 1991, 1992, 1993, 1994
#	The Regents of the University of California
# (c) UNIX System Laboratories, Inc.
# Copyright (c) 1988 University of Utah
# Copyright (c) 1993 Adam Glass
# Copyright (c) 1993 Theo de Raadt
# Copyright (c) 1994 Allen Briggs
# Copyright (c) 1995, 1996
#	The President and Fellows of Harvard College
# Copyright (c) 1996 Matthias Drochner
# Copyright (c) 1994, 1997 Christopher G. Demetriou
# All rights reserved.
#
# All or some portions of this file are derived from material licensed
# to the University of California by American Telephone and Telegraph
# Co. or Unix System Laboratories, Inc. and are reproduced herein with
# the permission of UNIX System Laboratories, Inc.
#
# This code is derived from software contributed to Berkeley by
# Jan-Simon Pendry.
#
# This code is derived from software contributed to Berkeley by
# Berkeley Software Design, Inc.
#
# This code is derived from software contributed to Berkeley by
# The Mach Operating System project at Carnegie-Mellon University.
#
# Sun4m support by Aaron Brown, Harvard University.
#
# This software was developed by the Computer Systems Engineering group
# at Lawrence Berkeley Laboratory under DARPA contract BG 91-66 and
# contributed to Berkeley.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgements:
#	This product includes software developed by Harvard University.
#	This product includes software developed by the University of
#	   California, Berkeley and its contributors.
#	This product includes software developed by the University of
#	   California, Lawrence Berkeley Laboratory.
# 4. Neither the name of the University nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.

EOF
sed -e '/\$Mir''OS: /s/MirOS/miros/p' \
    -e '/^function tarcksum/,/^}/p' \
    -n $BSDSRCDIR/sys/arch/i386/stand/bootxx_ustarfs/tarcksum
print
typeset -i ustar_keep=$((sym__ustar_keep - sym_start + fofs_text ))
(( ustar_keep < 100 )) || die 1 ustar_keep is too large
print typeset -i  outsz=$outsz ustar_keep=$ustar_keep
cat <<'EOF'

# $miros: src/distrib/tools/i386_chain.S,v 1.7 2007/10/20 22:05:13 tg Exp $
set -A pbs_thecode 0x66 0x31 0xC0 0x66 0x50 0x66 0x9D 0x05 0xA0 0x07 0x8E 0xD0 0xBC 0xFC 0xFF 0xFB 0x50 0x68 0x24 0x00 0x8E 0xD8 0x8E 0xC0 0x31 0xFF 0xBE 0x00 0x02 0xB9 0x80 0x00 0xF3 0x66 0xA5 0xCB 0xB8 0x01 0x02 0xBB 0x00 0x02 0xB9 0x19 0x00 0xB6 0x00 0x60 0xCD 0x13 0x61 0x73 0x08 0x60 0x31 0xC0 0xCD 0x13 0x61 0xEB 0xF2 0xEA 0x00 0x7C 0x00 0x00
typeset -Uui8 pbs_thecode
typeset -i pbs_ofs_sector=43 pbs_curptr=66 ustarmode=0

function pbs_output {
	typeset ostr=
	typeset -i psz cylno

	# fill the block table
	(( pbs_thecode[pbs_ofs_sector] = $1 + 1 ))
	if (( ustarmode )); then
		pbs_curptr=0
		pbs_thecode[pbs_curptr++]=1#u
		pbs_thecode[pbs_curptr++]=1#s
		pbs_thecode[pbs_curptr++]=1#t
		pbs_thecode[pbs_curptr++]=1#a
		pbs_thecode[pbs_curptr++]=1#r
		pbs_thecode[pbs_curptr++]=1#f
		pbs_thecode[pbs_curptr++]=1#s
		pbs_thecode[pbs_curptr++]=0
	fi
	while (( pbs_curptr < 126 )); do
		(( pbs_thecode[pbs_curptr++] = RANDOM & 0xFF ))
	done

	# create the Sun disklabel
	while (( pbs_curptr < 512 )); do
		pbs_thecode[pbs_curptr++]=0
	done

	# rpm
	pbs_thecode[420]=0x01
	pbs_thecode[421]=0x2C
	# pcyl
	(( pbs_thecode[422] = (g_code[0] >> 8) & 0xFF ))
	(( pbs_thecode[423] = g_code[0] & 0xFF ))
	# interleave
	pbs_thecode[431]=1
	# ncyl
	(( pbs_thecode[432] = (g_code[0] >> 8) & 0xFF ))
	(( pbs_thecode[433] = g_code[0] & 0xFF ))
	# ntrk
	(( pbs_thecode[436] = (g_code[1] >> 8) & 0xFF ))
	(( pbs_thecode[437] = g_code[1] & 0xFF ))
	# nsec
	(( pbs_thecode[438] = (g_code[2] >> 8) & 0xFF ))
	(( pbs_thecode[439] = g_code[2] & 0xFF ))
	# sectors per drive
	(( psz = g_code[0] * g_code[1] * g_code[2] ))
	# sparc partitions
	print -u2 geometry is $psz sectors in ${g_code[0]} cylinders, \
	    ${g_code[1]} heads, ${g_code[2]} sectors per track
	(( pbs_thecode[448] = pbs_thecode[456] = pbs_thecode[464] = \
	    pbs_thecode[472] = (psz >> 24) & 0xFF ))
	(( pbs_thecode[449] = pbs_thecode[457] = pbs_thecode[465] = \
	    pbs_thecode[473] = (psz >> 16) & 0xFF ))
	(( pbs_thecode[450] = pbs_thecode[458] = pbs_thecode[466] = \
	    pbs_thecode[474] = (psz >> 8) & 0xFF ))
	(( pbs_thecode[451] = pbs_thecode[459] = pbs_thecode[467] = \
	    pbs_thecode[475] = psz & 0xFF ))
	# sparc partition h (for ustarfs)
	let psz--
	pbs_thecode[503]=1
	(( pbs_thecode[504] = (psz >> 24) & 0xFF ))
	(( pbs_thecode[505] = (psz >> 16) & 0xFF ))
	(( pbs_thecode[506] = (psz >> 8) & 0xFF ))
	(( pbs_thecode[507] = psz & 0xFF ))
	let psz++
	# i386 partition
	pbs_thecode[478]=0x80
	(( pbs_thecode[480] = ustarmode ? 2 : 1 ))
	pbs_thecode[482]=0x96
	(( pbs_thecode[483] = g_code[1] - 1 ))
	(( cylno = g_code[0] > 1024 ? 1023 : g_code[0] - 1 ))
	(( pbs_thecode[484] = g_code[2] | ((cylno & 0x0300) >> 2) ))
	(( pbs_thecode[485] = cylno & 0x00FF ))
	(( ustarmode )) && pbs_thecode[486]=1
	(( ustarmode )) && let psz--
	(( pbs_thecode[490] = psz & 0xFF ))
	(( pbs_thecode[491] = (psz >> 8) & 0xFF ))
	(( pbs_thecode[492] = (psz >> 16) & 0xFF ))
	(( pbs_thecode[493] = (psz >> 24) & 0xFF ))
	(( ustarmode )) && let psz++
	# magic
	pbs_thecode[508]=0xDA
	pbs_thecode[509]=0xBE
	pbs_thecode[510]=0x55
	pbs_thecode[511]=0xAA

	# fill in the hashes
	pbs_curptr=0
	while (( pbs_curptr < 126 )); do
		(( pbs_thecode[126] ^= pbs_thecode[pbs_curptr++] ))
		(( pbs_thecode[127] ^= pbs_thecode[pbs_curptr++] ))
	done
	pbs_curptr=128
	while (( pbs_curptr < 512 )); do
		(( pbs_thecode[126] ^= pbs_thecode[pbs_curptr++] ))
		(( pbs_thecode[127] ^= pbs_thecode[pbs_curptr++] ))
	done

	# create the output string
	pbs_curptr=0
	while (( pbs_curptr < 512 )); do
		ostr=$ostr\\0${pbs_thecode[pbs_curptr++]#8#}
	done
	print -n "$ostr"
}

function out_int32 {
	typeset -Uui16 value=$1
	typeset -Uui8 ba bb bc bd

	(( ba = (value >> 24) & 0xFF ))
	(( bb = (value >> 16) & 0xFF ))
	(( bc = (value >> 8) & 0xFF ))
	(( bd = value & 0xFF ))
	print -n "\\0${ba#8#}\\0${bb#8#}\\0${bc#8#}\\0${bd#8#}"
}

function out_int8 {
	typeset -Uui8 b

	(( b = $1 & 0xFF ))
	print -n "\\0${b#8#}"
}

# Output the following:
# • 512 bytes: Sun disklabel
# • outsz bytes: bootxx (where first 512 bytes is ustar header)
# • pad until end of sector: random bytes
# • variable number of bytes: second stage bootloader
# • pad until end of sector: undefined
# A real ustar archive containing the kernel can be appended.
# Layout on disc (only 0‥k are written):
# • 0: Sun disklabel
# • 1: ustar header 1‥k
# • 2‥i: first stage bootloader
# • j‥k: second stage bootloader
# • k+1: next ustar header or 1024 NUL-bytes
# i = 1 + (outsz_padded / 512) - 1
# j = i + 1
# k = j + (stage2size_padded / 512) - 1
function do_ustar {
	typeset me=$1 mdecboot=$2

	# round up to whole of 512 bytes
	(( outsz = (outsz + 511) & ~511 ))

	# we need this later
	if ! T=$(mktemp -d /tmp/bootxx.XXXXXXXXXX); then
		print -u2 Error: cannot create temporary directory
		exit 1
	fi
	cd "$T"

	# output modified Sun disklabel
	pbs_output 0 >label

	# copy over second stage bootloader
	dd if="$mdecboot" of=stage2 2>/dev/null
	stage2size=$(stat -f %z stage2)
	(( stage2size = (stage2size + 511) & ~511 ))

	(( i = 1 + (outsz / 512) - 1 ))
	(( j = i + 1 ))
	(( k = j + (stage2size / 512) - 1 ))

	# create bootxx by using myself and calculated values
	print $j $k | mksh "$me" >stage1

	# copy tarball content (stage1 + stage2) together
	dd if=stage1 of=content obs=512 conv=osync 2>/dev/null
	if (( $(stat -f %z content) != outsz )); then
		print -u2 Internal error
		cd /
		rm -rf "$T"
		exit 255
	fi
	cat stage2 >>content

	# split content into file (f) and ustar header (h)
	dd if=content of=f bs=512 skip=1 2>/dev/null
	x=0
	while (( x++ < 100 )); do
		out_int8 $RANDOM
	done >h
	dd if=content bs=$ustar_keep count=1 conv=notrunc of=h 2>/dev/null

	# create an ustar archive
	tarprog=$(whence -p mirtar || whence -p tar)
	$tarprog -b 1 -M dist -cf a.tar f
	tarsize=$(stat -f %z a.tar)
	if (( tarsize != (outsz + stage2size + 1024) )); then
		print -u2 Error: tar output size $tarsize wrong, want \
		    $((outsz + stage2size + 1024))
		cd /
		rm -rf "$T"
		exit 1
	fi

	# patch its header
	dd if=h bs=100 count=1 conv=notrunc of=a.tar 2>/dev/null
	print -n "$(tarcksum a.tar)\\0" | \
	    dd of=a.tar bs=1 seek=148 conv=notrunc 2>/dev/null

	# output the result
	print -u2 created $((tarsize - 512)) bytes of ustarfs/sparc lead
	dd if=a.tar bs=512 count=$(((tarsize - 1024)/512)) 2>/dev/null | \
	    cat label -

	# clean up
	cd /
	rm -rf "$T"
}

EOF
print typeset -i blktblsz=$tblsz
cat <<'EOF'
set -A blktblent
typeset -i blktblent blktblnum=0 firstblock lastblock i=0 sscale=0 chainsec=-1
set -A g_code 2048 1 640

while getopts ":0:g:N:S:T:" ch; do
	case $ch {
	(0)	if (( (chainsec = OPTARG) < 0 || OPTARG > 62 )); then
			print -u2 Error: invalid chain sector "'$OPTARG'"
			exit 1
		fi ;;
	(g)	if [[ $OPTARG != +([0-9]):+([0-9]):+([0-9]) ]]; then
			print -u2 Error: invalid geometry code "'$OPTARG'"
			exit 1
		fi
		saveIFS=$IFS
		IFS=:
		set -A g_code -- $OPTARG
		IFS=$saveIFS ;;
	(N)	;;
	(S)	if (( (sscale = OPTARG) < 0 || OPTARG > 24 )); then
			print -u2 Error: invalid sector scale "'$OPTARG'"
			exit 1
		fi ;;
	(T)	if [[ ! -s $OPTARG ]]; then
			print -u2 Error: "'$OPTARG'" not found
			exit 1
		fi
		ustarfile=$OPTARG
		ustarmode=1 ;;
	(*)	print -u2 'Syntax:
	bxinst [-0 secno [-g C:H:S]] [-S scale] <blocklist >loader
	(bxinst -g C:H:S -T .../boot; tar -b 1 -M dist -cf - bsd) >floppy.tar
Default scale=0, geometry: 2048 cyls 1 head 640 secs, suggest secno=24'
		exit 1 ;;
	}
done
shift $((OPTIND - 1))

if (( ustarmode )); then
	if [[ ${g_code[*]} = "2048 1 640" ]]; then
		print -u2 Error: Use option -g C:H:S as well
		exit 1
	fi
	do_ustar "$(realpath "$0")" "$(realpath "$ustarfile")"
	exit 0
fi

# if desired, output chain sector (MBR) including partition and Sun disklabel
(( chainsec >= 0 )) && pbs_output $chainsec

# zero-initialise the block array
while (( i < blktblsz )); do
	blktblent[i++]=0
done

# read in the extents
while read firstblock lastblock junk; do
	while (( firstblock <= lastblock )); do
		(( blktblent[blktblnum++] = firstblock++ << sscale ))
	done
	if (( blktblnum > blktblsz )); then
		print -u2 Error: too many blocks, maximum $blktblsz
		exit 1
	fi
done

# verbose output
i=0
print -nu2 "using $blktblnum blocks of size $((512 << sscale)):"
while (( i < blktblnum )); do
	print -nu2 " ${blktblent[i++]}"
done
print -u2 .

# Part 1
EOF
print -r "print -n '\01\03\01\07\060\0200\0\07$part1'"
cat <<'EOF'

# The Block Table
out_int32 $blktblnum
out_int32 $((512 << sscale))
i=0
while (( i < blktblsz )); do
	out_int32 ${blktblent[i++]}
done

# Part 2
EOF
print -r "print -n '$part2'"
cat <<'EOF'

# Pad with random octets until end of sector
while (( outsz++ & 511 )); do
	out_int8 $RANDOM
done
#let outsz--

exit 0
EOF
exit 0
@


1.23
log
@teach the self-installing sparc bootblocks ustarfs
@
text
@d5 1
a5 1
#	Thorsten Glaser <tg@@mirbsd.org>
d66 3
a68 2
# Copyright (c) 2007, 2008, 2009, 2010
#	Thorsten Glaser <tg@@mirbsd.org>
d76 4
d88 3
d97 163
d271 1
@


1.22
log
@pad bootxx output for full sectors (using random octets)
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.21 2010/01/16 21:30:32 tg Exp $'
d66 1
a66 1
# Copyright (c) 2007, 2008, 2009
d88 11
d102 1
a102 1
typeset -i pbs_ofs_sector=43 pbs_curptr=66
d110 11
d160 8
d170 1
a170 1
	pbs_thecode[480]=1
d176 2
d182 1
d220 96
a316 4
typeset -i ustar_keep=$((sym__ustar_keep - sym_start + fofs_text ))
(( ustar_keep < 100 )) || die 1 ustar_keep is too large
print typeset -i ustar_keep=$ustar_keep \#XXX
print typeset -i outsz=$outsz
d323 1
a323 1
while getopts ":0:g:N:S:" ch; do
d342 6
d350 1
d357 9
a411 1
typeset -Uui8 x
d413 1
a413 2
	(( x = RANDOM & 0xFF ))
	print -n "\\0${x#8#}"
d415 1
a415 1
let outsz--
@


1.21
log
@track amount of initial (lead) bytes needed for ustar
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.20 2010/01/16 21:12:26 tg Exp $'
d52 2
a53 1
(( $(stat -f %z $T) <= (15 * 512) )) || die 1 bootxx too big
d191 1
d268 12
a279 1
print exit 0
@


1.20
log
@• srt0.S, mkbxinst.sh: define and control size of a.out header in-file
• srt0.S: hide an ustarfs header at appropriate absolute-file offsets
• mkbxinst.sh: check total size of bootxx (OpenBOOT loads sector 1‥15)
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.19 2009/10/03 17:38:11 tg Exp $'
d4 1
a4 1
# Copyright (c) 2007, 2008, 2009
d40 1
a40 1
	[[ $sym = @@(_block_start|_start) ]] || continue
d52 1
a52 1
(( $(stat -f %z $T) <= (15 * 512) )) || die bootxx too big
d187 3
@


1.19
log
@make sure that no shell script uses
• integer foo[n] (currently the same as integer foo, but not for
  much longer…)
• set ±o posix (replaced by set ±o sh)
any more
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.18 2009/07/24 16:45:11 tg Exp $'
d47 2
d52 1
@


1.18
log
@Embed one i386 MBR partition into the sparc Sun disklabel, which has
the type 0x96 (see cid 1004A48EFD57EB34069) and spans the same whole
disc area as the sparc Sun partitions a, b, c, and d we also create.

To be tested on bare iron (both arches) soon.
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.17 2009/02/02 23:59:50 tg Exp $'
d187 1
a187 1
typeset -i blktblnum=0 firstblock lastblock i=0 sscale=0 chainsec=-1
d222 1
a222 1
	typeset -i blktblent[i++]=0
@


1.17
log
@it was nice while it lasted… but a 2048 byte BSD disklabel on a hard disc
won’t work either (and setting the sector size in it to 0 panics the ker-
nel, quite nice local DoS attack by the way, thanks for all the blowfish)

⇒ revert the writing-the-disklabel code altogether
  ‣ make -N option ignored (and undocumented)
⇒ hack: if the MBR looks like a Sun disklabel faked by us (i.e. no exten-
  ded partition magic, but DABE and forced 55AA, and no 0x27 partition or
  recognisable BSD LE disklabel), ignore it for ‘a’ slice detection)

untested
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.16 2009/02/02 23:39:02 tg Exp $'
d91 1
a91 1
	typeset -i psz
d123 1
a123 1
	# partitions
d134 12
d217 1
a217 1
# output chain sector including Sun disklabel, if desired
@


1.16
log
@• The ATAPI CD label m̲u̲s̲t̲ have a sector size of 2048 bytes
• fix order of usage while here
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.15 2009/02/01 22:25:07 tg Exp $'
d40 1
a40 1
	[[ $sym = @@(_block_start|_start|__le_disklabel_*) ]] || continue
d47 1
a47 1
typeset -Uui10 ofs tblsz lofs lend
a48 2
(( lofs = sym__le_disklabel_start - sym_start + fofs_text ))
(( lend = sym__le_disklabel_end - sym_start + fofs_text ))
d52 1
a52 1
part1=$(dd if=$T bs=1 skip=8 count=$((lofs - 8)) 2>/dev/null | \
d54 1
a54 3
part2=$(dd if=$T bs=1 skip=$lend count=$((ofs - lend)) 2>/dev/null | \
    hexdump -ve '1/1 "\\0%o"' | sed 's/\\00*/\\0/g')
part3=$(dd if=$T bs=1 skip=$((ofs + tblsz * 4 + 8)) 2>/dev/null | \
d86 2
a87 4
set -A lbl_thecode 0x57 0x45 0x56 0x82 0x0D 0x00 0x00 0x00 0x43 0x44 0x2D 0x52 0x4F 0x4D 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x49 0x53 0x4F 0x20 0x39 0x36 0x36 0x30 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x20 0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x20 0x01 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2C 0x01 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x57 0x45 0x50 0x82 0x00 0x00 0x04 0x00 0x00 0x20 0x00 0x00 0x00 0x20 0x00 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
typeset -Uui8 pbs_thecode lbl_thecode
typeset -i pbs_ofs_sector=43 pbs_curptr=66 lbl_curptr lbl_psiz=0x94
typeset -i lbl_spt=0x2C lbl_tpc=0x30 lbl_cyl=0x34 lbl_spc=0x38 lbl_tot=0x3C
a114 2
	(( lbl_thecode[lbl_cyl] = ((g_code[0] + 3) / 4) & 0xFF ))
	(( lbl_thecode[lbl_cyl + 1] = ((g_code[0] + 3) >> 10) & 0xFF ))
a117 2
	(( lbl_thecode[lbl_tpc] = g_code[1] & 0xFF ))
	(( lbl_thecode[lbl_tpc + 1] = (g_code[1] >> 8) & 0xFF ))
a120 8
	(( lbl_thecode[lbl_spt] = g_code[2] & 0xFF ))
	(( lbl_thecode[lbl_spt + 1] = (g_code[2] >> 8) & 0xFF ))
	# sectors per cylinder
	(( psz = g_code[1] * g_code[2] ))
	(( lbl_thecode[lbl_spc] = psz & 0xFF ))
	(( lbl_thecode[lbl_spc + 1] = (psz >> 8) & 0xFF ))
	(( lbl_thecode[lbl_spc + 2] = (psz >> 16) & 0xFF ))
	(( lbl_thecode[lbl_spc + 3] = (psz >> 24) & 0xFF ))
a133 12
	(( lbl_thecode[lbl_tot + 0] = lbl_thecode[lbl_psiz + 0x00] = \
	    lbl_thecode[lbl_psiz + 0x10] = lbl_thecode[lbl_psiz + 0x20] = \
	    lbl_thecode[lbl_psiz + 0x30] = (psz / 4) & 0xFF ))
	(( lbl_thecode[lbl_tot + 1] = lbl_thecode[lbl_psiz + 0x01] = \
	    lbl_thecode[lbl_psiz + 0x11] = lbl_thecode[lbl_psiz + 0x21] = \
	    lbl_thecode[lbl_psiz + 0x31] = (psz >> 10) & 0xFF ))
	(( lbl_thecode[lbl_tot + 2] = lbl_thecode[lbl_psiz + 0x02] = \
	    lbl_thecode[lbl_psiz + 0x12] = lbl_thecode[lbl_psiz + 0x22] = \
	    lbl_thecode[lbl_psiz + 0x32] = (psz >> 18) & 0xFF ))
	(( lbl_thecode[lbl_tot + 3] = lbl_thecode[lbl_psiz + 0x03] = \
	    lbl_thecode[lbl_psiz + 0x13] = lbl_thecode[lbl_psiz + 0x23] = \
	    lbl_thecode[lbl_psiz + 0x33] = (psz >> 26) & 0xFF ))
a151 12
	lbl_curptr=0
	lbl_thecode[134]=0x56	# magic
	while (( lbl_curptr < 136 )); do
		(( lbl_thecode[136] ^= lbl_thecode[lbl_curptr++] ))
		(( lbl_thecode[137] ^= lbl_thecode[lbl_curptr++] ))
	done
	lbl_curptr=138
	while (( lbl_curptr < 404 )); do
		(( lbl_thecode[136] ^= lbl_thecode[lbl_curptr++] ))
		(( lbl_thecode[137] ^= lbl_thecode[lbl_curptr++] ))
	done

a159 25
function lbl_rename {
	typeset name=$1
	typeset -i i

	lbl_curptr=0x18
	while (( lbl_curptr < 0x28 )); do
		i=0
		if (( ${#name} )); then
			i=1#${name::1}
			name=${name:1}
		fi
		(( lbl_thecode[lbl_curptr++] = i ))
	done
}

function lbl_output {
	typeset ostr=

	lbl_curptr=0
	while (( lbl_curptr < 404 )); do
		ostr=$ostr\\0${lbl_thecode[lbl_curptr++]#8#}
	done
	print -n "$ostr"
}

d192 1
a192 1
	(N)	lbl_rename "$OPTARG" ;;
d198 1
a198 1
	bxinst [-0 secno [-g C:H:S]] [-N name] [-S scale] <blocklist >loader
a234 3
print lbl_output
print \# Part 2
print -r "print -n '$part2'"
d245 1
a245 1
# Part 3
d247 1
a247 1
print -r "print -n '$part3'"
@


1.15
log
@goddamn frickin’ typo!

yeah, magic, all right
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.14 2009/02/01 16:19:57 tg Exp $'
d90 1
a90 1
set -A lbl_thecode 0x57 0x45 0x56 0x82 0x0D 0x00 0x00 0x00 0x43 0x44 0x2D 0x52 0x4F 0x4D 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x49 0x53 0x4F 0x20 0x39 0x36 0x36 0x30 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x02 0x00 0x00 0x20 0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x20 0x01 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x2C 0x01 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x57 0x45 0x50 0x82 0x00 0x00 0x04 0x00 0x00 0x20 0x00 0x00 0x00 0x20 0x00 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x40 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x0C 0x08 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
d121 2
a122 2
	(( lbl_thecode[lbl_cyl] = g_code[0] & 0xFF ))
	(( lbl_thecode[lbl_cyl + 1] = (g_code[0] >> 8) & 0xFF ))
d154 1
a154 1
	    lbl_thecode[lbl_psiz + 0x30] = psz & 0xFF ))
d157 1
a157 1
	    lbl_thecode[lbl_psiz + 0x31] = (psz >> 8) & 0xFF ))
d160 1
a160 1
	    lbl_thecode[lbl_psiz + 0x32] = (psz >> 16) & 0xFF ))
d163 1
a163 1
	    lbl_thecode[lbl_psiz + 0x33] = (psz >> 24) & 0xFF ))
d266 1
a266 1
Default scale=0, suggest secno=24, geometry: 2048 cyls 1 head 640 secs'
@


1.14
log
@fix usage
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.13 2009/02/01 16:18:51 tg Exp $'
d183 1
a183 1
	lbl_curptr[134]=0x56	# magic
@


1.13
log
@fix usage
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.12 2009/02/01 15:50:10 tg Exp $'
d266 1
a266 1
Default scale=0, geometry: 2048 cyls 1 head 640 secs'
@


1.12
log
@• in the sparc self-installing boot blocks, create a _working_ i386
  CD-ROM disklabel iff -0 is used and a geometry is given
  (the exact values, such as device type ATAPI, are currently hard-
  coded, but the pack name and geometry can be used)
  ‣ this matches the -0 behaviour for the Sun disklabel
• clean these two up a little
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.11 2008/10/22 17:46:45 tg Exp $'
d265 1
a265 1
	bxinst [-0 [-g C:H:S]] [-N name] [-S scale] <blocklist >loader
@


1.11
log
@display disc geometry actually used for the Sun disklabel synthesized
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.10 2008/10/21 19:01:01 tg Exp $'
d4 2
a5 2
# Copyright (c) 2007, 2008
#	Thorsten Glaser <tg@@mirbsd.de>
a12 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
d22 2
a23 2
# Create a self-installing bootxx for sparc.
# Arguments: $1 = a.out (sparc OpenBoot) bootxx, linked
d34 1
a34 1
T=$(mktemp /tmp/pine.smime.XXXXXXXXXX) || die 1 Cannot create temporary file
d40 1
a40 1
	[[ $sym = @@(_block_start|_start) ]] || continue
d47 1
a47 1
typeset -Uui10 ofs tblsz
d49 2
d54 3
a56 1
part1=$(dd if=$T bs=1 skip=8 count=$((ofs - 8)) 2>/dev/null | \
d58 1
a58 1
part2=$(dd if=$T bs=1 skip=$((ofs + tblsz * 4 + 8)) 2>/dev/null | \
d66 2
a67 2
# Copyright (c) 2007, 2008
#	Thorsten Glaser <tg@@mirbsd.de>
d84 1
a84 1
# Self-installing SPARC boot blocks for MirOS BSD (sun4m, sun4c)
d90 4
a93 3
typeset -Uui8 pbs_thecode
typeset -i pbs_ofs_sector=43
typeset -i pbs_curptr=66
d121 2
d126 2
d131 10
a141 1
	(( psz = g_code[0] * g_code[1] * g_code[2] ))
d152 12
d182 12
d202 25
d245 1
a245 1
while getopts ":0:g:S:" ch; do
d259 1
d265 1
a265 1
	bxinst [-0 [-g C:H:S]] [-S scale] <blocklist >loader
d302 3
d315 1
a315 1
# Part 2
d317 1
a317 1
print -r "print -n '$part2'"
@


1.10
log
@properly determine file offset of the .text section from the a.out header,
instead of just assuming we get it by skipping the first two paragraphs

XXX there might be more cases of this in OpenBSD derived code

(i386 uses ELF and operates on binary, so no need to worry about that)
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.9 2008/10/21 01:18:14 tg Exp $'
d128 2
@


1.9
log
@indeed, it’s not THAT difficult to create a Sun disklabel on the fly,
especially not in a MirBSD Korn Shell script. pah!
@
text
@d2 1
a2 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.8 2008/10/21 00:12:26 tg Exp $'
d48 3
d52 1
a52 1
(( ofs = sym_block_start - sym_start + 32 ))
@


1.8
log
@simplify the hexdump-sed-pipeline
this were be no change in output if the original had been correct
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.7 2008/10/20 23:15:39 tg Exp $
a29 2
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.7 2008/10/20 23:15:39 tg Exp $'

d87 1
d93 1
d101 38
a139 2
	pbs_thecode[126]=0x8C
	pbs_thecode[127]=0xCA
d145 5
d153 1
a153 2
	typeset -Uui8 pbs_thecode
	while (( pbs_curptr < 128 )); do
d156 1
a156 5

	# the part after $ostr generated by:
	# $ dd if=<sparc cdrom with disklabel applied> bs=1 skip=128 | \
	#   hexdump -ve '1/1 "\\0%o"' | sed 's/\\00*/\\0/g'
	print -n "$ostr\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\01\0136\010\0\0\0\0\0\0\0\0\01\010\0\0\0\0\01\02\0200\0\0\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0332\0276\0125\0252"
d174 2
a175 1
typeset -i blktblnum=0 firstblock lastblock i=0 sscale=0
d177 1
a177 1
while getopts ":0:S:" ch; do
d179 1
a179 1
	(0)	if (( OPTARG < 0 || OPTARG > 62 )); then
d182 4
d187 4
a190 1
		pbs_output $OPTARG ;;
d195 3
a197 1
	(*)	print -u2 "Syntax: bxinst [-S scale] <blocklist >loader"
d203 3
@


1.7
log
@what began as simple sparc output correcture let me see what a mess this is…
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.6 2007/10/20 23:28:11 tg Exp $
d4 1
a4 1
# Copyright (c) 2007
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.6 2007/10/20 23:28:11 tg Exp $'
d56 1
a56 1
    hexdump -ve '1/1 "\\0%o"' | sed -e 's/\\00\\/\\0\\/g' -e 's/\\00\\/\\0\\/g')
d58 1
a58 1
    hexdump -ve '1/1 "\\0%o"' | sed -e 's/\\00\\/\\0\\/g' -e 's/\\00\\/\\0\\/g')
d119 1
a119 1
	#   hexdump -ve '1/1 "\\0%o"' | sed -e 's/\\00\\/\\0\\/g' -e 's/\\00\\/\\0\\/g'
@


1.6
log
@make the -0 option have an argument, use that for chaining stuff
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.5 2007/10/20 23:25:17 tg Exp $
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.5 2007/10/20 23:25:17 tg Exp $'
d56 1
a56 1
    hexdump -ve '1/1 "\\0%o"')
d58 1
a58 1
    hexdump -ve '1/1 "\\0%o"')
d65 1
a65 1
# Copyright (c) 2007
d70 1
a70 1
# is granted to deal in this work without restriction, including un-
a73 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
d81 1
a81 1
# of said person's immediate fault when using the work as intended.
a93 1
	typeset -Uui8 vo
d102 2
a103 2
	(( pbs_thecode[pbs_curptr++] = 0x8C ))
	(( pbs_thecode[pbs_curptr++] = 0xCA ))
d112 1
d114 1
a114 2
		(( vo = pbs_thecode[pbs_curptr++] ))
		ostr="$ostr\\0${vo#8#}"
d174 2
a175 2
let i=0
print -nu2 "using $blktblnum blocks of size $((512 << sscale)): "
d177 1
a177 1
	print -nu2 "${blktblent[i++]} "
d189 1
a189 1
let i=0
@


1.5
log
@instead of hardcoding, just use the function part of this prep thing
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.4 2007/10/20 23:18:03 tg Exp $
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.4 2007/10/20 23:18:03 tg Exp $'
d145 1
a145 1
while getopts ":0S:" ch; do
d147 5
a151 1
	(0)	pbs_output 24 ;;
@


1.4
log
@the line
|        ${SUDO} disklabel -w ${VND} fakecdrom "MirOS BSD/sparc "
was missed from generating a sparc bootable CD for some time
use a dump of the pregenerated dual_chain.bin for option -0
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.3 2007/10/20 22:40:18 tg Exp $
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.3 2007/10/20 22:40:18 tg Exp $'
d92 36
d147 1
a147 1
	(0)	print -n '\0146\061\0300\0146\0120\0146\0235\05\0240\07\0216\0320\0274\0374\0377\0373\0120\0150\044\0\0216\0330\0216\0300\061\0377\0276\0\02\0271\0200\0\0363\0146\0245\0313\0270\01\02\0273\0\02\0271\031\0\0266\0\0140\0315\023\0141\0163\010\0140\061\0300\0315\023\0141\0353\0362\0352\0\0174\0\0\0220\0220\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0220\0220\0155\0154\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\01\0136\010\0\0\0\0\0\0\0\0\01\010\0\0\0\0\01\02\0200\0\0\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\024\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0332\0276\0125\0252' ;;
@


1.3
log
@add new flag -0: make this sector-0-based
(no-op for i386, prepends a couple of zeroes for sparc)
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.2 2007/10/20 20:25:32 tg Exp $
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.2 2007/10/20 20:25:32 tg Exp $'
d111 1
a111 1
	(0)	dd if=/dev/zero count=1 2>/dev/null ;;
@


1.2
log
@integer → typeset -i
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.1 2007/10/20 20:24:41 tg Exp $
d30 1
a30 1
rcsid='$MirOS: src/sys/arch/sparc/stand/bootxx/mkbxinst.sh,v 1.1 2007/10/20 20:24:41 tg Exp $'
d109 1
a109 1
while getopts ":S:" ch; do
d111 1
@


1.1
log
@a less shell-in-Makefile-embedded approach
@
text
@d2 1
a2 1
# $MirOS: src/sys/arch/sparc/stand/bootxx/bxinst.sh,v 1.10 2007/10/20 20:05:55 tg Exp $
d30 1
a30 1
rcsid='$MirOS$'
d123 1
a123 1
	integer blktblent[i++]=0
@

