head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2019.06.08.17.17.46;	author tg;	state Exp;
branches;
next	1.3;
commitid	1005CFBEDAB5D84AFDF;

1.3
date	2018.08.29.02.13.27;	author tg;	state Exp;
branches;
next	1.2;
commitid	1005B8601524E6F1A70;

1.2
date	2018.08.29.01.29.21;	author tg;	state Exp;
branches;
next	1.1;
commitid	1005B85F6F55EFF1088;

1.1
date	2018.08.29.01.19.11;	author tg;	state Exp;
branches;
next	;
commitid	1005B85F4A156426139;


desc
@@


1.4
log
@let explwp() also return the waypoint code, normalised
(e.g. fixup trailing / in Munzee, BC/EC leading zeroes
as well as xkcd Geohashing coordinate leading zeroes);
let it untaint in Perl
@
text
@my $rcsid = '$MirOS: www/files/wp.pm,v 1.2 2018/08/29 01:29:21 tg Exp $';
#-
# Copyright © 2018, 2019
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un‐
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.

use strict;
use warnings;

# generic HTML encode (&<>" but not ')
sub htmlencode($) {
	local ($_) = @@_;

	s/&/&amp;/g;
	s/</&lt;/g;
	s/>/&gt;/g;
	s/\"/&#34;/g;

	return $_;
}

# generic HTML and HTTP redirect
sub redirect($) {
	my ($dst) = @@_;
	my $enc = htmlencode($dst);

	print("Status: 301\r\nLocation: $dst\r\n");
	print("Content-Type: text/html; charset=UTF-8\r\n\r\n");
	print("<html><head><title>Redirection</title></head><body>\n");
	print("<h1>Redirection</h1>\n");
	print("<p>Please visit <a href=\"$enc\">$enc</a> instead!</p>\n");
	print("</body></html>\n");
	exit(0);
}

# generic Y-M-D date validity checker
sub chkdate($$$) {
	my ($y, $m, $d) = @@_;
	my @@mdays = (0,31,28,31,30,31,30,31,31,30,31,30,31);

	$mdays[2] = (($y % 4) == 0 && (($y % 100) != 0 || ($y % 400) == 0)) ?
	    29 : 28 if ($m == 2);

	return !($y < 1 || $y > 9999 || $m < 1 || $m > 12 || $d < 1 ||
	    $d > $mdays[$m]);
}

# generic waypoint code exploder (classifyer, wpcode, label, URL)
sub explwp($) {
	my ($wp) = @@_;
	my $s;
	return ("BC", sprintf("BC%d", $1), sprintf("BesserCacher#%d", $1), sprintf("https://bessercacher.de/forum/viewtopic.php?t=%d", $1)) if
	    ($wp =~ m!^BC(\d+)$!);
	return ("EC", $s, "$s", sprintf("http://extremcaching.com/index.php/output-2/%d", $1)) if
	    ($wp =~ m!^EC(\d+)$!) &&
	    ($s = sprintf("EC%d", $1)) ne '';
	return ("GA", "$1", "$1", "https://geocaching.com.au/cache/$1") if
	    ($wp =~ m!^(GA[0-9A-Z]{1,6})$!);
	return ("GC", "$1", "$1", "https://www.geocaching.com/seek/cache_details.aspx?wp=$1") if
	    ($wp =~ m!^(GC[0-9A-Z]{1,6})$!);
	return ("GD", "$1", "$1", "http://geodashing.gpsgames.org/cgi-bin/dp.pl?dp=$1") if
	    ($wp =~ m!^(GD[0-9A-Z]{2}-[A-Z]{4})$!);
	return ("GE", "$1", "$1", "http://geocaching.gpsgames.org/cgi-bin/ge.pl?wp=$1") if
	    ($wp =~ m!^(GE[0-9A-Z]{1,6})$!);
	return ("GG", "$1", "$1", "http://golf.gpsgames.org/cgi-bin/golf.pl?course=$1&coursedetails=Go") if
	    ($wp =~ m!^(GG[0-9A-Z]{1,6})$!);
	return ("GK", "GK$1", "GK$1", "https://geokrety.org/konkret.php?id=" . hex($1)) if
	    ($wp =~ m!^GK([0-9A-F]+)$!);
	return ("GL", "$1", "$1", "http://coord.info/$1") if
	    ($wp =~ m!^(GL[0-9A-Z]{1,6})$!);
	return ("NC", "N$1", "N$1", "http://www.navicache.com/cgi-bin/db/displaycache2.pl?CacheID=" . hex($1)) if
	    ($wp =~ m!^N([0-9][0-9A-F]{4})$!);
	return ("OB", "$1", "$1", "https://www.opencaching.nl/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OB[0-9A-Z]{1,6})$!);
	return ("OC", "$1", "$1", "https://www.opencaching.de/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OC[0-9A-Z]{1,6})$!);
	return ("OK", "$1", "$1", "https://opencache.uk/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OK[0-9A-Z]{1,6})$!);
	return ("OP", "$1", "$1", "https://opencaching.pl/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OP[0-9A-Z]{1,6})$!);
	return ("OR", "$1", "$1", "https://www.opencaching.ro/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OR[0-9A-Z]{1,6})$!);
	return ("OU", "$1", "$1", "http://www.opencaching.us/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OU[0-9A-Z]{1,6})$!);
	return ("OZ", "$1", "$1", "https://opencaching.cz/viewcache.php?wp=$1") if
	    ($wp =~ m!^(OZ[0-9A-Z]{1,6})$!);
	return ("PR", "$1", "$1", "http://coord.info/$1") if
	    ($wp =~ m!^(PR[0-9A-Z]{1,6})$!);
	return ("SH", "$1", "$1", "http://shutterspot.gpsgames.org/cgi-bin/sh.pl?wp=$1") if
	    ($wp =~ m!^(SH[0-9A-Z]{1,6})$!);
	return ("TB", "$1", "$1", "https://www.geocaching.com/track/details.aspx?tracker=$1") if
	    ($wp =~ m!^(TB[0-9A-Z]{1,6})$!);
	return ("TC", "$1", "$1", "https://play.terracaching.com/Cache/$1") if
	    ($wp =~ m!^([TLC]C[0-9A-Z]{1,6})$!);
	return ("VX", "$1", "$1", "http://geovexilla.gpsgames.org/cgi-bin/vx.pl?listwaypointlogs=yes&wp=$1") if
	    ($wp =~ m!^(VX[0-9A-Z]{2}-[A-Z]{4})$!);
	return ("WM", "$1", "$1", "http://www.waymarking.com/waymarks/$1") if
	    ($wp =~ m!^(WM[0-9A-Z]{1,6})$!);
	return ("m/", "$1", "$1", "https://www.munzee.com/$1/") if
	    ($wp =~ m!^(m/[0-9A-Za-z_-]+/[0-9]+)/?$!);
	return ("gh", "$s", "$s", "http://wiki.xkcd.com/geohashing/$s") if
	    ($wp =~ m!^(2[0-9]{3})-(0[1-9]|1[0-2])-([0-2][1-9]|[1-3][01])_(-?[0-9]{1,2})_(-?[0-9]{1,3})$! &&
	    chkdate($1, $2, $3) && $4 >= -90 && $4 <= 90 && $5 >= -180 && $5 <= 180) &&
	    ($s = sprintf("%04d-%02d-%02d_%d_%d", $1, $2, $3, $4, $5)) ne '';
	return ("Gh", "$s", "$s", "http://wiki.xkcd.com/geohashing/$s") if
	    ($wp =~ m!^(2[0-9]{3})-(0[1-9]|1[0-2])-([0-2][1-9]|[1-3][01])_global$! &&
	    chkdate($1, $2, $3)) &&
	    ($s = sprintf("%04d-%02d-%02d_global", $1, $2, $3)) ne '';
	return ("", "$wp", "$wp", "");
}

# substitution function; define a “chkwp” function to use this; skips Munzees
sub substwps($) {
	my ($s) = @@_;

	$s =~ s@@\b([BE]C\d+|(?:G[ACEGL]|O[BCKPRUZ]|PR|SH|TB|[TLC]C|WM)[0-9A-Z]{1,6}|(?:GD|VX)[0-9A-Z]{2}-[A-Z]{4}|(?:GK|N)[0-9A-F]+|2[0-9]{3}-[0-9]{2}-[0-9]{2}_(?:-?[0-9]{1,2}_-?[0-9]{1,3}|global))\b@@chkwp($1)@@eg;
	return $s;
}

1;
@


1.3
log
@add www/mk/wp.inc to clone-ish www/files/wp.pm
@
text
@d3 1
a3 1
# Copyright © 2018
d62 1
a62 1
# generic waypoint code exploder (classifyer, label, URL)
d65 2
a66 1
	return ("BC", "BesserCacher#$1", "https://bessercacher.de/forum/viewtopic.php?t=$1") if
d68 14
a81 13
	return ("EC", "$wp", "http://extremcaching.com/index.php/output-2/$1") if
	    ($wp =~ m!^EC(\d+)$!);
	return ("GA", "$wp", "https://geocaching.com.au/cache/$wp") if
	    ($wp =~ m!^GA[0-9A-Z]{1,6}$!);
	return ("GC", "$wp", "https://www.geocaching.com/seek/cache_details.aspx?wp=$wp") if
	    ($wp =~ m!^GC[0-9A-Z]{1,6}$!);
	return ("GD", "$wp", "http://geodashing.gpsgames.org/cgi-bin/dp.pl?dp=$wp") if
	    ($wp =~ m!^GD[0-9A-Z]{2}-[A-Z]{4}$!);
	return ("GE", "$wp", "http://geocaching.gpsgames.org/cgi-bin/ge.pl?wp=$wp") if
	    ($wp =~ m!^GE[0-9A-Z]{1,6}$!);
	return ("GG", "$wp", "http://golf.gpsgames.org/cgi-bin/golf.pl?course=$wp&coursedetails=Go") if
	    ($wp =~ m!^GG[0-9A-Z]{1,6}$!);
	return ("GK", "$wp", "https://geokrety.org/konkret.php?id=" . hex($1)) if
d83 3
a85 3
	return ("GL", "$wp", "http://coord.info/$wp") if
	    ($wp =~ m!^GL[0-9A-Z]{1,6}$!);
	return ("NC", "$wp", "http://www.navicache.com/cgi-bin/db/displaycache2.pl?CacheID=" . hex($1)) if
d87 27
a113 27
	return ("OB", "$wp", "https://www.opencaching.nl/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OB[0-9A-Z]{1,6}$!);
	return ("OC", "$wp", "https://www.opencaching.de/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OC[0-9A-Z]{1,6}$!);
	return ("OK", "$wp", "https://opencache.uk/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OK[0-9A-Z]{1,6}$!);
	return ("OP", "$wp", "https://opencaching.pl/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OP[0-9A-Z]{1,6}$!);
	return ("OR", "$wp", "https://www.opencaching.ro/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OR[0-9A-Z]{1,6}$!);
	return ("OU", "$wp", "http://www.opencaching.us/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OU[0-9A-Z]{1,6}$!);
	return ("OZ", "$wp", "https://opencaching.cz/viewcache.php?wp=$wp") if
	    ($wp =~ m!^OZ[0-9A-Z]{1,6}$!);
	return ("PR", "$wp", "http://coord.info/$wp") if
	    ($wp =~ m!^PR[0-9A-Z]{1,6}$!);
	return ("SH", "$wp", "http://shutterspot.gpsgames.org/cgi-bin/sh.pl?wp=$wp") if
	    ($wp =~ m!^SH[0-9A-Z]{1,6}$!);
	return ("TB", "$wp", "https://www.geocaching.com/track/details.aspx?tracker=$wp") if
	    ($wp =~ m!^TB[0-9A-Z]{1,6}$!);
	return ("TC", "$wp", "https://play.terracaching.com/Cache/$wp") if
	    ($wp =~ m!^[TLC]C[0-9A-Z]{1,6}$!);
	return ("VX", "$wp", "http://geovexilla.gpsgames.org/cgi-bin/vx.pl?listwaypointlogs=yes&wp=$wp") if
	    ($wp =~ m!^VX[0-9A-Z]{2}-[A-Z]{4}$!);
	return ("WM", "$wp", "http://www.waymarking.com/waymarks/$wp") if
	    ($wp =~ m!^WM[0-9A-Z]{1,6}$!);
	return ("m/", "$1", "https://www.munzee.com/$1/") if
d115 1
a115 1
	return ("gh", "$wp", "http://wiki.xkcd.com/geohashing/$wp") if
d117 3
a119 2
	    chkdate($1, $2, $3) && $4 >= -90 && $4 <= 90 && $5 >= -180 && $5 <= 180);
	return ("Gh", "$wp", "http://wiki.xkcd.com/geohashing/$wp") if
d121 3
a123 2
	    chkdate($1, $2, $3));
	return ("", "$wp", "");
@


1.2
log
@fix EC RE, drop OX from subst RE and make it more precise, document it skips Munzees, add more test cases
@
text
@d1 1
a1 1
my $rcsid = '$MirOS: www/files/wp.pm,v 1.1 2018/08/29 01:19:11 tg Exp $';
d112 1
a112 1
	    ($wp =~ m!^(m/[0-9A-Za-z_-]*/[0-9]+)/?$!);
@


1.1
log
@share into a module and carry the test vectors
@
text
@d1 1
a1 1
my $rcsid = '$MirOS: www/files/wp.cgi,v 1.26 2018/08/29 00:48:46 tg Exp $';
d68 1
a68 1
	    ($wp =~ m!^EC([0-9A-Z]{1,6})$!);
d122 1
a122 1
# substitution function; define a “chkwp” function to use this
d126 1
a126 1
	$s =~ s@@\b((?:[BETLC]C|G[ACEGKL]|O[BCKPRUXZ]|PR|SH|TB|WM|N[0-9])[0-9A-Z]{1,6}|(?:GD|VX)[0-9A-Z]{2}-[A-Z]{4}|2[0-9]{3}-[0-9]{2}-[0-9]{2}_(?:-?[0-9]{1,2}_-?[0-9]{1,3}|global))\b@@chkwp($1)@@eg;
@

