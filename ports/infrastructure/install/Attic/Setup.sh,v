head	1.16;
access;
symbols;
locks; strict;
comment	@# @;


1.16
date	2005.09.12.22.53.17;	author tg;	state dead;
branches;
next	1.15;
commitid	6e6c432606e897b6;

1.15
date	2005.09.02.13.43.04;	author bsiegert;	state Exp;
branches;
next	1.14;
commitid	6b01431856ab5899;

1.14
date	2005.08.20.12.33.48;	author tg;	state Exp;
branches
	1.14.2.1;
next	1.13;
commitid	1bdf4307228d6819;

1.13
date	2005.07.18.20.12.02;	author tg;	state Exp;
branches;
next	1.12;
commitid	97742dc0d0b5376;

1.12
date	2005.07.05.20.25.59;	author tg;	state Exp;
branches;
next	1.11;
commitid	1bd242caecc5f2fa;

1.11
date	2005.06.03.00.14.14;	author tg;	state Exp;
branches;
next	1.10;
commitid	6921429fa069b452;

1.10
date	2005.06.02.20.35.47;	author tg;	state Exp;
branches;
next	1.9;
commitid	ee3429f6d8a7248;

1.9
date	2005.05.30.16.47.09;	author tg;	state Exp;
branches;
next	1.8;
commitid	4fc6429b436d42cb;

1.8
date	2005.05.21.18.08.39;	author tg;	state Exp;
branches;
next	1.7;
commitid	6e11428f7933a675;

1.7
date	2005.05.21.17.33.15;	author tg;	state Exp;
branches;
next	1.6;
commitid	4a60428f70cef574;

1.6
date	2005.05.21.03.09.58;	author tg;	state Exp;
branches;
next	1.5;
commitid	5165428ea684795c;

1.5
date	2005.05.21.01.52.45;	author tg;	state Exp;
branches;
next	1.4;
commitid	40ac428e942d99b5;

1.4
date	2005.05.21.00.16.02;	author tg;	state Exp;
branches;
next	1.3;
commitid	2ef4428e7c341292;

1.3
date	2005.04.20.22.24.27;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.19.19.31.41;	author bsiegert;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.1.7.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches;
next	;

1.14.2.1
date	2005.08.21.11.17.53;	author tg;	state Exp;
branches;
next	1.14.2.2;
commitid	63fa430862e721e6;

1.14.2.2
date	2005.08.21.11.51.54;	author tg;	state Exp;
branches;
next	1.14.2.3;
commitid	2a7d43086aca81b0;

1.14.2.3
date	2005.08.21.16.58.43;	author tg;	state Exp;
branches;
next	1.14.2.4;
commitid	6e754308b2ae8c0f;

1.14.2.4
date	2005.08.21.17.12.49;	author tg;	state Exp;
branches;
next	1.14.2.5;
commitid	359d4308b6050589;

1.14.2.5
date	2005.08.21.17.30.22;	author tg;	state Exp;
branches;
next	1.14.2.6;
commitid	a774308ba2a844b;

1.14.2.6
date	2005.08.21.17.40.11;	author tg;	state Exp;
branches;
next	1.14.2.7;
commitid	782d4308bc5f8a65;

1.14.2.7
date	2005.08.21.17.45.10;	author tg;	state Exp;
branches;
next	1.14.2.8;
commitid	15544308bdb1bec3;

1.14.2.8
date	2005.08.21.17.48.46;	author tg;	state Exp;
branches;
next	1.14.2.9;
commitid	1cfa4308be8b3e93;

1.14.2.9
date	2005.08.21.17.58.37;	author tg;	state Exp;
branches;
next	1.14.2.10;
commitid	577c4308c0dbb101;

1.14.2.10
date	2005.08.21.18.07.51;	author tg;	state Exp;
branches;
next	1.14.2.11;
commitid	3f6a4308c306e227;

1.14.2.11
date	2005.08.21.18.32.49;	author tg;	state Exp;
branches;
next	1.14.2.12;
commitid	7fc64308c8e188af;

1.14.2.12
date	2005.08.21.18.33.58;	author tg;	state Exp;
branches;
next	1.14.2.13;
commitid	7c0b4308c9043bb2;

1.14.2.13
date	2005.08.21.18.46.58;	author tg;	state Exp;
branches;
next	1.14.2.14;
commitid	57ae4308cc28ff70;

1.14.2.14
date	2005.08.21.18.56.55;	author tg;	state Exp;
branches;
next	1.14.2.15;
commitid	3a634308cdf29d60;

1.14.2.15
date	2005.08.21.19.02.55;	author tg;	state Exp;
branches;
next	1.14.2.16;
commitid	3e6b4308cfee1c89;

1.14.2.16
date	2005.09.01.21.57.43;	author tg;	state Exp;
branches;
next	1.14.2.17;
commitid	71204317792756b6;

1.14.2.17
date	2005.09.01.21.59.46;	author tg;	state Exp;
branches;
next	1.14.2.18;
commitid	73ac431779e240d9;

1.14.2.18
date	2005.09.11.00.49.37;	author tg;	state Exp;
branches;
next	1.14.2.19;
commitid	7a1e43237f292c25;

1.14.2.19
date	2005.09.11.15.07.50;	author tg;	state Exp;
branches;
next	1.14.2.20;
commitid	77d14324480b2792;

1.14.2.20
date	2005.09.12.20.10.09;	author tg;	state Exp;
branches;
next	1.14.2.21;
commitid	21164325e08e0b44;

1.14.2.21
date	2005.09.12.20.13.23;	author tg;	state Exp;
branches;
next	1.14.2.22;
commitid	f574325e160d800;

1.14.2.22
date	2005.09.12.20.15.48;	author tg;	state dead;
branches;
next	;
commitid	7ea84325e1c462f6;


desc
@@


1.16
log
@join tg-ports-devel branch into HEAD
@
text
@#!/bin/mksh
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.15 2005/09/02 13:43:04 bsiegert Exp $
#-
# Copyright (c) 2004, 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
#-
# MirPorts Framework - Installation script
#
# What does this thing do?
# 1) detect which OS we are running on
# 2) build and install package tools to /usr/mpkg/sbin
# 3) patch <bsd.sys.mk> if necessary; other upgrade stuff
# 4) install generic makefile includes
#    and, if necessary, mirports.osdep.mk
# 5) patch /etc/mk.conf
# 6) augment user and group list

print "1. Detecting environment..."

function f_start
{
	cat >>$1 |&
}

function f_end
{
	exec 3>&p; exec 3>&-
}

cd $(dirname $0)
top=$(cd ../..; pwd)
ti=$top/infrastructure
if os="$(uname -M 2>/dev/null)"; then
	os=${os%% *}
else
	os="$(uname -s)"
fi
osver=$(uname -r | sed 's/\./_/')
[[ -z $SHELL ]] && SHELL=/bin/mksh
export SHELL

if ! tmp=$(mktemp /tmp/mirports.XXXXXXXXXX); then
	print cannot make temporary file
	exit 1
fi

trap 'rm -f $tmp ; exit 0' 0
trap 'rm -f $tmp ; exit 1' 1 2 3 13 15

if [[ $os = Interix ]]; then
	BINOWN=$(cd ../db; make ___DISPLAY_MAKEVARS=BINOWN SHOW_ONLY=1)
	BINGRP=$(cd ../db; make ___DISPLAY_MAKEVARS=BINGRP SHOW_ONLY=1)
else
	BINOWN=root
	BINGRP=bin
fi

if ! chown $BINOWN $tmp; then
	print need root
	exit 1
fi

cp $ti/templates/fake.mtree $ti/db/
has_stamp=0

case $os in
Darwin)
	localbase=/usr/mpkg
	sysmk=$localbase/share/mmake
	mtar=$localbase/bin/tar
	pkgbin=$localbase/sbin

	if [[ -d $localbase/distfiles || -d $localbase/Distfiles ]]; then
		if [[ -e $localbase/distfiles/.stamp \
		    || -e $localbase/Distfiles/.stamp ]]; then
			has_stamp=1
		else
			has_stamp=0
		fi
	else
		mkdir -p $localbase/Distfiles
		print -n >$localbase/Distfiles/.stamp
		has_stamp=1
	fi

	cat $ti/db/fake.mtree >$tmp
	(print '/@@@@local/d\ni\n'; IFS=/; s=;
	 for pc in $(print "$localbase"); do
		s="$s    "; print "$s$pc"
	 done; print '.\nwq') | ed -s $tmp
	mtree -U -e -d -n -p / -f $tmp
	mkdir -p $localbase/{db/pkg,etc}
	if ! fgrep $localbase /etc/profile >/dev/null 2>&1; then
		f_start /etc/profile
		print -p "export MANPATH=\$(manpath -q):$localbase/man"
		print -p "export PATH=$localbase/bin:\$PATH"
		f_end
	fi
	export PATH=$localbase/bin:$PATH
	;;
Interix)
	localbase=/usr/mpkg
	sysmk=/usr/share/make
	mtar=/bin/tar
	pkgbin=/usr/sbin

	print 'g/[ug]name=[a-z]*/s///g\n'"/^.set/s/   /" \
	    "uname=$BINOWN gname=$BINGRP /\nwq" \
	    | ed -s $ti/db/fake.mtree
	cat $ti/db/fake.mtree >$tmp
	(print '/@@@@local/d\ni\n'; IFS=/; s=;
	 for pc in $(print "$localbase"); do
		s="$s    "; print "$s$pc"
	 done; print '.\nwq') | ed -s $tmp
	/usr/sbin/mtree -U -e -d -n -p / -f $tmp
	mkdir -p $localbase/{db/pkg,etc}
	;;
MirBSD)
	localbase=/usr/mpkg
	sysmk=/usr/share/mk
	mtar=/bin/tar
	pkgbin=$localbase/sbin

	ospl=$(uname -l | sed -e 's/^#//' -e 's/-.*$//' -e 's/^\(.\)./\1_/')
	ospm=${ospl%_*}
	ospl=${ospl#*_}
	# test is ancient -current or older, or modern
	if [[ $ospm -gt 7 ]]; then
		mirosnew=1
	else
		mirosnew=0
	fi
	( cd /usr/lib;
	  [[ -e libresolv.a && ! -e libdl.a ]] \
	    && ln libresolv.a libdl.a; \
	  [[ -e libexpat.so.0.0 && ! -e libexpat.so.4.0 ]] \
	    && ln -s libexpat.so.0.0 libexpat.so.4.0; \
	  for a in libpng.so.[01].*; do \
		b="$a"; \
		[[ -e $b ]] || b=nein; \
	  done; \
	  [[ $b != nein && ! -e libpng.so.4.0 ]] && ln -s $b libpng.so.4.0 )
	;;
OpenBSD)
	localbase=/usr/mpkg
	sysmk=/usr/share/mk
	mtar=/bin/tar
	pkgbin=$localbase/sbin

	( cd /usr/lib;
	  [[ -e libresolv.a && ! -e libdl.a ]] \
	    && ln libresolv.a libdl.a )
	;;
*)
	print No support for the $os operating system.
	exit 1
	;;
esac

( cd $pkgbin
  rm -f mirports_tar
  print "#!$SHELL" >mirports_tar
  print "exec $mtar "'"$@@"' >>mirports_tar
  chmod 555 mirports_tar
)

# detect compiler version and if it's GCC
if gv=$($ourCC -v 2>&1 | grep '/specs$'); then
	gv=${gv%/specs}
	gv=${gv##*/}
else
	gv=no
fi

print "2. Building package tools..."

cd $ti/pkgtools
rm -rf */obj
set -e
$MAKE cleandir
$MAKE obj
$MAKE cleandir
if [[ $os = Darwin ]]; then
	$MAKE depend INCS='-I/usr/mpkg/share/mmake'
	$MAKE PORTABLE=yes NEW_LOCALBASE=$localbase \
	    INCS='-I/usr/mpkg/share/mmake' \
	    LIBS=/usr/mpkg/share/mmake/libmirmake.a
elif [[ $os = Interix ]]; then
	$MAKE depend
	$MAKE PORTABLE=yes NEED_COMPAT=yes NEW_LOCALBASE=$localbase \
	    LIBS='-L\${.SYSMK} -lmirmake -ldb'
elif [[ $os = MirBSD ]]; then
	$MAKE depend
	if [[ $mirosnew = 1 ]]; then
		$MAKE NEW_LOCALBASE=$localbase
	else
		$MAKE PORTABLE=yes NEW_LOCALBASE=$localbase
	fi
elif [[ $os = OpenBSD ]]; then
	$MAKE depend
	$MAKE PORTABLE=yes NEW_LOCALBASE=$localbase
fi
$MAKE install PREFIX=$localbase MANDIR=$localbase/man/cat
set +e
rm -rf */obj

print -n "3. a) Patching <bsd.sys.mk>..."

if grep '\.ifndef.TRUEPREFIX' $sysmk/bsd.sys.mk >/dev/null 2>&1; then
	print not needed.
else
	if patch $sysmk/bsd.sys.mk \
	    $ti/install/patch-bsd_sys_mk; then
		print done.
		rm -f $sysmk/bsd.sys.mk.orig
	else
		print failed.
		exit 1
	fi
fi

if [[ $SHELL != /bin/mksh ]]; then
	print -n "3. b) Patching infrastructure..."
	for f in $ti/db/*; do
		[[ -f $f ]] || continue
		print "1g!/bin/mksh!s!!$SHELL!\nwq" | ed -s $f
		chmod a+x $f
	done
	print done.
fi

if [[ -d $top/distfiles && $has_stamp = 0 ]]; then
	print -n "3. c) Upgrading..."
	mv $top/distfiles $top/Distfiles
	rm -rf $top/packages
	print done.
	let x="$(pkg_info | wc -l)"
	(( x > 0 )) && \
	    print 'WARNING: You *must* de-install _all_ packages *NOW*!'
fi

print -n "4. Installing MirPorts system makefile includes..."

case $os in
Darwin)
	if ! install -c -o root -g wheel -m 644 \
	    $ti/install/mirports.osdep.mk-darwin \
	    $ti/mk/mirports.osdep.mk; then
		print failed.
		exit 1
	fi
	;;
Interix)
	if ! install -c -m 644 \
	    $ti/install/mirports.osdep.mk-interix \
	    $ti/mk/mirports.osdep.mk; then
		print failed.
		exit 1
	fi
	;;
MirBSD)
	if [[ $mirosnew = 0 ]]; then
		if ! install -c -o root -g wsrc -m 664 \
		    $ti/install/mirports.osdep.mk-mbsd \
		    $ti/mk/mirports.osdep.mk; then
			print failed.
			exit 1
		fi
	else
		rm -f $ti/mk/mirports.osdep.mk
	fi
	;;
OpenBSD)
	if ! install -c -o root -g wsrc -m 664 \
	    $ti/install/mirports.osdep.mk-obsd \
	    $ti/mk/mirports.osdep.mk; then
		print failed.
		exit 1
	fi
	;;
esac

if install -c -o $BINOWN -g $BINGRP -m 444 \
    $ti/install/*.mk $sysmk/; then
	print done.
else
	print failed.
	exit 1
fi

print -n "5. Preparing /etc/mk.conf..."

touch /etc/mk.conf
if fgrep '#@@@@MIRPORTS start' /etc/mk.conf >/dev/null 2>&1; then
	ed -s /etc/mk.conf 2>/dev/null <<-EOF
		/#@@@@MIRPORTS start/,/#@@@@MIRPORTS end/c
		#@@@@MIRPORTS deleteme
		.
		w
		+g/^$/d
		-,.g/#@@@@MIRPORTS deleteme/d
		wq
	EOF
	print 'g/#@@@@MIRPORTS deleteme/d\nwq' | ed -s /etc/mk.conf
fi

f_start /etc/mk.conf
if ! fgrep '#@@@@MIRPORTS user1' /etc/mk.conf >/dev/null 2>&1; then
	print -p '#@@@@MIRPORTS user1'
	print -p '### Options for MirPorts (recommended)'
	print -p '# make clean descends into dependencies'
	print -p '# is overriden by certain ports though'
	print -p 'CLEANDEPENDS?=		yes'
	print -p '# install all subpackages by default on make install'
	print -p '# NOTE: earlier MirPorts versions defaulted to off!'
	print -p '#PREFER_SUBPKG_INSTALL?=no	# default: yes'
	print -p
fi

print -p '#@@@@MIRPORTS start'
print -p
print -p "_CC_IS_GCC=		$gv"
print -p

case $os in
Darwin)
	print -p "PORTSDIR=		$top"
	;;
Interix)
	print -p "PORTSDIR=		$top"
	;;
MirBSD)
	# nothing else here yet
	;;
OpenBSD)
	if [[ $top != /usr/ports ]]; then
		print -p "USE_MIRPORTS?=\t	yes"
		print -p
		print -p '.if ${USE_MIRPORTS:L} == "yes"'
		print -p "PORTSDIR=		$top"
		print -p ".else"
		print -p "PORTSDIR=		/usr/ports"
		print -p ".endif"
	fi
	;;
esac

print -p '#@@@@MIRPORTS end'
print -p
f_end
print done.

print -n "6. Augmenting user and group database..."

if [[ $os = @@(Open|Mir)BSD ]]; then
	$SHELL $ti/scripts/mkuserdb
	print done.
else
	print not supported on $os, please do so manually!
fi

cat <<EOF

================================================
               Congratulations!
------------------------------------------------
 Your MirPorts Framework system is now set up
 completely and ready to run.
 If you have not yet done so, read the README
 file appropriate for your operating system for
 further information about how to use MirPorts:
 $ti/compat/README.${os}
================================================

EOF
exit 0
@


1.15
log
@Change libhash.a to libmirmake.a for Darwin. This has been gone unnoticed
way too long. Does anybody ever use this?

Discovered while doing a new install of MirPorts on my brand-new, shining
Mac Mini :).
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.13 2005/07/18 20:12:02 tg Exp $
@


1.14
log
@half-hearted attempt to unify LOCALBASE to /usr/mpkg for all platforms
agreed some time ago bsiegert@@
no veto on miros-discuss@@

for now, hardcode PREFIX to /usr/local for imake and old-install ports
(we should probably do something about imake anyway, regarding both
Interix and Darwin - maybe require our own XFree86® port, but later...)

some of the code (especially shell and make) will be rewritten now,
since it can be simplified (nuking bugs, maybe)

what about changing /etc/mk.conf as well (conflict with obsd and maybe
others)? I think of /etc/${MAKE}.cfg (MAKE=make or mmake) maybe?

please test, as usual...
@
text
@d206 1
a206 1
	    LIBS=/usr/mpkg/share/mmake/libhash.a
@


1.14.2.1
log
@simplify pkgtools build
XXX move mbcompat into mirmake?
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14 2005/08/20 12:33:48 tg Exp $
d202 11
a212 2
$MAKE depend
if [[ $os = MirBSD ]]; then
d214 1
a214 1
		$MAKE
d216 1
a216 1
		$MAKE PORTABLE=yes
d218 3
a220 2
else
	$MAKE
d222 1
a222 1
$MAKE install
@


1.14.2.2
log
@mk.conf changes
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.1 2005/08/21 11:17:53 tg Exp $
d34 1
a34 1
# 5) patch /etc/${MAKE}.cfg
a68 2
makecfg=/etc/$(cd ../db; make ___DISPLAY_MAKEVARS=MAKE:T SHOW_ONLY=1).cfg

d300 1
a300 1
print -n "5. Preparing ${makecfg}..."
d302 3
a304 3
touch $makecfg
if fgrep '#@@@@MIRPORTS start' $makecfg >/dev/null 2>&1; then
	ed -s $makecfg 2>/dev/null <<-EOF
d313 1
a313 1
	print 'g/#@@@@MIRPORTS deleteme/d\nwq' | ed -s $makecfg
d316 2
a317 2
f_start $makecfg
if ! fgrep '#@@@@MIRPORTS user1' $makecfg >/dev/null 2>&1; then
@


1.14.2.3
log
@this is how the new Setup.sh will look like
six kilos for just installing mksh... everything else be in setup.ksh
but hey, it divines the mirror, can handle gzsig, and much more!
@
text
@d1 2
a2 2
#!/bin/sh
# $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $
d4 1
a4 1
# Copyright (c) 2005
d26 57
a82 2
# This script installs mksh if needed, then calls setup.ksh with it.
# On Interix, nroff is also installed first.
d84 16
a99 32
# Constants
#mksh_ver=24 # unused
mksh_date="24 2005/08/21"
mksh_dist=mksh-R24b.cpio.gz
mksh_path=mir/mksh/$mksh_dist
mksh_md5="MD5 ($mksh_dist) = 48d0df73eba1ef4e9c0758f69262eb66"
mksh_sum="240923212 224290 $mksh_dist"
mksh_md5sum="48d0df73eba1ef4e9c0758f69262eb66  $mksh_dist"
mirror="${1:-http://mirbsd.mirsolutions.de/MirOS/dist/}"

# Divine a fetching utility
fetch=false
if [ -n "$SFUDIR" -o -n "$OPENNT_ROOT" ]; then
	# Interix: check for Weihenstephan wget
	if [ -x /dev/fs/C/usr/local/wbin/wget.exe ]; then
		fetch="runwin32 c:/usr/local/wbin/wget.exe"
	fi
fi
if [ "$fetch" = false ]; then
	# Check for ftp/wget/fetch
	for dir in /usr/mpkg/bin /usr/local/bin /bin /usr/bin; do
		if [ -x $dir/wget ]; then
			fetch=$dir/wget
			break
		fi
		if [ -x $dir/fetch ]; then
			fetch=$dir/fetch
			break
		fi
		if [ -x $dir/ftp ]; then
			fetch=$dir/ftp
			break
d101 52
d154 40
a194 1
export fetch mirror
d196 14
a209 9
# Check for Interix
if [ -n "$SFUDIR" -o -n "$OPENNT_ROOT" ]; then
	# We know /bin/ksh is sufficient
	# Check for nroff
	if [ ! -x /usr/bin/nroff ]; then
		set -e
		OVERRIDE_MKSH=/bin/ksh SHELL=/bin/ksh \
		    /bin/ksh `dirname $0`/setup.ksh -i
		set +e
d211 2
d214 5
d220 10
a229 30
# Look if this is a sufficient mksh, search for one
ms=false
for s in $SHELL /bin/mksh; do
	# This is from MirMake; it ensures mksh R24 or higher
	t="`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(2[4-9]|[3-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9]) ]]; then echo yes; else echo no; fi' 2>/dev/null`"
	if [ x"$t" = x"yes" ]; then
		ms=$s
		break
	fi
done

# If suitable mksh found, retrieve its version number
if [ x"$ms" != x"false" ]; then
	old=no
#	t="`$ms -c 'x=${KSH_VERSION#*KSH?R}; print ${x%% *}'`"
#	# first check version, then date
#	if [ $t -lt $mksh_ver ]; then
#		old=yes
#	fi
	# check if date matches
	t="`$ms -c 'print ${KSH_VERSION#*KSH?R}'`"
	if [ x"$t" != x"$mksh_date" ]; then
		old=yes
	fi
	# If old, check if we can upgrade
	if [ $old = yes -a x"$UPGRADE" != "no" ]; then
		# But use it as build shell
		SHELL="$ms"
		# Fake no suitable mksh found
		ms=false
d233 28
a260 14
# If no suitable mksh found, or too old, build one,
# else jump to the "real" set-up script
if [ x"$ms" != x"false" ]; then
	SHELL="$ms"; export SHELL
	exec $ms `dirname $0`/setup.ksh
	echo Warning: executing old mksh failed! >&2
fi

# Divine a temporary directory
if ! T=$(mktemp -d /tmp/mirports.XXXXXXXXXX); then
	# May be Interix without mktemp.sh
	T=/tmp/mirports.$$
	if [ -d $T ]; then
		echo Cannot generate temporary directory! >&2
d263 6
a268 2
	if ! mkdir -p $T; then
		echo Cannot generate temporary directory! >&2
a270 7
fi

# Download mksh
cd $T
case "$mirror" in
/*)	# file
	cp $mirror/$mksh_path .
d272 19
a290 2
*)	# http
	$fetch $mirror$mksh_path
a292 26
sum=good
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAoEAy5akQiuw0znRhMD0djgQ7BiUPahG1QHJb9ZNApd6D5OnV98FO8Ofbfm4CF1Cvwr+IPnyKyPglQnaFgHF3LVynKMYSupKXnd0JrBR79TBmIVImBnIaTPcApRdWZEbMW5IdYhrWFHKlzk4vDxBXdcVE6QfiemWsYqkiuoJvLTLHXq7WUCQ5z7KuQetMnnP2bswV8SZuYy0IvzQRBVJbiTQzBvsHfyZUERLBZvjtPE9jTaLdTOkKvCuhuTzQAMmG8aYFt9S0p1K20eCCgWvJ5vu3ir875yBrtVPl2VzdFdo7Wv3kg1HOV+Sy7dQ2bIJ52mV8CnHI1W+ZMEjzQ64m75wH/AGsVb35E0sPJzFNCGj//8/kyKxRR1I0DSDOb+iE48twOrBRrUF5+ApwocqVdIa//Cbe1ArjzrEhwaKY0SitPcFwbVV8XadtsHXfdM5QnFwTsNobk2w+XLt9I5yL/SdE1NVVXBsAN1nejzDo8XTheD6o/m5O29WO3MSS7jt1PCYItVjN4ONK/Ztaa+zQcNK9itMy2tEJ1R/gI+AipOQi0JaHHAjcdYKxDbbJpurJAHvtLvKiJNqNUJPGpqCSfL8YqmDwf3Gs1SntRjgZNeOpAdiHl2qUewcB2vujROmLTQgxJ2HJTK8hKr+2nkZdEMkYYQ/wDtsGYohokU1GOGTjdr5d2vXW8MAWaF5UQDXQzPCT4RGjDLfvod4SM+GHn8t2eDJH8uHvUPU6AXcohM30zw/h9FPf18q7Oo0srwFpc0qjvwDxl9lgilsfaL23K2V5YFeTkO1llxnRdsTmSZ7UMsugBFu5bjGEL4hC/Sml0oH9F8hiV50fXWetsQvNB637Q==' >key
if gzsig -q verify key $mksh_dist 2>/dev/null; then
	:
elif s="`md5 $mksh_dist 2>/dev/null`"; then
	[ x"$s" = x"$mksh_md5" ] || sum=bad
elif s="`cksum $mksh_dist 2>/dev/null`"; then
	[ x"$s" = x"$mksh_sum" ] || sum=bad
elif s="`md5sum $mksh_dist 2>/dev/null`"; then
	[ x"$s" = x"$mksh_md5sum" ] || sum=bad
else
	echo Warning: Cannot check sum of $mksh_dist >&2
	echo Please compare the following two lines manually! >&2
	echo ': -r--r--r--  1 tg  miros-cvsall  224290 Aug 21 13:08 mksh-R24b.cpio.gz' >&2
	echo ": `/bin/ls -l $mksh_dist`" >&2
	echo Press RETURN to continue! >&2
	read s
fi

if [ $sum = bad ]; then
	echo Checksum verification failed! >&2
	echo "false: $s" >&2
	cd
	rm -rf $T
	exit 1
fi
d294 5
a298 5
# Extract and build mksh
if ! gzip -dc $mksh_dist | cpio -id; then
	echo Build failed! >&2
	cd
	rm -rf $T
d302 1
a302 9
cd mksh
if ! SHELL="${SHELL:-/bin/sh}" ${SHELL:-/bin/sh} ./Build.sh; then
	if ! SHELL="${SHELL:-/bin/sh}" ${SHELL:-/bin/sh} ./Build.sh -d -r; then
		echo Build failed! >&2
		cd
		rm -rf $T
		exit 1
	fi
fi
d304 51
a354 18
if [ ! -x mksh ]; then
	echo Build failed! >&2
	cd
	rm -rf $T
	exit 1
fi

# Install mksh
set -e
rm -f /bin/mksh.$$.1
install -c -s -m 555 mksh /bin/mksh.$$.1
mv /bin/mksh /bin/mksh.$$.2 && mv /bin/mksh.$$.1 /bin/mksh
set +e
if ! rm /bin/mksh.$$.2; then
	if ! mv /bin/mksh.$$.2 /tmp/deleteme.$$; then
		echo Warning: remove /bin/mksh.$$.2 later! >&2
	else
		echo Don't forget to clean up /tmp/deleteme.$$ >&2
d356 2
a357 1
fi
d359 12
a370 8
# Install some kind of man page
s=0
if [ -s mksh.cat1 ]; then
	install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.0 \
	    && s=1
fi
if [ $s = 0 ]; then
	install -c -m 444 mksh.1 /usr/share/man/man1/mksh.1
d373 1
a373 3
# Clean up
cd
rm -rf $T
d375 10
a384 3
# Jump into final script
SHELL=/bin/mksh; export SHELL
SHELL=/bin/mksh exec /bin/mksh `dirname $0`/setup.ksh
d386 2
a387 3
# This line is never run
echo Could not call mksh on setup.ksh >&2
exit 2
@


1.14.2.4
log
@expose temporary directory and the gzsig(1) public key to setup.ksh
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.3 2005/08/21 16:58:43 tg Exp $
a65 16
# Divine a temporary directory
if ! T=$(mktemp -d /tmp/mirports.XXXXXXXXXX); then
	# May be Interix without mktemp.sh
	T=/tmp/mirports.$$
	if [ -d $T ]; then
		echo Cannot generate temporary directory! >&2
		exit 1
	fi
	if ! mkdir -p $T; then
		echo Cannot generate temporary directory! >&2
		exit 1
	fi
fi
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAoEAy5akQiuw0znRhMD0djgQ7BiUPahG1QHJb9ZNApd6D5OnV98FO8Ofbfm4CF1Cvwr+IPnyKyPglQnaFgHF3LVynKMYSupKXnd0JrBR79TBmIVImBnIaTPcApRdWZEbMW5IdYhrWFHKlzk4vDxBXdcVE6QfiemWsYqkiuoJvLTLHXq7WUCQ5z7KuQetMnnP2bswV8SZuYy0IvzQRBVJbiTQzBvsHfyZUERLBZvjtPE9jTaLdTOkKvCuhuTzQAMmG8aYFt9S0p1K20eCCgWvJ5vu3ir875yBrtVPl2VzdFdo7Wv3kg1HOV+Sy7dQ2bIJ52mV8CnHI1W+ZMEjzQ64m75wH/AGsVb35E0sPJzFNCGj//8/kyKxRR1I0DSDOb+iE48twOrBRrUF5+ApwocqVdIa//Cbe1ArjzrEhwaKY0SitPcFwbVV8XadtsHXfdM5QnFwTsNobk2w+XLt9I5yL/SdE1NVVXBsAN1nejzDo8XTheD6o/m5O29WO3MSS7jt1PCYItVjN4ONK/Ztaa+zQcNK9itMy2tEJ1R/gI+AipOQi0JaHHAjcdYKxDbbJpurJAHvtLvKiJNqNUJPGpqCSfL8YqmDwf3Gs1SntRjgZNeOpAdiHl2qUewcB2vujROmLTQgxJ2HJTK8hKr+2nkZdEMkYYQ/wDtsGYohokU1GOGTjdr5d2vXW8MAWaF5UQDXQzPCT4RGjDLfvod4SM+GHn8t2eDJH8uHvUPU6AXcohM30zw/h9FPf18q7Oo0srwFpc0qjvwDxl9lgilsfaL23K2V5YFeTkO1llxnRdsTmSZ7UMsugBFu5bjGEL4hC/Sml0oH9F8hiV50fXWetsQvNB637Q== Thorsten "mirabile" Glaser <tg@@MirBSD.org> SIGN' >$T/signkey
tempdir=$T; export tempdir

d119 14
d144 2
a145 1
if gzsig -q verify signkey $mksh_dist 2>/dev/null; then
d220 2
a221 2
cd $T
rm -rf mksh
@


1.14.2.5
log
@some portable shell programming (more to follow)
we don't run under Ultrix and stuff like that, but it doesn't
hurt to exercise some sh programming from time to time
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.4 2005/08/21 17:12:49 tg Exp $
d37 1
a37 7

mirror="${1:-http://mirbsd.mirsolutions.de/MirOS/dist/}"; export mirror

# Are we Interix?
interix=no
test -n "$SFUDIR" && interix=yes
test -n "$OPENNT_ROOT" && interix=yes
d41 5
a45 4
if test $interix = yes; then
	# check for Weihenstephan wget
	test -x /dev/fs/C/usr/local/wbin/wget.exe && \
	    fetch="runwin32 c:/usr/local/wbin/wget.exe"
d47 1
a47 1
if test x"$fetch" = x"false"; then
d50 1
a50 1
		if test -x $dir/wget; then
d54 1
a54 1
		if test -x $dir/fetch; then
d58 1
a58 1
		if test -x $dir/ftp; then
d64 1
a64 1
export fetch
@


1.14.2.6
log
@add a PATH divination

XXX we should use this path as _PORTPATH (prepend WRKDIR/bin tho)
XXX revisit this when XFree86 becomes a port
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.5 2005/08/21 17:30:22 tg Exp $
a29 2
localbase=/usr/mpkg

a44 39
# Set the PATHs
if test $interix = no; then
	p=$localbase/bin
	for a in /usr/local/bin /usr/X11R6/bin /usr/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	PATH=$p; export $PATH
else
	# On Interix, /usr/bin is /bin; gzip lives in /usr/contrib/bin;
	# gcc has yet its own directory; we have X11R5 as well
	p=$localbase/bin
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin /usr/X11R6/bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	test -n "$PATH_WINDOWS" && p=$p:/usr/contrib/win32/bin:$PATH_WINDOWS
	test -d /usr/X11R5/bin && p=$p:/usr/X11R5/bin
	PATH=$p; export $PATH
fi

@


1.14.2.7
log
@okay, $localbase/X11 is now recognised too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.6 2005/08/21 17:40:11 tg Exp $
a29 1

a30 4
xfbase=/usr/X11R6
# ... in case we have XFree86(R) as a port
test -f $localbase/X11/include/X11/X.h && xfbase=$localbase/X11
test -x $localbase/X11/bin/xterm && xfbase=$localbase/X11
d50 1
a50 1
	for a in /usr/local/bin $xfbase/bin /usr/X11R6/bin /usr/bin /bin; do
d75 1
a75 1
	for a in /usr/local/sbin /usr/sbin /sbin $xfbase/bin /usr/X11R6/bin; do
@


1.14.2.8
log
@autoconf.info 10.5 Shell Substitution
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.7 2005/08/21 17:45:10 tg Exp $
d45 1
a45 1
mirror=${1:-http://mirbsd.mirsolutions.de/MirOS/dist/}; export mirror
d149 1
a149 1
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(2[4-9]|[3-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9]) ]]; then echo yes; else echo no; fi' 2>/dev/null`
d159 1
a159 1
#	t=`$ms -c 'x=${KSH_VERSION#*KSH?R}; print ${x%% *}'`
d165 1
a165 1
	t=`$ms -c 'print ${KSH_VERSION#*KSH?R}'`
d172 1
a172 1
		SHELL=$ms
d181 1
a181 1
	SHELL=$ms; export SHELL
d199 1
a199 1
elif s=`md5 $mksh_dist 2>/dev/null`; then
d201 1
a201 1
elif s=`cksum $mksh_dist 2>/dev/null`; then
d203 1
a203 1
elif s=`md5sum $mksh_dist 2>/dev/null`; then
d231 2
a232 2
if ! SHELL=${SHELL:-/bin/sh} ${SHELL:-/bin/sh} ./Build.sh; then
	if ! SHELL=${SHELL:-/bin/sh} ${SHELL:-/bin/sh} ./Build.sh -d -r; then
@


1.14.2.9
log
@check all possible checksums
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.8 2005/08/21 17:48:46 tg Exp $
d196 11
a206 28
sum=unchecked
if s=`md5 $mksh_dist 2>/dev/null`; then
	if test x"$s" = x"$mksh_md5"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if s=`cksum $mksh_dist 2>/dev/null`; then
	if test x"$s" = x"$mksh_sum"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if s=`md5sum $mksh_dist 2>/dev/null`; then
	if test x"$s" = x"$mksh_md5sum"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if gzsig -q verify signkey $mksh_dist 2>/dev/null; then
	echo Note: cryptographically strong checksum verified successfully >&2
	sum=verygood
fi
if test $sum = unchecked; then
	echo Warning: Cannot check hashes for $mksh_dist >&2
d214 1
a214 1
if test $sum = bad; then
@


1.14.2.10
log
@* use $RANDOM
* I can't use "!" ?
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.9 2005/08/21 17:58:37 tg Exp $
d118 1
a118 3
if T=$(mktemp -d /tmp/mirports.XXXXXXXXXX); then
	:
else
d120 1
a120 1
	T=/tmp/mirports.$$.$RANDOM
d122 1
a122 1
		echo Cannot generate temporary directory >&2
d125 2
a126 2
	mkdir -p $T || {
		echo Cannot generate temporary directory >&2
d128 1
a128 1
	}
d137 6
a142 7
	test -x /usr/bin/nroff || \
	    OVERRIDE_MKSH=/bin/ksh SHELL=/bin/ksh \
	    /bin/ksh `dirname $0`/setup.ksh -i
	test -x /usr/bin/nroff || {
		echo Cannot install nroff >&2
		exit 1
	}
d183 1
a183 1
	echo Warning: executing old mksh failed >&2
d224 1
a224 1
	echo Please compare the following two lines manually >&2
d227 1
a227 1
	echo Press RETURN to continue >&2
d232 1
a232 1
	echo Checksum verification failed >&2
d240 2
a241 4
if gzip -dc $mksh_dist | cpio -id; then
	:
else
	echo Build failed >&2
d248 3
a250 7
if SHELL=${SHELL:-/bin/sh} ${SHELL:-/bin/sh} ./Build.sh; then
	:
else
	if SHELL=${SHELL:-/bin/sh} ${SHELL:-/bin/sh} ./Build.sh -d -r; then
		:
	else
		echo Build failed >&2
d257 2
a258 2
test -x mksh || {
	echo Build failed >&2
d262 1
a262 1
}
d270 3
a272 5
if rm /bin/mksh.$$.2; then
	:
else
	if mv /bin/mksh.$$.2 /tmp/deleteme.$$.$RANDOM; then
		echo Don't forget to clean up /tmp/deleteme.$$.* >&2
d274 1
a274 1
		echo Warning: remove /bin/mksh.$$.2 later >&2
@


1.14.2.11
log
@more portable shell code? *sigh*
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.10 2005/08/21 18:07:51 tg Exp $
d34 2
a35 2
test -r $localbase/X11/include/X11/X.h && xfbase=$localbase/X11
test -f $localbase/X11/bin/xterm && xfbase=$localbase/X11
d95 1
a95 1
	test -f /dev/fs/C/usr/local/wbin/wget.exe && \
d101 1
a101 1
		if test -f $dir/wget; then
d105 1
a105 1
		if test -f $dir/fetch; then
d109 1
a109 1
		if test -f $dir/ftp; then
d123 1
a123 1
	if test -d $T; then
d136 1
a136 1
if test $interix = yes; then
d139 1
a139 1
	test -f /usr/bin/nroff || \
d142 1
a142 1
	if test ! -f /usr/bin/nroff; then
d145 1
a145 1
	fi
d153 1
a153 1
	if test x"$t" = x"yes"; then
d160 1
a160 1
if test x"$ms" != x"false"; then
d169 1
a169 1
	if test x"$t" != x"$mksh_date"; then
d173 1
a173 1
	test $old = yes && if test x"$UPGRADE" != "no"; then
d183 1
a183 1
if test x"$ms" != x"false"; then
d253 2
a254 4
SHELL=${SHELL:-/bin/sh}; export SHELL
if test -f /usr/lib/libc.dylib; then
	# Darwin
	d=-d
d256 8
a263 1
	d=
d265 2
a266 2
$SHELL ./Build.sh $d || rm -f mksh
if test ! -s mksh; then
d271 1
a271 1
fi
d291 6
a296 2
if test -s mksh.cat1; then
	install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.0 && s=1
a297 1
test $s = 0 && install -c -m 444 mksh.1 /usr/share/man/man1/mksh.1
d305 1
a305 1
exec /bin/mksh `dirname $0`/setup.ksh
@


1.14.2.12
log
@also in comments
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.11 2005/08/21 18:32:49 tg Exp $
d164 3
a166 1
#	test $t -lt $mksh_ver && old=yes
d169 3
a171 2
	test x"$t" != x"$mksh_date" && old=yes

@


1.14.2.13
log
@* interix needs LD_LIBRARY_PATH too
* clean up if exec fails
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.12 2005/08/21 18:33:58 tg Exp $
a88 7

	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH
		export LD_LIBRARY_PATH
		;;
	esac
a297 2
cd /
rm -rf $T
@


1.14.2.14
log
@more subtileties; pass arguments (past mirror) to setup.ksh; better for mirror
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.13 2005/08/21 18:46:58 tg Exp $
d45 1
a45 6
mirror=$1
if test x"$mirror" = x"-" || test x"$mirror" = x; then
	mirror=http://mirbsd.mirsolutions.de/MirOS/dist/
fi
export mirror
test x"$1" = x || shift
a97 3
# Where are we?
ourpath=`dirname $0`

d148 1
a148 1
	    /bin/ksh $ourpath/setup.ksh -i
d189 1
a189 4
	case $# in
	0)	exec $ms $ourpath/setup.ksh ;;
	*)	exec $ms $ourpath/setup.ksh "$@@" ;;
	esac
d301 1
a301 4
case $# in
0)	exec /bin/mksh $ourpath/setup.ksh ;;
*)	exec /bin/mksh $ourpath/setup.ksh "$@@" ;;
esac
@


1.14.2.15
log
@interix -> isinterix
export a few more vars
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.14 2005/08/21 18:56:55 tg Exp $
a35 2
export localbase
export xfbase
d53 3
a55 4
isinterix=no
test -n "$SFUDIR" && isinterix=yes
test -n "$OPENNT_ROOT" && isinterix=yes
export isinterix
d58 1
a58 1
if test $isinterix = no; then
a104 1
export ourpath
d108 1
a108 1
if test $isinterix = yes; then
d151 1
a151 1
if test $isinterix = yes; then
@


1.14.2.16
log
@* continue writing the new installation script
* add facilities for installing as user and choosing a
  different localbase and x11base
* on Interix, don't add /usr/mpkg/lib to LD_LIBRARY_PATH
  if it's not part of the localbase
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.15 2005/08/21 19:02:55 tg Exp $
d31 2
a32 2
test -d ${localbase:-/nonexist} || localbase=/usr/mpkg
test -d ${xfbase:-/nonexist} || xfbase=/usr/X11R6
a97 1
	export LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
a100 1
		LD_LIBRARY_PATH=${LD_LIBRARY_PATH%:}
d160 1
a160 1
	    /bin/ksh $ourpath/setup.ksh -i "$@@"
@


1.14.2.17
log
@don't forget $xfbase/lib
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.16 2005/09/01 21:57:43 tg Exp $
d98 1
a98 5
	LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
d101 4
a104 1
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
a105 2
	LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
	export LD_LIBRARY_PATH LD_LIBRARY_PATH_ORG
@


1.14.2.18
log
@fix the worst programming errors
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.17 2005/09/01 21:59:46 tg Exp $
d48 1
a48 6
case x$1 in
	x-*)	mirror= ;;
	x)	;;
	*)	shift ;;
esac
if test x"$mirror" = x; then
d52 1
d68 1
a68 1
	done
d75 2
a76 2
	done
	PATH=$p; export PATH
d86 1
a86 1
	done
d93 1
a93 1
	done
d96 1
a96 1
	PATH=$p; export PATH
d137 1
a137 1
	done
@


1.14.2.19
log
@* complain if we need to install mksh and don't have write
  privs in /bin/ (e.g. install as user, no recent mksh available)
  XXX what about overrides to use an older (or newer) version?
* use ports/Distfiles/ for storing downloaded files (mksh, ...)
* don't download if it's already there
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.18 2005/09/11 00:49:37 tg Exp $
a117 1
mkdir -p $ourpath/../../Distfiles
a216 21
# Check permissions
rm -rf /bin/mksh.$$.1
badp=0
if test -d /bin/mksh.$$.1; then
	badp=1
else
	mkdir /bin/mksh.$$.1 2>/dev/null
	test -d /bin/mksh.$$.1 || badp=1
	rmdir /bin/mksh.$$.1 2>/dev/null
	test -d /bin/mksh.$$.1 && badp=1
	(echo test >/bin/mksh.$$.1) 2>/dev/null
	test -r /bin/mksh.$$.1 || badp=1
fi
if test $badp = 1; then
	echo 'You need superuser privilegues to continue installation.' >&2
	echo 'Ask your system operator to install a recent mksh (R24b)' >&2
	cd
	rm -rf $T /bin/mksh.$$.1
	exit 1
fi

d218 2
a219 2
cd $ourpath/../../Distfiles
test -r $mksh_path || case "$mirror" in
d271 1
a271 1
if gzip -dc $mksh_dist | (cd $T && cpio -id); then
d280 1
a280 1
cd $T/mksh
@


1.14.2.20
log
@* flesh out checksums of files to distinfo.sh (to be sourced)
* update to mksh R24c while we're at it (no change in date)
* fix a lot of errors in the "build mksh" code
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.19 2005/09/11 15:07:50 tg Exp $
d41 5
a116 1
ourpath=`(cd $ourpath && pwd -P)`
a160 1
echo Notice: Temporary Directory: $T >&2
a230 1
rm -f /bin/mksh.$$.1
d235 1
a235 1
	rm -rf $T
a239 2
what=mksh
. $ourpath/distinfo.sh
d241 1
a241 1
test -r $f_dist || case "$mirror" in
d243 1
a243 2
	test -r $mirror/$f_path && cp $mirror/$f_path .
	test -r $mirror/$f_dist && cp $mirror/$f_dist .
d246 1
a246 1
	$fetch $mirror$f_path
d250 2
a251 2
if s=`md5 $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_md5"; then
d257 2
a258 2
test $sum = bad || if s=`cksum $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_sum"; then
d264 2
a265 2
test $sum = bad || if s=`md5sum $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_md5sum"; then
d271 1
a271 1
test $sum = bad || if gzsig verify -q $T/signkey $f_dist 2>/dev/null; then
d276 1
a276 1
	echo Warning: Cannot check hashes for $f_dist >&2
d278 2
a279 2
	echo "$f_lsline" >&2
	echo ": `/bin/ls -l $f_dist`" >&2
d293 1
a293 1
if gzip -dc $f_dist | (cd $T && cpio -id); then
d320 1
d324 2
a325 3
rm -f /bin/mksh.$$.2
test -f /bin/mksh.$$.2 && if mv /bin/mksh.$$.2 /tmp/deleteme.$$.$RANDOM; then
	echo Do not forget to clean up /tmp/deleteme.$$.\* >&2
d327 5
a331 1
	echo Warning: remove /bin/mksh.$$.2 later >&2
@


1.14.2.21
log
@change $ourpath to PORTSDIR instead of PORTSDIR/infrastructure/install
(don't use pwd -P in Setup.sh because setup.ksh takes care of it)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.20 2005/09/12 20:10:09 tg Exp $
d112 1
a112 1
ourpath=`(cd $ourpath/../.. && pwd)`
d114 1
a114 1
mkdir -p $ourpath/Distfiles
d167 1
a167 1
	    /bin/ksh $ourpath/infrastructure/install/setup.ksh -i "$@@"
d209 2
a210 2
	0)	exec $ms $ourpath/infrastructure/install/setup.ksh ;;
	*)	exec $ms $ourpath/infrastructure/install/setup.ksh "$@@" ;;
d239 2
a240 2
. $ourpath/infrastructure/install/distinfo.sh
cd $ourpath/Distfiles
d345 2
a346 2
0)	exec /bin/mksh $ourpath/infrastructure/install/setup.ksh ;;
*)	exec /bin/mksh $ourpath/infrastructure/install/setup.ksh "$@@" ;;
@


1.14.2.22
log
@move user-visible part of new installer to PORTSDIR/. where it will
reside later, and outside of development branch in subdirectory;
remove Setup.sh from infrastructure/install. Only change:
| ourpath=`(cd $ourpath/../.. && pwd)`
gets the ../../ removed.

DO NOT USE (yet).
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.21 2005/09/12 20:13:23 tg Exp $
@


1.13
log
@kludge around Mac OSX users with case-insensitive filesystem

prodded and ok bsiegert@@

Note: we still do not support case-insensitive filesystems officially,
      nor will we.
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.12 2005/07/05 20:25:59 tg Exp $
d30 1
a30 2
# 2) build and install package tools to
#    /usr/sbin (MirOS), /usr/local/sbin (OpenBSD), /usr/mpkg/sbin (Darwin)
d138 1
a138 1
	localbase=/usr/local
d141 1
a141 1
	pkgbin=/usr/sbin
d164 1
a164 1
	localbase=/usr/local
d204 1
a204 1
	$MAKE PORTABLE=yes DB_DIR=$localbase/db \
a206 1
	$MAKE install PREFIX=$localbase MANDIR=$localbase/man/cat
d209 1
a209 1
	$MAKE PORTABLE=yes NEED_COMPAT=yes DB_DIR=$localbase/db \
a210 1
	$MAKE install
d214 1
a214 1
		$MAKE
d216 1
a216 1
		$MAKE PORTABLE=yes
a217 1
	$MAKE install
d220 1
a220 2
	$MAKE PORTABLE=yes
	$MAKE install PREFIX=$localbase MANDIR=$localbase/man/cat
d222 1
a298 1
	print '/^#@@@@PKG_CMDDIR/s/^#@@@@//\nwq' | ed -s $ti/mk/mirports.osdep.mk
a346 1
	print -p "PKG_CMDDIR=		$localbase/sbin"
d355 1
a355 3
	if [[ $top = /usr/ports ]]; then
		print -p "PKG_CMDDIR=		$localbase/sbin"
	else
a359 1
		print -p "PKG_CMDDIR=		$localbase/sbin"
a363 1
	print -p
@


1.12
log
@provide some assistance to the upgrader
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.11 2005/06/03 00:14:14 tg Exp $
d84 1
d93 13
d255 1
a255 1
if [[ -d $top/distfiles ]]; then
@


1.11
log
@* work around ETXTBUSY
* mktemp.sh no longer around, it's part of mirmake now
* optionally override ftp (http) client to use
* update to mirbsdksh R22c
* update to mirmake 20050602
* sprinkle some more absolutistic pathnames
* handle LD_LIBRARY_PATH addition
* call last command by "exec"
* no need to chmod +x install-sh any more, it's no longer needed
  since a working xinstall is coming with mirmake now
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.10 2005/06/02 20:35:47 tg Exp $
d32 1
a32 1
# 3) patch <bsd.sys.mk> if necessary
d241 10
@


1.10
log
@on Interix, install-sh must be 555 because it's being used
as install(1) replacement - the builtin install(1) doesn't know -d
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.9 2005/05/30 16:47:09 tg Exp $
a112 1
	chmod a+x $ti/db/install-sh
@


1.9
log
@flag day: /bin/mksh is now default shell (XXX untested)
pkg_scan: convert to ksh idioms, [ x"$1" ... is out
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.8 2005/05/21 18:08:39 tg Exp $
d113 1
@


1.8
log
@fake.mtree is modified during make setup, thus it's copied
to db/ (now all Ms in db/ are to be ignored, and all other
paths are without M after make setup)
@
text
@d1 2
a2 2
#!/bin/ksh
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.7 2005/05/21 17:33:15 tg Exp $
d59 1
a59 1
[[ -z $SHELL ]] && SHELL=/bin/ksh
d231 1
a231 1
if [[ $SHELL != /bin/ksh ]]; then
d235 1
a235 1
		print "1g!/bin/ksh!s!!$SHELL!\nwq" | ed -s $f
@


1.7
log
@* update to mksh R20b
* update another mirmake (maybe more to follow)
* fix compilation

waiting for bsiegert@@ to commit more rtld diffs
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.6 2005/05/21 03:09:58 tg Exp $
d83 2
d92 1
a92 1
	cat $ti/templates/fake.mtree >$tmp
d115 2
a116 2
	    | ed -s $ti/templates/fake.mtree
	cat $ti/templates/fake.mtree >$tmp
@


1.6
log
@chmod +x some infrastructure files on 'make setup'

idea by bsiegert@@, I could not argue enough against, breakage by libfool
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.5 2005/05/21 01:52:45 tg Exp $
d194 1
a194 1
	$MAKE depend INCS='-I/usr/share/make'
d196 1
a196 2
	    INCS='-I/usr/share/make' \
	    LIBS='/usr/share/make/libhash.a -ldb'
@


1.5
log
@root; install_program_dir
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.4 2005/05/21 00:16:02 tg Exp $
d235 1
@


1.4
log
@* db/Makefile [SHOW_ONLY]
	new ifdef; includes <bsd.own.mk> instead of <mirports.sys.mk>
	  (for make with ___DISPLAY_MAKEVARS)
* install/Setup-Interix.sh
	fix PATH
	new MirMake version
* install/Setup.sh
	preliminary support for Interix:
	use BINOWN/BINGRP (via db/Makefile)
	adjust mtree; paths
* install/mirports.osdep.mk-darwin
	_PORTPATH like this is now default
* pkgtools:
	add/extract.c, delete/perform.c, lib/pen.c:
	  no chflags/chattr/chown/statfs on Interix
	create/perform.c: uncomment header not on Interix
	lib/Makefile: use mbcompat (only on Interix)
	lib/rcdb.c: don't acquire lock on Interix (XXX)
	mbcompat/bsd-arc4random.c:
	  fix includes etc.
	  add protos
	  whitespace cleanup
	mbcompat/mktemp.c:
	  conditionalise __warn_references
* pkgtools/pkg/Makefile: don't strip on install
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.3 2005/04/20 22:24:27 tg Exp $
d111 3
d115 1
a115 1
	(print 'g/[ug]name=[a-z]*/s///g\n/@@@@local/d\ni\n'; IFS=/; s=;
a118 1
	print "/^.set/s/   / uname=$BINOWN gname=$BINGRP /\nwq" | ed -s $tmp
@


1.3
log
@some of our ports don't have /bin/ksh as shell, and most stoopid
GNU makefiles don't $(SHELL) mkinstalldirs. würg around.

ok bsiegert@@
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.2 2005/03/19 19:31:41 bsiegert Exp $
d70 9
a78 1
if ! chown root $tmp; then
d105 15
d191 6
d248 8
d279 1
a279 1
if install -c -o root -g bin -m 444 \
d326 3
@


1.2
log
@Change pathnames for new layout
@
text
@d2 1
a2 1
# $MirOS$
d184 1
a184 1
print -n "3. Patching <bsd.sys.mk>..."
d199 9
@


1.1
log
@Initial revision
@
text
@d82 1
a82 1
	cat $ti/db/fake.mtree >$tmp
d156 1
a156 1
cd $ti/stools
d190 1
a190 1
	    $ti/compat/generic/patch-bsd_sys_mk; then
d204 1
a204 1
	    $ti/compat/osdep/darwin-mirports.osdep.mk \
d213 1
a213 1
		    $ti/compat/osdep/mbsd-mirports.osdep.mk \
d224 1
a224 1
	    $ti/compat/osdep/obsd-mirports.osdep.mk \
d234 1
a234 1
    $ti/compat/generic/*.mk $sysmk/; then
d308 1
a308 1
	$SHELL $ti/db/mkuserdb
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
