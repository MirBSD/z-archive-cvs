head	1.14;
access;
symbols;
locks; strict;
comment	@# @;


1.14
date	2005.11.15.18.06.57;	author tg;	state dead;
branches;
next	1.13;
commitid	64c4437a23af2eb8;

1.13
date	2005.09.12.22.53.17;	author tg;	state Exp;
branches;
next	1.12;
commitid	6e6c432606e897b6;

1.12
date	2005.06.09.22.25.06;	author tg;	state Exp;
branches
	1.12.2.1;
next	1.11;
commitid	29ed42a8c1d497de;

1.11
date	2005.06.08.10.21.18;	author tg;	state Exp;
branches;
next	1.10;
commitid	4d542a6c6a63918;

1.10
date	2005.06.03.00.14.14;	author tg;	state Exp;
branches;
next	1.9;
commitid	6921429fa069b452;

1.9
date	2005.06.02.21.08.16;	author tg;	state Exp;
branches;
next	1.8;
commitid	514e429f7535c564;

1.8
date	2005.05.21.17.33.15;	author tg;	state Exp;
branches;
next	1.7;
commitid	4a60428f70cef574;

1.7
date	2005.05.21.01.07.14;	author tg;	state Exp;
branches;
next	1.6;
commitid	6efa428e89cc2fda;

1.6
date	2005.05.21.00.16.02;	author tg;	state Exp;
branches;
next	1.5;
commitid	2ef4428e7c341292;

1.5
date	2005.04.13.21.28.41;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2005.04.13.19.35.58;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.04.13.17.15.13;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.04.13.17.02.43;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.04.13.16.16.42;	author tg;	state Exp;
branches;
next	;

1.12.2.1
date	2005.08.21.11.31.16;	author tg;	state Exp;
branches;
next	;
commitid	2dde4308661200f8;


desc
@@


1.14
log
@* now I'm content with the manual page
* add target for generation of docs
  - one for *nix systems
  - one for DOS fanboys
* nuke unneeded script
@
text
@#!/bin/mksh
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.13 2005/09/12 22:53:17 tg Exp $
#-
# Copyright (c) 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
#-
# Retrieve prerequisites for running MirPorts on Mac OSX

# DO NOT UNCOMMENT
#testing=1

PATH=/bin:/opt/gcc.3.3/bin:/usr/contrib/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/X11R6/bin
[ -n "$PATH_WINDOWS" ] && PATH=$PATH:/usr/contrib/win32/bin:$PATH_WINDOWS
PATH_ORIG=$PATH:/usr/X11R5:bin
export PATH=$PATH_ORIG

bd=$(cd $(dirname $0); pwd)
td=$(cd $bd/../..; pwd)

#target=${1:-/usr/mpkg}
mirror=$1 # will be $2
ftp=ftp
#ftp="runwin32 .../wget"
[ -z $mirror ] && mirror=http://mirbsd.mirsolutions.de/MirOS/distfiles/

mksh=mksh-R22c.cpio.gz
make=mirmake-20050602.cpio.gz
mtar=paxmirabilis-20050413.cpio.gz
roff=mirnroff-20050413.cpio.gz
mftp=mirftp-20050413.cpio.gz
mtre=mirmtree-20050413.cpio.gz

T=$(mktemp -d /tmp/mirports.XXXXXXXXXX) || {
	echo Cannot generate temp dir >&2
	exit 1
}

echo "===> building in $T"

cd $T
case "$mirror" in
/*)	# file
	echo cp $mirror/$mksh .
	cp $mirror/$mksh .
	echo cp $mirror/$make .
	cp $mirror/$make .
	echo cp $mirror/$mtar .
	cp $mirror/$mtar .
	echo cp $mirror/$roff .
	cp $mirror/$roff .
#	echo cp $mirror/$mftp .
#	cp $mirror/$mftp .
	echo cp $mirror/$mtre .
	cp $mirror/$mtre .
	;;
*)	# http
	echo $ftp $mirror$mksh
	$ftp $mirror$mksh
	echo $ftp $mirror$make
	$ftp $mirror$make
	echo $ftp $mirror$mtar
	$ftp $mirror$mtar
	echo $ftp $mirror$roff
	$ftp $mirror$roff
#	echo $ftp $mirror$mftp
#	$ftp $mirror$mftp
	echo $ftp $mirror$mtre
	$ftp $mirror$mtre
	;;
esac
echo 'checking CKSUMs... (no comment)'
cksum $mksh >s
cksum $make >>s
cksum $mtar >>s
cksum $roff >>s
#cksum $mftp >>s
cksum $mtre >>s
cat >t <<EOF
4137564449 227585 mksh-R22c.cpio.gz
109949125 292052 mirmake-20050602.cpio.gz
862398610 117237 paxmirabilis-20050413.cpio.gz
2807559264 222049 mirnroff-20050413.cpio.gz
1518604836 17212 mirmtree-20050413.cpio.gz
EOF

if ! cmp -s s t; then
	echo Checksum failure! >&2
	diff -u12 t s | grep '^[+-][^+-]' >&2
	if [ x"$testing" != x"1" ]; then
		cd $td
		rm -rf $T
		exit 1
	else
		echo WARNING: testing engaged!
	fi
fi

export CC="${CC:-gcc}"
export CFLAGS="${CFLAGS:--O2 -fno-strength-reduce -fno-strict-aliasing}"

set -e # XXX should set up a trap, but...
set -x

mkdir -p /usr/share/man/{cat,man}{1,2,3,4,5,6,7,8,9} \
    /usr/share/tmac/m{doc,e,s} /usr/libexec

if [ ! -x /usr/bin/nroff ]; then
	gzip -dc $mksh | cpio -id
	cd mksh
	SHELL=/bin/ksh CFLAGS="$CFLAGS -D_ALL_SOURCE" /bin/ksh ./Build.sh
	install -c -s -m 555 mksh /bin/mksh2
	mv /bin/mksh /bin/mksh1p && mv /bin/mksh2 /bin/mksh
	rm /bin/mksh1p || echo Warning: remove /bin/mksh1p later! >&2
	cd ..
	rm -rf mksh

	gzip -dc $make | cpio -id
	cd mirmake
	/bin/mksh ./Build.sh \
	    Interix /usr share/man/man make \
	    "" "" "" /bin/mksh -
	/bin/mksh ./Install.sh
	rm -f /usr/share/man/man1/make.1
	cd ..
	rm -rf mirmake

	gzip -dc $roff | cpio -id
	for subdir in mirnroff/src/{usr.bin/oldroff,share/tmac}; do
		cd $subdir
		make NOMAN=yes obj
		make NOMAN=yes depend
		make NOMAN=yes
		make NOMAN=yes install
		cd ../../../..
	done
	rm -rf mirnroff
fi

if [ -x /usr/bin/nrcon ]; then
	export NROFF=/usr/bin/nrcon
else
	export NROFF="/usr/bin/nroff -Tascii"
fi

gzip -dc $mksh | cpio -id
cd mksh
#if [ -e /usr/share/make/libmirmake.a ]; then
#	CFLAGS="$CFLAGS -D_ALL_SOURCE -I/usr/share/make" \
#	LIBS="$LIBS -L/usr/share/make -lmirmake" \
#	ksh ./Build.sh
#else
	CFLAGS="$CFLAGS -D_ALL_SOURCE" /bin/ksh ./Build.sh
#fi
install -c -s -m 555 mksh /bin/mksh2
mv /bin/mksh /bin/mksh1 && mv /bin/mksh2 /bin/mksh
rm /bin/mksh1 || echo Warning: remove /bin/mksh1 later! >&2
install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.0
if ! fgrep /bin/mksh /etc/shells >/dev/null 2>&1; then
	echo /bin/mksh >>/etc/shells
fi
cd ..
rm -rf mksh

gzip -dc $make | cpio -id
cd mirmake
ksh ./Build.sh \
    Interix /usr share/man/cat make \
    "" "" "" /bin/mksh -
/bin/mksh ./Install.sh
cd ..
rm -rf mirmake

gzip -dc $roff | cpio -id
for subdir in mirnroff/src/{usr.bin/oldroff,share/tmac,usr.bin/soelim}; do
	cd $subdir
	make obj
	make depend
	make
	make install
	cd ../../../..
done
rm -rf mirnroff

gzip -dc $mtar | cpio -id
cd pax
make obj
make depend
make
make install BINDIR=/bin MANDIR=/usr/share/man/cat
cd ..
rm -rf pax

gzip -dc $mtre | cpio -id
cd mtree
make obj
make depend
make LIBS="-L\${.SYSMK} -lmirmake"
make install BINDIR=/usr/sbin MANDIR=/usr/share/man/cat
cd ..
rm -rf mtree

#gzip -dc $mftp | cpio -id
#cd ftp
#make obj
#make depend
#make
#make install BINDIR=/usr/bin MANDIR=/usr/share/man/cat
#cd ..
#rm -rf ftp

set +e
set -e

cd $td
rm -rf $T

if ! fgrep /usr/mpkg/lib /etc/profile.lcl >/dev/null 2>&1; then
	echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/mpkg/lib"' \
	    >>/etc/profile.lcl
fi
[[ $LD_LIBRARY_PATH = */usr/mpkg/lib* ]] || \
    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/usr/mpkg/lib"

exec make setup SHELL=/bin/mksh
@


1.13
log
@join tg-ports-devel branch into HEAD
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.12.2.1 2005/08/21 11:31:16 tg Exp $
@


1.12
log
@errors to fd 2
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.11 2005/06/08 10:21:18 tg Exp $
d158 6
@


1.12.2.1
log
@export NROFF to the right value
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.12 2005/06/09 22:25:06 tg Exp $
a157 6
if [ -x /usr/bin/nrcon ]; then
	export NROFF=/usr/bin/nrcon
else
	export NROFF="/usr/bin/nroff -Tascii"
fi

@


1.11
log
@handle the case of mksh ETXTBUSY swapping and in-use shells
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.10 2005/06/03 00:14:14 tg Exp $
d52 4
a55 2
T=$(mktemp -d /tmp/mirports.XXXXXXXXXX) || { echo Cannot generate temp dir; \
    exit 1; }
d106 2
a107 2
	echo Checksum failure!
	diff -u12 t s | grep '^[+-][^+-]'
d132 1
a132 1
	rm /bin/mksh1p || echo Warning: remove /bin/mksh1p later!
d169 1
a169 1
rm /bin/mksh1 || echo Warning: remove /bin/mksh1 later!
@


1.10
log
@* work around ETXTBUSY
* mktemp.sh no longer around, it's part of mirmake now
* optionally override ftp (http) client to use
* update to mirbsdksh R22c
* update to mirmake 20050602
* sprinkle some more absolutistic pathnames
* handle LD_LIBRARY_PATH addition
* call last command by "exec"
* no need to chmod +x install-sh any more, it's no longer needed
  since a working xinstall is coming with mirmake now
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.9 2005/06/02 21:08:16 tg Exp $
d129 2
a130 1
	mv /bin/mksh /bin/mksh1 && mv /bin/mksh2 /bin/mksh
d167 1
@


1.9
log
@for usability, add /usr/mpkg/lib to LD_LIBRARY_PATH in /etc/profile.lcl
no comment
@
text
@d1 2
a2 2
#!/bin/ksh
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.8 2005/05/21 17:33:15 tg Exp $
a30 3
# Since we're on NT, we can't exchange running binaries.
[ x"$SHELL" = x"/bin/mksh" ] && exec /bin/ksh $0 "$@@"

a35 5
if [ -e mktemp.sh ]; then
	rm -f /bin/mktemp
	install -c -m 555 mktemp.sh /bin/mktemp
fi

d41 2
d45 2
a46 2
mksh=mirbsdksh-R20b.cpio.gz
make=mirmake-20050521b.cpio.gz
d74 12
a85 12
	echo ftp $mirror$mksh
	ftp $mirror$mksh
	echo ftp $mirror$make
	ftp $mirror$make
	echo ftp $mirror$mtar
	ftp $mirror$mtar
	echo ftp $mirror$roff
	ftp $mirror$roff
#	echo ftp $mirror$mftp
#	ftp $mirror$mftp
	echo ftp $mirror$mtre
	ftp $mirror$mtre
d96 2
a97 2
573946240 292817 mirbsdksh-R20b.cpio.gz
1223689859 280930 mirmake-20050521b.cpio.gz
d126 4
a129 3
	cd ksh
	SHELL=/bin/ksh CFLAGS="$CFLAGS -D_ALL_SOURCE" ksh ./Build.sh
	install -c -s -m 555 mksh /bin/mksh
d131 1
a131 1
	rm -rf ksh
d156 1
a156 1
cd ksh
d162 1
a162 1
	CFLAGS="$CFLAGS -D_ALL_SOURCE" ksh ./Build.sh
d164 2
a165 1
install -c -s -m 555 mksh /bin/mksh
d171 1
a171 1
rm -rf ksh
d230 2
d233 1
a233 1
make setup SHELL=/bin/mksh
@


1.8
log
@* update to mksh R20b
* update another mirmake (maybe more to follow)
* fix compilation

waiting for bsiegert@@ to commit more rtld diffs
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.7 2005/05/21 01:07:14 tg Exp $
d229 6
@


1.7
log
@new mirmake version, now mandatory for Darwin too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.6 2005/05/21 00:16:02 tg Exp $
d51 2
a52 2
mksh=mirbsdksh-R20.cpio.gz
make=mirmake-20050521.cpio.gz
d101 7
a107 5
echo "62583208 292816 mirbsdksh-R20.cpio.gz" >t
echo "2398353143 281094 mirmake-20050521.cpio.gz" >>t
echo "862398610 117237 paxmirabilis-20050413.cpio.gz" >>t
echo "2807559264 222049 mirnroff-20050413.cpio.gz" >>t
echo "1518604836 17212 mirmtree-20050413.cpio.gz" >>t
d162 7
a168 1
CFLAGS="$CFLAGS -D_ALL_SOURCE" ksh ./Build.sh
d210 1
a210 1
make INCS="-I\${.SYSMK}" LIBS="-L\${.SYSMK} -lhash"
@


1.6
log
@* db/Makefile [SHOW_ONLY]
	new ifdef; includes <bsd.own.mk> instead of <mirports.sys.mk>
	  (for make with ___DISPLAY_MAKEVARS)
* install/Setup-Interix.sh
	fix PATH
	new MirMake version
* install/Setup.sh
	preliminary support for Interix:
	use BINOWN/BINGRP (via db/Makefile)
	adjust mtree; paths
* install/mirports.osdep.mk-darwin
	_PORTPATH like this is now default
* pkgtools:
	add/extract.c, delete/perform.c, lib/pen.c:
	  no chflags/chattr/chown/statfs on Interix
	create/perform.c: uncomment header not on Interix
	lib/Makefile: use mbcompat (only on Interix)
	lib/rcdb.c: don't acquire lock on Interix (XXX)
	mbcompat/bsd-arc4random.c:
	  fix includes etc.
	  add protos
	  whitespace cleanup
	mbcompat/mktemp.c:
	  conditionalise __warn_references
* pkgtools/pkg/Makefile: don't strip on install
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.5 2005/04/13 21:28:41 tg Exp $
d52 1
a52 1
make=mirmake-20050520.cpio.gz
d102 1
a102 1
echo "1776178915 280829 mirmake-20050520.cpio.gz" >>t
@


1.5
log
@okay, I get it to the point of building through (minus ftp)
new versions of make, mtree, nroff and pax
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.4 2005/04/13 19:35:58 tg Exp $
d34 1
a34 1
PATH=/bin:/opt/gcc.3.3/bin:/usr/contrib/bin:/usr/local/bin:/usr/X11R6/bin
d52 1
a52 1
make=mirmake-20050413.cpio.gz
d102 1
a102 1
echo "2826293142 279066 mirmake-20050413.cpio.gz" >>t
@


1.4
log
@now I get till pax...
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.3 2005/04/13 17:15:13 tg Exp $
d29 1
a29 1
testing=1
d53 1
a53 1
mtar=paxmirabilis-20050228.cpio.gz
d74 2
a75 2
	echo cp $mirror/$mftp .
	cp $mirror/$mftp .
d88 2
a89 2
	echo ftp $mirror$mftp
	ftp $mirror$mftp
d99 1
a99 1
cksum $mftp >>s
d102 4
a105 4
echo "1984996926 279003 mirmake-20050412.cpio.gz" >>t
echo "3380377454 117013 paxmirabilis-20050228.cpio.gz" >>t
echo "2584789426 221690 mirnroff-20050412.cpio.gz" >>t
echo "3462097166 62625 mirftp-20050413.cpio.gz" >>t
d149 4
a152 4
		SHELL=/bin/mksh make NOMAN=yes obj
		SHELL=/bin/mksh make NOMAN=yes depend
		SHELL=/bin/mksh make NOMAN=yes
		SHELL=/bin/mksh make NOMAN=yes install
d162 1
a162 1
install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.1
d181 4
a184 4
	SHELL=/bin/mksh make obj
	SHELL=/bin/mksh make depend
	SHELL=/bin/mksh make
	SHELL=/bin/mksh make install
d191 4
a194 4
SHELL=/bin/mksh make obj
SHELL=/bin/mksh make depend
SHELL=/bin/mksh make
SHELL=/bin/mksh make install BINDIR=/bin MANDIR=/usr/share/man/cat
d200 4
a203 4
SHELL=/bin/mksh make obj
SHELL=/bin/mksh make depend
SHELL=/bin/mksh make
SHELL=/bin/mksh make install BINDIR=/usr/sbin MANDIR=/usr/share/man/cat
d207 8
a214 8
gzip -dc $mftp | cpio -id
cd ftp
SHELL=/bin/mksh make obj
SHELL=/bin/mksh make NO_INET6=1 depend
SHELL=/bin/mksh make NO_INET6=1
SHELL=/bin/mksh make install BINDIR=/usr/bin MANDIR=/usr/share/man/cat
cd ..
rm -rf ftp
a216 3
for page in make pax tar cpio; do
	mv /usr/share/man/cat1/$page.0 /usr/share/man/cat1/$page.1
done
@


1.3
log
@cry out which temp dir we're using, since we don't
clean it up on error
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.2 2005/04/13 17:02:43 tg Exp $
d54 1
a54 1
roff=mirnroff-20050412.cpio.gz
d56 1
d76 2
d90 2
d100 1
d125 2
a126 1
mkdir -p /usr/share/man/{cat,man}1 /usr/share/tmac/m{doc,e,s}
d155 1
a155 2
	cd ..
	rm -rf pax
d162 1
a162 1
install -c -m 444 mksh.0 /usr/share/man/cat1/mksh.1
d187 1
a187 2
cd ..
rm -rf pax
d198 9
@


1.2
log
@my very own mktemp(1) replacement in mksh
1:1 plug-in compatible with our C equivalent
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Interix.sh,v 1.1 2005/04/13 16:16:42 tg Exp $
d52 1
a52 1
make=mirmake-20050412.cpio.gz
d60 2
@


1.1
log
@some first attempt (NOT for MirOS Interix, for MS Interix)
no 'make setup' yet, I'm happy if I get this far without hosing
my win2k install. This overwrites ftp, make, etc. from base.
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup-Darwin.sh,v 1.6 2005/04/12 20:35:29 tg Exp $
d39 5
@

