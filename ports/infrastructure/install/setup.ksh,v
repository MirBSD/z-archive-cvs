head	1.100;
access;
symbols
	MIRBSD_8_BASE:1.45;
locks; strict;
comment	@# @;


1.100
date	2018.10.07.01.09.57;	author tg;	state Exp;
branches;
next	1.99;
commitid	1005BB95CA10BF418E8;

1.99
date	2014.05.29.18.40.45;	author tg;	state Exp;
branches;
next	1.98;
commitid	10053877F337DFCFA47;

1.98
date	2014.01.26.21.52.29;	author tg;	state Exp;
branches;
next	1.97;
commitid	10052E583A967EB4D6A;

1.97
date	2010.01.21.17.20.53;	author tg;	state Exp;
branches;
next	1.96;
commitid	1004B588D07106094E7;

1.96
date	2009.10.17.21.51.42;	author tg;	state Exp;
branches;
next	1.95;
commitid	1004ADA3C7648D93868;

1.95
date	2009.10.04.15.27.19;	author tg;	state Exp;
branches;
next	1.94;
commitid	1004AC8BEE7745C2D99;

1.94
date	2009.08.30.18.14.06;	author tg;	state Exp;
branches;
next	1.93;
commitid	1004A9AC160276D98AE;

1.93
date	2009.03.29.13.04.05;	author tg;	state Exp;
branches;
next	1.92;
commitid	10049CF71B654F9EF54;

1.92
date	2008.12.29.19.49.15;	author tg;	state Exp;
branches;
next	1.91;
commitid	100495929C44F7A2386;

1.91
date	2008.11.29.12.15.47;	author tg;	state Exp;
branches;
next	1.90;
commitid	10049313267027B7360;

1.90
date	2008.11.08.18.45.25;	author tg;	state Exp;
branches;
next	1.89;
commitid	1004915DE575BA68A74;

1.89
date	2008.10.05.16.10.04;	author tg;	state Exp;
branches;
next	1.88;
commitid	10048E8E6E26536FCB9;

1.88
date	2008.05.31.20.56.53;	author bsiegert;	state Exp;
branches;
next	1.87;
commitid	1004841BB912E2AD496;

1.87
date	2008.05.31.15.11.43;	author bsiegert;	state Exp;
branches;
next	1.86;
commitid	10048416AB2188277B0;

1.86
date	2008.05.03.00.22.03;	author tg;	state Exp;
branches;
next	1.85;
commitid	100481BB02D6EB120B8;

1.85
date	2008.05.01.00.52.31;	author tg;	state Exp;
branches;
next	1.84;
commitid	1004819145953F55377;

1.84
date	2008.03.14.17.01.34;	author tg;	state Exp;
branches;
next	1.83;
commitid	10047DAAF4B0AD84942;

1.83
date	2008.03.14.15.56.45;	author tg;	state Exp;
branches;
next	1.82;
commitid	10047DAA04311B7E132;

1.82
date	2008.03.14.15.50.55;	author tg;	state Exp;
branches;
next	1.81;
commitid	10047DA9EE904A19483;

1.81
date	2008.03.12.23.43.11;	author tg;	state Exp;
branches;
next	1.80;
commitid	10047D86A9C2D04FA59;

1.80
date	2008.02.24.11.36.30;	author tg;	state Exp;
branches;
next	1.79;
commitid	10047C156936AEE5708;

1.79
date	2008.02.24.10.38.08;	author tg;	state Exp;
branches;
next	1.78;
commitid	10047C149152273152C;

1.78
date	2007.04.30.13.07.35;	author tg;	state Exp;
branches;
next	1.77;
commitid	1004635E9DA6DCF425D;

1.77
date	2007.04.01.01.24.04;	author tg;	state Exp;
branches;
next	1.76;
commitid	100460F09A374E47866;

1.76
date	2007.01.18.19.41.29;	author tg;	state Exp;
branches;
next	1.75;
commitid	10045AFCD277BF0DD96;

1.75
date	2006.12.28.03.34.26;	author tg;	state Exp;
branches;
next	1.74;
commitid	10045933B52267F74D7;

1.74
date	2006.12.28.03.11.33;	author tg;	state Exp;
branches;
next	1.73;
commitid	100459335F77FC7F2B2;

1.73
date	2006.12.28.02.33.13;	author tg;	state Exp;
branches;
next	1.72;
commitid	10045932CC873429731;

1.72
date	2006.12.28.01.02.32;	author tg;	state Exp;
branches;
next	1.71;
commitid	100459317B24D58D896;

1.71
date	2006.12.28.00.22.18;	author tg;	state Exp;
branches;
next	1.70;
commitid	10045930DF02A282515;

1.70
date	2006.12.23.04.17.50;	author tg;	state Exp;
branches;
next	1.69;
commitid	100458CADFD07C189AD;

1.69
date	2006.11.17.00.18.46;	author tg;	state Exp;
branches;
next	1.68;
commitid	100455CFFCE67E80D73;

1.68
date	2006.10.17.21.08.05;	author tg;	state Exp;
branches;
next	1.67;
commitid	100453545C2041E7641;

1.67
date	2006.10.13.17.25.59;	author tg;	state Exp;
branches;
next	1.66;
commitid	100452FCC351146EE3E;

1.66
date	2006.10.13.17.16.31;	author tg;	state Exp;
branches;
next	1.65;
commitid	100452FC9F55130A4BD;

1.65
date	2006.10.13.12.50.43;	author tg;	state Exp;
branches;
next	1.64;
commitid	100452F8B646971999B;

1.64
date	2006.10.06.14.08.02;	author tg;	state Exp;
branches;
next	1.63;
commitid	100452663464A9A2EFD;

1.63
date	2006.09.20.22.24.49;	author tg;	state Exp;
branches;
next	1.62;
commitid	1004511BFAD3427E1F6;

1.62
date	2006.08.16.19.46.25;	author tg;	state Exp;
branches;
next	1.61;
commitid	10044E3762016E082FD;

1.61
date	2006.07.23.17.42.34;	author tg;	state Exp;
branches;
next	1.60;
commitid	10044C3B4364E1E1D4A;

1.60
date	2006.07.23.17.37.58;	author tg;	state Exp;
branches;
next	1.59;
commitid	10044C3B4074AA4A5C2;

1.59
date	2006.06.25.07.55.27;	author tg;	state Exp;
branches;
next	1.58;
commitid	100449E4176738D0153;

1.58
date	2006.06.25.00.59.03;	author tg;	state Exp;
branches;
next	1.57;
commitid	100449DDFE2299A0411;

1.57
date	2006.05.27.19.47.33;	author tg;	state Exp;
branches;
next	1.56;
commitid	1004478ACE2629F5230;

1.56
date	2006.05.26.23.00.04;	author tg;	state Exp;
branches;
next	1.55;
commitid	1004477887E28D036E4;

1.55
date	2006.03.19.21.34.21;	author tg;	state Exp;
branches;
next	1.54;
commitid	100441DCE6C6E0D2860;

1.54
date	2006.03.19.20.31.47;	author tg;	state Exp;
branches;
next	1.53;
commitid	100441DBFBA338AA164;

1.53
date	2006.03.19.20.28.24;	author tg;	state Exp;
branches;
next	1.52;
commitid	100441DBEDA29917BFD;

1.52
date	2006.03.19.20.24.24;	author tg;	state Exp;
branches;
next	1.51;
commitid	100441DBDFF725FDD6E;

1.51
date	2006.02.26.00.26.24;	author tg;	state Exp;
branches;
next	1.50;
commitid	1004400F598145382C2;

1.50
date	2006.02.20.20.09.06;	author tg;	state Exp;
branches;
next	1.49;
commitid	10043FA21F15477CAE8;

1.49
date	2006.02.07.21.36.36;	author tg;	state Exp;
branches;
next	1.48;
commitid	10043E912EC66E9B676;

1.48
date	2006.01.25.20.50.50;	author tg;	state Exp;
branches;
next	1.47;
commitid	10043D7E4C06D742E4E;

1.47
date	2005.12.28.17.28.57;	author tg;	state Exp;
branches;
next	1.46;
commitid	10043B2CB33562F1CEB;

1.46
date	2005.12.28.00.28.24;	author tg;	state Exp;
branches;
next	1.45;
commitid	10043B1DC3038B826AB;

1.45
date	2005.12.23.20.18.11;	author tg;	state Exp;
branches;
next	1.44;
commitid	10043AC5B8D6BAA91D0;

1.44
date	2005.12.20.20.20.56;	author tg;	state Exp;
branches;
next	1.43;
commitid	10043A867B22185D834;

1.43
date	2005.12.20.20.19.48;	author tg;	state Exp;
branches;
next	1.42;
commitid	10043A86769100EA475;

1.42
date	2005.12.20.20.13.21;	author tg;	state Exp;
branches;
next	1.41;
commitid	10043A865DE693BFF34;

1.41
date	2005.12.20.19.57.53;	author tg;	state Exp;
branches;
next	1.40;
commitid	10043A8624B52844F91;

1.40
date	2005.12.18.16.36.29;	author tg;	state Exp;
branches;
next	1.39;
commitid	10043A58BE830AFB807;

1.39
date	2005.12.18.03.49.22;	author tg;	state Exp;
branches;
next	1.38;
commitid	10043A4DC4446914592;

1.38
date	2005.12.18.03.42.47;	author tg;	state Exp;
branches;
next	1.37;
commitid	10043A4DA975EEC0321;

1.37
date	2005.12.17.05.46.19;	author tg;	state Exp;
branches;
next	1.36;
commitid	10043A3A3E65E20A413;

1.36
date	2005.12.17.02.57.13;	author tg;	state Exp;
branches;
next	1.35;
commitid	10043A37E427899D34D;

1.35
date	2005.12.15.01.42.58;	author tg;	state Exp;
branches;
next	1.34;
commitid	10043A0CA161ABF082F;

1.34
date	2005.12.15.01.39.20;	author tg;	state Exp;
branches;
next	1.33;
commitid	10043A0C95700C75A7F;

1.33
date	2005.12.14.23.47.26;	author tg;	state Exp;
branches;
next	1.32;
commitid	10043A0AF180027AF19;

1.32
date	2005.12.14.23.11.45;	author tg;	state Exp;
branches;
next	1.31;
commitid	10043A0A6B512F26B53;

1.31
date	2005.11.24.22.58.16;	author tg;	state Exp;
branches;
next	1.30;
commitid	7f784386458683bd;

1.30
date	2005.11.17.23.54.19;	author tg;	state Exp;
branches;
next	1.29;
commitid	7707437d18363f5f;

1.29
date	2005.11.16.11.49.41;	author tg;	state Exp;
branches;
next	1.28;
commitid	3b4f437b1ce1c29e;

1.28
date	2005.11.15.16.46.36;	author tg;	state Exp;
branches;
next	1.27;
commitid	3d76437a10c3fc40;

1.27
date	2005.11.10.22.20.46;	author tg;	state Exp;
branches;
next	1.26;
commitid	49d84373c7025ee2;

1.26
date	2005.11.10.20.38.10;	author tg;	state Exp;
branches;
next	1.25;
commitid	7fa04373af2a07ff;

1.25
date	2005.11.10.13.21.42;	author tg;	state Exp;
branches;
next	1.24;
commitid	5c684373493b9de1;

1.24
date	2005.11.10.13.07.57;	author tg;	state Exp;
branches;
next	1.23;
commitid	2e2b4373462b75af;

1.23
date	2005.11.09.20.46.14;	author tg;	state Exp;
branches;
next	1.22;
commitid	148a4372602c74af;

1.22
date	2005.11.08.12.04.43;	author tg;	state Exp;
branches;
next	1.21;
commitid	9cf43709447b532;

1.21
date	2005.10.21.20.10.28;	author tg;	state Exp;
branches;
next	1.20;
commitid	58ce43594b233c28;

1.20
date	2005.10.09.18.48.08;	author tg;	state Exp;
branches;
next	1.19;
commitid	7d54434965cca27c;

1.19
date	2005.09.24.12.09.36;	author tg;	state Exp;
branches;
next	1.18;
commitid	25d0433541f503b0;

1.18
date	2005.09.24.12.01.25;	author tg;	state Exp;
branches;
next	1.17;
commitid	48f14335401205f1;

1.17
date	2005.09.19.20.48.56;	author tg;	state Exp;
branches;
next	1.16;
commitid	f79432f2449962c;

1.16
date	2005.09.19.20.23.45;	author tg;	state Exp;
branches;
next	1.15;
commitid	12e2432f1e5e33d9;

1.15
date	2005.09.19.19.56.47;	author tg;	state Exp;
branches;
next	1.14;
commitid	79c6432f17f7c56b;

1.14
date	2005.09.19.19.37.55;	author tg;	state Exp;
branches;
next	1.13;
commitid	1352432f13a2bc9f;

1.13
date	2005.09.19.18.23.07;	author tg;	state Exp;
branches;
next	1.12;
commitid	5e77432f02162959;

1.12
date	2005.09.18.21.22.52;	author tg;	state Exp;
branches;
next	1.11;
commitid	4ec5432ddab8c102;

1.11
date	2005.09.18.21.19.50;	author tg;	state Exp;
branches;
next	1.10;
commitid	2684432dd9f19cbe;

1.10
date	2005.09.18.21.16.56;	author tg;	state Exp;
branches;
next	1.9;
commitid	7e5432dd94a8ef6;

1.9
date	2005.09.13.11.12.21;	author tg;	state Exp;
branches;
next	1.8;
commitid	1b974326b40df63a;

1.8
date	2005.09.13.11.05.20;	author tg;	state Exp;
branches;
next	1.7;
commitid	473c4326b280d714;

1.7
date	2005.09.13.10.52.36;	author tg;	state Exp;
branches;
next	1.6;
commitid	1d934326af7bee86;

1.6
date	2005.09.13.10.26.40;	author tg;	state Exp;
branches;
next	1.5;
commitid	54674326a9531dc5;

1.5
date	2005.09.13.00.12.23;	author tg;	state Exp;
branches;
next	1.4;
commitid	75564326196889ca;

1.4
date	2005.09.12.23.25.56;	author tg;	state Exp;
branches;
next	1.3;
commitid	27043260e6a333e;

1.3
date	2005.09.12.23.23.53;	author tg;	state Exp;
branches;
next	1.2;
commitid	9d143260e01fe5a;

1.2
date	2005.09.12.22.53.17;	author tg;	state Exp;
branches;
next	1.1;
commitid	6e6c432606e897b6;

1.1
date	2005.09.01.21.57.43;	author tg;	state dead;
branches
	1.1.2.1;
next	;
commitid	71204317792756b6;

1.1.2.1
date	2005.09.01.21.57.43;	author tg;	state Exp;
branches;
next	1.1.2.2;
commitid	71204317792756b6;

1.1.2.2
date	2005.09.01.21.59.46;	author tg;	state Exp;
branches;
next	1.1.2.3;
commitid	73ac431779e240d9;

1.1.2.3
date	2005.09.01.22.15.26;	author tg;	state Exp;
branches;
next	1.1.2.4;
commitid	786f43177d7275c0;

1.1.2.4
date	2005.09.10.23.37.02;	author tg;	state Exp;
branches;
next	1.1.2.5;
commitid	34d943236e025369;

1.1.2.5
date	2005.09.11.00.23.53;	author tg;	state Exp;
branches;
next	1.1.2.6;
commitid	19fe432379213dce;

1.1.2.6
date	2005.09.11.00.49.37;	author tg;	state Exp;
branches;
next	1.1.2.7;
commitid	7a1e43237f292c25;

1.1.2.7
date	2005.09.11.00.53.33;	author tg;	state Exp;
branches;
next	1.1.2.8;
commitid	5e2b432380212b4f;

1.1.2.8
date	2005.09.11.01.09.50;	author tg;	state Exp;
branches;
next	1.1.2.9;
commitid	486d432383ea5169;

1.1.2.9
date	2005.09.11.01.40.40;	author tg;	state Exp;
branches;
next	1.1.2.10;
commitid	1adc43238b282a93;

1.1.2.10
date	2005.09.11.02.04.02;	author tg;	state Exp;
branches;
next	1.1.2.11;
commitid	1604323908f2ff4;

1.1.2.11
date	2005.09.11.02.12.20;	author tg;	state Exp;
branches;
next	1.1.2.12;
commitid	6a743239294d866;

1.1.2.12
date	2005.09.11.15.07.50;	author tg;	state Exp;
branches;
next	1.1.2.13;
commitid	77d14324480b2792;

1.1.2.13
date	2005.09.11.15.15.30;	author tg;	state Exp;
branches;
next	1.1.2.14;
commitid	1e3432449aa71a7;

1.1.2.14
date	2005.09.11.22.13.16;	author tg;	state Exp;
branches;
next	1.1.2.15;
commitid	6a0e4324abf28dfb;

1.1.2.15
date	2005.09.11.23.02.07;	author tg;	state Exp;
branches;
next	1.1.2.16;
commitid	6bca4324b77589d9;

1.1.2.16
date	2005.09.11.23.05.00;	author tg;	state Exp;
branches;
next	1.1.2.17;
commitid	29c54324b826ad54;

1.1.2.17
date	2005.09.11.23.09.57;	author tg;	state Exp;
branches;
next	1.1.2.18;
commitid	32924324b94e9996;

1.1.2.18
date	2005.09.12.20.13.24;	author tg;	state Exp;
branches;
next	1.1.2.19;
commitid	f574325e160d800;

1.1.2.19
date	2005.09.12.20.41.16;	author tg;	state Exp;
branches;
next	1.1.2.20;
commitid	79364325e7ec4a1b;

1.1.2.20
date	2005.09.12.21.39.43;	author tg;	state Exp;
branches;
next	1.1.2.21;
commitid	12144325f5abb4f6;

1.1.2.21
date	2005.09.12.21.40.38;	author tg;	state Exp;
branches;
next	1.1.2.22;
commitid	b0a4325f5d03902;

1.1.2.22
date	2005.09.12.21.41.04;	author tg;	state Exp;
branches;
next	1.1.2.23;
commitid	702e4325f5f63f11;

1.1.2.23
date	2005.09.12.21.41.55;	author tg;	state Exp;
branches;
next	1.1.2.24;
commitid	49274325f62d8430;

1.1.2.24
date	2005.09.12.21.46.43;	author tg;	state Exp;
branches;
next	1.1.2.25;
commitid	ea24325f71f0ce4;

1.1.2.25
date	2005.09.12.22.17.15;	author tg;	state Exp;
branches;
next	1.1.2.26;
commitid	5c064325fe6ec91c;

1.1.2.26
date	2005.09.12.22.47.12;	author tg;	state Exp;
branches;
next	;
commitid	70d5432605585138;


desc
@@


1.100
log
@spelling cleanup: “programme” is distinct from “program”; even in
British English, the latter is used for computer programs, while
the former serves for things like the TV programme, or a programme
to plant trees
@
text
@# $MirOS: ports/infrastructure/install/setup.ksh,v 1.99 2014/05/29 18:40:45 tg Exp $
#-
# Copyright (c) 2005, 2008, 2014
#	Thorsten “mirabilos” Glaser <tg@@mirbsd.de>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# This script really installs the MirPorts Framework.

function usage
{
	print -u2 "Syntax: Setup.sh [-u|-U user[:group]]] [-e|-E sysconfdir]"
	print -u2 "\t[-l localbase] [-X xfbase] [-DiNT]"
	print -u2 "  -e\tset sysconfdir (default /etc; -e: \$localbase/etc)"
	print -u2 "  -u\tinstall as user (default root:bin except on Interix)"
	exit 1
}

function dependdist
{
	what=$1
	#%%BEGIN ^K. sync Setup.sh with setup.ksh %% getfile
	. $ourpath/infrastructure/install/distinfo.sh
	cd $DISTDIR
	test -r $f_dist || case "$mirror" in
	/*)	# file
		test -r $mirror/$f_path && cp $mirror/$f_path .
		test -r $mirror/$f_dist && cp $mirror/$f_dist .
		;;
	*)	# http
		$fetch $f_dist $mirror$f_path
		;;
	esac
	sum=unchecked
	if s=`md5 $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_md5"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum = bad || if s=`cksum $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_sum"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum = bad || if s=`md5sum $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_md5sum"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum != good || test -z "$f_key" || \
	    if gzsig verify -q $T/$f_key $f_dist 2>/dev/null; then
		echo Note: cryptographically strong checksum verified successfully for $f_dist >&2
		sum=verygood
	fi
	if test $sum = unchecked; then
		echo Warning: Cannot check hashes for $f_dist >&2
		echo Please compare the following two lines manually >&2
		echo "$f_lsline" >&2
		echo ": `TZ=UTC /bin/ls -l $f_dist`" >&2
		echo Press RETURN to continue or abort if unsure. >&2
		read s
	fi

	if test $sum = bad; then
		echo Checksum verification failed >&2
		echo "false: $s" >&2
		cd
		rm -rf $T
		exit 1
	fi

	# Extract the distfile
	if gzip -dc $f_dist | (cd $T && cpio -id); then
		:
	else
		echo Build failed >&2
		cd
		rm -rf $T
		exit 1
	fi
	#%%END sync Setup.sh with setup.ksh %% getfile

	cd $T
}


if [[ $isinterix != @@(yes|no) || -z $mirror || -z $DISTDIR \
    || -z $ourpath || -z $tempdir || -z $fetch ]]; then
	print -u2 ERROR: Do not call this script directly!
	rm -rf $tempdir
	exit 1
fi
T=$tempdir

trap 'rm -rf $T; exit 1' 1 2 3 5 13 15
trap 'rm -rf $T; exit 0' 0

called_with="$*"

[[ -n $localbase ]] || localbase=/usr/mpkg
[[ -n $xfbase ]] || xfbase=/usr/X11R6
if [[ $interix = yes ]]; then
	user=$(id -un | sed 's! !\\ !g'):$(id -gn | sed 's! !\\ !g')
else
	user=root:bin
fi
etc=/etc
integer iopt=0
integer nopt=0
integer topt=0
d=0
while getopts "DE:ehil:NTU:uX:" opt; do
	case $opt {
	(D)	trap - 0 1 2 3 13 15
		d=1 ;;
	(E)	etc=${OPTARG%%*(/)} ;;
	(e)	etc=@@LOCALBASE@@/etc ;;
	(i)	iopt=1 ;;
	(l)	localbase=${OPTARG%%*(/)} ;;
	(N)	nopt=1 ;;
	(T)	topt=1 ;;
	(U)	user=$OPTARG ;;
	(u)	user=$(id -un):$(id -gn) ;;
	(X)	xfbase=${OPTARG%%*(/)} ;;
	(*)	usage ;;
	}
done
shift $((OPTIND - 1))

[[ $isinterix = yes ]] && LD_LIBRARY_PATH=$LD_LIBRARY_PATH_ORG
[[ $etc = @@LOCALBASE@@* ]] && etc=$localbase${etc#@@LOCALBASE@@}
[[ $d = 1 ]] && set -x

# Divine paths again
#%%BEGIN sync Setup.sh with setup.ksh %% paths
p=$localbase/bin:$localbase/sbin
if test $isinterix = no; then
	for a in /usr/local/bin /usr/bin /bin $xfbase/bin /usr/X11R6/bin \
	    /usr/sbin /sbin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
else
	# On Interix, /usr/bin is /bin; gzip lives in /usr/contrib/bin;
	# gcc has yet its own directory; we have X11R5 as well
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin \
	    /usr/sbin /sbin $localbase/sbin $xfbase/bin /usr/X11R6/bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	test -n "$PATH_WINDOWS" && p=$p:/usr/contrib/win32/bin:$PATH_WINDOWS
	test -d /usr/X11R5/bin && p=$p:/usr/X11R5/bin

	LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
	esac
	LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
	export LD_LIBRARY_PATH LD_LIBRARY_PATH_ORG
fi
PATH=$p; export PATH
#%%END sync Setup.sh with setup.ksh %% paths

# Check some stuff
myuid=${user%%:*}
mygid=${user##*:}
test=.mirports.test.$$.$RANDOM
x=0; print -n >$T/$test && chown $myuid $T/$test && chgrp $mygid $T/$test \
    && chown $myuid:$mygid $T/$test && rm $T/$test && x=1
if [[ $x = 0 ]]; then
	print -u2 "Error: Cannot use UID '$myuid', GID '$mygid'!"
	exit 1
fi
if [[ -d $etc || $etc != @@($localbase/)* ]]; then
	x=0; print -n >$etc/$test && chown $myuid $etc/$test && chgrp $mygid $etc/$test \
	    && chown $myuid:$mygid $etc/$test && rm $etc/$test && x=1
	if [[ $x = 0 ]]; then
		print -u2 "Error: Cannot access '$etc' for UID '$myuid', GID '$mygid'!"
		exit 1
	fi
fi
[[ $myuid = root ]] || export BINOWN=$myuid
[[ $mygid = bin ]] || export BINGRP=$mygid
[[ $myuid = root ]] || export BINMODE=755
if [[ $isinterix = no && $myuid != root ]]; then
	# mostly copied from above (%% paths), except for the export
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
	esac
	export LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
fi
if [[ $isinterix = yes || $myuid != root ]]; then
	need_llp=yes
else
	need_llp=no
fi

isopenbsd=no
ismirbsd=no
isdarwin=no

case $(uname -s 2>/dev/null || uname) {
(Darwin*)
	isdarwin=yes
	defmanpath='/usr/local/share/man:/usr/X11R6/man:/usr/share/man'
	export BOOTSTRAP=yes
	;;
(Interix*)
	defmanpath='/usr/share/man:/usr/X11R6/man:/usr/X11R5/man'
	export FETCH_CMD=$fetch BOOTSTRAP=yes
	;;
(MidnightBSD*)
	ismnbsd=yes
	defmanpath='/usr/local/man:/usr/share/man:/usr/X11R6/man' #XXX
	export BOOTSTRAP=yes
	;;
(MirBSD*)
	ismirbsd=yes
	defmanpath='/usr/local/man:/usr/share/man:/usr/X11R6/man'
	;;
(OpenBSD*)
	if uname -M >/dev/null 2>&1; then
		ismirbsd=yes
	else
		isopenbsd=yes
	fi
	defmanpath='/usr/local/man:/usr/share/man:/usr/X11R6/man' #XXX
	;;
(*)
	print -u2 Cannot determine operating system.
	exit 1
	;;
}

if [[ $ismirbsd$isopenbsd$ismnbsd = *yes* && $user != root:bin ]]; then
	print -u2 WARNING: Using the MirPorts Framework without sudo is
	print -u2 highly discouraged if you do not need to do so. Several
	print -u2 applications install programs with setuid/setgid bits
	print -u2 set, leading to potential exploits of your user account.
	print -u2 In contrast, they handle suid-root and sgid-wheel properly.
	print -u2
	if [[ $isopenbsd$ismnbsd = yes ]]; then
		print -u2 Even on OpenBSD and MidnightBSD, you should \
		    install MirPorts with sudo.
		print -u2
	fi
fi

newmanpath=${MANPATH:-$defmanpath}
[[ :$newmanpath: = *:$localbase/man:* ]] || \
    newmanpath=$localbase/man:$newmanpath
newmanpath=${newmanpath%%+(:)}

case :$INFOPATH: in
*:$localbase/info:*) ;;
*)	INFOPATH=$localbase/info:$INFOPATH ;;
esac
export INFOPATH=${INFOPATH%%+(:)}

case :$PERL5LIB: in
*:$localbase/libdata/perl5:*) ;;
*)	PERL5LIB=$localbase/libdata/perl5:$localbase/libdata/perl5/site_perl:$PERL5LIB ;;
esac
export PERL5LIB=${PERL5LIB%%+(:)}

if (( iopt )); then
	# we are run under Interix pdksh
	portsdir=$(cd "$ourpath"; pwd)
else
	portsdir=$(realpath $ourpath)
fi

cp $portsdir/infrastructure/templates/fake.mtree $T/fake.mtree
if [[ $myuid != root ]]; then
	print 'g/[ug]name=[a-z]*/s///g\n'"/^.set/s/   /" \
	    "uname=$myuid gname=$mygid /\nwq" \
	    | ed -s $T/fake.mtree
fi
(print '/@@@@local/d\ni\n'; IFS=/; s=;
 for pc in $(print "$localbase"); do
	s="$s    "; print "$s$pc"
 done; print '.\nwq') | ed -s $T/fake.mtree
if whence -p mtree >/dev/null; then
	mtree -U -e -d -n -p / -f $T/fake.mtree
	run_mtree=1
else
	mkdir -p $localbase/{bin,db,include,info,lib{,data,exec}} \
	    $localbase/{man/{cat,man}{1,2,3,4,5,6,7,8},sbin,share}
	run_mtree=0
fi
mkdir -p $etc
usetmpdir=0
if [[ -z $PKG_TMPDIR ]]; then
	if ! f=$(mktemp /var/tmp/mirports.XXXXXXXXXX); then
		# May be Interix without mktemp.sh
		f=/tmp/mirports.$$$RANDOM
		if [[ -e $f ]]; then
			print -u2 Cannot generate temporary file.
			exit 1
		fi
		print >$f
		if [[ ! -e $f ]]; then
			print -u2 Cannot generate temporary file.
			exit 1
		fi
	fi
	g=$localbase/bin/.tmp.$$$RANDOM
	if ! builtin rename $f $g 2>&-; then
		usetmpdir=1
		export PKG_TMPDIR=$localbase/db/tmp
		if ! mkdir -p $PKG_TMPDIR; then
			print -u2 Cannot generate playpen base directory.
			exit 1
		fi
	else
		unset PKG_TMPDIR
	fi
	rm -f $f $g
else
	export PKG_TMPDIR
fi


# Install the ld(1) wrapper
rm -f $localbase/bin/ld
install -c -o $myuid -g $mygid -m 600 \
    $portsdir/infrastructure/install/ld-wrapper.ksh $localbase/bin/ld
ed -s $localbase/bin/ld <<-EOF
	1s!/bin/mksh!$MKSH!
	wq
EOF
chmod 555 $localbase/bin/ld
[[ $isdarwin = *yes* ]] && ln -f $localbase/bin/ld $localbase/db/libtool
[[ $isdarwin$ismnbsd = *yes* ]] && ln -f $localbase/bin/ld $localbase/db/collect2


# Check if we need to install mirmake
cd $T
cat >f <<EOF
_MIRMAKE_VER?=0
all:
	@@echo \${_MIRMAKE_VER}
EOF
shmk=$localbase/share/mmake
mv=20061228
f_ver=$(make -f f all)
f_verexist=$($localbase/bin/mmake -f f all 2>/dev/null)
(( nopt )) || if [[ $f_ver -ge $mv ]]; then
	# Version matches; write a wrapper if needed
	sysmk=$(make -f f ___DISPLAY_MAKEVARS=.SYSMK)
	m=$(whence -p make)
	if [[ $f_verexist -ge $mv ]]; then
		# We have already been here, keep the port
		:
	elif [[ $sysmk = $shmk ]]; then
		# Trouble ahead
		[[ $m = /usr/bin/make ]] || rm -f $m
	else
		wrapper=1 # Write a wrapper
		if [[ -x $localbase/bin/mmake && \
		    $(mmake -f f all) -lt $mv ]]; then
			[[ $(head -1 $localbase/bin/mmake) \
			    = "#!$MKSH" ]] || wrapper=0
		fi
		if [[ $wrapper = 1 ]]; then
			rm -f $localbase/bin/mmake
			cat >$localbase/bin/mmake <<-EOF
				#!$MKSH
				exec $m -m $shmk -m $sysmk "\$@@"
			EOF
			chown $myuid:$mygid $localbase/bin/mmake
			chmod 555 $localbase/bin/mmake
			mkdir -p $shmk
			# Fake package installation
			mkdir -p $localbase/db/pkg/mirmake-$f_ver-0-wrapper
			sed -e "s#/usr/mpkg#$localbase#" \
			    -e 's#@@subdir@@#devel/mirmake,wrapper#' \
			    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
			    >$localbase/db/pkg/mirmake-$f_ver-0-wrapper/+CONTENTS
			print mirmake wrapper, created by Setup.sh \
			    >$localbase/db/pkg/mirmake-$f_ver-0-wrapper/+COMMENT
		else
			print Upgrading MirMake, please wait...
			(cd $portsdir/devel/mirmake; \
			    . $localbase/db/SetEnv.sh; \
			    mmake repackage reupgrade clean)
		fi
	fi
fi
(( nopt )) || if [[ $(mmake -f f all 2>/dev/null) -lt $mv ]]; then
	if [[ $(cd $localbase/db/pkg && echo mirmake-*) != "mirmake-*" ]]; then
		print Upgrading MirMake, please wait...
		(cd $portsdir/devel/mirmake; \
		    . $localbase/db/SetEnv.sh; \
		    mmake repackage reupgrade clean)
	else
		# Too old (or nonexistant), install new mirmake
		dependdist make
		cd mirmake
		osmandir=man/cat
		if [[ $isinterix = yes ]]; then
			ostype=Interix
		elif [[ $ismnbsd = yes ]]; then
			ostype=MidnightBSD
		elif [[ $ismirbsd = yes ]]; then
			ostype=MirBSD
		elif [[ $isopenbsd = yes ]]; then
			ostype=OpenBSD
		elif [[ $isdarwin = yes ]]; then
			ostype=Darwin
			osmandir=man/man
		fi
		u=$myuid:$mygid
		[[ $u = root:bin ]] && u=
		set -e
		$SHELL ./Build.sh $ostype $localbase $osmandir mmake \
		    "" "" "" $SHELL $u
		$SHELL ./Install.sh
		set +e
		cd $T
		rm -rf mirmake
		# Fake package installation
		mkdir -p $localbase/db/pkg/mirmake-$f_ver-0-setup
		sed -e "s#/usr/mpkg#$localbase#" \
		    -e 's#@@subdir@@#devel/mirmake,setup#' \
		    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
		    >$localbase/db/pkg/mirmake-$f_ver-0-setup/+CONTENTS
		print MirOS make variant, installed by Setup.sh \
		    >$localbase/db/pkg/mirmake-$f_ver-0-setup/+COMMENT
	fi
fi

# Copy <*.mk> includes
cd $portsdir/infrastructure/install
cp mirports.sys.mk $T/
ed -s $T/mirports.sys.mk <<-EOF
	/^PORTSDIR/s#@@#$portsdir#
	/^LOCALBASE/s#@@#$localbase#
	wq
EOF
install -c -o $myuid -g $mygid -m 444 bsd.port.mk $shmk/
install -c -o $myuid -g $mygid -m 444 bsd.port.subdir.mk $shmk/
install -c -o $myuid -g $mygid -m 444 $T/mirports.sys.mk $shmk/


# Check if we need to install nroff
if [[ ! -f /usr/bin/nroff && ! -f $localbase/bin/nroff ]]; then
	dependdist nroff
	set -e
	for subdir in mirnroff/src/{usr.bin/oldroff,share/tmac}; do
		cd $subdir
		mmake NOMAN=yes obj
		mmake NOMAN=yes depend
		mmake NOMAN=yes
		mmake NOMAN=yes install
		cd ../../../..
	done
	set +e
	# Building this without NOMAN=yes can be done by a port.
	rm -rf mirnroff
	# Fake package installation
	mkdir -p $localbase/db/pkg/nroff-$f_ver-0-setup
	sed -e "s#/usr/mpkg#$localbase#" \
	    -e 's#@@subdir@@#essentials/nroff,setup#' \
	    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
	    >$localbase/db/pkg/nroff-$f_ver-0-setup/+CONTENTS
	print unix text processor, installed by Setup.sh \
	    >$localbase/db/pkg/nroff-$f_ver-0-setup/+COMMENT
fi
(( iopt )) && exit 0
unset NROFF


# Check if we need to install mtree
if [[ ! -x /usr/sbin/mtree && ! -x $localbase/bin/mtree ]]; then
	dependdist mtree
	set -e
	cd mtree
	mmake obj
	mmake depend
	mmake
	mmake install
	set +e
	cd ..
	rm -rf mtree
	# Fake package installation
	mkdir -p $localbase/db/pkg/mtree-$f_ver-0-setup
	sed -e "s#/usr/mpkg#$localbase#" \
	    -e 's#@@subdir@@#essentials/mtree,setup#' \
	    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
	    >$localbase/db/pkg/mtree-$f_ver-0-setup/+CONTENTS
	print mtree >$localbase/db/pkg/mtree-$f_ver-0-setup/+COMMENT
fi
[[ $run_mtree = 0 ]] &&	mtree -U -e -d -n -p / -f $T/fake.mtree


# Write environmental stuff
cat >$localbase/db/SetEnv.sh <<-EOF
	LOCALBASE='$localbase'
	PORTSDIR='$portsdir'
	SYSCONFDIR='$etc'
	X11BASE='$xfbase'
	MAKECONF='$localbase/db/mmake.cfg'
	BINOWN='$myuid'
	BINGRP='$mygid'
	PATH='$PATH'
	MANPATH='$newmanpath'
	INFOPATH='$INFOPATH'
	PERL5LIB='$PERL5LIB'
	XAPPLRESDIR='$localbase/lib/X11/app-defaults'
	XDG_CACHE_HOME=\$HOME/.etc/xdg/cache
	XDG_CONFIG_DIRS='$etc/xdg:/etc/xdg'
	XDG_CONFIG_HOME=\$HOME/.etc/xdg/config
	XDG_DATA_DIRS='$localbase/share/:/usr/local/share/:/usr/share/'
	XDG_DATA_HOME=\$HOME/.etc/xdg/data
EOF
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.sh <<-EOF
	LD_LIBRARY_PATH='$LD_LIBRARY_PATH'
EOF
[[ $MKSH = /bin/mksh ]] || \
    cat >>$localbase/db/SetEnv.sh <<-EOF
	MKSH='$MKSH'
EOF
cat >>$localbase/db/SetEnv.sh <<-EOF
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE MAKECONF
	export BINOWN BINGRP PATH LD_LIBRARY_PATH MKSH
	export MANPATH INFOPATH PERL5LIB XAPPLRESDIR XDG_CACHE_HOME
	export XDG_CONFIG_DIRS XDG_CONFIG_HOME XDG_DATA_DIRS XDG_DATA_HOME
EOF
[[ $isinterix = yes ]] && cat >>$localbase/db/SetEnv.sh <<-EOF
	unset INCLUDE LIB
EOF
[[ $usetmpdir = 1 ]] && cat >>$localbase/db/SetEnv.sh <<-EOF
	PKG_TMPDIR='$PKG_TMPDIR'
	export PKG_TMPDIR
EOF
[[ $myuid = root ]] || \
    print 'BINMODE=755; export BINMODE' >>$localbase/db/SetEnv.sh
cat >>$localbase/db/SetEnv.sh <<-'EOF'
	if [ -z "$SSL_CERT_DIR" -a -d $LOCALBASE/share/ca-certificates/. ]; then
		SSL_CERT_DIR=$LOCALBASE/share/ca-certificates
		export SSL_CERT_DIR
	fi
	:
EOF

cat >$localbase/db/SetEnv.csh <<-EOF
	setenv LOCALBASE '$localbase'
	setenv PORTSDIR '$portsdir'
	setenv SYSCONFDIR '$etc'
	setenv X11BASE '$xfbase'
	setenv MAKECONF '$localbase/db/mmake.cfg'
	setenv BINOWN '$myuid'
	setenv BINGRP '$mygid'
	setenv PATH '$PATH'
	setenv MANPATH '$newmanpath'
	setenv INFOPATH '$INFOPATH'
	setenv PERL5LIB '$PERL5LIB'
	setenv XAPPLRESDIR '$localbase/lib/X11/app-defaults'
	setenv XDG_CACHE_HOME \$HOME/.etc/xdg/cache
	setenv XDG_CONFIG_DIRS '$etc/xdg:/etc/xdg'
	setenv XDG_CONFIG_HOME \$HOME/.etc/xdg/config
	setenv XDG_DATA_DIRS '$localbase/share/:/usr/local/share/:/usr/share/'
	setenv XDG_DATA_HOME \$HOME/.etc/xdg/data
EOF
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.csh <<-EOF
	setenv LD_LIBRARY_PATH '$LD_LIBRARY_PATH'
EOF
[[ $MKSH = /bin/mksh ]] || \
    cat >>$localbase/db/SetEnv.csh <<-EOF
	setenv MKSH '$MKSH'
EOF
[[ $isinterix = yes ]] && cat >>$localbase/db/SetEnv.csh <<-EOF
	unsetenv INCLUDE
	unsetenv LIB
EOF
[[ $usetmpdir = 1 ]] && cat >>$localbase/db/SetEnv.csh <<-EOF
	setenv PKG_TMPDIR '$PKG_TMPDIR'
EOF
[[ $myuid = root ]] || print 'setenv BINMODE 755' >>$localbase/db/SetEnv.csh
cat >>$localbase/db/SetEnv.csh <<-'EOF'
	if ( !($?SSL_CERT_DIR) && -d $LOCALBASE/share/ca-certificates/. ) then
		setenv SSL_CERT_DIR $LOCALBASE/share/ca-certificates
	endif
	true
EOF

cat >$localbase/db/SetEnv.make <<-EOF
	# called with $called_with

	LOCALBASE=	$localbase
	PORTSDIR?=	$portsdir
	SYSCONFDIR?=	$etc
	X11BASE?=	$xfbase
	MAKECONF=	$localbase/db/mmake.cfg
	BINOWN?=	$myuid
	BINGRP?=	$mygid
	_PORTPATH?=	$PATH
EOF
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.make <<-EOF
	_OUR_LDLIBPATH=	$LD_LIBRARY_PATH
EOF
[[ $MKSH = /bin/mksh ]] || \
    cat >>$localbase/db/SetEnv.make <<-EOF
	MKSH=		$MKSH
EOF
[[ $DISTDIR = $portsdir/Distfiles ]] || \
    cat >>$localbase/db/SetEnv.make <<-EOF
	DISTDIR=	$DISTDIR
EOF
[[ $myuid = root ]] || print 'BINMODE?=	755' >>$localbase/db/SetEnv.make

. $localbase/db/SetEnv.sh

warn_makecfg=0
[[ -s $localbase/db/make.cfg && ! -s $localbase/db/mmake.cfg ]] \
    && mv $localbase/db/make.cfg $localbase/db/mmake.cfg
[[ -s $localbase/db/mmake.cfg ]] && warn_makecfg=1
if [[ ! -s $localbase/db/mmake.cfg ]]; then
	cat >$localbase/db/mmake.cfg <<-EOF
		# Default to include system-wide configuration
	EOF
	if [[ -e /etc/mk.conf ]]; then
		cat >>$localbase/db/mmake.cfg <<-EOF
			# Older system-wide configuration
			.include "/etc/mk.conf"

		EOF
	fi
	cat >>$localbase/db/mmake.cfg <<-EOF
		.if exists(/etc/make.cfg)
		.  include "/etc/make.cfg"
		.endif

		# Some stubs
	EOF
	if [[ $myuid = root ]]; then
		cat >>$localbase/db/mmake.cfg <<-EOF
			SUDO=			sudo	# Default on for root
		EOF
	else
		cat >>$localbase/db/mmake.cfg <<-EOF
			SUDO=				# Default off for user
		EOF
	fi
	cat >>$localbase/db/mmake.cfg <<-EOF
		#CLEANDEPENDS=		No	# Default to yes
		#PREFER_SUBPKG_INSTALL=	No	# Default to yes
		#VMEM_AUTOUNLOCK=	Yes	# Default to no
	EOF
fi

if (( nopt )); then
	[[ $warn_makecfg = 1 ]] && cat >&2 <<-EOF
		Warning: $localbase/db/mmake.cfg already existed before!
		Please verify if this file contains desired settings.
	EOF
	print Finished partial setup. Issue one of these commands:
	print "% source $localbase/db/SetEnv.csh"
	print "\$ . $localbase/db/SetEnv.sh"
	exit 0
fi

f_ver=$(cd $portsdir/essentials/pkgtools && \
    mmake show='CVS_DISTDATE:C![^0-9]!!g')
if [[ $(cd $localbase/db/pkg && echo pkgtools-$f_ver-*) \
    != "pkgtools-$f_ver-*" ]]; then
	: # Current package tools are already installed
elif [[ $(cd $localbase/db/pkg && echo pkgtools-*) != "pkgtools-*" ]]; then
	print Upgrading package tools, please wait...
	(cd $portsdir/essentials/pkgtools; \
	    mmake repackage reupgrade clean)
else
	if (( topt == 0 )); then
		dependdist pkgtools
		cd $T/pkgtools
		app=
	else
		mkdir -p $T/pkgtools
		cd $T/pkgtools
		lndir $portsdir/infrastructure/pkgtools
		f_ver=20091227	# hardcoded here, update manually and seldom
		app=-opt_t
	fi
	export LOCALBASE=$localbase PORTSDIR=$portsdir
	set -e
	mmake obj
	mmake depend
	mmake PORTABLE=Yes BINOWN="$myuid"
	mmake install
	set +e
	unset LOCALBASE
	cd $T
	# Fake package installation
	mkdir -p $localbase/db/pkg/pkgtools-$f_ver-0$app
	sed -e "s#/usr/mpkg#$localbase#" \
	    -e 's#@@subdir@@#essentials/pkgtools,'${app#-}'#' \
	    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
	    >$localbase/db/pkg/pkgtools-$f_ver-0$app/+CONTENTS
	print autopackage tools, created by Setup.sh ${app:+from CVS} \
	    >$localbase/db/pkg/pkgtools-$f_ver-0$app/+COMMENT
	unset app
fi


# Check if we need to install cpio
# (Only install if it isn't there; the user can use pkg_upgrade himself)
[[ $ismirbsd = no ]] && if ! pkg_info paxmirabilis >/dev/null 2>&1; then
	set -e
	cd $portsdir/archivers/mircpio
	mmake fake
	x=$(mmake show=_FAKE_COOKIE)
	rm -f $localbase/bin/tar
	vp=${x%.fake_done}$(mmake show=PREFIX)/bin
	cp $vp/tar $localbase/bin/
	mmake package
	PATH=$vp:$PATH $localbase/sbin/pkg_add -N $(mmake show=_PACKAGE_COOKIE)
	set +e
	mmake clean
	cd $T
fi


# Check if we need to install patch
[[ $isinterix$ismnbsd = *yes* ]] && \
    if ! pkg_info patch >/dev/null 2>&1; then
	cd $portsdir/essentials/patch
	set -e
	mmake install
	set +e
	mmake clean
	cd $T
fi


# Check if we need to install cksum
[[ $isdarwin$isinterix$ismnbsd = *yes* ]] && \
    if ! pkg_info cksum >/dev/null 2>&1; then
	cd $portsdir/essentials/cksum
	set -e
	mmake install
	set +e
	mmake clean
	cd $T
fi


# Check if we need to install GNU m4
[[ $isinterix$ismnbsd = *yes* ]] && \
    if ! pkg_info m4 >/dev/null 2>&1; then
	cd $portsdir/lang/m4
	set -e
	mmake install
	set +e
	mmake clean
	cd $T
fi
[[ $isdarwin$isinterix$ismnbsd = *yes* ]] && unset BOOTSTRAP


# Check if we need to install GNU wget
[[ $isinterix = *yes* ]] && \
    if ! pkg_info wget >/dev/null 2>&1; then
	cd $portsdir/net/wget
	set -e
	mmake install
	set +e
	mmake clean
	cd $T
fi
[[ $isinterix = *yes* ]] && unset FETCH_CMD


# End of installation program

[[ $ismirbsd = yes ]] || rm -rf $localbase/tmp

(( topt )) || if [[ $ismirbsd$isopenbsd = *yes* && $myuid = root ]]; then
	print Augmenting user and group database...
	$SHELL $portsdir/infrastructure/install/mkuserdb.ksh
else
	print Please add the required users to your system manually.
fi

[[ $warn_makecfg = 1 ]] && cat >&2 <<-EOF
	Warning: $localbase/db/mmake.cfg already existed before!
	Please verify if this file contains desired settings.
EOF
if [[ $ismirbsd = yes && $myuid = root && $localbase = /usr/mpkg ]]; then
	print Finished first-time setup... have fun.
else
	print Should be done now... have fun. Issue one of these commands:
	print "% source $localbase/db/SetEnv.csh"
	print "\$ . $localbase/db/SetEnv.sh"
fi
exit 0
@


1.99
log
@change FETCH_CMD to end with -o (ftp, fetch) or -O (GNU wget)
and use this
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.98 2014/01/26 21:52:29 tg Exp $
d271 1
a271 1
	print -u2 applications install programmes with setuid/setgid bits
d810 1
a810 1
# End of installation programme
@


1.98
log
@this should fix a problem lewellyn is having with MirPorts on Interix (SUA)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.97 2010/01/21 17:20:53 tg Exp $
d44 1
a44 1
		$fetch $mirror$f_path
@


1.97
log
@bump pkgtools-opt_t vsn
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.96 2009/10/17 21:51:42 tg Exp $
d3 1
a3 1
# Copyright (c) 2005, 2008
d299 6
a304 1
portsdir=$(realpath $ourpath)
@


1.96
log
@new cool variable VMEM_AUTOUNLOCK including documentation
inspired by pkgsrc® which does this automagically and always, IIRC
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.95 2009/10/04 15:27:19 tg Exp $
d713 1
a713 1
		f_ver=20090829	# hardcoded here, update manually and seldom
@


1.95
log
@fix bootstrapping on Snow Leopard, I hope
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.94 2009/08/30 18:14:06 tg Exp $
d680 1
@


1.94
log
@new pkgtools, mirmake(beta):

• mirmake now has DLL/plugin separation in <bsd.lib.mk>,
  maybe work on Darwin, maybe not… bsiegert@@ please test
• pkgtools have proven to work, even with PKG_SUFX=.cpio
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.93 2009/03/29 13:04:05 tg Exp $
d744 2
a745 1
	cp ${x%.fake_done}$(mmake show=PREFIX)/bin/tar $localbase/bin/
d747 1
a747 1
	$localbase/sbin/pkg_add -N $(mmake show=_PACKAGE_COOKIE)
@


1.93
log
@• take care of dbins
• #!/bin/mksh shebang, in most places
• rcsid while here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.92 2008/12/29 19:49:15 tg Exp $
d712 1
a712 1
		f_ver=20081128	# hardcoded here, update manually and seldom
@


1.92
log
@do not use _VERSION any more, now that we use _CVS_DISTF
@
text
@d1 1
a1 2
#!/usr/bin/env mksh
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.91 2008/11/29 12:15:47 tg Exp $
@


1.91
log
@tazz noted that pkgtools remote addition is still broken in the last
released version, so bump the pkgtools port and re-roll the -current
ports and pkgutl snapshot
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.90 2008/11/08 18:45:25 tg Exp $
d695 2
a696 1
f_ver=$(cd $portsdir/essentials/pkgtools && mmake show=_VERSION)
@


1.90
log
@use the new pkgtools here, too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.89 2008/10/05 16:10:04 tg Exp $
d712 1
a712 1
		f_ver=20081108	# hardcoded here, update manually and seldom
@


1.89
log
@we have required a pretty up-to-date mksh for a while,
so make use of the “realpath” builtin
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.88 2008/05/31 20:56:53 bsiegert Exp $
d70 2
a71 1
	test $sum != good || if gzsig verify -q $T/$f_key $f_dist 2>/dev/null; then
d712 1
a712 1
		f_ver=20070431	# hardcoded here, update manually and seldom
@


1.88
log
@The package is called cksum, not mircksum. Stop installing cksum on _every_
invocation.
@
text
@d1 2
a2 2
#!/bin/mksh
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.87 2008/05/31 15:11:43 bsiegert Exp $
d299 1
a299 1
portsdir=$(readlink -nf $ourpath 2>/dev/null || (cd $ourpath && pwd -P))
@


1.87
log
@Fix typo (> instead of >>), port sh fragment to csh
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.86 2008/05/03 00:22:03 tg Exp $
d766 1
a766 1
    if ! pkg_info mircksum >/dev/null 2>&1; then
@


1.86
log
@ensure BINMODE is 755 for AS_USER installations
otherwise, install -c -s -m 555 fails.
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.85 2008/05/01 00:52:31 tg Exp $
d611 4
a614 6
cat >$localbase/db/SetEnv.csh <<-'EOF'
	#XXX convert this to csh
	#if [ -z "$SSL_CERT_DIR" -a -d $LOCALBASE/share/ca-certificates/. ]; then
	#	SSL_CERT_DIR=$LOCALBASE/share/ca-certificates
	#	export SSL_CERT_DIR
	#fi
@


1.85
log
@remove the advertising clause from all of my contributions
to the MirPorts Framework
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
d212 1
d566 2
d610 1
d644 1
@


1.84
log
@since not only pkg_upgrade but also pkg_add itself (and surely some of
the other package tools) call e.g. pkg_add without the full path, some
OS’s native package tools might come in the way
→ prefix $localbase/sbin to the system dirs too, not only $localbase/bin
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.83 2008/03/14 15:56:45 tg Exp $
d5 1
a5 1
#	Thorsten “mirabilos” Glaser <tg@@66h.42h.de>
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d13 8
a20 12
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
@


1.83
log
@no longer install lndir(1) and <tzfile.h>, as this has been fixed
in more recent versions of mirmake and paxmirabilis
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.82 2008/03/14 15:50:55 tg Exp $
d160 1
a161 1
	p=$localbase/bin
a168 1
	PATH=$p:$localbase/sbin; export PATH
a171 1
	p=$localbase/bin
a180 1
	PATH=$p; export PATH
d194 1
@


1.82
log
@supply a PKG_TMPDIR to assist installing/upgrading MirCpio on weird OSes
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.81 2008/03/12 23:43:11 tg Exp $
a507 17
# Check if we need to build lndir
if ! whence -p lndir >&-; then
	mkdir -p $T/lndir_build
	cp $portsdir/infrastructure/install/lndir.c $T/lndir_build/
	(cd $T/lndir_build; $localbase/bin/mmake \
	    -f $shmk/bsd.prog.mk PROG=lndir NOMAN=yes)
	install -c -m 755 $T/lndir_build/lndir $localbase/bin/
fi


# Install other missing files
if [[ $ismnbsd = yes && ! -e /usr/include/tzfile.h ]]; then
	rm -f $shmk/tzfile.h
	install -c -m 444 $portsdir/infrastructure/install/tzfile.h $shmk/
fi


@


1.81
log
@Initial support for running the MirPorts Framework (mirports)
on MidnightBSD (mnbsd), parallel to their native “mports”:
• the test was on stargazer, which is a FreeBSD “upgraded” to
  mnbsd, so there may be differences to a real mnbsd-current
• we do need upgraded MirMake, but I didn’t release that yet,
  since I’d have to test it first
• the default MANPATH needs a re-check, like OpenBSD
• the setup.ksh change installs lndir(1) and a tzfile.h from
  ports/infrastructure/install/ manually; this should be moved
  into MirMake (at least lndir, which is part of XFree86®, which,
  in turn, is seen less and less in the public, sadly)
• builds paxmirabilis (MirCpio), MirPatch, GNU m4, MirCksum,
  lndir (see above), and the MirPackageTools ☺
• uses gcc spec file, like Darwin, to call native ld as collect2
  after parsing -Wl,--library-after (XXX why does OpenBSD not
  need this, does it use $PATH to call ld? if so, why none else?)
• XXX HAS_TIMET64=No on LP64 platforms?
• XXX does mnbsd not have systrace?

Additional tweaks:
• bump © and stuff
• use a temporary playpen in LOCALBASE/tmp while upgrading,
  so that pkg_add paxmirabilis*cgz does not need to use tar
  to copy over the new files _after_ removing tar…
• use full path to pkg_add when calling it manually
• resolve possible conflict of a native rmd160(1) while
  bootstrapping GNU m4, when MirCksum is already installed
  XXX remove _CKSUM_SIZE and _CKSUM_A compatibility crap ASAP
• if collect2 isn’t known by gcc, use ld instead in the wrapper
• in pkgtools, always link against libmirmake unless OpenBSD/MirBSD
  (XXX in cksum, we always link against it if it exists)
• XXX possibly remove the dependency of MirCpio to tzfile.h
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.80 2008/02/24 11:36:30 tg Exp $
d326 29
a354 4
if [[ $ismirbsd = no ]]; then
	# create playpen base, so that pkg_add of paxmirabilis works
	mkdir -p $localbase/tmp
	export PKG_TMPDIR=$localbase/tmp
d585 4
a588 1

d628 3
a630 1

@


1.80
log
@try to work around the idiocy in Leopard’s new gcc

developed at FOSDEM night together with bsiegert@@
tested on gecko2@@’s laptop
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.79 2008/02/24 10:38:08 tg Exp $
d4 2
a5 2
# Copyright (c) 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d251 5
d274 1
a274 1
if [[ $ismirbsd$isopenbsd = *yes* && $user != root:bin ]]; then
d281 3
a283 2
	if [[ $isopenbsd = yes ]]; then
		print -u2 Even on OpenBSD, you should install MirPorts with sudo.
d326 5
d342 2
a343 4
if [[ $isdarwin = *yes* ]]; then
	ln -f $localbase/bin/ld $localbase/db/libtool
	ln -f $localbase/bin/ld $localbase/db/collect2
fi
d412 2
d483 17
d733 1
d736 1
a736 1
	pkg_add -N $(mmake show=_PACKAGE_COOKIE)
d744 1
a744 1
[[ $isinterix = *yes* ]] && \
d756 1
a756 1
[[ $isdarwin$isinterix = *yes* ]] && \
d768 1
a768 1
[[ $isinterix = *yes* ]] && \
d777 1
a777 1
[[ $isdarwin$isinterix = *yes* ]] && unset BOOTSTRAP
d795 2
@


1.79
log
@add hook for ca-certificates package (e.g. to assist alpine on OSX)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.78 2007/04/30 13:07:35 tg Exp $
d331 4
a334 1
[[ $isdarwin = *yes* ]] && ln -f $localbase/bin/ld $localbase/db/libtool
@


1.78
log
@• if installing packages at setup time, install them as if they had a
  flavour “setup” and specially handle the comment, etc.
• if installing mirmake as mere /usr/bin/make wrapper, install it as
  if it had a flavour “wrapper” instead
• take care of pkgpaths (these might give out-of-date warnings, so be it;
  besides we can fix this in out-of-date, or it might even be ok like this)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.77 2007/04/01 01:24:04 tg Exp $
d530 8
d570 9
@


1.77
log
@add a subdir comment for the fake-packages, to benefit scripts/out-of-date
XXX essentials/nroff essentials/mtree still missing
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.76 2007/01/18 19:41:29 tg Exp $
d372 1
a372 1
			mkdir -p $localbase/db/pkg/mirmake-$f_ver-0
d374 1
a374 1
			    -e 's#@@subdir@@#devel/mirmake,#' \
d376 3
a378 2
			    >$localbase/db/pkg/mirmake-$f_ver-0/+CONTENTS
			print mirmake >$localbase/db/pkg/mirmake-$f_ver-0/+COMMENT
d418 1
a418 1
		mkdir -p $localbase/db/pkg/mirmake-$f_ver-0
d420 1
a420 1
		    -e 's#@@subdir@@#devel/mirmake,#' \
d422 3
a424 3
		    >$localbase/db/pkg/mirmake-$f_ver-0/+CONTENTS
		print MirOS make variant \
		    >$localbase/db/pkg/mirmake-$f_ver-0/+COMMENT
d457 1
a457 1
	mkdir -p $localbase/db/pkg/nroff-$f_ver-0
d459 1
a459 1
	    -e 's#@@subdir@@#essentials/nroff,#' \
d461 3
a463 2
	    >$localbase/db/pkg/nroff-$f_ver-0/+CONTENTS
	print unix text processor >$localbase/db/pkg/nroff-$f_ver-0/+COMMENT
d482 1
a482 1
	mkdir -p $localbase/db/pkg/mtree-$f_ver-0
d484 1
a484 1
	    -e 's#@@subdir@@#essentials/mtree,#' \
d486 2
a487 2
	    >$localbase/db/pkg/mtree-$f_ver-0/+CONTENTS
	print mtree >$localbase/db/pkg/mtree-$f_ver-0/+COMMENT
d649 1
d654 2
a655 1
		f_ver=20061227	# hardcoded here, update manually and seldom
d667 1
a667 1
	mkdir -p $localbase/db/pkg/pkgtools-$f_ver-0
d669 1
a669 1
	    -e 's#@@subdir@@#essentials/pkgtools,#' \
d671 4
a674 2
	    >$localbase/db/pkg/pkgtools-$f_ver-0/+CONTENTS
	print autopackage tools >$localbase/db/pkg/pkgtools-$f_ver-0/+COMMENT
@


1.76
log
@* patch applications that adhere to the XDG specification¹ to use ~/.etc/
* create² XDG base directories
* tell XDG applications of ${LOCALBASE} and ${SYSCONFDIR}

¹) http://standards.freedesktop.org/basedir-spec/basedir-spec-0.6.html
²) even though the spec, pointed to me by Jonathan "ciruZ" Schleifer
   (thanks), says that's not necessary and they'll do it themselves
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.75 2006/12/28 03:34:26 tg Exp $
d374 1
d419 1
d458 1
d482 1
d665 1
@


1.75
log
@"cksum" interaction trouble
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.74 2006/12/28 03:11:33 tg Exp $
d500 5
d517 2
a518 1
	export MANPATH INFOPATH PERL5LIB XAPPLRESDIR
d537 5
@


1.74
log
@path for pkgtools changed
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.73 2006/12/28 02:33:13 tg Exp $
d245 1
d706 1
a706 1
[[ $isinterix = *yes* ]] && unset BOOTSTRAP
@


1.73
log
@tentatively upgrade to new mirmake version, which should
fix the Mac problems, fixes endianness problems, and has
been tested on miros on i386 and (few) mac osx on macppc
but should even continue to work on GNU/Linux...
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.72 2006/12/28 01:02:32 tg Exp $
d630 1
a630 1
		cd $T/ports/infrastructure/pkgtools
d632 2
a633 2
		mkdir -p $T/ports/infrastructure/pkgtools
		cd $T/ports/infrastructure/pkgtools
@


1.72
log
@source SetEnv.sh after writing, to make it available
to the remainder of the script
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.71 2006/12/28 00:22:18 tg Exp $
d341 1
a341 1
mv=20061006
@


1.71
log
@* PRIORITY UPDATE for the package tools, contains several
  crucial bug fixes regarding dependency handling; everyone
  is advised to upgrade, even 23C3 Live+Install CD users
* switch pkgtools from CVS_DISTF to hand-generated distfiles,
  to aid persons whose <bsd.port.mk> _and_ package tools
  were out of date (e.g. MirOS #9-stable users)

Known bug: install from ftp/http is still b0rken,
but I wanted to get this update out NOW.
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.70 2006/12/23 04:17:50 tg Exp $
d569 2
a625 1
	    . $localbase/db/SetEnv.sh; \
@


1.70
log
@update with the essential bug fixes
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.69 2006/11/17 00:18:46 tg Exp $
d634 1
a634 1
		f_ver=20061223	# hardcoded here, update manually and seldom
@


1.69
log
@systrace the 'make setup' so it only writes to /usr/mpkg
(and temporarily to /etc) during operation
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.68 2006/10/17 21:08:05 tg Exp $
d634 1
a634 1
		f_ver=20061013	# hardcoded here, update manually and seldom
@


1.68
log
@* setup.ksh: add -T option to Setup.sh(8) to use the checked-out copy of
  the package tools instead of downloading a distfile, document it and
  why (mostly for people who install from a CD, want to pkg_add binary
  packages and don't bother with the other stuff and downloading, e.g.
  in a restricted / non-networked environment)
* Makefile: use -T for 'make setup'

Note:	-T isn't something "mere users" should use at all. If you have
	used -T during your setup, it's highly recommended to execute
	$ cd $portsdir/essentials/pkgtools; mmake repackage reupgrade clean
	if and as soon as you can.
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.67 2006/10/13 17:25:59 tg Exp $
d722 1
a722 1
if [[ $ismirbsd$isopenbsd = *yes* && $myuid = root ]]; then
@


1.67
log
@use source tarballs for pkgtools
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.66 2006/10/13 17:16:31 tg Exp $
d32 1
a32 1
	print -u2 "\t[-l localbase] [-X xfbase] [-N]"
d132 3
a134 2
let iopt=0
let nopt=0
d136 1
a136 1
while getopts "DE:ehil:NU:uX:" opt; do
d142 1
a142 1
	(i)	let iopt=1 ;;
d145 1
d627 9
a635 2
	dependdist pkgtools
	cd $T/ports/infrastructure/pkgtools
@


1.66
log
@instead of erroring out with "you must upgrade FOO via ports", just do it
(experimental, untested, might break stuff)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.65 2006/10/13 12:50:43 tg Exp $
d625 2
a626 3
	mkdir $T/pkgtools
	cd $T/pkgtools
	lndir $portsdir/infrastructure/pkgtools
d641 1
a641 1
	print package tools >$localbase/db/pkg/pkgtools-$f_ver-0/+COMMENT
@


1.65
log
@bump the minimum mirmake version that is ok for the wrapper (i.e. instead
of building mirmake, wrapping /usr/bin/make with -m $localbase/share/mmake)
to the most current one, i.e. post the 2006-10-04 snapshot, post the C++
stability/reliability improvements.

of course, mirmake isn't up to the task yet, but that'll change later this
day, I suppose... (the devel/mirmake port however is)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.64 2006/10/06 14:08:02 tg Exp $
d353 1
a353 1
		# Write a wrapper
d356 2
a357 6
			if [[ $(head -1 $localbase/bin/mmake) \
			    != "#!$MKSH" ]]; then
				print -u2 Error: You must upgrade MirMake \
				    via ports.
				exit 1
			fi
d359 53
a411 8
		rm -f $localbase/bin/mmake
		cat >$localbase/bin/mmake <<-EOF
			#!$MKSH
			exec $m -m $shmk -m $sysmk "\$@@"
		EOF
		chown $myuid:$mygid $localbase/bin/mmake
		chmod 555 $localbase/bin/mmake
		mkdir -p $shmk
d417 2
a418 7
		print mirmake >$localbase/db/pkg/mirmake-$f_ver-0/+COMMENT
	fi
fi
(( nopt )) || if [[ $(mmake -f f all 2>/dev/null) -lt $mv ]]; then
	if [[ $(cd $localbase/db/pkg && echo mirmake-*) != "mirmake-*" ]]; then
		print -u2 Error: You must upgrade MirMake via ports.
		exit 1
a419 28
	# Too old (or nonexistant), install new mirmake
	dependdist make
	cd mirmake
	osmandir=man/cat
	if [[ $isinterix = yes ]]; then
		ostype=Interix
	elif [[ $ismirbsd = yes ]]; then
		ostype=MirBSD
	elif [[ $isopenbsd = yes ]]; then
		ostype=OpenBSD
	elif [[ $isdarwin = yes ]]; then
		ostype=Darwin
		osmandir=man/man
	fi
	u=$myuid:$mygid
	[[ $u = root:bin ]] && u=
	set -e
	$SHELL ./Build.sh $ostype $localbase $osmandir mmake "" "" "" $SHELL $u
	$SHELL ./Install.sh
	set +e
	cd $T
	rm -rf mirmake
	# Fake package installation
	mkdir -p $localbase/db/pkg/mirmake-$f_ver-0
	sed -e "s#/usr/mpkg#$localbase#" \
	    <$portsdir/infrastructure/templates/basepkg.CONTENTS \
	    >$localbase/db/pkg/mirmake-$f_ver-0/+CONTENTS
	print MirOS make variant >$localbase/db/pkg/mirmake-$f_ver-0/+COMMENT
d620 4
a623 2
	print -u2 Error: upgrade pkgtools via ports.
	exit 1
@


1.64
log
@mention that -u/-U are best avoided if possible to use sudo, and why
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.63 2006/09/20 22:24:49 tg Exp $
d339 1
a339 1
mv=20051220
@


1.63
log
@catch signal 5 too, idea from original lynx "oldlynx" sample script, thanks TD
while here, update licences where I can
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.62 2006/08/16 19:46:25 tg Exp $
d266 13
@


1.62
log
@install the ld-wrapper for darwin libtool, too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.61 2006/07/23 17:42:34 tg Exp $
d14 2
a15 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d25 1
a25 1
# the possibility of such damage or existence of a nontrivial bug.
d119 1
a119 1
trap 'rm -rf $T; exit 1' 1 2 3 13 15
@


1.61
log
@add an ld(1) wrapper which provides --library-after=X as new option,
which works like --library-path=X (-LX), install the wrapper and use
it for ${LOCALBASE}/lib and (USE_X11=Yes) ${X11BASE}/lib

now curl 7.15.4 can be built while curl 7.15.1 (missing function
in /usr/mpkg/lib/libcurl.so.something which is new in the new version)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.59 2006/06/25 07:55:27 tg Exp $
d315 1
@


1.60
log
@fix re-setup troubles
@
text
@d306 11
@


1.59
log
@apparently I'm prone to reverse-logic errors
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.58 2006/06/25 00:59:03 tg Exp $
d316 1
d321 4
a324 1
	if [[ $sysmk = $shmk ]]; then
d338 1
@


1.58
log
@require paxmirabilis on all (non-MirOS) OSes
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.57 2006/05/27 19:47:33 tg Exp $
d608 1
a608 1
[[ $ismirbsd = no ]] || if ! pkg_info paxmirabilis >/dev/null 2>&1; then
@


1.57
log
@quell a warning (found on gecko2's G4)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.56 2006/05/26 23:00:04 tg Exp $
d608 1
a608 2
[[ $isdarwin$isinterix = *yes* ]] && \
    if ! pkg_info paxmirabilis >/dev/null 2>&1; then
@


1.56
log
@build pkgtools in temp dir
+ no hanging obj/
+ works on live CD
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.55 2006/03/19 21:34:21 tg Exp $
d349 1
a349 1
(( nopt )) || if [[ $(mmake -f f all) -lt $mv ]]; then
@


1.55
log
@infrastructure for using multiple keys
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.54 2006/03/19 20:31:47 tg Exp $
d585 3
a587 1
	cd $portsdir/infrastructure/pkgtools
a589 1
	mmake cleandir
a590 1
	mmake cleandir
a594 1
	rm -rf {add,create,delete,info,lib,pkg,rtfm,upgrade}/obj
@


1.54
log
@better yet: don't overwrite mmake script,
just don't check the version in semiupgrade (-N) case
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.53 2006/03/19 20:28:24 tg Exp $
d75 1
a75 1
	test $sum != good || if gzsig verify -q $T/signkey $f_dist 2>/dev/null; then
@


1.53
log
@* oops, add "N" to getopts call
* allow $localbase/bin/mmake script to be overwritten
* log own invocation params
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.52 2006/03/19 20:24:24 tg Exp $
d316 1
a316 1
if [[ $f_ver -ge $mv ]]; then
a333 1
		rm -f $localbase/bin/mmake
d349 1
a349 1
if [[ $(mmake -f f all) -lt $mv ]]; then
@


1.52
log
@add a -N mode for "simple" rewriting of SetEnv & friends
unsupported of course ;)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.51 2006/02/26 00:26:24 tg Exp $
d122 2
d135 1
a135 1
while getopts "DE:ehil:U:uX:" opt; do
d334 1
d506 2
@


1.51
log
@drop support for /etc/${MAKE:T}.cfg

we now add /etc/make.cfg in $LOCALBASE/db/mmake.cfg
(attention MirOS users, to make this work for building
pkgtools from source you must source SetEnv.sh)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.50 2006/02/20 20:09:06 tg Exp $
d32 1
a32 1
	print -u2 "\t[-l localbase] [-X xfbase]"
d130 2
a131 1
iopt=0
d139 1
a139 1
	(i)	iopt=1 ;;
d141 1
d417 1
a417 1
[[ $iopt = 1 ]] && exit 0
d562 11
@


1.50
log
@do not duplicate any data
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.49 2006/02/07 21:36:36 tg Exp $
a529 6
		.if exists(/etc/\${MAKE:T}.cfg)
		.  include "/etc/\${MAKE:T}.cfg"
		.elif exists(/etc/make.cfg)
		.  include "/etc/make.cfg"
		.endif

d539 4
@


1.49
log
@add localbase/sbin always to path (on 'normal' systems)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.48 2006/01/25 20:50:50 tg Exp $
d562 1
a562 1
f_ver=$(<$portsdir/infrastructure/pkgtools/VERSION)
@


1.48
log
@PKG_USER -> BINOWN
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.47 2005/12/28 17:28:57 tg Exp $
d157 1
a157 1
	    /usr/sbin /sbin $localbase/sbin; do
d163 1
a163 1
	PATH=$p; export PATH
@


1.47
log
@* Makefile: /etc/X11/app-defaults is the place to go for 'em
* setup.ksh: add XAPPLRESDIR override to SetEnv files
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.46 2005/12/28 00:28:24 tg Exp $
d577 1
a577 1
	mmake PORTABLE=Yes PKG_USER="$myuid"
@


1.46
log
@bsiegert@@ annoyed me much enough to add the +COMMENT files to
the faked packages
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.45 2005/12/23 20:18:11 tg Exp $
d454 1
d467 1
a467 1
	export MANPATH INFOPATH PERL5LIB
d485 1
@


1.45
log
@fix version used in faking installed mirmake package
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.44 2005/12/20 20:20:56 tg Exp $
d342 1
d377 1
d413 1
d436 1
d586 1
@


1.44
log
@don't resolve the DISTDIR symlink here, it may be useful sometimes
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.43 2005/12/20 20:19:48 tg Exp $
d311 2
a312 1
if [[ $(make -f f all) -ge $mv ]]; then
@


1.43
log
@fix up the worst errors, WFM now (basically, didn't test what happens
if you have installed older versions)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.42 2005/12/20 20:13:21 tg Exp $
a436 2
DISTDIR=$(readlink -nf $DISTDIR)

@


1.42
log
@crude attempt to fake packages on setup for pkgtools, mirmake,
(interix only) nroff, mtree (i.e. everything pre-cpio)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.41 2005/12/20 19:57:53 tg Exp $
d519 1
a519 1
[[ -s $localbase/db/mmake.cfg && ! -s $localbase/db/make.cfg ]] \
a557 2
        if [[ $(cd $localbase/db/pkg && echo mirmake-*) != "mirmake-*" ]]; then

d560 1
a560 1
	# Current package tools are already installed
@


1.41
log
@make -> mmake, as discussed
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.40 2005/12/18 16:36:29 tg Exp $
d320 9
d336 5
d344 4
d370 5
d405 5
d427 5
d557 29
a585 13
cd $portsdir/infrastructure/pkgtools
export LOCALBASE=$localbase PORTSDIR=$portsdir
set -e
mmake cleandir
mmake obj
mmake cleandir
mmake depend
mmake PORTABLE=Yes PKG_USER="$myuid"
mmake install
set +e
rm -rf {add,create,delete,info,lib,pkg,rtfm,upgrade}/obj
unset LOCALBASE
cd $T
@


1.40
log
@Part 2 of the big commit:
* www/vbegin.php: don't output the UTF-8 BOM for now
* ports/Setup.sh: change order in which path is divined [1]
* ports/books/mirex: convert to CVS_DISTF
* ports/comms/ssfe: increase line length limit and history buffer size
* ports/infrastructure/install/setup.sh: sync path order with Setup.sh [1]
* ports/infrastructure/mk/bsd.port.mk: (_PORTPATH) sync default PATH [1]
* ports/infrastructure/mk/bsd.port.mk: (_UPGRADE_FLAGS) new, default to -a
* ports/infrastructure/mk/bsd.port.mk: (_upgrade) use it
* ports/infrastructure/mk/bsd.port.mk: (reupgrade) new target, set to -a -f
* ports/infrastructure/scripts/mkmcz: don't use $LOCALBASE, trust in PATH
* ports/infrastructure/mk/bsd.port.mk: (_CVS_FETCH) use _PORTPATH
* ports/infrastructure/pkgtools/create: treat /usr/info same as /usr/man
* ports/infrastructure/pkgtools/upgrade: fix path to temp +REQUIRED_BY
* ports/www/firesomething: break, suggest Opera-Linux/K-Meleon/Safari
* src/Makefile, src/gcc/Makefile.lang: if build GCJ, check if X11 installed
* src/Makefile, src/gnu/usr.bin/perl/Makefile.bsd-wrapper: defer h2ph
  execution to end of build
* src/distrib/lists: sync with pre-h2ph change
* src/etc/services: add openvpn, from IANA
* src/gcc/Makefile.inc, Makefile.lang: fragment out NO_*= stuff
* src/gcc/libjava/Makefile.bsd-wrapper: DEBUGPROGS is gone
* src/gnu/usr.bin/perl/Makefile.bsd-wrapper: flesh out h2ph, fix perms
* src/lib/libc/time/localtime.c: fix undefined extern
* ports/net/sirc/Makefile: automatically insert version into CTCP VERSION
* ports/net/sirc/dist/PROGRAMMING: document capab hooks
* ports/net/sirc/dist/dsircp: several hours of perl hacking with Club-Mate
  - publish $msgchannel, $talkserver [2]
  - support for CAPAB: publish $has_capab, $capab_cmd, $capab_response;
    add "capab" hook in reply
  - support for CAPAB IDENTIFY-MSG: publish $has_identifymsg; new
    $unverified, $unverified_m; enable automatically if present;
    change <...> [...] -...- to ... [[...]] ...
  - /describe nick now looks [*] (or [[*]]) instead of *, /me now looks
    # instead of * if identified, to facilitate this conversion
  - fix abuse of U+0060
  - sort /names [2]
  - fix ^B ^_ ^V [2]
  - remove trailing whitespace on outgoing msgs [2]
  - remove trailing whitespace on incoming msgs
  - fix indentation
  - auto-split overlong lines (partially [2])
  - in NOTICE make nick bold too [2]
  - disable DCC since it crashes
  - beautify CTCP TIME replies
  - add ACCEPT command (for ratbox-ircd, e.g. Freeforge)
* ports/net/sirc/pkg/DESCR: summarise new features

[1] all for the sake of bsiegert@@ wanting to not have to souce a
    SetEnv.sh or SetEnv.csh before building in "default MirPorts"
    (i.e. LOCALBASE=/usr/mpkg SYSCONFDIR=/etc BINOWN=root SUDO=sudo)
[2] adapted from http://co.ordinate.org/sirc/
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.39 2005/12/18 03:49:22 tg Exp $
d309 4
a312 3
shmk=$localbase/share/make
if [[ $(make -f f all) -ge 20051215 ]]; then
	# Version matches; check for ${.SYSMK}
d314 4
a317 6
	if [[ $ismirbsd = yes && $sysmk = /usr/share/mk \
	    && $localbase = /usr/mpkg && $myuid = root && $mygid = bin ]]; then
		# On MirOS-Default, use /usr/share/mk
		shmk=/usr/share/mk
	elif [[ $sysmk = $shmk ]]; then
		: # Everything OK, we don't need to update
d320 1
a320 2
		m=$(whence -p make)
		cat >$localbase/bin/make <<-EOF
d322 1
a322 1
			exec $m -m $localbase/share/make -m $sysmk "\$@@"
d324 2
a325 2
		chown $myuid:$mygid $localbase/bin/make
		chmod 555 $localbase/bin/make
d328 3
a330 2
else
	# Too old, install new mirmake
d347 1
a347 1
	$SHELL ./Build.sh $ostype $localbase $osmandir make "" "" "" $SHELL $u
d373 4
a376 4
		make NOMAN=yes obj
		make NOMAN=yes depend
		make NOMAN=yes
		make NOMAN=yes install
d392 4
a395 4
	make obj
	make depend
	make
	make install
d411 1
a411 1
	MAKECONF='$localbase/db/make.cfg'
d441 1
a441 1
	setenv MAKECONF '$localbase/db/make.cfg'
d467 1
a467 1
	MAKECONF=	$localbase/db/make.cfg
d486 5
a490 3
[[ -s $localbase/db/make.cfg ]] && warn_makecfg=1
if [[ ! -s $localbase/db/make.cfg ]]; then
	cat >$localbase/db/make.cfg <<-EOF
d494 2
d500 1
a500 1
		cat >>$localbase/db/make.cfg <<-EOF
d506 1
a506 1
	cat >>$localbase/db/make.cfg <<-EOF
d510 1
a510 1
		cat >>$localbase/db/make.cfg <<-EOF
d514 1
a514 1
		cat >>$localbase/db/make.cfg <<-EOF
d518 1
a518 1
	cat >>$localbase/db/make.cfg <<-EOF
d527 6
a532 6
make cleandir
make obj
make cleandir
make depend
make PORTABLE=Yes PKG_USER="$myuid"
make install
d545 5
a549 5
	make fake
	x=$(make show=_FAKE_COOKIE)
	cp ${x%.fake_done}$(make show=PREFIX)/bin/tar $localbase/bin/
	make package
	pkg_add -N $(make show=_PACKAGE_COOKIE)
d551 1
a551 1
	make clean
d561 1
a561 1
	make install
d563 1
a563 1
	make clean
d573 1
a573 1
	make install
d575 1
a575 1
	make clean
d585 1
a585 1
	make install
d587 1
a587 1
	make clean
d598 1
a598 1
	make install
d600 1
a600 1
	make clean
d616 1
a616 1
	Warning: $localbase/db/make.cfg already existed before!
@


1.39
log
@if make.cfg already existed, warn at the end of setup, not in the middle
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.38 2005/12/18 03:42:47 tg Exp $
d156 2
a157 8
	for a in /usr/local/bin $xfbase/bin /usr/X11R6/bin /usr/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin; do
d168 2
a169 8
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin $xfbase/bin /usr/X11R6/bin; do
@


1.38
log
@if we're the "master ports" on MirOS (mirbsd=yes, UID=root, localbase=/usr/mpkg)
issue a different finishing message since you don't need to source anything
(the scripts are still generated though)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.37 2005/12/17 05:46:19 tg Exp $
d498 2
a499 4
[[ -s $localbase/db/make.cfg ]] && cat >&2 <<-EOF
	Warning: $localbase/db/make.cfg already exists!
	Please verify if this file contains desired settings.
EOF
d624 4
@


1.37
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.36 2005/12/17 02:57:13 tg Exp $
d626 7
a632 3
print Should be done now... have fun. Issue one of the following commands:
print "% source $localbase/db/SetEnv.csh"
print "\$ . $localbase/db/SetEnv.sh"
@


1.36
log
@* move fake.mtree (generated) to LOCALBASE
* setup.ksh: only build what we really need, since we have a dependency now
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.35 2005/12/15 01:42:58 tg Exp $
d18 8
a25 7
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
@


1.35
log
@* update mirmake mandatorily to 20051215 for setup
* update mirmake port (people, use this one to upgrade your installation,
  I just did that as well, and it works)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.34 2005/12/15 01:39:20 tg Exp $
d292 1
a292 1
cp $portsdir/infrastructure/templates/fake.mtree $portsdir/infrastructure/db/
d296 1
a296 1
	    | ed -s $portsdir/infrastructure/db/fake.mtree
a297 1
cat $portsdir/infrastructure/db/fake.mtree >$T/fake.mtree
@


1.34
log
@remove pkgtools/upgrade/obj too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.33 2005/12/14 23:47:26 tg Exp $
d322 1
a322 1
if [[ $(make -f f all) -ge 20051110 ]]; then
@


1.33
log
@exit if -i is given (another Interix unbreak step)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.32 2005/12/14 23:11:45 tg Exp $
d545 1
a545 1
rm -rf {rtfm,pkg,lib,info,delete,create,add}/obj
@


1.32
log
@unset NROFF after building make, because it conflicts with what make thinks
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.31 2005/11/24 22:58:16 tg Exp $
d396 1
@


1.31
log
@what if mtree doesn't exist? run it later, fake some mkdir stuff earlier
(quite conservative - creates lots of directories which might be not needed)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.30 2005/11/17 23:54:19 tg Exp $
d396 1
@


1.30
log
@move essentials/cpio to archivers/mircpio
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.29 2005/11/16 11:49:41 tg Exp $
d303 8
a310 1
mtree -U -e -d -n -p / -f $T/fake.mtree
d411 1
@


1.29
log
@expose PORTSDIR to pkgtools and all later built stuff
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.28 2005/11/15 16:46:36 tg Exp $
d545 1
a545 1
	cd $portsdir/essentials/cpio
@


1.28
log
@* honour DISTDIR set in environment prior to /bin/sh Setup.sh
* propagate DISTDIR to SetEnv.make (should be in make.cfg, but
  that file is never overwritten by Setup.sh)
* honour fetch set in environment prior to /bin/sh Setup.sh
* commit first part of a manual page for Setup.sh/setup.ksh
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.27 2005/11/10 22:20:46 tg Exp $
d526 1
a526 1
export LOCALBASE=$localbase
@


1.27
log
@* texinfo: must not depend on m4, autoconf on Interix
* setup.ksh: install patch(1) as port on Interix
* setup.ksh: install GNU wget last (huge load of dependencies)
* mirports.sys.mk: add /usr/local/lib/bind to ld path on Interix
* network.conf.template: add some HTTP mirrors of GNU
* m4: must not depend on m4 on Interix
* m4: depends on texinfo on Interix
* wget: update to 1.10.2-1
* wget: add HTTP mirror of Debian
* wget: does not need GNU make
* wget: add -lbind (and its dependency -ldb) on Interix
  XXX I hope bdb4 does NOT get used by this... we actually
  XXX have a libdb.so.3.5 in base on Interix 3.5
* wget: 1,$ = % in ed(1) scripts
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.26 2005/11/10 20:38:10 tg Exp $
d42 1
a42 1
	cd $ourpath/Distfiles
d110 1
a110 1
if [[ $isinterix != @@(yes|no) || -z $mirror \
d407 1
d483 4
@


1.26
log
@* locate wget/fetch/ftp and nrcon in $localbase/bin too
* prefer installed MirPorts wget on Interix over Weihenstephan's
* Build.sh -d is auto-recognised in mksh R25
* redirect mksh man page installation errors to /dev/null
* need MirCpio on Interix too (I think)
* add glue for GNU wget, GNU m4 on Interix
* fix build of MirCksum package
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.25 2005/11/10 13:21:42 tg Exp $
d552 12
d576 1
a576 1
# Check if we need to install GNU wget
d578 2
a579 2
    if ! pkg_info wget >/dev/null 2>&1; then
	cd $portsdir/net/wget
d586 1
a586 1
[[ $isinterix = *yes* ]] && unset FETCH_CMD
d589 1
a589 1
# Check if we need to install GNU m4
d591 2
a592 2
    if ! pkg_info m4 >/dev/null 2>&1; then
	cd $portsdir/lang/m4
d599 1
@


1.25
log
@require latest MirMake (needed at least on Interix)

now, Interix bootstrap "almost" succeeds:
* wget isn't yet installed (no code written for that)
* cksum installation fails due to no wget installed
  (why is wget in BOOTSTRAP in mirports.sys.mk?)
* cksum installation fails, but setup.ksh does not abort

need to go to the univ now, sorry, can't continue
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.24 2005/11/10 13:07:57 tg Exp $
d253 1
d537 2
a538 1
[[ $isdarwin = *yes* ]] && if ! pkg_info paxmirabilis >/dev/null 2>&1; then
d552 12
d565 10
d577 8
a584 4
# Check if we need to install cksum
[[ $isdarwin$isinterix = *yes* ]] && if ! pkg_info mircksum >/dev/null 2>&1; then
	cd $portsdir/essentials/cksum
	make install clean
@


1.24
log
@remove INCLUDE and LIB environment variables on Interix
(these are usually added by command line MS cc versions)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.23 2005/11/09 20:46:14 tg Exp $
d314 1
a314 1
if [[ $(make -f f all) -ge 20051021 ]]; then
@


1.23
log
@* (sort of) fix _defmanpath
* Print the "source" commands for csh and sh as they must be used,
  so they can be directly copy'n'pasted
* This seems no longer experimental, thus remove the reference to playing
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.22 2005/11/08 12:04:43 tg Exp $
d433 3
d458 4
@


1.22
log
@commit initial support for Interix, fix some of the other stuff
for the non-root case

I'm testing this ATM, but my univ lectures continue in a few mins
(blame my economy prof! she's a ... <censored />)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.21 2005/10/21 20:10:28 tg Exp $
d256 1
a256 1
	defmanpath='/usr/{local,share,X11R6}/man/'
d264 1
a264 1
	defmanpath='/usr/{local,share,X11R6}/man/' #XXX
a434 1
	# unsupported, untested, etc.pp
d563 3
a565 2
print Should be done now... have fun.
print Source $localbase/db/SetEnv.sh for playing.
@


1.21
log
@* use new MirMake
* CFLAGS+= -> include bsd.own.mk + COPTS+=

both together make pkgtools use system cflags too
(mirmake itself doesn't, but it can't easily due to its portability)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.20 2005/10/09 18:48:08 tg Exp $
d373 15
d391 12
d543 1
d546 1
@


1.20
log
@* if we are on a system with /etc/mk.conf source that too
  (tested at install-time and hardcoded)
* if we have DEFCOPTS in the system-wide make configuration
  file, add that to COPTS by default, as expected as default
  behaviour on a MirOS system
* better indentation while here
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.19 2005/09/24 12:09:36 tg Exp $
d314 1
a314 1
if [[ $(make -f f all) -ge 20050912 ]]; then
a483 7
	if fgrep -q DEFCOPTS /etc/make.cfg /etc/mk.conf 2>/dev/null; then
		cat >>$localbase/db/make.cfg <<-EOF

			# Add MirOS default CFLAGS if desired
			COPTS?=			\${DEFCOPTS} \${GCEXTRA}
		EOF
	fi
@


1.19
log
@it does not make sense to have PORTPATH=_PORTPATH
instead, make only PORTPATH be prepended by ${WRKDIR}/bin
and _PORTPATH is the "shell" path
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.18 2005/09/24 12:01:25 tg Exp $
d460 9
d473 1
a473 1
			SUDO=		sudo		# Default on for root
d481 2
a482 2
		#CLEANDEPENDS=	No		# Default to yes
		#PREFER_SUBPKG_INSTALL=No	# Default to yes
d484 7
@


1.18
log
@use the path divined earlier as default _PORTPATH (with ${WRKDIR}/bin prepended)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.17 2005/09/19 20:48:56 tg Exp $
d438 1
a438 1
	_PORTPATH?=	\${WRKDIR}/bin:$PATH
@


1.17
log
@INFOPATH and PERL5LIB
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.16 2005/09/19 20:23:45 tg Exp $
d438 1
@


1.16
log
@add Darwin default $MANPATH
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.15 2005/09/19 19:56:47 tg Exp $
d276 13
d390 2
d403 2
a404 1
	export BINOWN BINGRP PATH MANPATH LD_LIBRARY_PATH MKSH
d418 2
@


1.15
log
@fix cpio build; add cksum while here. tested.

I hereby declare *SNIP* the MirPorts Framework open for Darwin!
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.14 2005/09/19 19:37:55 tg Exp $
d249 1
a249 1
	defmanpath= #XXX
@


1.14
log
@new mirmake -> Darwin support
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.13 2005/09/19 18:23:07 tg Exp $
d478 1
a478 1
	make TAR=/usr/bin/tar fake
d480 1
a480 1
	cp ${x%.fake_done}/bin/tar $localbase/bin/
d485 1
a489 1

d491 5
@


1.13
log
@hack some support for Darwin (untested)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.12 2005/09/18 21:22:52 tg Exp $
d474 1
@


1.12
log
@use mirmake-20050918
works well so far, for me
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.10 2005/09/18 21:16:56 tg Exp $
d470 1
d474 11
a484 1

@


1.11
log
@normalise paths (localbase, xfbase, etc) by removing trailing slashes
XXX what about non-absolute pathnames? oh horror...
@
text
@a343 9
	if [[ $MKSH != /bin/mksh ]]; then
		# temporary hack until mirmake-20050913 is used
		chmod u+w $localbase/bin/lorder
		ed -s $localbase/bin/lorder <<-EOF
			1s#/bin/mksh#$MKSH#
			wq
		EOF
		chmod u-w $localbase/bin/lorder
	fi
@


1.10
log
@only bother to call gzsig if one of the other methods succeeded
gzsig only checks integrity, but not if that's the one we wanted
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.9 2005/09/13 11:12:21 tg Exp $
d135 1
a135 1
	(E)	etc=$OPTARG ;;
d138 1
a138 1
	(l)	localbase=$OPTARG ;;
d141 1
a141 1
	(X)	xfbase=$OPTARG ;;
@


1.9
log
@mkdep gets $MKSH replaced by Build.sh (mirmake) already;
lorder should be a /bin/sh script but isn't in mirmake-20050912
(fixed upstream; remove this paragraph then)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.8 2005/09/13 11:05:20 tg Exp $
d74 1
a74 1
	test $sum = bad || if gzsig verify -q $T/signkey $f_dist 2>/dev/null; then
@


1.8
log
@lorder and mkdep start with #!/bin/mksh
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.7 2005/09/13 10:52:36 tg Exp $
d345 7
a351 8
		for f in $localbase/bin/{lorder,mkdep}; do
			chmod u+w $f
			ed -s $f <<-EOF
				1s#/bin/mksh#$MKSH#
				wq
			EOF
			chmod u-w $f
		done
@


1.7
log
@add user-definable $MKSH (probably still breaks in some places tho)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.6 2005/09/13 10:26:40 tg Exp $
d344 10
@


1.6
log
@* move scripts/mkuserdb -> install/mkuserdb.ksh
* move scripts/userlist -> templates/userlist.db
* use mkuserdb.ksh in setup.ksh if Open/MirBSD and root, warn otherwise
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.5 2005/09/13 00:12:23 tg Exp $
d314 1
a314 1
			#!/bin/mksh
d382 4
d388 1
a388 1
	export BINOWN BINGRP PATH MANPATH LD_LIBRARY_PATH
d407 4
d425 4
@


1.5
log
@add comment that cksum is definitively in place there

bsiegert@@ what about sort? where is it needed for?
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.4 2005/09/12 23:25:56 tg Exp $
d471 7
@


1.4
log
@really sync these two files
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.3 2005/09/12 23:23:53 tg Exp $
d466 3
@


1.3
log
@* sanitise comments
* remove "mirbsd or exit 1" test marker
* add BEGIN/END markers for code copied between these two files
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.2 2005/09/12 22:53:17 tg Exp $
d40 1
a40 1
	#%%BEGIN sync Setup.sh with setup.ksh %% getfile
d95 1
@


1.2
log
@join tg-ports-devel branch into HEAD
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.26 2005/09/12 22:47:12 tg Exp $
d40 1
d103 1
d150 2
a151 1
# Divine paths again (copied from Setup.sh)
d201 1
d224 1
a224 1
	# mostly copied from above, except for the export
a290 4
# XXX this is the place to install other stuff
# XXX mmake nroff cpio mtree wget
# XXX install <mirports.sys.mk> with/instead mmake
[[ $ismirbsd = yes ]] || exit 1
d358 6
d458 9
@


1.1
log
@file setup.ksh was initially added on branch tg-ports-devel.
@
text
@d1 454
@


1.1.2.1
log
@* continue writing the new installation script
* add facilities for installing as user and choosing a
  different localbase and x11base
* on Interix, don't add /usr/mpkg/lib to LD_LIBRARY_PATH
  if it's not part of the localbase
@
text
@a0 123
#!/bin/mksh
# $MirOS: src/share/misc/licence.template,v 1.2 2005/03/03 19:43:30 tg Rel $
#-
# Copyright (c) 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
#-
# This script really installs the MirPorts Framework.

me=$(basename $0)

function usage
{
	print -u2 "Syntax: $me [-u|-U user[:group]]] [-l localbase] [-X xfbase]"
	print -u2 "  -u\tinstall as user (default root:bin except on Interix)"
	exit 1
}

if [[ $isinterix != @@(yes|no) || -z $mirror \
    || -z $ourpath || -z $tempdir ]]; then
	print -u2 ERROR: Do not call this script directly!
	exit 1
fi
T=$tempdir

[[ -n $localbase ]] || localbase=/usr/mpkg
[[ -n $xfbase ]] || xfbase=/usr/X11R6
if [[ $interix = yes ]]; then
	user=$(id -un | sed 's! !\\ !g'):$(id -gn | sed 's! !\\ !g')
else
	user=root:bin
fi
iopt=0
while getopts "il:U:uX:" opt; do
	case $opt {
	(i)	iopt=1 ;;
	(l)	localbase=$OPTARG ;;
	(U)	user=$OPTARG ;;
	(u)	user=$(id -un):$(id -gn) ;;
	(X)	xfbase=$OPTARG ;;
	(*)	usage ;;
	}
done
shift $((OPTIND - 1))

[[ $isinterix = yes ]] && LD_LIBRARY_PATH=$LD_LIBRARY_PATH_ORG

# Divine paths again (copied from Setup.sh)
if test $isinterix = no; then
	p=$localbase/bin
	for a in /usr/local/bin $xfbase/bin /usr/X11R6/bin /usr/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	PATH=$p; export $PATH
else
	# On Interix, /usr/bin is /bin; gzip lives in /usr/contrib/bin;
	# gcc has yet its own directory; we have X11R5 as well
	p=$localbase/bin
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin $xfbase/bin /usr/X11R6/bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	fi
	test -n "$PATH_WINDOWS" && p=$p:/usr/contrib/win32/bin:$PATH_WINDOWS
	test -d /usr/X11R5/bin && p=$p:/usr/X11R5/bin
	PATH=$p; export $PATH

	export LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH
		LD_LIBRARY_PATH=${LD_LIBRARY_PATH%:}
		export LD_LIBRARY_PATH
		;;
	esac
fi

# Check some stuff
myuid=${user%%:*}
mygid=${user##*:}
x=0; print -n >$T/test && chown $myuid $T/test && chgrp $mygid $T/test \
    && chown $myuid:$mygid $T/test && rm $T/test && x=1
if [[ $x = 0 ]]; then
	print -u2 "Error: Cannot use UID '$myuid', GID '$mygid'!"
	exit 1
fi

@


1.1.2.2
log
@don't forget $xfbase/lib
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.1 2005/09/01 21:57:43 tg Exp $
d104 1
a104 5
	LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
d107 4
a110 1
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
a111 2
	LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
	export LD_LIBRARY_PATH LD_LIBRARY_PATH_ORG
@


1.1.2.3
log
@move LOCALBASE, SYSCONFDIR etc. to SetEnv.make (or SetEnv.sh, SetEnv.csh)
scripts, as discussed with bsiegert@@

SYSCONFDIR still defaults to /etc
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.2 2005/09/01 21:59:46 tg Exp $
d32 1
a32 3
	print -u2 "Syntax: $me [-u|-U user[:group]]] [-e|-E sysconfdir]"
	print -u2 "\t[-l localbase] [-X xfbase]"
	print -u2 "  -e\tset sysconfdir (default /etc; -e: \$localbase/etc)"
a50 1
etc=/etc
d52 1
a52 1
while getopts "E:eil:U:uX:" opt; do
a53 2
	(E)	etc=$OPTARG ;;
	(e)	etc=@@LOCALBASE@@/etc ;;
a64 1
[[ $etc = @@LOCALBASE@@* ]] && etc=$localbase${etc#@@LOCALBASE@@}
@


1.1.2.4
log
@* bring pkg_scan to Attic - we don't support upgrading anyway
* bring tkpkg to Attic... resurrecting is for volunteers
* write a bit more of the installer, to test on MirOS...
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.3 2005/09/01 22:15:26 tg Exp $
a41 1
	rm -rf $tempdir
a45 3
trap 'rm -rf $T; exit 1' 1 2 3 13 15
trap 'rm -rf $T; exit 0' 0

a132 66
let isopenbsd=0
let ismirbsd=0
let isdarwin=0

case $(uname -s 2>/dev/null || uname) {
(MirBSD*)
	let ismirbsd=1 ;;
(OpenBSD*)
	if uname -M >/dev/null 2>&1; then
		let ismirbsd=1
	else
		let isopenbsd=1
	fi
	;;
(Darwin*)
	let isdarwin=1 ;;
(*)
	print -u2 Cannot determine operating system.
	exit 1
	;;
}

# XXX this is the place to install other stuff
# XXX mmake nroff cpio mtree wget
# XXX install <mirports.sys.mk> with/instead mmake
(( ismirbsd == 1 )) || exit 1
MAKE=make

portsdir=$(readlink -nf $ourpath/../..)

cat >$localbase/db/SetEnv.sh <<-EOF
	LOCALBASE='$localbase'
	PORTSDIR='$portsdir'
	SYSCONFDIR='$etc'
	X11BASE='$xfbase'
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE
EOF

cat >$localbase/db/SetEnv.csh <<-EOF
	# unsupported, untested, etc.pp
	setenv LOCALBASE '$localbase'
	setenv PORTSDIR '$portsdir'
	setenv SYSCONFDIR '$etc'
	setenv X11BASE '$xfbase'
EOF

cat >$localbase/db/SetEnv.make <<-EOF
	LOCALBASE=	$localbase
	PORTSDIR?=	$portsdir
	SYSCONFDIR?=	$etc
	X11BASE?=	$xfbase
EOF

cd $portsdir/infrastructure/pkgtools
export LOCALBASE=$localbase
$MAKE cleandir
$MAKE obj
$MAKE cleandir
$MAKE depend
$MAKE PORTABLE=Yes
$MAKE install
unset LOCALBASE

print Should be done now... have fun.
print Source $localbase/db/SetEnv.sh for playing.
exit 0
@


1.1.2.5
log
@some further work on this quilt
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.4 2005/09/10 23:37:02 tg Exp $
d137 3
a139 3
isopenbsd=no
ismirbsd=no
isdarwin=no
d143 1
a143 1
	ismirbsd=yes ;;
d146 1
a146 1
		ismirbsd=yes
d148 1
a148 1
		isopenbsd=yes
d152 1
a152 1
	let isdarwin=yes ;;
a189 14
cp $portsdir/infrastructure/templates/fake.mtree $portsdir/infrastructure/db/
if [[ $myuid != root ]]; then
	print 'g/[ug]name=[a-z]*/s///g\n'"/^.set/s/   /" \
	    "uname=$myuid gname=$mygid /\nwq" \
	    | ed -s $portsdir/infrastructure/db/fake.mtree
fi
cat $portsdir/infrastructure/db/fake.mtree >$T/fake.mtree
(print '/@@@@local/d\ni\n'; IFS=/; s=;
 for pc in $(print "$localbase"); do
	s="$s    "; print "$s$pc"
 done; print '.\nwq') | ed -s $T/fake.mtree
mtree -U -e -d -n -p / -f $T/fake.mtree
mkdir -p $etc

@


1.1.2.6
log
@fix the worst programming errors
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.5 2005/09/11 00:23:53 tg Exp $
d59 1
a59 2
d=0
while getopts "DE:eil:U:uX:" opt; do
a60 1
	(D)	d=1 ;;
a74 1
[[ $d = 1 ]] && set -x
d84 1
a84 1
	done
d91 2
a92 2
	done
	PATH=$p; export PATH
d102 1
a102 1
	done
d109 1
a109 1
	done
d112 1
a112 1
	PATH=$p; export PATH
a135 2
[[ $myuid = root ]] || export BINOWN=$myuid
[[ $mygid = bin ]] || export BINGRP=$mygid
a158 16
portsdir=$(readlink -nf $ourpath/../.. 2>/dev/null || (cd $ourpath/../.. && pwd -P))

cp $portsdir/infrastructure/templates/fake.mtree $portsdir/infrastructure/db/
if [[ $myuid != root ]]; then
	print 'g/[ug]name=[a-z]*/s///g\n'"/^.set/s/   /" \
	    "uname=$myuid gname=$mygid /\nwq" \
	    | ed -s $portsdir/infrastructure/db/fake.mtree
fi
cat $portsdir/infrastructure/db/fake.mtree >$T/fake.mtree
(print '/@@@@local/d\ni\n'; IFS=/; s=;
 for pc in $(print "$localbase"); do
	s="$s    "; print "$s$pc"
 done; print '.\nwq') | ed -s $T/fake.mtree
mtree -U -e -d -n -p / -f $T/fake.mtree
mkdir -p $etc

d162 1
a162 1
[[ $ismirbsd = yes ]] || exit 1
d165 2
d190 14
@


1.1.2.7
log
@clean up
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.6 2005/09/11 00:49:37 tg Exp $
a210 1
set -e
a216 2
set +e
rm -rf {rtfm,pkg,lib,info,delete,create,add}/obj
@


1.1.2.8
log
@expose BINOWN and BINGRP to the 'world'
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.7 2005/09/11 00:53:33 tg Exp $
d191 1
a191 3
	BINOWN='$myuid'
	BINGRP='$mygid'
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE BINOWN BINGRP
a199 2
	setenv BINOWN '$myuid'
	setenv BINGRP '$mygid'
a206 2
	BINOWN?=	$myuid
	BINGRP?=	$mygid
@


1.1.2.9
log
@forgot the path
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.8 2005/09/11 01:09:50 tg Exp $
d193 1
a193 2
	PATH='$PATH'
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE BINOWN BINGRP PATH
a194 2
[[ $isinterix = yes ]] && \
    echo "export LD_LIBRARY_PATH='$LD_LIBRARY_PATH'" >>$localbase/db/SetEnv.sh
a203 1
	setenv PATH '$PATH'
@


1.1.2.10
log
@* -#ifndef __INTERIX
  +#ifndef AS_USER
       if (!Fake && getuid() != 0)
          errx(1, "you must be root to delete packages");
   #endif
  and similar
* make compile with __CRAZY=Yes

bsiegert@@ please look at this diff closely
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.9 2005/09/11 01:40:40 tg Exp $
d226 1
a226 1
$MAKE PORTABLE=Yes PKG_USER="$myuid"
@


1.1.2.11
log
@add LD_LIBRARY_PATH support for ordinary systems too
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.10 2005/09/11 02:04:02 tg Exp $
a140 17
if [[ $isinterix = no && $myuid != root ]]; then
	# mostly copied from above, except for the export
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
	esac
	export LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
fi
if [[ $isinterix = yes || $myuid != root ]]; then
	need_llp=yes
else
	need_llp=no
fi
d194 1
d196 2
a197 8
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.sh <<-EOF
	LD_LIBRARY_PATH='$LD_LIBRARY_PATH'
EOF
cat >>$localbase/db/SetEnv.sh <<-EOF
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE
	export BINOWN BINGRP PATH LD_LIBRARY_PATH
EOF
a208 4
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.csh <<-EOF
	setenv LD_LIBRARY_PATH '$LD_LIBRARY_PATH'
EOF
a217 4
[[ $need_llp = yes ]] && \
    cat >>$localbase/db/SetEnv.make <<-EOF
	_OUR_LDLIBPATH=	$LD_LIBRARY_PATH
EOF
@


1.1.2.12
log
@* complain if we need to install mksh and don't have write
  privs in /bin/ (e.g. install as user, no recent mksh available)
  XXX what about overrides to use an older (or newer) version?
* use ports/Distfiles/ for storing downloaded files (mksh, ...)
* don't download if it's already there
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.11 2005/09/11 02:12:20 tg Exp $
d60 1
a60 1
while getopts "DE:ehil:U:uX:" opt; do
@


1.1.2.13
log
@* always use 'make' ($localbase/bin/make) as MirMake executable name
* use $localbase/db/make.cfg instead of /etc/make.cfg
* include /etc/make.cfg by default in $localbase/db/make.cfg

This further unifies the look of the MirPorts Framework among platforms,
allows for better co-existence with/on other OSes, porting systems, and
parallel installations of several MirPorts instances even as the same user
(e.g. one with SUDO=sudo and LOCALBASE=/usr/mpkg, one for testing).
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.12 2005/09/11 15:07:50 tg Exp $
d201 1
a207 1
	MAKECONF='$localbase/db/make.cfg'
d217 1
a217 1
	export LOCALBASE PORTSDIR SYSCONFDIR X11BASE MAKECONF
a226 1
	setenv MAKECONF '$localbase/db/make.cfg'
a240 1
	MAKECONF=	$localbase/db/make.cfg
a248 7
cat >$localbase/db/make.cfg <<-EOF
	# Default to include system-wide configuration
	.if exists(/etc/\${MAKE:T}.cfg)
	.  include "/etc/\${MAKE:T}.cfg"
	.endif
EOF

d252 6
a257 6
make cleandir
make obj
make cleandir
make depend
make PORTABLE=Yes PKG_USER="$myuid"
make install
@


1.1.2.14
log
@don't overwrite make.cfg if exists and not empty
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.13 2005/09/11 15:15:30 tg Exp $
d251 1
a251 5
[[ -s $localbase/db/make.cfg ]] && cat >&2 <<-EOF
	Warning: $localbase/db/make.cfg already exists!
	Please verify if this file contains desired settings.
EOF
[[ -s $localbase/db/make.cfg ]] || cat >$localbase/db/make.cfg <<-EOF
@


1.1.2.15
log
@* fix an omission in Darwin
* sort OS list
* also set a static $MANPATH
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.14 2005/09/11 22:13:16 tg Exp $
a163 7
(Darwin*)
	isdarwin=yes
	defmanpath= #XXX
	;;
(Interix*)
	defmanpath='/usr/share/man:/usr/X11R6/man:/usr/X11R5/man'
	;;
d165 1
a165 3
	ismirbsd=yes
	defmanpath='/usr/{local,share,X11R6}/man/'
	;;
a171 1
	defmanpath='/usr/{local,share,X11R6}/man/' #XXX
d173 2
a180 1
newmanpath="$localbase/man:${MANPATH:-$defmanpath}"
a210 1
	MANPATH='$newmanpath'
d218 1
a218 1
	export BINOWN BINGRP PATH MANPATH LD_LIBRARY_PATH
a230 1
	setenv MANPATH '$newmanpath'
@


1.1.2.16
log
@check if we can use the given sysconfdir
(common to forget -e when -u)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.15 2005/09/11 23:02:07 tg Exp $
d133 2
a134 3
test=.mirports.test.$$.$RANDOM
x=0; print -n >$T/$test && chown $myuid $T/$test && chgrp $mygid $T/$test \
    && chown $myuid:$mygid $T/$test && rm $T/$test && x=1
a138 6
x=0; print -n >$etc/$test && chown $myuid $etc/$test && chgrp $mygid $etc/$test \
    && chown $myuid:$mygid $etc/$test && rm $etc/$test && x=1
if [[ $x = 0 ]]; then
	print -u2 "Error: Cannot access '$etc' for UID '$myuid', GID '$mygid'!"
	exit 1
fi
@


1.1.2.17
log
@use a mechanism similar to LD_LIBRARY_PATH for preventing dups in MANPATH
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.16 2005/09/11 23:05:00 tg Exp $
d196 1
a196 4
newmanpath=${MANPATH:-$defmanpath}
[[ :$newmanpath: = *:$localbase/man:* ]] || \
    newmanpath=$localbase/man:$newmanpath
newmanpath=${newmanpath%%+(:)}
@


1.1.2.18
log
@change $ourpath to PORTSDIR instead of PORTSDIR/infrastructure/install
(don't use pwd -P in Setup.sh because setup.ksh takes care of it)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.17 2005/09/11 23:09:57 tg Exp $
d200 1
a200 1
portsdir=$(readlink -nf $ourpath 2>/dev/null || (cd $ourpath && pwd -P))
@


1.1.2.19
log
@* change wording a bit
* copy "fetch and extract distfile" part to setup.ksh, as function dependdist
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.18 2005/09/12 20:13:24 tg Exp $
a38 70
function dependdist
{
	what=$1
	. $ourpath/infrastructure/install/distinfo.sh
	cd $ourpath/Distfiles
	test -r $f_dist || case "$mirror" in
	/*)	# file
		test -r $mirror/$f_path && cp $mirror/$f_path .
		test -r $mirror/$f_dist && cp $mirror/$f_dist .
		;;
	*)	# http
		$fetch $mirror$f_path
		;;
	esac
	sum=unchecked
	if s=`md5 $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_md5"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum = bad || if s=`cksum $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_sum"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum = bad || if s=`md5sum $f_dist 2>/dev/null`; then
		if test x"$s" = x"$f_md5sum"; then
			sum=good
		else
			sum=bad
		fi
	fi
	test $sum = bad || if gzsig verify -q $T/signkey $f_dist 2>/dev/null; then
		echo Note: cryptographically strong checksum verified successfully >&2
		sum=verygood
	fi
	if test $sum = unchecked; then
		echo Warning: Cannot check hashes for $f_dist >&2
		echo Please compare the following two lines manually >&2
		echo "$f_lsline" >&2
		echo ": `TZ=UTC /bin/ls -l $f_dist`" >&2
		echo Press RETURN to continue or abort if unsure. >&2
		read s
	fi

	if test $sum = bad; then
		echo Checksum verification failed >&2
		echo "false: $s" >&2
		cd
		rm -rf $T
		exit 1
	fi

	if gzip -dc $f_dist | (cd $T && cpio -id); then
		:
	else
		echo Build failed >&2
		cd
		rm -rf $T
		exit 1
	fi

	cd $T
}


d40 1
a40 1
    || -z $ourpath || -z $tempdir || -z $fetch ]]; then
@


1.1.2.20
log
@when debugging, disable traps (i.e. don't remove tempdir on exit)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.19 2005/09/12 20:41:16 tg Exp $
d132 1
a132 2
	(D)	trap - 0 1 2 3 13 15
		d=1 ;;
@


1.1.2.21
log
@when checking access to SYSCONFDIR, only check if it exists, or if
it's outside of $localbase
XXX cope with mtree
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.20 2005/09/12 21:39:43 tg Exp $
d211 5
a215 7
if [[ -d $etc || $etc != @@($localbase/)* ]]; then
	x=0; print -n >$etc/$test && chown $myuid $etc/$test && chgrp $mygid $etc/$test \
	    && chown $myuid:$mygid $etc/$test && rm $etc/$test && x=1
	if [[ $x = 0 ]]; then
		print -u2 "Error: Cannot access '$etc' for UID '$myuid', GID '$mygid'!"
		exit 1
	fi
@


1.1.2.22
log
@add code for building mirmake (1st test)
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.19 2005/09/12 20:41:16 tg Exp $
a293 68
# Check if we need to install mirmake
cd $T
cat >f <<EOF
_MIRMAKE_VER?=0
all:
	@@echo \${_MIRMAKE_VER}
EOF
shmk=$localbase/share/make
if [[ $(make -f f all) -ge 20040912 ]]; then
	# Version matches; check for ${.SYSMK}
	sysmk=$(make -f f ___DISPLAY_MAKEVARS=.SYSMK)
	if [[ $ismirbsd = yes && $sysmk = /usr/share/mk \
	    && $localbase = /usr/mpkg && $myuid = root && $mygid = bin ]]; then
		# On MirOS-Default, use /usr/share/mk
		shmk=/usr/share/mk
	elif [[ $sysmk = $shmk ]]; then
		: # Everything OK, we don't need to update
	else
		# Write a wrapper
		m=$(whence -p make)
		cat >$localbase/bin/make <<-EOF
			#!/bin/mksh
			exec $m -m $localbase/share/make -m $sysmk "\$@@"
		EOF
		chown $myuid:$mygid $localbase/bin/make
		chmod 555 $localbase/bin/make
		mkdir -p $shmk
	fi
else
	# Too old, install new mirmake
	dependdist make
	cd mirmake
	osmandir=man/cat
	if [[ $isinterix = yes ]]; then
		ostype=Interix
	elif [[ $ismirbsd = yes ]]; then
		ostype=MirBSD
	elif [[ $isopenbsd = yes ]]; then
		ostype=OpenBSD
	elif [[ $isdarwin = yes ]]; then
		ostype=Darwin
		osmandir=man/man
	fi
	u=$myuid:$mygid
	[[ $u = root:bin ]] && u=
	set -e
	$SHELL ./Build.sh $ostype $localbase $osmandir make "" "" "" $SHELL $u
	$SHELL ./Install.sh
	set +e
	cd $T
	rm -rf mirmake
fi

# Copy <*.mk> includes
cd $portsdir/infrastructure/install
cp mirports.sys.mk $T/
ed -s $T/mirports.sys.mk <<-EOF
	/^PORTSDIR/s#@@#$portsdir#
	/^LOCALBASE/s#@@#$localbase#
	wq
EOF
install -c -o $myuid -g $mygid -m 444 bsd.port.mk $shmk/
install -c -o $myuid -g $mygid -m 444 bsd.port.subdir.mk $shmk/
install -c -o $myuid -g $mygid -m 444 $T/mirports.sys.mk $shmk/


# Write environmental stuff

@


1.1.2.23
log
@use "Syntax: Setup.sh" not setup.ksh
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.22 2005/09/12 21:41:04 tg Exp $
d28 2
d32 1
a32 1
	print -u2 "Syntax: Setup.sh [-u|-U user[:group]]] [-e|-E sysconfdir]"
@


1.1.2.24
log
@* divine the C compiler (mgcc, gcc, cc)
  XXX should I consider looking into egcc? well, just setenv manually.
* fix the date used for mirmake currentness checks
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.23 2005/09/12 21:41:55 tg Exp $
d300 1
a300 1
if [[ $(make -f f all) -ge 20050912 ]]; then
@


1.1.2.25
log
@* Setup.sh, setup.ksh: be more verbose if gzsig(1) succeeds
* distinfo.sh: Use working mirmake
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.24 2005/09/12 21:46:43 tg Exp $
d74 1
a74 1
		echo Note: cryptographically strong checksum verified successfully for $f_dist >&2
@


1.1.2.26
log
@* add some useful stuff from old Setup.sh (commented out in make.cfg)
  which was formerly added to /etc/mk.conf
* in make.cfg, set (hard) SUDO to "" unless invoked as root ("sudo")
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/setup.ksh,v 1.1.2.25 2005/09/12 22:17:15 tg Exp $
d415 6
a420 23
if [[ ! -s $localbase/db/make.cfg ]]; then
	cat >$localbase/db/make.cfg <<-EOF
		# Default to include system-wide configuration
		.if exists(/etc/\${MAKE:T}.cfg)
		.  include "/etc/\${MAKE:T}.cfg"
		.endif

		# Some stubs
	EOF
	if [[ $myuid = root ]]; then
		cat >>$localbase/db/make.cfg <<-EOF
			SUDO=		sudo		# Default on for root
		EOF
	else
		cat >>$localbase/db/make.cfg <<-EOF
			SUDO=				# Default off for user
		EOF
	fi
	cat >>$localbase/db/make.cfg <<-EOF
		#CLEANDEPENDS=	No		# Default to yes
		#PREFER_SUBPKG_INSTALL=No	# Default to yes
	EOF
fi
@


