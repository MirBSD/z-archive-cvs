head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2008.12.10.18.40.13;	author tg;	state Exp;
branches;
next	1.3;
commitid	10049400D213BD80DD4;

1.3
date	2007.07.02.13.18.21;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004688FB253D839F10;

1.2
date	2006.10.09.20.38.07;	author tg;	state Exp;
branches;
next	1.1;
commitid	100452AB344437D66E6;

1.1
date	2006.10.02.04.01.47;	author tg;	state Exp;
branches;
next	;
commitid	10045208F2110596D57;


desc
@@


1.4
log
@eurynome: anoncvs@@ â†’ _anoncvs@@
@
text
@#!/usr/bin/env bash
# $MirOS: ports/infrastructure/scripts/darwindiskimage,v 1.3 2007/07/02 13:18:21 tg Exp $
# $NetBSD: darwindiskimage,v 1.2 2006/08/30 04:36:10 schmonz Exp $
#-
# Copyright (c) 2006
#	Thorsten Glaser <tg@@mirbsd.de>
# Derived from NetBSD(R) pkgsrc(R)
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# Use this to create a disk image, for use with a MirPorts Framework
# installation on a default case-insensitive Mac OSX installation.
#
# $ /usr/bin/cvs -d _anoncvs@@anoncvs.mirbsd.org:/cvs co ports/infrastructure
# $ cp ports/infrastructure/scripts/darwindiskimage ~
# $ bash ~/darwindiskimage create ~/Documents/MirPorts 512
#				# Mebibytes - season to taste
# $ bash ~/darwindiskimage mount ~/Documents/MirPorts
# $ sudo chown $(id -u):$(id -g) /Volumes/MirPorts
# $ cd /Volumes/MirPorts
# $ /usr/bin/cvs -d _anoncvs@@anoncvs.mirbsd.org:/cvs co ports
# $ bash ./Setup.sh -uel /Volumes/MirPorts/mpkg
# $ . /Volumes/MirPorts/mpkg/db/SetEnv.sh
# $ cd devel/cvs
# $ mmake install clean
# $ cd ../..
# $ /Volumes/MirPorts/mpkg/bin/cvs -Rq up -PAd
#
# To use:
# $ bash ~/darwindiskimage mount ~/Documents/MirPorts
# $ . /Volumes/MirPorts/mpkg/db/SetEnv.sh
# $ cd /Volumes/MirPorts/ports/foo/bar; mmake install clean
#
# Have fun...


_getdevice_and_halfway_mount() {
	hdid -nomount "$1" | _getdevicebasename | tail -1
}

_getdevicebasename() {
	awk '{print $1}' | sed -e 's|^/dev/||'
}

_normalise_filename() {
	echo "$1" | sed -e 's|\.dmg$||' -e 's|$|.dmg|'
}

dmg_create() {
	local fstype fs osmajor file mountedname megabytes device
	[ $# -eq 2 ] || die 1 "Usage: $0 create <file> <megabytes>"

	# Use case-sensitive HFS+ where available (Darwin >= 7)
	fstype='Apple_UFS'
	fs='UFS'
	osmajor=`uname -r | awk 'BEGIN {FS="."} {print $1}'`
	if [ ${osmajor} -ge 7 ]; then
		fstype='Apple_HFSX'
		fs='HFSX'
	fi

	file="`_normalise_filename \"$1\"`"
	mountedname="`basename \"${file}\" .dmg`"
	megabytes=$2

	# create
	hdiutil create -quiet "${file}" -megabytes ${megabytes} \
		-partitionType ${fstype} -layout SPUD -fs ${fs}

	# rename
	device=`_getdevice_and_halfway_mount "${file}"`
	hdiutil mount "${file}"
	disktool -n "${device}" "${mountedname}"
	hdiutil eject -quiet "${device}"
}

dmg_mount() {
	local file device exitcode
	[ $# -eq 1 ] || die 1 "Usage: $0 mount <file>"

	file="`_normalise_filename \"$1\"`"

	hdiutil mount ${file}
}


dmg_umount() {
	local mountpoint device
	[ $# -eq 1 ] || die 1 "Usage: $0 umount <mount-point>"

	mountpoint="$1"
	device=`mount | grep "${mountpoint} (local" | _getdevicebasename`

	[ "${device}" ] || die 1 "error: no device mounted at ${mountpoint}"

	hdiutil eject -quiet "${device}"
}

die() {
	local exitcode
	exitcode=$1; shift
	warn "$@@"
	exit ${exitcode}
}

warn() {
	echo >&2 "$@@"
}

try() {
	exitcode=$1; shift
	action=$1; shift
	error=`"${action}" "$@@" 2>&1` || die ${exitcode} "${error}"
}

main() {
	[ $# -eq 0 ] && die 1 "Usage: $0 <create|mount|umount>"
	ACTION="$1"; shift
	case ${ACTION} in
	create|mount|umount)
		try 1 "dmg_${ACTION}" "$@@"
		return 0
		;;
	*)
		die 1 "Usage: $0 <create|mount|umount>"
		;;
	esac
}

PATH=${PATH}:/sbin:/usr/sbin
main "$@@"
exit $?
@


1.3
log
@sync coding style, licence plate, cosmetics
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/scripts/darwindiskimage,v 1.2 2006/10/09 20:38:07 tg Exp $
d27 1
a27 1
# $ /usr/bin/cvs -d anoncvs@@anoncvs.mirbsd.org:/cvs co ports/infrastructure
d34 1
a34 1
# $ /usr/bin/cvs -d anoncvs@@anoncvs.mirbsd.org:/cvs co ports
@


1.2
log
@bsiegert@@ just reminded me that devel/cvs not a sensible name
for the port is, as it clashes with devel/CVS (meta directory
from the checkout). change instructions, still untested.
@
text
@d1 2
a2 2
#!/bin/bash
# $MirOS: ports/infrastructure/scripts/darwindiskimage,v 1.1 2006/10/02 04:01:47 tg Exp $
d9 5
a13 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d15 8
a22 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a defect.
d50 1
a50 2
_getdevice_and_halfway_mount()
{
d54 1
a54 2
_getdevicebasename()
{
d58 1
a58 2
_normalize_filename()
{
d62 1
a62 2
dmg_create()
{
d75 1
a75 1
	file="`_normalize_filename \"$1\"`"
d90 1
a90 2
dmg_mount()
{
d94 1
a94 1
	file="`_normalize_filename \"$1\"`"
d100 1
a100 2
dmg_umount()
{
d112 1
a112 2
die()
{
d119 1
a119 2
warn()
{
d123 1
a123 2
try()
{
d129 1
a129 2
main()
{
d133 7
a139 7
		create|mount|umount)
			try 1 "dmg_${ACTION}" "$@@"
			return 0
			;;
		*)
			die 1 "Usage: $0 <create|mount|umount>"
			;;
@


1.1
log
@experimental port to Mac OSX via disk image and case sensitive filesystem
untested; subject to change; depends on not-yet-committed cvs mirport
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.14 2006/08/09 19:35:23 tg Rel $
d28 1
a28 1
# $ /usr/bin/cvs -d anoncvs@@anoncvs.mirbsd.org:/cvs co osxports
d34 2
a35 2
# $ pax -rw ports /Volumes/MirPorts/; rm -rf ports
# $ cd /Volumes/MirPorts/ports
d40 2
a41 6
# $ cd /Volumes/MirPorts
# $ mv ports/Distfiles .
# $ rm -rf ports
# $ /Volumes/MirPorts/mpkg/bin/cvs -d anoncvs@@anoncvs.mirbsd.org:/cvs \
#	co -PA ports
# $ cd ports; ln -s ../Distfiles .
@

