head	1.295;
access;
symbols
	MIRBSD_8_BASE:1.87;
locks; strict;
comment	@# @;


1.295
date	2018.07.15.13.41.19;	author tg;	state Exp;
branches;
next	1.294;
commitid	1005B4B4F0B4ECDB6D4;

1.294
date	2017.07.20.22.17.23;	author tg;	state Exp;
branches;
next	1.293;
commitid	10059712BEC22EBE07B;

1.293
date	2017.07.20.21.15.51;	author tg;	state Exp;
branches;
next	1.292;
commitid	10059711D89780CE021;

1.292
date	2017.04.08.16.05.45;	author tg;	state Exp;
branches;
next	1.291;
commitid	10058E90A645BB20D20;

1.291
date	2015.10.13.17.11.19;	author tg;	state Exp;
branches;
next	1.290;
commitid	100561D3B484F737B14;

1.290
date	2015.07.19.00.00.00;	author tg;	state Exp;
branches;
next	1.289;
commitid	10055AAE88F12649364;

1.289
date	2014.12.06.16.14.17;	author tg;	state Exp;
branches;
next	1.288;
commitid	10054832B5717805035;

1.288
date	2014.05.30.00.21.36;	author tg;	state Exp;
branches;
next	1.287;
commitid	1005387CEA65239D0BB;

1.287
date	2014.05.29.23.08.18;	author tg;	state Exp;
branches;
next	1.286;
commitid	1005387BDE306B07E93;

1.286
date	2014.05.29.18.40.46;	author tg;	state Exp;
branches;
next	1.285;
commitid	10053877F337DFCFA47;

1.285
date	2014.05.29.18.36.29;	author tg;	state Exp;
branches;
next	1.284;
commitid	10053877E42222098EB;

1.284
date	2014.05.28.18.52.53;	author tg;	state Exp;
branches;
next	1.283;
commitid	1005386309D5EDA68CC;

1.283
date	2014.04.18.19.59.26;	author tg;	state Exp;
branches;
next	1.282;
commitid	1005351833D3629C347;

1.282
date	2014.04.02.16.54.32;	author tg;	state Exp;
branches;
next	1.281;
commitid	100533C40E078D6902C;

1.281
date	2014.01.07.13.07.31;	author tg;	state Exp;
branches;
next	1.280;
commitid	10052CBFC2C13C46573;

1.280
date	2013.12.01.03.49.59;	author tg;	state Exp;
branches;
next	1.279;
commitid	100529AB1E84C106108;

1.279
date	2013.11.06.18.53.15;	author tg;	state Exp;
branches;
next	1.278;
commitid	100527A901359B823D1;

1.278
date	2013.08.06.19.22.25;	author tg;	state Exp;
branches;
next	1.277;
commitid	10052014D091A639B01;

1.277
date	2012.10.18.16.41.25;	author tg;	state Exp;
branches;
next	1.276;
commitid	1005080313B0D9D852C;

1.276
date	2012.08.04.18.13.18;	author tg;	state Exp;
branches;
next	1.275;
commitid	100501D662F4B51A414;

1.275
date	2010.03.06.20.01.41;	author tg;	state Exp;
branches;
next	1.274;
commitid	1004B92B4BD7ABE84C6;

1.274
date	2010.02.18.19.03.57;	author tg;	state Exp;
branches;
next	1.273;
commitid	1004B7D8F0055A68A5A;

1.273
date	2010.01.09.19.40.06;	author tg;	state Exp;
branches;
next	1.272;
commitid	1004B48DBA971EB4151;

1.272
date	2010.01.09.18.34.00;	author tg;	state Exp;
branches;
next	1.271;
commitid	1004B48CC2F0F9FF379;

1.271
date	2009.12.28.14.55.12;	author tg;	state Exp;
branches;
next	1.270;
commitid	1004B38C6D25E238175;

1.270
date	2009.12.20.12.34.58;	author tg;	state Exp;
branches;
next	1.269;
commitid	1004B2E19EE11E297EC;

1.269
date	2009.12.12.23.48.51;	author tg;	state Exp;
branches;
next	1.268;
commitid	1004B242BE61FD6FF0B;

1.268
date	2009.12.06.19.26.59;	author tg;	state Exp;
branches;
next	1.267;
commitid	1004B1C05903AC0C712;

1.267
date	2009.12.06.19.26.01;	author tg;	state Exp;
branches;
next	1.266;
commitid	1004B1C055B24F136A7;

1.266
date	2009.11.22.20.34.40;	author tg;	state Exp;
branches;
next	1.265;
commitid	1004B09A07064C3C599;

1.265
date	2009.11.22.15.34.11;	author tg;	state Exp;
branches;
next	1.264;
commitid	1004B0959E8012B753D;

1.264
date	2009.11.21.20.27.33;	author tg;	state Exp;
branches;
next	1.263;
commitid	1004B084D48051D8DBF;

1.263
date	2009.11.21.16.44.31;	author tg;	state Exp;
branches;
next	1.262;
commitid	1004B0818FA083AE9FC;

1.262
date	2009.10.17.21.51.42;	author tg;	state Exp;
branches;
next	1.261;
commitid	1004ADA3C7648D93868;

1.261
date	2009.09.12.12.04.42;	author tg;	state Exp;
branches;
next	1.260;
commitid	1004AAB8E6C59BB5BD5;

1.260
date	2009.08.30.18.24.15;	author tg;	state Exp;
branches;
next	1.259;
commitid	1004A9AC3E45E0023F3;

1.259
date	2009.08.30.11.32.36;	author tg;	state Exp;
branches;
next	1.258;
commitid	1004A9A634A1510B223;

1.258
date	2009.08.29.12.44.04;	author tg;	state Exp;
branches;
next	1.257;
commitid	1004A9922A810069AB6;

1.257
date	2009.08.16.17.25.49;	author tg;	state Exp;
branches;
next	1.256;
commitid	1004A8841315849D3DC;

1.256
date	2009.08.16.17.20.53;	author tg;	state Exp;
branches;
next	1.255;
commitid	1004A883FBB18E3B918;

1.255
date	2009.08.16.16.27.08;	author tg;	state Exp;
branches;
next	1.254;
commitid	1004A882F1F72B43308;

1.254
date	2009.06.22.12.07.30;	author tg;	state Exp;
branches;
next	1.253;
commitid	1004A3F73D56AC0030C;

1.253
date	2009.06.18.20.55.36;	author tg;	state Exp;
branches;
next	1.252;
commitid	1004A3AA9D175EAA332;

1.252
date	2009.05.24.19.51.40;	author tg;	state Exp;
branches;
next	1.251;
commitid	1004A19A5493369A557;

1.251
date	2009.05.11.12.30.59;	author bsiegert;	state Exp;
branches;
next	1.250;
commitid	1004A081A4A55276DA0;

1.250
date	2009.03.31.19.33.49;	author bsiegert;	state Exp;
branches;
next	1.249;
commitid	10049D2700E28D73325;

1.249
date	2009.03.29.13.04.05;	author tg;	state Exp;
branches;
next	1.248;
commitid	10049CF71B654F9EF54;

1.248
date	2009.02.01.12.02.07;	author bsiegert;	state Exp;
branches;
next	1.247;
commitid	10049858F324ECACC9E;

1.247
date	2009.01.03.20.45.38;	author bsiegert;	state Exp;
branches;
next	1.246;
commitid	100495FCE70200E45AE;

1.246
date	2008.12.07.20.32.24;	author tg;	state Exp;
branches;
next	1.245;
commitid	100493C32751D66B834;

1.245
date	2008.12.07.18.17.18;	author tg;	state Exp;
branches;
next	1.244;
commitid	100493C13365412C388;

1.244
date	2008.11.29.14.35.27;	author tg;	state Exp;
branches;
next	1.243;
commitid	1004931530E6D3540C2;

1.243
date	2008.11.11.20.41.05;	author tg;	state Exp;
branches;
next	1.242;
commitid	1004919EDD87C8F9A0D;

1.242
date	2008.11.11.02.50.07;	author tg;	state Exp;
branches;
next	1.241;
commitid	1004918F2E56B329425;

1.241
date	2008.11.10.20.38.16;	author tg;	state Exp;
branches;
next	1.240;
commitid	10049189BBF7DCF62DE;

1.240
date	2008.11.10.20.34.55;	author tg;	state Exp;
branches;
next	1.239;
commitid	10049189B01236991FA;

1.239
date	2008.11.10.01.59.21;	author tg;	state Exp;
branches;
next	1.238;
commitid	10049179545230A64CF;

1.238
date	2008.11.10.01.43.57;	author tg;	state Exp;
branches;
next	1.237;
commitid	100491791EA7AD23D7B;

1.237
date	2008.11.10.01.41.00;	author tg;	state Exp;
branches;
next	1.236;
commitid	1004917912866FEDD14;

1.236
date	2008.11.02.19.21.31;	author tg;	state Exp;
branches;
next	1.235;
commitid	100490DFDD210E16EDF;

1.235
date	2008.11.02.17.29.28;	author tg;	state Exp;
branches;
next	1.234;
commitid	100490DE37D5207832A;

1.234
date	2008.11.02.17.26.05;	author tg;	state Exp;
branches;
next	1.233;
commitid	100490DE2BE451BDA41;

1.233
date	2008.11.02.14.49.36;	author tg;	state Exp;
branches;
next	1.232;
commitid	100490DBE0946151EDD;

1.232
date	2008.11.02.03.51.16;	author tg;	state Exp;
branches;
next	1.231;
commitid	100490D23B764094434;

1.231
date	2008.11.02.03.22.59;	author tg;	state Exp;
branches;
next	1.230;
commitid	100490D1CFE5F60B17A;

1.230
date	2008.11.01.23.43.57;	author tg;	state Exp;
branches;
next	1.229;
commitid	100490CE9AC0940A270;

1.229
date	2008.11.01.22.57.22;	author tg;	state Exp;
branches;
next	1.228;
commitid	100490CDECE38054B7B;

1.228
date	2008.10.16.19.06.40;	author tg;	state Exp;
branches;
next	1.227;
commitid	10048F790D2694F2C8D;

1.227
date	2008.10.14.19.41.06;	author tg;	state Exp;
branches;
next	1.226;
commitid	10048F4F5E726BC60F7;

1.226
date	2008.10.13.21.22.54;	author tg;	state Exp;
branches;
next	1.225;
commitid	10048F3BC211DF83D9D;

1.225
date	2008.10.12.15.25.16;	author tg;	state Exp;
branches;
next	1.224;
commitid	10048F216EB6BB8022E;

1.224
date	2008.10.12.14.01.16;	author tg;	state Exp;
branches;
next	1.223;
commitid	10048F2030735A99D8E;

1.223
date	2008.10.12.13.57.01;	author tg;	state Exp;
branches;
next	1.222;
commitid	10048F2023B136886C9;

1.222
date	2008.10.12.13.56.07;	author tg;	state Exp;
branches;
next	1.221;
commitid	10048F20203337123D1;

1.221
date	2008.10.12.13.53.12;	author tg;	state Exp;
branches;
next	1.220;
commitid	10048F200BD779FEF04;

1.220
date	2008.10.12.13.35.04;	author tg;	state Exp;
branches;
next	1.219;
commitid	10048F1FD1656B4EF71;

1.219
date	2008.10.10.20.06.14;	author tg;	state Exp;
branches;
next	1.218;
commitid	10048EFB5CC1B4E831D;

1.218
date	2008.10.05.17.53.33;	author tg;	state Exp;
branches;
next	1.217;
commitid	10048E8FF2C4286FE20;

1.217
date	2008.10.05.17.11.55;	author tg;	state Exp;
branches;
next	1.216;
commitid	10048E8F5727D45A8AE;

1.216
date	2008.10.05.14.50.37;	author tg;	state Exp;
branches;
next	1.215;
commitid	10048E8D43B12603EA8;

1.215
date	2008.10.04.18.37.31;	author tg;	state Exp;
branches;
next	1.214;
commitid	10048E7B76F1F1670BC;

1.214
date	2008.09.23.19.56.31;	author bsiegert;	state Exp;
branches;
next	1.213;
commitid	10048D949A87E36023B;

1.213
date	2008.09.21.14.18.21;	author bsiegert;	state Exp;
branches;
next	1.212;
commitid	10048D65791150FEB00;

1.212
date	2008.09.17.20.05.36;	author tg;	state Exp;
branches;
next	1.211;
commitid	10048D162E278764D86;

1.211
date	2008.09.11.21.34.41;	author tg;	state Exp;
branches;
next	1.210;
commitid	10048C98EFC2B42D35A;

1.210
date	2008.09.11.20.50.56;	author bsiegert;	state Exp;
branches;
next	1.209;
commitid	10048C9844373B3C690;

1.209
date	2008.09.09.19.21.41;	author tg;	state Exp;
branches;
next	1.208;
commitid	10048C6CCCC652B48E4;

1.208
date	2008.08.27.07.31.41;	author tg;	state Exp;
branches;
next	1.207;
commitid	10048B502D13EC153D5;

1.207
date	2008.08.26.18.38.13;	author tg;	state Exp;
branches;
next	1.206;
commitid	10048B44D9C296A3801;

1.206
date	2008.08.26.17.29.00;	author tg;	state Exp;
branches;
next	1.205;
commitid	10048B43CEC79450C86;

1.205
date	2008.06.15.14.52.00;	author tg;	state Exp;
branches;
next	1.204;
commitid	10048552C9D69822230;

1.204
date	2008.06.12.19.50.55;	author tg;	state Exp;
branches;
next	1.203;
commitid	10048517DFF48236388;

1.203
date	2008.05.03.22.19.36;	author tg;	state Exp;
branches;
next	1.202;
commitid	100481CE507120DC340;

1.202
date	2008.05.03.21.58.23;	author tg;	state Exp;
branches;
next	1.201;
commitid	100481CE00C29B337CB;

1.201
date	2008.05.02.13.40.44;	author tg;	state Exp;
branches;
next	1.200;
commitid	100481B19DF032AE8BA;

1.200
date	2008.04.05.23.13.10;	author tg;	state Exp;
branches;
next	1.199;
commitid	10047F807942B266347;

1.199
date	2008.04.05.21.50.13;	author tg;	state Exp;
branches;
next	1.198;
commitid	10047F7F4284B53BED4;

1.198
date	2008.03.14.20.19.42;	author tg;	state Exp;
branches;
next	1.197;
commitid	10047DADDAB252C4C44;

1.197
date	2008.03.14.19.13.03;	author tg;	state Exp;
branches;
next	1.196;
commitid	10047DACE3740B22A2F;

1.196
date	2008.03.14.15.33.53;	author tg;	state Exp;
branches;
next	1.195;
commitid	10047DA9AE621D7BEB1;

1.195
date	2008.03.14.15.25.22;	author tg;	state Exp;
branches;
next	1.194;
commitid	10047DA98D049E42B58;

1.194
date	2008.03.12.23.43.12;	author tg;	state Exp;
branches;
next	1.193;
commitid	10047D86A9C2D04FA59;

1.193
date	2008.03.09.17.22.55;	author tg;	state Exp;
branches;
next	1.192;
commitid	10047D41CAA7E715397;

1.192
date	2008.02.24.11.36.29;	author tg;	state Exp;
branches;
next	1.191;
commitid	10047C156936AEE5708;

1.191
date	2008.02.22.21.43.43;	author tg;	state Exp;
branches;
next	1.190;
commitid	10047BF4211618DC2CB;

1.190
date	2008.02.10.18.39.22;	author bsiegert;	state Exp;
branches;
next	1.189;
commitid	10047AF44F100027615;

1.189
date	2007.10.26.21.45.53;	author tg;	state Exp;
branches;
next	1.188;
commitid	1004722601E7D63EEB0;

1.188
date	2007.10.26.12.14.20;	author bsiegert;	state Exp;
branches;
next	1.187;
commitid	1004721D9DC16FA1D61;

1.187
date	2007.08.16.18.14.01;	author tg;	state Exp;
branches;
next	1.186;
commitid	10046C493F612EC4227;

1.186
date	2007.08.16.12.28.37;	author tg;	state Exp;
branches;
next	1.185;
commitid	10046C4423B68CEF0CA;

1.185
date	2007.08.11.15.44.09;	author tg;	state Exp;
branches;
next	1.184;
commitid	10046BDD960086736B4;

1.184
date	2007.08.07.19.30.45;	author tg;	state Exp;
branches;
next	1.183;
commitid	10046B8C8743B857FE6;

1.183
date	2007.07.09.18.39.05;	author tg;	state Exp;
branches;
next	1.182;
commitid	100469280DF00CD3B97;

1.182
date	2007.06.07.18.00.45;	author tg;	state Exp;
branches;
next	1.181;
commitid	100466847E07C80CB1D;

1.181
date	2007.05.28.16.14.18;	author tg;	state Exp;
branches;
next	1.180;
commitid	100465AFFE504D2CE79;

1.180
date	2007.05.27.14.12.00;	author tg;	state Exp;
branches;
next	1.179;
commitid	100465991B94BE06642;

1.179
date	2007.05.26.02.41.27;	author tg;	state Exp;
branches;
next	1.178;
commitid	10046579E6E4A0AF456;

1.178
date	2007.05.26.02.38.11;	author tg;	state Exp;
branches;
next	1.177;
commitid	10046579DA5379BBD49;

1.177
date	2007.05.14.01.40.55;	author tg;	state Exp;
branches;
next	1.176;
commitid	1004647BE3403A19A6C;

1.176
date	2007.05.12.23.12.28;	author tg;	state Exp;
branches;
next	1.175;
commitid	100464649E61EB30FCE;

1.175
date	2007.05.07.22.51.06;	author tg;	state Exp;
branches;
next	1.174;
commitid	100463FAD6937603E76;

1.174
date	2007.05.07.22.37.10;	author tg;	state Exp;
branches;
next	1.173;
commitid	100463FAA2572C8E8E0;

1.173
date	2007.05.07.22.34.56;	author tg;	state Exp;
branches;
next	1.172;
commitid	100463FA9A232137CBF;

1.172
date	2007.05.07.22.34.11;	author tg;	state Exp;
branches;
next	1.171;
commitid	100463FA9702043B6EB;

1.171
date	2007.05.06.18.35.46;	author tg;	state Exp;
branches;
next	1.170;
commitid	100463E1FF263C2CF4E;

1.170
date	2007.04.07.14.37.14;	author bsiegert;	state Exp;
branches;
next	1.169;
commitid	1004617AC8D41C928F5;

1.169
date	2007.04.04.21.38.45;	author tg;	state Exp;
branches;
next	1.168;
commitid	10046141AFB17A41C54;

1.168
date	2007.04.04.17.59.55;	author bsiegert;	state Exp;
branches;
next	1.167;
commitid	1004613E7A33E48D464;

1.167
date	2007.04.01.20.19.53;	author tg;	state Exp;
branches;
next	1.166;
commitid	100461013BB698AF935;

1.166
date	2007.03.30.23.22.09;	author bsiegert;	state Exp;
branches;
next	1.165;
commitid	100460D9B921A2CF5C6;

1.165
date	2007.03.30.23.20.09;	author bsiegert;	state Exp;
branches;
next	1.164;
commitid	100460D99284E3410CC;

1.164
date	2007.03.20.17.33.46;	author tg;	state Exp;
branches;
next	1.163;
commitid	10046001B0B284CA76F;

1.163
date	2007.03.04.21.16.10;	author tg;	state Exp;
branches;
next	1.162;
commitid	10045EB37034A026D4E;

1.162
date	2007.03.02.01.38.30;	author tg;	state Exp;
branches;
next	1.161;
commitid	10045E7802762886F0F;

1.161
date	2007.03.02.01.10.34;	author tg;	state Exp;
branches;
next	1.160;
commitid	10045E779A071EBE5DC;

1.160
date	2007.03.02.00.31.52;	author tg;	state Exp;
branches;
next	1.159;
commitid	10045E7706D0C27A0A8;

1.159
date	2007.01.29.17.15.13;	author tg;	state Exp;
branches;
next	1.158;
commitid	10045BE2BB322584AAD;

1.158
date	2007.01.29.17.13.08;	author tg;	state Exp;
branches;
next	1.157;
commitid	10045BE2B2211A91448;

1.157
date	2006.12.30.21.13.45;	author tg;	state Exp;
branches;
next	1.156;
commitid	1004596D69269353C87;

1.156
date	2006.12.23.04.07.56;	author tg;	state Exp;
branches;
next	1.155;
commitid	100458CABB054645508;

1.155
date	2006.12.23.04.02.22;	author tg;	state Exp;
branches;
next	1.154;
commitid	100458CAA41493E42E5;

1.154
date	2006.12.23.01.15.12;	author tg;	state Exp;
branches;
next	1.153;
commitid	100458C83107CB42D96;

1.153
date	2006.12.22.21.08.37;	author tg;	state Exp;
branches;
next	1.152;
commitid	100458C492D4856924A;

1.152
date	2006.12.21.19.33.53;	author tg;	state Exp;
branches;
next	1.151;
commitid	100458AE1A5071D7B1D;

1.151
date	2006.12.20.15.29.26;	author tg;	state Exp;
branches;
next	1.150;
commitid	100458956E02A39AB3C;

1.150
date	2006.12.11.22.59.21;	author tg;	state Exp;
branches;
next	1.149;
commitid	100457DE2881CF8197C;

1.149
date	2006.11.24.01.15.07;	author tg;	state Exp;
branches;
next	1.148;
commitid	100456647AD46D03A2E;

1.148
date	2006.11.22.18.03.20;	author tg;	state Exp;
branches;
next	1.147;
commitid	100456490FC01A3FA1C;

1.147
date	2006.11.22.17.58.40;	author tg;	state Exp;
branches;
next	1.146;
commitid	10045648FDB3F03764C;

1.146
date	2006.11.19.13.17.27;	author tg;	state Exp;
branches;
next	1.145;
commitid	1004560597245D5D90C;

1.145
date	2006.11.17.18.31.41;	author tg;	state Exp;
branches;
next	1.144;
commitid	100455DFFFD1EEF61A4;

1.144
date	2006.11.14.02.31.17;	author tg;	state Exp;
branches;
next	1.143;
commitid	10045592A847E6BE537;

1.143
date	2006.11.08.16.51.22;	author bsiegert;	state Exp;
branches;
next	1.142;
commitid	10045520AFB7A06A9EF;

1.142
date	2006.11.04.00.29.15;	author tg;	state Exp;
branches;
next	1.141;
commitid	100454BDEF163D54E23;

1.141
date	2006.11.04.00.27.19;	author tg;	state Exp;
branches;
next	1.140;
commitid	100454BDE7D5A0E4629;

1.140
date	2006.11.04.00.03.54;	author tg;	state Exp;
branches;
next	1.139;
commitid	100454BD8D334B15F85;

1.139
date	2006.11.03.23.47.32;	author tg;	state Exp;
branches;
next	1.138;
commitid	100454BD5043A801C7E;

1.138
date	2006.11.03.23.41.25;	author tg;	state Exp;
branches;
next	1.137;
commitid	100454BD39A3257A93F;

1.137
date	2006.10.27.15.53.05;	author tg;	state Exp;
branches;
next	1.136;
commitid	10045422B51340FA673;

1.136
date	2006.10.17.21.28.11;	author tg;	state Exp;
branches;
next	1.135;
commitid	10045354AFC612879EF;

1.135
date	2006.10.17.21.15.41;	author tg;	state Exp;
branches;
next	1.134;
commitid	100453547F255F4DEE4;

1.134
date	2006.10.13.17.09.19;	author tg;	state Exp;
branches;
next	1.133;
commitid	100452FC7FA2E1D2241;

1.133
date	2006.10.06.20.01.06;	author tg;	state Exp;
branches;
next	1.132;
commitid	1004526B6102F41851C;

1.132
date	2006.10.06.19.34.37;	author tg;	state Exp;
branches;
next	1.131;
commitid	1004526AEB478436327;

1.131
date	2006.09.22.00.09.18;	author tg;	state Exp;
branches;
next	1.130;
commitid	100451329B522B433AB;

1.130
date	2006.09.17.20.17.33;	author tg;	state Exp;
branches;
next	1.129;
commitid	100450DAD37048D0C72;

1.129
date	2006.09.13.23.34.01;	author tg;	state Exp;
branches;
next	1.128;
commitid	1004508957A47E860A6;

1.128
date	2006.09.13.22.07.11;	author tg;	state Exp;
branches;
next	1.127;
commitid	100450881212EF3914B;

1.127
date	2006.09.09.14.14.22;	author tg;	state Exp;
branches;
next	1.126;
commitid	1004502CC51153BF11F;

1.126
date	2006.08.26.23.34.16;	author tg;	state Exp;
branches;
next	1.125;
commitid	10044F0D836486F5483;

1.125
date	2006.08.26.19.35.57;	author tg;	state Exp;
branches;
next	1.124;
commitid	10044F0A2A522CCE072;

1.124
date	2006.08.26.16.51.33;	author tg;	state Exp;
branches;
next	1.123;
commitid	10044F07C1C20DBFE87;

1.123
date	2006.08.16.19.51.14;	author tg;	state Exp;
branches;
next	1.122;
commitid	10044E377364156F55A;

1.122
date	2006.08.10.16.45.47;	author tg;	state Exp;
branches;
next	1.121;
commitid	10044DB62C55FC3E97F;

1.121
date	2006.07.23.17.42.34;	author tg;	state Exp;
branches;
next	1.120;
commitid	10044C3B4364E1E1D4A;

1.120
date	2006.07.15.16.40.44;	author tg;	state Exp;
branches;
next	1.119;
commitid	10044B91A5D41B3FFF2;

1.119
date	2006.07.11.14.26.38;	author tg;	state Exp;
branches;
next	1.118;
commitid	10044B3B52F0C15EE45;

1.118
date	2006.07.11.14.26.00;	author tg;	state Exp;
branches;
next	1.117;
commitid	10044B3B5026649F12A;

1.117
date	2006.06.25.02.51.24;	author tg;	state Exp;
branches;
next	1.116;
commitid	100449DFA3E15E43C65;

1.116
date	2006.06.25.02.24.08;	author tg;	state Exp;
branches;
next	1.115;
commitid	100449DF3D04B53B89A;

1.115
date	2006.06.25.01.48.36;	author tg;	state Exp;
branches;
next	1.114;
commitid	100449DEB7B4888894A;

1.114
date	2006.06.25.00.04.10;	author tg;	state Exp;
branches;
next	1.113;
commitid	100449DD3052928C3B7;

1.113
date	2006.06.24.23.55.47;	author tg;	state Exp;
branches;
next	1.112;
commitid	100449DD10D75D91A41;

1.112
date	2006.06.24.23.49.36;	author tg;	state Exp;
branches;
next	1.111;
commitid	100449DCF9D5872566C;

1.111
date	2006.06.23.15.56.27;	author bsiegert;	state Exp;
branches;
next	1.110;
commitid	100449C0EEB2DACA1B2;

1.110
date	2006.05.28.20.45.17;	author tg;	state Exp;
branches;
next	1.109;
commitid	100447A0BF364D53FB8;

1.109
date	2006.04.25.20.01.00;	author tg;	state Exp;
branches;
next	1.108;
commitid	100444E800D3870C226;

1.108
date	2006.03.27.20.59.32;	author tg;	state Exp;
branches;
next	1.107;
commitid	1004428523A73BA88B1;

1.107
date	2006.03.23.21.36.22;	author tg;	state Exp;
branches;
next	1.106;
commitid	100442314E1002AF403;

1.106
date	2006.03.02.01.17.37;	author tg;	state Exp;
branches;
next	1.105;
commitid	100440647AA4FD1D12E;

1.105
date	2006.02.21.12.59.25;	author tg;	state Exp;
branches;
next	1.104;
commitid	10043FB0EA720FFB033;

1.104
date	2006.02.21.03.36.05;	author tg;	state Exp;
branches;
next	1.103;
commitid	10043FA8AB54F16595C;

1.103
date	2006.02.09.17.40.23;	author tg;	state Exp;
branches;
next	1.102;
commitid	10043EB7D42718A11ED;

1.102
date	2006.02.09.13.03.04;	author tg;	state Exp;
branches;
next	1.101;
commitid	10043EB3D961542BE61;

1.101
date	2006.02.09.12.25.13;	author tg;	state Exp;
branches;
next	1.100;
commitid	10043EB348C1DDC8752;

1.100
date	2006.02.09.12.15.49;	author tg;	state Exp;
branches;
next	1.99;
commitid	10043EB322960414B16;

1.99
date	2006.02.09.09.35.58;	author tg;	state Exp;
branches;
next	1.98;
commitid	10043EB0C94610EDE76;

1.98
date	2006.02.05.17.02.21;	author tg;	state Exp;
branches;
next	1.97;
commitid	10043E62FAB135FC260;

1.97
date	2006.02.01.18.54.04;	author tg;	state Exp;
branches;
next	1.96;
commitid	10043E103DE050FB5B0;

1.96
date	2006.01.25.12.21.34;	author tg;	state Exp;
branches;
next	1.95;
commitid	10043D76D5E7EBC514E;

1.95
date	2006.01.13.03.49.25;	author tg;	state Exp;
branches;
next	1.94;
commitid	10043C722F46A94D38C;

1.94
date	2006.01.10.20.58.20;	author tg;	state Exp;
branches;
next	1.93;
commitid	10043C41FCB14E41393;

1.93
date	2006.01.01.03.29.57;	author tg;	state Exp;
branches;
next	1.92;
commitid	10043B74CCC3DA11ADB;

1.92
date	2006.01.01.03.22.42;	author tg;	state Exp;
branches;
next	1.91;
commitid	10043B74B16347D8D26;

1.91
date	2006.01.01.02.52.14;	author tg;	state Exp;
branches;
next	1.90;
commitid	10043B743E50252B5DC;

1.90
date	2006.01.01.02.51.17;	author tg;	state Exp;
branches;
next	1.89;
commitid	10043B743B42A80B42C;

1.89
date	2006.01.01.02.47.19;	author tg;	state Exp;
branches;
next	1.88;
commitid	10043B742AD213905DB;

1.88
date	2005.12.29.22.01.13;	author tg;	state Exp;
branches;
next	1.87;
commitid	10043B45CB555E85287;

1.87
date	2005.12.20.19.57.53;	author tg;	state Exp;
branches;
next	1.86;
commitid	10043A8624B52844F91;

1.86
date	2005.12.18.16.36.40;	author tg;	state Exp;
branches;
next	1.85;
commitid	10043A58BE830AFB807;

1.85
date	2005.12.18.05.40.16;	author tg;	state Exp;
branches;
next	1.84;
commitid	10043A4F61A25509D86;

1.84
date	2005.12.17.04.29.13;	author tg;	state Exp;
branches;
next	1.83;
commitid	10043A3942975423403;

1.83
date	2005.12.17.04.05.26;	author tg;	state Exp;
branches;
next	1.82;
commitid	10043A38E31472AE1C2;

1.82
date	2005.12.17.03.06.07;	author tg;	state Exp;
branches;
next	1.81;
commitid	10043A380B0728983C8;

1.81
date	2005.12.17.02.57.14;	author tg;	state Exp;
branches;
next	1.80;
commitid	10043A37E427899D34D;

1.80
date	2005.12.17.02.36.25;	author tg;	state Exp;
branches;
next	1.79;
commitid	10043A378A344C47E91;

1.79
date	2005.12.17.00.55.14;	author tg;	state Exp;
branches;
next	1.78;
commitid	10043A361E306B46168;

1.78
date	2005.12.16.22.41.11;	author tg;	state Exp;
branches;
next	1.77;
commitid	10043A342982BFD230D;

1.77
date	2005.12.16.22.04.16;	author tg;	state Exp;
branches;
next	1.76;
commitid	10043A339F018DB22F3;

1.76
date	2005.12.16.16.41.02;	author tg;	state Exp;
branches;
next	1.75;
commitid	10043A2EE162412A5B6;

1.75
date	2005.12.16.14.58.14;	author tg;	state Exp;
branches;
next	1.74;
commitid	10043A2D612009EB14D;

1.74
date	2005.12.16.11.46.39;	author tg;	state Exp;
branches;
next	1.73;
commitid	10043A2A92E65B7CCDD;

1.73
date	2005.12.16.11.16.12;	author tg;	state Exp;
branches;
next	1.72;
commitid	10043A2A20763234B83;

1.72
date	2005.12.16.11.14.50;	author tg;	state Exp;
branches;
next	1.71;
commitid	10043A2A1A835317767;

1.71
date	2005.12.15.01.24.42;	author tg;	state Exp;
branches;
next	1.70;
commitid	10043A0C5D7068BC1DF;

1.70
date	2005.11.19.12.54.25;	author tg;	state Exp;
branches;
next	1.69;
commitid	4064437f20740661;

1.69
date	2005.11.18.14.14.30;	author tg;	state Exp;
branches;
next	1.68;
commitid	7bbe437de19f4e55;

1.68
date	2005.11.17.23.04.49;	author tg;	state Exp;
branches;
next	1.67;
commitid	275f437d0c972720;

1.67
date	2005.11.17.23.00.35;	author tg;	state Exp;
branches;
next	1.66;
commitid	23c437d0b97cf02;

1.66
date	2005.11.17.22.49.46;	author tg;	state Exp;
branches;
next	1.65;
commitid	614f437d09157948;

1.65
date	2005.11.17.22.47.50;	author tg;	state Exp;
branches;
next	1.64;
commitid	7816437d087ecf9e;

1.64
date	2005.11.17.22.12.18;	author tg;	state Exp;
branches;
next	1.63;
commitid	dc1437d004e3cfa;

1.63
date	2005.11.17.22.08.57;	author tg;	state Exp;
branches;
next	1.62;
commitid	7e15437cff561d3c;

1.62
date	2005.11.17.20.18.31;	author tg;	state Exp;
branches;
next	1.61;
commitid	6229437ce59d9e1b;

1.61
date	2005.11.17.20.15.03;	author tg;	state Exp;
branches;
next	1.60;
commitid	4894437ce4d4f999;

1.60
date	2005.11.17.19.59.25;	author tg;	state Exp;
branches;
next	1.59;
commitid	3ec4437ce11a69ae;

1.59
date	2005.11.10.23.36.08;	author tg;	state Exp;
branches;
next	1.58;
commitid	13494373d9587faf;

1.58
date	2005.11.10.20.39.09;	author tg;	state Exp;
branches;
next	1.57;
commitid	78a14373affd8fbc;

1.57
date	2005.11.10.20.12.08;	author tg;	state Exp;
branches;
next	1.56;
commitid	10124373a9a00757;

1.56
date	2005.11.07.20.34.03;	author tg;	state Exp;
branches;
next	1.55;
commitid	1e20436fba3a089d;

1.55
date	2005.10.23.21.49.52;	author tg;	state Exp;
branches;
next	1.54;
commitid	170a435c0575077d;

1.54
date	2005.10.21.20.29.18;	author tg;	state Exp;
branches;
next	1.53;
commitid	7e3343594fad3415;

1.53
date	2005.10.12.19.16.23;	author tg;	state Exp;
branches;
next	1.52;
commitid	4c96434d60597f94;

1.52
date	2005.10.09.19.33.39;	author tg;	state Exp;
branches;
next	1.51;
commitid	6fb643497089eb4b;

1.51
date	2005.10.02.18.10.09;	author tg;	state Exp;
branches;
next	1.50;
commitid	76094340228b1352;

1.50
date	2005.09.30.09.43.33;	author tg;	state Exp;
branches;
next	1.49;
commitid	3793433d089ae790;

1.49
date	2005.09.29.12.42.28;	author tg;	state Exp;
branches;
next	1.48;
commitid	c51433be114f1ce;

1.48
date	2005.09.24.12.13.18;	author tg;	state Exp;
branches;
next	1.47;
commitid	25d0433541f503b0;

1.47
date	2005.09.24.11.57.14;	author tg;	state Exp;
branches;
next	1.46;
commitid	3d1643353f286b24;

1.46
date	2005.09.22.20.27.46;	author bsiegert;	state Exp;
branches;
next	1.45;
commitid	53c0433313ce82b8;

1.45
date	2005.09.14.21.17.35;	author tg;	state Exp;
branches;
next	1.44;
commitid	6c2a4328937a0d85;

1.44
date	2005.09.12.22.53.18;	author tg;	state Exp;
branches;
next	1.43;
commitid	6e6c432606e897b6;

1.43
date	2005.09.11.02.33.57;	author tg;	state Exp;
branches;
next	1.42;
commitid	773e432397611c14;

1.42
date	2005.09.01.20.09.37;	author tg;	state Exp;
branches;
next	1.41;
commitid	215643175f6501f5;

1.41
date	2005.08.29.19.41.16;	author tg;	state Exp;
branches;
next	1.40;
commitid	3d4b431364e5a4d2;

1.40
date	2005.08.20.12.33.53;	author tg;	state Exp;
branches
	1.40.2.1;
next	1.39;
commitid	1bdf4307228d6819;

1.39
date	2005.07.24.12.34.26;	author tg;	state Exp;
branches;
next	1.38;
commitid	4e3f42e38a78866c;

1.38
date	2005.07.18.20.00.49;	author bsiegert;	state Exp;
branches;
next	1.37;
commitid	277242dc0a78f1dc;

1.37
date	2005.07.18.17.41.13;	author bsiegert;	state Exp;
branches;
next	1.36;
commitid	593042dbe9ae9580;

1.36
date	2005.07.18.17.14.31;	author bsiegert;	state Exp;
branches;
next	1.35;
commitid	213f42dbe26df79e;

1.35
date	2005.07.05.22.33.59;	author bsiegert;	state Exp;
branches;
next	1.34;
commitid	30c642cb0adab198;

1.34
date	2005.07.05.22.26.56;	author bsiegert;	state Exp;
branches;
next	1.33;
commitid	4ebd42cb09184b58;

1.33
date	2005.07.05.20.08.29;	author tg;	state Exp;
branches;
next	1.32;
commitid	6fe042cae8bb6f4d;

1.32
date	2005.07.05.19.31.46;	author tg;	state Exp;
branches;
next	1.31;
commitid	6cd542cadfe82e4e;

1.31
date	2005.07.05.18.50.20;	author tg;	state Exp;
branches;
next	1.30;
commitid	45ea42cad66ff1b2;

1.30
date	2005.07.04.18.41.40;	author tg;	state Exp;
branches;
next	1.29;
commitid	1b9242c982f1eb9f;

1.29
date	2005.06.23.17.01.19;	author tg;	state Exp;
branches;
next	1.28;
commitid	7cef42baeaf09a44;

1.28
date	2005.06.23.16.53.48;	author bsiegert;	state Exp;
branches;
next	1.27;
commitid	301442bae92842ca;

1.27
date	2005.06.17.20.15.21;	author tg;	state Exp;
branches;
next	1.26;
commitid	30de42b32f50d15d;

1.26
date	2005.06.11.21.12.03;	author tg;	state Exp;
branches;
next	1.25;
commitid	502a42ab5397b768;

1.25
date	2005.06.02.22.17.48;	author tg;	state Exp;
branches;
next	1.24;
commitid	3ebb429f85a0590d;

1.24
date	2005.05.31.20.45.32;	author bsiegert;	state Exp;
branches;
next	1.23;
commitid	274b429cccef4992;

1.23
date	2005.05.21.18.08.38;	author tg;	state Exp;
branches;
next	1.22;
commitid	6e11428f7933a675;

1.22
date	2005.05.21.14.29.28;	author tg;	state Exp;
branches;
next	1.21;
commitid	13a2428f45d60f6e;

1.21
date	2005.05.21.01.52.46;	author tg;	state Exp;
branches;
next	1.20;
commitid	40ac428e942d99b5;

1.20
date	2005.05.21.01.40.03;	author tg;	state Exp;
branches;
next	1.19;
commitid	3264428e9180da66;

1.19
date	2005.05.21.00.59.31;	author tg;	state Exp;
branches;
next	1.18;
commitid	5458428e87f50ac7;

1.18
date	2005.05.20.22.04.43;	author tg;	state Exp;
branches;
next	1.17;
commitid	5c1c428e5ef444de;

1.17
date	2005.04.29.18.32.22;	author tg;	state Exp;
branches;
next	1.16;

1.16
date	2005.04.28.20.46.58;	author tg;	state Exp;
branches;
next	1.15;

1.15
date	2005.04.11.15.55.41;	author tg;	state Exp;
branches;
next	1.14;

1.14
date	2005.04.11.14.52.47;	author tg;	state Exp;
branches;
next	1.13;

1.13
date	2005.04.11.14.47.33;	author tg;	state Exp;
branches;
next	1.12;

1.12
date	2005.04.11.14.43.43;	author tg;	state Exp;
branches;
next	1.11;

1.11
date	2005.04.10.20.52.25;	author tg;	state Exp;
branches;
next	1.10;

1.10
date	2005.04.10.20.45.02;	author tg;	state Exp;
branches;
next	1.9;

1.9
date	2005.04.10.19.41.29;	author tg;	state Exp;
branches;
next	1.8;

1.8
date	2005.04.10.19.36.33;	author tg;	state Exp;
branches;
next	1.7;

1.7
date	2005.04.10.19.15.41;	author tg;	state Exp;
branches;
next	1.6;

1.6
date	2005.03.29.12.41.55;	author tg;	state Exp;
branches;
next	1.5;

1.5
date	2005.03.27.18.41.34;	author tg;	state Exp;
branches;
next	1.4;

1.4
date	2005.03.25.23.42.25;	author bsiegert;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.20.17.00.44;	author bsiegert;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.19.23.15.06;	author bsiegert;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.18.15.47.19;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.40.2.1
date	2005.08.21.11.08.26;	author tg;	state Exp;
branches;
next	1.40.2.2;
commitid	31c743085fec9b02;

1.40.2.2
date	2005.08.21.12.47.08;	author tg;	state Exp;
branches;
next	1.40.2.3;
commitid	4072430877da806f;

1.40.2.3
date	2005.09.11.01.05.41;	author tg;	state Exp;
branches;
next	1.40.2.4;
commitid	2f08432382e315cf;

1.40.2.4
date	2005.09.11.01.20.25;	author tg;	state Exp;
branches;
next	1.40.2.5;
commitid	3213432386629ffb;

1.40.2.5
date	2005.09.11.01.24.56;	author tg;	state Exp;
branches;
next	1.40.2.6;
commitid	1f4f43238773830e;

1.40.2.6
date	2005.09.11.02.12.20;	author tg;	state Exp;
branches;
next	1.40.2.7;
commitid	6a743239294d866;

1.40.2.7
date	2005.09.11.02.35.31;	author tg;	state Exp;
branches;
next	1.40.2.8;
commitid	c19432397fa512e;

1.40.2.8
date	2005.09.12.22.13.47;	author tg;	state Exp;
branches;
next	;
commitid	8c94325fdad7150;

1.1.7.1
date	2005.03.18.15.47.19;	author tg;	state Exp;
branches;
next	;


desc
@@


1.295
log
@further limit the amount of mailto links weâ€™re giving out
@
text
@# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.294 2017/07/20 22:17:23 tg Exp $
# $OpenBSD: bsd.port.mk,v 1.677 2005/01/06 19:30:34 espie Exp $
# $FreeBSD: bsd.port.mk,v 1.264 1996/12/25 02:27:44 imp Exp $
# $NetBSD: bsd.port.mk,v 1.62 1998/04/09 12:47:02 hubertf Exp $
#-
# This is the MirPorts Framework master system Makefile. It provides
# an infrastructure to be used within the framework by every port.
#
# Each port has a maintainer, which is the email address(es) of the person(s)
# to contact if you have questions/suggestions about that specific port.
# To obtain that address, just type
#	mmake show=RESPONSIBLE
# in the specific port's directory.

# Any variable or target starting with an underscore (e.g., _DEPEND_ECHO)
# is internal to bsd.port.mk, not part of the user's API, and liable to
# change without notice.

.if ${.MAKEFLAGS:MFLAVOUR=*}
ERRORS+=		"Use 'env FLAVOUR=${FLAVOUR:Q} ${MAKE}' instead."
.endif
.if ${.MAKEFLAGS:MSUBPACKAGE=*}
ERRORS+=		"Use 'env SUBPACKAGE=${SUBPACKAGE:Q} ${MAKE}' instead."
.endif

# Default sequence for "all" is:  fetch checksum extract patch configure build
#
# Please read the comments in the targets section below, you
# should be able to use the pre-* or post-* targets (which
# are available for every stage except checksum) or provide
# an overriding do-* target to do pretty much anything you
# want.
#
# For historical reasons, the distpatch target is a subtarget of patch.
# If you provide a do-patch, you MUST call distpatch explicitly.
# The sequence of hooks actually run is:
#
# pre-patch 'real distpatch' post-distpatch 'real patch' post-patch

# User settings
TRUST_PACKAGES?=	No
BIN_PACKAGES?=		No
CLEANDEPENDS?=		Yes
BULK?=			No
RECURSIVE_FETCH_LIST?=	Yes
WRKOBJDIR?=
FAKEOBJDIR?=
BULK_TARGETS?=

# special purpose user settings
PATCH_CHECK_ONLY?=	No
REFETCH?=		false

# Global path locations.
DISTDIR?=		${PORTSDIR}/Distfiles
BULK_COOKIES_DIR?=	${PORTSDIR}/Bulk
TEMPLATES?=		${PORTSDIR}/infrastructure/templates
TMPDIR?=		/tmp
WWW_PREFIX?=		/var/www

PKGREPOSITORY?=		${PORTSDIR}/Packages
CDROM_PACKAGES?=	${PKGREPOSITORY}/CDROM
FTP_PACKAGES?=		${PKGREPOSITORY}/FTP

WRKOBJDIR_${PKGPATH}?=		${WRKOBJDIR}
FAKEOBJDIR_${PKGPATH}?=		${FAKEOBJDIR}
BULK_${PKGPATH}?=		${BULK}
BULK_TARGETS_${PKGPATH}?=	${BULK_TARGETS}
CLEANDEPENDS_${PKGPATH}?=	${CLEANDEPENDS}

# Commands and command settings.
PKG_DBDIR?=		${LOCALBASE}/db/pkg
PKG_TMPDIR?=		/var/tmp
PKG_CMDDIR?=		${LOCALBASE}/sbin
PKG_CMD_ADD?=		${PKG_CMDDIR}/pkg_add
PKG_CMD_CREATE?=	${PKG_CMDDIR}/pkg_create
PKG_CMD_DELETE?=	${PKG_CMDDIR}/pkg_delete -c
PKG_CMD_INFO?=		${PKG_CMDDIR}/pkg_info
PKG_CMD_PKG?=		${PKG_CMDDIR}/pkg
PKG_CMD_UPGRADE?=	${PKG_CMDDIR}/pkg_upgrade

.if ${MACHINE_ARCH} != ${ARCH}
PKG_ARCH?=		${MACHINE_ARCH},${ARCH}
.else
PKG_ARCH?=		${MACHINE_ARCH}
.endif

# remount those mount points ro before fake.
# XXX tends to panic the OS
PROTECT_MOUNT_POINTS?=

.if exists(${.CURDIR}/../Makefile.inc)
.  include "${.CURDIR}/../Makefile.inc"
.endif

.if !defined(PERMIT_PACKAGE_CDROM) || !defined(PERMIT_PACKAGE_FTP) || \
  !defined(PERMIT_DISTFILES_CDROM) || !defined(PERMIT_DISTFILES_FTP)
ERRORS+=		"The licencing info for ${FULLPKGNAME} is incomplete."
ERRORS+=		"Please notify the MirPorts maintainer:"
ERRORS+=		"    ${RESPONSIBLE}"
_BAD_LICENCING=		Yes
PERMIT_PACKAGE_CDROM=	No
PERMIT_DISTFILES_CDROM=	No
PERMIT_PACKAGE_FTP=	No
PERMIT_DISTFILES_FTP=	No
.endif

# CDROM should be FTP exportable!
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" && ${PERMIT_PACKAGE_FTP:L} != "yes"
ERRORS+=		"Package is marked as permit CDROM but not FTP."
.endif
.if ${PERMIT_DISTFILES_CDROM:L} == "yes" && ${PERMIT_DISTFILES_FTP:L} != "yes"
ERRORS+=		"Distfiles are marked as permit CDROM but not FTP."
.endif


.if defined(show)
.MAIN: show
show:
.  for _s in ${show}
	@@echo ${${_s}:Q}
.  endfor
.elif defined(dump)
.MAIN: show
show:
.  for _s in ${dump}
	@@echo ${_s:Q:Q}=${${_s}:Q:Q}
.  endfor
.elif defined(clean)
.MAIN: clean
.elif defined(for-build-depends)
.MAIN: for-build-depends
.elif defined(for-all-depends)
.MAIN: for-all-depends
.elif defined(for-run-depends)
.MAIN: for-run-depends
.else
.MAIN: all
.endif

FAKE?=			Yes
_LIBLIST=		${WRKDIR}/.liblist-${ARCH}${_FLAVOUR_EXT2}
_BUILDLIBLIST=		${WRKDIR}/.buildliblist-${ARCH}${_FLAVOUR_EXT2}

# need to go through an extra var because clean is set in stone,
# on the cmdline.
_clean=			${clean}
.if ${_clean:L:Mpackage} || ${_clean:L:Mpackages}
CLEANDEPENDS=		No
.endif
.if empty(_clean) || ${_clean:L} == "depends"
_clean+=		work
.endif
.if ${CLEANDEPENDS_${PKGPATH}:L} == "yes"
_clean+=		depends
.endif
.if ${_clean:L:Mwork}
_clean+=		fake
.endif
.if ${_clean:L:Mforce}
_clean+=		-f
.endif
# check that clean is clean
_okay_words=		-f bulk depends dist fake flavours force install \
			package packages readme sub work
.for _w in ${_clean:L}
.  if !${_okay_words:M${_w}}
ERRORS+=		"Fatal: unknown clean command: ${_w}"
.  endif
.endfor

NOMANCOMPRESS?=		Yes
DEF_UMASK?=		022

.if exists(${.CURDIR}/Makefile.${ARCH})
.  include "${.CURDIR}/Makefile.${ARCH}"
.elif exists(${.CURDIR}/Makefile.${MACHINE_ARCH})
.  include "${.CURDIR}/Makefile.${MACHINE_ARCH}"
.endif

NO_DEPENDS?=		No
NO_BUILD?=		No
NO_REGRESS?=		No
DIST_SUBDIR?=

.if !empty(DIST_SUBDIR)
FULLDISTDIR?=		${DISTDIR}/${DIST_SUBDIR}
.else
FULLDISTDIR?=		${DISTDIR}
.endif

.if exists(${.CURDIR}/patches.${ARCH})
PATCHDIR?=		${.CURDIR}/patches.${ARCH}
.elif exists(${.CURDIR}/patches.${MACHINE_ARCH})
PATCHDIR?=		${.CURDIR}/patches.${MACHINE_ARCH}
.else
PATCHDIR?=		${.CURDIR}/patches
.endif

PATCH_LIST?=		patch-*

.if exists(${.CURDIR}/scripts.${ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${ARCH}
.elif exists(${.CURDIR}/scripts.${MACHINE_ARCH})
SCRIPTDIR?=		${.CURDIR}/scripts.${MACHINE_ARCH}
.else
SCRIPTDIR?=		${.CURDIR}/scripts
.endif

.if exists(${.CURDIR}/files.${ARCH})
FILESDIR?=		${.CURDIR}/files.${ARCH}
.elif exists(${.CURDIR}/files.${MACHINE_ARCH})
FILESDIR?=		${.CURDIR}/files.${MACHINE_ARCH}
.else
FILESDIR?=		${.CURDIR}/files
.endif

.if exists(${.CURDIR}/pkg.${ARCH})
PKGDIR?=		${.CURDIR}/pkg.${ARCH}
.elif exists(${.CURDIR}/pkg.${MACHINE_ARCH})
PKGDIR?=		${.CURDIR}/pkg.${MACHINE_ARCH}
.elif exists(${.CURDIR}/pkg/DESCR)
PKGDIR?=		${.CURDIR}/pkg
.else
PKGDIR?=		${.CURDIR}
.endif

PREFIX?=		${LOCALBASE}
TRUEPREFIX?=		${PREFIX}
DESTDIRNAME?=		DESTDIR
DESTDIR?=		${WRKINST}
P5SITE=			libdata/perl5/site_perl

MAKE_FLAGS?=		CC=${_PASS_CC:T:Q}
.if !defined(FAKE_FLAGS)
FAKE_FLAGS=		${DESTDIRNAME}=${WRKINST:Q}
.endif

CONFIGURE_STYLE?=

.if ${USE_GMAKE:L} == "yes" || ${USE_SCHILY:L} != "no"
BUILD_DEPENDS+=		::devel/gmake
MAKE_PROGRAM=		${GMAKE}
MAKE_FLAGS+=		MAKE=$(MAKE_PROGRAM)
FAKE_FLAGS+=		MAKE=$(MAKE_PROGRAM)
.  if ${USE_SCHILY:L} != "no"
MAKE_ENV+=		MAKEPROG=${MAKE_PROGRAM:Q} CCOM=cc
.  endif
.else
MAKE_PROGRAM=		${MAKE}
.endif

.if ${CONFIGURE_STYLE:L:Mautomake} || ${CONFIGURE_STYLE:L:Mautoconf} \
    || ${CONFIGURE_STYLE:L:Mautoupdate} || ${CONFIGURE_STYLE:L:Mautogen}
.  if !${CONFIGURE_STYLE:L:Mgnu}
CONFIGURE_STYLE+=	gnu
.  endif
.endif

SUBPACKAGE?=
FLAVOUR?=
FLAVOURS?=
PSEUDO_FLAVOURS?=
FLAVOURS+=		${PSEUDO_FLAVOURS}

.if !empty(FLAVOURS:L:Mregress) && empty(FLAVOUR:L:Mregress)
NO_REGRESS=		Yes
.endif

.if ${USE_MOTIF:L} != "no"
USE_X11=		Yes
MODULES+=		motif
.endif

.if !empty(SUBPACKAGE)
.  for _i in ${SUBPACKAGE}
.    if !defined(MULTI_PACKAGES) || empty(MULTI_PACKAGES:M${_i})
ERRORS+=		"Subpackage ${SUBPACKAGE} does not exist."
.    endif
.  endfor
.endif

# Support architecture and flavour dependent packing lists
SED_PLIST?=

MCZ_FETCH?=		No
.for _i in - 0 1 2 3 4 5 6 7 8 9
.  if defined(SVN_DISTPATH${_i:N-}) && !empty(SVN_DISTPATH${_i:N-})
SVN_DISTDIR${_i:N-}?=	${SVN_DISTPATH${_i:N-}:T}
.    if !defined(SVN_DISTFILE${_i:N-}) || empty(SVN_DISTFILE${_i:N-}) 
SVN_DISTFILE${_i:N-}=	${SVN_DISTDIR${_i:N-}:T}
.    endif
SVN_DISTREV${_i:N-}?=	1
.    if ${MCZ_FETCH:L} != "no"
MASTER_SITES${_i:N-}?=	${_MASTER_SITE_MIRBSD}
.    endif
.  elif defined(CVS_DISTREPO${_i:N-}) && !empty(CVS_DISTREPO${_i:N-})
.    if ${MCZ_FETCH:L} != "no"
MASTER_SITES${_i:N-}?=	${_MASTER_SITE_MIRBSD}
.    endif
.  else
.    undef SVN_DISTPATH${_i:N-}
.    undef CVS_DISTREPO${_i:N-}
.  endif
.endfor

DASH_VER?=		0
.if defined(DIST_NAME) && defined(DIST_DATE)
PKGNAME?=		${DIST_NAME}-${DIST_DATE}-${DASH_VER}
WRKDIST?=		${WRKDIR}/${DIST_NAME}
.elif defined(CVS_DISTREPO)
PKGNAME?=		${_CVS_DISTF:R}-${DASH_VER}
WRKDIST?=		${WRKDIR}/${CVS_DISTMODS}
.elif defined(SVN_DISTPATH)
PKGNAME?=		${SVN_DISTFILE}-${SVN_DISTREV}-${DASH_VER}
WRKDIST?=		${WRKDIR}/${SVN_DISTDIR}
.else
PKGNAME?=		${DISTNAME}-${DASH_VER}
WRKDIST?=		${WRKDIR}/${DISTNAME}
.endif
FULLPKGNAME?=		${PKGNAME}${FLAVOUR_EXT}
PKGFILE=		${PKGREPOSITORY}/${FULLPKGNAME}${PKG_SUFX}
_MASTER?=

.if defined(MULTI_PACKAGES) && !empty(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
.    if !defined(FULLPKGNAME${_s})
.      if defined(PKGNAME${_s})
FULLPKGNAME${_s} =	${PKGNAME${_s}}${FLAVOUR_EXT}
.      else
FULLPKGNAME${_s} =	${PKGNAME}${_s}${FLAVOUR_EXT}
.      endif
.    endif
PKGFILE${_s} =		${PKGREPOSITORY}/${FULLPKGNAME${_s}}${PKG_SUFX}
.  endfor
.endif

_SYSTRACE_COOKIE=	${WRKDIR}/systrace.policy
_WRKDIR_COOKIE=		${WRKDIR}/.extract_started
_EXTRACT_COOKIE=	${WRKDIR}/.extract_done
_PATCH_COOKIE=		${WRKDIR}/.patch_done
_DISTPATCH_COOKIE=	${WRKDIR}/.distpatch_done
_PREPATCH_COOKIE=	${WRKDIR}/.prepatch_done
_INSTALL_COOKIE=	${PKG_DBDIR}/${FULLPKGNAME${SUBPACKAGE}}/+CONTENTS
_BULK_COOKIE=		${BULK_COOKIES_DIR}/${FULLPKGNAME}
.if ${FAKE:L} == "yes"
_FAKE_COOKIE=		${WRKINST}/.fake_done
_INSTALL_PRE_COOKIE=	${WRKINST}/.install_started
.else
_INSTALL_PRE_COOKIE=	${WRKBUILD}/.install_started
_FAKE_COOKIE=		${WRKBUILD}/.fake_done
.endif
_PACKAGE_COOKIE=	${PKGFILE}
_CONFIGURE_COOKIE=	${WRKBUILD}/.configure_done
_BUILD_COOKIE=		${WRKBUILD}/.build_done
_REGRESS_COOKIE=	${WRKBUILD}/.regress_done

_ALL_COOKIES=		${_EXTRACT_COOKIE} ${_PATCH_COOKIE} \
			${_CONFIGURE_COOKIE} ${_INSTALL_PRE_COOKIE} \
			${_BUILD_COOKIE} ${_REGRESS_COOKIE} \
			${_PACKAGE_COOKIES} ${_DISTPATCH_COOKIE} \
			${_PREPATCH_COOKIE} ${_FAKE_COOKIE} \
			${_WRKDIR_COOKIE} ${_DEPlib_COOKIES} \
			${_DEPbuild_COOKIES} ${_DEPrun_COOKIES} \
			${_DEPregress_COOKIES}

_MAKE_COOKIE?=		touch -f

# Miscellaneous overridable commands:
GMAKE?=			gmake
USE_CCACHE?=		No

CHECKSUM_FILE?=		${.CURDIR}/distinfo

# Don't touch!!! Used for generating checksums.
_CIPHERS=		rmd160 tiger sha1 sha256 md5

_PORTPATH?=		${LOCALBASE}/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/sbin
.if ${USE_X11:L} == "yes"
_PORTPATH:=		${_PORTPATH}:${X11BASE}/bin
.endif
PORTPATH?=		${WRKDIR}/bin:${_PORTPATH}

# Add any COPTS to CFLAGS.
CPPFLAGS+=		-idirafter ${LOCALBASE}/include
.if ${USE_X11:L} == "yes"
CPPFLAGS+=		-idirafter ${X11BASE}/include
.endif
CFLAGS+=		${COPTS} ${CPPFLAGS}
CXXFLAGS+=		${CXXOPTS} ${CPPFLAGS}
.if defined(WARNINGS) && ${WARNINGS:L} == "yes"
.  if defined(CDIAGFLAGS)
CFLAGS+=		${CDIAGFLAGS}
.  endif
.  if defined(CXXDIAGFLAGS)
CXXFLAGS+=		${CXXDIAGFLAGS}
.  endif
.endif
# cf. http://libtorrent.rakshasa.no/wiki/LibTorrentKnownIssues#Badcodeproducedwith-fomit-frame-pointer
CXXFLAGS+=		-fno-omit-frame-pointer
LDFLAGS+=		${LDSTATIC} -Wl,--library-after=${LOCALBASE}/lib
.if ${OBJECT_FMT} == "ELF"
LDFLAGS+=		-Wl,-rpath -Wl,${LOCALBASE}/lib
.endif

_DEFCOPTS_pcc?=		-O

NO_CXX?=		No	# inhibit use of C++ ports
USE_COMPILER?=		system
.if ${USE_COMPILER:L} == "gcc4.4"
HAS_CXX:=		port
_CXX_LIB_DEPENDS=	# empty as the libs are not in LOCALBASE/lib/ directly
.endif
.if ${USE_CXX:L} == "yes"
.  if ${NO_CXX:L} == "yes"
NO_CXX=			C++ is explicitly disabled
.  elif ${HAS_CXX:L} == "base"
CXX?=			g++
NO_CXX=			No
.  elif ${HAS_CXX:L} == "port"
LIB_DEPENDS+=		${_CXX_LIB_DEPENDS}
NO_CXX=			No
.  elif ${HAS_CXX:L} != "reason"
NO_CXX=			C++ is not supported on this system
.  endif
.else
NO_CXX=			not explicitly requested by this port
.endif
_ORIG_CC:=		${CC}
_ORIG_CXX:=		${CXX}
.if ${USE_COMPILER:L} == "pcc"
BUILD_DEPENDS+=		:pcc-*:lang/pcc
USE_CCACHE:=		No
_DEFCOPTS:=		${_DEFCOPTS_pcc}
_DEFcTOsOPTS:=		-S
_ORIG_CC:=		pcc
_ORIG_CXX:=		false
.elif ${USE_COMPILER:L} == "gcc4.4"
BUILD_DEPENDS+=		:gcc-4.4.7-*:lang/egcs/gcc4.4
RUN_DEPENDS+=		:gcc-rtl-4.4.7-*:lang/egcs/gcc4.4,-rtl
_ORIG_CC:=		gcc-4.4
_ORIG_CXX:=		g++-4.4
.elif ${USE_COMPILER:L} != "system"
.  error invalid compiler: ${USE_COMPILER}
.endif
_USE_CC:=		${_ORIG_CC}
_USE_CXX:=		${_ORIG_CXX}
.if ${NO_CXX:L} != "no"
_USE_CXX:=		false
.endif
_USE_CCSTD?=		-std=gnu99
_USE_CXXSTD?=		# the equivalent?

.if ${USE_CCACHE:L} == "yes"
CCACHE_DEPENDS?=	:ccache->=2.4-3:devel/ccache
BUILD_DEPENDS+=		${CCACHE_DEPENDS}
CCACHE_DIR?=		${HOME}/.etc/ccache
.  if !empty(CCACHE_DEPENDS)
_USE_CC:=		env CCACHE_DIR=${CCACHE_DIR:Q} CCACHE_NOLINK=1 \
			    CCACHE_UMASK=002 ccache ${_USE_CC}
.    if ${NO_CXX:L} == "no"
_USE_CXX:=		env CCACHE_DIR=${CCACHE_DIR:Q} CCACHE_NOLINK=1 \
			    CCACHE_UMASK=002 ccache ${_USE_CXX}
.    endif
.  endif
.endif

.if !empty(WRKOBJDIR_${PKGPATH})
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOUR_EXT2}
.else
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOUR_EXT2}
.endif

.undef CC
.undef CXX
#.if _ORIG_CC is a gcc (and _ORIG_CXX is a g++)
_MPWRAP_CC=		mpgcc
_MPWRAP_CXX=		mpg++
#.else
#_MPWRAP_CC=		mpcc
#_MPWRAP_CXX=		mpcxx
#.endif
_PASS_CC=		${WRKDIR}/bin/${_MPWRAP_CC}
_PASS_CXX=		${WRKDIR}/bin/${_MPWRAP_CXX}
.if ${USE_COMPILER:L} == "pcc"
_PASS_CC=		${_ORIG_CC}
_PASS_CXX=		${_ORIG_CXX}
.endif
CC=			${_PASS_CC:T}
CXX=			${_PASS_CXX:T}

MAKE_FILE?=		Makefile
PORTHOME?=		/${PKGNAME}_writes_to_HOME

MAKE_ENV+=		HOME=${PORTHOME:Q} PATH=${PORTPATH:Q} \
			PREFIX=${PREFIX:Q} TRUEPREFIX=${PREFIX:Q} \
			LOCALBASE=${LOCALBASE:Q} X11BASE=${X11BASE:Q} \
			CC=${_PASS_CC:T:Q} LDFLAGS=${LDFLAGS:Q} ${DESTDIRNAME}= \
			CXX=${_PASS_CXX:T:Q} CFLAGS=${CFLAGS:M*:Q} \
			BINOWN=${BINOWN:Q} BINGRP=${BINGRP:Q} \
			EXTRA_SYS_MK_INCLUDES=\"${PORTSDIR:Q}/infrastructure/mk/mirports.bsd.mk\"
.if ${NO_CXX:L} == "no"
MAKE_ENV+=		CXXFLAGS=${CXXFLAGS:M*:Q}
.endif

.if defined(LDADD) && !empty(LDADD)
MAKE_ENV+=		LDADD=${LDADD:Q}
.endif

DISTORIG?=		.bak.orig
PATCH?=			/usr/bin/patch
PATCHORIG?=		.orig
PATCH_STRIP?=		-p0
PATCH_DIST_STRIP?=	-p0

PATCH_DEBUG?=		No
.if ${PATCH_DEBUG:L} != "no"
PATCH_ARGS?=		-b -d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b -z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
.else
PATCH_ARGS?=		-b -d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-b -z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
.endif

.if ${PATCH_CHECK_ONLY:L} == "yes"
PATCH_ARGS+=		-C
PATCH_DIST_ARGS+=	-C
.endif

NO_SYSTRACE?=		No
.if ${NO_SYSTRACE:L} == "no"
_SYSTRACE_CMD?=		/bin/systrace ${_SYSTRACE_ARGS} -f ${_SYSTRACE_COOKIE}
.else
_SYSTRACE_CMD=
.endif

TAR?=			/bin/tar
UNZIP?=			unzip
BZIP2?=			bzip2
AWK?=			/usr/bin/awk
M4?=			/usr/bin/m4

.if !empty(FAKEOBJDIR_${PKGPATH})
WRKINST?=		${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOUR_EXT2}
.else
WRKINST?=		${WRKDIR}/fake-${ARCH}${_FLAVOUR_EXT2}
.endif

WRKSRC?=		${WRKDIST}
WRKBUILD?=		${WRKSRC}
WRKPKG?=		${WRKBUILD}/.pkg
WRKCONF?=		${WRKBUILD}

ALL_TARGET?=		all
INSTALL_TARGET?=	install
FAKE_TARGET?=		${INSTALL_TARGET}

.for _i in perl gnu imake
.  if ${CONFIGURE_STYLE:L:M${_i}}
MODULES+=		${_i}
.  endif
.endfor

.if defined(MODULES)
_MODULES_DONE=
.  include "${PORTSDIR}/infrastructure/mk/modules.port.mk"
.endif

EXTRA_XAKE_FLAGS+=	SHELL=${SHELL:Q}
MAKE_FLAGS+=		${EXTRA_MAKE_FLAGS} ${EXTRA_XAKE_FLAGS}
FAKE_FLAGS+=		${EXTRA_FAKE_FLAGS} ${EXTRA_XAKE_FLAGS}

# Build FLAVOUR_EXT, checking that no flavours are misspelled
FLAVOUR_EXT:=
# _FLAVOUR_EXT2 is used internally for working directories.
# It encodes flavours and pseudo-flavours.
_FLAVOUR_EXT2:=

# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
.if !empty(FLAVOURS)
.  for _i in ${FLAVOURS:L}
.    if empty(FLAVOUR:L:M${_i})
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' \
		-e '//d' \
		-e '/^%%${_i}%%$$/d'
.    else
_FLAVOUR_EXT2:=	${_FLAVOUR_EXT2}-${_i}
.    if empty(PSEUDO_FLAVOURS:L:M${_i})
FLAVOUR_EXT:=	${FLAVOUR_EXT}-${_i}
.    endif
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/d' \
		-e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' \
		-e '//d'
.    endif
.  endfor
.endif

.if !empty(FLAVOURS:M[0-9]*)
ERRORS+=		"Flavour cannot start with a digit."
.endif

.if !empty(FLAVOUR)
.  if !empty(FLAVOURS)
.    for _i in ${FLAVOUR:L}
.      if empty(FLAVOURS:L:M${_i})
ERRORS+=		"Unknown flavour: ${_i}"
ERRORS+=		"Possible flavours are: ${FLAVOURS}"
.      endif
.    endfor
.  else
ERRORS+=		"No flavours for this port."
.  endif
.endif

###
### Variable setup that can happen after modules
###

REGRESS_TARGET?=	regress
REGRESS_FLAGS?=		${MAKE_FLAGS}

.if ${FAKE:L} == "yes"
_PACKAGE_COOKIE_DEPS=	${_FAKE_COOKIE}
.else
_PACKAGE_COOKIE_DEPS=	${_INSTALL_COOKIE}
.endif

_PACKAGE_COOKIES=	${_PACKAGE_COOKIE}
.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE= FLAVOUR=${FLAVOUR:Q} PACKAGING= exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

.for _s in ${MULTI_PACKAGES}
_PACKAGE_COOKIE${_s} =	${PKGFILE${_s}}
_PACKAGE_COOKIES+=	${_PACKAGE_COOKIE${_s}}
.endfor

.if empty(SUBPACKAGE)
.  if empty(FLAVOUR_EXT)
FULLPKGPATH=		${PKGPATH},
.  else
FULLPKGPATH=		${PKGPATH}${FLAVOUR_EXT:S/-/,/g}
.  endif
.else
FULLPKGPATH=		${PKGPATH},${SUBPACKAGE}${FLAVOUR_EXT:S/-/,/g}
.endif

# A few aliases for *-install targets
INSTALL_PROGRAM?=	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} \
			    -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_LIB?=		${INSTALL} ${INSTALL_COPY} \
			    -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE}
INSTALL_SCRIPT?=	${INSTALL} ${INSTALL_COPY} \
			    -o ${BINOWN} -g ${BINGRP} -m ${BINMODE}
INSTALL_DATA?=		${INSTALL} ${INSTALL_COPY} \
			    -o ${SHAREOWN} -g ${SHAREGRP} -m ${SHAREMODE}
INSTALL_MAN?=		${INSTALL} ${INSTALL_COPY} \
			    -o ${MANOWN} -g ${MANGRP} -m ${MANMODE}

INSTALL_PROGRAM_DIR?=	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${DIRMODE}
INSTALL_LIB_DIR?=	${INSTALL_PROGRAM_DIR}
INSTALL_SCRIPT_DIR?=	${INSTALL_PROGRAM_DIR}
INSTALL_DATA_DIR?=	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${DIRMODE}
INSTALL_MAN_DIR?=	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${DIRMODE}

_INSTALL_MACROS=	BSD_INSTALL_PROGRAM=${INSTALL_PROGRAM:Q} \
			BSD_INSTALL_LIB=${INSTALL_LIB:Q} \
			BSD_INSTALL_SCRIPT=${INSTALL_SCRIPT:Q} \
			BSD_INSTALL_DATA=${INSTALL_DATA:Q} \
			BSD_INSTALL_MAN=${INSTALL_MAN:Q} \
			BSD_INSTALL_PROGRAM_DIR=${INSTALL_PROGRAM_DIR:Q} \
			BSD_INSTALL_LIB_DIR=${INSTALL_LIB_DIR:Q} \
			BSD_INSTALL_SCRIPT_DIR=${INSTALL_SCRIPT_DIR:Q} \
			BSD_INSTALL_DATA_DIR=${INSTALL_DATA_DIR:Q} \
			BSD_INSTALL_MAN_DIR=${INSTALL_MAN_DIR:Q}
MAKE_ENV+=		${_INSTALL_MACROS}
SCRIPTS_ENV+=		${_INSTALL_MACROS}

# setup systrace variables
SYSTRACE_FILTER?=	${PORTSDIR}/infrastructure/templates/systrace.filter
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env \
			${_MIRMAKE_EXE} ${LOCALBASE}/bin/gmake
SYSTRACE_SUBST_VARS+=	DISTDIR PKG_TMPDIR PORTSDIR TMPDIR WRKDIR
.for _v in ${SYSTRACE_SUBST_VARS}
_SYSTRACE_SED_SUBST+=	-e 's,$${${_v}},${${_v}},g'
.endfor

# Create the generic variable substitution list, from subst vars
SUBST_VARS+=		MACHINE_ARCH ARCH HOMEPAGE PREFIX SYSCONFDIR \
			FLAVOUR_EXT RESPONSIBLE VSN
.if ${USE_X11:L} == "yes"
SUBST_VARS+=		X11BASE
.endif
_SED_SUBST=		sed
.for _v in ${SUBST_VARS}
_SED_SUBST+=		-e 's|$${${_v}}|${${_v}}|g'
.endfor
_SED_SUBST+=		-e 's,$${FLAVOURS},${FLAVOUR_EXT},g' -e 's,$$\\,$$,g'
# and append it to the PLIST substitution pipeline
SED_PLIST+=		|${_SED_SUBST}

SUBST_CMD=		perl -pi
.for i in ${SUBST_VARS}
SUBST_CMD+=		-e "s%\\\$${$i}%${$i}%;"
.endfor

.if !defined(NO_LIBTOOLISE_PLIST) || (${NO_LIBTOOLISE_PLIST:L} == "no")
SED_PLIST+=		| (cd ${WRKINST}${PREFIX}; LOCALBASE=${LOCALBASE} perl -W ${PORTSDIR}/infrastructure/scripts/unlibtoolise || rm -f $@@.tmp)
.endif

# find out the most appropriate PLIST source
.if !defined(PLIST) \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.${ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.${ARCH}
.elif !defined(PLIST) \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.${MACHINE_ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.${MACHINE_ARCH}
.endif
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.noshared)
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}.noshared
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOUR_EXT}
.endif
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.${ARCH}
.elif !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.${MACHINE_ARCH}
.endif
.if !defined(PLIST) && ${NO_SHARED_LIBS:L} == "yes" \
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}.noshared)
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}.noshared
.endif
PLIST?=			${PKGDIR}/PLIST${SUBPACKAGE}

# Likewise for DESCR/MESSAGE/COMMENT
.if defined(COMMENT${SUBPACKAGE}${FLAVOUR_EXT})
_COMMENT=		${COMMENT${SUBPACKAGE}${FLAVOUR_EXT}}
.elif defined(COMMENT${SUBPACKAGE})
_COMMENT=		${COMMENT${SUBPACKAGE}}
.endif

.if exists(${PKGDIR}/MESSAGE${SUBPACKAGE})
MESSAGE?=		${PKGDIR}/MESSAGE${SUBPACKAGE}
.endif

DESCR?=			${PKGDIR}/DESCR${SUBPACKAGE}

MTREE_FILE?=
.if ${PREFIX} == "/usr"
MTREE_FILE+=		${PORTSDIR}/infrastructure/templates/4.4BSD.dist
.endif
MTREE_FILE+=		${LOCALBASE}/db/fake.mtree

# Fill out package command, and package dependencies
_PKG_PREREQ=		${WRKPKG}/PLIST${SUBPACKAGE} \
			${WRKPKG}/DESCR${SUBPACKAGE} \
			${WRKPKG}/COMMENT${SUBPACKAGE}
# Note that if you override PKG_ARGS, you will not get correct dependencies;
# you can add stuff to PKG_ARGS_ADD instead
.if !defined(PKG_ARGS)
PKG_ARGS=		-v -c ${WRKPKG:Q}/COMMENT${SUBPACKAGE:Q} \
			-d ${WRKPKG}/DESCR${SUBPACKAGE}
PKG_ARGS+=		-f ${WRKPKG}/PLIST${SUBPACKAGE} -p ${PREFIX}
.  if exists(${PKGDIR}/INSTALL${SUBPACKAGE})
PKG_ARGS+=		-i ${WRKPKG}/INSTALL${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/INSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/DEINSTALL${SUBPACKAGE})
PKG_ARGS+=		-k ${WRKPKG}/DEINSTALL${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/DEINSTALL${SUBPACKAGE}
.  endif
.  if exists(${PKGDIR}/REQ${SUBPACKAGE})
PKG_ARGS+=		-r ${WRKPKG}/REQ${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/REQ${SUBPACKAGE}
.  endif
.  if defined(MESSAGE) && ${MESSAGE} != "/dev/null"
PKG_ARGS+=		-D ${WRKPKG}/MESSAGE${SUBPACKAGE}
_PKG_PREREQ+=		${WRKPKG}/MESSAGE${SUBPACKAGE}
.  endif
.endif
.if defined(EMUL) && !empty(EMUL)
PKG_ARGS+=		-e ${EMUL:Q}
.endif
.if ${FAKE:L} == "yes"
PKG_ARGS+=		-S ${WRKINST}
.endif
PKG_ARGS+=		${PKG_ARGS_ADD}
.if !defined(_COMMENT)
ERRORS+=		"Missing port comment in Makefile."
.endif
.if ${FULLPKGNAME:C/-[0-9][0-9]*(-[a-zA-Z][^-]*)*$//:C/^.*-([^-]*)$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}
ERRORS+=		"Invalid version number in main package '${FULLPKGNAME}': ${FULLPKGNAME:C/-[0-9][0-9]*(-[a-zA-Z][^-]*)*$//:C/^.*-([^-]*)$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
.endif
.if defined(MULTI_PACKAGES) && !empty(MULTI_PACKAGES)
.  for _s in ${MULTI_PACKAGES}
.    if ${FULLPKGNAME${_s}:C/-[0-9][0-9]*(-[a-zA-Z][^-]*)*$//:C/^.*-([^-]*)$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}
ERRORS+=		"Invalid version number in '${_s}' subpackage '${FULLPKGNAME${_s}}': ${FULLPKGNAME${_s}:C/-[0-9][0-9]*(-[a-zA-Z][^-]*)*$//:C/^.*-([^-]*)$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
.    endif
.  endfor
.endif

CHMOD?=			/bin/chmod
CHOWN?=			/sbin/chown
GUNZIP_CMD?=		/usr/bin/gunzip -f
GZCAT?=			/usr/bin/gzip -dc
GZIP?=			-n9
GZIP_CMD?=		/usr/bin/gzip -nf ${GZIP}
LDCONFIG?=		[ ! -x /sbin/ldconfig ] || /sbin/ldconfig
STRIP?=			/usr/bin/strip

# Autoconf scripts MAY tend to use bison by default otherwise
YACC?=			yacc
# XXX ${SETENV} is needed in front of var=value lists whenever the next
# command is expanded from a variable, as this could be a shell construct
SETENV?=		/usr/bin/env -i
# Override only if port depends e.g. on GNU bash features. Not recommended.
SH?=			${SHELL}

# Used to print all the '===>' style prompts - override this to turn them off.
ECHO_MSG?=		echo

.for _i _j in _OUR_LDLIBPATH LD_LIBRARY_PATH PERL5LIB PERL5LIB
.  if defined(${_i}) && !empty(${_i})
SETENV+=		${_j}=${${_i}:Q}
.  endif
.endfor

.for _i in ${SETENV_TO_KEEP}
.  if defined(${_i}) && !empty(${_i})
SETENV+=		${_i:Q}=${${_i}:Q}
.  endif
.endfor

# basic master sites configuration

.if exists(${PORTSDIR}/infrastructure/db/network.conf)
.  include "${PORTSDIR}/infrastructure/db/network.conf"
.else
.  include "${PORTSDIR}/infrastructure/templates/network.conf.template"
.endif
# Where to put distfiles that don't have any other master site
#
MASTER_SITE_LOCAL?= \
	ftp://ftp.netbsd.org/pub/NetBSD/packages/distfiles/LOCAL_PORTS/ \
	ftp://ftp.freebsd.org/pub/FreeBSD/distfiles/LOCAL_PORTS/

# Empty declarations to avoid "variable XXX is recursive" errors
MASTER_SITES?=
# I guess we're in the master distribution business! :)  As we gain mirror
# sites for distfiles, add them to this list.
.if !defined(MASTER_SITE_OVERRIDE)
MASTER_SITES:=	${MASTER_SITES} ${MASTER_SITE_BACKUP}
.else
MASTER_SITES:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES}
.endif

# _SITE_SELECTOR chooses the value of sites based on select.
_SITE_SELECTOR=	case $$select in

.for _I in 0 1 2 3 4 5 6 7 8 9
.  if defined(MASTER_SITES${_I})
.    if !defined(MASTER_SITE_OVERRIDE)
MASTER_SITES${_I}:=	${MASTER_SITES${_I}} ${MASTER_SITE_BACKUP}
.    else
MASTER_SITES${_I}:=	${MASTER_SITE_OVERRIDE} ${MASTER_SITES${_I}}
.    endif
_SITE_SELECTOR+=	*:${_I}) sites=${MASTER_SITES${_I}:Q};;
.  else
_SITE_SELECTOR+=	*:${_I}) echo >&2 \
			    "Error: MASTER_SITES${_I} not defined";;
.  endif
.endfor
_SITE_SELECTOR+=	*) sites=${MASTER_SITES:Q};; esac


# Code to handle ports distfiles on a CDROM.  The distfiles
# are located in /cdrom/distfiles/${DIST_SUBDIR}/ (assuming that the
# CD-ROM is mounted on /cdrom).
.if exists(/cdrom/distfiles)
CDROM_SITE?=		/cdrom/distfiles/${DIST_SUBDIR}
.else
CDROM_SITE?=
.endif

FETCH_SYMLINK_DISTFILES?=Yes
.if !empty(CDROM_SITE)
.  if ${FETCH_SYMLINK_DISTFILES:L} == "yes"
_CDROM_OVERRIDE=	if test -e ${CDROM_SITE}/$$f && \
			    ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
.  else
_CDROM_OVERRIDE=	if cp -f ${CDROM_SITE}/$$f .; then exit 0; fi
.  endif
.else
_CDROM_OVERRIDE=	:
.endif

_CVS_FDEP=
.for _i in - 0 1 2 3 4 5 6 7 8 9
.  undef _CVS_DISTF${_i:N-}
.  if defined(CVS_DISTREPO${_i:N-})
CVS_DISTFILE${_i:N-}?=	${CVS_DISTMODS${_i:N-}}
_CVS_DISTF${_i:N-}=	${CVS_DISTFILE${_i:N-}}-
.    if defined(CVS_DISTTAGS${_i:N-})
.      for _j in ${CVS_DISTTAGS${_i:N-}:C![^0-9a-zA-Z_-]!!g}
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}}T${_j}-
.      endfor
.    endif
.    if defined(CVS_DISTDATE${_i:N-})
.      for _j in ${CVS_DISTDATE${_i:N-}:C![^0-9]!!g}
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}}${_j}
.      endfor
.    endif
.    if defined(CVS_DISTTAGS${_i:N-}) || defined(CVS_DISTDATE${_i:N-})
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}:S/-$//}.mcz
.    else
ERRORS+=		"neither CVS_DISTDATE${_i:N-} nor CVS_DISTTAGS${_i:N-} defined"
.    endif
_CVS_FETCH${_i:N-}=	${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz \
			    ${_MKMCZ_OPTS} \
			    ${FULLDISTDIR:Q}/${_CVS_DISTF${_i:N-}:Q} \
			    '${CVS_DISTREPO${_i:N-}}' \
			    '${CVS_DISTDATE${_i:N-}}' \
			    '${CVS_DISTTAGS${_i:N-}}' \
			    ${CVS_DISTMODS${_i:N-}:Q}
_CVS_FDEP+=		mpczar
.  elif defined(SVN_DISTPATH${_i:N-})
_CVS_DISTF${_i:N-}=	${SVN_DISTFILE${_i:N-}}-r${SVN_DISTREV${_i:N-}}.mcz
_CVS_FETCH${_i:N-}=	${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz \
			    ${_MKMCZ_OPTS} -s \
			    ${FULLDISTDIR:Q}/${_CVS_DISTF${_i:N-}:Q} \
			    ${SVN_DISTPATH${_i:N-}:Q} \
			    ${SVN_DISTREV${_i:N-}:Q} \
			    ${SVN_DISTDIR${_i:N-}:Q}
_CVS_FDEP+=		mpczar svn
.  endif
.  if defined(_CVS_DISTF${_i:N-}) && (${MCZ_FETCH:L} == "xz")
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}}.xz
.  elif defined(_CVS_DISTF${_i:N-}) && (${MCZ_FETCH:L} == "lz")
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}}.lz
.  elif defined(_CVS_DISTF${_i:N-}) && (${MCZ_FETCH:L} == "lzma")
_CVS_DISTF${_i:N-}:=	${_CVS_DISTF${_i:N-}}.lzma
.  endif
.endfor

DIST_SOURCE?=		distfile
.if ${_CVS_FDEP:Mmpczar}
.  if ${MCZ_FETCH:L} == "no"
FETCH_DEPENDS+=		:mpczar->=20081101:archivers/mpczar
.  endif
DIST_SOURCE=		distfile
.  if defined(_CVS_DISTF)
DISTFILES=
.  endif
.endif
.if ${_CVS_FDEP:Msvn}
.  if ${MCZ_FETCH:L} == "no"
FETCH_DEPENDS+=		:subversion-*:devel/subversion
.  endif
.endif
.if ${DIST_SOURCE:L} == "port"
DIST_SOURCEDIR?=	${.CURDIR}/dist
.  if (${PERMIT_DISTFILES_CDROM:L} != "yes") || (${PERMIT_DISTFILES_FTP:L} != "yes")
ERRORS+=		"If using DIST_SOURCE=port the distfiles must be licenced appropriately."
ERRORS+=		"Please notify the MirPorts maintainer:"
ERRORS+=		"    ${RESPONSIBLE}"
_BAD_LICENCING=		Yes
.  endif
.elif ${DIST_SOURCE:L} == "module"
DIST_SOURCEDIR?=	${PORTSDIR}/Extras/${DIST_NAME}
.endif
.if ${DIST_SOURCE:L} != "distfile"
NO_CHECKSUM=		defined
NO_DISTFILES=		defined
.endif
EXTRACT_SUFX?=		.tar.gz
DISTFILES?=		${DISTNAME}${EXTRACT_SUFX}

_EVERYTHING=		${DISTFILES}
_DISTFILES=		${DISTFILES:C/:[0-9]$//}

.for _i in - 0 1 2 3 4 5 6 7 8 9
.  if defined(_CVS_DISTF${_i:N-})
_DISTFILES+=		${_CVS_DISTF${_i:N-}}
.  endif
.endfor

ALLFILES=		${_DISTFILES}

.if defined(PATCHFILES)
_PATCHFILES=		${PATCHFILES:C/:[0-9]$//}
_EVERYTHING+=		${PATCHFILES}
ALLFILES+=		${_PATCHFILES}
.endif

.if make(checksum) || make(makesum) || make(addsum) || defined(__FETCH_ALL)
.  if defined(SUPDISTFILES) && !defined(NOSUPDISTFILES)
_EVERYTHING+=		${SUPDISTFILES}
ALLFILES+=		${SUPDISTFILES:C/:[0-9]$//}
.  endif
.endif

__CKSUMFILES=
# First, remove duplicates
.for _file in ${ALLFILES}
.  if empty(__CKSUMFILES:M${_file})
__CKSUMFILES+=		${_file}
.  endif
.endfor
ALLFILES:=		${__CKSUMFILES}

.if defined(IGNOREFILES)
.  for _file in ${IGNOREFILES}
__CKSUMFILES:=		${__CKSUMFILES:N${_file}}
.  endfor
.endif

# List of all files, with ${DIST_SUBDIR} in front.  Used for checksum.
.if !empty(DIST_SUBDIR)
_CKSUMFILES=		${__CKSUMFILES:S/^/${DIST_SUBDIR}\//}
_IGNOREFILES=		${IGNOREFILES:S/^/${DIST_SUBDIR}\//}
.else
_CKSUMFILES=		${__CKSUMFILES}
_IGNOREFILES=		${IGNOREFILES}
.endif

# This is what is actually going to be extracted, and is overridable
#  by user.
EXTRACT_ONLY?=		${_DISTFILES}

# okay, time for some guess work
.if !empty(EXTRACT_ONLY:M*.bz2) || \
    !empty(EXTRACT_ONLY:M*.tbz) || !empty(EXTRACT_ONLY:M*.cbz) || \
    (defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
_USE_BZIP2?=		Yes
.endif
.if !empty(EXTRACT_ONLY:L:M*.l[zh][ha])
_USE_LHARC?=		Yes
.endif
.if !empty(EXTRACT_ONLY:M*.lzma)
_USE_LZMA?=		Yes
.endif
.if !empty(EXTRACT_ONLY:M*.xz) || \
    !empty(EXTRACT_ONLY:M*.txz) || !empty(EXTRACT_ONLY:M*.cxz)
_USE_XZ?=		Yes
.endif
.if !empty(EXTRACT_ONLY:M*.lz) || \
    !empty(EXTRACT_ONLY:M*.tlz)
_USE_LZIP?=		Yes
.endif
.if !empty(EXTRACT_ONLY:M*.zip)
_USE_ZIP?=		Yes
.endif
_USE_BZIP2?=		No
_USE_LHARC?=		No
_USE_LZMA?=		No
_USE_XZ?=		No
_USE_LZIP?=		No
_USE_ZIP?=		No

EXTRACT_CASES?=

_PERL_FIX_SHAR?=	perl -ne 'print if $$s || ($$s = m:^\#(\!\s*/bin/sh\s*| This is a shell archive):)'

# XXX note that we DON'T set EXTRACT_SUFX.

.if ${_USE_BZIP2:L} != "no"
BUILD_DEPENDS+=		:bzip2-*:archivers/bzip2
EXTRACT_CASES+=		\
    *.tar.bz2 | *.tbz | *.cpio.bz2 | *.cbz)				\
	${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;		\
    *.bz2)								\
	${BZIP2} -dc ${FULLDISTDIR}/$$archive >$$(basename $$archive .bz2) ;;
.endif

.if ${_USE_LHARC:L} != "no"
BUILD_DEPENDS+=		:lha-*:archivers/lha
EXTRACT_CASES+=		\
    *.[Ll][Zz][Hh] | *.[Ll][Hh][Aa]) \
	lha xw=${WRKDIR}/${DISTNAME} ${FULLDISTDIR}/$$archive ;;
.endif

.if ${_USE_LZMA:L} != "no"
#BUILD_DEPENDS+=		:lzma-*:archivers/lzma
.  if !exists(/usr/bin/xzdec)
BUILD_DEPENDS+=		:xz-*:archivers/xz
.  endif
EXTRACT_CASES+=		\
    *.tar.lzma | *.cpio.lzma | *.mcz.lzma)				\
	lzmadec <${FULLDISTDIR}/$$archive | ${TAR} xf - ;;		\
    *.lzma)								\
	lzmadec <${FULLDISTDIR}/$$archive >$$(basename $$archive .lzma) ;;
.endif

.if ${_USE_XZ:L} != "no"
EXTRACT_CASES+=		\
    *.tar.xz | *.txz | *.cpio.xz | *.cxz | *.mcz.xz)			\
	xzdec <${FULLDISTDIR}/$$archive | ${TAR} xf - ;;		\
    *.xz)								\
	xzdec <${FULLDISTDIR}/$$archive >$$(basename $$archive .xz) ;;
.endif

.if ${_USE_LZIP:L} != "no"
BUILD_DEPENDS+=		:pdlzip-*:archivers/pdlzip
EXTRACT_CASES+=		\
    *.tar.lz | *.tlz | *.cpio.lz | *.mcz.lz)				\
	pdlzip -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;		\
    *.lz)								\
	pdlzip -dc ${FULLDISTDIR}/$$archive >$$(basename $$archive .lz) ;;
.endif

.if ${_USE_ZIP:L} != "no"
BUILD_DEPENDS+=		:unzip-*:archivers/unzip
# stupid stupid stupid, LHarc extract caces do this right,
# but we cannot change the default to Yes now for compatâ€¦
_USE_ZIP_SUBDIR?=	No
.if ${_USE_ZIP_SUBDIR:L} == "no"
EXTRACT_CASES+=		\
    *.zip) \
	${UNZIP} -q ${FULLDISTDIR}/$$archive -d ${WRKDIR} ;;
.else
EXTRACT_CASES+=		\
    *.zip) \
	${UNZIP} -q ${FULLDISTDIR}/$$archive -d ${WRKDIR}/${DISTNAME} ;;
.endif
.endif

EXTRACT_CASES+=		\
    *.tar.gz | *.tar.[Zz] | *.t.gz | *.tgz | *.taz |			\
    *.cpio.gz | *.cpio.[Zz] | *.cgz | *.ngz | *.mcz)			\
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;	\
    *.tar | *.cpio)							\
	${TAR} xf ${FULLDISTDIR}/$$archive ;;				\
    *.shar.gz | *.shar.[Zz] | *.sh.gz | *.sh.[Zz])			\
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive |			\
	    ${_PERL_FIX_SHAR} | ${SH} ;;				\
    *.shar | *.sh | *.shr)						\
	${_PERL_FIX_SHAR} ${FULLDISTDIR}/$$archive | ${SH} ;;		\
    *.gz | *.[Zz])							\
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive			\
	    >$$(basename $$archive .gz) ;;				\
    *.jar | *.pdf | *.txi)						\
	cp ${FULLDISTDIR}/$$archive ${WRKDIR}/ ;;			\
    *.uu.gz | *.uu.[Zz])						\
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | uudecode ;;		\
    *.uu)								\
	uudecode ${FULLDISTDIR}/$$archive ;;				\
    *)									\
	${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;


PATCH_CASES?=
.if ${_USE_BZIP2:L} != "no"
PATCH_CASES+=		*.bz2) ${BZIP2} -dc $$patchfile \
			    | ${PATCH} ${PATCH_DIST_ARGS} ;;
.endif
PATCH_CASES+=		*.Z|*.gz) ${GZCAT} $$patchfile \
			    | ${PATCH} ${PATCH_DIST_ARGS} ;;
PATCH_CASES+=		*) ${PATCH} ${PATCH_DIST_ARGS} <$$patchfile ;;

# Documentation
RESPONSIBLE?=		The MirBSD discuss mailing list, see: http://www.mirbsd.org/rss.htm\#lists

.if !defined(CATEGORIES)
ERRORS+=		"Makefile variable CATEGORIES is mandatory."
.endif


CONFIGURE_SCRIPT?=	configure
.if ${CONFIGURE_SCRIPT:M/*}
_CONFIGURE_SCRIPT=	${CONFIGURE_SCRIPT}
.elif exists(${WRKSRC}/${CONFIGURE_SCRIPT})
_CONFIGURE_SCRIPT=	${WRKSRC}/${CONFIGURE_SCRIPT}
.else
_CONFIGURE_SCRIPT=	./${CONFIGURE_SCRIPT}
.endif

CONFIGURE_ENV+=		PATH=${PORTPATH:Q}
CONFIGURE_ENV+=		SHELL=${MKSH:Q} CONFIG_SHELL=${MKSH:Q}

.if ${NO_SHARED_LIBS:L} == "yes"
CONFIGURE_SHARED?=	--disable-shared
.else
CONFIGURE_SHARED?=	--enable-shared
.endif

# Passed to configure invocations, and user scripts
SCRIPTS_ENV+=		CURDIR=${.CURDIR:Q} DISTDIR=${DISTDIR:Q} \
			PATH=${PORTPATH:Q} WRKDIR=${WRKDIR:Q} \
			WRKDIST=${WRKDIST:Q} WRKSRC=${WRKSRC:Q} \
			WRKBUILD=${WRKBUILD:Q} PATCHDIR=${PATCHDIR:Q} \
			SCRIPTDIR=${SCRIPTDIR:Q} FILESDIR=${FILESDIR:Q} \
			PORTSDIR=${PORTSDIR:Q} DEPENDS=${DEPENDS:Q} \
			PREFIX=${PREFIX:Q} LOCALBASE=${LOCALBASE:Q} \
			X11BASE=${X11BASE:Q}

.if defined(BATCH)
SCRIPTS_ENV+=		BATCH=yes
.endif

FETCH_MANUALLY?=	No
.if (defined(_CVS_DISTF) && (${MCZ_FETCH:L} == "no")) || \
    (${FETCH_MANUALLY:L} != "no")
_ALLFILES_PRESENT=	Yes
.  for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.    if !exists(${_F})
_ALLFILES_PRESENT=	No
.    endif
.  endfor
.  if ${_ALLFILES_PRESENT:L} == "no"
IS_INTERACTIVE=		Yes
.  endif
.endif

################################################################
# Many ways to disable a port.
#
# If we're in BATCH mode and the port is interactive, or we're
# in interactive mode and the port is non-interactive, skip all
# the important targets.  The reason we have two modes is that
# one might want to leave a build in BATCH mode running
# overnight, then come back in the morning and do _only_ the
# interactive ones that required your intervention.
#
# Ignore ports that can't be resold if building for a CDROM.
#
# Don't build a port if it's broken.
#
# Don't build a port if it comes with the base system.
################################################################

.if defined(WANTLIB) || defined(MAINTAINER)
BROKEN+=		port not converted from OpenBSD to MirPorts
.endif

.if !defined(NO_IGNORE)
.  if (defined(REGRESS_IS_INTERACTIVE) && defined(BATCH))
_IGNORE_REGRESS=	"has interactive tests"
.  endif
.  if (!defined(REGRESS_IS_INTERACTIVE) && defined(INTERACTIVE))
_IGNORE_REGRESS=	"does not have interactive tests"
.  endif
.  if (defined(IS_INTERACTIVE) && defined(BATCH))
IGNORE+=		"is an interactive port"
.  endif
.  if (!defined(IS_INTERACTIVE) && defined(INTERACTIVE))
IGNORE+=		"is not an interactive port"
.  endif
.  if ${USE_X11:L} == "yes"
.    if !exists(${X11BASE})
IGNORE+=		"uses X11, but ${X11BASE} not found"
.    else
LDFLAGS+=		-Wl,--library-after=${X11BASE}/lib
.      if ${OBJECT_FMT} == "ELF"
LDFLAGS+=		-Wl,-rpath -Wl,${X11BASE}/lib
.      endif
.    endif
.  else
CONFIGURE_ENV+=		XMKMF=false
.  endif
.  if ${USE_CXX:L} == "yes" && ${NO_CXX:L} != "no"
IGNORE+=		"uses C++, but ${NO_CXX}"
.  endif
.  if defined(BROKEN)
IGNORE+=		"is marked as broken: ${BROKEN}"
.  endif
.  if defined(ONLY_FOR_PLATFORM)
__OK!=	ok=0; \
	set -o noglob; \
	for match in ${ONLY_FOR_PLATFORM}; do \
		saveIFS=$$IFS; \
		IFS=:; set -A s -- $$match; \
		IFS=$$saveIFS; \
		[[ $${s[0]} = @@(\*|${OStype}) ]] || continue; \
		[[ $${s[2]} = @@(\*|${ARCH}|${MACHINE_ARCH}) ]] || continue; \
		if [[ $${s[1]} = *.* ]]; then \
			saveIFS=$$IFS; \
			IFS=.; set -A sv -- $${s[1]}; \
			IFS=$$saveIFS; \
			(( $${sv[0]} <= ${OSver:R} )) || continue; \
			if (( $${sv[0]} == ${OSver:R} )); then \
				(( $${sv[1]} <= ${OSver:E} )) || continue; \
			fi; \
		else \
			[[ $${s[1]} = @@(\*|${OSREV}) ]] || continue; \
		fi; \
		ok=1; \
		break; \
	done; \
	print $$ok
.    if ${__OK} == "0"
.      if ${ARCH} == ${MACHINE_ARCH}
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSver}:${ARCH}"
.      else
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSver}:${ARCH} (${MACHINE_ARCH})"
.      endif
.    endif
.    undef __OK
.  endif
.  if defined(NOT_FOR_PLATFORM)
__OK!=	ok=1; \
	set -o noglob; \
	test="${OStype}:${OSREV}:${ARCH} ${OStype}:${OSREV}:${MACHINE_ARCH}"; \
	for match in ${NOT_FOR_PLATFORM}; do \
		for platform in $$test; do \
			eval [[ $$platform != $$match ]] || ok=0; \
		done; \
	done; \
	print $$ok
.    if ${__OK} == "0"
IGNORE+=		"is not for ${NOT_FOR_PLATFORM}"
.    endif
.    undef __OK
.  endif
.endif		# NO_IGNORE


.if !defined(DEPENDS_TARGET)
.  if make(reinstall)
DEPENDS_TARGET=		reinstall
.  else
DEPENDS_TARGET=		install
.  endif
.endif

################################################################
# Dependency checking
################################################################

# Various dependency styles

_build_depends_fragment=	! ${PKG_CMD_INFO} -qe "$$pkg" || found=true
_run_depends_fragment=		${_build_depends_fragment}
_regress_depends_fragment=	${_build_depends_fragment}
_fetch_depends_fragment=	${_build_depends_fragment}

_resolve_lib_args=

.if ${NO_SHARED_LIBS:L} == "yes"
_resolve_lib_args:=	${_resolve_lib_args} -noshared
.endif

.if ${RTLD_TYPE} == "dyld"
_resolve_lib_args:=	${_resolve_lib_args} -dylib
.endif

.if ${RTLD_TYPE} == "GNU"
_resolve_lib_args:=	${_resolve_lib_args} -gnulib
.endif

_libresolve_fragment= \
	case "$$d" in \
	*/*)	shprefix="$${d%/*}/"; shdir="${LOCALBASE}/$${d%/*}"; \
		d=$${d\#\#*/};; \
	*)	shprefix=; shdir="${LOCALBASE}/lib";; \
	esac; \
	check=$$(eval $$listlibs | ${MKSH} \
	    ${PORTSDIR}/infrastructure/scripts/resolve-lib \
	    ${_resolve_lib_args} $$d) || true

_lib_depends_fragment= \
	what=$$dep; \
	whattype=' library'; \
	IFS=,; bad=false; for d in $$dep; do \
		listlibs='ls /usr/lib $$shdir 2>/dev/null'; \
		${_libresolve_fragment}; \
		case "$$check" in \
		Missing\ library) bad=true; msg="$$msg $$d missing...";; \
		Error:*) bad=true; msg="$$msg $$d unsolvable...";; \
		esac; \
	done; $$bad || ${_build_depends_fragment}

_FULL_PACKAGE_NAME?=	No

BUILD_DEPENDS+=		${B_R_DEPENDS}
RUN_DEPENDS+=		${B_R_DEPENDS}
.for _DEP in build run lib regress fetch
_DEP${_DEP}_COOKIES=
.  if defined(${_DEP:U}_DEPENDS) && !empty(${_DEP:U}_DEPENDS) && \
    ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
_DEP${_DEP}_COOKIES+=	${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}
.    endfor
.  endif
.endfor

# Normal user-mode targets are PHONY targets, e.g., don't create the
# corresponding file. However, there is nothing phony about the cookie.

_INSTALL_DEPS=		${_INSTALL_COOKIE}
_PACKAGE_DEPS=		${_PACKAGE_COOKIES}
.if defined(ALWAYS_PACKAGE)
_INSTALL_DEPS+=		${_PACKAGE_COOKIES}
.endif
.if ${BULK_${PKGPATH}:L} == "yes"
_INSTALL_DEPS+=		${_BULK_COOKIE}
_PACKAGE_DEPS+=		${_BULK_COOKIE}
.endif
_UPGRADE_DEPS=
_UPGRADE_PKGS=

PREFER_SUBPKG_INSTALL?=	yes
.if empty(SUBPACKAGE) && defined(MULTI_PACKAGES) \
    && !empty(MULTI_PACKAGES) && (${PREFER_SUBPKG_INSTALL:L} == "yes")
.  for _i in ${MULTI_PACKAGES}
_INSTALL_DEPS+=		${PKG_DBDIR}/${FULLPKGNAME${_i}}/+CONTENTS
_UPGRADE_DEPS+=		_upgrade-${_i}
_UPGRADE_PKGS+=		${PKGFILE${_i}}

${PKG_DBDIR}/${FULLPKGNAME${_i}}/+CONTENTS: ${PKG_DBDIR}/${FULLPKGNAME}/+CONTENTS
	@@env SUBPACKAGE=${_i:Q} ${MAKE} install-binpkg

_upgrade-${_i}:
	@@env SUBPACKAGE=${_i:Q} ${MAKE} _upgrade
.  endfor
.endif

.if ${CONFIGURE_STYLE:L:Mbmake}
MAKE_ENV+=		CPPFLAGS=${CPPFLAGS:Q}
.endif

MODBMAKE_configure=	cd ${WRKBUILD} && \
			    exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
			    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE:Q} obj

MODBMAKE_pre_build=	cd ${WRKBUILD} && \
			    exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
			    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE:Q} depend

MODSIMPLE_configure=	cd ${WRKCONF} && \
			    ${_SYSTRACE_CMD} ${SETENV} \
			    ${MODSIMPLE_configure_env} \
			    ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}

MODSIMPLE_USE_INSTALL?=	${INSTALL} -c -o ${BINOWN} -g ${BINGRP}
MODSIMPLE_configure_env=REALOS=${OStype:Q} MKSH=${MKSH:Q} \
			ac_cv_path_CC=${_PASS_CC:T:Q} ac_cv_path_CXX=${_PASS_CXX:T:Q} \
			CC=${_PASS_CC:T:Q} CFLAGS="$$(print -nr -- ${CFLAGS:Q} | \
			    sed -e 's${CPPFLAGS:S\\\\\\g}g' \
			    -e 's/[ 	]*$$//')" \
			CXX=${_PASS_CXX:T:Q} CXXFLAGS="$$(print -nr -- ${CXXFLAGS:Q} | \
			    sed -e 's${CPPFLAGS:S\\\\\\g}g' \
			    -e 's/[ 	]*$$//')" \
			LD=${LD:Q} LDFLAGS=${LDFLAGS:Q} CPPFLAGS=${CPPFLAGS:Q} \
			INSTALL=${MODSIMPLE_given_INSTALL:Q} \
			ac_given_INSTALL=${MODSIMPLE_given_INSTALL:Q} \
			INSTALL_SCRIPT=${INSTALL_SCRIPT:Q} \
			INSTALL_PROGRAM=${INSTALL_PROGRAM:Q} YACC=${YACC:Q} \
			INSTALL_MAN=${INSTALL_MAN:Q} GCC_NO_WERROR=1 \
			INSTALL_DATA=${INSTALL_DATA:Q} ${CONFIGURE_ENV}

_FAKE_SETUP=		TRUEPREFIX=${PREFIX:Q} PREFIX=${WRKINST:Q}${PREFIX:Q} \
			${DESTDIRNAME}=${WRKINST:Q}

VMEM_WARNING?=		No
VMEM_AUTOUNLOCK?=	No
_CLEANDEPENDS?=		Yes

_VMEM_UNLOCK:=
.if (${VMEM_AUTOUNLOCK:L} == "yes") && (${VMEM_WARNING:L} == "yes")
_VMEM_UNLOCK+=		${_VMEM_UNLOCK_CMDS}
.endif

# mirroring utilities
.if !empty(DIST_SUBDIR)
_ALLFILES=		${ALLFILES:S/^/${DIST_SUBDIR}\//}
.else
_ALLFILES=		${ALLFILES}
.endif

_FMN=			${PKGPATH}/${FULLPKGNAME}
.if defined(MULTI_PACKAGES)
.  for _S in ${MULTI_PACKAGES}
_FMN+=			${PKGPATH}/${FULLPKGNAME${_S}}
.  endfor
.endif

# Internal variables, used by dependencies targets
# Only keep pkg:dir spec
.if defined(LIB_DEPENDS) && !empty(LIB_DEPENDS) && ${NO_SHARED_LIBS:L} != "yes"
_ALWAYS_DEP2=		${LIB_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_ALWAYS_DEP=		${_ALWAYS_DEP2:C/[^:]*://}
.else
_ALWAYS_DEP2=
_ALWAYS_DEP=
.endif

.if defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)
_RUN_DEP2=		${RUN_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_RUN_DEP=		${_RUN_DEP2:C/[^:]*://}
.else
_RUN_DEP2=
_RUN_DEP=
.endif

.if defined(BUILD_DEPENDS) && !empty(BUILD_DEPENDS)
_BUILD_DEP2=		${BUILD_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_BUILD_DEP=		${_BUILD_DEP2:C/[^:]*://}
.else
_BUILD_DEP2=
_BUILD_DEP=
.endif

.if defined(FETCH_DEPENDS) && !empty(FETCH_DEPENDS)
_FETCH_DEP2=		${FETCH_DEPENDS:C/^[^:]*:([^:]*:[^:]*).*$/\1/}
_FETCH_DEP=		${_FETCH_DEP2:C/[^:]*://}
.else
_FETCH_DEP2=
_FETCH_DEP=
.endif

_LIB_DEP2=		${LIB_DEPENDS}
README_NAME?=		${TEMPLATES}/README.port

REORDER_DEPENDENCIES?=

.if defined(_STAT_SIZE)
_size_fragment=		stat -f 'SIZE (%N) = %z' $$file || echo -1
.elif ${HAS_CKSUM:L} == "yes"
_size_fragment=		${CKSUM_CMD} -a size $$file || echo -1
.else
_size_fragment=		print "SIZE ($$file) =" $$(wc -c <"$$file" || echo -1)
.endif

###
### end of variable setup. Only targets now
###

${LOCALBASE}/db/fake.mtree: ${PORTSDIR}/infrastructure/templates/fake.mtree
	${SUDO} cp $> $@@
	if [[ ${BINOWN} != root ]]; then \
		print 'g/[ug]name=[a-z]*/s///g\n'"/^.set/s/   /" \
		    "uname=@@BINOWN@@ gname=@@BINGRP@@ /\nwq" \
		    | ${SUDO} ed -s $@@; \
	fi

.if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.else
${_PACKAGE_COOKIE}: ${_PACKAGE_COOKIE_DEPS}
.endif
	@@cd ${.CURDIR} && SUBPACKAGE= FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING= exec ${MAKE} _package
.if !defined(PACKAGE_NOINSTALL)
	@@${_MAKE_COOKIE} $@@
.endif

.for _s in ${MULTI_PACKAGES}
.  if ${BIN_PACKAGES:L} == "yes"
${_PACKAGE_COOKIE${_s}}:
	@@cd ${.CURDIR} && exec ${MAKE} ${_PACKAGE_COOKIE_DEPS}
.  else
${_PACKAGE_COOKIE${_s}}: ${_PACKAGE_COOKIE_DEPS}
.  endif
	@@cd ${.CURDIR} && SUBPACKAGE=${_s:Q} FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING=${_s:Q} exec ${MAKE} _package
.endfor

.PRECIOUS: ${_PACKAGE_COOKIES} ${_INSTALL_COOKIE}

${_SYSTRACE_COOKIE}:
	@@rm -f $@@
.for _i in ${_SYSTRACE_POLICIES}
	@@echo "Policy: ${_i}, Emulation: native" >>$@@
	@@if [ -f ${.CURDIR}/systrace.filter ]; then \
		cat ${.CURDIR}/systrace.filter >>$@@; \
	fi
	@@sed ${_SYSTRACE_SED_SUBST} ${SYSTRACE_FILTER} >>$@@
.  if ${USE_CCACHE:L} == "yes"
	@@for cmd in chmod chown fswrite lchown link mknod rename symlink; do \
		print '\tnative-'$$cmd: filename match \
		    \"${CCACHE_DIR:Q}\" then permit; \
	done >>$@@
.  endif
.endfor
	@@if [ -f ${.CURDIR}/systrace.policy ]; then \
		sed ${_SYSTRACE_SED_SUBST} ${.CURDIR}/systrace.policy >>$@@; \
	fi

# create the packing stuff from source
${WRKPKG}/COMMENT${SUBPACKAGE}:
	@@echo ${_COMMENT:Q} >$@@

${WRKPKG}/PLIST${SUBPACKAGE}: ${PLIST} ${WRKPKG}/depends${SUBPACKAGE}
	echo "@@comment subdir=${FULLPKGPATH}" \
	    "cdrom=${PERMIT_PACKAGE_CDROM:L:S/"/\"/g}" \
	    "ftp=${PERMIT_PACKAGE_FTP:L:S/"/\"/g}" \
	    >$@@.tmp
.if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	echo "@@comment @@tag permit cdrom" >>$@@.tmp
.endif
.if ${PERMIT_PACKAGE_FTP:L} == "yes"
	echo "@@comment @@tag permit ftp" >>$@@.tmp
.endif
	echo "@@comment @@tag cc ${USE_COMPILER:L}" >>$@@.tmp
.if ${NO_CXX:L} == "no"
	echo "@@comment @@tag dep cxx yes" >>$@@.tmp
.endif
.if ${USE_X11:L} == "yes"
	echo "@@comment @@tag dep x11" >>$@@.tmp
.endif
	echo "@@comment" \
	    "portdir=http://cvs.mirbsd.de/ports/${PKGPATH}/" \
	    >>$@@.tmp
	sort -u <${WRKPKG}/depends${SUBPACKAGE} >>$@@.tmp
.if ${NO_SHARED_LIBS:L} == "yes"
	sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
	    -e '//d' \
	    -e '/^%%!SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
	    -e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} ${SED_PLIST} >>$@@.tmp
.elif ${OBJECT_FMT} == "Mach-O"
	if [ -e ${PKGDIR}/PFRAG.dylib${SUBPACKAGE} ]; then \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.dylib${SUBPACKAGE}' \
		    -e '//d' <${PLIST} ${SED_PLIST} \
		    >>$@@.tmp; \
	else \
		echo '@@option dylib' >>$@@.tmp; \
		sed -e '/^!%%SHARED%%$$/d' \
		    -e '/^%%!SHARED%%$$/d' \
		    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
		    -e '//d' <${PLIST} ${SED_PLIST} \
		    >>$@@.tmp; \
	fi
.elif ${OStype} == "Interix"
	echo '@@option gnu-ld' >>$@@.tmp; \
	sed -e '/^!%%SHARED%%$$/d' -e '/^%%!SHARED%%$$/d' \
	    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
	    -e '//d' <${PLIST} ${SED_PLIST} >>$@@.tmp
.else
	echo '@@option ldcache' >>$@@.tmp; \
	sed -e '/^!%%SHARED%%$$/d' -e '/^%%!SHARED%%$$/d' \
	    -e '/^%%SHARED%%$$/r${PKGDIR}/PFRAG.shared${SUBPACKAGE}' \
	    -e '//d' <${PLIST} ${SED_PLIST} >>$@@.tmp
.endif
	mv $@@.tmp $@@

${WRKPKG}/depends${SUBPACKAGE}:
	@@mkdir -p ${WRKPKG}
	@@>$@@
.if (defined(RUN_DEPENDS) && !empty(RUN_DEPENDS)) || \
    (${NO_SHARED_LIBS:L} != "yes" && \
     defined(LIB_DEPENDS) && !empty(LIB_DEPENDS))
	@@${_depfile_fragment}; \
	    echo "|${FULLPKGNAME${SUBPACKAGE}}|" >>$${_DEPENDS_FILE}; \
	    self=${FULLPKGNAME${SUBPACKAGE}} _depends_result=$@@ \
	    ${MAKE} _recurse-solve-package-depends
.endif

${WRKPKG}/DESCR${SUBPACKAGE}: ${DESCR}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
	@@echo "\nMaintainer: ${RESPONSIBLE}" >>$@@
.if defined(HOMEPAGE)
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: "${HOMEPAGE:Q} >>$@@
.endif
.if !empty(FLAVOURS)
	@@echo "\nFlavours available:" ${FLAVOURS} >>$@@
.endif

${WRKPKG}/mtree.spec: ${MTREE_FILE}
	@@${_SED_SUBST} ${MTREE_FILE} >$@@.tmp
	@@(print '/@@@@local/d\ni\n'; IFS=/; s=; \
	 for pc in $$(print ${LOCALBASE:Q}); do \
		s="$$s    "; print "$$s$$pc"; \
	 done; \
	 print .; \
	 print '%g/@@BINOWN@@/s//${BINOWN}/g'; \
	 print '%g/@@BINGRP@@/s//${BINGRP}/g'; \
	 print wq) | ed -s $@@.tmp
	@@mv -f $@@.tmp $@@

# substitute
.for _subst_file in INSTALL DEINSTALL REQ
.  if exists(${PKGDIR}/${_subst_file}${SUBPACKAGE})
${WRKPKG}/${_subst_file}${SUBPACKAGE}: ${PKGDIR}/${_subst_file}${SUBPACKAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.  endif
.endfor

.if defined(MESSAGE)
${WRKPKG}/MESSAGE${SUBPACKAGE}: ${MESSAGE}
	@@${_SED_SUBST} <$? >$@@.tmp && mv -f $@@.tmp $@@
.endif

makesum: fetch-all
.if !defined(NO_CHECKSUM)
	@@rm -f ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && ${CKSUM_CMD} ${_CIPHERS:S/^/-a /} -a size \
	    ${_CKSUMFILES} >>${CHECKSUM_FILE}
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@print '1i\n$$Mir''OS$$\n\n.\nwq' | ed -s ${CHECKSUM_FILE}
.endif

addsum: fetch-all
.if !defined(NO_CHECKSUM)
	@@touch ${CHECKSUM_FILE}
	@@cd ${DISTDIR} && ${CKSUM_CMD} ${_CIPHERS:S/^/-a /} -a size \
	    ${_CKSUMFILES} >>${CHECKSUM_FILE}
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
	@@sort -u -o ${CHECKSUM_FILE} ${CHECKSUM_FILE}
	@@if [ $$(sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d | \
	    wc -l) -ne 0 ]; then \
		echo "Inconsistent checksum in ${CHECKSUM_FILE}"; \
		exit 1; \
	else \
		${ECHO_MSG} "${CHECKSUM_FILE} updated okay," \
		    "don't forget to remove cruft"; \
	fi
.endif


################################################################
# Dependency checking
################################################################

depends: lib-depends build-depends run-depends regress-depends

# and the rules for the actual dependencies

_print-packagename:
.if ${_FULL_PACKAGE_NAME:L} == "yes"
	@@echo ${PKGPATH:Q}/${FULLPKGNAME${SUBPACKAGE}:Q}
.else
	@@echo ${FULLPKGNAME${SUBPACKAGE}}
.endif

.for _DEP in build run lib regress fetch
.  if defined(${_DEP:U}_DEPENDS) && !empty(${_DEP:U}_DEPENDS) && \
    ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
${WRKDIR}/.${_DEP}${_i:C,[|:./<=>*],-,g}: ${_WRKDIR_COOKIE}
	@@unset PACKAGING DEPENDS_TARGET FLAVOUR SUBPACKAGE \
	    _MASTER WRKDIR|| true; \
	echo ${_i:Q}|{ \
		IFS=:; read dep pkg dir target; \
		${_flavour_fragment}; defaulted=false; \
		case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
		case "X$$target" in \
		Xinstall|Xreinstall) early_exit=false;; \
		Xpackage) early_exit=true;; \
		*) \
			early_exit=true; mkdir -p ${WRKDIR}/$$dir; \
			toset="$$toset \
			    _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' \
			    WRKDIR=${WRKDIR}/$$dir"; \
			dep="/nonexistent";; \
		esac; \
		case "X$$pkg" in \
		X)	pkg=$$(eval $$toset ${MAKE} _print-packagename | sed -e 's,-[0-9].*,-*,'); \
			defaulted=true;; \
		esac; \
		for abort in false false true; do \
			if $$abort; then \
				${ECHO_MSG} "Dependency check failed"; \
				exit 1; \
			fi; \
			found=false; \
			what=$$pkg; \
			whattype=; \
			case "$$dep" in \
			"/nonexistent") ;; \
			*)  \
				${_${_DEP}_depends_fragment}; \
				if $$found; then \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what$$whattype - found"; \
					break; \
				else \
					: $${msg:= not found}; \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what$$whattype -$$msg"; \
				fi;; \
			esac; \
			if [[ -z $$dir ]]; then \
				${ECHO_MSG} "===>  Please install $$what manually."; \
				${ECHO_MSG} "      There is no MirPort available for this dependency."; \
				exit 1; \
			fi; \
			${ECHO_MSG} "===>  Verifying $$target for $$what in $$dir"; \
			[[ $$target = *patch* ]] && \
			    target="__AUTOPORT_RECURSIVE=1 $$target"; \
			if eval $$toset ${MAKE} $$target; then \
				${ECHO_MSG} "===> Returning to build of ${FULLPKGNAME${SUBPACKAGE}}${_MASTER}"; \
			else \
				exit 1; \
			fi; \
			if $$early_exit; then \
				break; \
			fi; \
		done; \
	}
	@@${_MAKE_COOKIE} $@@
.    endfor
.  endif
${_DEP}-depends: ${_DEP${_DEP}_COOKIES}

whatif-${_DEP}-depends: .PHONY
.  if defined(${_DEP:U}_DEPENDS) && !empty(${_DEP:U}_DEPENDS) && \
    ${NO_DEPENDS:L} == "no"
.    for _i in ${${_DEP:U}_DEPENDS}
	@@unset PACKAGING DEPENDS_TARGET FLAVOUR SUBPACKAGE \
	    _MASTER WRKDIR|| true; \
	echo ${_i:Q}|{ \
		IFS=:; read dep pkg dir target; \
		${_flavour_fragment}; defaulted=false; \
		case "X$$target" in X) target=${DEPENDS_TARGET};; esac; \
		case "X$$target" in \
		Xinstall|Xreinstall) early_exit=false;; \
		Xpackage) early_exit=true;; \
		*) \
			early_exit=true; mkdir -p ${WRKDIR}/$$dir; \
			toset="$$toset \
			    _MASTER='[${FULLPKGNAME${SUBPACKAGE}}]${_MASTER}' \
			    WRKDIR=${WRKDIR}/$$dir"; \
			dep="/nonexistent";; \
		esac; \
		case "X$$pkg" in \
		X)	pkg=$$(eval $$toset ${MAKE} _print-packagename | sed -e 's,-[0-9].*,-*,'); \
			defaulted=true;; \
		esac; \
		for abort in x; do \
			found=false; \
			what=$$pkg; \
			whattype=; \
			case "$$dep" in \
			"/nonexistent") ;; \
			*)  \
				${_${_DEP}_depends_fragment}; \
				if $$found; then \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what$$whattype - found"; \
					break; \
				else \
					: $${msg:= not found}; \
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what$$whattype -$$msg"; \
				fi;; \
			esac; \
			if [[ -z $$dir ]]; then \
				${ECHO_MSG} "===>  Please install $$what manually."; \
				${ECHO_MSG} "      There is no MirPort available for this dependency."; \
				exit 1; \
			fi; \
			${ECHO_MSG} "===>  Verifying $$target for $$what in $$dir"; \
			eval $$toset ${MAKE} whatif-depends; \
		done; \
	}
.    endfor
.  endif
.endfor

whatif-depends: .PHONY whatif-fetch-depends whatif-build-depends \
    whatif-lib-depends whatif-run-depends #whatif-regress-depends

# Do a brute-force ldd/objdump on all files under WRKINST.
_CHECK_LIBS_SCRIPT=	${PORTSDIR}/infrastructure/scripts/check-libs-elf
${_LIBLIST}: ${_FAKE_COOKIE}
	@@cd ${WRKINST} && ${SUDO} find . -type f|\
		${SUDO} xargs objdump -p 2>/dev/null |\
		sed -n \
		    -e '/^ *NEEDED *\(.*\)\.so\.\([0-9][0-9]*\)\.\([0-9][0-9]*\)$$/s//\1 \2 \3/p' \
		    -e '/^ *NEEDED *\(.*\)\.so$$/s//\1/p' \
		| sort -u >$@@

# list of libraries that can be used: libraries just built, and system libs.
${_BUILDLIBLIST}: ${_FAKE_COOKIE}
	@@{ \
		${SUDO} find ${WRKINST} -type f -o -type l; \
		find /usr/lib -path /usr/lib -o -type d -prune \
		    -o -type f -print; \
		find ${X11BASE}/lib -path ${X11BASE}/lib -o -type d -prune \
		    -o -type f -print; \
	} | \
		egrep '(\.so\.|\.so$$)' | ${SUDO} xargs file -L \
		    | fgrep 'shared' | cut -d\: -f1 | sort -u >$@@


.for _i in ${EMUL}
.  ifndef HAS_EMUL_${_i}
HAS_EMUL_${_i}!=sysctl -n kern.emul.${_i} 2>/dev/null
.    if ${__MAKEFLAGS_HACKERY:L} == "yes"
.MAKEFLAGS:=	${.MAKEFLAGS} HAS_EMUL_${_i}=${HAS_EMUL_${_i}:Q}
.    endif
.  endif
.  if ${HAS_EMUL_${_i}} != "1"
IGNORE+=	"needs ${_i} emulation, which is turned off, see compat_${_i}(8)"
.  endif
.endfor


.if defined(IGNORE) && !defined(NO_IGNORE)
fetch checksum extract patch configure all build install regress \
    uninstall deinstall fake package lib-depends-check manpages-check \
    relevant-checks whatif-depends:
.  if !defined(IGNORE_SILENT)
.    for _i in ${IGNORE}
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} "${_i}.
.    endfor
.  endif

.else
# For now, just check all libnames are present
# The check is done on the fake area, be wary of multi-packages situation,
# since we don't take it into account yet.
#
# Note that we cache needed library names, and libraries we're allowed to
# depend upon, but not the actual list of lib depends, since this list is
# going to be tweaked as a result of running lib-depends-check.
#
lib-depends-check: ${_LIBLIST} ${_BUILDLIBLIST}
	@@${_depfile_fragment}; \
	LIB_DEPENDS="$$(${MAKE} _recurse-lib-depends-check)" \
	PKG_DBDIR=${PKG_DBDIR:Q} perl ${_CHECK_LIBS_SCRIPT} \
	    ${_LIBLIST} ${_BUILDLIBLIST}

manpages-check: ${_FAKE_COOKIE}
	@@cd ${WRKINST}${TRUEPREFIX}/man && \
	    ${SUDO} /usr/libexec/makewhatis -p . && cat whatis.db

# Most standard port targets create a cookie to avoid being re-run.
#
# fetch is an exception, as it uses the files it fetches as 'cookies',
# and it's run by checksum, so in essence it's a sub-goal of extract,
# in normal use.
#
# Besides, fetch can't create cookies, as it does not have WRKDIR available
# in the first place.
#
# IMPORTANT: pre-fetch/do-fetch/post-fetch MUST be designed so that they
# can be run several times in a row.

.ifdef NO_DISTFILES
DISTFILES=
.endif

fetch:
.  ifndef NO_DISTFILES
	@@${ECHO_MSG} "===>  Checking files for ${FULLPKGNAME}${_MASTER}"
.    if target(pre-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} pre-fetch
.    endif
.    if target(do-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} do-fetch
.    else
# What FETCH normally does:
.      if !empty(ALLFILES)
	@@cd ${.CURDIR} && exec ${MAKE} ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.      endif
# End of FETCH
.    endif
.    if target(post-fetch)
	@@cd ${.CURDIR} && exec ${MAKE} post-fetch
.    endif
.  endif


checksum: fetch
	@@-cd ${DISTDIR} && rm -f ${_CKSUMFILES:S!^!{CDROM,FTP}/!} 2>/dev/null
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES)
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ ! -f $$checksum_file ]; then \
		${ECHO_MSG} ">> No checksum file."; \
	else \
		if [[ ! -e ${WRKDIR}/.sums ]]; then \
			mkdir -p ${WRKDIR}; \
			(cd ${DISTDIR}; \
			if [[ ${HAS_CKSUM:L} == no ]]; then \
				${CKSUM_CMD} ${_CKSUMFILES}; \
			elif [[ ${HAS_CKSUM:L} == @@(old|md) ]]; then \
				cksum ${_CKSUMFILES}; \
				md5 ${_CKSUMFILES}; \
				[[ ${HAS_CKSUM:L} == md ]] || \
				    rmd160 ${_CKSUMFILES}; \
			else \
				${CKSUM_CMD} \
				    ${_CIPHERS:S/^/-a /} ${_CKSUMFILES}; \
			fi) >${WRKDIR}/.sums; \
		fi; \
		cd ${DISTDIR}; OK=true; list=; \
		case ${HAS_CKSUM:L} { \
		(md)	allciphers="cksum md5" ;; \
		(no)	allciphers="cksum" ;; \
		(old)	allciphers="cksum md5 rmd160" ;; \
		(yes)	allciphers="${_CIPHERS}" ;; \
		}; \
		for file in ${_CKSUMFILES}; do \
			match=; \
			for cipher in $$allciphers; do \
				if [[ $$cipher = cksum ]]; then \
					s=$$(grep "$$file\$$" \
					    $$checksum_file || true); \
					if [[ -z $$s ]]; then \
						${ECHO_MSG} ">> No cksum recorded for $$file."; \
						continue; \
					fi; \
					t=$$(grep "$$file\$$" \
					    ${WRKDIR}/.sums || true); \
					if [[ $$s = $$t ]]; then \
						match=1; \
						${ECHO_MSG} ">> cksum OK for $$file."; \
					else \
						echo ">> cksum mismatch for $$file."; \
						OK=false; \
					fi; \
					continue; \
				fi; \
				set -- $$(grep -i "^$$cipher ($$file)" \
				    $$checksum_file); \
				if (( !$$# )); then \
					${ECHO_MSG} ">> No $$cipher checksum recorded for $$file."; \
					continue; \
				fi; \
				case $$4 in \
				"") \
					${ECHO_MSG} ">> No checksum recorded for $$file."; \
					OK=false;; \
				IGNORE) \
					echo ">> Checksum for $$file is set to IGNORE in md5 file even though"; \
					echo "   the file is not in the "'$$'"{IGNOREFILES} list."; \
					OK=false;; \
				*) \
					CKSUM=$$(grep -i "^$$cipher ($$file)" \
					    ${WRKDIR}/.sums | sed 's/^.*= //'); \
					case $$CKSUM in \
				  	"$$4") \
						match=1; \
						${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)";; \
					*) \
						echo ">> Checksum mismatch for $$file. ($$cipher)"; \
						if [[ -n $$_CKSUM_DEBUG ]]; then \
							echo "<< HAVE '$$CKSUM'"; \
							echo "<< WANT '$$4'"; \
						fi; \
						list="$$list $$file $$cipher $$4"; \
						OK=false;; \
					esac;; \
				esac; \
			done; \
			[[ $$match = 1 ]] || OK=false; \
		done; \
		set --; \
		for file in ${_IGNOREFILES}; do \
		  set -- $$(grep "($$file)" $$checksum_file) || \
			  { echo ">> No checksum recorded for $$file, file is in "'$$'"{IGNOREFILES} list." && \
			  OK=false; } ; \
		  case $$4 in \
		  	IGNORE) : ;; \
			*) \
			  echo ">> Checksum for $$file is not set to IGNORE in md5 file even though"; \
			  echo "   the file is in the "'$$'"{IGNOREFILES} list."; \
			  OK=false;; \
		  esac; \
		done; \
		if ! $$OK; then \
		  rm -f ${WRKDIR}/.sums; \
		  if ${REFETCH}; then \
		  	cd ${.CURDIR} && ${MAKE} _refetch _PROBLEMS="$$list"; \
		  else \
			echo "Make sure the Makefile and checksum file ($$checksum_file)"; \
			echo "are up to date.  If you want to fetch a good copy of this"; \
			echo "file from the OpenBSD or MirOS main archive, type"; \
			echo "\"mmake REFETCH=true [other args]\"."; \
			exit 1; \
		  fi; \
		fi ; \
  fi
.  endif
.  if (${PERMIT_DISTFILES_FTP:L} == "yes") && !empty(_CKSUMFILES)
	@@cd ${DISTDIR}; all=; for i in ${_CKSUMFILES:H}; do \
		[[ " $$all " = *" $$i "* ]] || all="$$all $$i"; \
	done; \
	mkdir -p CDROM FTP; \
	(cd CDROM; mkdir -p $$all); \
	(cd FTP; mkdir -p $$all); \
	for i in $$all; do \
		if [[ ! -w $$i || ! -w CDROM/$$i || ! -w FTP/$$i ]]; then \
			print -u2 'Warning: some subdirectory of ${DISTDIR}' \
			    'is not writable for you!'; \
			break; \
		fi; \
	done
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
.      for _i in ${_CKSUMFILES}
	@@[[ -e ${DISTDIR}/CDROM/${_i} ]] || \
	    [[ ! -e ${DISTDIR}/${_i} ]] || \
	    ln ${DISTDIR}/${_i} ${DISTDIR}/CDROM/${_i} 2>&- || \
	    ln -s ${DISTDIR}/${_i} ${DISTDIR}/CDROM/${_i}
.      endfor
.    endif
.    for _i in ${_CKSUMFILES}
	@@[[ -e ${DISTDIR}/FTP/${_i} ]] || \
	    [[ ! -e ${DISTDIR}/${_i} ]] || \
	    ln ${DISTDIR}/${_i} ${DISTDIR}/FTP/${_i} 2>&- || \
	    ln -s ${DISTDIR}/${_i} ${DISTDIR}/FTP/${_i}
.    endfor
.  endif

_refetch:
.  ifndef NO_DISTFILES
.    for file cipher value in ${_PROBLEMS}
	@@rm ${DISTDIR}/${file}
	@@cd ${.CURDIR} && exec ${MAKE} ${DISTDIR}/${file} \
	    MASTER_SITE_OVERRIDE="ftp://ftp.openbsd.org/pub/OpenBSD/distfiles/${cipher}/${value}/"
.    endfor
	cd ${.CURDIR} && exec ${MAKE} checksum REFETCH=false
.  endif


# The cookie's recipe hold the real rule for each of those targets.

extract: ${_EXTRACT_COOKIE}
patch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_PATCH_COOKIE}
distpatch: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_DISTPATCH_COOKIE}
configure: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_CONFIGURE_COOKIE}
all build: ${_DEPbuild_COOKIES} ${_DEPlib_COOKIES} \
	${_BUILD_COOKIE}
install: ${_INSTALL_DEPS}
fake: ${_FAKE_COOKIE}
package: ${_PACKAGE_DEPS}

unconfigure:
	rm -f ${_CONFIGURE_COOKIE}

.  if defined(_IGNORE_REGRESS)
regress:
.    if !defined(IGNORE_SILENT)
	@@${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} ${_IGNORE_REGRESS}."
.    endif
.  else
regress: ${_DEPregress_COOKIES} ${_REGRESS_COOKIE}
.  endif

.endif # IGNORECMD

${_BULK_COOKIE}: ${_PACKAGE_COOKIES}
	@@mkdir -p ${BULK_COOKIES_DIR}
.for _i in ${BULK_TARGETS_${PKGPATH}}
	@@${ECHO_MSG} "===> Running ${_i}"
	@@cd ${.CURDIR} && exec ${MAKE} ${_i} ${BULK_FLAGS}
.endfor
	@@cd ${.CURDIR} && exec ${SUDO} ${MAKE} clean
	@@${_MAKE_COOKIE} $@@

# The real targets. Note that some parts always get run, some parts can be
# disabled, and there are hooks to override behavior.

.if (${MACHINE_OS} == "Darwin") || (${OStype} == "MidnightBSD")
${_WRKDIR_COOKIE}: ${LOCALBASE}/db/specs.${_ORIG_CC:S!/!_!g}
.else
${_WRKDIR_COOKIE}:
.endif
	@@rm -rf ${WRKDIR}
	@@mkdir -p ${WRKDIR} ${WRKDIR}/bin
	@@ln -s ${_MIRMAKE_EXE} ${WRKDIR}/bin/make
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CC:Q} ${_USE_CCSTD} '"$$@@"' >${WRKDIR}/bin/${_MPWRAP_CC}
.if ${NO_CXX:L} != "no"
	@@print '#!'${MKSH:Q}'\nexit 1' >${WRKDIR:Q}/bin/${_MPWRAP_CXX}
.else
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CXX:Q} ${_USE_CXXSTD} '"$$@@"' >${WRKDIR}/bin/${_MPWRAP_CXX}
.endif
	@@chmod ${BINMODE} ${WRKDIR}/bin/{${_MPWRAP_CC},${_MPWRAP_CXX}}
	@@${_MAKE_COOKIE} $@@

${_EXTRACT_COOKIE}: ${_WRKDIR_COOKIE} ${_SYSTRACE_COOKIE}
.if ${DIST_SOURCE:L} == "distfile"
	@@cd ${.CURDIR} && exec ${MAKE} NOSUPDISTFILES=1 \
	    checksum build-depends lib-depends
	@@${ECHO_MSG} "===>  Extracting for ${FULLPKGNAME}${_MASTER}"
.  if target(pre-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-extract
.  endif
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
.else
	@@cd ${.CURDIR} && exec ${MAKE} build-depends lib-depends
	@@${ECHO_MSG} "===>  Copying source for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${WRKSRC}
	cd ${WRKSRC} && lndir ${DIST_SOURCEDIR}
.endif
	@@-cd ${WRKDIST} && chmod -R u+w .
.if target(post-extract)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-extract
.endif
	@@${_MAKE_COOKIE} $@@

.if !target(do-extract)
do-extract:
# What EXTRACT normally does:
	@@PATH=${PORTPATH}; set -e; cd ${WRKDIR}; \
	for archive in ${EXTRACT_ONLY}; do \
		case $$archive in \
		${EXTRACT_CASES} \
		esac; \
	done
# End of EXTRACT
.endif


# Both distpatch and patch invoke pre-patch, if it's defined.
# Hence it needs special treatment (a specific cookie).
.if target(pre-patch)
${_PREPATCH_COOKIE}:
	@@cd ${.CURDIR} && exec ${MAKE} pre-patch
.  if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.  endif
.endif



# The real distpatch

${_DISTPATCH_COOKIE}: ${_EXTRACT_COOKIE}
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} do-distpatch
.else
# What DISTPATCH normally does
.  if defined(_PATCHFILES)
	@@${ECHO_MSG} "===>  Applying distribution patches for ${FULLPKGNAME}${_MASTER}"
	@@cd ${FULLDISTDIR}; \
	  for patchfile in ${_PATCHFILES}; do \
	  	case ${PATCH_DEBUG:L:Q} in \
		no)	;; \
		*)	${ECHO_MSG} "===>   Applying distribution patch $$patchfile" ;; \
		esac; \
		case $$patchfile in \
			${PATCH_CASES} \
		esac; \
	  done
.  endif
# End of DISTPATCH.
.endif
.if target(post-distpatch)
	@@cd ${.CURDIR} && exec ${MAKE} post-distpatch
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif

# The real patch

${_PATCH_COOKIE}: ${_EXTRACT_COOKIE}
	@@${ECHO_MSG} "===>  Patching for ${FULLPKGNAME}${_MASTER}"
.if target(pre-patch)
	@@cd ${.CURDIR} && exec ${MAKE} ${_PREPATCH_COOKIE}
.endif
.if target(do-patch)
	@@cd ${.CURDIR} && exec ${MAKE} do-patch
.else
# What PATCH normally does:
# XXX test for efficiency, don't bother with distpatch if it's not needed
.  if target(do-distpatch) || target(post-distpatch) || defined(PATCHFILES)
	@@cd ${.CURDIR} && exec ${MAKE} distpatch
.  endif
	@@if cd ${PATCHDIR} 2>/dev/null || [ x"${PATCH_LIST:M/*}" != x"" ]; then \
		error=false; \
		for i in ${PATCH_LIST}; do \
			case $$i in \
			*.orig|*.rej|*~) \
				${ECHO_MSG} "===>   Ignoring patchfile $$i" ; \
				;; \
			*) \
			    if [ -e $$i ]; then \
					case ${PATCH_DEBUG:L:Q} in \
					no)	;; \
					*)	${ECHO_MSG} "===>   Applying ${OPSYS} patch $$i" ;; \
					esac; \
					${PATCH} ${PATCH_ARGS} <$$i || \
						{ echo "***>   $$i did not apply cleanly"; \
						error=true; }\
				else \
					if [ $$i != "patch-*" ]; then \
						echo "===>   Can't find patch matching $$i"; \
						error=true; \
					fi; \
				fi; \
				;; \
			esac; \
		done;\
		if $$error; then exit 1; fi; \
	fi
# End of PATCH.
.endif
.if target(post-patch)
	@@cd ${.CURDIR} && exec ${MAKE} post-patch
.endif
.for _m in ${MODULES}
.  if defined(MOD${_m:U}_post-patch)
	@@${MOD${_m:U}_post-patch}
.  endif
.endfor
.if !empty(REORDER_DEPENDENCIES) && ${PATCH_CHECK_ONLY:L} != "yes"
	sed -e '/^#/d' ${REORDER_DEPENDENCIES} | \
	  tsort -r|while read f; do \
	    cd ${WRKSRC}; \
		case $$f in \
		/*) \
			find . -name $${f#/} -print | while read i; \
				do echo "Touching $$i"; touch $$i; done \
			;; \
		*) \
			if test -e $$f ; then \
				echo "Touching $$f"; touch $$f; \
			fi \
			;; \
		esac; done
.endif
.if ${PATCH_CHECK_ONLY:L} != "yes"
	@@${_MAKE_COOKIE} $@@
.endif

# The real configure

${_CONFIGURE_COOKIE}: ${_PATCH_COOKIE}
	@@${ECHO_MSG} "===>  Configuring for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${WRKBUILD} ${WRKPKG}
.if target(pre-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-configure
.endif
.if ${USE_SCHILY:L} != "no"
.  if (${OStype} == "MidnightBSD") || (${OStype} == "MirBSD")
	sed -e 's/@@@@OScompat@@@@/${OScompat}/' \
	    -e 's/@@@@OStype@@@@/${OStype}/' \
	    -e 's#!/bin/mksh#!'${MKSH:Q}'' \
	    <${PORTSDIR}/infrastructure/db/uname.sed >${WRKDIR}/bin/uname
	chmod ${BINMODE} ${WRKDIR}/bin/uname
.  endif
	ln -sf ${WRKDIR}/bin/${_MPWRAP_CC} ${WRKDIR}/bin/cc
.  if ${MACHINE} != "i386"
	ln -sf ${WRKSRC}/RULES/i386-openbsd-cc.rul \
	    ${WRKSRC:Q}/RULES/${MACHINE:Q}-openbsd-cc.rul
.  endif
.  if ${OStype} == "Darwin"
	ln -sf ${WRKSRC:Q}/RULES/power-macintosh-darwin-cc.rul \
	    ${WRKSRC:Q}/RULES/i386-darwin-cc.rul
.  endif
.endif
.if target(do-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-configure
.elif ${CONFIGURE_STYLE:L} != "no"
# What CONFIGURE normally does
	@@if [ -f ${SCRIPTDIR}/configure ]; then \
		cd ${.CURDIR} &&  ${_SYSTRACE_CMD} ${SETENV} \
		    ${SCRIPTS_ENV} ${SH} ${SCRIPTDIR}/configure; \
	fi
.  for _c in ${CONFIGURE_STYLE:L}
.    if defined(MOD${_c:U}_configure)
	@@${MOD${_c:U}_configure}
.    endif
.  endfor
# End of CONFIGURE.
.endif
.if target(post-configure)
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-configure
.endif
	@@${_MAKE_COOKIE} $@@

# The real build

${_BUILD_COOKIE}: ${_CONFIGURE_COOKIE}
.if ${NO_BUILD:L} == "no"
	@@${ECHO_MSG} "===>  Building for ${FULLPKGNAME}${_MASTER}"
.  if ${VMEM_WARNING:L} == "yes"
	@@echo ""; \
	echo "*** WARNING: you may see an error such as"; \
	echo "***       virtual memory exhausted"; \
	echo "*** when building this package.  If you do you must increase"; \
	echo "*** your limits.  See the man page for your shell and look"; \
	echo "*** for the 'limit' or 'ulimit' command. You may also want to"; \
	echo "*** see the login.conf(5) manual page."; \
	echo "*** Some examples are: "; \
	echo "*** 	csh(1) and tcsh(1): limit datasize <KiB memory>"; \
	echo "***	ksh(1), zsh(1) and bash(1): ulimit -d <KiB memory>"; \
	echo ""
.  endif
.  if target(pre-build)
	@@${_VMEM_UNLOCK} \
	cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
.  endif
.  for _c in ${CONFIGURE_STYLE:L}
.    if defined(MOD${_c:U}_pre_build)
	@@${_VMEM_UNLOCK} \
	${MOD${_c:U}_pre_build}
.    endif
.  endfor
.  if target(do-build)
	@@${_VMEM_UNLOCK} \
	cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
.  else
# What BUILD normally does:
	@@${_VMEM_UNLOCK} \
	cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
	    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE:Q} ${ALL_TARGET}
# End of BUILD
.  endif
.  if target(post-build)
	@@${_VMEM_UNLOCK} \
	cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
.  endif
.endif
	@@${_MAKE_COOKIE} $@@

${_REGRESS_COOKIE}: ${_BUILD_COOKIE}
.if ${NO_REGRESS:L} == "no"
	@@${ECHO_MSG} "===>  Regression check for ${FULLPKGNAME}${_MASTER}"
.  if target(pre-regress)
	@@cd ${.CURDIR} && exec ${MAKE} pre-regress
.  endif
.  if target(do-regress)
	@@cd ${.CURDIR} && exec ${MAKE} do-regress
.  else
# What REGRESS normally does:
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} ${REGRESS_ENV} \
	    ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE:Q} ${REGRESS_TARGET}
# End of REGRESS
.  endif
.  if target(post-regress)
	@@cd ${.CURDIR} && exec ${MAKE} post-regress
.  endif
.else
	@@echo 1>&2 "No regression check for ${FULLPKGNAME}"
.endif
	@@${_MAKE_COOKIE} $@@

.if ${FAKE:L} == "yes"
${_FAKE_COOKIE}: ${_BUILD_COOKIE} ${WRKPKG}/mtree.spec
	@@${ECHO_MSG} "===>  Faking installation for ${FULLPKGNAME}${_MASTER}"
	@@if [ x$$(${SUDO} ${SH} -c umask) != x${DEF_UMASK} ]; then \
		echo >&2 "Error: your umask is \"$$(${SH} -c umask)"\".; \
		exit 1; \
	fi
	@@${SUDO} rm -rf ${WRKINST}
	@@${SUDO} ${INSTALL_PROGRAM_DIR} ${WRKINST}
	@@${SUDO} /usr/sbin/mtree -U -e -d -n -p ${WRKINST} \
		-f ${WRKPKG}/mtree.spec  >/dev/null
.  if ${PREFIX} == "/usr"
	@@${SUDO} ln -s ../man ${WRKINST}/usr/share/man
.  endif
.  for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -r ${_p}
.  endfor
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre-fake)
	@@${MOD${_m:U}_pre-fake}
.    endif
.  endfor

.  if target(pre-fake)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} pre-fake ${_FAKE_SETUP}
.  endif
	@@${SUDO} ${_MAKE_COOKIE} ${_INSTALL_PRE_COOKIE}
.  if target(pre-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} pre-install ${_FAKE_SETUP}
.  endif
.  if target(do-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${MAKE} do-install ${_FAKE_SETUP}
.  else
# What FAKE normally does:
	@@cd ${WRKBUILD} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    ${SETENV} ${MAKE_ENV} ${_FAKE_SETUP} \
	    ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE:Q} ${FAKE_TARGET}
# End of FAKE.
.  endif
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_post-fake)
	@@${MOD${_m:U}_post-fake}
.    endif
.  endfor
.  if target(post-install)
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
	    env FLAVOUR=${FLAVOUR:Q} \
	    ${MAKE} post-install ${_FAKE_SETUP}
.  endif
.  for _p in ${PROTECT_MOUNT_POINTS}
	@@${SUDO} mount -u -w ${_p}
.  endfor
.  if ${PREFIX} == "/usr"
	@@cd ${WRKINST:Q}/usr/share; \
	    [[ ! -h man || $$(readlink man) != ../man ]] || ${SUDO} rm man
.  endif
	@@${SUDO} ${_MAKE_COOKIE} $@@

# The real install

${_INSTALL_COOKIE}:  ${_PACKAGE_COOKIES}
	@@cd ${.CURDIR} && DEPENDS_TARGET=install \
	    exec ${MAKE} run-depends lib-depends
	@@cd ${.CURDIR} && exec ${MAKE} install-binpkg
	@@-${SUDO} ${_MAKE_COOKIE} $@@

install-binpkg:
	@@${ECHO_MSG} "===>  Installing ${FULLPKGNAME${SUBPACKAGE}} from ${PKGFILE${SUBPACKAGE}}"
.  for _m in ${MODULES}
.    if defined(MOD${_m:U}_pre_install)
	@@${MOD${_m:U}_pre_install}
.    endif
.  endfor
.  if ${TRUST_PACKAGES:L} == "yes"
	@@if ${PKG_CMD_INFO} -qe \
	    ${FULLPKGNAME${SUBPACKAGE}}; then \
		echo "Package ${FULLPKGNAME${SUBPACKAGE}} is already installed"; \
	else \
		${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} \
		    PKG_TMPDIR=${PKG_TMPDIR} PATH=${PKG_CMDDIR:Q}:$$PATH \
		    ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}; \
	fi
.  else
	@@${SUDO} ${SETENV} PKG_PATH=${PKGREPOSITORY}:${PKG_PATH} \
	    PKG_TMPDIR=${PKG_TMPDIR} PATH=${PKG_CMDDIR:Q}:$$PATH \
	    ${PKG_CMD_ADD} ${PKGFILE${SUBPACKAGE}}
.  endif
.endif

# The real package

_package: ${_PKG_PREREQ}
	@@[[ -d ${PKGREPOSITORY} ]] || mkdir -p ${PKGREPOSITORY}
	@@if [[ ! -w ${PKGREPOSITORY} ]]; then \
		print -u2 'Error: ${PKGREPOSITORY} is not writable for you!'; \
		exit 1; \
	fi
.if target(pre-package)
	@@cd ${.CURDIR} && exec ${MAKE} pre-package
.endif
.if target(do-package)
	@@cd ${.CURDIR} && exec ${MAKE} do-package
.else
# What PACKAGE normally does:
	@@${ECHO_MSG} "===>  Building package for ${FULLPKGNAME${SUBPACKAGE}}"
# PLIST should normally hold no duplicates.
# This is left as a warning, because stuff such as @@exec %F/%D
# completion may cause legitimate dups.
	@@duplicates=$$(sort <${WRKPKG}/PLIST${SUBPACKAGE} \
	    | egrep -v '@@(comment|mode|owner|group)' | uniq -d); \
	case "$${duplicates}" in "");; \
	*)	echo "\n*** WARNING *** Duplicates in PLIST:\n$$duplicates\n";; \
	esac
	@@${_VMEM_UNLOCK_CMDS} \
	cd ${.CURDIR} && if ${SUDO} ${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
	    ${PKG_CMD_CREATE} ${PKG_ARGS} ${PKGFILE${SUBPACKAGE}}; then \
		mode=$$(id -u):$$(id -g); \
		${SUDO} ${CHOWN} $${mode} ${PKGFILE${SUBPACKAGE}}; \
		${MAKE} _package-links; \
	  else \
		${SUDO} ${MAKE} CLEANDEPENDS=No clean=package; \
		exit 1; \
	  fi
# End of PACKAGE.
.endif
.if target(post-package)
	@@cd ${.CURDIR} && exec ${MAKE} post-package
.endif

fetch-all:
	@@cd ${.CURDIR} && exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes \
	    NO_IGNORE=Yes fetch

# Separate target for each file fetch will retrieve
# In the first loop, go over all CVS distfiles.
# In the second loop, go over ALLFILES, but ignore
# these for which there is already a target.

.if ${MCZ_FETCH:L} == "no"
.  for _i in - 0 1 2 3 4 5 6 7 8 9
.    if defined(_CVS_FETCH${_i:N-}) && ${REFETCH} != "true"
${FULLDISTDIR}/${_CVS_DISTF${_i:N-}}:
	@@if [[ ! -w ${FULLDISTDIR} ]]; then \
		print -u2 'Error: some subdirectory of ${DISTDIR}' \
		    'is not writable for you!'; \
		exit 1; \
	fi
	@@[[ -e ${FULLDISTDIR}/${_CVS_DISTF${_i:N-}} ]] || { \
		cd ${.CURDIR}; ${MAKE} fetch-depends; \
		PATH=${_PORTPATH:Q} TMPDIR=${TMPDIR:Q} \
		    ${_CVS_FETCH${_i:N-}}; \
		file=${@@:S@@^${DISTDIR}/@@@@}; \
		ck=$$(cd ${DISTDIR} && ${_size_fragment}); \
		if [[ ! -s ${CHECKSUM_FILE} ]]; then \
			${ECHO_MSG} ">> No checksum file for ${FULLDISTDIR}/${_CVS_DISTF${_i:N-}}"; \
		elif grep -qe "^$$ck\$$" \
		    -e "^Size$${ck#SIZE} bytes\$$" \
		    ${CHECKSUM_FILE}; then \
			${ECHO_MSG} ">> Size matches for ${FULLDISTDIR}/${_CVS_DISTF${_i:N-}}"; \
		elif grep -qe "SIZE ($$file)" -e "Size ($$file)" ${CHECKSUM_FILE}; then \
			${ECHO_MSG} ">> Size does not match for ${FULLDISTDIR}/${_CVS_DISTF${_i:N-}}"; \
			${ECHO_MSG} ">> Try to refetch with mmake fetch REFETCH=true"; \
			false; \
		else \
			${ECHO_MSG} ">> No size recorded for ${FULLDISTDIR}/${_CVS_DISTF${_i:N-}}"; \
		fi; \
	}
.    endif
.  endfor
.endif
.for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
.  if !target(${_F})
${_F}:
.    if ${FETCH_MANUALLY:L} != "no"
.      for _M in ${FETCH_MANUALLY}
	@@echo "*** "${_M}
.      endfor
	@@exit 1
.    else
	@@mkdir -p ${_F:H}
	@@if [[ ! -w ${_F:H} ]]; then \
		print -u2 'Error: some subdirectory of ${DISTDIR}' \
		    'is not writable for you!'; \
		exit 1; \
	fi
	@@cd ${_F:H}; \
	select=${_EVERYTHING:M*${_F:S@@^${FULLDISTDIR}/@@@@}\:[0-9]}; \
	f=${_F:S@@^${FULLDISTDIR}/@@@@}; \
	${ECHO_MSG} ">> $$f doesn't seem to exist on this system."; \
	${_CDROM_OVERRIDE}; \
	${_SITE_SELECTOR}; \
	for site in $$sites; do \
		${ECHO_MSG} ">> Attempting to fetch ${_F} from $${site}."; \
		if ${FETCH_CMD} ${_F} $${site}$$f; then \
			file=${_F:S@@^${DISTDIR}/@@@@}; \
			ck=$$(cd ${DISTDIR} && ${_size_fragment}); \
			if grep -qe "^$$ck\$$" \
			    -e "^Size$${ck#SIZE} bytes\$$" \
			    ${CHECKSUM_FILE}; then \
				${ECHO_MSG} ">> Size matches for ${_F}"; \
				exit 0; \
			elif grep -qe "SIZE ($$file)" -e "Size ($$file)" ${CHECKSUM_FILE}; then \
				${ECHO_MSG} ">> Size does not match for ${_F}"; \
			else \
				${ECHO_MSG} ">> No size recorded for ${_F}"; \
				exit 0; \
			fi; \
		fi; \
	done; exit 1
.    endif
.  endif
.endfor

# Some support rules for do-package

_package-links:
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
.for _l in FTP CDROM
.  if ${PERMIT_PACKAGE_${_l}:L} == "yes"
	@@echo "Link to ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}"
	@@mkdir -p -m 0775 ${${_l}_PACKAGES}
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
	@@ln ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX} 2>/dev/null || \
	  cp -p ${PKGFILE${SUBPACKAGE}} \
	  ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.  endif
.endfor

_delete-package-links:
.for _l in FTP CDROM
	@@rm -f ${${_l}_PACKAGES}/${FULLPKGNAME${SUBPACKAGE}}${PKG_SUFX}
.endfor

# Cleaning up

clean:
.if ${_clean:L:Mdepends} && ${_CLEANDEPENDS:L} == "yes"
	@@${MAKE} all-dir-depends | tsort -rq | sed '$$d' | \
	    while read dir; do \
		unset FLAVOUR SUBPACKAGE || true; \
		${_flavour_fragment}; \
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
	done
.endif
	@@${ECHO_MSG} "===>  Cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
.  if ${_clean:L:Mfake}
	@@if cd ${WRKINST} 2>/dev/null; then ${SUDO} rm -rf ${WRKINST}; fi
.  endif
.  if ${_clean:L:Mwork}
.    if ${_clean:L:Mflavours}
	@@for i in ${.CURDIR}/w-*; do \
		if [ -L $$i ]; then ${SUDO} rm -rf $$(readlink $$i); fi; \
		${SUDO} rm -rf $$i; \
	done
.    else
	@@[ ! -L ${WRKDIR} ] || ${SUDO} rm -rf $$(readlink ${WRKDIR})
	@@${SUDO} rm -rf ${WRKDIR}
.    endif
.  endif
.  if ${_clean:L:Mdist}
	@@${ECHO_MSG} "===>  Dist cleaning for ${FULLPKGNAME${SUBPACKAGE}}"
	@@if cd ${FULLDISTDIR} 2>/dev/null; then \
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
	fi
	@@if cd ${DISTDIR}/CDROM/${DIST_SUBDIR} 2>/dev/null; then \
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
	fi
	@@if cd ${DISTDIR}/FTP/${DIST_SUBDIR} 2>/dev/null; then \
		if [ "${_DISTFILES}" -o "${_PATCHFILES}" ]; then \
			rm -f ${_DISTFILES} ${_PATCHFILES}; \
		fi \
	fi
.    if !empty(DIST_SUBDIR)
	-@@rmdir ${FULLDISTDIR}
.    endif
.  endif
.  if ${_clean:L:Minstall}
.    if ${_clean:L:Msub}
.      for _s in ${MULTI_PACKAGES}
	-${SUDO} ${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${_s}}
.      endfor
.    else
	-${SUDO} ${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}
.    endif
.  endif
.  if ${_clean:L:Mpackages} || ${_clean:L:Mpackage} && ${_clean:L:Msub}
	rm -f ${_PACKAGE_COOKIES}
.    if defined(MULTI_PACKAGES)
.      for _s in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE=${_s:Q} exec ${MAKE} _delete-package-links
.      endfor
.    endif
.  elif ${_clean:L:Mpackage}
	@@cd ${.CURDIR} && exec ${MAKE} _delete-package-links
	rm -f ${PKGFILE${SUBPACKAGE}}
.  endif
.  if ${_clean:L:Mreadmes}
	rm -f ${.CURDIR}/${FULLPKGNAME}.html
.      for _s in ${MULTI_PACKAGES}
	rm -f ${.CURDIR}/${FULLPKGNAME${_s}}.html
.      endfor
.  endif
.  if ${_clean:L:Mbulk}
	rm -f ${_BULK_COOKIE}
.  endif

# packing list utilities.  This generates a packing list from a recently
# installed port.  Not perfect, but pretty close.  The generated file
# will have to have some tweaks done by hand.
# Note: add @@comment PACKAGE(arch=${MACHINE_ARCH},
#		opsys=${OPSYS}, vers=${OPSYS_VER})
# when port is installed or package created.
#
.if ${FAKE:L} == "yes"
_tmpvars:=
.  for _v in ${SUBST_VARS:NHOMEPAGE:NSYSCONFDIR:NRESPONSIBLE}
_tmpvars+=		${_v}=${${_v}:Q}
.  endfor

plist update-plist: fake
	@@mkdir -p ${PKGDIR}
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG=${LDCONFIG:Q} \
	LOCALBASE=${PREFIX} \
	MTREE_FILE=${WRKPKG}/mtree.spec \
	INSTALL_PRE_COOKIE=${_INSTALL_PRE_COOKIE} \
	PKGREPOSITORY=${PKGREPOSITORY} \
	PLIST=${PLIST} \
	PFRAG=${PKGDIR}/PFRAG \
	FLAVOURS=${FLAVOURS:Q} MULTI_PACKAGES=${MULTI_PACKAGES:Q} \
	OKAY_FILES=${_FAKE_COOKIE:Q}\ ${_INSTALL_PRE_COOKIE:Q} \
	perl ${PORTSDIR}/infrastructure/scripts/make-plist ${PKGDIR} ${_tmpvars}
.endif

update-patches:
	@@toedit=$$(WRKDIST=${WRKDIST} PATCHDIR=${PATCHDIR} \
	    PATCH_LIST=${PATCH_LIST:Q} DIFF_ARGS=${DIFF_ARGS:Q} \
	    DISTORIG=${DISTORIG} PATCHORIG=${PATCHORIG} ${_GDIFFLAG} \
	    ${SHELL} ${PORTSDIR}/infrastructure/scripts/update-patches); \
	case $$toedit in "");; \
	*) read i?'edit patches: '; \
	cd ${PATCHDIR} && $${VISUAL:-$${EDITOR:-/usr/bin/vi}} $$toedit;; esac


# mirroring utilities
fetch-makefile:
	@@echo -n "all"
.if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo -n " ftp"
.endif
.if ${PERMIT_DISTFILES_CDROM:L} == "yes"
	@@echo -n " cdrom"
.endif
	@@echo ":: ${_FMN}"
# write generic package dependencies
	@@echo ".PHONY: ${_FMN}"
.if ${RECURSIVE_FETCH_LIST:L} == "yes"
	@@echo "${_FMN}: ${_ALLFILES} "$$(_FULL_PACKAGE_NAME=Yes \
	    ${MAKE} full-all-depends)
.else
	@@echo "${_FMN}: ${_ALLFILES}"
.endif
	@@exec ${MAKE} __FETCH_ALL=Yes __ARCH_OK=Yes \
	    NO_IGNORE=Yes _fetch-makefile

_fetch-makefile:
.if !empty(ALLFILES)
.  for _F in ${_ALLFILES}
	@@if ! fgrep -q "|${_F}|" $${_DONE_FILES}; then \
		echo "|${_F}|" >>$${_DONE_FILES}; \
		${MAKE} _fetch-onefile _file=${_F}; \
	fi
.  endfor
.endif
	@@echo


_fetch-onefile:
# XXX loop so that M${_F} will work
.for _F in ${_file}
	@@echo '${_F}: $$F'
	@@echo -n '\t@@RESPONSIBLE="${RESPONSIBLE}" '
.  if !empty(DIST_SUBDIR)
	@@echo -n 'DIST_SUBDIR="${DIST_SUBDIR}" '
.  endif
	@@echo '\\'
	@@select='${_EVERYTHING:M*${_F:S@@^${DIST_SUBDIR}/@@@@}\:[0-9]}'; \
	${_SITE_SELECTOR}; \
	echo "\t SITES=\"$$sites\" \\"
.  if ${FETCH_MANUALLY:L} != "no"
	@@echo '\t FETCH_MANUALLY="Yes" \\'
.  endif
.  if !defined(NO_CHECKSUM) && !empty(_CKSUMFILES:M${_F})
	@@checksum_file=${CHECKSUM_FILE}; \
	if [ ! -f $$checksum_file ]; then \
	  echo >&2 "Missing checksum file: $$checksum_file"; \
	  echo '\t ERROR="no checksum file" \\'; \
	else \
	  for c in ${_CIPHERS}; do \
		if set -- $$(grep -i "^$$c (${_F})" $$checksum_file); then \
			break; fi; \
	  done; \
	  case "$$4" in \
		"") \
		  echo >&2 "No checksum recorded for ${_F}."; \
		  echo '\t ERROR="no checksum" \\';; \
		"IGNORE") \
		  echo >&2 "Checksum for ${_F} is IGNORE in $$checksum_file"; \
		  echo >&2 'but file is not in $${IGNORE_FILES}'; \
		  echo '\t ERROR="IGNORE inconsistent" \\';; \
		*) \
		  echo "\t CIPHER=\"$$c\" CKSUM=\"$$4\" \\";; \
	  esac; \
	fi
.  endif
	@@echo '\t $${EXEC} $${FETCH} "$$@@"'
.endfor

# foobar

.if (${MACHINE_OS} == "Darwin") || (${OStype} == "MidnightBSD")
.  if exists(${_ORIG_CC})
CC_SPECS=	${_ORIG_CC}
.  elif exists(/usr/bin/${_ORIG_CC})
CC_SPECS=	/usr/bin/${_ORIG_CC}
.  else
.    ifndef CC_SPECS
CC_SPECS!=	whence -p ${_ORIG_CC:Q} 2>&- || \
		whence -p $$(echo ${_ORIG_CC:Q} | sed 's/ .*//') 2>&-
.      if ${__MAKEFLAGS_HACKERY:L} == "yes"
.MAKEFLAGS:=	${.MAKEFLAGS} CC_SPECS=${CC_SPECS:Q}
.      endif
.    endif
.    if !exists(${CC_SPECS})
CC_SPECS:=
.    endif
.  endif

_patch_cc_specs=\
	if fgrep -q /usr/bin/libtool $$t; then \
		print ',g!/usr/bin/libtool!s!!'${LOCALBASE:Q}'/db/libtool!g\nwq' | \
		    ed -s $$t; \
	else \
		reallinker=$$(${_ORIG_CC} -print-prog-name=collect2); \
		[[ -x $$reallinker ]] || \
		    reallinker=$$(${_ORIG_CC} -print-prog-name=ld); \
		print '/^\*linker:$$/+1s!^collect2!${LOCALBASE}/db/collect2' \
		    "-Ww,collect2 $$reallinker!\nwq" | ed -s $$t; \
	fi
.if exists(${.SYSMK}/libmirmake.a)
_patch_cc_specs+=;\
	print '/^\*link_gcc_c_sequence:$$/+1s^-L'${.SYSMK:Q} \
	    '%{!shared:-lmirmake} \nwq' | ed -s $$t
.endif

${LOCALBASE}/db/specs.${_ORIG_CC:S!/!_!g}: ${CC_SPECS} \
    ${PORTSDIR}/infrastructure/mk/bsd.port.mk
	@@if ! t=$$(mktemp /tmp/XXXXXXXXXXXX); then \
		print -u2 Error: cannot make temporary file; \
		exit 1; \
	fi; \
	${_ORIG_CC} -dumpspecs >$$t; \
	${_patch_cc_specs}; \
	if ! ${SUDO} ${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} \
	    -m ${NONBINMODE} $$t $@@; then \
		print -u2 Error: cannot install specs file; \
		rm -f $$t; \
		exit 1; \
	fi; \
	rm -f $$t; :
.endif

# This target generates an index entry suitable for aggregation into
# a large index.  Format is:
#
# distribution-name|port-path|installation-prefix|comment|homepage| \
#  description-file|maintainer|categories|lib-deps|build-deps|run-deps| \
#  fos-os|for-arch|package-cdrom|package-ftp|distfiles-cdrom|distfiles-ftp
_EXTRA_DESCRIBE=
.if defined(BROKEN)
_EXTRA_DESCRIBE+=	"(broken)"
.endif
.if ${USE_CXX:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses C++)"
.endif
.if ${USE_MOTIF:L} != "no"
_EXTRA_DESCRIBE+=	"(uses Motif)"
.elif ${USE_X11:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses X11)"
.endif
.if (${USE_GMAKE:L} == "yes") || (${USE_SCHILY:L} == "yes")
_EXTRA_DESCRIBE+=	"(uses GNU Make)"
.endif
.if ${USE_SCHILY:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses Schily)"
# we donâ€™t distribute such filth from hostile upstreams
PERMIT_PACKAGE_CDROM:=	No
PERMIT_PACKAGE_FTP:=	No
.endif
.if ${_USE_ZIP:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses PKZip)"
.endif
.if ${_USE_BZIP2:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses BZip2)"
.endif
.if ${NO_SYSTRACE:L} != "no"
_EXTRA_DESCRIBE+=	"(disables systrace)"
.endif
.for _i in ${EMUL}
_EXTRA_DESCRIBE+=	"(uses ${_i} personality)"
.endfor
.if ${_EXTRA_DESCRIBE} == ""
_EXTRA_DESCRIBE=
.endif
describe:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE=${SUBPACKAGE:Q} FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING=${SUBPACKAGE:Q} exec ${MAKE} describe
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE=${_sub:Q} FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING=${_sub:Q} exec ${MAKE} describe
.    endfor
.  endif
.else
	@@echo -n "${FULLPKGNAME${SUBPACKAGE}}|${FULLPKGPATH}|"
.  if ${PREFIX} == ${LOCALBASE}
	@@echo -n "|"
.  else
	@@echo -n "${PREFIX}|"
.  endif
	@@echo -n ${_COMMENT:Q}${_EXTRA_DESCRIBE}\|${HOMEPAGE:Q}\|; \
	if [ -f ${DESCR} ]; then \
		echo -n "${DESCR:S,^${PORTSDIR}/,,}|"; \
	else \
		echo -n "/dev/null|"; \
	fi; \
	echo -n "${RESPONSIBLE}|${CATEGORIES}|"
.  for _d in LIB BUILD RUN
.    if !empty(_${_d}_DEP2)
	@@cd ${.CURDIR} && _FINAL_ECHO=: _INITIAL_ECHO=: exec \
	    ${MAKE} ${_d:L}-depends-list
.    endif
	@@echo -n "|"
.  endfor
	@@case "${ONLY_FOR_PLATFORM}!${NOT_FOR_PLATFORM}" in \
	"!")	echo -n "any|" ;; \
	*)	sp=; only="${ONLY_FOR_PLATFORM}"; not="${NOT_FOR_PLATFORM}"; \
		test -z "$$only" || for a in $$only; do \
			echo -n "$$sp$$a"; \
			sp=" "; \
		done; \
		test -z "$$not" || for a in $$not; do \
			echo -n "$$sp!$$a"; \
			sp=" "; \
		done; \
		echo -n "|" ;; \
	esac

.  if defined(_BAD_LICENCING)
	@@echo "?|?|?|?"
.  else
.    if ${PERMIT_PACKAGE_CDROM:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_PACKAGE_FTP:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_CDROM:L} == "yes"
	@@echo -n "y|"
.    else
	@@echo -n "n|"
.    endif
.    if ${PERMIT_DISTFILES_FTP:L} == "yes"
	@@echo "y"
.    else
	@@echo "n"
.    endif
.  endif
.endif

readmes:
.if defined(MULTI_PACKAGES) && !defined(PACKAGING)
	@@cd ${.CURDIR} && SUBPACKAGE=${SUBPACKAGE:Q} FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING=${SUBPACKAGE:Q} exec ${MAKE} readmes
.  if empty(SUBPACKAGE)
.    for _sub in ${MULTI_PACKAGES}
	@@cd ${.CURDIR} && SUBPACKAGE=${_sub:Q} FLAVOUR=${FLAVOUR:Q} \
	    PACKAGING=${_sub:Q} exec ${MAKE} readmes
.    endfor
.  endif
.else
	@@rm -f ${FULLPKGNAME${SUBPACKAGE}}.html
	@@cd ${.CURDIR} && exec ${MAKE} README_NAME=${README_NAME} \
	    ${FULLPKGNAME${SUBPACKAGE}}.html
.endif


${FULLPKGNAME${SUBPACKAGE}}.html:
	@@echo ${_COMMENT:Q} | ${HTMLIFY} >$@@.tmp-comment
	@@echo ${FULLPKGNAME${SUBPACKAGE}} | ${HTMLIFY} >$@@.tmp3
.if defined(HOMEPAGE)
	@@echo 'See <a href="'${HOMEPAGE:Q}'">'${HOMEPAGE:Q}'</a> for details.' >$@@.tmp4
.else
	@@echo "" >$@@.tmp4
.endif
.if defined(MULTI_PACKAGES)
.  if empty(SUBPACKAGE)
	@@echo "<h2>Subpackages</h2>" >$@@.tmp-subpackages
	@@echo "<ul>" >>$@@.tmp-subpackages

.    for _S in ${MULTI_PACKAGES}
	@@name=$$(SUBPACKAGE=${_S} ${MAKE} _print-packagename \
	    _FULL_PACKAGE_NAME=No); \
	echo "<li><a href=\"$$name.html\">$$name</a>" >>$@@.tmp-subpackages
.    endfor
	@@echo "</ul>" >>$@@.tmp-subpackages
.  else
	@@name=$$(unset SUBPACKAGE; ${MAKE} _print-packagename \
	    _FULL_PACKAGE_NAME=No); \
	echo "<h2>Subpackage of <a href=\"$$name.html\">$$name</a></h2>" \
	    >$@@.tmp-subpackages
.  endif
.else
	@@>$@@.tmp-subpackages
.endif
.for _I in build run
.  if !empty(_ALWAYS_DEP) || !empty(_${_I:U}_DEP)
	@@cd ${.CURDIR} && ${MAKE} full-${_I}-depends _FULL_PACKAGE_NAME=Yes \
	    | while read n; do \
		j=$$(dirname $$n|${HTMLIFY}); k=$$(basename $$n|${HTMLIFY}); \
		echo "<li><a href=\"${PKGDEPTH}$$j/$$k.html\">$$k</a>"; \
	    done  >$@@.tmp-${_I}
.  else
	@@echo "<li>none" >$@@.tmp-${_I}
.  endif
.endfor
	@@cat ${README_NAME} | sed \
	    -e 's|%%PORT%%|'"$$(echo ${FULLPKGPATH}  | ${HTMLIFY})"'|g' \
	    -e '/%%PKG%%/r$@@.tmp3' -e '//d' \
	    -e '/%%COMMENT%%/r$@@.tmp-comment' -e '//d' \
	    -e '/%%DESCR%%/r${PKGDIR}/DESCR${SUBPACKAGE}' -e '//d' \
	    -e '/%%HOMEPAGE%%/r$@@.tmp4' -e '//d' \
	    -e '/%%BUILD_DEPENDS%%/r$@@.tmp-build' -e '//d' \
	    -e '/%%RUN_DEPENDS%%/r$@@.tmp-run' -e '//d' \
 	    -e '/%%SUBPACKAGES%%/r$@@.tmp-subpackages' -e '//d' \
	    >>$@@
	@@rm -f $@@.tmp*


print-build-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-build-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to build.'
.endif

print-run-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-run-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to run.'
.endif

print-all-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP) || !empty(_BUILD_DEP)
	@@echo -n 'This port requires package(s) "'
	@@${MAKE} full-all-depends|tr '\012' '\040'|sed -e 's, $$,,'
	@@echo '" to run.'
.endif

print-depends: print-build-depends print-run-depends

.for _i in build all run
full-${_i}-depends:
	@@${MAKE} ${_i}-dir-depends | tsort -rq | sed -e '$$d' \
	    | while read dir; do \
		unset FLAVOUR SUBPACKAGE || true; \
		${_flavour_fragment}; \
		eval $$toset ${MAKE} _print-packagename ; \
	done

for-${_i}-depends:
	@@${MAKE} ${_i}-dir-depends | tsort -rq | sed -e '$$d' \
	    | while read dir; do \
		unset FLAVOUR SUBPACKAGE || true; \
		${_flavour_fragment}; \
		eval $$toset ${for-${_i}-depends}; \
	done
.endfor

relevant-checks:
.if ${PERMIT_PACKAGE_CDROM:L} == "yes" || ${PERMIT_PACKAGE_FTP:L} == "yes" \
    || ${USE_CXX:L} == "yes" || ${USE_X11:L} == "yes"
	@@${MAKE} all-dir-depends | tsort -rq | sed -e '$$d' \
	    | while read dir; do \
		unset FLAVOUR SUBPACKAGE || true; \
		${_flavour_fragment}; \
		export _MASTER_PERMIT_CDROM=${PERMIT_PACKAGE_CDROM:Q} \
		    _MASTER_PERMIT_FTP=${PERMIT_PACKAGE_FTP:Q} \
		    _MASTER_BROKEN=${BROKEN:Q} \
		    _MASTER_IGNORE=${IGNORE:Q} \
		    _MASTER_USE_CXX=${USE_CXX:Q} \
		    _MASTER_USE_X11=${USE_X11:Q}; \
		eval $$toset ${MAKE} _relevant-checks; \
	done
.endif

_relevant-checks:
.if defined(_MASTER_BROKEN) && empty(_MASTER_BROKEN) \
    && defined(BROKEN) && !empty(BROKEN)
	@@print -u2 "Warning: dependency ${PKGPATH} is marked BROKEN: ${BROKEN}"
.endif
.if defined(_MASTER_IGNORE) && empty(_MASTER_IGNORE) \
    && defined(IGNORE) && !empty(IGNORE) && empty(BROKEN)
	@@print -u2 "Warning: dependency ${PKGPATH} is marked IGNORE:" ${IGNORE}
.endif
.for _i in FTP CDROM
.  if defined(_MASTER_PERMIT_${_i}) \
    && ${_MASTER_PERMIT_${_i}:L} == "yes" && ${PERMIT_PACKAGE_${_i}:L} != "yes"
	@@echo >&2 "Warning: dependency ${PKGPATH} is not allowed for ${_i}"
.  endif
.endfor
.for _i in CXX X11
.  if defined(_MASTER_USE_${_i}) \
    && ${_MASTER_USE_${_i}:L} != "yes" && ${USE_${_i}:L} == "yes" \
    && !${FLAVOURS:U:MNO_${_i}}
	@@echo >&2 "Warning: dependency ${PKGPATH} uses ${_i}"
.  endif
.endfor

.for _i in RUN BUILD LIB
${_i:L}-depends-list:
.  if !empty(_${_i}_DEP2)
	@@unset FLAVOUR SUBPACKAGE || true; \
	: $${_INITIAL_ECHO:='echo -n "This port requires \""'}; \
	: $${_ECHO='echo -n'}; \
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=; \
	eval $${_INITIAL_ECHO}; \
	for spec in $$(echo ${_${_i}_DEP2:Q} \
		| tr '\040' '\012' | sort -u); do \
		$${_ECHO} "$$space$${spec}"; \
		space=' '; \
	done; eval $${_FINAL_ECHO}
.  endif
.endfor

# recursive depend targets

# Print list of all libraries that we may depend upon.
_recurse-lib-depends-check:
.for _i in ${LIB_DEPENDS}
	@@unset FLAVOUR SUBPACKAGE  || true; \
	echo ${_i:Q} | { \
		IFS=:; read dep pkg dir target; \
		IFS=,; for j in $$dep; do echo $$j; done; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavour_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor
.for _i in ${RUN_DEPENDS}
	@@unset FLAVOUR SUBPACKAGE  || true; \
	echo ${_i:Q} | { \
		IFS=:; read dep pkg dir target; \
		if ! fgrep -q "|$$dir|" $${_DEPENDS_FILE}; then \
			echo "|$$dir|" >>$${_DEPENDS_FILE}; \
			${_flavour_fragment}; \
			eval $$toset ${MAKE} _recurse-lib-depends-check; \
		fi; \
	}
.endfor


# Write a correct list of dependencies for packages.
_recurse-solve-package-depends:
.for _i in ${RUN_DEPENDS}
	@@unset FLAVOUR SUBPACKAGE || true; \
	echo ${_i:Q} |{ \
		IFS=:; read dep pkg dir target; \
		if [[ -n $$dir ]]; then \
			${_flavour_fragment}; \
			default=$$(eval $$toset ${MAKE} _print-packagename); \
		else \
			default=nonexistent; \
		fi; \
		: $${pkg:=$$default}; \
		echo "@@newdepend $$self:$$pkg:$$default" >>$${_depends_result}; \
		if fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
			: ; \
		elif [[ -n $$dir ]]; then \
			echo "|$$default|" >>$${_DEPENDS_FILE}; \
			toset="$$toset self=\"$$default\""; \
			if ! eval $$toset ${MAKE} \
			    _recurse-solve-package-depends; then  \
				echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
				exit 1; \
			fi; \
		fi; }
.endfor
.if ${NO_SHARED_LIBS:L} != "yes"
.  for _i in ${LIB_DEPENDS}
	@@unset FLAVOUR SUBPACKAGE || true; \
	echo ${_i:Q}|{ \
		IFS=:; read dep pkg dir target; \
		${_flavour_fragment}; \
		libspecs=;comma=; \
		default=$$(eval $$toset ${MAKE} _print-packagename); \
		case "X$$pkg" in \
		X)	pkg=$$(echo $$default | sed -e 's,-[0-9].*,-*,');; \
		esac; \
		newdep=; comma=; \
		if ${PKG_CMD_INFO} -qe $$pkg; then \
			listlibs='ls /usr/lib $$shdir 2>/dev/null'; \
		else \
			listlibs='ls /usr/lib 2>/dev/null'; \
			IFS=,; for d in $$dep; do \
				${_libresolve_fragment}; \
				case "$$check" in \
				*.a|Missing\ library|Error:*) \
					newdep="$$newdep$$comma$$d"; \
					comma=',' ;; \
				esac; \
			done; \
			comma=; dep="$$newdep"; \
		fi; \
		if [[ -n $$newdep ]]; then \
			( unset PACKAGING || true; \
			  eval $$toset ${MAKE} \
			    ${PKGREPOSITORY}/$$default${PKG_SUFX} \
			); \
			listlibs='${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
			    ${PKG_CMD_INFO} -L \
			    ${PKGREPOSITORY}/$$default${PKG_SUFX} \
			    | grep $$shdir | sed -e "s,^$$shdir/,,"'; \
		fi; \
		IFS=,; for d in $$dep; do \
			${_libresolve_fragment}; \
			case "$$check" in \
			*.a) continue;; \
			Missing\ library|Error:*) \
				echo 1>&2 "Can't resolve libspec $$d"; \
				exit 1;; \
			*) \
				libspecs="$$libspecs$$comma$$shprefix$$check"; \
				comma=',';; \
			esac; \
		done; \
		case "X$$libspecs" in \
		X) ;;\
		*) \
			echo "@@libdepend $$self:$$libspecs:$$pkg:$$default" \
			    >>$${_depends_result}; \
			if ! fgrep -q "|$$default|" $${_DEPENDS_FILE}; then \
				echo "lib|$$default|" >>$${_DEPENDS_FILE}; \
				toset="$$toset self=\"$$default\""; \
				if ! eval $$toset ${MAKE} \
				    _recurse-solve-package-depends; then  \
					echo 1>&2 "*** Problem checking deps in \"$$dir\"." ; \
					exit 1; \
				fi; \
			fi;; \
		esac; \
	}
.  endfor
.endif

# recursively build a list of dirs for package running, ready for tsort
_recurse-run-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_RUN_DEP}
	@@unset FLAVOUR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavour_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-run-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

run-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_RUN_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} PACKAGING=${SUBPACKAGE:Q} \
		${MAKE} _recurse-run-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

# recursively build a list of dirs for package building, ready for tsort
# second and further stages need _RUN_DEP.
_recurse-all-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP} ${_FETCH_DEP}
	@@unset FLAVOUR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavour_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

# first stage does not need _RUN_DEP
_build-dir-depends:
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP}
	@@unset FLAVOUR SUBPACKAGE || true; \
	echo "$$self ${_dir}"; \
	if ! fgrep -q "|${_dir}|" $${_DEPENDS_FILE}; then \
		echo "|${_dir}|" >>$${_DEPENDS_FILE}; \
		dir=${_dir}; \
		${_flavour_fragment}; \
		toset="$$toset self=\"${_dir}\""; \
		if ! eval $$toset ${MAKE} _recurse-all-dir-depends; then  \
			echo 1>&2 "*** Problem checking deps in \"$$dir\"."; \
			exit 1; \
		fi; \
	fi
.endfor

build-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _build-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

all-dir-depends:
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP) || !empty(_FETCH_DEP)
	@@${_depfile_fragment}; \
	if ! fgrep -q "|${FULLPKGPATH}|" $${_DEPENDS_FILE}; then \
		echo "|${FULLPKGPATH}|" >>$${_DEPENDS_FILE}; \
		self=${FULLPKGPATH} ${MAKE} _recurse-all-dir-depends; \
	fi
.else
	@@echo "${FULLPKGPATH} ${FULLPKGPATH}"
.endif

link-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/$$(basename ${.CURDIR}); \
	if [ ! -e $$linkname ]; then \
		echo "$$linkname -> ${.CURDIR}"; \
		mkdir -p ${PORTSDIR}/${_CAT}; \
		ln -s ${.CURDIR} $$linkname; \
	fi
.endfor

unlink-categories:
.for _CAT in ${CATEGORIES}
	@@linkname=${PORTSDIR}/${_CAT}/$$(basename ${.CURDIR}); \
	if [ -L $$linkname ]; then \
		echo "rm $$linkname"; \
		rm $$linkname; \
		if rmdir ${PORTSDIR}/${_CAT} 2>/dev/null; then \
			echo "rmdir ${PORTSDIR}/${_CAT}"; \
	    fi; \
	fi
.endfor

homepage-links:
.if defined(HOMEPAGE)
	@@echo '<li><a href="'${HOMEPAGE:Q}'">'${PKGNAME:Q}'</a>'
.else
	@@echo '<li>${PKGNAME}'
.endif

.if ${FAKE:L} == "no"
.  include "${PORTSDIR}/infrastructure/mk/old-install.mk"
.endif

#####################################################
# convenience targets, not really needed
#####################################################

checkpatch:
	@@cd ${.CURDIR} && exec ${MAKE} PATCH_CHECK_ONLY=Yes patch

clean-depends:
	@@cd ${.CURDIR} && exec ${MAKE} clean=depends

distclean:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=dist

cleandir:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=Yes clean

delete-package:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=package

homepage:
.ifdef HOMEPAGE
	$${BROWSER:-lynx} ${HOMEPAGE:Q}
.else
	@@echo This port has not defined a HOMEPAGE.
.endif

reinstall:
	@@cd ${.CURDIR} && exec ${MAKE} clean='install force'
	@@cd ${.CURDIR} && DEPENDS_TARGET=${DEPENDS_TARGET} exec ${MAKE} install

repackage:
	@@cd ${.CURDIR} && exec ${MAKE} CLEANDEPENDS=No clean=packages
	@@cd ${.CURDIR} && exec ${MAKE} package

rebuild:
	@@rm -f ${_BUILD_COOKIE}
	@@cd ${.CURDIR} && exec ${MAKE} build

uninstall deinstall:
	@@${ECHO_MSG} "===> Deinstalling for ${FULLPKGNAME${SUBPACKAGE}}"
	@@${SUDO} ${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
	    ${PKG_CMD_DELETE} ${FULLPKGNAME${SUBPACKAGE}}

upgrade:
	@@exec ${MAKE} _UPGRADE_FLAGS= _do-upgrade

reupgrade:
	@@exec ${MAKE} _UPGRADE_FLAGS=-af _do-upgrade

_do-upgrade: _upgrade_pkgs .WAIT _upgrade ${_UPGRADE_DEPS}

_upgrade_pkgs:
	@@i=0; for f in ${PKGFILE} ${_UPGRADE_PKGS}; do \
		[[ -s $$f ]] || i=1; \
	done; [[ $$i = 0 ]] || exec ${MAKE} ${_PACKAGE_COOKIES}
	@@${ECHO_MSG} "===>  Upgrading for ${FULLPKGNAME}${_MASTER}"

_upgrade:
	${SUDO} ${PKG_CMD_UPGRADE} ${_UPGRADE_FLAGS} ${PKGFILE${SUBPACKAGE}}

.if defined(ERRORS)
.BEGIN:
.  for _m in ${ERRORS}
	@@echo 1>&2 ${_m} "(in ${PKGPATH})"
.  endfor
	@@exit 1
.endif

.PHONY: \
	_build-dir-depends _delete-package-links \
	_fetch-makefile _fetch-onefile \
	_package _package-links _print-packagename \
	_recurse-all-dir-depends _recurse-lib-depends-check \
	_recurse-run-dir-depends _recurse-solve-package-depends _refetch \
	addsum \
	all all-dir-depends build \
	build-depends build-depends-list build-dir-depends \
	checkpatch checksum clean cleandir \
	clean-depends configure deinstall \
	delete-package \
	depends \
	describe distclean distpatch \
	do-build do-configure do-distpatch \
	do-extract do-fetch do-install \
	do-package do-regress extract \
	fake fetch fetch-all \
	fetch-makefile for-all-depends for-build-depends \
	for-run-depends full-all-depends full-build-depends \
	full-run-depends homepage homepage-links install install-binpkg \
	lib-depends lib-depends-check lib-depends-list \
	link-categories makesum manpages-check \
	package patch \
	plist post-build post-configure \
	post-distpatch post-extract post-fetch \
	post-install post-package post-patch \
	post-regress pre-build pre-configure \
	pre-extract pre-fake pre-fetch \
	pre-install pre-package pre-patch \
	pre-regress print-build-depends print-run-depends \
	_print-uses readmes rebuild \
	regress regress-depends \
	reinstall repackage reupgrade run-depends \
	run-depends-list run-dir-depends show \
	uninstall unlink-categories update-patches update-plist \
	upgrade _upgrade _upgrade_pkgs unconfigure \
	relevant-checks _relevant-checks
@


1.294
log
@add .lz/.tlz support for distfiles (not yet for binary packages)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.290 2015/07/19 00:00:00 tg Exp $
a13 3
#
# For the MirPorts Framework, the master contact address is the mailing list:
#	mmake show=_MIRPORTS_ADDRESS
d1173 1
a1173 1
RESPONSIBLE?=		The MirPorts mailing list ${_MIRPORTS_ADDRESS}
@


1.293
log
@.lz and .tlz are claimed by lzip, drop most LZMA-Alone support
(one thing in which Lasse and Antonio agree)
@
text
@d953 2
d1061 4
d1072 1
d1117 9
@


1.292
log
@add -fverbose-asm and MD options to compile-to-.s by default
@
text
@d1052 1
a1052 2
.if !empty(EXTRACT_ONLY:M*.lzma) || \
    !empty(EXTRACT_ONLY:M*.tlz) || !empty(EXTRACT_ONLY:M*.clz)
d1096 1
a1096 1
    *.tar.lzma | *.tlz | *.cpio.lzma | *.clz | *.mcz.lzma)		\
@


1.291
log
@spurious error msg if ${WRKINST}/usr/share/man is not a symlink
@
text
@d438 1
@


1.290
log
@implement SETENV_TO_KEEP
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.289 2014/12/06 16:14:17 tg Exp $
d2487 2
a2488 2
	@@[[ $$(readlink ${WRKINST}/usr/share/man) != ../man ]] || \
	    ${SUDO} rm ${WRKINST}/usr/share/man
@


1.289
log
@update SelfHTML to the, probably last, latest version;
fix an editorial bug while there
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.288 2014/05/30 00:21:36 tg Exp $
d842 6
@


1.288
log
@fix dependencies to _really_ use the -rtl package

now, we only have a minor issue:
three â€œ@@pkgdep gcc-rtl-4.4.7-0â€ lines in db/pkg/t1lib-5.1.2-0/+CONTENTS
and three â€œt1lib-5.1.2-0â€ in db/pkg/gcc-rtl-4.4.7-0/+REQUIRED_BY, which
are caused by the pkg(1) utility, which is in Perl, which I cannot hack
(especially not now).

on the positive side, gcc-4.4 with SSP works, it handles 16-bit wchar_t
and pcc struct return (unlike pccâ€¦ hahâ€¦ the ironyâ€¦) just fine. it isnâ€™t
really tested butâ€¦ should work. binary package is uploadedâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.285 2014/05/29 18:36:29 tg Exp $
d1106 4
d1113 5
@


1.287
log
@add support for USE_COMPILER=gcc4.4 (untested, too)

XXX LIB_DEPENDS should express them, but theyâ€™re in the version-specific subdirâ€¦
@
text
@d415 1
a415 1
_CXX_LIB_DEPENDS=	:gcc-rtl-4.4.7-*:lang/egcs/gcc4.4
d442 1
@


1.286
log
@change FETCH_CMD to end with -o (ftp, fetch) or -O (GNU wget)
and use this
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.284 2014/05/28 18:52:53 tg Exp $
d412 5
a433 1
USE_COMPILER?=		system
d440 4
@


1.285
log
@fix indent
@
text
@d2603 1
a2603 1
		if ${FETCH_CMD} $${site}$$f; then \
@


1.284
log
@default to FETCH_SYMLINK_DISTFILES=Yes, allow FETCH_SYMLINK_DISTFILES=No, fix FETCH_SYMLINK_DISTFILES=Yes when file is not on the â€œCD-ROMâ€
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.283 2014/04/18 19:59:26 tg Exp $
d2604 13
a2616 13
				file=${_F:S@@^${DISTDIR}/@@@@}; \
				ck=$$(cd ${DISTDIR} && ${_size_fragment}); \
				if grep -qe "^$$ck\$$" \
				    -e "^Size$${ck#SIZE} bytes\$$" \
				    ${CHECKSUM_FILE}; then \
					${ECHO_MSG} ">> Size matches for ${_F}"; \
					exit 0; \
				elif grep -qe "SIZE ($$file)" -e "Size ($$file)" ${CHECKSUM_FILE}; then \
					${ECHO_MSG} ">> Size does not match for ${_F}"; \
				else \
					${ECHO_MSG} ">> No size recorded for ${_F}"; \
					exit 0; \
				fi; \
@


1.283
log
@check BROKEN/IGNORE/USE_CXX+NO_CXX on whatif-depends
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.282 2014/04/02 16:54:32 tg Exp $
d884 1
d886 3
a888 2
.  if defined(FETCH_SYMLINK_DISTFILES)
_CDROM_OVERRIDE=	if ln -s ${CDROM_SITE}/$$f .; then exit 0; fi
@


1.282
log
@use C99 compiler by default (which we used to, but disabled in base)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.281 2014/01/07 13:07:31 tg Exp $
d1869 1
a1869 1
    relevant-checks:
@


1.281
log
@-llvm
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.280 2013/12/01 03:49:59 tg Exp $
d444 2
d2133 1
a2133 1
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CC:Q} '"$$@@"' >${WRKDIR}/bin/${_MPWRAP_CC}
d2137 1
a2137 1
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CXX:Q} '"$$@@"' >${WRKDIR}/bin/${_MPWRAP_CXX}
@


1.280
log
@use xz to decompress *.lzma files, not lzma
we can't have two decompressors in here that conflict with each other
and I can't think of a way to express an or-dependency here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.279 2013/11/06 18:53:15 tg Exp $
a409 1
_DEFCOPTS_llvm?=	-O1 -Wformat -fno-strict-aliasing -fwrapv
a435 5
.elif ${USE_COMPILER:L} == "llvm"
BUILD_DEPENDS+=		:llvm-gcc*:lang/llvm-gcc
_DEFCOPTS:=		${_DEFCOPTS_llvm}
_ORIG_CC:=		llvm-gcc
_ORIG_CXX:=		llvm-g++
@


1.279
log
@add SHA256 to _CIPHERS; while not much more secure any more, it adds,
and OpenBSD and pkgsrcÂ®(IIRC) also use it, so it allows us to share
distinfo files more easily
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.278 2013/08/06 19:22:25 tg Exp $
d1078 4
a1081 1
BUILD_DEPENDS+=		:lzma-*:archivers/lzma
a1089 3
.  if !exists(/usr/bin/xzdec)
BUILD_DEPENDS+=		:xz-*:archivers/xz
.  endif
@


1.278
log
@make it possible for MODULES to mandate use of systrace
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.277 2012/10/18 16:41:25 tg Exp $
d379 1
a379 1
_CIPHERS=		rmd160 tiger sha1 md5
@


1.277
log
@add a way to disable adding stuff to .MAKEFLAGS
for badly behaved sub-makes
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.276 2012/08/04 18:13:18 tg Exp $
d527 7
a686 6
NO_SYSTRACE?=		No
.if ${NO_SYSTRACE:L} == "no"
_SYSTRACE_CMD?=		/bin/systrace ${_SYSTRACE_ARGS} -f ${_SYSTRACE_COOKIE}
.else
_SYSTRACE_CMD=
.endif
@


1.276
log
@check which ulimits are available before choosing to unlock them
- reported by bsiegert@@

the hardlimits are checked only once now, as $(â€¦) cannot be passed
via .MAKEFLAGS
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.275 2010/03/06 20:01:41 tg Exp $
d1859 1
d1861 1
d2846 1
d2848 1
@


1.275
log
@donâ€™t cater to hostile upstreams
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.273 2010/01/09 19:40:06 tg Exp $
d1436 1
a1436 2
_VMEM_UNLOCK+=		ulimit -d $$(ulimit -H -d);
_VMEM_UNLOCK+=		ulimit -m $$(ulimit -H -m);
d2522 1
a2522 1
	@@ulimit -d $$(ulimit -H -d); ulimit -m $$(ulimit -H -m); \
@


1.274
log
@unbreak after cid 1004B61A9B525E85DF5 - OpenBSD ports use a
non-POSIX construct here
@
text
@d2909 3
@


1.273
log
@argh, wildcards!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.272 2010/01/09 18:34:00 tg Exp $
d1984 3
a1986 2
				if ! set -- $$(grep -i "^$$cipher ($$file)" \
				    $$checksum_file); then \
@


1.272
log
@use mpcc/mpcxx for non-gcc CC/CXX and mpgcc/mpg++ for gcc CC/CXX
so that people using substring matches on ${CC} etc. workâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.271 2009/12/28 14:55:12 tg Exp $
d1244 1
d1249 2
a1250 2
		[[ $${s[0]} = ${OStype} ]] || continue; \
		[[ $${s[2]} = @@(${ARCH}|${MACHINE_ARCH}) ]] || continue; \
d1260 1
a1260 1
			[[ $${s[1]} = ${OSREV} ]] || continue; \
d1277 1
@


1.271
log
@speed up recursive ops by use of .MAKEFLAGS (not MAKEFLAGS like TNF,
since our make is different, apparently)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.270 2009/12/20 12:34:58 tg Exp $
d473 9
a481 2
_PASS_CC=		${WRKDIR}/bin/mpcc
_PASS_CXX=		${WRKDIR}/bin/mpcxx
d2132 1
a2132 1
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CC:Q} '"$$@@"' >${WRKDIR}/bin/mpcc
d2134 1
a2134 1
	@@print '#!'${MKSH:Q}'\nexit 1' >${WRKDIR:Q}/bin/mpcxx
d2136 1
a2136 1
	@@print '#!'${MKSH:Q}'\nexec' ${_USE_CXX:Q} '"$$@@"' >${WRKDIR}/bin/mpcxx
d2138 1
a2138 1
	@@chmod ${BINMODE} ${WRKDIR}/bin/mp{cc,cxx}
d2307 1
a2307 1
	ln -sf ${WRKDIR}/bin/mpcc ${WRKDIR}/bin/cc
@


1.270
log
@new ã€Œdump='foo bar'ã€ target, like show, but can be evalâ€™d in shell
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.269 2009/12/12 23:48:51 tg Exp $
d1849 1
d1851 2
d2832 1
d2835 2
@


1.269
log
@make ONLY_FOR_PLATFORM (but not NOT_FOR_PLATFORM as it's illogical)
OSver-aware (major.minor)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.268 2009/12/06 19:26:59 tg Exp $
d126 6
@


1.268
log
@since the old one was broken, use a new one
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.267 2009/12/06 19:26:01 tg Exp $
a1230 1
	test="${OStype}:${OSREV}:${ARCH} ${OStype}:${OSREV}:${MACHINE_ARCH}"; \
d1232 18
a1249 3
		for platform in $$test; do \
			eval [[ $$platform != $$match ]] || ok=1; \
		done; \
d1254 1
a1254 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSREV}:${ARCH}"
d1256 1
a1256 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSREV}:${ARCH} (${MACHINE_ARCH})"
@


1.267
log
@fix @@tag dep cxx
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.266 2009/11/22 20:34:40 tg Exp $
d1545 1
a1545 1
	echo "@@comment @@tag dep cxx" >>$@@.tmp
@


1.266
log
@prepare for xz, as port or in base
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.265 2009/11/22 15:34:11 tg Exp $
d1544 1
a1544 1
.if ${NO_CXX:L} != "no"
@


1.265
log
@support for the upcoming XZ Utils compression
planned for long, prodded by bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.264 2009/11/21 20:27:33 tg Exp $
d1073 3
a1075 2
#XXX or in base!
#BUILD_DEPENDS+=	:xz-*:archivers/xz
@


1.264
log
@provide ${AWK}
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.263 2009/11/21 16:44:31 tg Exp $
d923 3
a925 1
.  if defined(_CVS_DISTF${_i:N-}) && (${MCZ_FETCH:L} == "lzma")
d1028 4
d1038 1
d1072 10
@


1.263
log
@â€¢ attempt to lay ground for an m4 MODULE
â€¢ devel/autoconf/2.63: use it
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.262 2009/10/17 21:51:42 tg Exp $
d517 1
@


1.262
log
@new cool variable VMEM_AUTOUNLOCK including documentation
inspired by pkgsrcÂ® which does this automagically and always, IIRC
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.261 2009/09/12 12:04:42 tg Exp $
d517 1
a802 1
M4?=			/usr/bin/m4
@


1.261
log
@replace perl script with something readable
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.260 2009/08/30 18:24:15 tg Exp $
d1383 1
d1386 6
d2307 2
a2308 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} pre-build
d2312 2
a2313 1
	@@${MOD${_c:U}_pre_build}
d2317 2
a2318 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-build
d2321 2
a2322 1
	@@cd ${WRKBUILD} && exec ${_SYSTRACE_CMD} ${SETENV} ${MAKE_ENV} \
d2327 2
a2328 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} post-build
@


1.260
log
@typo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.259 2009/08/30 11:32:36 tg Exp $
d1284 3
a1286 3
	check=$$(eval $$listlibs | perl \
	    ${PORTSDIR}/infrastructure/scripts/resolve-lib ${_resolve_lib_args} $$d) \
	    || true
@


1.259
log
@unlimit data and memory size for the call to pkg_create, because lzma
compression eats up insane amounts of it (>=311 MiB)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.258 2009/08/29 12:44:04 tg Exp $
d2459 1
a2459 1
	@@ulimit -d $(ulimit -H -d); ulimit -m $(ulimit -H -m); \
@


1.258
log
@quote MAKE_FILE
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.257 2009/08/16 17:25:49 tg Exp $
d2459 2
a2460 1
	@@cd ${.CURDIR} && if ${SUDO} ${SETENV} PATH=${PKG_CMDDIR:Q}:$$PATH \
@


1.257
log
@add VSN to default SUBST_VARS
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.256 2009/08/16 17:20:53 tg Exp $
d1351 1
a1351 1
			    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} obj
d1355 1
a1355 1
			    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} depend
d2312 1
a2312 1
	    ${MAKE_PROGRAM} ${MAKE_FLAGS} -f ${MAKE_FILE} ${ALL_TARGET}
d2332 1
a2332 1
	    ${MAKE_PROGRAM} ${REGRESS_FLAGS} -f ${MAKE_FILE} ${REGRESS_TARGET}
d2382 1
a2382 1
	    ${MAKE_PROGRAM} ${FAKE_FLAGS} -f ${MAKE_FILE} ${FAKE_TARGET}
@


1.256
log
@append EXTRA_MAKE_FLAGS, EXTRA_FAKE_FLAGS, EXTRA_XAKE_FLAGS to
MAKE_FLAGS, FAKE_FLAGS, MAKE_FLAGS and FAKE_FLAGS, respectively,
after MODULES (like gnu.port.mk) have run, so that the user can
always override them

(?AKE_FLAGS are for infrastructure, EXTRA_?AKE_FLAGS for Makefiles)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.255 2009/08/16 16:27:08 tg Exp $
d681 1
a681 1
			FLAVOUR_EXT RESPONSIBLE
@


1.255
log
@change
â€¢ _PASS_CC back from ã€Œmpccã€ to ã€Œ${WRKDIR}/bin/mpccã€ (note that the
  former ã€Œ${WRKDIR:Q}/bin/mpccã€ was wrong)
â€¢ all uses of _PASS_CC to either
  â€£ ${_PASS_CC:T:Q} (when passing, e.g. for libtool â€“ this is for use
    when ${WRKDIR}/bin is in $$PATH)
  â€£ ${_PASS_CC:Q} (when invoking, e.g. in post-build targets â€“ only
    these I saw when mechanically doing this; Benny wants to fix the
    remaining ones; I shouldâ€™ve introduced no more breakage than was)
â€¢ _PASS_CXX/mpcxx just the same

agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.254 2009/06/22 12:07:30 tg Exp $
a235 4
EXTRA_XAKE_FLAGS+=	SHELL=${SHELL:Q}
MAKE_FLAGS+=		${EXTRA_MAKE_FLAGS} ${EXTRA_XAKE_FLAGS}
FAKE_FLAGS+=		${EXTRA_FAKE_FLAGS} ${EXTRA_XAKE_FLAGS}

d544 4
@


1.254
log
@unify font setup; make sure that the other half of fucking modern X,
namely fuck fontconfig, finds them too
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.253 2009/06/18 20:55:36 tg Exp $
d231 1
a231 1
MAKE_FLAGS?=		CC=${_PASS_CC:Q}
d471 2
a472 4
#_PASS_CC=		${WRKDIR:Q}/bin/mpcc
#_PASS_CXX=		${WRKDIR:Q}/bin/mpcxx
_PASS_CC=		mpcc
_PASS_CXX=		mpcxx
d477 2
a478 2
CC=			${_PASS_CC}
CXX=			${_PASS_CXX}
d486 2
a487 2
			CC=${_PASS_CC:Q} LDFLAGS=${LDFLAGS:Q} ${DESTDIRNAME}= \
			CXX=${_PASS_CXX:Q} CFLAGS=${CFLAGS:M*:Q} \
d1364 2
a1365 2
			ac_cv_path_CC=${_PASS_CC:Q} ac_cv_path_CXX=${_PASS_CXX:Q} \
			CC=${_PASS_CC:Q} CFLAGS="$$(print -nr -- ${CFLAGS:Q} | \
d1368 1
a1368 1
			CXX=${_PASS_CXX:Q} CXXFLAGS="$$(print -nr -- ${CXXFLAGS:Q} | \
@


1.253
log
@fix mmake clean with CLEANDEPENDS=yes and flavours
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.252 2009/05/24 19:51:40 tg Exp $
d684 3
@


1.252
log
@bsiegert@@ broke 'FLAVOUR="aa caca" mmake fake' by missing quoting, fix
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.251 2009/05/11 12:30:59 bsiegert Exp $
d2582 2
a2583 1
	@@${MAKE} all-dir-depends | tsort -rq | while read dir; do \
d2588 1
a2588 1
.else
a2655 1
.endif
@


1.251
log
@Add a new veriable called SUBST_CMD. It has the same syntax as OpenBSD's,
the -c option is not supported though.

${SUBST_CMD} file ...

will replace all SUBST_VARS in the file.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.250 2009/03/31 19:33:49 bsiegert Exp $
d2390 2
a2391 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} env FLAVOUR=${FLAVOUR} \
@


1.250
log
@explicitly pass FLAVOUR to the "post-install" target via env. Fixes
build of subversion w/ bsddb flavour on Mac OS for me.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.249 2009/03/29 13:04:05 tg Exp $
d692 5
@


1.249
log
@â€¢ take care of dbins
â€¢ #!/bin/mksh shebang, in most places
â€¢ rcsid while here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.248 2009/02/01 12:02:07 bsiegert Exp $
d2385 1
a2385 1
	@@cd ${.CURDIR} && exec ${SUDO} ${_SYSTRACE_CMD} \
@


1.248
log
@Fix schily configure style on Darwin/i386 by adding a relevant .rul file
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.247 2009/01/03 20:45:38 bsiegert Exp $
d2241 1
@


1.247
log
@bsd.port.mk: Implement ${MODFOO_post-fake}, which is run just before
the "post-install" target, if any.

perl.port.mk: In post-fake, remove .packlist file and prune empty directories
under P5ARCH, including maybe P5ARCH itself. Thus, no more manually editing
PLIST files for perl module ports!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.246 2008/12/07 20:32:24 tg Exp $
d2242 1
d2244 1
a2244 2
	ln -s ${WRKDIR}/bin/mpcc ${WRKDIR}/bin/cc
	chmod ${BINMODE} ${WRKDIR}/bin/uname
d2249 4
@


1.246
log
@* modularise patching the cc spec
* depend the spec on <bsd.port.mk> itself
* patch it so that -lmirmake is always added to final (executable,
  but not shlib) links on Darwin and MidnightBSD, because for in-
  stance, Mirzilla Firetapir needs libmirmake for SHA-2 functions
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.245 2008/12/07 18:17:18 tg Exp $
d2374 5
@


1.245
log
@new "mmake homepage" == ${BROWSER:-lynx} "$(mmake show=HOMEPAGE)"
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.244 2008/11/29 14:35:27 tg Exp $
a1246 4
#.if exists(${.SYSMK}/libmirmake.a)
#LDFLAGS+=		-Wl,--library-after=${.SYSMK} -lmirmake
#.endif

d2767 1
a2767 6
${LOCALBASE}/db/specs.${_ORIG_CC:S!/!_!g}: ${CC_SPECS}
	@@if ! t=$$(mktemp /tmp/XXXXXXXXXXXX); then \
		print -u2 Error: cannot make temporary file; \
		exit 1; \
	fi; \
	${_ORIG_CC} -dumpspecs >$$t; \
d2769 1
a2769 1
		print 'g!/usr/bin/libtool!s!!${LOCALBASE}/db/libtool!g\nwq' | \
d2777 12
d2790 2
@


1.244
log
@* check USE_COMPILER for invalid values
* add special "tags" to the generated binary packages to list
  - permits (ftp, cdrom)
  - implicit dependencies (compiler, x11)
  which are to be parsed by the package list generation script
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.243 2008/11/11 20:41:05 tg Exp $
d3332 7
d3401 1
a3401 1
	full-run-depends homepage-links install install-binpkg \
@


1.243
log
@with -O2, this thing goes past the boundaries of ulimits even after
unlocking _all_ of them to the max on i386â€¦ so use -O1 which helpsâ€¦ some.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.242 2008/11/11 02:50:07 tg Exp $
d440 2
d1509 13
@


1.242
log
@use lzmadec not lzma to decompress; mention PKG_SUFX while here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.241 2008/11/10 20:38:16 tg Exp $
d408 1
a408 1
_DEFCOPTS_llvm?=	-O2 -Wformat -fno-strict-aliasing -fwrapv
@


1.241
log
@hm, -std=gnu99 is added otherwhere, but -Wformat is useful

XXX llvm-gfortran could be used nowâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.240 2008/11/10 20:34:55 tg Exp $
d1051 1
a1051 1
	lzma -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;		\
d1053 1
a1053 1
	lzma -dc ${FULLDISTDIR}/$$archive >$$(basename $$archive .lzma) ;;
@


1.240
log
@allow USE_COMPILER=llvm now
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.239 2008/11/10 01:59:21 tg Exp $
d408 1
a408 1
_DEFCOPTS_llvm?=	-O2 -fno-strict-aliasing -fwrapv -std=gnu99
@


1.239
log
@if using pcc, we want blazingly fast compiles, so skip the indirection
around a shell script, which does hard-coded stuff anyway since we donâ€™t
do ccache with pccâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.238 2008/11/10 01:43:57 tg Exp $
d407 3
a431 1
_DEFCOPTS_pcc?=		-O
d435 5
@


1.238
log
@do not bitch about circular dependencies in tsort(1)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.237 2008/11/10 01:41:00 tg Exp $
d466 4
@


1.237
log
@new: USE_COMPILER?=system
support: USE_COMPILER=pcc
planned: USE_COMPILER=llvm # and others, egcc?

Happy Birthday, ssimon!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.236 2008/11/02 19:21:31 tg Exp $
d2544 1
a2544 1
	@@${MAKE} all-dir-depends | tsort -r | while read dir; do \
d2974 1
a2974 1
	@@${MAKE} ${_i}-dir-depends | tsort -r | sed -e '$$d' \
d2982 1
a2982 1
	@@${MAKE} ${_i}-dir-depends | tsort -r | sed -e '$$d' \
d2993 1
a2993 1
	@@${MAKE} all-dir-depends | tsort -r | sed -e '$$d' \
@


1.236
log
@typo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.235 2008/11/02 17:29:28 tg Exp $
d425 11
a435 2
_USE_CC:=		${CC}
_USE_CXX:=		${CXX}
@


1.235
log
@optimise: â€œ${_i:S/-//}â€ â‡’ â€œ${_i:N-}â€
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.234 2008/11/02 17:26:05 tg Exp $
d304 1
a304 1
,    undef CVS_DISTREPO${_i:N-}
@


1.234
log
@introduce and document new variable MCZ_FETCH
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.233 2008/11/02 14:49:36 tg Exp $
d289 4
a292 4
.  if defined(SVN_DISTPATH${_i:S/-//}) && !empty(SVN_DISTPATH${_i:S/-//})
SVN_DISTDIR${_i:S/-//}?=${SVN_DISTPATH${_i:S/-//}:T}
.    if !defined(SVN_DISTFILE${_i:S/-//}) || empty(SVN_DISTFILE${_i:S/-//}) 
SVN_DISTFILE${_i:S/-//}=${SVN_DISTDIR${_i:S/-//}:T}
d294 1
a294 1
SVN_DISTREV${_i:S/-//}?=1
d296 1
a296 1
MASTER_SITES${_i:S/-//}?=${_MASTER_SITE_MIRBSD}
d298 1
a298 1
.  elif defined(CVS_DISTREPO${_i:S/-//}) && !empty(CVS_DISTREPO${_i:S/-//})
d300 1
a300 1
MASTER_SITES${_i:S/-//}?=${_MASTER_SITE_MIRBSD}
d303 2
a304 2
.    undef SVN_DISTPATH${_i:S/-//}
,    undef CVS_DISTREPO${_i:S/-//}
d857 7
a863 7
.  undef _CVS_DISTF${_i:S/-//}
.  if defined(CVS_DISTREPO${_i:S/-//})
CVS_DISTFILE${_i:S/-//}?=${CVS_DISTMODS${_i:S/-//}}
_CVS_DISTF${_i:S/-//}=	${CVS_DISTFILE${_i:S/-//}}-
.    if defined(CVS_DISTTAGS${_i:S/-//})
.      for _j in ${CVS_DISTTAGS${_i:S/-//}:C![^0-9a-zA-Z_-]!!g}
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}T${_j}-
d866 3
a868 3
.    if defined(CVS_DISTDATE${_i:S/-//})
.      for _j in ${CVS_DISTDATE${_i:S/-//}:C![^0-9]!!g}
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}${_j}
d871 2
a872 2
.    if defined(CVS_DISTTAGS${_i:S/-//}) || defined(CVS_DISTDATE${_i:S/-//})
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}:S/-$//}.mcz
d874 1
a874 1
ERRORS+=		"neither CVS_DISTDATE${_i:S/-//} nor CVS_DISTTAGS${_i:S/-//} defined"
d876 1
a876 1
_CVS_FETCH${_i:S/-//}=	${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz \
d878 5
a882 5
			    ${FULLDISTDIR:Q}/${_CVS_DISTF${_i:S/-//}:Q} \
			    '${CVS_DISTREPO${_i:S/-//}}' \
			    '${CVS_DISTDATE${_i:S/-//}}' \
			    '${CVS_DISTTAGS${_i:S/-//}}' \
			    ${CVS_DISTMODS${_i:S/-//}:Q}
d884 3
a886 3
.  elif defined(SVN_DISTPATH${_i:S/-//})
_CVS_DISTF${_i:S/-//}=	${SVN_DISTFILE${_i:S/-//}}-r${SVN_DISTREV${_i:S/-//}}.mcz
_CVS_FETCH${_i:S/-//}=	${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz \
d888 4
a891 4
			    ${FULLDISTDIR:Q}/${_CVS_DISTF${_i:S/-//}:Q} \
			    ${SVN_DISTPATH${_i:S/-//}:Q} \
			    ${SVN_DISTREV${_i:S/-//}:Q} \
			    ${SVN_DISTDIR${_i:S/-//}:Q}
d894 2
a895 2
.  if defined(_CVS_DISTF${_i:S/-//}) && (${MCZ_FETCH:L} == "lzma")
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}.lzma
d936 2
a937 2
.  if defined(_CVS_DISTF${_i:S/-//})
_DISTFILES+=		${_CVS_DISTF${_i:S/-//}}
d2437 2
a2438 2
.    if defined(_CVS_FETCH${_i:S/-//}) && ${REFETCH} != "true"
${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}:
d2444 1
a2444 1
	@@[[ -e ${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}} ]] || { \
d2447 1
a2447 1
		    ${_CVS_FETCH${_i:S/-//}}; \
d2451 1
a2451 1
			${ECHO_MSG} ">> No checksum file for ${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}"; \
d2455 1
a2455 1
			${ECHO_MSG} ">> Size matches for ${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}"; \
d2457 1
a2457 1
			${ECHO_MSG} ">> Size does not match for ${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}"; \
d2461 1
a2461 1
			${ECHO_MSG} ">> No size recorded for ${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}"; \
@


1.233
log
@allow use of TMPDIR to tell different place for .mcz creation
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.232 2008/11/02 03:51:16 tg Exp $
d287 1
d295 10
d312 1
a312 1
.elif defined(CVS_DISTREPO) && !empty(CVS_DISTREPO)
d315 1
a315 2
MASTER_SITES?=		${_MASTER_SITE_MIRBSD}
.elif defined(SVN_DISTPATH) && !empty(SVN_DISTPATH)
d857 2
a858 1
.  if defined(CVS_DISTREPO${_i:S/-//}) && !empty(CVS_DISTREPO${_i:S/-//})
d884 1
a884 1
.  elif defined(SVN_DISTPATH${_i:S/-//}) && !empty(SVN_DISTPATH${_i:S/-//})
d894 3
d901 1
d903 1
d910 1
d912 1
d1030 1
a1030 1
    *.tar.lzma | *.tlz | *.cpio.lzma | *.clz)				\
d1117 2
a1118 1
.if defined(_CVS_DISTF) || (${FETCH_MANUALLY:L} != "no")
d2435 3
a2437 2
.for _i in - 0 1 2 3 4 5 6 7 8 9
.  if defined(_CVS_FETCH${_i:S/-//}) && ${REFETCH} != "true"
d2464 3
a2466 2
.  endif
.endfor
@


1.232
log
@ha, or so I thought. fix this, ?= not =
also, the variable name is just too freaking long
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.231 2008/11/02 03:22:59 tg Exp $
d2426 2
a2427 1
		PATH=${_PORTPATH} ${_CVS_FETCH${_i:S/-//}}; \
@


1.231
log
@allow conditionalising on installer, in order to no longer require
packages who interleave building and installing (omniORB, llvm) to
be built as nÅn-root

XXX find a way to ensure the perms in the package are okay
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.230 2008/11/01 23:43:57 tg Exp $
d1319 1
a1319 1
MODSIMPLE_given_INSTALL=${INSTALL} -c -o ${BINOWN} -g ${BINGRP}
@


1.230
log
@pass CXXFLAGS like CFLAGS, but only if USE_CXX; quote properly
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.229 2008/11/01 22:57:22 tg Exp $
d1319 1
d1329 3
a1331 3
			INSTALL='/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}' \
			ac_given_INSTALL='/usr/bin/install -c -o ${BINOWN} \
			    -g ${BINGRP}' INSTALL_SCRIPT=${INSTALL_SCRIPT:Q} \
@


1.229
log
@implement and document SVN_DISTFILE fetch method (re-using _CVS_DISTF
stuff) after, what, like two years?
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.228 2008/10/16 19:06:40 tg Exp $
d456 2
a457 2
			CC=${_PASS_CC:Q} CXX=${_PASS_CXX:Q} CFLAGS=${CFLAGS:M*:Q} \
			LDFLAGS=${LDFLAGS:Q} ${DESTDIRNAME}= \
d460 3
d1321 1
a1321 1
			CC=${_PASS_CC:Q} CFLAGS="$$(print -nr -- '${CFLAGS}' | \
d1324 1
a1324 1
			CXX=${_PASS_CXX:Q} CXXFLAGS="$$(print -nr -- '${CXXFLAGS}' | \
@


1.228
log
@nÅn-existent files shall not abort recursing through master sites
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.227 2008/10/14 19:41:06 tg Exp $
d287 10
d301 1
a301 1
.elif defined(CVS_DISTMODS) && !empty(CVS_DISTMODS)
d305 3
d842 1
d844 1
a844 1
.  if defined(CVS_DISTREPO${_i:S/-//})
d869 10
d883 2
a884 2
.if defined(_CVS_DISTF)
FETCH_DEPENDS+=		:mpczar->=20061119:archivers/mpczar
d886 1
d888 4
@


1.227
log
@link only if existing
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.226 2008/10/13 21:22:54 tg Exp $
d1363 1
a1363 1
_size_fragment=		stat -f 'SIZE (%N) = %z' $$file
d1365 1
a1365 1
_size_fragment=		${CKSUM_CMD} -a size $$file
d1367 1
a1367 1
_size_fragment=		print "SIZE ($$file) =" $$(wc -c <"$$file")
@


1.226
log
@change the name of the db/specs file to match the compiler name,
for use of multiple compilers

Reason: Iâ€™m trying
tglaser@@anakin:~/mirports/devel/glib1 $ mmake CC=/Developer/usr/bin/llvm-gcc CXX=/Developer/usr/bin/llvm-gxx
because normal Apple gcc in Leopard has broken inliningâ€¦ *sigh*
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.225 2008/10/12 15:25:16 tg Exp $
d1914 1
d1921 1
@


1.225
log
@one backslash-newline too muchâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.224 2008/10/12 14:01:16 tg Exp $
d1978 1
a1978 1
${_WRKDIR_COOKIE}: ${LOCALBASE}/db/specs
d2679 1
a2679 1
${LOCALBASE}/db/specs: ${CC_SPECS}
@


1.224
log
@Support for
â€¢ *.tar.Z and older *.tar.z and *.taz
â€¢ *.cpio.Z and older *.cpio.z
â€¢ *.ngz
â€¢ older *.shar.z, *.sh.z
â€¢ *.Z and older *.z
â€¢ *.uu.gz and *.uu.Z and older *.uu.z
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.223 2008/10/12 13:57:01 tg Exp $
d967 1
a967 2
	${BZIP2} -dc ${FULLDISTDIR}/$$archive				\
	    >$$(basename $$archive .bz2) ;;				\
d983 1
a983 2
	lzma -dc ${FULLDISTDIR}/$$archive				\
	    >$$(basename $$archive .lzma) ;;				\
@


1.223
log
@sort and introduce some whitespace, no textual changes
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.222 2008/10/12 13:56:07 tg Exp $
d996 2
a997 1
    *.tar.gz | *.t.gz | *.tgz | *.cpio.gz | *.cgz | *.mcz)		\
d1001 1
a1001 1
    *.shar.gz | *.shar.Z | *.sh.gz | *.sh.Z)				\
d1006 1
a1006 1
    *.gz)								\
d1011 2
@


1.222
log
@add *.bz2 and *.lzma support (same as *.gz: just decompress/copy)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.221 2008/10/12 13:53:12 tg Exp $
a934 3
.if !empty(EXTRACT_ONLY:M*.zip)
_USE_ZIP?=		Yes
.endif
d947 3
a949 1
_USE_ZIP?=		No
d953 1
d960 1
a960 6
.if ${_USE_ZIP:L} != "no"
BUILD_DEPENDS+=		:unzip-*:archivers/unzip
EXTRACT_CASES+=		\
    *.zip) \
	${UNZIP} -q ${FULLDISTDIR}/$$archive -d ${WRKDIR} ;;
.endif
d970 1
d977 1
d987 8
d1015 1
@


1.221
log
@â€¢ bsd.port.mk: improve heuristics for bzip2 distfile detection
â€¢ bsd.port.mk: add LHarc (*.lzh/*.LZH but also *.lha seen)
  detection and handling
â€¢ bsd.port.mk: add LZMA (with tar and cpio) detection and handling
â€¢ bsd.port.mk: add jar/pdf/txi (simple copy) and uudecode handling
â€¢ all: fold some of the more common cases into bsd.port.mk
â€¢ pawn: adjust for WRKDIST vs WRKDIR difference

XXX some of the archives, especially plan9/*, now have a slightly
XXX different extract using ${_PERL_FIX_SHAR} â€“ Benny, please see
XXX if that broke anything
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.220 2008/10/12 13:35:04 tg Exp $
d938 2
a939 2
.if !empty(EXTRACT_ONLY:M*.tar.bz2) || !empty(EXTRACT_ONLY:M*.tbz) || \
    !empty(EXTRACT_ONLY:M*.cpio.bz2) || !empty(EXTRACT_ONLY:M*.cbz) || \
d946 2
a947 2
.if !empty(EXTRACT_ONLY:M*.tar.lzma) || !empty(EXTRACT_ONLY:M*.tlz) || \
    !empty(EXTRACT_ONLY:M*.cpio.lzma) || !empty(EXTRACT_ONLY:M*.clz)
d969 5
a973 2
    *.tar.bz2 | *.tbz | *.cpio.bz2 | *.cbz) \
	${BZIP2} -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
d984 5
a988 2
    *.tar.lzma | *.tlz | *.cpio.lzma | *.clz) \
	lzma -dc ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
@


1.220
log
@beautify EXTRACT_CASES and add missing .tbz, .tgz
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.219 2008/10/10 20:06:14 tg Exp $
d938 3
a940 2
.if !empty(EXTRACT_ONLY:M*.tar.bz2) \
    || (defined(PATCHFILES) && !empty(_PATCHFILES:M*.bz2))
d943 7
d952 2
d972 12
d985 1
a985 1
    *.tar.gz | *.tgz | *.cpio.gz | *.cgz | *.mcz)			\
d992 1
a992 1
    *.shar | *.sh)							\
d997 4
@


1.219
log
@people will say now, bsiegert@@ was right, but I disagree.

Work around devel/mercurial breakage (and some others) by hiding it.
These ports VIOLATE THE POLICY by not honouring ${CC}. The wÃ¼rgaround
(yes, itâ€™s not pretty) is to use the basename of the compiler script.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.218 2008/10/05 17:53:33 tg Exp $
d952 3
a954 2
EXTRACT_CASES+=		*.zip) ${UNZIP} -q ${FULLDISTDIR}/$$archive \
			    -d ${WRKDIR};;
d958 19
a976 15
EXTRACT_CASES+=		*.tar.bz2 | *.cpio.bz2 | *.cbz) ${BZIP2} -dc \
			    ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
.endif
EXTRACT_CASES+=		*.tar | *.cpio) ${TAR} xf ${FULLDISTDIR}/$$archive ;;
EXTRACT_CASES+=		*.shar.gz|*.shar.Z|*.sh.gz|*.sh.Z) ${GZIP_CMD} -dc \
			    ${FULLDISTDIR}/$$archive | ${_PERL_FIX_SHAR} \
			    | ${SH} ;;
EXTRACT_CASES+=		*.shar | *.sh) ${_PERL_FIX_SHAR} \
			    ${FULLDISTDIR}/$$archive | ${SH} ;;
EXTRACT_CASES+=		*.tar.gz | *.cpio.gz | *.cgz | *.mcz) ${GZIP_CMD} -dc \
			    ${FULLDISTDIR}/$$archive | ${TAR} xf - ;;
EXTRACT_CASES+=		*.gz) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive \
			    >$$(basename $$archive .gz) ;;
EXTRACT_CASES+=		*) ${GZIP_CMD} -dc ${FULLDISTDIR}/$$archive \
			    | ${TAR} xf - ;;
@


1.218
log
@facilitate ports ccache cache dir shareing
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.217 2008/10/05 17:11:55 tg Exp $
d430 4
a433 2
_PASS_CC=		${WRKDIR:Q}/bin/mpcc
_PASS_CXX=		${WRKDIR:Q}/bin/mpcxx
@


1.217
log
@prevent people from using buggy versions of ccache
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.216 2008/10/05 14:50:37 tg Exp $
d413 2
a414 1
_USE_CC:=		env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${_USE_CC}
d416 2
a417 1
_USE_CXX:=		env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${_USE_CXX}
@


1.216
log
@new configure style ã€ˆbmakeã€‰
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.215 2008/10/04 18:37:31 tg Exp $
d409 1
a409 1
CCACHE_DEPENDS?=	::devel/ccache
@


1.215
log
@fix the ccache thing as discusses:
we now always use
_PASS_CC=	/usr/ports/security/pgp+/w-pgp-2.6.3in-3/bin/mpcc
_PASS_CXX=	/usr/ports/security/pgp+/w-pgp-2.6.3in-3/bin/mpcxx
for compilation; the new _ORIG_CC and _ORIG_CXX are saved (_ORIG_CXX is
even not set to false) and used for Darwin spec file generation (Benny,
please test if this works); Systrace doesnâ€™t bitch; and we now have two
_USE_CC and _USE_CXX variables wich contain what is actually written in
the mpcc and mpcxx files. All six of these are internal, but a Makefile
shouldâ„¢ use _PASS_CC and _PASS_CXX ipv CC and CXX, so that things still
will work when the user overrides CC via the command line (but it works
if he doesnâ€™t already)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.214 2008/09/23 19:56:31 bsiegert Exp $
d1222 12
d2158 5
@


1.214
log
@Change the way ccache support is implemented, due to too many problems.
WRKDIR/bin/mgcc is now a symlink to LOCALBASE/bin/ccache, the dir is set in
{CONFIGURE,MAKE}_ENV. All support is now a module.

Needs to be tested on a platform with systrace.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.213 2008/09/21 14:18:21 bsiegert Exp $
d231 1
a231 1
MAKE_FLAGS?=		CC=${CC:Q}
d400 4
d405 1
a405 1
CXX:=			false
d409 15
a423 1
MODULES+=		devel/ccache
d426 7
d439 1
a439 1
			CC=${CC:Q} CXX=${CXX:Q} CFLAGS=${CFLAGS:M*:Q} \
a477 6
.if !empty(WRKOBJDIR_${PKGPATH})
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOUR_EXT2}
.else
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOUR_EXT2}
.endif

d1228 2
a1229 2
			ac_cv_path_CC=${CC:Q} ac_cv_path_CXX=${CXX:Q} \
			CC=${CC:Q} CFLAGS="$$(print -nr -- '${CFLAGS}' | \
d1232 1
a1232 1
			CXX=${CXX:Q} CXXFLAGS="$$(print -nr -- '${CXXFLAGS}' | \
d1355 1
a1355 1
. if ${USE_CCACHE:L} == "yes"
d1360 1
a1360 1
. endif
d1925 7
d2098 2
a2099 2
	print '#!${SHELL}\nexec ${CC} "$$@@"' >${WRKDIR}/bin/cc
	chmod ${BINMODE} ${WRKDIR}/bin/*
d2602 4
a2605 4
.  if exists(${CC})
CC_SPECS=	${CC}
.  elif exists(/usr/bin/${CC})
CC_SPECS=	/usr/bin/${CC}
d2607 2
a2608 1
CC_SPECS!=	which ${CC:Q} 2>&- || which $$(echo ${CC:Q}|sed 's/ .*//') 2>&-
d2619 1
a2619 1
	${CC} -dumpspecs >$$t; \
d2624 1
a2624 1
		reallinker=$$(${CC} -print-prog-name=collect2); \
d2626 1
a2626 1
		    reallinker=$$(${CC} -print-prog-name=ld); \
@


1.213
log
@Move added systrace policy lines for ccache inside the loop so that it works
for all the binaries, not only make.
Fixes ccache on MirOS.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.212 2008/09/17 20:05:36 tg Exp $
d405 1
a405 7
CCACHE_DEPENDS?=	::devel/ccache
BUILD_DEPENDS+=		${CCACHE_DEPENDS}
CCACHE_DIR?=		${HOME}/.etc/ccache
CC:=			env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${CC}
.  if ${NO_CXX:L} == "no"
CXX:=			env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${CXX}
.  endif
@


1.212
log
@only overwrite links if they do not exist

XXX bad idea, I originally did not do this for consistency reasons, but
XXX with a read-only distfile areaâ€¦ I'd probably better use ${CDROM_SITE}
XXX instead though, or try to re-link anyway (maybe unless R/O)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.211 2008/09/11 21:34:41 tg Exp $
d1342 1
a1342 2
.endfor
.if ${USE_CCACHE:L} == "yes"
d1347 2
a1348 1
.endif
@


1.211
log
@clean up after the mac fanboy bsiegert@@:
â€¢ allow for safer regeneration of index (my system is still authoritativeâ˜º)
â€¢ we use ${FOO:L} == "yes" for boolean checks, not ${FOO:L:Myes}â€¦ since the
  value "yes no" can fool (for the same reasons, some variables are checked
  ==yes and !=yes while others are checked ==no and !=no but *no* variables
  are checked ==yes and ==no or soâ€¦)
â€¢ the USE_CXX check is â‘  bogus and â‘¡ too early; move the entire block of if
  USE_CCACHE to much further below when CXX and NO_CXX have been determined
â€¢ no package, not even your beloved ccache, can (build-)depend on itself
â€¢ didnâ€™t we decide ${HOME}/.etc/ccache is a much nicer place for that stuff
  than ${HOME}/.ccache ? (XXX fix this in the port too, for default?)
â€¢ make overriding ${CCACHE_DIR} work at all (with systrace)
â€¢ clean up the ccache port Makefile after the mac fanboy tyler@@ while hereâ€¦
  XXX CONFIGURE_STYLE=gnu is almost always wrong (editors/joe and all auto-
  XXX conf/automake ports themselves being notable exceptions, and a couple
  XXX of ports, like GNU m4, on e.g. Interix)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.210 2008/09/11 20:50:56 bsiegert Exp $
d1840 2
a1841 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/CDROM/${_i} 2>&- || \
d1846 2
a1847 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/FTP/${_i} 2>&- || \
@


1.210
log
@Add support for ccache using USE_CCACHE=Yes. CCACHE_DIR is overridable via
mmake.cfg. tg@@: .if make(describe) does not work for some reason. Thus: Don't
regenerate the index if you have USE_CCACHE=Yes.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.209 2008/09/09 19:21:41 tg Exp $
a352 11
.if ${USE_CCACHE:L:Myes}
. if !make(describe)
BUILD_DEPENDS+=		::devel/ccache
. endif
CCACHE_DIR?=		${HOME}/.ccache
CC:=			env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${CC}
. if ${USE_CXX:L:Myes}
CXX:=			env CCACHE_DIR=${CCACHE_DIR:Q} ccache ${CXX}
. endif
.endif

d404 10
d1346 1
a1346 1
		    "\"$$HOME/.ccache\" then permit"; \
@


1.209
log
@amend by USE_CCACHE=No and allow systrace if set to Yes
no more actions, bsiegert@@ will do thatâ€¦ tonnerre persuaded him

I still donâ€™t trust it, but I want distcc for my SPARC cluster
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.208 2008/08/27 07:31:41 tg Exp $
d353 11
@


1.208
log
@new: NO_LIBTOOLISE_PLIST, to be used to prevent .la files from being
processed on â€œmmake packageâ€

XXX TODO: also make this prevent â€œmmake plistâ€ removing lib symlinks
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.207 2008/08/26 18:38:13 tg Exp $
d349 1
d1333 6
@


1.207
log
@no we don't make a file called whatif-depends
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.206 2008/08/26 17:29:00 tg Exp $
d616 1
d618 1
@


1.206
log
@new target "whatif-depends" to see what would be installed
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.205 2008/06/15 14:52:00 tg Exp $
a1590 1
	@@${_MAKE_COOKIE} $@@
@


1.205
log
@â€œmake distcleanâ€ shall remove the links in /uâ†’/pâ†’/Dâ†’/{CDROM,FTP}/ too
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.204 2008/06/12 19:50:55 tg Exp $
d1541 53
d1596 3
@


1.204
log
@if ã€ŒÂ«PORTDIRÂ»/pkg/DESCRã€ does not exist, use the port directory itself,
not the ã€Œpkgã€ subdirectory, as place for DESCR, PLISTs, and PFRAGs.

bsiegert@@ agreed

XXX the PFRAGs must die, IMHO
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.203 2008/05/03 22:19:36 tg Exp $
d2345 10
@


1.203
log
@rewrite, support mnbsd, process muuuuch better
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.202 2008/05/03 21:58:23 tg Exp $
d219 2
d222 1
a222 1
PKGDIR?=		${.CURDIR}/pkg
@


1.202
log
@ensure uname.sed is only called for mbsd or mnbsd
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.201 2008/05/02 13:40:44 tg Exp $
d1997 1
@


1.201
log
@chmod -R u+w ${WRKDIST} after extracting
(ignore failures in case WRKDIST isnâ€™t set correctly for very new ports)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.200 2008/04/05 23:13:10 tg Exp $
d1995 1
d1998 1
d2000 1
a2000 1
	chmod ${BINMODE} ${WRKDIR}/bin/cc ${WRKDIR}/bin/uname
@


1.200
log
@pass XMKMF=false to configure if USE_X11!=yes
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.199 2008/04/05 21:50:13 tg Exp $
d1851 1
@


1.199
log
@support extra REGRESS_ENV
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.198 2008/03/14 20:19:42 tg Exp $
d1046 2
@


1.198
log
@add new â€œp5â€ module, included implicitly by â€œperlâ€ module
every non-modperl user of ${P5ARCH} *must* now include that
it contains the real fix for darwin-thread-multi-2level and
x86-interix-thread-multiâ€¦ and cleans up the confusion between
i386-midnightbsd and i386-freebsd-64intâ€¦
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.197 2008/03/14 19:13:03 tg Exp $
d2066 1
a2066 1
	@@cd ${WRKBUILD} && exec ${SETENV} ${MAKE_ENV} \
@


1.197
log
@â€¢ bsd.port.mk: expose mksh as SHELL and CONFIG_SHELL to scripts
â€¢ gnu.port.mk: improve dependencies on autoconf
  XXX this is #10 material
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.196 2008/03/14 15:33:53 tg Exp $
a227 1
P5ARCH?=		${P5SITE}/${MACHINE_ARCH}-${OSname}
@


1.196
log
@okay okay, use native cksum+md5 on darwin, cksum+md5+rmd160 on mnbsd+obsd
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.195 2008/03/14 15:25:22 tg Exp $
d969 1
@


1.195
log
@switch cksum logic. either you have a cksum with -a options, which is
recent enough (to include TIGER), or you don't, in which case you can
ONLY use the cksum checksum, no hash, until mircksum is installed
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.194 2008/03/12 23:43:12 tg Exp $
d1274 1
a1274 1
.elif ${HAS_CKSUM:L} != "no"
d1648 5
d1658 7
a1664 2
		cd ${DISTDIR}; OK=true; list=; allciphers="${_CIPHERS}"; \
		[[ ${HAS_CKSUM:L} != no ]] || allciphers=cksum; \
@


1.194
log
@Initial support for running the MirPorts Framework (mirports)
on MidnightBSD (mnbsd), parallel to their native â€œmportsâ€:
â€¢ the test was on stargazer, which is a FreeBSD â€œupgradedâ€ to
  mnbsd, so there may be differences to a real mnbsd-current
â€¢ we do need upgraded MirMake, but I didnâ€™t release that yet,
  since Iâ€™d have to test it first
â€¢ the default MANPATH needs a re-check, like OpenBSD
â€¢ the setup.ksh change installs lndir(1) and a tzfile.h from
  ports/infrastructure/install/ manually; this should be moved
  into MirMake (at least lndir, which is part of XFree86Â®, which,
  in turn, is seen less and less in the public, sadly)
â€¢ builds paxmirabilis (MirCpio), MirPatch, GNU m4, MirCksum,
  lndir (see above), and the MirPackageTools â˜º
â€¢ uses gcc spec file, like Darwin, to call native ld as collect2
  after parsing -Wl,--library-after (XXX why does OpenBSD not
  need this, does it use $PATH to call ld? if so, why none else?)
â€¢ XXX HAS_TIMET64=No on LP64 platforms?
â€¢ XXX does mnbsd not have systrace?

Additional tweaks:
â€¢ bump Â© and stuff
â€¢ use a temporary playpen in LOCALBASE/tmp while upgrading,
  so that pkg_add paxmirabilis*cgz does not need to use tar
  to copy over the new files _after_ removing tarâ€¦
â€¢ use full path to pkg_add when calling it manually
â€¢ resolve possible conflict of a native rmd160(1) while
  bootstrapping GNU m4, when MirCksum is already installed
  XXX remove _CKSUM_SIZE and _CKSUM_A compatibility crap ASAP
â€¢ if collect2 isnâ€™t known by gcc, use ld instead in the wrapper
â€¢ in pkgtools, always link against libmirmake unless OpenBSD/MirBSD
  (XXX in cksum, we always link against it if it exists)
â€¢ XXX possibly remove the dependency of MirCpio to tzfile.h
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.193 2008/03/09 17:22:55 tg Exp $
a351 5
.if defined(BOOTSTRAP)
_CIPHERS=		sha1 md5
.  undef _CKSUM_SIZE
.elif defined(_CKSUM_SIZE)
_CKSUM_SIZE:=1
a352 3
.else
_CIPHERS=		rmd160 sha1 md5
.endif
d1274 2
a1275 2
.elif defined(_CKSUM_SIZE)
_size_fragment=		cksum -a size $$file
d1426 1
a1426 2
.ifdef _CKSUM_SIZE
	@@cd ${DISTDIR} && cksum ${_CIPHERS:S/^/-a /} -a size \
a1427 11
.else
	@@x=bad; cd ${DISTDIR} && \
	    for cipher in ${_CIPHERS}; do \
		${_CKSUM_A} $$cipher ${_CKSUMFILES} \
		    >>${CHECKSUM_FILE} && x=ok || true; \
	    done; test $$x = ok
	@@cd ${DISTDIR} && \
	    for file in ${_CKSUMFILES}; do \
		${_size_fragment} >>${CHECKSUM_FILE}; \
	    done
.endif
d1438 1
a1438 2
.ifdef _CKSUM_SIZE
	@@cd ${DISTDIR} && cksum ${_CIPHERS:S/^/-a /} -a size \
a1439 11
.else
	@@x=bad; cd ${DISTDIR} && \
	    for cipher in ${_CIPHERS}; do \
		${_CKSUM_A} $$cipher ${_CKSUMFILES} \
		    >>${CHECKSUM_FILE} && x=ok || true; \
	    done; test $$x = ok
	@@cd ${DISTDIR} && \
	    for file in ${_CKSUMFILES}; do \
		${_size_fragment} >>${CHECKSUM_FILE}; \
	    done
.endif
d1444 2
a1445 2
	@@if [ $$(sed -e 's/\=.*$$//' ${CHECKSUM_FILE} | uniq -d \
	    | wc -l) -ne 0 ]; then \
a1639 1
	integer new_cksum=0${_CKSUM_SIZE}; \
d1643 1
a1643 2
		_CIPHERS='${_CIPHERS}'; \
		(( new_cksum )) && if [[ ! -e ${WRKDIR}/.sums ]]; then \
d1645 7
a1651 14
			syntax=; first=; _CIPHERS=; sp=; \
			for cipher in ${_CIPHERS}; do \
				if ! (echo | ${_CKSUM_A} $$cipher \
				    >/dev/null 2>&1); then \
					${ECHO_MSG} ">> No $$cipher found on this system."; \
				else \
					syntax="$$syntax$$first$$cipher"; \
					first=" -a "; \
					_CIPHERS=$$_CIPHERS$$sp$$cipher; \
					sp=" "; \
				fi; \
			done; \
			(cd ${DISTDIR} && ${_CKSUM_A} $$syntax \
			    ${_CKSUMFILES} >${WRKDIR}/.sums); \
d1653 2
a1654 1
		cd ${DISTDIR}; OK=true; list=; \
d1657 1
a1657 1
			for cipher in $$_CIPHERS; do \
d1665 2
a1666 6
					if (( new_cksum )); then \
						t=$$(grep "$$file\$$" \
						    ${WRKDIR}/.sums || true); \
					else \
						t=$$(cksum "$$file"); \
					fi; \
a1675 5
				(( new_cksum )) || if ! (echo | ${_CKSUM_A} $$cipher \
				    >/dev/null 2>&1); then \
					${ECHO_MSG} ">> No $$cipher found on this system."; \
					continue; \
				fi; \
d1681 1
a1681 1
				case "$$4" in \
d1685 1
a1685 1
				"IGNORE") \
d1690 2
a1691 6
					if (( new_cksum )); then \
						CKSUM=$$(grep -i "^$$cipher ($$file)" \
						    ${WRKDIR}/.sums | sed 's/^.*= //'); \
					else \
						CKSUM=$$(${_CKSUM_A} $$cipher <$$file); \
					fi; \
d1714 2
a1715 2
		  case "$$4" in \
		  	"IGNORE") : ;; \
@


1.193
log
@bulk convert FLAVOR to FLAVOUR; nuke unused file; convert to $Mdocdate
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.192 2008/02/24 11:36:29 tg Exp $
d352 4
a355 1
.ifdef _CKSUM_SIZE
d1867 1
a1867 1
.if ${MACHINE_OS} == "Darwin"
d2530 1
a2530 1
.if ${MACHINE_OS} == "Darwin"
d2553 2
@


1.192
log
@try to work around the idiocy in Leopardâ€™s new gcc

developed at FOSDEM night together with bsiegert@@
tested on gecko2@@â€™s laptop
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.191 2008/02/22 21:43:43 tg Exp $
d22 2
a23 2
.if ${.MAKEFLAGS:MFLAVOR=*}
ERRORS+=		"Use 'env FLAVOR=${FLAVOR:Q} ${MAKE}' instead."
d139 2
a140 2
_LIBLIST=		${WRKDIR}/.liblist-${ARCH}${_FLAVOR_EXT2}
_BUILDLIBLIST=		${WRKDIR}/.buildliblist-${ARCH}${_FLAVOR_EXT2}
d161 1
a161 1
_okay_words=		-f bulk depends dist fake flavors force install \
d261 4
a264 4
FLAVOR?=
FLAVORS?=
PSEUDO_FLAVORS?=
FLAVORS+=		${PSEUDO_FLAVORS}
d266 1
a266 1
.if !empty(FLAVORS:L:Mregress) && empty(FLAVOR:L:Mregress)
d298 1
a298 1
FULLPKGNAME?=		${PKGNAME}${FLAVOR_EXT}
d306 1
a306 1
FULLPKGNAME${_s} =	${PKGNAME${_s}}${FLAVOR_EXT}
d308 1
a308 1
FULLPKGNAME${_s} =	${PKGNAME}${_s}${FLAVOR_EXT}
d447 1
a447 1
WRKINST?=		${FAKEOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
d449 1
a449 1
WRKINST?=		${WRKDIR}/fake-${ARCH}${_FLAVOR_EXT2}
d453 1
a453 1
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}${_FLAVOR_EXT2}
d455 1
a455 1
WRKDIR?=		${.CURDIR}/w-${PKGNAME}${_FLAVOR_EXT2}
d478 3
a480 3
# Build FLAVOR_EXT, checking that no flavours are misspelled
FLAVOR_EXT:=
# _FLAVOR_EXT2 is used internally for working directories.
d482 1
a482 1
_FLAVOR_EXT2:=
d486 3
a488 3
.if !empty(FLAVORS)
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
d494 3
a496 3
_FLAVOR_EXT2:=	${_FLAVOR_EXT2}-${_i}
.    if empty(PSEUDO_FLAVORS:L:M${_i})
FLAVOR_EXT:=	${FLAVOR_EXT}-${_i}
d506 1
a506 1
.if !empty(FLAVORS:M[0-9]*)
d510 4
a513 4
.if !empty(FLAVOR)
.  if !empty(FLAVORS)
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
d515 1
a515 1
ERRORS+=		"Possible flavours are: ${FLAVORS}"
d543 1
a543 1
	@@cd ${.CURDIR} && SUBPACKAGE= FLAVOR=${FLAVOR:Q} PACKAGING= exec ${MAKE} _package
d554 1
a554 1
.  if empty(FLAVOR_EXT)
d557 1
a557 1
FULLPKGPATH=		${PKGPATH}${FLAVOR_EXT:S/-/,/g}
d560 1
a560 1
FULLPKGPATH=		${PKGPATH},${SUBPACKAGE}${FLAVOR_EXT:S/-/,/g}
d611 1
a611 1
			FLAVOR_EXT RESPONSIBLE
d616 1
a616 1
_SED_SUBST+=		-e 's,$${FLAVORS},${FLAVOR_EXT},g' -e 's,$$\\,$$,g'
d624 2
a625 2
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${ARCH}
d627 2
a628 2
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.${MACHINE_ARCH}
d631 2
a632 2
    && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared)
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}.noshared
d634 2
a635 2
.if !defined(PLIST) && exists(${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT})
PLIST=			${PKGDIR}/PLIST${SUBPACKAGE}${FLAVOR_EXT}
d649 2
a650 2
.if defined(COMMENT${SUBPACKAGE}${FLAVOR_EXT})
_COMMENT=		${COMMENT${SUBPACKAGE}${FLAVOR_EXT}}
d1303 1
a1303 1
	@@cd ${.CURDIR} && SUBPACKAGE= FLAVOR=${FLAVOR:Q} \
d1316 1
a1316 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_s:Q} FLAVOR=${FLAVOR:Q} \
d1399 2
a1400 2
.if !empty(FLAVORS)
	@@echo "\nFlavours available:" ${FLAVORS} >>$@@
d1504 1
a1504 1
	@@unset PACKAGING DEPENDS_TARGET FLAVOR SUBPACKAGE \
d2350 1
a2350 1
		unset FLAVOR SUBPACKAGE || true; \
d2360 1
a2360 1
.    if ${_clean:L:Mflavors}
d2436 1
a2436 1
	FLAVORS=${FLAVORS:Q} MULTI_PACKAGES=${MULTI_PACKAGES:Q} \
d2603 1
a2603 1
	@@cd ${.CURDIR} && SUBPACKAGE=${SUBPACKAGE:Q} FLAVOR=${FLAVOR:Q} \
d2607 1
a2607 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_sub:Q} FLAVOR=${FLAVOR:Q} \
d2674 1
a2674 1
	@@cd ${.CURDIR} && SUBPACKAGE=${SUBPACKAGE:Q} FLAVOR=${FLAVOR:Q} \
d2678 1
a2678 1
	@@cd ${.CURDIR} && SUBPACKAGE=${_sub:Q} FLAVOR=${FLAVOR:Q} \
d2768 1
a2768 1
		unset FLAVOR SUBPACKAGE || true; \
d2776 1
a2776 1
		unset FLAVOR SUBPACKAGE || true; \
d2787 1
a2787 1
		unset FLAVOR SUBPACKAGE || true; \
d2817 1
a2817 1
    && !${FLAVORS:U:MNO_${_i}}
d2825 1
a2825 1
	@@unset FLAVOR SUBPACKAGE || true; \
d2843 1
a2843 1
	@@unset FLAVOR SUBPACKAGE  || true; \
d2855 1
a2855 1
	@@unset FLAVOR SUBPACKAGE  || true; \
d2870 1
a2870 1
	@@unset FLAVOR SUBPACKAGE || true; \
d2895 1
a2895 1
	@@unset FLAVOR SUBPACKAGE || true; \
d2963 1
a2963 1
	@@unset FLAVOR SUBPACKAGE || true; \
d2993 1
a2993 1
	@@unset FLAVOR SUBPACKAGE || true; \
d3010 1
a3010 1
	@@unset FLAVOR SUBPACKAGE || true; \
@


1.191
log
@sorry, we *must* use --library-after
not using it WILL cause hidden bugs

we'll rather fix the gcc issue instead
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.189 2007/10/26 21:45:53 tg Exp $
d2544 8
a2551 5
	if ! ${CC} -dumpspecs | sed \
	    's#/usr/bin/libtool#${LOCALBASE}/db/libtool#g' >$$t; then \
		print -u2 Error: cannot create specs file; \
		rm -f $$t; \
		exit 1; \
@


1.190
log
@For non-ELF targets, don't use --library after as the ld wrapper / spec
frobnicator does not work on gcc 4.0.1 (Mac OS 10.5).
@
text
@d382 1
a384 3
LDFLAGS+=		${LDSTATIC} -Wl,--library-after=${LOCALBASE}/lib
.else
LDFLAGS+=		${LDSTATIC} -L${LOCALBASE}/lib
d1046 1
a1047 1
LDFLAGS+=		-Wl,--library-after=${X11BASE}/lib
a1048 2
.      else
LDFLAGS+=		-L${X11BASE}/lib
@


1.189
log
@experimental: RCS IDs in distinfo files
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.188 2007/10/26 12:14:20 bsiegert Exp $
a381 1
LDFLAGS+=		${LDSTATIC} -Wl,--library-after=${LOCALBASE}/lib
d384 3
d1048 1
a1049 1
.      if ${OBJECT_FMT} == "ELF"
d1051 2
@


1.188
log
@Fix the bug where the second dependency argument in a LIB_DEPENDS is not
taken into account and remove the workaround.

HEADS UP: If the second argument for ANY dependency is empty, the default
is now "any version", not "the exact same version currently in ports".

agreed tg@@ on phone
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.187 2007/08/16 18:14:01 tg Exp $
d1449 1
@


1.187
log
@ease ports that used to need SEPARATE_BUILD
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.186 2007/08/16 12:28:37 tg Exp $
d1150 1
a1150 1
	done; $$bad || found=true
a1153 1
BUILD_DEPENDS+=		${LIB_DEPENDS:C/^([^:]*):([^:]*):/:\2:/:C/^::.*$//:M*}
d1520 1
a1520 1
		X)	pkg=$$(eval $$toset ${MAKE} _print-packagename); \
@


1.186
log
@change upgrade semantics by request of bsiegert@@
â€¢ â€œmmake upgradeâ€: if not installed, install, else upgrade if not same version
â€¢ â€œmmake reupgradeâ€: if installed, upgrade even if same version

also make clear that an already installed package is not an error
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.185 2007/08/11 15:44:09 tg Exp $
d327 2
a328 2
_INSTALL_PRE_COOKIE=	${WRKDIR}/.install_started
_FAKE_COOKIE=		${WRKDIR}/.fake_done
d331 3
a333 3
_CONFIGURE_COOKIE=	${WRKDIR}/.configure_done
_BUILD_COOKIE=		${WRKDIR}/.build_done
_REGRESS_COOKIE=	${WRKDIR}/.regress_done
d460 1
a460 1
WRKPKG?=		${WRKDIR}/pkg
@


1.185
log
@ancientÂ crap
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.184 2007/08/07 19:30:45 tg Exp $
a83 1
_UPGRADE_FLAGS?=	-a
d3112 3
d3116 1
a3116 1
	exec env _UPGRADE_FLAGS="${_UPGRADE_FLAGS} -f" ${MAKE} upgrade
d3118 1
a3118 1
upgrade: _upgrade_pkgs .WAIT _upgrade ${_UPGRADE_DEPS}
@


1.184
log
@support ciphers not being supported
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.183 2007/07/09 18:39:05 tg Exp $
a2760 1
	# Nothing to do...
@


1.183
log
@typo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.182 2007/06/07 18:00:45 tg Exp $
d1674 1
d1677 1
a1677 1
			syntax=; first=; \
d1685 2
d1695 1
a1695 1
			for cipher in ${_CIPHERS}; do \
@


1.182
log
@shaddap
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.181 2007/05/28 16:14:18 tg Exp $
d2263 1
a2263 1
		if [[ ! -s ${CHECKSUM_FILE}; then \
@


1.181
log
@if checksum mismatch, delete distfiles' checksums cache
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.180 2007/05/27 14:12:00 tg Exp $
d2263 3
a2265 1
		if grep -qe "^$$ck\$$" \
@


1.180
log
@fix for ports without distfiles and old-style method, such as metaauto
DAMN!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.179 2007/05/26 02:41:27 tg Exp $
d1771 1
@


1.179
log
@shaddap
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.178 2007/05/26 02:38:11 tg Exp $
d1668 1
a1668 1
.  if !defined(NO_CHECKSUM)
d1783 1
a1783 1
.  if ${PERMIT_DISTFILES_FTP:L} == "yes"
@


1.178
log
@fix x-device link
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.177 2007/05/14 01:40:55 tg Exp $
d1799 1
a1799 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/CDROM/${_i} || \
d1804 1
a1804 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/FTP/${_i} || \
@


1.177
log
@split this better to allow re-use
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.176 2007/05/12 23:12:28 tg Exp $
d1799 2
a1800 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/CDROM/${_i}
d1804 2
a1805 1
	@@ln ${DISTDIR}/${_i} ${DISTDIR}/FTP/${_i}
@


1.176
log
@split out the real configure call, might come in handy (magicpoint?)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.175 2007/05/07 22:51:06 tg Exp $
d1199 20
a1218 16
MODSIMPLE_configure= \
	cd ${WRKCONF} && ${_SYSTRACE_CMD} ${_real_simple_configure_call}
_real_simple_configure_call= \
	${SETENV} REALOS=${OStype:Q} \
	    ac_cv_path_CC=${CC:Q} LDFLAGS=${LDFLAGS:Q} MKSH=${MKSH:Q} \
	    ac_cv_path_CXX=${CXX:Q} CPPFLAGS=${CPPFLAGS:Q} \
	    CC=${CC:Q} CFLAGS="$$(print -nr -- '${CFLAGS}' | \
		sed -e 's${CPPFLAGS:S\\\\\\g}g' -e 's/[ 	]*$$//')" \
	    CXX=${CXX:Q} CXXFLAGS="$$(print -nr -- '${CXXFLAGS}' | \
		sed -e 's${CPPFLAGS:S\\\\\\g}g' -e 's/[ 	]*$$//')" \
	    INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    ac_given_INSTALL="/usr/bin/install -c -o ${BINOWN} -g ${BINGRP}" \
	    INSTALL_PROGRAM=${INSTALL_PROGRAM:Q} YACC=${YACC:Q} \
	    INSTALL_MAN=${INSTALL_MAN:Q} INSTALL_DATA=${INSTALL_DATA:Q} \
	    INSTALL_SCRIPT=${INSTALL_SCRIPT:Q} LD=${LD:Q} GCC_NO_WERROR=1 \
	    ${CONFIGURE_ENV} ${SH} ${_CONFIGURE_SCRIPT} ${CONFIGURE_ARGS}
@


1.175
log
@make sure modules can define additional flavours
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.174 2007/05/07 22:37:10 tg Exp $
d1200 3
a1202 1
	cd ${WRKCONF} && ${_SYSTRACE_CMD} ${SETENV} REALOS=${OStype:Q} \
@


1.174
log
@fix "(uses Motif)" displaying in the INDEX
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.173 2007/05/07 22:34:56 tg Exp $
a286 45
# Build FLAVOR_EXT, checking that no flavours are misspelled
FLAVOR_EXT:=
# _FLAVOR_EXT2 is used internally for working directories.
# It encodes flavours and pseudo-flavours.
_FLAVOR_EXT2:=

# Create the basic sed substitution pipeline for fragments
# (applies only to PLIST for now)
.if !empty(FLAVORS)
.  for _i in ${FLAVORS:L}
.    if empty(FLAVOR:L:M${_i})
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/r${PKGDIR}/PFRAG.no-${_i}${SUBPACKAGE}' \
		-e '//d' \
		-e '/^%%${_i}%%$$/d'
.    else
_FLAVOR_EXT2:=	${_FLAVOR_EXT2}-${_i}
.    if empty(PSEUDO_FLAVORS:L:M${_i})
FLAVOR_EXT:=	${FLAVOR_EXT}-${_i}
.    endif
SED_PLIST+=	|sed \
		-e '/^!%%${_i}%%$$/d' \
		-e '/^%%${_i}%%$$/r${PKGDIR}/PFRAG.${_i}${SUBPACKAGE}' \
		-e '//d'
.    endif
.  endfor
.endif

.if !empty(FLAVORS:M[0-9]*)
ERRORS+=		"Flavour cannot start with a digit."
.endif

.if !empty(FLAVOR)
.  if !empty(FLAVORS)
.    for _i in ${FLAVOR:L}
.      if empty(FLAVORS:L:M${_i})
ERRORS+=		"Unknown flavour: ${_i}"
ERRORS+=		"Possible flavours are: ${FLAVORS}"
.      endif
.    endfor
.  else
ERRORS+=		"No flavours for this port."
.  endif
.endif

d479 45
@


1.173
log
@have USE_MOTIF imply USE_X11
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.172 2007/05/07 22:34:11 tg Exp $
d2559 3
a2561 1
.if ${USE_X11:L} == "yes"
a2569 3
.if ${USE_MOTIF:L} == "yes"
_EXTRA_DESCRIBE+=	"(uses Motif)"
.endif
@


1.172
log
@22:18âŽœ<benz> fix mal die logik in bsd.port.mk, dass lesstif default wird
22:18âŽœ<benz> ich geh schlafen
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.171 2007/05/06 18:35:46 tg Exp $
d272 1
@


1.171
log
@by request of bsiegert@@ make people use the new pkg_info -e code,
cf. commitid 1004639017279101038
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.170 2007/04/07 14:37:14 bsiegert Exp $
d272 1
a272 26
.  if ${USE_MOTIF:L} == "lesstif"
LIB_DEPENDS+=		Xm.1::x11/lesstif
.  elif ${USE_MOTIF:L} == "openmotif"
.    ifndef BROKEN
BROKEN=			x11/openmotif is broken
.    endif
LIB_DEPENDS+=		Xm.2::x11/openmotif
.  elif ${USE_MOTIF:L} == "any" || ${USE_MOTIF:L} == "yes"
FLAVORS+=		lesstif
.    if ${FLAVOR:L:Mlesstif} && ${FLAVOR:L:Mmotif}
ERRORS+=		"Choose motif or lesstif, not both."
.    endif
.    if ${FLAVOR:L:Mlesstif}
LIB_DEPENDS+=		Xm.1::x11/lesstif
.    else
.      ifndef BROKEN
BROKEN=			x11/openmotif is broken
.      endif
LIB_DEPENDS+=		Xm.2::x11/openmotif
.    endif
.  elif ${USE_MOTIF:L} != "transparent"
ERRORS+=		"Unknown USE_MOTIF=${USE_MOTIF:Q} settings."
.  endif
MOTIFLIB=		-L${LOCALBASE}/lib -lXm
MAKE_ENV+=		MOTIFLIB=${MOTIFLIB:Q}
USE_X11=		Yes
@


1.170
log
@For "mmake relevant-checks", don't print warnings like
"dependency foo uses X11"
if the dependency has a no_x11 flavour. Same for CXX.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.169 2007/04/04 21:38:45 tg Exp $
d1136 4
a1139 10
_build_depends_fragment= \
	if [[ $$pkg = *-!* ]]; then \
		pkg dependencies check "$$pkg" && found=true; \
	else \
		${PKG_CMD_INFO} -qe "$$pkg" && found=true; \
	fi || true
# (the '|| true' is for make... otherwise it yields error code 1 sometimes)
_run_depends_fragment=${_build_depends_fragment}
_regress_depends_fragment=${_build_depends_fragment}
_fetch_depends_fragment=${_build_depends_fragment}
@


1.169
log
@bsiegert@@ reminded me that DT_RPATH is ELF specific (I think, well, at
least the Macintosh linker has no -rpath optionâ€¦)@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.168 2007/04/04 17:59:55 bsiegert Exp $
d2832 2
a2833 1
    && ${_MASTER_USE_${_i}:L} != "yes" && ${USE_${_i}:L} == "yes"
@


1.168
log
@USE_MOTIF implies USE_X11
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.167 2007/04/01 20:19:53 tg Exp $
d452 4
a455 2
LDFLAGS+=		${LDSTATIC} -Wl,-rpath -Wl,${LOCALBASE}/lib \
			-Wl,--library-after=${LOCALBASE}/lib
d1071 4
a1074 2
LDFLAGS+=		-Wl,-rpath -Wl,${X11BASE}/lib \
			-Wl,--library-after=${X11BASE}/lib
@


1.167
log
@implement ports/Distfiles/{CDROM,FTP}/*, idea by me, reminder that I'd
better honour DIST_SUBDIR (or subdir'd DISTFILES as in misc/figlet) by
bsiegert@@, implementation by me, agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.166 2007/03/30 23:22:09 bsiegert Exp $
d297 1
@


1.166
log
@Don't give bogus warning on duplicate @@group directives, like for @@owner
and others
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.165 2007/03/30 23:20:09 bsiegert Exp $
d1686 1
d1802 23
@


1.165
log
@Implement one of the points from my todo list: @@emul directives for
plists. If EMUL is set in a port's Makefile (e.g. EMUL=linux for a port
which needs linux emulation), this fact is entered into the package.
pkg_add checks for the relevant emulation.

- introduce new piperead() function, which executes a command and reads
  one line of output. Carefully crafted to avoid errors.
- new option for pkg_create: -e gives an initial value for @@emul
- bsd.port.mk: add -e to PKG_ARGS if EMUL given
- new function have_emulation(): Is the emulation enabled (via sysctl
  -n) or, alternatively, are we already running the "right" OS?
- pkg_info: show @@emul directive
- documentation: document EMUL and @@emul
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.164 2007/03/20 17:33:46 tg Exp $
d2214 1
a2214 1
	    | egrep -v '@@(comment|mode|owner)' | uniq -d); \
@


1.164
log
@look more cool
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.163 2007/03/04 21:16:10 tg Exp $
d716 3
@


1.163
log
@tentatively add â€œ-Wl,-rpath -Wl,${LOCALBASE}/libâ€ (and X11BASE) to LDFLAGS,
globally; agreed bsiegert@@ since glib1, mc, screen, gtk+2, cups continue to
build and appear to work
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.162 2007/03/02 01:38:30 tg Exp $
d1165 1
d1548 1
d1554 1
a1554 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what - found"; \
d1558 1
a1558 1
					${ECHO_MSG} "===>  ${FULLPKGNAME${SUBPACKAGE}}${_MASTER} depends on: $$what -$$msg"; \
@


1.162
log
@prune ${WRKINST} before re-creating and using it
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.161 2007/03/02 01:10:34 tg Exp $
d451 2
a452 1
LDFLAGS+=		-Wl,--library-after=${LOCALBASE}/lib ${LDSTATIC}
d1065 2
a1066 1
LDFLAGS+=		-Wl,--library-after=${X11BASE}/lib
d1119 1
a1119 1
#LDFLAGS+=		-Wl,--library-after=${X11BASE}/lib -lmirmake
@


1.161
log
@${MAKE} is wrong here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.160 2007/03/02 00:31:52 tg Exp $
d2108 1
@


1.160
log
@implement a REFETCH=true ability for CVS_DISTF* stuff which then
fetches it from the MirOS master site (using primary master site
so take care and use :0 etc. for additional distfiles)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.159 2007/01/29 17:15:13 tg Exp $
d2253 1
a2253 1
			${ECHO_MSG} ">> Try to refetch with ${MAKE} fetch REFETCH=true"; \
@


1.159
log
@missing @@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.158 2007/01/29 17:13:08 tg Exp $
d362 1
d2235 1
a2235 1
.  if defined(_CVS_FETCH${_i:S/-//})
d2253 1
@


1.158
log
@(hopefully) catch Distfiles and Packages dirs not writable for user

error noticed by Walter Ian Kaye on lynx-dev
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.157 2006/12/30 21:13:45 tg Exp $
d2274 1
a2274 1
	cd ${_F:H}; \
@


1.157
log
@default to PKGNAME?=${_CVS_DISTF:R}-${DASH_VER} if using cvs distfiles
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.156 2006/12/23 04:07:56 tg Exp $
d2188 5
a2200 6
	@@if [ ! -d ${PKGREPOSITORY} ]; then \
	   if ! mkdir -p ${PKGREPOSITORY}; then \
	      echo ">> Can't create directory ${PKGREPOSITORY}."; \
		  exit 1; \
	   fi; \
	fi
d2236 5
d2268 6
a2273 1
	@@mkdir -p ${_F:H}; \
@


1.156
log
@prevent a few more variables from creeping in...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.155 2006/12/23 04:02:22 tg Exp $
a354 3
.if defined(CVS_DISTMODS) && !empty(CVS_DISTMODS)
WRKDIST?=		${WRKDIR}/${CVS_DISTMODS}
.endif
d359 3
d364 1
a522 1
WRKDIST?=		${WRKDIR}/${DISTNAME}
a523 1

@


1.155
log
@* prevent ${BINOWN} from creeping up in PLISTs
  by removing it from the list of SUBST_VARS
* fix figlet mirrors (use our own)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.154 2006/12/23 01:15:12 tg Exp $
a1238 5
_tmpvars:=
.  for _v in ${SUBST_VARS}
_tmpvars+=		${_v}=${${_v}:Q}
.  endfor

d2392 5
@


1.154
log
@pkg_info -qe isn't quite up to the task either
bring back pkg dependencies check until the bug is fixed,
for the special case of pkg-*-!flavour only
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.153 2006/12/22 21:08:37 tg Exp $
d632 1
a632 1
			FLAVOR_EXT RESPONSIBLE BINOWN
@


1.153
log
@append :${X11BASE}/bin to ${_PORTPATH} if USE_X11 only,
instead of adding it to the default _PORTPATH, which is
overridden by SetEnv.make anyway

unbreaks at least graphics/imlib
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.152 2006/12/21 19:33:53 tg Exp $
d1127 6
a1132 3
	if ${PKG_CMD_INFO} -qe "$$pkg"; then \
		found=true; \
	fi
@


1.152
log
@don't generate .sums twice - if something's wrong there, just mmake clean
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.151 2006/12/20 15:29:26 tg Exp $
d426 4
a429 1
_PORTPATH?=		${LOCALBASE}/bin:/usr/local/bin:/usr/bin:/bin:${X11BASE}/bin:/usr/sbin:/sbin:${LOCALBASE}/sbin
@


1.151
log
@Instead of defaulting
| PKGNAME?=		${DISTNAME}-0
default it to
| DASH_VER?=		0
| PKGNAME?=		${DISTNAME}-${DASH_VER}

I chose to take the name DASH_VER here because it's been
in wider use already (albeit in a non-standardised manner)
in MirPorts, and I've seen it elsewhere, I think. In my
own ports I used to use PL but that's too short and not
explicit enough for a new global variable.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.150 2006/12/11 22:59:21 tg Exp $
d1684 1
a1684 1
		if (( new_cksum )); then \
a1695 1
			rm -f ${WRKDIR}/.sums; \
@


1.150
log
@better workaround for the issue that lib dependencies' middle
part is not correctly checked pre-build: add them to BUILD_DEPENDS
if they have a middle part

XXX what about them being RUN_DEPENDS? especially on not shared
XXX arches, where this isn't done automatically... probably, if
XXX the library package (.cgz) contains additional stuff, the
XXX porter who devises the dependency should add an explicit
XXX run-time dependency
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.149 2006/11/24 01:15:07 tg Exp $
d358 1
d360 1
a360 1
PKGNAME?=		${DIST_NAME}-${DIST_DATE}-0
d363 1
a363 1
PKGNAME?=		${DISTNAME}-0
@


1.149
log
@use :M* not :C/ *$//
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.148 2006/11/22 18:03:20 tg Exp $
d1167 1
a1856 16
	@@rm -f ${WRKDIR}/.lib_kludge_hit
.for _i in ${LIB_DEPENDS}
	@@x='${_i}'; if [[ $$x = *([!:]):+([!:]):* ]]; then \
		print -u2 'Error:\tthe middle part of LIB_DEPENDS cannot be reliably used to'; \
		print -u2 '\tenforce a minimum version. Use a mixed tdependency instead on'; \
		print -u2 '\titem "${_i}" like\n'; \
		IFS=:; set -A y -- $$x; \
		print -u2 "LIB_DEPENDS+=\\t\\t$${y[0]}::$${y[2]}"; \
		print -u2 "B_R_DEPENDS+=\\t\\t:$${y[1]}:$${y[2]}"; \
		print -u2; \
		touch ${WRKDIR}/.lib_kludge_hit; \
	fi
.endfor
.if (${USER:L} == "tg") || (${USER:L} == "bsiegert")
	@@[[ ! -e ${WRKDIR}/.lib_kludge_hit ]]
.endif
@


1.148
log
@obvios missing sudo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.147 2006/11/22 17:58:40 tg Exp $
d473 1
a473 1
			CC=${CC:Q} CXX=${CXX:Q} CFLAGS=${CFLAGS:C/ *$//:Q} \
@


1.147
log
@specs file (Mac only) should be created as ${BINOWN}
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.146 2006/11/19 13:17:27 tg Exp $
d2529 1
a2529 1
	if ! ${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} \
@


1.146
log
@update and change distfile to cpio format

agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.145 2006/11/17 18:31:41 tg Exp $
d2519 17
a2535 2
	@@${CC} -dumpspecs | sed \
	    's#/usr/bin/libtool#${LOCALBASE}/db/libtool#g' >$@@
@


1.145
log
@add and document new variable B_R_DEPENDS which is internally treated
as if its contents were added to both BUILD_DEPENDS and RUN_DEPENDS,
to simplify makefiles
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.144 2006/11/14 02:31:17 tg Exp $
d837 2
a838 1
			    '${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}' \
d842 1
a842 1
			    '${CVS_DISTMODS${_i:S/-//}}'
d848 1
a848 1
FETCH_DEPENDS+=		:mpczar->=20051117-1:archivers/mpczar
@


1.144
log
@don't fail on 'mmake checksum'
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.143 2006/11/08 16:51:22 bsiegert Exp $
d1166 2
d1170 2
a1171 1
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
d1251 1
a1251 1
.if defined(LIB_DEPENDS) && ${NO_SHARED_LIBS:L} != "yes"
d1259 1
a1259 1
.if defined(RUN_DEPENDS)
d1267 1
a1267 1
.if defined(BUILD_DEPENDS)
d1275 1
a1275 1
.if defined(FETCH_DEPENDS)
d1510 2
a1511 1
.  if defined(${_DEP:U}_DEPENDS) && ${NO_DEPENDS:L} == "no"
a1863 2
		print -u2 'BUILD_DEPENDS+=\t\t$${B_R_DEPENDS}'; \
		print -u2 'RUN_DEPENDS+=\t\t$${B_R_DEPENDS}'; \
d2815 1
a2815 1
.for _i in  ${RUN_DEPENDS}
@


1.143
log
@Change all calls to "pkg dependencies check" to use "pkg_info -qe". Also
make pkg print a warning message when the deprecated form is used.

Please report it when you see a warning about this during normal MirPorts
usage, and please update bsd.port.mk along with the pkgtools.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.142 2006/11/04 00:29:15 tg Exp $
d1678 1
@


1.142
log
@fix
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.141 2006/11/04 00:27:19 tg Exp $
d1122 1
a1122 1
	if ${PKG_CMD_PKG} dependencies check "$$pkg"; then \
d2181 1
a2181 1
	@@if ${PKG_CMD_PKG} dependencies check \
d2863 1
a2863 1
		if ${PKG_CMD_PKG} dependencies check $$pkg; then \
@


1.141
log
@+debugging
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.140 2006/11/04 00:03:54 tg Exp $
d1738 1
a1738 1
						CKSUM=$$(grep -i "^$$cipher " \
d1749 1
a1749 1
						if [[ -n $_CKSUM_DEBUG ]]; then \
@


1.140
log
@I was annoyed by slow checksumming of large files (previously,
cksum(1) was called once per file and cipher on /dev/null
and once per file and cipher on that file,
now it's called once per cipher on /dev/null and once on all files.
Only enabled if we have "new cksum" (with tiger etc.)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.139 2006/11/03 23:47:32 tg Exp $
d1749 4
@


1.139
log
@make that a warning, not an error, for the normal user,
and add spaces
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.138 2006/11/03 23:41:25 tg Exp $
d419 1
d1673 1
d1677 15
d1703 6
a1708 1
					t=$$(cksum "$$file"); \
d1718 1
a1718 1
				if ! (echo | ${_CKSUM_A} $$cipher \
d1737 7
a1743 2
					CKSUM=$$(${_CKSUM_A} $$cipher <$$file); \
					case "$$CKSUM" in \
@


1.138
log
@I'm fed with this bug. For now, produce abortion errors like
| Error:  the middle part of LIB_DEPENDS cannot be reliably used to
|         enforce a minimum version. Use a mixed tdependency instead on
|         item "SDL_Pango:sdl-pango->=0.1.2-1:devel/sdl-pango" like
| LIB_DEPENDS+=           SDL_Pango::devel/sdl-pango
| B_R_DEPENDS+=           :sdl-pango->=0.1.2-1:devel/sdl-pango
| BUILD_DEPENDS+=         ${B_R_DEPENDS}
| RUN_DEPENDS+=           ${B_R_DEPENDS}
on attempt to extract a package that uses it.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.137 2006/10/27 15:53:05 tg Exp $
d1824 1
a1824 1
		print -u2 '\titem "${_i}" like'; \
d1830 1
d1834 1
d1836 1
@


1.137
log
@* sys.mk, param.h: bump OS patchlevel
* sys.mk, sys.mk.ed: simplify CPPFLAGS generation
* limits.h, stdlib.h: crank MB_LEN_MAX to (2*real-MB_LEN_MAX - 1)
  to account for functions such as wcrtomb(3) to process an mbstate_t
* machine/limits.h: do *not* define MB_LEN_MAX=1 unconditionally,
  broke libncursesw(!); protect against multiple inclusion
* bsd.port.mk: default 'mmake uninstall' to pkg_delete -c
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.136 2006/10/17 21:28:11 tg Exp $
d1819 15
@


1.136
log
@remove obsolete DEBUGLIBS addition
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.135 2006/10/17 21:15:41 tg Exp $
d80 1
a80 1
PKG_CMD_DELETE?=	${PKG_CMDDIR}/pkg_delete
@


1.135
log
@experimental (i.e., untested): move ${WRKDIR}/specs to ${LOCALBASE}/db/
and make it depend on the compiler used

only affects darwin; moving requested by bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.134 2006/10/13 17:09:19 tg Exp $
a431 3
.if defined(DEBUGLIBS) && ${DEBUGLIBS:L} != "no"
CFLAGS+=		-g1
.endif
@


1.134
log
@new cksum package, leads to more distinguished choices
should, however, bring TIGER to everyone
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.133 2006/10/06 20:01:06 tg Exp $
d1811 3
d1815 1
a1818 4
.if ${MACHINE_OS} == "Darwin"
	@@${CC} -dumpspecs | sed \
	    's#/usr/bin/libtool#${LOCALBASE}/db/libtool#g' >${WRKDIR}/specs
.endif
d2454 19
@


1.133
log
@size does matter
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.132 2006/10/06 19:34:37 tg Exp $
d1287 1
a1287 1
.ifdef _CKSUM_SIZE
d1289 2
@


1.132
log
@* infrastructure/mk/bsd.port.mk: never compile C++ code with
  -fomit-frame-pointer as this seems to break exceptions
  reported by: libtorrent/rtorrent wiki
* devel/libsigc++: speed up build; be explicit about building
  of shared or static libraries; regen distinfo; fix indentation
* net/libtorrent, net/rtorrent: update to latest UNSTABLE ver-
  sion (because the STABLE version has, according to upstream,
  known bugs); enable IPv6; use "autogen" configuration style,
  because "autoconf" doesn't work any more because upstream
  wishes to use libtool 2.0-beta which has an interface incom-
  patible to libtool 1.4, 1.5 and mirlibtool; speed up build;
  be explicit about minimum curl version; add default session
  dir example (commented out) to rtorrent.rc; apply fix for the
  slow hashing problem (from upstream); indent properly
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.131 2006/09/22 00:09:18 tg Exp $
d1288 1
a1288 1
_size_fragment=		stat -f 'SIZE (%N) = %z'
@


1.131
log
@formalise the check whether we have a 'new' cksum
XXX think better about this
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.130 2006/09/17 20:17:33 tg Exp $
d445 2
@


1.130
log
@implement, as a hack, if CKSUM_HAS_SIZE is (user-)defined,
to use cksum -a <algorithms> including TIGER and SIZE

also, use stat(1) as size_fragment, it'd be idiotic to not
do it, but depend that on CKSUM_HAS_SIZE (XXX bad, but ok
for now) too since "the other bsd" doesn't have /usr/bin/stat
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.129 2006/09/13 23:34:01 tg Exp $
d418 1
a418 1
.ifdef CKSUM_HAS_SIZE
d1285 1
a1285 1
.ifdef CKSUM_HAS_SIZE
d1437 1
a1437 1
.ifdef CKSUM_HAS_SIZE
d1460 1
a1460 1
.ifdef CKSUM_HAS_SIZE
@


1.129
log
@proper quoting is difficult eh?
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.128 2006/09/13 22:07:11 tg Exp $
d418 3
d422 1
d1285 3
d1289 1
d1437 4
a1445 3
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
d1450 4
a1456 1

d1460 4
a1468 3
	@@for file in ${_IGNOREFILES}; do \
		echo "MD5 ($$file) = IGNORE" >>${CHECKSUM_FILE}; \
	done
d1473 4
@


1.128
log
@fix after $COMMENT changes
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.127 2006/09/09 14:14:22 tg Exp $
d1395 1
a1395 1
	@@fgrep -q '$${HOMEPAGE}' $? || echo "\nWWW: ${HOMEPAGE}" >>$@@
d2565 1
a2565 1
	@@echo 'See <a href="${HOMEPAGE}">${HOMEPAGE}</a> for details.' >$@@.tmp4
d2942 1
a2942 1
	@@echo '<li><a href="${HOMEPAGE}">${PKGNAME}</a>'
@


1.127
log
@quote!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.126 2006/08/26 23:34:16 tg Exp $
d2449 1
a2449 1
.if ${USE_GMAKE:L} == "yes"
d2453 1
a2453 1
_EXTRA_DESCRIBE+=	"(uses GNU Make) (uses Schily)"
d2490 1
a2490 1
	@@echo -n ${_COMMENT}${_EXTRA_DESCRIBE}"|${HOMEPAGE}|"; \
@


1.126
log
@OStype vs MACHINE_OS confusion, try to clean up the mess:

We use MACHINE_OS to distinguish between different OSes, i.e.
 BSD Darwin Interix Linux

Within these, there are OStype per MACHINE_OS, e.g.
 BSD -> MirBSD OpenBSD
 Darwin -> Darwin
 Interix -> Interix MirInterix
 Linux -> Debian

These are only the OStype""s seen until now,
so please use what semantically fits, e.g. on
Interix and MirInterix, you don't have IPv6,
but on MirInterix you won't need an explicit
texinfo dependency since it's in the base system.
Be aware that OStype can be user defined though!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.125 2006/08/26 19:35:57 tg Exp $
d1335 1
a1335 1
	@@echo ${_COMMENT} >$@@
d2562 1
a2562 1
	@@echo ${_COMMENT} | ${HTMLIFY} >$@@.tmp-comment
@


1.125
log
@comment out commitid 10044F07C1C20DBFE87
libmirmake (and new mirmake) aren't ready yet
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.124 2006/08/26 16:51:33 tg Exp $
d1794 1
a1794 1
.if ${OStype} == "Darwin"
@


1.124
log
@experimental: add -lmirmake to LDFLAGS
(pending shared mirmake library)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.123 2006/08/16 19:51:14 tg Exp $
d1107 3
a1109 3
.if exists(${.SYSMK}/libmirmake.a)
LDFLAGS+=		-Wl,--library-after=${X11BASE}/lib -lmirmake
.endif
@


1.123
log
@hopefully fix shared library build on the Mac
needs at lease commitid 10044E3758755E1B9A8 and 10044E3762016E082FD
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.122 2006/08/10 16:45:47 tg Exp $
d1107 3
@


1.122
log
@fix 'FLAVOR= mmake clean' with FLAVOR?=non-empty in Makefile
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.121 2006/07/23 17:42:34 tg Exp $
d1791 4
@


1.121
log
@add an ld(1) wrapper which provides --library-after=X as new option,
which works like --library-path=X (-LX), install the wrapper and use
it for ${LOCALBASE}/lib and (USE_X11=Yes) ${X11BASE}/lib

now curl 7.15.4 can be built while curl 7.15.1 (missing function
in /usr/mpkg/lib/libcurl.so.something which is new in the new version)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.120 2006/07/15 16:40:44 tg Exp $
d567 3
d571 1
@


1.120
log
@use sudo for cleaning the build area

there are some misbehaving ports (e.g. Python, AquaTerm)
who write to the build area (i.e. outside the fake tree)
during install time, and it doesn't look like they get
fixed any time soon (doesn't look easy either)

requested by bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.119 2006/07/11 14:26:38 tg Exp $
d441 1
a441 1
LDFLAGS+=		-L${LOCALBASE}/lib ${LDSTATIC}
d1051 1
a1051 1
LDFLAGS+=		-L${X11BASE}/lib
@


1.119
log
@use ?= just in case...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.118 2006/07/11 14:26:00 tg Exp $
d2268 2
a2269 2
	@@[ ! -L ${WRKDIR} ] || rm -rf $$(readlink ${WRKDIR})
	@@rm -rf ${WRKDIR}
@


1.118
log
@add INSTALL_LIB, INSTALL_LIB_DIR akin TNF pkgsrc(R)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.117 2006/06/25 02:51:24 tg Exp $
d573 1
a573 1
INSTALL_PROGRAM=	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} \
d575 1
a575 1
INSTALL_LIB=		${INSTALL} ${INSTALL_COPY} \
d577 1
a577 1
INSTALL_SCRIPT=		${INSTALL} ${INSTALL_COPY} \
d579 1
a579 1
INSTALL_DATA=		${INSTALL} ${INSTALL_COPY} \
d581 1
a581 1
INSTALL_MAN=		${INSTALL} ${INSTALL_COPY} \
d584 5
a588 5
INSTALL_PROGRAM_DIR=	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m ${DIRMODE}
INSTALL_LIB_DIR=	${INSTALL_PROGRAM_DIR}
INSTALL_SCRIPT_DIR=	${INSTALL_PROGRAM_DIR}
INSTALL_DATA_DIR=	${INSTALL} -d -o ${SHAREOWN} -g ${SHAREGRP} -m ${DIRMODE}
INSTALL_MAN_DIR=	${INSTALL} -d -o ${MANOWN} -g ${MANGRP} -m ${DIRMODE}
@


1.117
log
@sync, use it
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.116 2006/06/25 02:24:08 tg Exp $
d575 2
d585 1
d591 1
d596 1
@


1.116
log
@no CPPOPTS, we _do_ need them to be fixed in autoconf
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.115 2006/06/25 01:48:36 tg Exp $
d1192 1
a1192 1
	    ac_cv_path_CC=${CC:Q} LDFLAGS=${LDFLAGS:Q} \
@


1.115
log
@use CPPOPTS for stuff not thought for autoconf
XXX quirk
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.114 2006/06/25 00:04:10 tg Exp $
a423 1
CPPFLAGS+=		${CPPOPTS}
d1193 1
a1193 2
	    ac_cv_path_CXX=${CXX:Q} CPPFLAGS="$$(print -nr -- '${CPPFLAGS}' | \
		sed -e 's${CPPOPTS:S\\\\\\g}g' -e 's/[ 	]*$$//')" \
@


1.114
log
@too much julishka to come up w/ a ci msg
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.112 2006/06/24 23:49:36 tg Exp $
d424 1
d1194 2
a1195 1
	    ac_cv_path_CXX=${CXX:Q} CPPFLAGS=${CPPFLAGS:S/\\/\\\\/g:Q} \
@


1.113
log
@fix CFLAGS, CXXFLAGS containing CPPFLAGS for configure call
@
text
@d1192 3
a1194 2
	    CC=${CC:Q} ac_cv_path_CC=${CC:Q} CPPFLAGS=${CPPFLAGS:C/ *$//:Q} \
	    CFLAGS="$$(print -nr -- '${CFLAGS}' | \
d1196 1
a1196 1
	    CXXFLAGS="$$(print -nr -- '${CXXFLAGS}' | \
a1197 1
	    CXX=${CXX:Q} ac_cv_path_CXX=${CXX:Q} LDFLAGS=${LDFLAGS:Q} \
@


1.112
log
@don't pass CXXFLAGS twice to configure
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.111 2006/06/23 15:56:27 bsiegert Exp $
d1194 1
a1194 1
		sed 's${CPPFLAGS:S/\\/\\\\/g}')" \
d1196 1
a1196 1
		sed 's${CPPFLAGS:S/\\/\\\\/g}')" \
@


1.111
log
@Make the Packages/FTP and Packages/CDROM directories group writable. They
are usually owned by group wsrc, to which users that install ports (should)
belong.

Found while setting up the FROSCON showcase.

ok tg@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.110 2006/05/28 20:45:17 tg Exp $
d1192 5
a1196 1
	    CC=${CC:Q} ac_cv_path_CC=${CC:Q} CFLAGS=${CFLAGS:C/ *$//:Q} \
a1197 1
	    CXXFLAGS=${CXXFLAGS:C/ *$//:Q} CPPFLAGS=${CPPFLAGS:C/ *$//:Q} \
@


1.110
log
@slightly change ONLY/NOT_FOR_ARCH in INDEX to allow both to be set
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.109 2006/04/25 20:01:00 tg Exp $
d2225 1
a2225 1
	@@mkdir -p ${${_l}_PACKAGES}
@


1.109
log
@try this for separate build
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.108 2006/03/27 20:59:32 tg Exp $
d2485 12
a2496 6
	@@case "${ONLY_FOR_PLATFORM}" in \
	"")	case "${NOT_FOR_PLATFORM}" in \
		"")	echo -n "any|" ;; \
		*)	echo -n "!${NOT_FOR_PLATFORM}|" ;; \
		esac ;; \
	*)	echo -n "${ONLY_FOR_PLATFORM}|" ;; \
@


1.108
log
@document non-systrace ports in the INDEX
since they are INSECURE
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.107 2006/03/23 21:36:22 tg Exp $
d967 2
@


1.107
log
@enhance the relevant-checks target by BROKEN and IGNORE (cluefully)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.106 2006/03/02 01:17:37 tg Exp $
d2443 3
@


1.106
log
@use a three-stage regex instead of a two-stage regex for checking
package version numbers to avoid false positive on 'bsdgames-20050216-1'
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.105 2006/02/21 12:59:25 tg Exp $
d2634 2
d2643 8
@


1.105
log
@change naming scheme for time-of-the-day cvs date tags,
and prepend instead of append cvs symbolic tags
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.104 2006/02/21 03:36:05 tg Exp $
d705 2
a706 2
.if ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}
ERRORS+=		"Invalid version number in main package '${FULLPKGNAME}': ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
d710 2
a711 2
.    if ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}
ERRORS+=		"Invalid version number in '${_s}' subpackage '${FULLPKGNAME${_s}}': ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
@


1.104
log
@Forcing USE_CXX=no ports to use 'false' as ${CXX} since now.
add some stuff to wlog.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.103 2006/02/09 17:40:23 tg Exp $
d807 6
a812 1
_CVS_DISTF${_i:S/-//}=	${CVS_DISTFILE${_i:S/-//}}
d815 1
a815 6
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}-${_j}
.      endfor
.    endif
.    if defined(CVS_DISTTAGS${_i:S/-//})
.      for _j in ${CVS_DISTTAGS${_i:S/-//}:C![^0-9a-zA-Z_-]!!g}
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}-T${_j}
d819 1
a819 1
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}.mcz
@


1.103
log
@that was not the cause of the bug, fix it for real
(introduced from openbsd)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.102 2006/02/09 13:03:04 tg Exp $
d456 5
a460 2
CONFIGURE_ENV+=		CXX=${CXX:Q}
MAKE_ENV+=		CXX=${CXX:Q}
d469 1
a469 1
			CC=${CC:Q} CFLAGS=${CFLAGS:C/ *$//:Q} \
@


1.102
log
@pass CC by default as overriding MAKE_FLAGS
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.101 2006/02/09 12:25:13 tg Exp $
d564 1
a564 1
FULLPKGPATH=		${PKGPATH}${_FLAVOR_EXT:S/-/,/g}
d566 1
a566 1
FULLPKGPATH=		${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT:S/-/,/g}
@


1.101
log
@first bulk build fallout:
* fix port bugs which are simple to fix (eg. libtoolise)
* break all others so that we get a percentage of what works...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.100 2006/02/09 12:15:49 tg Exp $
d231 1
a231 1
MAKE_FLAGS?=
@


1.100
log
@if pulling in a LIB_DEPENDS during _recurse-solve-package-depends
unset PACKAGING for a while (not for writing the depends list) in
order to enable a potentially built package to correctly pull its
library dependencies (audio/abcde -> audio/libao -> audio/esound)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.99 2006/02/09 09:35:58 tg Exp $
d275 3
d287 3
@


1.99
log
@remove SEPARATE_BUILD for once and for good, I'm fed up with
all the trouble it can cause - ports which need it (e.g. the
GCC SC doesnt "support" building gcc with srcdir=objdir) can
set stuff like WRKBUILD themselves.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.98 2006/02/05 17:02:21 tg Exp $
d2665 1
a2665 1
.for _i in  ${LIB_DEPENDS}
d2743 4
a2746 2
			eval $$toset ${MAKE} \
			    ${PKGREPOSITORY}/$$default${PKG_SUFX}; \
@


1.98
log
@cannot use egrep here, $file may contain +
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.97 2006/02/01 18:54:04 tg Exp $
a385 2
.elif defined(SEPARATE_BUILD)
_INSTALL_PRE_COOKIE=	${WRKBUILD}/.install_started
a390 5
.if defined(SEPARATE_BUILD)
_CONFIGURE_COOKIE=	${WRKBUILD}/.configure_done
_BUILD_COOKIE=		${WRKBUILD}/.build_done
_REGRESS_COOKIE=	${WRKBUILD}/.regress_done
.else
a393 1
.endif
a499 3
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
WRKDIR?=		${WRKOBJDIR_${PKGPATH}}/${PKGNAME}
.  else
a500 1
.  endif
a501 3
.  if defined(SEPARATE_BUILD) && ${SEPARATE_BUILD:L:Mflavored}
WRKDIR?=		${.CURDIR}/w-${PKGNAME}
.  else
a502 1
.  endif
a507 4
.if defined(SEPARATE_BUILD)
WRKBUILD?=		${WRKDIR}/build-${MACHINE_ARCH}${_FLAVOR_EXT2}
WRKPKG?=		${WRKBUILD}/pkg
.else
a509 1
.endif
a958 3
.  if defined(SEPARATE_BUILD)
_CONFIGURE_SCRIPT=	${WRKSRC}/${CONFIGURE_SCRIPT}
.  else
a959 1
.  endif
@


1.97
log
@if NO_DISTFILES set DISTFILES empty
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.96 2006/01/25 12:21:34 tg Exp $
d2185 1
a2185 1
		elif egrep -q "S(IZE|ize) \($$file\)" ${CHECKSUM_FILE}; then \
d2220 1
a2220 1
				elif egrep -q "S(IZE|ize) \($$file\)" ${CHECKSUM_FILE}; then \
@


1.96
log
@   Revision  [253]1.708  /  ([254]download) - [255]annotate - [256][select for diffs] , Fri Sep 16 09:51:25
   2005 UTC (4 months, 1 week ago) by espie
   Branch: [257]MAIN
   Changes since 1.707: +3 -3 lines
   Diff to previous [258]1.707 ([259]colored)
Fix a buglet in bsd.port.mk where the PSEUDO_FLAVORS get encoded into
the FULLPKGPATH, thus providing changes to packing-lists which shouldn't
happen, and making update more difficult.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.95 2006/01/13 03:49:25 tg Exp $
a861 1
DISTFILES=
d1625 4
@


1.95
log
@* mirbsd.bsdadvocacy.org -> www.66h.42h.de
* mirbsd.mirsolutions.de -> www.66h.42h.de (loses SSL)
* http*/cvs.cgi/ -> cvs.mirbsd.de
* mirsolutions.de -> mirbsd.org

No complete transition yet, but this helps a lot with
the recent and upcoming(!) domain issues.

Please use only http://mirbsd.de/ as mirror redirector
and only http://cvs.mirbsd.de/ as CVSweb redirector.
Please do not use mirbsd.de for anything else save eMail.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.94 2006/01/10 20:58:20 tg Exp $
d579 1
a579 1
FULLPKGPATH=		${PKGPATH}${_FLAVOR_EXT2:S/-/,/g}
d581 1
a581 1
FULLPKGPATH=		${PKGPATH},${SUBPACKAGE}${_FLAVOR_EXT2:S/-/,/g}
@


1.94
log
@MirMake now defaults DEBUGLIBS to "no", and DEBUGPROGS is gone,
so for the case someone has set it to "yes" himself, add -g1 to
CFLAGS for ports builds (since INSTALL_STRIP is still set, this
really only affects libraries, despite a small slowdown).
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.93 2006/01/01 03:29:57 tg Exp $
d1343 1
a1343 1
	    "portdir=http://mirbsd.mirsolutions.de/cvs.cgi/ports/${PKGPATH}/" \
@


1.93
log
@typo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.92 2006/01/01 03:22:42 tg Exp $
d430 3
@


1.92
log
@aid debugging
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.91 2006/01/01 02:52:14 tg Exp $
d720 1
a720 1
ERRORS+=		"Invalid version number in '${_s}' subpackage '${FULLPKGNAME${_s}': ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
@


1.91
log
@found letters and underscores in real-world versions...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.88 2005/12/29 22:01:13 tg Exp $
d715 1
a715 1
ERRORS+=		"Invalid version number in main package: ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
d720 1
a720 1
ERRORS+=		"Invalid version number in '${_s}' subpackage: ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9._a-zA-Z]*$//}."
@


1.90
log
@fix match ex (replace ex was correct)
@
text
@d714 2
a715 2
.if ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9.]*$//}
ERRORS+=		"Invalid version number in main package: ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9.]*$//}."
d719 2
a720 2
.    if ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9.]*$//}
ERRORS+=		"Invalid version number in '${_s}' subpackage: ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:C/^[0-9][0-9.]*$//}."
@


1.89
log
@commit a mechanism to automatically check package version number
parts for correctness (stripping off stem, patchlevel and optional
flavour names from the FULLPKGNAME${SUBPACKAGE}).
@
text
@d714 2
a715 2
.if ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:N[0-9][0-9.]*}
ERRORS+=		"Invalid version number in main package: ${FULLPKGNAME:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/}."
d719 2
a720 2
.    if ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/:N[0-9][0-9.]*}
ERRORS+=		"Invalid version number in '${_s}' subpackage: ${FULLPKGNAME${_s}:C/^.*-([^-]*)-[0-9][0-9]*(-[a-zA-Z][^-]*)*$/\1/}."
@


1.88
log
@move the libtoolise script a bit down the queue
ok bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.87 2005/12/20 19:57:53 tg Exp $
d714 10
@


1.87
log
@make -> mmake, as discussed
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.86 2005/12/18 16:36:40 tg Exp $
a348 2
SED_PLIST+=		| (cd ${WRKINST}${PREFIX}; LOCALBASE=${LOCALBASE} perl -W ${PORTSDIR}/infrastructure/scripts/unlibtoolise || rm -f $@@.tmp)

d633 2
@


1.86
log
@Part 2 of the big commit:
* www/vbegin.php: don't output the UTF-8 BOM for now
* ports/Setup.sh: change order in which path is divined [1]
* ports/books/mirex: convert to CVS_DISTF
* ports/comms/ssfe: increase line length limit and history buffer size
* ports/infrastructure/install/setup.sh: sync path order with Setup.sh [1]
* ports/infrastructure/mk/bsd.port.mk: (_PORTPATH) sync default PATH [1]
* ports/infrastructure/mk/bsd.port.mk: (_UPGRADE_FLAGS) new, default to -a
* ports/infrastructure/mk/bsd.port.mk: (_upgrade) use it
* ports/infrastructure/mk/bsd.port.mk: (reupgrade) new target, set to -a -f
* ports/infrastructure/scripts/mkmcz: don't use $LOCALBASE, trust in PATH
* ports/infrastructure/mk/bsd.port.mk: (_CVS_FETCH) use _PORTPATH
* ports/infrastructure/pkgtools/create: treat /usr/info same as /usr/man
* ports/infrastructure/pkgtools/upgrade: fix path to temp +REQUIRED_BY
* ports/www/firesomething: break, suggest Opera-Linux/K-Meleon/Safari
* src/Makefile, src/gcc/Makefile.lang: if build GCJ, check if X11 installed
* src/Makefile, src/gnu/usr.bin/perl/Makefile.bsd-wrapper: defer h2ph
  execution to end of build
* src/distrib/lists: sync with pre-h2ph change
* src/etc/services: add openvpn, from IANA
* src/gcc/Makefile.inc, Makefile.lang: fragment out NO_*= stuff
* src/gcc/libjava/Makefile.bsd-wrapper: DEBUGPROGS is gone
* src/gnu/usr.bin/perl/Makefile.bsd-wrapper: flesh out h2ph, fix perms
* src/lib/libc/time/localtime.c: fix undefined extern
* ports/net/sirc/Makefile: automatically insert version into CTCP VERSION
* ports/net/sirc/dist/PROGRAMMING: document capab hooks
* ports/net/sirc/dist/dsircp: several hours of perl hacking with Club-Mate
  - publish $msgchannel, $talkserver [2]
  - support for CAPAB: publish $has_capab, $capab_cmd, $capab_response;
    add "capab" hook in reply
  - support for CAPAB IDENTIFY-MSG: publish $has_identifymsg; new
    $unverified, $unverified_m; enable automatically if present;
    change <...> [...] -...- to «...» [[...]] ¬...¬
  - /describe nick now looks [*] (or [[*]]) instead of *, /me now looks
    # instead of * if identified, to facilitate this conversion
  - fix abuse of U+0060
  - sort /names [2]
  - fix ^B ^_ ^V [2]
  - remove trailing whitespace on outgoing msgs [2]
  - remove trailing whitespace on incoming msgs
  - fix indentation
  - auto-split overlong lines (partially [2])
  - in NOTICE make nick bold too [2]
  - disable DCC since it crashes
  - beautify CTCP TIME replies
  - add ACCEPT command (for ratbox-ircd, e.g. Freeforge)
* ports/net/sirc/pkg/DESCR: summarise new features

[1] all for the sake of bsiegert@@ wanting to not have to souce a
    SetEnv.sh or SetEnv.csh before building in "default MirPorts"
    (i.e. LOCALBASE=/usr/mpkg SYSCONFDIR=/etc BINOWN=root SUDO=sudo)
[2] adapted from http://co.ordinate.org/sirc/
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.85 2005/12/18 05:40:16 tg Exp $
d12 1
a12 1
#	make show=RESPONSIBLE
d16 1
a16 1
#	make show=_MIRPORTS_ADDRESS
d618 1
a618 2
			/usr/bin/make ${PKG_CMDDIR:S!/sbin!/bin!}/make \
			${LOCALBASE}/bin/gmake
d1714 1
a1714 1
			echo "\"make REFETCH=true [other args]\"."; \
d1776 1
@


1.85
log
@* pkg_upgrade: fail pkg_add if pkg_delete fails
* bsd.port.mk: d'oh, sudo pkg_upgrade...

With this, with an already installed openvpn-2.0.5-1
I could do a FLAVOR=static make upgrade clean and got
an automatic, seamless upgrade to openvpn-2.0.5-1-static.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.84 2005/12/17 04:29:13 tg Exp $
d84 1
d424 1
a424 1
_PORTPATH?=		${LOCALBASE}/bin:/usr/bin:/bin:${LOCALBASE}/sbin:/usr/sbin:/sbin:${X11BASE}/bin
d2162 1
a2162 1
		${_CVS_FETCH${_i:S/-//}}; \
d2945 3
d2957 1
a2957 1
	${SUDO} ${PKG_CMD_UPGRADE} -a ${PKGFILE${SUBPACKAGE}}
d3000 1
a3000 1
	reinstall repackage run-depends \
@


1.84
log
@nice ===> Upgrading for ... prompt
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.83 2005/12/17 04:05:26 tg Exp $
d2953 1
a2953 1
	${PKG_CMD_UPGRADE} -a ${PKGFILE${SUBPACKAGE}}
@


1.83
log
@* Even if it's just for the fun, add a script which (called as root)
  builds a specified port, including dependencies, relative to /usr,
  removes non-run dependencies and exits. Might be useful in the future.
* bsd.port.mk: if prefix /usr, add share/man -> man symlink for these
  who try to be smart
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.82 2005/12/17 03:06:07 tg Exp $
d2950 1
@


1.82
log
@typo
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.81 2005/12/17 02:57:14 tg Exp $
d2032 3
d2070 4
@


1.81
log
@* move fake.mtree (generated) to LOCALBASE
* setup.ksh: only build what we really need, since we have a dependency now
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.80 2005/12/17 02:36:25 tg Exp $
d2613 1
a2613 1
		eval $$toset; ${for-${_i}-depends}; \
@


1.80
log
@* 4.4BSD.dist: var/spool/ftp and var/cron are permission trouble, nuke
* 4.4BSD.dist: we need one uname and gname for mtree to work
* create/create.h, create/pl.c: (check_list) add syshack flag to change
  man/ into share/man/
* create/perform.c: (pkg_perform) if the Prefix is /usr enable the new
  syshack flag if not just normalising the packaging list; be careful
  to not totally break for FAKE=no operation
* bsd.port.mk: (${WRKPKG}/mtree.spec) replace @@BINOWN@@ and @@BINGRP@@
* bsd.port.mk: (${PORTSDIR}/infrastructure/db/fake.mtree) use it
* bsd.port.mk: (MTREE_FILE+=) add 4.4BSD.dist if PREFIX=/usr
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.79 2005/12/17 00:55:14 tg Exp $
d678 1
a678 1
MTREE_FILE+=		${PORTSDIR}/infrastructure/db/fake.mtree
d1274 2
a1275 2
${PORTSDIR}/infrastructure/db/fake.mtree: ${PORTSDIR}/infrastructure/templates/fake.mtree
	cp $> $@@
d1279 1
a1279 1
		    | ed -s $@@; \
@


1.79
log
@${FOO:Q} is bad if you do
|	${SHELL} somescript ${FOO:Q} ${BAR:Q}
and somescript uses $1 and $2.

Guess what happens if ${FOO} is empty...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.78 2005/12/16 22:41:11 tg Exp $
d675 3
d1278 1
a1278 1
		    "uname=${BINOWN} gname=${BINGRP} /\nwq" \
d1393 5
a1397 1
	 done; print '.\nwq') | ed -s $@@.tmp
@


1.78
log
@automatically build/update fake.mtree
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.77 2005/12/16 22:04:16 tg Exp $
d820 5
a824 5
			    ${FULLDISTDIR:Q}/${_CVS_DISTF${_i:S/-//}:Q} \
			    ${CVS_DISTREPO${_i:S/-//}:Q} \
			    ${CVS_DISTDATE${_i:S/-//}:Q} \
			    ${CVS_DISTTAGS${_i:S/-//}:Q} \
			    ${CVS_DISTMODS${_i:S/-//}:Q}
@


1.77
log
@remove LDADD_CYCLIC, just use the groups always, it's not that much a payoff
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.76 2005/12/16 16:41:02 tg Exp $
d1271 8
@


1.76
log
@* implement package updates
* an optional -f forces re-installation (i.e. we could realise
  the existing "reinstall" target in <bsd.port.mk> with it)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.75 2005/12/16 14:58:14 tg Exp $
a472 3
.  if defined(LDADD_CYCLIC)
MAKE_ENV+=		LDADD_CYCLIC=1
.  endif
@


1.75
log
@use install-binpkg not install for automated subpackage installation
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.74 2005/12/16 11:46:39 tg Exp $
d83 1
d1173 2
d1181 2
d1186 3
d2925 10
d2978 2
a2979 2
	uninstall unlink-categories update-patches \
	update-plist unconfigure \
@


1.74
log
@make WRKDIST= optional for CVS_DISTMODS case
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.73 2005/12/16 11:16:12 tg Exp $
d1180 1
a1180 1
	@@env SUBPACKAGE=${_i:Q} ${MAKE} install
@


1.73
log
@make CVS_DISTFILE optional (CVS_DISTMODS is used by default)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.72 2005/12/16 11:14:50 tg Exp $
d349 3
@


1.72
log
@* make using CVS checkout method for both date and tag possible (tested)
* mkmcz: revert unintended debugging change which broke archive creation
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.71 2005/12/15 01:24:42 tg Exp $
d801 1
@


1.71
log
@* use ${FOO:Q} i.p.v. '${FOO}' or "${FOO}"
* replace v='' and v="" with v= while here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.70 2005/11/19 12:54:25 tg Exp $
d801 1
a802 1
_CVS_DISTF${_i:S/-//}=	${CVS_DISTFILE${_i:S/-//}}-
d804 1
a804 1
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}${_j}
d806 2
a807 3
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}.mcz
.    elif defined(CVS_DISTTAGS${_i:S/-//})
_CVS_DISTF${_i:S/-//}=	${CVS_DISTFILE${_i:S/-//}}-T
d809 1
a809 1
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}${_j}
d811 2
@


1.70
log
@* mirmake: update to 20051119
* infrastructure: (MAKE_ENV) add LDADD, LDADD_CYCLIC if defined
  (Interix) employ LDADD_CYCLIC
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.69 2005/11/18 14:14:30 tg Exp $
d231 1
a231 1
FAKE_FLAGS=		${DESTDIRNAME}='${WRKINST}'
d234 1
a234 1
EXTRA_XAKE_FLAGS+=	SHELL="${SHELL}"
d246 1
a246 1
MAKE_ENV+=		MAKEPROG='${MAKE_PROGRAM}' CCOM=cc
d288 1
a288 1
MAKE_ENV+=		MOTIFLIB='${MOTIFLIB}'
d452 2
a453 2
CONFIGURE_ENV+=		CXX='${CXX}'
MAKE_ENV+=		CXX='${CXX}'
d459 7
a465 7
MAKE_ENV+=		HOME='${PORTHOME}' PATH='${PORTPATH}' \
			PREFIX='${PREFIX}' TRUEPREFIX='${PREFIX}' \
			LOCALBASE='${LOCALBASE}' X11BASE='${X11BASE}' \
			CC='${CC}' CFLAGS='${CFLAGS:C/ *$//}' \
			LDFLAGS='${LDFLAGS}' ${DESTDIRNAME}= \
			BINOWN='${BINOWN}' BINGRP='${BINGRP}' \
			EXTRA_SYS_MK_INCLUDES="\"${PORTSDIR}/infrastructure/mk/mirports.bsd.mk\""
d565 1
a565 1
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' PACKAGING='' exec ${MAKE} _package
d596 8
a603 8
_INSTALL_MACROS=	BSD_INSTALL_PROGRAM="${INSTALL_PROGRAM}" \
			BSD_INSTALL_SCRIPT="${INSTALL_SCRIPT}" \
			BSD_INSTALL_DATA="${INSTALL_DATA}" \
			BSD_INSTALL_MAN="${INSTALL_MAN}" \
			BSD_INSTALL_PROGRAM_DIR="${INSTALL_PROGRAM_DIR}" \
			BSD_INSTALL_SCRIPT_DIR="${INSTALL_SCRIPT_DIR}" \
			BSD_INSTALL_DATA_DIR="${INSTALL_DATA_DIR}" \
			BSD_INSTALL_MAN_DIR="${INSTALL_MAN_DIR}"
d683 1
a683 1
PKG_ARGS=		-v -c '${WRKPKG}/COMMENT${SUBPACKAGE}' \
d771 1
a771 1
_SITE_SELECTOR+=	*:${_I}) sites="${MASTER_SITES${_I}}";;
d777 1
a777 1
_SITE_SELECTOR+=	*) sites="${MASTER_SITES}";; esac
d817 5
a821 5
			    '${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}' \
			    '${CVS_DISTREPO${_i:S/-//}}' \
			    '${CVS_DISTDATE${_i:S/-//}}' \
			    '${CVS_DISTTAGS${_i:S/-//}}' \
			    '${CVS_DISTMODS${_i:S/-//}}'
d969 1
a969 1
CONFIGURE_ENV+=		PATH='${PORTPATH}'
d978 8
a985 8
SCRIPTS_ENV+=		CURDIR='${.CURDIR}' DISTDIR='${DISTDIR}' \
			PATH='${PORTPATH}' WRKDIR='${WRKDIR}' \
			WRKDIST='${WRKDIST}' WRKSRC='${WRKSRC}' \
			WRKBUILD='${WRKBUILD}' PATCHDIR='${PATCHDIR}' \
			SCRIPTDIR='${SCRIPTDIR}' FILESDIR='${FILESDIR}' \
			PORTSDIR='${PORTSDIR}' DEPENDS="${DEPENDS}" \
			PREFIX='${PREFIX}' LOCALBASE='${LOCALBASE}' \
			X11BASE='${X11BASE}'
d1127 1
a1127 1
	*)	shprefix=""; shdir="${LOCALBASE}/lib";; \
d1180 4
a1183 4
	cd ${WRKCONF} && ${_SYSTRACE_CMD} ${SETENV} REALOS='${OStype}' \
	    CC="${CC}" ac_cv_path_CC="${CC}" CFLAGS="${CFLAGS:C/ *$//}" \
	    CXX="${CXX}" ac_cv_path_CXX="${CXX}" LDFLAGS="${LDFLAGS}" \
	    CXXFLAGS="${CXXFLAGS:C/ *$//}" CPPFLAGS="${CPPFLAGS:C/ *$//}" \
d1186 3
a1188 3
	    INSTALL_PROGRAM="${INSTALL_PROGRAM}" YACC="${YACC}" \
	    INSTALL_MAN="${INSTALL_MAN}" INSTALL_DATA="${INSTALL_DATA}" \
	    INSTALL_SCRIPT="${INSTALL_SCRIPT}" LD="${LD}" GCC_NO_WERROR=1 \
d1191 2
a1192 2
_FAKE_SETUP=		TRUEPREFIX='${PREFIX}' PREFIX='${WRKINST}${PREFIX}' \
			${DESTDIRNAME}='${WRKINST}'
d1199 1
a1199 1
_tmpvars+=		${_v}='${${_v}}'
d1267 2
a1268 2
	@@cd ${.CURDIR} && SUBPACKAGE='' FLAVOR='${FLAVOR}' \
	    PACKAGING='' exec ${MAKE} _package
d1280 2
a1281 2
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_s}' exec ${MAKE} _package
d1370 1
a1370 1
	 for pc in $$(print '${LOCALBASE}'); do \
d1444 1
a1444 1
	@@echo '${PKGPATH}/${FULLPKGNAME${SUBPACKAGE}}'
d1455 1
a1455 1
	echo '${_i}'|{ \
d1569 1
a1569 1
	PKG_DBDIR='${PKG_DBDIR}' perl ${_CHECK_LIBS_SCRIPT} \
d1615 1
a1615 1
		cd ${DISTDIR}; OK=true; list=''; \
d1812 1
a1812 1
	  	case "${PATCH_DEBUG:L}" in \
d1854 1
a1854 1
					case "${PATCH_DEBUG:L}" in \
d1917 1
a1917 1
	    "${WRKSRC}/RULES/${MACHINE}-openbsd-cc.rul"
d2065 1
a2065 1
		    PKG_TMPDIR=${PKG_TMPDIR} PATH="${PKG_CMDDIR}:$$PATH" \
d2070 1
a2070 1
	    PKG_TMPDIR=${PKG_TMPDIR} PATH="${PKG_CMDDIR}:$$PATH" \
d2100 1
a2100 1
	@@cd ${.CURDIR} && if ${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
d2243 1
a2243 1
	-${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
d2247 1
a2247 1
	-${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
d2255 1
a2255 1
	@@cd ${.CURDIR} && SUBPACKAGE='${_s}' exec ${MAKE} _delete-package-links
d2283 1
a2283 1
	@@DESTDIR=${WRKINST} PREFIX=${WRKINST}${PREFIX} LDCONFIG="${LDCONFIG}" \
d2290 2
a2291 2
	FLAVORS='${FLAVORS}' MULTI_PACKAGES='${MULTI_PACKAGES}' \
	OKAY_FILES='${_FAKE_COOKIE} ${_INSTALL_PRE_COOKIE}' \
d2297 1
a2297 1
	    PATCH_LIST='${PATCH_LIST}' DIFF_ARGS='${DIFF_ARGS}' \
d2385 1
a2385 1
_EXTRA_DESCRIBE=""
d2418 2
a2419 2
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${SUBPACKAGE}' exec ${MAKE} describe
d2422 2
a2423 2
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_sub}' exec ${MAKE} describe
d2483 2
a2484 2
	@@cd ${.CURDIR} && SUBPACKAGE='${SUBPACKAGE}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${SUBPACKAGE}' exec ${MAKE} readmes
d2487 2
a2488 2
	@@cd ${.CURDIR} && SUBPACKAGE='${_sub}' FLAVOR='${FLAVOR}' \
	    PACKAGING='${_sub}' exec ${MAKE} readmes
d2627 1
a2627 1
	: $${_FINAL_ECHO:='echo "\" for ${_i:L}."'}; space=''; \
d2629 1
a2629 1
	for spec in $$(echo '${_${_i}_DEP2}' \
d2643 1
a2643 1
	echo '${_i}' | { \
d2655 1
a2655 1
	echo '${_i}' | { \
d2670 1
a2670 1
	echo '${_i}' |{ \
d2695 1
a2695 1
	echo '${_i}'|{ \
d2698 1
a2698 1
		libspecs='';comma=''; \
d2721 1
a2721 1
			listlibs='${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
d2779 1
a2779 1
		self=${FULLPKGPATH} PACKAGING='${SUBPACKAGE}' \
d2909 1
a2909 1
	@@${SUDO} ${SETENV} PATH="${PKG_CMDDIR}:$$PATH" \
@


1.69
log
@* mpczar
  - depend on paxmirabilis-20051118-0 or higher
  - bump to -1
* bsd.port.mk
  - bump mpczar dependency to 20051117-1 or higher
* pkgtools
  - regenerate distfiles with new mpczar
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.68 2005/11/17 23:04:49 tg Exp $
d467 7
@


1.68
log
@_CVS_DISTF${_i:S/-//} contributes to _DISTFILES not ALLFILES
(it'd be a good idea to extract them, eh?)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.67 2005/11/17 23:00:35 tg Exp $
d820 1
a820 1
FETCH_DEPENDS+=		::archivers/mpczar
@


1.67
log
@* Size does matter
* implement 'make clean' CLEANDEPENDS for FETCH_DEPENDS
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.66 2005/11/17 22:49:46 tg Exp $
d845 7
a859 6
.for _i in - 0 1 2 3 4 5 6 7 8 9
.  if defined(_CVS_DISTF${_i:S/-//})
ALLFILES+=		${_CVS_DISTF${_i:S/-//}}
.  endif
.endfor

@


1.66
log
@move _CVS_FETCH generation out of the loop to a more logic place
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.65 2005/11/17 22:47:50 tg Exp $
d820 1
d1234 8
d2120 1
a2120 2
		cd ${.CURDIR}; ${MAKE} fetch-depends \
		    FETCH_DEPENDS=::archivers/mpczar && \
d2122 1
a2122 1
		file=${_F:S@@^${DISTDIR}/@@@@}; \
d2781 1
a2781 1
.for _dir in ${_ALWAYS_DEP} ${_BUILD_DEP} ${_RUN_DEP}
d2825 1
a2825 1
.if !empty(_ALWAYS_DEP) || !empty(_BUILD_DEP) || !empty(_RUN_DEP)
@


1.65
log
@fix retrieval (can't nest 2 .for and 1 .if construct)
I chose the larger but IMHO more performant (w/o testing) diff;
the other would have been:

Index: bsd.port.mk
===================================================================
RCS file: /cvs/ports/infrastructure/mk/bsd.port.mk,v
retrieving revision 1.64
diff -u -p -r1.64 bsd.port.mk
--- bsd.port.mk	17 Nov 2005 22:12:18 -0000	1.64
+++ bsd.port.mk	17 Nov 2005 22:38:59 -0000
@@@@ -2099,19 +2099,15 @@@@ fetch-all:
 _CVS_DISTFNUM:=	X
 .  for _i in - 0 1 2 3 4 5 6 7 8 9
 .    if defined(_CVS_DISTF${_i:S/-//}) && (${_CVS_DISTF${_i:S/-//}} == ${_F:S@@^${FULLDISTDIR}/@@@@})
-_CVS_DISTFNUM:=	${_i}
-.    endif
-.  endfor
-.  if ${_CVS_DISTFNUM} != X
 ${_F}:
 	@@[[ -e ${_F} ]] || { \
 		cd ${.CURDIR}; ${MAKE} fetch-depends \
 		    FETCH_DEPENDS=::archivers/mpczar && \
 		${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz '${_F}' \
-		    '${CVS_DISTREPO${_CVS_DISTFNUM}}' \
-		    '${CVS_DISTDATE${_CVS_DISTFNUM}}' \
-		    '${CVS_DISTTAGS${_CVS_DISTFNUM}}' \
-		    '${CVS_DISTMODS${_CVS_DISTFNUM}}'; \
+		    '${CVS_DISTREPO${_i:S/-//}}' \
+		    '${CVS_DISTDATE${_i:S/-//}}' \
+		    '${CVS_DISTTAGS${_i:S/-//}}' \
+		    '${CVS_DISTMODS${_i:S/-//}}'; \
 		file=${_F:S@@^${DISTDIR}/@@@@}; \
 		ck=$$(cd ${DISTDIR} && ${_size_fragment}); \
 		if grep -qe "^$$ck\$$" \
@@@@ -2125,7 +2121,9 @@@@ ${_F}:
 			${ECHO_MSG} ">> No size recorded for ${_F}"; \
 		fi; \
 	}
-.  else
+.    endif
+.  endfor
+.  if !target(${_F})
 ${_F}:
 .    if ${FETCH_MANUALLY:L} != "no"
 .      for _M in ${FETCH_MANUALLY}
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.64 2005/11/17 22:12:18 tg Exp $
d809 6
d2108 1
a2108 8
.  if defined(_CVS_DISTF${_i:S/-//})
_CVS_FETCH${_i:S/-//}=	${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz \
			    '${FULLDISTDIR}/${_CVS_DISTF${_i:S/-//}}' \
			    '${CVS_DISTREPO${_i:S/-//}}' \
			    '${CVS_DISTDATE${_i:S/-//}}' \
			    '${CVS_DISTTAGS${_i:S/-//}}' \
			    '${CVS_DISTMODS${_i:S/-//}}'

@


1.64
log
@yeah, ok, mark them interactive if !ALLFILES_PRESENT
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.63 2005/11/17 22:08:57 tg Exp $
d2097 3
d2101 11
a2111 10
.for _F in ${ALLFILES:S@@^@@${FULLDISTDIR}/@@}
_CVS_DISTFNUM:=	X
.  for _i in - 0 1 2 3 4 5 6 7 8 9
.    if defined(_CVS_DISTF${_i:S/-//}) && (${_CVS_DISTF${_i:S/-//}} == ${_F:S@@^${FULLDISTDIR}/@@@@})
_CVS_DISTFNUM:=	${_i}
.    endif
.  endfor
.  if ${_CVS_DISTFNUM} != X
${_F}:
	@@[[ -e ${_F} ]] || { \
d2114 1
a2114 5
		${MKSH} ${PORTSDIR}/infrastructure/scripts/mkmcz '${_F}' \
		    '${CVS_DISTREPO${_CVS_DISTFNUM}}' \
		    '${CVS_DISTDATE${_CVS_DISTFNUM}}' \
		    '${CVS_DISTTAGS${_CVS_DISTFNUM}}' \
		    '${CVS_DISTMODS${_CVS_DISTFNUM}}'; \
d2120 1
a2120 1
			${ECHO_MSG} ">> Size matches for ${_F}"; \
d2122 1
a2122 1
			${ECHO_MSG} ">> Size does not match for ${_F}"; \
d2125 1
a2125 1
			${ECHO_MSG} ">> No size recorded for ${_F}"; \
d2128 4
a2131 1
.  else
@


1.63
log
@add fetching part for .mcz files, including archive generation and
size checks (XXX ssh might be interactive, or cvs login needed)

ok bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.62 2005/11/17 20:18:31 tg Exp $
d977 1
a977 1
.if ${FETCH_MANUALLY:L} != "no"
@


1.62
log
@cgz -> mcz for mpczar balls
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.61 2005/11/17 20:15:03 tg Exp $
d1092 1
d1131 1
a1131 1
.for _DEP in build run lib regress
d1426 1
a1426 1
.for _DEP in build run lib regress
d2099 30
d2130 2
a2131 2
.  if ${FETCH_MANUALLY:L} != "no"
.    for _M in ${FETCH_MANUALLY}
d2133 1
a2133 1
.    endfor
d2135 1
a2135 1
.  else
d2161 1
@


1.61
log
@_CVS_DISTF is DIST_SOURCE=distfiles
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.60 2005/11/17 19:59:25 tg Exp $
d799 1
a799 1
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}.cgz
d805 1
a805 1
_CVS_DISTF${_i:S/-//}:=	${_CVS_DISTF${_i:S/-//}}.cgz
d919 1
a919 1
EXTRACT_CASES+=		*.tar.gz | *.cpio.gz | *.cgz) ${GZIP_CMD} -dc \
@


1.60
log
@part 1 of the mpczar-utilising cvs-distfile-fetching routines

ok bsiegert@@
<benz> ich will doku dafür in der manpage sehen
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.59 2005/11/10 23:36:08 tg Exp $
d814 1
a814 1
DIST_SOURCE=		cvs
@


1.59
log
@hack in -gnulib support for resolve-lib, becoming necessary
with the recent changes to libtool

bsiegert@@ please look at the two XXX in there, I don't speak
perl well enough to fix that
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.58 2005/11/10 20:39:09 tg Exp $
d792 20
d813 4
d846 6
@


1.58
log
@nicer output
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.57 2005/11/10 20:12:08 tg Exp $
d1069 1
a1069 1
.if ${OBJECT_FMT} == "Mach-O"
d1073 4
@


1.57
log
@add support for cksum(1) checksums, to be used *only* in corner cases
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.56 2005/11/07 20:34:03 tg Exp $
d1571 1
a1571 1
						${ECHO_MSG} ">> Checksum OK for $$file. ($$cipher)"; \
d1573 1
a1573 1
						echo ">> Checksum mismatch for $$file. ($$cipher)"; \
@


1.56
log
@remove USE_SYSTRACE since NO_SYSTRACE can be set to disable it anyway,
and OpenBSD only needs it because these baka-tachi default it to No
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.55 2005/10/23 21:49:52 tg Exp $
d1561 17
@


1.55
log
@what the...?
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.54 2005/10/21 20:29:18 tg Exp $
d602 1
a602 1
.if ${USE_SYSTRACE:L} == "yes" && ${NO_SYSTRACE:L} == "no"
@


1.54
log
@add BINOWN to SUBST_VARS
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.53 2005/10/12 19:16:23 tg Exp $
d1017 1
a1017 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:*:${OSREV}:*:${ARCH}"
d1019 1
a1019 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:*:${OSREV}:*:${ARCH} (${MACHINE_ARCH})"
@


1.53
log
@In addition to LD_LIBRARY_PATH, bsiegert@@ found out that PERL5LIB
is one of the "required" environment variables, thusly I've decided
to add it to SETENV, and while here, make the process more flexible.

Read this diff, everyone who wants to learn about mirmagic, er make.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.52 2005/10/09 19:33:39 tg Exp $
d618 1
a618 1
			FLAVOR_EXT RESPONSIBLE
@


1.52
log
@ease "cross-dressing builds" by not assuming ${LOCALBASE}/bin/make
is the one to use, rather use ${PKG_CMDDIR:S!/sbin!/bin} so you
only need to set this one
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.51 2005/10/02 18:10:09 tg Exp $
a718 4
# For Interix and installs as regular user
.if defined(_OUR_LDLIBPATH) && !empty(_OUR_LDLIBPATH)
SETENV+=		LD_LIBRARY_PATH="${_OUR_LDLIBPATH}"
.endif
d725 6
@


1.51
log
@if USE_X11, we must add X11BASE/include to cppflags too
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.50 2005/09/30 09:43:33 tg Exp $
d609 1
a609 1
			/usr/bin/make ${LOCALBASE}/bin/make \
@


1.50
log
@add new targets which make stuff like
$ make for-all-depends='make checksum'
possible

From: Brad Ely <elyb@@ioplasm.net>
but slightly modified - does not apply to the port
itself, only its dependencies
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.49 2005/09/29 12:42:28 tg Exp $
d424 3
@


1.49
log
@if unlibtoolise fails, make the package build fail too (else we'd end up
with an empty package) - noticed by bsiegert@@

Idea: if unlibtoolise exits abnormally, we remove PLIST.tmp and make the
following "mv PLIST.tmp PLIST" fail thusly, exiting make.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.48 2005/09/24 12:13:18 tg Exp $
d127 6
d2476 8
d2832 2
a2833 1
	fetch-makefile full-all-depends full-build-depends \
@


1.48
log
@it does not make sense to have PORTPATH=_PORTPATH
instead, make only PORTPATH be prepended by ${WRKDIR}/bin
and _PORTPATH is the "shell" path
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.47 2005/09/24 11:57:14 tg Exp $
d341 1
a341 1
SED_PLIST+=		| (cd ${WRKINST}${PREFIX}; LOCALBASE=${LOCALBASE} perl -W ${PORTSDIR}/infrastructure/scripts/unlibtoolise)
d1274 1
a1274 1
	mv -f $@@.tmp $@@
@


1.47
log
@save us a fork of sed(1)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.46 2005/09/22 20:27:46 bsiegert Exp $
d413 2
a414 2
_PORTPATH?=		${WRKDIR}/bin:${LOCALBASE}/bin:/usr/bin:/bin:${LOCALBASE}/sbin:/usr/sbin:/sbin:${X11BASE}/bin
PORTPATH?=		${_PORTPATH}
@


1.46
log
@Add a custom P5ARCH dir on Darwin---one which corresponds to reality ;).

ok tg@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.45 2005/09/14 21:17:35 tg Exp $
d2055 3
a2057 2
				if grep -qe "^$$ck\$$" -e "^$$(print "$$ck" \
				    | sed s/IZE/ize/) bytes\$$" ${CHECKSUM_FILE}; then \
@


1.45
log
@no -Werror-maybe-reset logic for now (GCC_NO_WERROR=1 stays)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.44 2005/09/12 22:53:18 tg Exp $
d221 1
a221 1
P5ARCH=			${P5SITE}/${MACHINE_ARCH}-${OSname}
@


1.44
log
@join tg-ports-devel branch into HEAD
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.8 2005/09/12 22:13:47 tg Exp $
a428 4
.if ${OStype} == "MirBSD" && ${_CC_IS_GCC:M3.4*}
CFLAGS+=		-Werror-maybe-reset
CXXFLAGS+=		-Werror-maybe-reset
.endif
@


1.43
log
@convert /var/www to ${WWW_PREFIX} more or less mechanically
this breaks some ports, but most of the breakage can be solved
by converting to @@sample and the rest should be some basic
adding of substitution (SUBST_VARS and/or ed/sed)...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.42 2005/09/01 20:09:37 tg Exp $
d46 1
a46 1
CLEANDEPENDS?=		No
a233 2
# where configuration files should go
SYSCONFDIR?=		/etc
d413 1
a413 1
_PORTPATH?=		${WRKDIR}/bin:${LOCALBASE}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${X11BASE}/bin
d459 1
d598 1
a598 2
_SYSTRACE_CMD?=		/bin/systrace ${SYSTRACE_ARGS_ADD} -i -a \
			    -f ${_SYSTRACE_COOKIE}
d603 3
a605 2
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env /usr/bin/make \
			    ${LOCALBASE}/bin/gmake
d714 4
@


1.42
log
@add two new types of ports: these who have their source in
ports/foo/bar/dist/ and these who have their sources in an
own CVS module, to be placed under ports/Extras/<modulename>

Samples for the first one: ssfe, sirc (forked from upstream),
MirPorts package tools, ...

Samples for the second one: CVS, GCC until we go 4.2, ...

Be careful with the licencing!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.41 2005/08/29 19:41:16 tg Exp $
d62 1
@


1.41
log
@/usr/lib/debug is obsolete
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40 2005/08/20 12:33:53 tg Exp $
d102 1
a102 1
_BAD_LICENSING=		Yes
d342 1
a342 1
SED_PLIST+=	|(cd ${WRKINST}${PREFIX} ; LOCALBASE=${LOCALBASE} perl -W ${PORTSDIR}/infrastructure/scripts/unlibtoolise)
d344 4
d349 1
d781 17
d1520 1
d1522 1
a1522 1
.  if target(pre-fetch)
d1524 2
a1525 2
.  endif
.  if target(do-fetch)
d1527 1
a1527 1
.  else
d1529 1
a1529 1
.    if !empty(ALLFILES)
d1531 2
d1534 1
a1534 3
# End of FETCH
.  endif
.  if target(post-fetch)
d1536 1
d1611 2
a1612 1
.  for file cipher value in ${_PROBLEMS}
d1616 1
a1616 1
.  endfor
d1618 1
d1668 1
d1672 1
a1672 1
.if target(pre-extract)
d1674 7
a1681 1
	@@cd ${.CURDIR} && exec ${_SYSTRACE_CMD} ${MAKE} do-extract
d2342 1
a2342 1
.  if defined(_BAD_LICENSING)
@


1.40
log
@half-hearted attempt to unify LOCALBASE to /usr/mpkg for all platforms
agreed some time ago bsiegert@@
no veto on miros-discuss@@

for now, hardcode PREFIX to /usr/local for imake and old-install ports
(we should probably do something about imake anyway, regarding both
Interix and Darwin - maybe require our own XFree86® port, but later...)

some of the code (especially shell and make) will be rewritten now,
since it can be simplified (nuking bugs, maybe)

what about changing /etc/mk.conf as well (conflict with obsd and maybe
others)? I think of /etc/${MAKE}.cfg (MAKE=make or mmake) maybe?

please test, as usual...
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.39 2005/07/24 12:34:26 tg Exp $
a423 3
.if ${CFLAGS:M-g}
LDFLAGS+=		-L${LOCALBASE}/lib/debug
.endif
@


1.40.2.1
log
@* OBJECT_FMT is provided by MirMake
  (XXX openbsd?)
* LOCALBASE and SYSCONFDIR are now in mirports.sys.mk
* SYSCONFDIR now defaults to LOCALBASE/etc
* new variable MMAKE
* protect some by .ifndef BOOTSTRAP
* amend portpath by LOCALBASE/sbin
* default MKC_USAP on openbsd to yes
* stub openbsd 3.7, 3.8 (clone 3.6)
* clean up and mksh'ify in bsd.port.mk and mirports.sys.mk
* no -L${LOCALBASE}/lib/debug for us
* remove _DOMAIN_DU_JOUR
* use readlink -nf better
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40 2005/08/20 12:33:53 tg Exp $
d233 2
d342 1
a342 1
SED_PLIST+=		| (cd ${WRKINST}${PREFIX}; LOCALBASE=${LOCALBASE} perl -W ${PORTSDIR}/infrastructure/scripts/unlibtoolise)
d409 1
a409 1
_PORTPATH?=		${WRKDIR}/bin:${LOCALBASE}/bin:/usr/bin:/bin:${LOCALBASE}/sbin:/usr/sbin:/sbin:${X11BASE}/bin
d424 3
d602 2
a603 1
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env ${MMAKE} ${LOCALBASE}/bin/gmake
@


1.40.2.2
log
@optimise and forgot FETCH_CMD
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.1 2005/08/21 11:08:26 tg Exp $
d591 2
a592 1
_SYSTRACE_CMD?=		/bin/systrace ${_SYSTRACE_ARGS} -f ${_SYSTRACE_COOKIE}
@


1.40.2.3
log
@merge -rHEAD into development branch

Note for bsiegert@@ please don't use csh prompts in man pages any more
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.42 2005/09/01 20:09:37 tg Exp $
d102 1
a102 1
_BAD_LICENCING=		Yes
a341 4
.if defined(DIST_NAME) && defined(DIST_DATE)
PKGNAME?=		${DIST_NAME}-${DIST_DATE}-0
WRKDIST?=		${WRKDIR}/${DIST_NAME}
.else
a342 1
.endif
a771 17
DIST_SOURCE?=		distfile
.if ${DIST_SOURCE:L} == "port"
DIST_SOURCEDIR?=	${.CURDIR}/dist
.  if (${PERMIT_DISTFILES_CDROM:L} != "yes") || (${PERMIT_DISTFILES_FTP:L} != "yes")
ERRORS+=		"If using DIST_SOURCE=port the distfiles must be licenced appropriately."
ERRORS+=		"Please notify the MirPorts maintainer:"
ERRORS+=		"    ${RESPONSIBLE}"
_BAD_LICENCING=		Yes
.  endif
.elif ${DIST_SOURCE:L} == "module"
DIST_SOURCEDIR?=	${PORTSDIR}/Extras/${DIST_NAME}
.endif
.if ${DIST_SOURCE:L} != "distfile"
DISTFILES=
NO_CHECKSUM=		defined
NO_DISTFILES=		defined
.endif
a1493 1
.  ifndef NO_DISTFILES
d1495 1
a1495 1
.    if target(pre-fetch)
d1497 2
a1498 2
.    endif
.    if target(do-fetch)
d1500 1
a1500 1
.    else
d1502 1
a1502 1
.      if !empty(ALLFILES)
d1504 1
a1504 1
.      endif
d1506 2
a1507 2
.    endif
.    if target(post-fetch)
a1508 1
.    endif
d1583 1
a1583 2
.  ifndef NO_DISTFILES
.    for file cipher value in ${_PROBLEMS}
d1587 1
a1587 1
.    endfor
a1588 1
.  endif
a1637 1
.if ${DIST_SOURCE:L} == "distfile"
d1641 1
a1641 1
.  if target(pre-extract)
d1643 1
a1643 1
.  endif
a1644 6
.else
	@@cd ${.CURDIR} && exec ${MAKE} build-depends lib-depends
	@@${ECHO_MSG} "===>  Copying source for ${FULLPKGNAME}${_MASTER}"
	@@mkdir -p ${WRKSRC}
	cd ${WRKSRC} && lndir ${DIST_SOURCEDIR}
.endif
d2305 1
a2305 1
.  if defined(_BAD_LICENCING)
@


1.40.2.4
log
@expose BINOWN and BINGRP to <bsd.prog.mk> ports
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.3 2005/09/11 01:05:41 tg Exp $
a457 1
			BINOWN='${BINOWN}' BINGRP='${BINGRP}' \
@


1.40.2.5
log
@default CLEANDEPENDS=yes (used to be done in make.cfg)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.4 2005/09/11 01:20:25 tg Exp $
d46 1
a46 1
CLEANDEPENDS?=		Yes
@


1.40.2.6
log
@add LD_LIBRARY_PATH support for ordinary systems too
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.5 2005/09/11 01:24:56 tg Exp $
a710 4
# For Interix and installs as regular user
.if defined(_OUR_LDLIBPATH) && !empty(_OUR_LDLIBPATH)
SETENV+=		LD_LIBRARY_PATH="${_OUR_LDLIBPATH}"
.endif
@


1.40.2.7
log
@merge r1.43
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.6 2005/09/11 02:12:20 tg Exp $
a61 1
WWW_PREFIX?=		/var/www
@


1.40.2.8
log
@mmake and systrace clash
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.40.2.7 2005/09/11 02:35:31 tg Exp $
d603 1
a603 3
_SYSTRACE_POLICIES+=	${SHELL} /usr/bin/env \
			/usr/bin/make ${LOCALBASE}/bin/make \
			${LOCALBASE}/bin/gmake
@


1.39
log
@* @@ldcache 0/1 -> @@option ldcache
  requested by bsiegert@@
* always emit @@option ldcache, don't look at /sbin/ldconfig existence on buildd
  agreed by bsiegert@@ (never cease to wonder about openbsd kludges...)
* while here, make the PLIST generation process more verbose
* while here, move some redundant code farther below and unify
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.38 2005/07/18 20:00:49 bsiegert Exp $
d74 1
a74 1
PKG_DBDIR?=		/var/db/pkg
d76 1
a76 1
PKG_CMDDIR?=		/usr/sbin
@


1.38
log
@Add LOCALBASE variable for unlibtoolise
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.37 2005/07/18 17:41:13 bsiegert Exp $
d1216 1
a1216 1
	@@echo "@@comment subdir=${FULLPKGPATH}" \
d1220 2
a1221 2
	@@echo "@@comment" \
	    "portdir=http://mirbsd.bsdadvocacy.org/cvs.cgi/ports/${PKGPATH}/" \
d1223 1
a1223 6
	@@t="0${_noshared}"; if [[ $$t = 0-noshared ]]; then \
		t=0; \
	elif [ -x /sbin/ldconfig ]; then \
		t=1; \
	fi; echo "@@ldcache $$t" >>$@@.tmp
	@@sort -u <${WRKPKG}/depends${SUBPACKAGE} >>$@@.tmp
d1225 1
a1225 1
	@@sed -e '/^!%%SHARED%%$$/r${PKGDIR}/PFRAG.no-shared${SUBPACKAGE}' \
d1228 1
a1228 2
	    -e '//d' -e '/^%%SHARED%%$$/d' <${PLIST} ${SED_PLIST} \
	    >>$@@.tmp && mv -f $@@.tmp $@@
d1235 1
a1235 1
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
d1242 1
a1242 1
		    >>$@@.tmp && mv -f $@@.tmp $@@; \
d1248 1
a1248 1
	    -e '//d' <${PLIST} ${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
d1250 1
d1253 1
a1253 1
	    -e '//d' <${PLIST} ${SED_PLIST} >>$@@.tmp && mv -f $@@.tmp $@@
d1255 1
@


1.37
log
@Use correct paths for unlibtoolise, oops. At least, PLISTs should no longer
be completely empty now.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.36 2005/07/18 17:14:31 bsiegert Exp $
d342 1
a342 1
SED_PLIST+=	|(cd ${WRKINST}${PREFIX} ; perl ${PORTSDIR}/infrastructure/scripts/unlibtoolise)
@


1.36
log
@Unbreak (hopefully) unlibtoolise.

* Move the script invocation after fragment substitution
* Only add files from *.la if they are not already present in the PLIST, thus
  prevent double inclusion for ports which are not yet libtoolised (i.e. all)
* use @@lib where applicable

The clou is that we do not need to mark .la files specially, it just
works(TM)---at least I hope so. Please test.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.34 2005/07/05 22:26:56 bsiegert Exp $
d342 1
a342 1
SED_PLIST+=	|(cd ${WRKINST} ; perl ${SCRIPTDIR}/unlibtoolise)
@


1.35
log
@Add unlibtoolise invocation, untested.

ok tg@@
@
text
@a296 2
SED_PLIST+=	|(cd ${WRKINST} ; perl ${SCRIPTDIR}/unlibtoolise)

d342 2
@


1.34
log
@do not hardcode /usr/local in libtoolise_plist
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.33 2005/07/05 20:08:29 tg Exp $
d297 2
@


1.33
log
@* capitalise the initial letter on Distfiles, Packages, etc.
* slightly change the Packages layout

agreed bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.32 2005/07/05 19:31:46 tg Exp $
d2143 1
@


1.32
log
@PKGNAME defaults to DISTNAME-0 now (debian style)

this is kind of a MirPorts flag day; in the future, all packages
will be required to have a patch level, starting at 0 and increasing
strongly monotonically, in the decimal number system.

Please do not update your ports framework yet; there will be a lot
more changes to this flag day.

If upgrading, make sure you deinstall *ALL* packages first and leave
nothing around in /usr/ports/packages .

ok ("fein") bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.31 2005/07/05 18:50:20 tg Exp $
d58 2
a59 2
DISTDIR?=		${PORTSDIR}/distfiles
BULK_COOKIES_DIR?=	${PORTSDIR}/bulk/${MACHINE_ARCH}
d63 3
a65 4
PKGREPOSITORYBASE?=	${PORTSDIR}/packages/${MACHINE_ARCH}
PKGREPOSITORY?=		${PKGREPOSITORYBASE}/all
CDROM_PACKAGES?=	${PKGREPOSITORYBASE}/cdrom
FTP_PACKAGES?=		${PKGREPOSITORYBASE}/ftp
@


1.31
log
@* volgens bsiegert@@ we do not support the espietools at all
* while here, correct some more spelling
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.30 2005/07/04 18:41:40 tg Exp $
d343 1
a343 1
PKGNAME?=		${DISTNAME}
@


1.30
log
@wc -c | awk? no way
use mksh instead.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.29 2005/06/23 17:01:19 tg Exp $
d295 1
a295 1
# Support architecture and flavor dependent packing lists
d298 1
a298 1
# Build FLAVOR_EXT, checking that no flavors are misspelled
d301 1
a301 1
# It encodes flavors and pseudo-flavors.
a342 6
.if ${MIRBSD_PKGTOOLS:L} == "no"
PKG_ARGS_ADD+=		-A${PKG_ARCH:Q}
.  if ${LOCALBASE} != "/usr/local"
PKG_ARGS_ADD+=		-L${LOCALBASE}
.  endif
.endif
d1372 1
a1372 1
		${_flavor_fragment}; defaulted=false; \
d2070 1
a2070 1
		${_flavor_fragment}; \
d2438 1
a2438 1
		${_flavor_fragment}; \
d2449 1
a2449 1
		${_flavor_fragment}; \
d2499 1
a2499 1
			${_flavor_fragment}; \
d2510 1
a2510 1
			${_flavor_fragment}; \
d2524 1
a2524 1
			${_flavor_fragment}; \
d2548 1
a2548 1
		${_flavor_fragment}; \
d2616 1
a2616 1
		${_flavor_fragment}; \
d2646 1
a2646 1
		${_flavor_fragment}; \
d2663 1
a2663 1
		${_flavor_fragment}; \
@


1.29
log
@"makes sense" bsiegert@@
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.28 2005/06/23 16:53:48 bsiegert Exp $
d1172 1
a1172 2
_size_fragment=		wc -c $$file 2>/dev/null | \
			    awk '{print "SIZE (" $$2 ") = " $$1}'
@


1.28
log
@Add proper support for resolving libspecs on Darwin. I had to edit perl code,
at least I get some beer to help me forget about it.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.27 2005/06/17 20:15:21 tg Exp $
d1038 2
d1041 1
a1041 3
_noshared=		-noshared
.else
_noshared=
d1045 1
a1045 3
_dylib=			-dylib
.else
_dylib=
d1055 1
a1055 1
	    ${PORTSDIR}/infrastructure/scripts/resolve-lib ${_noshared} ${_dylib} $$d) \
@


1.27
log
@instead of the generic <bsd.own.mk> include a "mirports.bsd.mk"
with <sys.mk> for MirPorts inner builds; this is the place to
override e.g. DEBUGLIBS for ports using <bsd.lib.mk>
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.26 2005/06/11 21:12:03 tg Exp $
d1044 6
d1057 1
a1057 1
	    ${PORTSDIR}/infrastructure/scripts/resolve-lib ${_noshared} $$d) \
@


1.26
log
@add "install-binpkg" target, which works like "install" except that
it doesn't want to be called after a successful build and fake.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.25 2005/06/02 22:17:48 tg Exp $
d463 1
a463 1
			EXTRA_SYS_MK_INCLUDES="<bsd.own.mk>"
@


1.25
log
@use gzip -dc, not gzcat
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.24 2005/05/31 20:45:32 bsiegert Exp $
d1939 4
a1962 1
	@@-${SUDO} ${_MAKE_COOKIE} $@@
d2793 1
a2793 1
	full-run-depends homepage-links install \
@


1.24
log
@add @@option gnu-ld for Interix instead of so-links
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.23 2005/05/21 18:08:38 tg Exp $
d705 1
a705 1
GZCAT?=			/usr/bin/gzcat
@


1.23
log
@fake.mtree is modified during make setup, thus it's copied
to db/ (now all Ms in db/ are to be ignored, and all other
paths are without M after make setup)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.22 2005/05/21 14:29:28 tg Exp $
d1253 1
a1253 1
	echo '@@option so-links' >>$@@.tmp; \
@


1.22
log
@on Interix, emit @@option so-links
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.21 2005/05/21 01:52:46 tg Exp $
d665 1
a665 1
MTREE_FILE+=		${PORTSDIR}/infrastructure/templates/fake.mtree
@


1.21
log
@root; install_program_dir
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.20 2005/05/21 01:40:03 tg Exp $
d1252 5
@


1.20
log
@${INSTALL}, not install
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.19 2005/05/21 00:59:31 tg Exp $
d1889 1
a1889 1
	@@${SUDO} ${INSTALL} -d -m 755 -o root -g wheel ${WRKINST}
@


1.19
log
@fix MAKE_COOKIE; gzip path
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.18 2005/05/20 22:04:43 tg Exp $
d1889 1
a1889 1
	@@${SUDO} install -d -m 755 -o root -g wheel ${WRKINST}
@


1.18
log
@${LOCALBASE}/bin first, /bin and /usr/bin later (and sbin anyway)

"makes sense" bsiegert@@ (esp. on non-MirOS)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.17 2005/04/29 18:32:22 tg Exp $
d404 1
a404 1
_MAKE_COOKIE=		touch -f
@


1.17
log
@if MESSAGE is /dev/null, no point!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.16 2005/04/28 20:46:58 tg Exp $
d414 1
a414 1
_PORTPATH?=		${WRKDIR}/bin:/usr/bin:/bin:/usr/sbin:/sbin:${LOCALBASE}/bin:${X11BASE}/bin
@


1.16
log
@we don't use SHA-2 any more, agreed bsiegert@@
optimum would be RIPEMD-160 + either Whirlpool or Tiger
we also need MD5 for legacy, and some people only
provide SHA-1, but these could (after above is in) be
omitted from newly generated checksums.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.15 2005/04/11 15:55:41 tg Exp $
d689 1
a689 1
.  if defined(MESSAGE)
@


1.15
log
@the port part of platform refinal
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.14 2005/04/11 14:52:47 tg Exp $
d412 1
a412 1
_CIPHERS=		rmd160 sha512 sha1 md5
@


1.14
log
@infrastructure part of
 OStype:ARCH (MirBSD:i386)
->
 OStype:OSREV:ARCH (MirBSD:8:i386)
change

If there is *any* operating system out there which
uses colons (:) in its version numbers, tell me.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.13 2005/04/11 14:47:33 tg Exp $
d992 1
a992 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSREV}:${ARCH}"
d994 1
a994 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${OSREV}:${ARCH} (${MACHINE_ARCH})"
@


1.13
log
@indent less and give each shell cmd its own line
for better overview
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.12 2005/04/11 14:43:43 tg Exp $
d983 1
a983 1
	test="${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}"; \
d992 1
a992 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${ARCH}"
d994 1
a994 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${ARCH} (${MACHINE_ARCH})"
d1001 1
a1001 1
	test="${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}"; \
@


1.12
log
@rewrite in ksh for simplicity
added benefit: NOT_FOR_PLATFORM=MirBSD:@@(i386|sparc) now works
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.11 2005/04/10 20:52:25 tg Exp $
d982 5
a986 5
__PLATFORM_OK!=	ok=0; test="${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}"; \
		for match in ${ONLY_FOR_PLATFORM}; do \
			for platform in $$test; do \
				eval [[ $$platform != $$match ]] || ok=1; \
			done; \
d988 3
a990 2
		print $$ok
.    if ${__PLATFORM_OK} == "0"
d997 1
a997 1
.    undef __PLATFORM_OK
d1000 5
a1004 5
__PLATFORM_OK!=	ok=1; test="${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}"; \
		for match in ${NOT_FOR_PLATFORM}; do \
			for platform in $$test; do \
				eval [[ $$platform != $$match ]] || ok=0; \
			done; \
d1006 3
a1008 2
		print $$ok
.    if ${__PLATFORM_OK} == "0"
d1011 1
a1011 1
.    undef __PLATFORM_OK
@


1.11
log
@fix index after NOT/ONLY_FOR_* changes
yes, this reduces one column
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.10 2005/04/10 20:45:02 tg Exp $
d982 8
a989 10
_i:=			${OStype}:${ARCH}
_j:=			${OStype}:${MACHINE_ARCH}
.    for _k in ${ONLY_FOR_PLATFORM}
.      if !empty(_i:M${_k:S/:/\:/g}) || !empty(_j:M${_k:S/:/\:/g})
__PLATFORM_OK=1
.      endif
.    endfor
.    ifdef __PLATFORM_OK
.      undef __PLATFORM_OK
.    else
d996 1
a996 2
.    undef _i
.    undef _j
d999 8
a1006 4
_i:=			${OStype}:${ARCH}
_j:=			${OStype}:${MACHINE_ARCH}
.    for _k in ${NOT_FOR_PLATFORM}
.      if !empty(_i:M${_k:S/:/\:/g}) || !empty(_j:M${_k:S/:/\:/g})
d1008 2
a1009 4
.      endif
.    endfor
.    undef _i
.    undef _j
@


1.10
log
@/usr/local/lib/debug if -g
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.9 2005/04/10 19:41:29 tg Exp $
d2300 7
a2306 14
	@@case "${ONLY_FOR_OS}" in \
	 "") case "${NOT_FOR_OS}" in \
		 "") echo -n "BSD Linux|";; \
		 *) echo -n "!${NOT_FOR_OS}|";; \
		 esac;; \
	 *) echo -n "${ONLY_FOR_OS}|";; \
	 esac
	@@case "${ONLY_FOR_ARCHS}" in \
	 "") case "${NOT_FOR_ARCHS}" in \
		 "") echo -n "any|";; \
		 *) echo -n "!${NOT_FOR_ARCHS}|";; \
		 esac;; \
	 *) echo -n "${ONLY_FOR_ARCHS}|";; \
	 esac
@


1.9
log
@* add wildcards for ONLY_FOR_PLATFORM
* fix . and : confusion (debugging)
* fix error message
* clean up after myself
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.8 2005/04/10 19:36:33 tg Exp $
d429 3
@


1.8
log
@wildcard support for NOT_FOR_PLATFORM

implementation notes:
* nesting .for .for .if does not work
* as does some more nesting stuff
* in general, don't nest for loops
* this way, we even save a loop and an if
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.7 2005/04/10 19:15:41 tg Exp $
d979 4
a982 2
.    for _i in ${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}
.      if !empty(ONLY_FOR_PLATFORM:M${_i:S/:/\:/g})
d986 3
a988 1
.    ifndef __PLATFORM_OK
d992 1
a992 1
IGNORE+=		"is only for ${ONLY_FOR_PLATFORM}, not ${OStype}:${ARCH} \(${MACHINE_ARCH}\)"
d995 2
d999 2
a1000 2
_i:=			${OStype}.${ARCH}
_j:=			${OStype}.${MACHINE_ARCH}
d1002 1
a1002 1
.      if !empty(_i:M${_k}) || !empty(_j:M${_k})
d1006 2
a1007 2
.undef _i
.undef _j
@


1.7
log
@* ONLY_FOR_{ARCH,OS} and NOT_FOR_{ARCH,OS} => {ONLY,NOT}_FOR_PLATFORM
* fix a longstanding bug which would double the error message

no wildcards yet, though
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.6 2005/03/29 12:41:55 tg Exp $
d993 5
a997 3
.    for _i in ${OStype}:${ARCH} ${OStype}:${MACHINE_ARCH}
.      if !empty(NOT_FOR_PLATFORM:M${_i:S/:/\:/g})
__PLATFORM_OK=0
d1000 2
a1001 3
.    if defined(__PLATFORM_OK) && ${__PLATFORM_OK} == "0"
IGNORE+=		"is not for ${NOT_FOR_PLATFORM}"
.    endif
@


1.6
log
@break C++ on -HEAD for now
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.5 2005/03/27 18:41:34 tg Exp $
d978 4
a981 4
.  if defined(ONLY_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(ONLY_FOR_ARCHS:M${__ARCH})
_ARCH_OK=1
d984 3
a986 3
.    if !defined(_ARCH_OK)
.      if ${MACHINE_ARCH} == "${ARCH}"
IGNORE+=		"is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH}"
d988 1
a988 1
IGNORE+=		"is only for ${ONLY_FOR_ARCHS}, not ${MACHINE_ARCH} \(${ARCH}\)"
d992 4
a995 18
.  if defined(NOT_FOR_ARCHS)
.    for __ARCH in ${MACHINE_ARCH} ${ARCH}
.      if !empty(NOT_FOR_ARCHS:M${__ARCH})
IGNORE+=		"is not for ${NOT_FOR_ARCHS}"
.      endif
.    endfor
.  endif
.  if defined(ONLY_FOR_OS)
.    for _m in ${MACHINE_OS}
.      if empty(ONLY_FOR_OS:M${_m})
IGNORE+=		"is only for ${ONLY_FOR_OS}, not ${MACHINE_OS}"
.      endif
.    endfor
.  endif
.  if defined(NOT_FOR_OS)
.    for _m in ${MACHINE_OS}
.      if !empty(NOT_FOR_OS:M${_m})
IGNORE+=		"is not for ${NOT_FOR_OS}"
d998 3
@


1.5
log
@nothing needs build-/run-depends on C++ any more
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.4 2005/03/25 23:42:25 bsiegert Exp $
d445 1
a445 1
.  else
@


1.4
log
@Always add -b to the arguments for patch so that backup files are always
generated.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.mk,v 1.2 2005/03/19 23:15:06 bsiegert Exp $
a442 1
BUILD_DEPENDS+=		${_CXX_BR_DEPENDS}
a443 1
RUN_DEPENDS+=		${_CXX_BR_DEPENDS}
@


1.3
log
@more paths *sigh*
@
text
@d472 2
a473 2
PATCH_ARGS?=		-d ${WRKDIST} -z ${PATCHORIG} -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} -E ${PATCH_DIST_STRIP}
d475 2
a476 2
PATCH_ARGS?=		-d ${WRKDIST} -z ${PATCHORIG} --forward --quiet -E ${PATCH_STRIP}
PATCH_DIST_ARGS?=	-z ${DISTORIG} -d ${WRKDIST} --forward --quiet -E ${PATCH_DIST_STRIP}
@


1.2
log
@more path reshuffling
@
text
@d1 1
a1 1
# $MirOS$
d605 1
a605 1
SYSTRACE_FILTER?=	${PORTSDIR}/infrastructure/db/systrace.filter
@


1.1
log
@Initial revision
@
text
@d664 1
a664 1
MTREE_FILE+=		${PORTSDIR}/infrastructure/db/fake.mtree
d1053 1
a1053 1
	    ${PORTSDIR}/infrastructure/build/resolve-lib ${_noshared} $$d) \
d1432 1
a1432 1
_CHECK_LIBS_SCRIPT=	${PORTSDIR}/infrastructure/install/check-libs-elf
d2148 1
a2148 1
	perl ${PORTSDIR}/infrastructure/install/make-plist ${PKGDIR} ${_tmpvars}
d2155 1
a2155 1
	    ${SHELL} ${PORTSDIR}/infrastructure/build/update-patches); \
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
