head	1.16;
access;
symbols
	MIRBSD_8_BASE:1.4;
locks; strict;
comment	@# @;


1.16
date	2009.05.08.14.57.06;	author bsiegert;	state Exp;
branches;
next	1.15;
commitid	1004A04481D03673C5D;

1.15
date	2009.02.24.18.10.17;	author bsiegert;	state Exp;
branches;
next	1.14;
commitid	10049A4379E3675DE4D;

1.14
date	2008.10.16.19.47.54;	author tg;	state Exp;
branches;
next	1.13;
commitid	10048F79A7E1A8F8C72;

1.13
date	2008.10.16.19.35.55;	author tg;	state Exp;
branches;
next	1.12;
commitid	10048F797AC04EA7640;

1.12
date	2008.06.12.19.50.55;	author tg;	state Exp;
branches;
next	1.11;
commitid	10048517DFF48236388;

1.11
date	2008.03.09.17.22.56;	author tg;	state Exp;
branches;
next	1.10;
commitid	10047D41CAA7E715397;

1.10
date	2007.05.07.23.40.20;	author tg;	state Exp;
branches;
next	1.9;
commitid	100463FB8F322AA966F;

1.9
date	2007.04.03.22.08.30;	author tg;	state Exp;
branches;
next	1.8;
commitid	1004612D02A035C896A;

1.8
date	2007.01.26.20.31.54;	author tg;	state Exp;
branches;
next	1.7;
commitid	10045BA65395CE5338A;

1.7
date	2006.09.13.22.07.12;	author tg;	state Exp;
branches;
next	1.6;
commitid	100450881212EF3914B;

1.6
date	2006.02.09.13.31.31;	author tg;	state Exp;
branches;
next	1.5;
commitid	10043EB4441527CC1CD;

1.5
date	2006.02.09.09.03.43;	author tg;	state Exp;
branches;
next	1.4;
commitid	10043EB055E506F3E16;

1.4
date	2005.12.15.01.24.43;	author tg;	state Exp;
branches;
next	1.3;
commitid	10043A0C5D7068BC1DF;

1.3
date	2005.11.15.19.33.56;	author tg;	state Exp;
branches;
next	1.2;
commitid	7927437a38332782;

1.2
date	2005.07.05.18.50.21;	author tg;	state Exp;
branches;
next	1.1;
commitid	45ea42cad66ff1b2;

1.1
date	2005.03.18.15.47.19;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.1.7.1
date	2005.03.18.15.47.19;	author tg;	state Exp;
branches;
next	;


desc
@@


1.16
log
@Fix a small bug w.r.t. recursive building that would sometimes cause
the "failedport" script to receive garbage in the flavour part.
@
text
@# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.15 2009/02/24 18:10:17 bsiegert Exp $
# $OpenBSD: bsd.port.subdir.mk,v 1.64 2004/04/07 13:06:33 espie Exp $
# $FreeBSD: bsd.port.subdir.mk,v 1.20 1997/08/22 11:16:15 asami Exp $
#
# The include file <bsd.port.subdir.mk> contains the default targets
# for building ports subdirectories.
#
#
# +++ variables +++
#
# STRIP		The flag passed to the install program to cause the binary
#		to be stripped.  This is to be used when building your
#		own install script so that the entire system can be made
#		stripped/not-stripped using a single knob. [-s]
#
# ECHO_MSG	Used to print all the '===>' style prompts - override this
#		to turn them off [echo].
#
# SUBDIR	A list of subdirectories that should be built as well.
#		Each of the targets will execute the same target in the
#		subdirectories.
#
#
# +++ targets +++
#
#	README.html:
#		Creating README.html for package.
#
#	afterinstall, all, beforeinstall, build, checksum, clean, cleandir,
#	configure, depend, describe, extract, fetch, fetch-list,
#	install, package, readmes, deinstall, reinstall,
#	tags

.ifndef	MIRPORTS_SYS_MK
ERRORS+=		"Please upgrade your system Makefile includes."
ERRORS+=		"See http://mirbsd.de/ for instructions."
.endif

.if defined(show)
.MAIN: show
.elif defined(clean)
.MAIN: clean
.else
.MAIN: all
.endif

.if !defined(DEBUG_FLAGS)
STRIP?=		-s
.endif

ECHO_MSG?=	echo

BULK?=		No
.if ${BULK:L} == "yes"
REPORT_PROBLEM?=env PORTSDIR=${PORTSDIR} ${SHELL} ${PORTSDIR}/infrastructure/scripts/failedport $$dir,$$f
.else
REPORT_PROBLEM?=exit 1
.endif

# create a list of subdirectories
.ifdef SUBONLY
SUBDIR=		${SUBONLY}
.elifndef _MANUAL_SUBDIR
_SUBDIR!=	cd ${.CURDIR} && echo */Makefile | \
		    sed -e 's!/Makefile!!g' | sort -R' '
.  if ${_SUBDIR:N\*}
SUBDIR+=	${_SUBDIR}
.  endif
.endif

# create a full list of SUBDIRS...
.if empty(PKGPATH)
_FULLSUBDIR:=	${SUBDIR}
.else
_FULLSUBDIR:=	${SUBDIR:S@@^@@${PKGPATH}/@@g}
.endif

_SKIPPED=
.for i in ${SKIPDIR}
_SKIPPED:+=	${_FULLSUBDIR:M$i}
_FULLSUBDIR:=	${_FULLSUBDIR:N$i}
.endfor


_subdir_fragment= \
	: $${echo_msg:=${ECHO_MSG:Q}}; \
	: $${target:=${.TARGET}}; \
	unset SUBONLY || :; \
	for i in ${_SKIPPED}; do \
		eval $${echo_msg} "===\> $$i skipped"; \
	done; \
	for d in ${_FULLSUBDIR}; do \
		dir=$$d; \
		${_flavour_fragment}; \
		set +e; \
		if [[ $$d != *,* && -r bulklist ]]; then \
			while read flavour; do \
				f=$$([[ -z $$flavour ]] || \
				    sed -e 's/ /,/g' <<<"$$flavour"); \
				tmp_toset="$$toset FLAVOUR=\"$$flavour\""; \
				eval $${echo_msg} "===\> $$dir,$$f"; \
				if ! eval $$tmp_toset ${MAKE} $$target; then \
					${REPORT_PROBLEM}; \
				fi; \
			done <bulklist; \
		else \
			f=; \
			eval $${echo_msg} "===\> $$d"; \
			if ! eval $$toset ${MAKE} $$target; then \
				${REPORT_PROBLEM}; \
			fi; \
		fi; \
	done; set -e

.for __target in all build checksum cleandir configure \
    deinstall describe distclean extract fake fetch fetch-all fetch-makefile \
    homepage-links install lib-depends-check link-categories manpages-check \
    package regress reinstall relevant-checks show unlink-categories
${__target}:
	@@${_subdir_fragment}
.endfor

.for __target in all-dir-depends build-dir-depends run-dir-depends
${__target}:
	@@${_depfile_fragment}; echo_msg=:; ${_subdir_fragment}
.endfor

clean:
.if defined(clean) && ${clean:L:Mdepends}
	@@{ target=all-dir-depends; echo_msg=:; \
	${_depfile_fragment}; ${_subdir_fragment}; }| tsort -r|while read dir; do \
		unset FLAVOUR SUBPACKAGE || true; \
		${_flavour_fragment}; \
		eval $$toset ${MAKE} _CLEANDEPENDS=No clean; \
	done
.else
	@@${_subdir_fragment}
.endif
.if defined(clean) && ${clean:L:Mreadmes}
	rm -f ${.CURDIR}/README.html
.endif

readmes:
	@@${_subdir_fragment}
	@@rm -f ${.CURDIR}/README.html
	@@cd ${.CURDIR} && exec ${MAKE} README.html

TEMPLATES?=	${PORTSDIR}/infrastructure/templates
.if defined(PORTSTOP)
README=		${TEMPLATES}/README.top
.else
README=		${TEMPLATES}/README.category
.endif

README.html:
	@@>$@@.tmp
.for d in ${_FULLSUBDIR}
	@@dir=$d; ${_flavour_fragment}; \
	name=$$(eval $$toset ${MAKE} _print-packagename); \
	case $$name in \
		README) comment=;; \
		*) comment=$$(eval $$toset ${MAKE} show=_COMMENT | ${HTMLIFY});; \
	esac; \
	cd ${.CURDIR}; \
	echo "<dt><a href=\"${PKGDEPTH}$$dir/$$name.html\">$d</a><dd>$$comment" >>$@@.tmp
.endfor
	@@f=${.CURDIR:Q}/pkg/DESCR; \
	 [[ -e $$f ]] || f=${.CURDIR:Q}/DESCR; \
	 sed -e \
	    's%%CATEGORY%%'$$(echo ${.CURDIR:Q} | \
	    sed -e 's.*/\([^/]*\)$$\1')'g' \
	    -e '/%%DESCR%%/r'"$$f" -e '//d' \
	    -e '/%%SUBDIR%%/r$@@.tmp' -e '//d' \
	    <${README:Q} >$@@
	@@rm $@@.tmp

_print-packagename:
	@@echo "README"

.PHONY: _print-packagename all all-dir-depends build build-dir-depends \
    checksum clean cleandir configure deinstall describe distclean \
    extract fake fetch fetch-all fetch-makefile homepage-links install \
    lib-depends-check link-categories manpages-check package \
    readmes regress reinstall relevant-checks run-dir-depends show \
    unlink-categories
@


1.15
log
@If doing a bulk build, instead of exiting when a port does not build, call
a new script "failedport" and continue with the next one.
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.14 2008/10/16 19:47:54 tg Exp $
d107 1
@


1.14
log
@clean up
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.13 2008/10/16 19:35:55 tg Exp $
d52 5
d58 1
@


1.13
log
@make fetch-all a recursive target
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.12 2008/06/12 19:50:55 tg Exp $
d58 2
a59 2
_SUBDIR!=	cd ${.CURDIR} && echo */Makefile \
		    | sed -e 's!/Makefile!!g' | sort -R' '
d92 2
a93 2
				f=$$([[ -z $$flavour ]] || echo "$$flavour" \
				    | sed -e 's/ /,/g'); \
d108 4
a111 6
.for __target in all fetch fetch-all package fake extract cleandir configure \
		 build describe distclean deinstall install \
		 reinstall checksum show fetch-makefile \
		 link-categories unlink-categories regress lib-depends-check \
		 homepage-links manpages-check relevant-checks

a116 1

d173 6
a178 7
.PHONY: all fetch fetch-all package fake extract configure \
	build describe distclean deinstall install \
	reinstall checksum show fetch-makefile \
	link-categories unlink-categories regress lib-depends-check \
	homepage-links manpages-check relevant-checks \
	all-dir-depends build-dir-depends run-dir-depends \
	clean cleandir readmes _print-packagename
@


1.12
log
@if 「«PORTDIR»/pkg/DESCR」 does not exist, use the port directory itself,
not the 「pkg」 subdirectory, as place for DESCR, PLISTs, and PFRAGs.

bsiegert@@ agreed

XXX the PFRAGs must die, IMHO
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.11 2008/03/09 17:22:56 tg Exp $
d108 1
a108 1
.for __target in all fetch package fake extract cleandir configure \
d176 1
a176 1
.PHONY: all fetch package fake extract configure \
@


1.11
log
@bulk convert FLAVOR to FLAVOUR; nuke unused file; convert to $Mdocdate
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.10 2007/05/07 23:40:20 tg Exp $
d163 8
a170 5
	@@cat ${README} | \
		sed -e 's%%CATEGORY%%'$$(echo ${.CURDIR} | sed -e 's.*/\([^/]*\)$$\1')'g' \
			-e '/%%DESCR%%/r${.CURDIR}/pkg/DESCR' -e '//d' \
			-e '/%%SUBDIR%%/r$@@.tmp' -e '//d' \
		> $@@
@


1.10
log
@allow SUBONLY for recursives
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.9 2007/04/03 22:08:30 tg Exp $
d94 1
a94 1
				tmp_toset="$$toset FLAVOR=\"$$flavour\""; \
d128 1
a128 1
		unset FLAVOR SUBPACKAGE || true; \
@


1.9
log
@out-of-date returned an error for me because it was trying to get the
description line of, among others, “www/php/extensions,-pgsql” – so far
nothing weird there, but the -pgsql subpackage doesn't exist for the
second line in bulklist

disable bulklist processing if a (any or empty) flavour is given
XXX benny is this correct?
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.8 2007/01/26 20:31:54 tg Exp $
d82 1
@


1.8
log
@make it possible to 'make SUBONLY="foo/bar baz"' like with gcc module
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.7 2006/09/13 22:07:12 tg Exp $
d89 1
a89 1
		if [ -r bulklist ]; then \
@


1.7
log
@fix after $COMMENT changes
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.6 2006/02/09 13:31:31 tg Exp $
d55 3
a57 1
.ifndef _MANUAL_SUBDIR
@


1.6
log
@revert commitid 10043EB055E506F3E16
changes the INDEX wrongly
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.4 2005/12/15 01:24:43 tg Exp $
d155 1
a155 2
		*) comment=$$(eval $$toset ${MAKE} show=_COMMENT \
		    | sed -e 's,^",,' -e 's,"$$,,' | ${HTMLIFY});; \
@


1.5
log
@add a trailing space to the FLAVOR="$flavour" mmake ... line in the
FLAVOR environment variable to (hopefully) ensure that for an empty
line in bulklist the correct flavour (none, not default) is chosen.
@
text
@d91 1
a91 1
				tmp_toset="$$toset FLAVOR=\"$$flavour\" "; \
@


1.4
log
@* use ${FOO:Q} i.p.v. '${FOO}' or "${FOO}"
* replace v='' and v="" with v= while here
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.3 2005/11/15 19:33:56 tg Exp $
d91 1
a91 1
				tmp_toset="$$toset FLAVOR=\"$$flavour\""; \
@


1.3
log
@crude U+0060 removal
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.2 2005/07/05 18:50:21 tg Exp $
d154 1
a154 1
		README) comment='';; \
@


1.2
log
@* volgens bsiegert@@ we do not support the espietools at all
* while here, correct some more spelling
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/mk/bsd.port.subdir.mk,v 1.1.7.1 2005/03/18 15:47:19 tg Exp $
d152 1
a152 1
	name=`eval $$toset ${MAKE} _print-packagename`; \
d155 2
a156 1
		*) comment=`eval $$toset ${MAKE} show=_COMMENT|sed -e 's,^",,' -e 's,"$$,,' |${HTMLIFY}`;; \
d162 1
a162 1
		sed -e 's%%CATEGORY%%'`echo ${.CURDIR} | sed -e 's.*/\([^/]*\)$$\1'`'g' \
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $MirOS$
d85 1
a85 1
		${_flavor_fragment}; \
d126 1
a126 1
		${_flavor_fragment}; \
d151 1
a151 1
	@@dir=$d; ${_flavor_fragment}; \
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
