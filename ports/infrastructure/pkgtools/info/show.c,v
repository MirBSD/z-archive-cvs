head	1.7;
access;
symbols
	bsiegert-cfgfile_BASE:1.7
	bsiegert-cfgfile:1.7.0.2
	MIRBSD_8_BASE:1.4;
locks; strict;
comment	@ * @;


1.7
date	2009.10.20.19.32.49;	author bsiegert;	state Exp;
branches
	1.7.2.1;
next	1.6;
commitid	1004ADE102745DDB74A;

1.6
date	2007.07.08.02.00.45;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004690454979DE27F1;

1.5
date	2007.03.30.23.20.11;	author bsiegert;	state Exp;
branches;
next	1.4;
commitid	100460D99284E3410CC;

1.4
date	2005.05.06.17.35.15;	author tg;	state Exp;
branches;
next	1.3;
commitid	62dc427baac5a272;

1.3
date	2005.04.11.21.08.22;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.04.11.20.57.41;	author tg;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.7.2.1
date	2010.05.31.20.22.18;	author bsiegert;	state Exp;
branches;
next	;
commitid	1004C041A70074F187B;

1.1.7.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches;
next	;


desc
@@


1.7
log
@New plist entry type "@@nolib", for use with .la files, which will NOT be passed
through libtoolise/unlibtoolise. Needed for GNU Smalltalk
@
text
@/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.6 2007/07/08 02:00:45 tg Exp $ */
/* $OpenBSD: show.c,v 1.13 2003/08/21 20:24:56 espie Exp $ */

/*
 * FreeBSD install - a package for the installation and maintainance
 * of non-core utilities.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * Jordan K. Hubbard
 * 23 Aug 1993
 *
 * Various display routines for the info module.
 */

#include <err.h>

#include "lib.h"
#include "info.h"

__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.6 2007/07/08 02:00:45 tg Exp $");

/* structure to define entries for the "show table" */
typedef struct show_t {
	pl_ent_t	sh_type;	/* type of entry */
	const char	*sh_quiet;	/* message when quiet */
	const char	*sh_verbose;	/* message when verbose */
} show_t;

/* the entries in this table must be ordered the same as pl_ent_t constants */
static show_t	showv[] = {
	{	PLIST_FILE,	"%s",		"File: %s" },
	{	PLIST_CWD,	"@@cwd %s",	"\tCWD to: %s" },
	{	PLIST_CMD,	"@@exec %s",	"\tEXEC '%s'" },
	{	PLIST_CHMOD,	"@@chmod %s",	"\tCHMOD to %s" },
	{	PLIST_CHOWN,	"@@chown %s",	"\tCHOWN to %s" },
	{	PLIST_CHGRP,	"@@chgrp %s",	"\tCHGRP to %s" },
	{	PLIST_COMMENT,	"@@comment %s",	"\tComment: %s" },
	{	PLIST_ARCH,	"@@arch %s",	"\tComment: @@arch %s" },
	{	PLIST_IGNORE,	NULL,	NULL },
	{	PLIST_NAME,	"@@name %s",	"\tPackage name: %s" },
	{	PLIST_UNEXEC,	"@@unexec %s",	"\tUNEXEC '%s'" },
	{	PLIST_SRC,	"@@srcdir: %s",	"\tSRCDIR to: %s" },
	{	PLIST_DISPLAY,	"@@display %s",	"\tInstall message file: %s" },
	{	PLIST_PKGDEP,	"@@pkgdep %s",	"\tPackage depends on: %s" },
	{	PLIST_MTREE,	"@@mtree %s",	"\tPackage mtree file: %s" },
	{	PLIST_DIR_RM,	"@@dirrm %s",	"\tDeinstall directory remove: %s" },
	{	PLIST_OPTION,	"@@option %s",	"\tPackage has option: %s" },
	{	PLIST_PKGCFL,	"@@pkgcfl %s",	"\tPackage conflicts with: %s" },
	{	PLIST_EXTRA,	"@@extra %s",	"\tExtra files: %s" },
	{	PLIST_EXTRAUNEXEC,
				"@@extraunexec %s",
						"\tExtra UNEXEC: %s" },
	{	PLIST_SAMPLE,	"@@sample %s",	"\tInstall configuration file: %s" },
	{	PLIST_LIB,	"@@lib %s",	"\tShared library: %s" },
	{	PLIST_SHELL,	"@@shell %s",	"\tShell: %s" },
	{	PLIST_ENDFAKE,	"@@endfake",	"\tEnd of fake point" },
	{	PLIST_LDCACHE,	"@@ldcache %s",	"\tShared libraries enabled: %s" },
	{	PLIST_EMUL,	"@@emul %s",	"\tNeeds binary emulation: %s" },
	{	PLIST_NOLIB,	"@@nolib %s",	"\tLibtool library (no expansion): %s" },
	{	-1,		NULL,		 NULL }
};

void
show_file(const char *title, const char *fname)
{
	FILE *fp;
	char line[1024];
	int n;

	if (!Quiet) {
		printf("%s%s", InfoPrefix, title);
	}
	if ((fp = fopen(fname, "r")) == NULL) {
		printf("ERROR: show_file: Can't open '%s' for reading!\n", fname);
	} else {
		while ((n = fread(line, 1, 1024, fp)) != 0) {
			fwrite(line, 1, n, stdout);
		}
		(void) fclose(fp);
	}
	printf("\n");	/* just in case */
}

void
show_index(const char *title, const char *fname)
{
	FILE *fp;
	char line[MAXINDEXSIZE+2];

	strlcpy(line, "???\n", sizeof(line));

	if (!Quiet) {
		printf("%s%-20s ", InfoPrefix, title);
	}
	if ((fp = fopen(fname, "r")) == NULL) {
		pwarnx("show_file (%s): can't open '%s' for reading", title, fname);
	}
	else {
		if (fgets(line, MAXINDEXSIZE+1, fp)) {
			int  line_length = strlen(line);

			if (line[line_length-1] != '\n') {
				line[line_length] = '\n';
				line[line_length+1] = 0;
			}
		}
		(void) fclose(fp);
	}
        (void) fputs(line, stdout);
}

/* Show a packing list item type.  If type is PLIST_SHOW_ALL, show all */
void
show_plist(const char *title, package_t *plist, pl_ent_t type)
{
    plist_t *p;
    bool ign;
    show_t *showr;

    if (!Quiet) {
	printf("%s%s", InfoPrefix, title);
    }
    for (ign = false, p = plist->head; p ; p = p->next) {
	if (p->type == type || type == PLIST_SHOW_ALL) {
		for (showr = showv; (showr->sh_type != p->type) && (showr->sh_type != -1); showr++);
		switch(p->type) {
		case PLIST_FILE:
			printf(Quiet ? showr->sh_quiet : showr->sh_verbose, p->name);
			if (ign) {
				if (!Quiet) {
					printf(" (ignored)");
				}
				ign = false;
			}
			break;
		case PLIST_CHMOD:
		case PLIST_CHOWN:
		case PLIST_CHGRP:
			printf(Quiet ? showr->sh_quiet : showr->sh_verbose,
				p->name ? p->name : "(clear default)");
			break;
		case PLIST_IGNORE:
			ign = true;
			break;
		case PLIST_CWD:
		case PLIST_CMD:
		case PLIST_SRC:
		case PLIST_UNEXEC:
		case PLIST_COMMENT:
		case PLIST_NAME:
		case PLIST_DISPLAY:
		case PLIST_PKGDEP:
		case PLIST_MTREE:
		case PLIST_DIR_RM:
		case PLIST_OPTION:
		case PLIST_PKGCFL:
		case PLIST_EXTRA:
		case PLIST_EXTRAUNEXEC:
		case PLIST_SAMPLE:
		case PLIST_ARCH:
		case PLIST_LIB:
		case PLIST_SHELL:
		case PLIST_ENDFAKE:
		case PLIST_LDCACHE:
		case PLIST_EMUL:
		case PLIST_NOLIB:
			printf(Quiet ? showr->sh_quiet : showr->sh_verbose, p->name);
			break;
		default:
			pwarnx("unknown command type %d (%s)", p->type, p->name);
		}
		(void) fputc('\n', stdout);
	}
    }
}

/* Show all files in the packing list (except ignored ones) */
void
show_files(const char *title, package_t *plist)
{
	plist_t	*p;
	bool	ign;
	const char *dir = ".";

	if (!Quiet) {
		printf("%s%s", InfoPrefix, title);
	}
	for (ign = false, p = plist->head; p ; p = p->next) {
		switch(p->type) {
		case PLIST_FILE:
		case PLIST_INFO:
		case PLIST_MAN:
		case PLIST_LIB:
			if (!ign) {
				printf("%s/%s\n", dir, p->name);
			}
			ign = false;
			break;
		case PLIST_CWD:
			dir = p->name;
			break;
		case PLIST_IGNORE:
			ign = true;
			break;
		default:
			break;
		}
	}
}
@


1.7.2.1
log
@Add support for @@newde and @@libdep, they can show up at least in uninstalled
packages when viewed with -v.
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.7 2009/10/20 19:32:49 bsiegert Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.7 2009/10/20 19:32:49 bsiegert Exp $");
a60 2
	{	PLIST_NEWDEP,	"@@newdep %s",	"\tNew package dependency: %s" },
	{	PLIST_LIBDEP,	"@@libdep %s",	"\tLibrary dependency: %s" },
a166 2
		case PLIST_NEWDEP:
		case PLIST_LIBDEP:
@


1.6
log
@enlarge width of first display column so that AT LEAST pkgtools-date-0 fits
(flavours still are longer thoâ€¢)
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.5 2007/03/30 23:20:11 bsiegert Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.5 2007/03/30 23:20:11 bsiegert Exp $");
d67 1
d174 1
@


1.5
log
@Implement one of the points from my todo list: @@emul directives for
plists. If EMUL is set in a port's Makefile (e.g. EMUL=linux for a port
which needs linux emulation), this fact is entered into the package.
pkg_add checks for the relevant emulation.

- introduce new piperead() function, which executes a command and reads
  one line of output. Carefully crafted to avoid errors.
- new option for pkg_create: -e gives an initial value for @@emul
- bsd.port.mk: add -e to PKG_ARGS if EMUL given
- new function have_emulation(): Is the emulation enabled (via sysctl
  -n) or, alternatively, are we already running the "right" OS?
- pkg_info: show @@emul directive
- documentation: document EMUL and @@emul
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.4 2005/05/06 17:35:15 tg Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.4 2005/05/06 17:35:15 tg Exp $");
d100 1
a100 1
		printf("%s%-18s ", InfoPrefix, title);
@


1.4
log
@show @@lib @@man and @@info (if contained in +CONTENTS) as files
this unbreaks, among possibly many others, pine's LIB_DEPENDS
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.3 2005/04/11 21:08:22 tg Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.3 2005/04/11 21:08:22 tg Exp $");
d66 1
d172 1
@


1.3
log
@unbreak infrastructure/scripts/out-of-date (well, sort of)

anyone know perl?

--- /tmp/outdated.lJWK32478/old Mon Apr 11 21:07:21 2005
+++ /tmp/outdated.lJWK32478/new Mon Apr 11 21:07:21 2005
@@@@ -2,32 +2,66 @@@@
 autoconf-2.59p1
 bzip2-1.0.2
 c-client-4.61p3
+c-client-4.61p3-ldap
+c-client-4.61p3-ldap-plaintext
+c-client-4.61p3-plaintext
 daemontools-0.76
...

If so, then help us fix it, thanks.
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.2 2005/04/11 20:57:41 tg Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.2 2005/04/11 20:57:41 tg Exp $");
d195 3
@


1.2
log
@two new types
@
text
@d1 1
a1 1
/* $MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.1.7.1 2005/03/18 15:47:16 tg Exp $ */
d28 1
a28 1
__RCSID("$MirOS: ports/infrastructure/pkgtools/info/show.c,v 1.1.7.1 2005/03/18 15:47:16 tg Exp $");
d166 5
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
/* $MirOS$ */
d28 1
a28 1
__RCSID("$MirOS$");
d64 2
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
