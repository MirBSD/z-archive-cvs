head	1.17;
access;
symbols
	bsiegert-cfgfile_BASE:1.17
	bsiegert-cfgfile:1.17.0.2
	MIRBSD_8_BASE:1.11;
locks; strict;
comment	@# @;


1.17
date	2008.11.02.19.20.09;	author tg;	state Exp;
branches;
next	1.16;
commitid	100490DFD7966E23BD3;

1.16
date	2008.03.12.23.46.49;	author tg;	state Exp;
branches;
next	1.15;
commitid	10047D86B785789EAF0;

1.15
date	2008.03.12.23.43.13;	author tg;	state Exp;
branches;
next	1.14;
commitid	10047D86A9C2D04FA59;

1.14
date	2006.12.28.20.19.10;	author tg;	state Exp;
branches;
next	1.13;
commitid	100459426CE27801321;

1.13
date	2006.08.26.23.34.17;	author tg;	state Exp;
branches;
next	1.12;
commitid	10044F0D836486F5483;

1.12
date	2006.01.25.20.50.51;	author tg;	state Exp;
branches;
next	1.11;
commitid	10043D7E4C06D742E4E;

1.11
date	2005.10.21.20.10.29;	author tg;	state Exp;
branches;
next	1.10;
commitid	58ce43594b233c28;

1.10
date	2005.09.19.19.35.30;	author tg;	state Exp;
branches;
next	1.9;
commitid	104c432f13097610;

1.9
date	2005.09.12.22.53.20;	author tg;	state Exp;
branches;
next	1.8;
commitid	6e6c432606e897b6;

1.8
date	2005.09.02.13.43.06;	author bsiegert;	state Exp;
branches;
next	1.7;
commitid	6b01431856ab5899;

1.7
date	2005.08.20.12.33.54;	author tg;	state Exp;
branches
	1.7.2.1;
next	1.6;
commitid	1bdf4307228d6819;

1.6
date	2005.05.23.11.59.58;	author tg;	state Exp;
branches;
next	1.5;
commitid	74b54291c5cd712a;

1.5
date	2005.05.23.11.02.41;	author tg;	state Exp;
branches;
next	1.4;
commitid	1c334291b853b81d;

1.4
date	2005.04.12.20.35.29;	author tg;	state Exp;
branches;
next	1.3;

1.3
date	2005.04.11.21.05.02;	author tg;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.25.23.44.43;	author bsiegert;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.7.2.1
date	2005.08.21.11.17.54;	author tg;	state Exp;
branches;
next	1.7.2.2;
commitid	63fa430862e721e6;

1.7.2.2
date	2005.08.21.11.56.43;	author tg;	state Exp;
branches;
next	1.7.2.3;
commitid	ee843086c086e5e;

1.7.2.3
date	2005.09.01.22.05.38;	author tg;	state Exp;
branches;
next	1.7.2.4;
commitid	609043177b42f25b;

1.7.2.4
date	2005.09.11.00.49.38;	author tg;	state Exp;
branches;
next	1.7.2.5;
commitid	7a1e43237f292c25;

1.7.2.5
date	2005.09.11.02.04.02;	author tg;	state Exp;
branches;
next	;
commitid	1604323908f2ff4;

1.1.7.1
date	2005.03.18.15.47.16;	author tg;	state Exp;
branches;
next	;


desc
@@


1.17
log
@${DEBUG} may be -g but never a CPPFLAGS
@
text
@# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.16 2008/03/12 23:46:49 tg Exp $
# $OpenBSD: Makefile.inc,v 1.2 1997/09/21 11:44:03 deraadt Exp $

.ifndef _MODPORTS_INFRASTRUCTURE_PKGTOOLS_MAKEFILE_INC
_MODPORTS_INFRASTRUCTURE_PKGTOOLS_MAKEFILE_INC=1

LOCALBASE?=	/usr/mpkg	# overridden by setup.ksh
PKG_DB_DIR?=	${LOCALBASE}/db	# path for package databases, etc.
#				# can also be overridden by environment
BSD_PREFIX=	${LOCALBASE}	# path for binaries, man page, etc.
#				# usually not overridden

BINDIR=		${BSD_PREFIX}/sbin
CPPFLAGS+=	-D_PATH_REFCNTDB=\"${PKG_DB_DIR}/shareddirs.db\"
CPPFLAGS+=	-DDEF_LOG_DIR=\"${PKG_DB_DIR}/pkg\"

.include <bsd.own.mk>

.ifndef LIB
CPPFLAGS+=	-I${.CURDIR}/../lib

.  include <bsd.obj.mk>
.  if exists(${.CURDIR}/../lib/${__objdir})
LDADD+=		-L${.CURDIR}/../lib/${__objdir} -linstall
DPADD+=		${.CURDIR}/../lib/${__objdir}/libinstall.a
.  else
LDADD+=		-L${.CURDIR}/../lib -linstall
DPADD+=		${.CURDIR}/../lib/libinstall.a
.  endif
.endif

.if ${OStype} != "MirBSD"
PORTABLE=	Yes
.endif

.if exists(${.SYSMK}/libmirmake.a)
CPPFLAGS+=	-I${.SYSMK}
LDADD+=		-L${.SYSMK} -lmirmake
.endif

.if ${OStype} == "Interix"
LDADD+=		-ldb
.endif

.if ${BINOWN} != "root"
CPPFLAGS+=	-DAS_USER
.endif

PORTABLE?=	no
.if ${PORTABLE:L} != "yes"
COPTS+=		-Wall -Werror
.endif

.endif
@


1.16
log
@like mircksum, use libmirmake _always_ if it exists
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.15 2008/03/12 23:43:13 tg Exp $
d20 1
a20 1
CPPFLAGS+=	${DEBUG} -I${.CURDIR}/../lib
@


1.15
log
@Initial support for running the MirPorts Framework (mirports)
on MidnightBSD (mnbsd), parallel to their native â€œmportsâ€:
â€¢ the test was on stargazer, which is a FreeBSD â€œupgradedâ€ to
  mnbsd, so there may be differences to a real mnbsd-current
â€¢ we do need upgraded MirMake, but I didnâ€™t release that yet,
  since Iâ€™d have to test it first
â€¢ the default MANPATH needs a re-check, like OpenBSD
â€¢ the setup.ksh change installs lndir(1) and a tzfile.h from
  ports/infrastructure/install/ manually; this should be moved
  into MirMake (at least lndir, which is part of XFree86Â®, which,
  in turn, is seen less and less in the public, sadly)
â€¢ builds paxmirabilis (MirCpio), MirPatch, GNU m4, MirCksum,
  lndir (see above), and the MirPackageTools â˜º
â€¢ uses gcc spec file, like Darwin, to call native ld as collect2
  after parsing -Wl,--library-after (XXX why does OpenBSD not
  need this, does it use $PATH to call ld? if so, why none else?)
â€¢ XXX HAS_TIMET64=No on LP64 platforms?
â€¢ XXX does mnbsd not have systrace?

Additional tweaks:
â€¢ bump Â© and stuff
â€¢ use a temporary playpen in LOCALBASE/tmp while upgrading,
  so that pkg_add paxmirabilis*cgz does not need to use tar
  to copy over the new files _after_ removing tarâ€¦
â€¢ use full path to pkg_add when calling it manually
â€¢ resolve possible conflict of a native rmd160(1) while
  bootstrapping GNU m4, when MirCksum is already installed
  XXX remove _CKSUM_SIZE and _CKSUM_A compatibility crap ASAP
â€¢ if collect2 isnâ€™t known by gcc, use ld instead in the wrapper
â€¢ in pkgtools, always link against libmirmake unless OpenBSD/MirBSD
  (XXX in cksum, we always link against it if it exists)
â€¢ XXX possibly remove the dependency of MirCpio to tzfile.h
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.14 2006/12/28 20:19:10 tg Exp $
d36 1
a36 1
.if (${OStype} != "MirBSD") && (${OStype} != "OpenBSD")
@


1.14
log
@this builds fine without -Wno-unreachable-code these days
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.13 2006/08/26 23:34:17 tg Exp $
d36 1
a36 1
.if (${MACHINE_OS} == "Darwin") || (${MACHINE_OS} == "Interix")
@


1.13
log
@OStype vs MACHINE_OS confusion, try to clean up the mess:

We use MACHINE_OS to distinguish between different OSes, i.e.
 BSD Darwin Interix Linux

Within these, there are OStype per MACHINE_OS, e.g.
 BSD -> MirBSD OpenBSD
 Darwin -> Darwin
 Interix -> Interix MirInterix
 Linux -> Debian

These are only the OStype""s seen until now,
so please use what semantically fits, e.g. on
Interix and MirInterix, you don't have IPv6,
but on MirInterix you won't need an explicit
texinfo dependency since it's in the base system.
Be aware that OStype can be user defined though!
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.12 2006/01/25 20:50:51 tg Exp $
a52 1
CDIAGFLAGS+=	-Wno-unreachable-code
@


1.12
log
@PKG_USER -> BINOWN
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.11 2005/10/21 20:10:29 tg Exp $
d36 1
a36 1
.if (${OStype} == "Darwin") || (${OStype} == "Interix")
@


1.11
log
@* use new MirMake
* CFLAGS+= -> include bsd.own.mk + COPTS+=

both together make pkgtools use system cflags too
(mirmake itself doesn't, but it can't easily due to its portability)
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.10 2005/09/19 19:35:30 tg Exp $
d45 1
a45 2
PKG_USER?=	root
.if ${PKG_USER} != "root"
@


1.10
log
@shove all this -L../lib stuff into Makefile.inc
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.9 2005/09/12 22:53:20 tg Exp $
d17 2
d52 1
a52 1
CFLAGS+=	-Wall -Werror
@


1.9
log
@join tg-ports-devel branch into HEAD
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7.2.5 2005/09/11 02:04:02 tg Exp $
d17 13
@


1.8
log
@Change libhash.a to libmirmake.a for Darwin. This has been gone unnoticed
way too long. Does anybody ever use this?

Discovered while doing a new install of MirPorts on my brand-new, shining
Mac Mini :).
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.6 2005/05/23 11:59:58 tg Exp $
d7 9
a15 2
NEW_LOCALBASE?=	/usr/mpkg
DB_DIR?=	${NEW_LOCALBASE}/db
d17 1
a17 6
LOCALBASE?=	/usr/mpkg
PREFIX?=	${LOCALBASE}
.if ${OStype} == "Darwin"
MANDIR=		${LOCALBASE}/man/cat
INCS=		-I${.SYSMK}
LIBS=		${.SYSMK}/libmirmake.a
d21 4
a24 1
BINDIR=		${PREFIX}/sbin
d26 3
a28 3
CPPFLAGS+=	-D_PATH_REFCNTDB=\"${DB_DIR}/shareddirs.db\"
CPPFLAGS+=	-DDEF_LOG_DIR=\"${DB_DIR}/pkg\"
CPPFLAGS+=	${INCS}
d30 4
a33 1
LDADD+=		${LIBS}
@


1.7
log
@half-hearted attempt to unify LOCALBASE to /usr/mpkg for all platforms
agreed some time ago bsiegert@@
no veto on miros-discuss@@

for now, hardcode PREFIX to /usr/local for imake and old-install ports
(we should probably do something about imake anyway, regarding both
Interix and Darwin - maybe require our own XFree86® port, but later...)

some of the code (especially shell and make) will be rewritten now,
since it can be simplified (nuking bugs, maybe)

what about changing /etc/mk.conf as well (conflict with obsd and maybe
others)? I think of /etc/${MAKE}.cfg (MAKE=make or mmake) maybe?

please test, as usual...
@
text
@d15 1
a15 1
LIBS=		${.SYSMK}/libhash.a
@


1.7.2.1
log
@simplify pkgtools build
XXX move mbcompat into mirmake?
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7 2005/08/20 12:33:54 tg Exp $
d7 3
a9 1
# Where MirPorts live
a10 2

# Where we live
d12 4
a15 12
# Where we place our database
DB_DIR?=	${LOCALBASE}/db


BINDIR=		${PREFIX}/sbin
.if ${PREFIX} == "/usr"
MANDIR=		${PREFIX}/share/man/cat
.else
MANDIR=		${PREFIX}/man/cat
.endif

.if ${OStype} != "MirBSD"
d19 1
a19 9
.if (${OStype} == "Darwin") || (${OStype} == "Interix")
CPPFLAGS+=	-I${.SYSMK}
LDADD+=		-L\${.SYSMK} -lmirmake
.endif

.if ${OStype} == "Interix"
LDADD+=		-ldb
NEED_COMPAT=	Yes
.endif
d23 3
@


1.7.2.2
log
@mbcompat is now part of libmirmake
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7.2.1 2005/08/21 11:17:54 tg Exp $
d34 1
@


1.7.2.3
log
@shuffle stuff around a bit
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7.2.2 2005/08/21 11:56:43 tg Exp $
d7 15
a21 9
LOCALBASE?=	/usr/mpkg	# overridden by setup.ksh
PKG_DB_DIR?=	${LOCALBASE}/db	# path for package databases, etc.
				# can also be overridden by environment
BSD_PREFIX?=	${LOCALBASE}	# path for binaries, man page, etc.
				# usually not overridden

BINDIR=		${BSD_PREFIX}/sbin
CPPFLAGS+=	-D_PATH_REFCNTDB=\"${PKG_DB_DIR}/shareddirs.db\"
CPPFLAGS+=	-DDEF_LOG_DIR=\"${PKG_DB_DIR}/pkg\"
d29 1
a29 1
LDADD+=		-L${.SYSMK} -lmirmake
d36 3
@


1.7.2.4
log
@fix the worst programming errors
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7.2.3 2005/09/01 22:05:38 tg Exp $
d9 3
a11 3
#				# can also be overridden by environment
BSD_PREFIX=	${LOCALBASE}	# path for binaries, man page, etc.
#				# usually not overridden
@


1.7.2.5
log
@* -#ifndef __INTERIX
  +#ifndef AS_USER
       if (!Fake && getuid() != 0)
          errx(1, "you must be root to delete packages");
   #endif
  and similar
* make compile with __CRAZY=Yes

bsiegert@@ please look at this diff closely
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.7.2.4 2005/09/11 00:49:38 tg Exp $
a29 5
PKG_USER?=	root
.if ${PKG_USER} != "root"
CPPFLAGS+=	-DAS_USER
.endif

@


1.6
log
@CDIAGFLAGS+= -Wno-unreachable-code
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.5 2005/05/23 11:02:41 tg Exp $
d7 3
a9 1
.if ${OStype} == "Darwin"
d12 1
a16 4
DB_DIR?=	${LOCALBASE}/db
.else
PREFIX?=	/usr
DB_DIR?=	/var/db
@


1.5
log
@* no CRAZY any more, it's __CRAZY in <bsd.own.mk> now
* protect from multiple inclusion, like all other .incs
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.4 2005/04/12 20:35:29 tg Exp $
d32 1
@


1.4
log
@latest MirMake, sorry, you do need it
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.3 2005/04/11 21:05:02 tg Exp $
d4 3
a32 8
.ifdef CRAZY
CFLAGS+=	-Wall -Wextra -Wunused -Wdeclaration-after-statement -Wundef \
		-Wendif-labels -Wshadow -Wpointer-arith -Wbad-function-cast \
		-Wcast-qual -Wcast-align -Wwrite-strings -Wstrict-prototypes \
		-Wold-style-definition -Wmissing-prototypes \
		-Wmissing-declarations -Wmissing-noreturn \
		-Wmissing-format-attribute -Wredundant-decls \
		-Wno-unreachable-code -Winline -pedantic -std=c99
@


1.3
log
@pass make CRAZY=1
@
text
@d1 1
a1 1
# $MirOS: ports/infrastructure/pkgtools/Makefile.inc,v 1.2 2005/03/25 23:44:43 bsiegert Exp $
a5 1
MMAKEDIR=	${LOCALBASE}/share/mmake
d8 2
a9 2
INCS=		-I${MMAKEDIR}
LIBS=		${MMAKEDIR}/libhash.a
@


1.2
log
@Add Darwin compilation options here too, so that a simple "mmake" works to
build the pkgtools.

ok tg@@
@
text
@d1 1
a1 1
# $MirOS$
d30 10
@


1.1
log
@Initial revision
@
text
@d4 10
d15 3
a18 1
DB_DIR?=	/var/db
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
