head	1.7;
access;
symbols;
locks; strict;
comment	@# @;


1.7
date	2012.02.11.19.30.02;	author tg;	state dead;
branches;
next	1.6;
commitid	1004F36C11F02848ED5;

1.6
date	2011.06.11.03.55.37;	author tg;	state Exp;
branches;
next	1.5;
commitid	1004DF2E74A6938C5EF;

1.5
date	2011.05.06.23.17.28;	author tg;	state Exp;
branches;
next	1.4;
commitid	1004DC4819C685DDCFE;

1.4
date	2010.09.19.18.42.03;	author tg;	state Exp;
branches;
next	1.3;
commitid	1004C96598A069420CF;

1.3
date	2010.09.15.23.41.21;	author tg;	state Exp;
branches;
next	1.2;
commitid	1004C9159AB6B64B332;

1.2
date	2010.09.15.20.57.03;	author tg;	state Exp;
branches;
next	1.1;
commitid	1004C9132F41004B31C;

1.1
date	2006.10.02.05.59.18;	author tg;	state Exp;
branches;
next	;
commitid	1004520AAAB453C7791;


desc
@@


1.7
log
@update the CVS package in MirPorts (to match base and Debian)

• since the Debian cvs source package was taken over by this one,
  reverse things and use the Debian *.diff.gz to get our patches
  from ;-) saves tracking things in CVS thrice
• since the Debian cvs binary package contains PDF documentation
  generated from something with our patches, ship it instead of
  the one from the vanilla CVS distfile
• ship cvs-switchroot(1) from Debian, which is just a fancy name
  for mircvs://src/scripts/mnt-cvsroot and has a manpage
• move stuff from PREFIX/share/cvs to PREFIX/share/doc/cvs as is proper
• fix regression testsuite on MirBSD as much as possible (same as base)
@
text
@$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.6 2011/06/11 03:55:37 tg Exp $
--- src/server.c.orig	Wed Sep 28 15:25:37 2005
+++ src/server.c	Sat Jun 11 03:06:20 2011
@@@@ -20,6 +20,8 @@@@
 #include "getline.h"
 #include "getnline.h"
 
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.6 2011/06/11 03:55:37 tg Exp $");
+
 int server_active = 0;
 
 #if defined (SERVER_SUPPORT) || defined (CLIENT_SUPPORT)
@@@@ -823,6 +825,14 @@@@ E Protocol error: Root says \"%s\" but p
     }
 # endif
 
+    if (root_allow_used() && !root_allow_ok(arg))
+    {
+	if (alloc_pending (80 + strlen (arg)))
+	    sprintf (pending_error_text,
+		     "E Bad root %s", arg);
+	return;
+    }
+
     /* For pserver, this will already have happened, and the call will do
        nothing.  But for rsh, we need to do it now.  */
     config = get_root_allow_config (current_parsed_root->directory,
@@@@ -2350,6 +2360,7 @@@@ prepost_proxy_proc (const char *reposito
     bool *pre = closure;
 
     /* %c = cvs_cmd_name
+     * %I = commit ID
      * %p = shortrepos
      * %r = repository
      */
@@@@ -2367,6 +2378,7 @@@@ prepost_proxy_proc (const char *reposito
 # endif /* SUPPORT_OLD_INFO_FMT_STRINGS */
 	                      filter,
 	                      "c", "s", cvs_cmd_name,
+			      "I", "s", global_session_id,
 	                      "R", "s", referrer ? referrer->original : "NONE",
 	                      "p", "s", ".",
 	                      "r", "s", current_parsed_root->directory,
@@@@ -3519,7 +3531,7 @@@@ do_cvs_command (char *cmd_name, int (*co
      * Therefore, we wish to avoid reprocessing the command since that would
      * cause endless recursion.
      */
-    if (isProxyServer())
+    if ((command != version || current_parsed_root) && isProxyServer())
     {
 # ifdef PROXY_SUPPORT
 	if (reprocessing)
@@@@ -4621,6 +4633,14 @@@@ serve_rls (char *arg)
 
 
 static void
+serve_suck (char *arg)
+{
+  do_cvs_command ("suck", suck);
+}
+
+
+
+static void
 serve_add (char *arg)
 {
     do_cvs_command ("add", add);
@@@@ -5962,6 +5982,7 @@@@ struct request requests[] =
   REQ_LINE("rannotate", serve_rannotate, 0),
   REQ_LINE("noop", serve_noop, RQ_ROOTLESS),
   REQ_LINE("version", serve_version, RQ_ROOTLESS),
+  REQ_LINE("suck", serve_suck, 0),
   REQ_LINE(NULL, NULL, 0)
 
 #undef REQ_LINE
@@@@ -6271,8 +6292,12 @@@@ size_t MaxProxyBufferSize = (size_t)(8 *
 
 static const char *const server_usage[] =
 {
+#ifdef ALLOW_CONFIG_OVERRIDE
     "Usage: %s %s [-c config-file]\n",
     "\t-c config-file\tPath to an alternative CVS config file.\n",
+#else
+    "Usage: %s %s\n",
+#endif
     "Normally invoked by a cvs client on a remote machine.\n",
     NULL
 };
@@@@ -6289,8 +6314,8 @@@@ parseServerOptions (int argc, char **arg
     {
 	switch (c)
 	{
-#ifdef ALLOW_CONFIG_OVERRIDE
 	    case 'c':
+#ifdef ALLOW_CONFIG_OVERRIDE
 		if (gConfigPath) free (gConfigPath);
 		gConfigPath = xstrdup (optarg);
 		break;
@@@@ -6887,7 +6912,7 @@@@ cleanup:
 static int
 check_pam_password (char **username, char *password)
 {
-    int retval, err;
+    int retval;
     struct pam_conv conv = { cvs_pam_conv, 0 };
     char *pam_stage = "start";
 
@@@@ -6930,7 +6955,7 @@@@ check_pam_password (char **username, cha
 
     return retval == PAM_SUCCESS;       /* indicate success */
 }
-#endif
+#else /* !HAVE_PAM */
 
 static int
 check_system_password (char *username, char *password)
@@@@ -6996,6 +7021,7 @@@@ error 0 %s: no such user\n", username);
 #endif
     return 1;
 }
+#endif /* !HAVE_PAM */
 
 
 
@


1.6
log
@update and bring them in sync
@
text
@d1 1
a1 1
$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.5 2011/05/06 23:17:28 tg Exp $
d8 1
a8 1
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.5 2011/05/06 23:17:28 tg Exp $");
@


1.5
log
@refresh
@
text
@d1 1
a1 1
$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.4 2010/09/19 18:42:03 tg Exp $
d3 1
a3 1
+++ src/server.c	Fri May  6 21:03:29 2011
d8 1
a8 1
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.4 2010/09/19 18:42:03 tg Exp $");
d53 24
a76 1
@@@@ -6271,8 +6283,12 @@@@ size_t MaxProxyBufferSize = (size_t)(8 *
d89 1
a89 1
@@@@ -6289,8 +6305,8 @@@@ parseServerOptions (int argc, char **arg
d99 1
a99 1
@@@@ -6887,7 +6903,7 @@@@ cleanup:
d108 1
a108 1
@@@@ -6930,7 +6946,7 @@@@ check_pam_password (char **username, cha
d117 1
a117 1
@@@@ -6996,6 +7012,7 @@@@ error 0 %s: no such user\n", username);
@


1.4
log
@hrm, write proxies seem to be broken, but other than that…
@
text
@d1 1
a1 1
$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.3 2010/09/15 23:41:21 tg Exp $
d3 1
a3 1
+++ src/server.c	Sun Sep 19 14:38:03 2010
d8 1
a8 1
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.3 2010/09/15 23:41:21 tg Exp $");
d44 9
@


1.3
log
@oh well… warning freeness (-Wall -Werror on MirBSD, some on MirDebian)
@
text
@d1 1
a1 1
$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.2 2010/09/15 20:57:03 tg Exp $
d3 1
a3 1
+++ src/server.c	Wed Sep 15 23:33:02 2010
d8 1
a8 1
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_server_c,v 1.2 2010/09/15 20:57:03 tg Exp $");
d13 1
a13 2
@@@@ -799,6 +801,14 @@@@ serve_root (char *arg)
 	return;
d15 1
d25 3
a27 3
     /* Set original_parsed_root here, not because it can be changed in the
      * client Redirect sense, but so we don't have to switch in code that
      * runs in both modes to decide which to print.
d44 24
a67 1
@@@@ -6887,7 +6899,7 @@@@ cleanup:
d76 1
a76 1
@@@@ -6930,7 +6942,7 @@@@ check_pam_password (char **username, cha
d85 1
a85 1
@@@@ -6996,6 +7008,7 @@@@ error 0 %s: no such user\n", username);
@


1.2
log
@WIP port (will be worked on more, commit for safety)

Some changes, in this order:
• re-sync with MirOS base cvs
• reduce diff against upstream
• apply cvs-datetime.patch from Arkadiusz Miskiewicz <arekm>
  via Concurrent Versions System - Bugs: bug #21523, can't parse date/time: =UTC when commiting file (workaround/fix attached)
• apply (only those considered somewhat sane) patches from Debian cvs_1:1.12.13-12
  – 11_check_method_crash
  – 12_rcs2log_POSIX_sort
  – 14_ext_expansion
  – 15_PATH_MAX_check
  – 20_readdir_errno
  – 21_getcwd_chroot
  – 25_import-n-X
  – 51_newlines_in_commit_template (partially)
  – 55_keyword_alphanumerics (modified)
  – 62_cvsrc_whitespace
  – 65_login_cvspass_message
  – 69_ext_allowroot (modified)
  – 71_cvsbug_tmpfix
  – 81_fix_-l (modified)
  – 85_normalize_correct_roots
  – 86_server_wrapper (modified)
  – 93_homedir (modified)
  – 95_flag_conflicted_copies
  – 96_manpage_fixes (partially)
  – 97_cvs.info.typo (partially)
  – 98_fix_sparc_sigbus.diff
• document Debian’s changes in the Texinfo manual
• modify mkman.pl to produce more correct looking output
• point to texinfo HTML document from HTML manpage
• fix fseeko configure.in test
• correct bugs in Debian’s changes
@
text
@d1 1
a1 1
$MirOS$
d3 1
a3 1
+++ src/server.c	Wed Sep 15 20:50:30 2010
d8 1
a8 1
+__RCSID("$MirOS$");
d44 26
@


1.1
log
@add cvs port, compiles fine and warning-free on MirOS-current;
other OSes not tested, older MirOS may have issues (mktime, regex/wctype)
@
text
@d3 26
a28 2
+++ src/server.c	Mon Oct  2 04:40:37 2006
@@@@ -2350,6 +2350,7 @@@@ prepost_proxy_proc (const char *reposito
d36 1
a36 1
@@@@ -2367,6 +2368,7 @@@@ prepost_proxy_proc (const char *reposito
@

