head	1.49;
access;
symbols
	MIRBSD_8_BASE:1.20;
locks; strict;
comment	@# @;


1.49
date	2015.10.16.13.19.08;	author tg;	state Exp;
branches;
next	1.48;
commitid	1005620F9660B564E1E;

1.48
date	2014.12.06.15.16.20;	author tg;	state Exp;
branches;
next	1.47;
commitid	10054831DDB4E97BD47;

1.47
date	2014.05.29.18.40.44;	author tg;	state Exp;
branches;
next	1.46;
commitid	10053877F337DFCFA47;

1.46
date	2008.11.08.23.03.29;	author tg;	state Exp;
branches;
next	1.45;
commitid	10049161AC72620EAF0;

1.45
date	2008.10.05.16.17.17;	author tg;	state Exp;
branches;
next	1.44;
commitid	10048E8E8962BD253C0;

1.44
date	2008.07.11.11.22.14;	author tg;	state Exp;
branches;
next	1.43;
commitid	1004877427D302D1139;

1.43
date	2008.05.03.01.28.58;	author tg;	state Exp;
branches;
next	1.42;
commitid	100481BBFDD7988CB52;

1.42
date	2008.05.01.00.52.28;	author tg;	state Exp;
branches;
next	1.41;
commitid	1004819145953F55377;

1.41
date	2008.03.14.17.01.35;	author tg;	state Exp;
branches;
next	1.40;
commitid	10047DAAF4B0AD84942;

1.40
date	2008.03.14.15.40.53;	author tg;	state Exp;
branches;
next	1.39;
commitid	10047DA9C942664D17A;

1.39
date	2008.03.02.15.41.16;	author tg;	state Exp;
branches;
next	1.38;
commitid	10047CACAB202D07353;

1.38
date	2007.10.26.22.22.24;	author tg;	state Exp;
branches;
next	1.37;
commitid	1004722689D52E149CF;

1.37
date	2007.10.14.18.55.55;	author tg;	state Exp;
branches;
next	1.36;
commitid	1004712664935A6879F;

1.36
date	2007.09.11.14.42.28;	author tg;	state Exp;
branches;
next	1.35;
commitid	10046E6A95F7024A806;

1.35
date	2007.08.15.22.22.09;	author tg;	state Exp;
branches;
next	1.34;
commitid	10046C37C7D6B90415B;

1.34
date	2007.07.19.22.40.48;	author tg;	state Exp;
branches;
next	1.33;
commitid	100469FE87B79E0A395;

1.33
date	2007.03.05.21.34.52;	author tg;	state Exp;
branches;
next	1.32;
commitid	10045EC8D0C0E08119F;

1.32
date	2006.12.28.00.51.01;	author tg;	state Exp;
branches;
next	1.31;
commitid	100459315046817BCE8;

1.31
date	2006.09.03.12.51.26;	author tg;	state Exp;
branches;
next	1.30;
commitid	10044FACFE530645EC9;

1.30
date	2006.08.23.10.20.40;	author tg;	state Exp;
branches;
next	1.29;
commitid	10044EC2BEC3D75CD04;

1.29
date	2006.06.25.00.54.19;	author tg;	state Exp;
branches;
next	1.28;
commitid	100449DDEC4216DCD70;

1.28
date	2006.05.27.10.42.18;	author tg;	state Exp;
branches;
next	1.27;
commitid	10044782D187F4953B7;

1.27
date	2006.05.26.23.44.14;	author tg;	state Exp;
branches;
next	1.26;
commitid	100447792E1748EB612;

1.26
date	2006.05.26.22.55.54;	author tg;	state Exp;
branches;
next	1.25;
commitid	1004477878C3C958BB9;

1.25
date	2006.03.19.21.37.09;	author tg;	state Exp;
branches;
next	1.24;
commitid	100441DCF192506B459;

1.24
date	2006.03.19.21.34.21;	author tg;	state Exp;
branches;
next	1.23;
commitid	100441DCE6C6E0D2860;

1.23
date	2006.03.19.21.23.15;	author tg;	state Exp;
branches;
next	1.22;
commitid	100441DCBBE25CC5039;

1.22
date	2006.02.07.21.36.35;	author tg;	state Exp;
branches;
next	1.21;
commitid	10043E912EC66E9B676;

1.21
date	2006.01.13.03.49.23;	author tg;	state Exp;
branches;
next	1.20;
commitid	10043C722F46A94D38C;

1.20
date	2005.12.18.16.36.25;	author tg;	state Exp;
branches;
next	1.19;
commitid	10043A58BE830AFB807;

1.19
date	2005.12.17.05.46.17;	author tg;	state Exp;
branches;
next	1.18;
commitid	10043A3A3E65E20A413;

1.18
date	2005.12.03.22.01.22;	author tg;	state Exp;
branches;
next	1.17;
commitid	3f1b439215c5e108;

1.17
date	2005.11.16.15.29.04;	author tg;	state Exp;
branches;
next	1.16;
commitid	489a437b504194b4;

1.16
date	2005.11.15.16.46.35;	author tg;	state Exp;
branches;
next	1.15;
commitid	3d76437a10c3fc40;

1.15
date	2005.11.10.20.38.09;	author tg;	state Exp;
branches;
next	1.14;
commitid	7fa04373af2a07ff;

1.14
date	2005.11.10.13.11.31;	author tg;	state Exp;
branches;
next	1.13;
commitid	351243734712fdf6;

1.13
date	2005.11.10.13.07.55;	author tg;	state Exp;
branches;
next	1.12;
commitid	2e2b4373462b75af;

1.12
date	2005.11.08.12.04.42;	author tg;	state Exp;
branches;
next	1.11;
commitid	9cf43709447b532;

1.11
date	2005.10.08.19.44.12;	author tg;	state Exp;
branches;
next	1.10;
commitid	42554348219a6448;

1.10
date	2005.09.18.19.42.29;	author tg;	state Exp;
branches;
next	1.9;
commitid	6b4432dc30ce11b;

1.9
date	2005.09.18.19.36.43;	author tg;	state Exp;
branches;
next	1.8;
commitid	26dc432dc17a808d;

1.8
date	2005.09.13.10.52.35;	author tg;	state Exp;
branches;
next	1.7;
commitid	1d934326af7bee86;

1.7
date	2005.09.12.23.25.55;	author tg;	state Exp;
branches;
next	1.6;
commitid	27043260e6a333e;

1.6
date	2005.09.12.23.23.49;	author tg;	state Exp;
branches;
next	1.5;
commitid	9d143260e01fe5a;

1.5
date	2005.09.12.22.17.14;	author tg;	state Exp;
branches;
next	1.4;
commitid	5c064325fe6ec91c;

1.4
date	2005.09.12.21.46.43;	author tg;	state Exp;
branches;
next	1.3;
commitid	ea24325f71f0ce4;

1.3
date	2005.09.12.20.41.15;	author tg;	state Exp;
branches;
next	1.2;
commitid	79364325e7ec4a1b;

1.2
date	2005.09.12.20.36.31;	author tg;	state Exp;
branches;
next	1.1;
commitid	31aa4325e6bb78f0;

1.1
date	2005.09.12.20.15.47;	author tg;	state Exp;
branches;
next	;
commitid	7ea84325e1c462f6;


desc
@@


1.49
log
@extend version check to all possible ones
@
text
@#!/bin/sh
# $MirOS: ports/Setup.sh,v 1.48 2014/12/06 15:16:20 tg Exp $
#-
# Copyright (c) 2005, 2006, 2014, 2015
#	mirabilos <m@@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# This script installs mksh if needed, then calls setup.ksh with it.
# On Interix, nroff is also installed first.

# clean up inherited environment
unset LOCALBASE PORTSDIR SYSCONFDIR X11BASE MAKECONF BINOWN BINGRP

# Constants

test -d ${localbase:-/nonexist} || localbase=/usr/mpkg
test -d ${xfbase:-/nonexist} || xfbase=/usr/X11R6
# ... in case we have XFree86(R) as a port
test -r $localbase/X11/include/X11/X.h && xfbase=$localbase/X11
test -f $localbase/X11/bin/xterm && xfbase=$localbase/X11
export localbase
export xfbase

# minimum req'd version (change this below too)
mksh_ver=34
mksh_date=2008/05/17

mirror=$1
case x$1 in
	x-*)	mirror= ;;
	x)	;;
	*)	shift ;;
esac
if test x"$mirror" = x; then
	mirror=http://www.mirbsd.org/MirOS/dist/
fi
export mirror

# Are we Interix?
isinterix=no
test -n "$SFUDIR" && isinterix=yes
test -n "$OPENNT_ROOT" && isinterix=yes
export isinterix

# Set the PATHs
#%%BEGIN sync Setup.sh with setup.ksh %% paths
p=$localbase/bin:$localbase/sbin
if test $isinterix = no; then
	for a in /usr/local/bin /usr/bin /bin $xfbase/bin /usr/X11R6/bin \
	    /usr/sbin /sbin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
else
	# On Interix, /usr/bin is /bin; gzip lives in /usr/contrib/bin;
	# gcc has yet its own directory; we have X11R5 as well
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin \
	    /usr/sbin /sbin $localbase/sbin $xfbase/bin /usr/X11R6/bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	test -n "$PATH_WINDOWS" && p=$p:/usr/contrib/win32/bin:$PATH_WINDOWS
	test -d /usr/X11R5/bin && p=$p:/usr/X11R5/bin

	LD_LIBRARY_PATH_ORG=$LD_LIBRARY_PATH
	case :$LD_LIBRARY_PATH: in
	*:$xfbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$xfbase/lib:$LD_LIBRARY_PATH ;;
	esac
	case :$LD_LIBRARY_PATH: in
	*:$localbase/lib:*) ;;
	*)	LD_LIBRARY_PATH=$localbase/lib:$LD_LIBRARY_PATH ;;
	esac
	LD_LIBRARY_PATH=${LD_LIBRARY_PATH%%+(:)}
	export LD_LIBRARY_PATH LD_LIBRARY_PATH_ORG
fi
PATH=$p; export PATH
#%%END sync Setup.sh with setup.ksh %% paths

# Where are we?
ourpath=`dirname "$0"`
ourpath=`(cd "$ourpath" && pwd)`
export ourpath
test -z "$DISTDIR" && DISTDIR=$ourpath/Distfiles
test -d "$DISTDIR" || mkdir -p "$DISTDIR"
test -d "$DISTDIR" || DISTDIR=$ourpath/Distfiles
test -d "$DISTDIR" || mkdir -p "$DISTDIR"
export DISTDIR

# Divine a fetching utility
test -z "$fetch" && fetch=false
test x"$fetch" = x"false" && if test $isinterix = yes; then
	# check for Weihenstephan wget
	test -f /dev/fs/C/usr/local/wbin/wget.exe && \
	    fetch="runwin32 c:/usr/local/wbin/wget.exe -O"
	# but prefer MirPorts wget
	test -f $localbase/bin/wget && fetch="$localbase/bin/wget -O"
fi
if test x"$fetch" = x"false"; then
	# Check for ftp/wget/fetch
	for dir in $localbase/bin /usr/{mpkg,local,pkg}/bin /bin /usr/bin; do
		if test -f $dir/wget; then
			fetch="$dir/wget -O"
			break
		fi
		if test -f $dir/fetch; then
			fetch="$dir/fetch -o"
			break
		fi
		if test -f $dir/ftp; then
			fetch="$dir/ftp -o"
			break
		fi
	done
fi
export fetch

# Divine a C compiler
if test -z "$CC"; then
	if mgcc -v >/dev/null 2>&1; then
		CC=mgcc
	elif gcc -v >/dev/null 2>&1; then
		CC=gcc
	else
		CC=cc
	fi
	export CC
fi

# Divine a manual page formatter
test -f "${NROFF-/nonexistent}" || if test -f /usr/bin/nrcon; then
	NROFF=/usr/bin/nrcon
elif test -f $localbase/bin/nrcon; then
	NROFF=$localbase/bin/nrcon
else
	NROFF="/usr/bin/env nroff -Tascii"
fi
export NROFF

# Divine a temporary directory
if T=$(mktemp -d /tmp/mirports.XXXXXXXXXX); then
	:
else
	# May be Interix without mktemp.sh
	T=/tmp/mirports.$$$RANDOM
	if test -d $T; then
		echo Cannot generate temporary directory >&2
		exit 1
	fi
	mkdir -p $T || {
		echo Cannot generate temporary directory >&2
		exit 1
	}
fi
echo Notice: Temporary Directory: $T >&2
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAoEAy5akQiuw0znRhMD0djgQ7BiUPahG1QHJb9ZNApd6D5OnV98FO8Ofbfm4CF1Cvwr+IPnyKyPglQnaFgHF3LVynKMYSupKXnd0JrBR79TBmIVImBnIaTPcApRdWZEbMW5IdYhrWFHKlzk4vDxBXdcVE6QfiemWsYqkiuoJvLTLHXq7WUCQ5z7KuQetMnnP2bswV8SZuYy0IvzQRBVJbiTQzBvsHfyZUERLBZvjtPE9jTaLdTOkKvCuhuTzQAMmG8aYFt9S0p1K20eCCgWvJ5vu3ir875yBrtVPl2VzdFdo7Wv3kg1HOV+Sy7dQ2bIJ52mV8CnHI1W+ZMEjzQ64m75wH/AGsVb35E0sPJzFNCGj//8/kyKxRR1I0DSDOb+iE48twOrBRrUF5+ApwocqVdIa//Cbe1ArjzrEhwaKY0SitPcFwbVV8XadtsHXfdM5QnFwTsNobk2w+XLt9I5yL/SdE1NVVXBsAN1nejzDo8XTheD6o/m5O29WO3MSS7jt1PCYItVjN4ONK/Ztaa+zQcNK9itMy2tEJ1R/gI+AipOQi0JaHHAjcdYKxDbbJpurJAHvtLvKiJNqNUJPGpqCSfL8YqmDwf3Gs1SntRjgZNeOpAdiHl2qUewcB2vujROmLTQgxJ2HJTK8hKr+2nkZdEMkYYQ/wDtsGYohokU1GOGTjdr5d2vXW8MAWaF5UQDXQzPCT4RGjDLfvod4SM+GHn8t2eDJH8uHvUPU6AXcohM30zw/h9FPf18q7Oo0srwFpc0qjvwDxl9lgilsfaL23K2V5YFeTkO1llxnRdsTmSZ7UMsugBFu5bjGEL4hC/Sml0oH9F8hiV50fXWetsQvNB637Q== Thorsten "mirabilos" Glaser <tg@@MirBSD.org> SIGN' >$T/signkey
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQDAezwU2y/8Wc6rQcqqcAq17khQOijUcUih2SHt2CumxbblbTy0uJq5VFeVdo2Au2ynSlq8/EmsNMh7gMqUOo46F/+wx249Hcr2iUVuhzsDtKrKqcY4+cGA1ytGxnHdot9jl6NDsdyyMXp7dE6SmMhXfb2M7NMtNryQeQmpNytU//dKw8dNYGizIrkHxxQOM1Uhbec7blJBn1GhDmcI6Hfc1QtZBSW9qnpjAE4xAe6RXksXyA72DnxOAJJj0bv5zBCIJSPGUWuHpgkV8JUsezumRV52ejgqkJn6Pa5MGFN3tNGp99meMJlNJTFZ0q0mRrDH/pQQTg40qHjMHUSM/8ilqpkOJ5fkP7DwOCCrPgMj3GvCUXWnW1joI54lKMyaFdiO53QsyqbOjuTB2xBlc/oO8eKKIEP2Woo/WzGyModa7DePdYklWHUYF1AI70dd3SrntzB6UR8itkBsXn+oUWWwixNsbUX1Ud1UtkpNLn34zFBQ6IiFgEO6LinycgYpVJ7yeavt0ti74E6ACuYTHrKVSKm4cGwiqFlxg+gGgrtlDG0n8530XVmtEYcb8m0T/MFf0QW52ZAp6JXqkrDKrJzSfIMSQ85bPOu3ZJ9T8Q56TgdEqMzhIZzpQGrXygfMBA/NpvuAs8mzL9lqYgmDxUj5FSHO7kg3gWgJ9gmtH1yjxxDjezhaJvWiQ2cNnyTSdjM1l7PyeZ1TU08ZefcJ12z63qYwAKL2gfEwsi6gZKqWp3b9i0axyvN3zeQA5AnUujHboeWE47Xy/8OWTcMfhU95/nunc+KSH449HaYNpR22vEtkJRKhoopanlCu1CfyCQV9W/97OqZBHBLlhC8FOdSf1Jg0Yg8aPG77s7XVbfRBC5JTCUCck3Ym/zzcVCmc+4mn8hA+zCzEYNpkfptHvND4oZ9CCkQZuI/YuAqPVqjhmOcYpgTvwVefSVTAy5HqKPkYwoX/EmZwV+jZhSprEJdEg1uinTJxKvVcvHkvNsi/0z+EvOalkGdl+oYKA04rNfq9FGE19iHHa7RwIQxnIc905CBTzH9zBUqWivU11v/sdPklx86oanavt5W7Yaq7Ksirh4GpeVMGS1i51Otml2JihmGeRpuzn+ERpYodRCMopCGkJHZqDjbB6K884EH4GJ3CQWi0OD/1rd84GQZKg++CvJdeO2rzqdYeEJLU/CpQSz7xo8mzGQCa4Pl26df2W/RA/wCnmcOz//dALG30rFHYBt+MEIACXdBz+QQBRQf0ycOjjrFfWMRqFVv9ACEZ16faXiB6t+bLzhvFWgRA+fC/3wa9qmjgF2zISnZ4hsbnQDmfcuJs1WqeYpluYzgGng3MBxEG7L5cz2xwU98XSVEn' >$T/gzsigkey.pub
tempdir=$T; export tempdir

# Check for Interix
if test $isinterix = yes; then
	# We know /bin/ksh is sufficient and we're using it

	# Remove interfering environment variables
	unset INCLUDE LIB

	# Check for nroff
	which nroff >/dev/null 2>&1 || \
	    OVERRIDE_MKSH=/bin/ksh SHELL=/bin/ksh MKSH=/bin/ksh \
	    /bin/ksh $ourpath/infrastructure/install/setup.ksh -i "$@@"
	if ! which nroff >/dev/null 2>&1; then
		echo Cannot install nroff >&2
		exit 1
	fi
	export NROFF=nrcon
fi

# Look if this is a sufficient mksh, search for one
ms=false
for s in /bin/mksh $MKSH $SHELL; do
	# This is from MirMake; it ensures mksh R34 or higher
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(3[4-9]|[4-9][0-9]|[1-9][0-9]+([0-9]))\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then echo yes; else echo no; fi' 2>/dev/null`
	if test x"$t" = x"yes"; then
		ms=$s
		break
	fi
done

# If suitable mksh found, retrieve its version number
if test x"$ms" != x"false"; then
	old=no
	t=`$ms -c 'x=${KSH_VERSION#*KSH?R}; print ${x%% *}'`
	# first check version, then date
	test $t -lt $mksh_ver && old=yes
	if test $t -eq $mksh_ver; then
		# check if date matches
		t=`$ms -c 'print ${KSH_VERSION#*KSH?R+([0-9]) }'`
		# complicated check due to test/mksh brokenness in old MirOS
		test x"$t" \> x"$mksh_date" || old=yes
		test x"$t" = x"$mksh_date" && old=no
	fi

	# If old, check if we can upgrade
	test $old = yes && if test x"$UPGRADE" != x"no"; then
		# But use it as build shell
		SHELL=$ms
		# Fake no suitable mksh found
		ms=false
	fi
fi

# If no suitable mksh found, or too old, build one,
# else jump to the "real" set-up script
if test x"$ms" != x"false"; then
	SHELL=$ms; export SHELL
	MKSH=$ms; export MKSH
	case $# in
	0)	exec $ms $ourpath/infrastructure/install/setup.ksh ;;
	*)	exec $ms $ourpath/infrastructure/install/setup.ksh "$@@" ;;
	esac
	echo Warning: executing old mksh failed >&2
fi

MKSH=${MKSH:-/bin/mksh}; export MKSH
# Check permissions
tpfx=$$$RANDOM
rm -rf $MKSH.$tpfx.1
badp=0
if test -d $MKSH.$tpfx.1; then
	badp=1
else
	mkdir $MKSH.$tpfx.1 2>/dev/null
	test -d $MKSH.$tpfx.1 || badp=1
	rmdir $MKSH.$tpfx.1 2>/dev/null
	test -d $MKSH.$tpfx.1 && badp=1
	(echo test >$MKSH.$tpfx.1) 2>/dev/null
	test -r $MKSH.$tpfx.1 || badp=1
fi
rm -f $MKSH.$tpfx.1
if test $badp = 1; then
	echo 'You need superuser privilegues to continue installation.' >&2
	echo 'Ask your system operator to install a recent mksh (R35+)' >&2
	echo 'or call this script with MKSH=/path/to/mksh (is compiled' >&2
	echo 'if it does not exist, but the path must exist).' >&2
	cd
	rm -rf $T
	exit 1
fi

# Download mksh
what=mksh
#%%BEGIN ^K. sync Setup.sh with setup.ksh %% getfile
. $ourpath/infrastructure/install/distinfo.sh
cd $DISTDIR
test -r $f_dist || case "$mirror" in
/*)	# file
	test -r $mirror/$f_path && cp $mirror/$f_path .
	test -r $mirror/$f_dist && cp $mirror/$f_dist .
	;;
*)	# http
	$fetch $f_dist $mirror$f_path
	;;
esac
sum=unchecked
if s=`md5 $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_md5"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if s=`cksum $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_sum"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if s=`md5sum $f_dist 2>/dev/null`; then
	if test x"$s" = x"$f_md5sum"; then
		sum=good
	else
		sum=bad
	fi
fi
test $sum = bad || if gzsig verify -q $T/$f_key $f_dist 2>/dev/null; then
	echo Note: cryptographically strong checksum verified successfully for $f_dist >&2
	sum=verygood
fi
if test $sum = unchecked; then
	echo Warning: Cannot check hashes for $f_dist >&2
	echo Please compare the following two lines manually >&2
	echo "$f_lsline" >&2
	echo ": `TZ=UTC /bin/ls -l $f_dist`" >&2
	echo Press RETURN to continue or abort if unsure. >&2
	read s
fi

if test $sum = bad; then
	echo Checksum verification failed >&2
	echo "false: $s" >&2
	cd
	rm -rf $T
	exit 1
fi

# Extract the distfile
if gzip -dc $f_dist | (cd $T && cpio -id); then
	:
else
	echo Build failed >&2
	cd
	rm -rf $T
	exit 1
fi
#%%END sync Setup.sh with setup.ksh %% getfile

# Build mksh
cd $T/mksh
case $SHELL in
*csh) SHELL=/bin/sh ;;
esac
SHELL=${SHELL:-/bin/sh}; export SHELL
$SHELL ./Build.sh || rm -f mksh
if test ! -s mksh; then
	echo Build failed >&2
	cd
	rm -rf $T
	exit 1
fi

# Install mksh
set -e
install -c -s -m 555 mksh $MKSH.$tpfx.1
test ! -s $MKSH || mv $MKSH $MKSH.$tpfx.2 && mv $MKSH.$tpfx.1 $MKSH
set +e
test ! -f $MKSH.$tpfx.2 || mv $MKSH.$tpfx.2 /tmp/deleteme.$$$RANDOM \
    || mv $MKSH.$tpfx.2 /Deleteme.$$$RANDOM

# Install some kind of man page (don't care if it fails)
s=0
if test -s mksh.cat1; then
	install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.0 2>/dev/null \
	    && s=1
fi
test $s = 0 && install -c -m 444 mksh.1 /usr/share/man/man1/mksh.1 2>/dev/null

# Clean up
cd $T
rm -rf mksh

# Jump into final script
SHELL=$MKSH; export SHELL
case $# in
0)	exec $MKSH $ourpath/infrastructure/install/setup.ksh ;;
*)	exec $MKSH $ourpath/infrastructure/install/setup.ksh "$@@" ;;
esac

# This line is never run
echo Could not call mksh on setup.ksh >&2
cd /
rm -rf $T
exit 2
@


1.48
log
@quoting fix
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.47 2014/05/29 18:40:44 tg Exp $
d4 2
a5 2
# Copyright (c) 2005, 2006, 2014
#	Thorsten Glaser <tg@@mirbsd.de>
d200 1
a200 1
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(3[4-9]|[4-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then echo yes; else echo no; fi' 2>/dev/null`
@


1.47
log
@change FETCH_CMD to end with -o (ftp, fetch) or -O (GNU wget)
and use this
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.46 2008/11/08 23:03:29 tg Exp $
d4 1
a4 1
# Copyright (c) 2005, 2006
d99 2
a100 2
ourpath=`dirname $0`
ourpath=`(cd $ourpath && pwd)`
@


1.46
log
@more mass conversions, including ancient eMail addresses
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.45 2008/10/05 16:17:17 tg Exp $
d113 1
a113 1
	    fetch="runwin32 c:/usr/local/wbin/wget.exe"
d115 1
a115 1
	test -f $localbase/bin/wget && fetch=$localbase/bin/wget
d121 1
a121 1
			fetch=$dir/wget
d125 1
a125 1
			fetch=$dir/fetch
d129 1
a129 1
			fetch=$dir/ftp
d279 1
a279 1
	$fetch $mirror$f_path
@


1.45
log
@hmpf, weâ€™d better indeed require an mksh which has realpath builtin,
even though mirmake already didâ€¦
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.44 2008/07/11 11:22:14 tg Exp $
d174 1
a174 1
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAoEAy5akQiuw0znRhMD0djgQ7BiUPahG1QHJb9ZNApd6D5OnV98FO8Ofbfm4CF1Cvwr+IPnyKyPglQnaFgHF3LVynKMYSupKXnd0JrBR79TBmIVImBnIaTPcApRdWZEbMW5IdYhrWFHKlzk4vDxBXdcVE6QfiemWsYqkiuoJvLTLHXq7WUCQ5z7KuQetMnnP2bswV8SZuYy0IvzQRBVJbiTQzBvsHfyZUERLBZvjtPE9jTaLdTOkKvCuhuTzQAMmG8aYFt9S0p1K20eCCgWvJ5vu3ir875yBrtVPl2VzdFdo7Wv3kg1HOV+Sy7dQ2bIJ52mV8CnHI1W+ZMEjzQ64m75wH/AGsVb35E0sPJzFNCGj//8/kyKxRR1I0DSDOb+iE48twOrBRrUF5+ApwocqVdIa//Cbe1ArjzrEhwaKY0SitPcFwbVV8XadtsHXfdM5QnFwTsNobk2w+XLt9I5yL/SdE1NVVXBsAN1nejzDo8XTheD6o/m5O29WO3MSS7jt1PCYItVjN4ONK/Ztaa+zQcNK9itMy2tEJ1R/gI+AipOQi0JaHHAjcdYKxDbbJpurJAHvtLvKiJNqNUJPGpqCSfL8YqmDwf3Gs1SntRjgZNeOpAdiHl2qUewcB2vujROmLTQgxJ2HJTK8hKr+2nkZdEMkYYQ/wDtsGYohokU1GOGTjdr5d2vXW8MAWaF5UQDXQzPCT4RGjDLfvod4SM+GHn8t2eDJH8uHvUPU6AXcohM30zw/h9FPf18q7Oo0srwFpc0qjvwDxl9lgilsfaL23K2V5YFeTkO1llxnRdsTmSZ7UMsugBFu5bjGEL4hC/Sml0oH9F8hiV50fXWetsQvNB637Q== Thorsten "mirabile" Glaser <tg@@MirBSD.org> SIGN' >$T/signkey
@


1.44
log
@bump mksh
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.43 2008/05/03 01:28:58 tg Exp $
d39 2
a40 2
mksh_ver=33
mksh_date=2008/04/11
d260 1
a260 1
	echo 'Ask your system operator to install a recent mksh (R33d)' >&2
@


1.43
log
@require mksh R33d or above
â€£ to the user: due to the bugfixes
â€£ to us: for the features
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.42 2008/05/01 00:52:28 tg Exp $
d199 2
a200 2
	# This is from MirMake; it ensures mksh R33 or higher
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(3[3-9]|[4-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then echo yes; else echo no; fi' 2>/dev/null`
@


1.42
log
@remove the advertising clause from all of my contributions
to the MirPorts Framework
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
d39 2
a40 2
mksh_ver=31
mksh_date=2007/08/19
d199 2
a200 2
	# This is from MirMake; it ensures mksh R31 or higher
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(3[1-9]|[4-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then echo yes; else echo no; fi' 2>/dev/null`
d260 1
a260 1
	echo 'Ask your system operator to install a recent mksh (R33),' >&2
@


1.41
log
@since not only pkg_upgrade but also pkg_add itself (and surely some of
the other package tools) call e.g. pkg_add without the full path, some
OSâ€™s native package tools might come in the way
â†’ prefix $localbase/sbin to the system dirs too, not only $localbase/bin
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.40 2008/03/14 15:40:53 tg Exp $
a12 4
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
@


1.40
log
@bump dependency from mksh R26 to mksh R31
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.39 2008/03/02 15:41:16 tg Exp $
d65 1
a66 1
	p=$localbase/bin
a73 1
	PATH=$p:$localbase/sbin; export PATH
a76 1
	p=$localbase/bin
a85 1
	PATH=$p; export PATH
d99 1
@


1.39
log
@mksh R33 into MirPorts Framework; revamp {,DE}INSTALL scripts
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.38 2007/10/26 22:22:24 tg Exp $
d43 2
a44 2
mksh_ver=26
mksh_date=2005/11/22
d205 2
a206 2
	# This is from MirMake; it ensures mksh R26 or higher
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(2[6-9]|[3-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9])?(\ *) ]]; then echo yes; else echo no; fi' 2>/dev/null`
@


1.38
log
@â€¢ recommend mksh R32
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.37 2007/10/14 18:55:55 tg Exp $
d266 1
a266 1
	echo 'Ask your system operator to install a recent mksh (R32),' >&2
@


1.37
log
@mksh R31d is strongly recommended for its bug fixes
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.36 2007/09/11 14:42:28 tg Exp $
d266 1
a266 1
	echo 'Ask your system operator to install a recent mksh (R31d)' >&2
@


1.36
log
@mksh R31b, finallyâ€¦ took some time to make the distfiles, because Iâ€™m busy IRL
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.35 2007/08/15 22:22:09 tg Exp $
d266 1
a266 1
	echo 'Ask your system operator to install a recent mksh (R31b)' >&2
@


1.35
log
@allow an optional vendor-specific string separated by space from
the upstream mksh version number in these scripts

intended for integration of mksh in, e.g. MidnightBSD, in case
they like to change the code from the original
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.34 2007/07/19 22:40:48 tg Exp $
d266 1
a266 1
	echo 'Ask your system operator to install a recent mksh (R29),' >&2
@


1.34
log
@use pkgsrcÂ® ftp too if found, from replaced via IRC
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.33 2007/03/05 21:34:52 tg Exp $
d206 1
a206 1
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(2[6-9]|[3-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9]) ]]; then echo yes; else echo no; fi' 2>/dev/null`
@


1.33
log
@upgrade to mksh R29
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.32 2006/12/28 00:51:01 tg Exp $
d125 1
a125 1
	for dir in $localbase/bin /usr/{mpkg,local}/bin /bin /usr/bin; do
@


1.32
log
@clean up inherited environment before make'ing setup
@
text
@d2 1
a2 1
# $MirOS: src/share/misc/licence.template,v 1.20 2006/12/11 21:04:56 tg Rel $
d266 1
a266 1
	echo 'Ask your system operator to install a recent mksh (R28),' >&2
@


1.31
log
@mksh R28
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.30 2006/08/23 10:20:40 tg Exp $
d4 2
a5 2
# Copyright (c) 2005
#	Thorsten "mirabile" Glaser <tg@@66h.42h.de>
d7 5
a11 6
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
d13 2
a14 2
# All advertising materials mentioning features or use of this soft-
# ware must display the following acknowledgement:
d17 8
a24 8
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a nontrivial bug.
d29 3
@


1.30
log
@fix for user shell = csh (or tcsh), derived from mksh Build.sh
reported and verified to work by Christian "Hawkeye" Jarczyk, thanks!
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.29 2006/06/25 00:54:19 tg Exp $
d264 1
a264 1
	echo 'Ask your system operator to install a recent mksh (R27),' >&2
@


1.29
log
@change mirror to www.mirbsd.org
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.28 2006/05/27 10:42:18 tg Exp $
d342 3
@


1.28
log
@switch distfile mirror (mksh)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.27 2006/05/26 23:44:14 tg Exp $
d51 1
a51 1
	mirror=http://users.unixforge.de/~tglaser/dist/
@


1.27
log
@mksh R27
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.26 2006/05/26 22:55:54 tg Exp $
d51 1
a51 1
	mirror=http://mirbsd.mirsolutions.de/MirOS/dist/
@


1.26
log
@missed a path, oops
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.25 2006/03/19 21:37:09 tg Exp $
d264 1
a264 1
	echo 'Ask your system operator to install a recent mksh (R26),' >&2
@


1.25
log
@expose new gzsigkey.pub
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.24 2006/03/19 21:34:21 tg Exp $
d179 1
a179 1
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQDAezwU2y/8Wc6rQcqqcAq17khQOijUcUih2SHt2CumxbblbTy0uJq5VFeVdo2Au2ynSlq8/EmsNMh7gMqUOo46F/+wx249Hcr2iUVuhzsDtKrKqcY4+cGA1ytGxnHdot9jl6NDsdyyMXp7dE6SmMhXfb2M7NMtNryQeQmpNytU//dKw8dNYGizIrkHxxQOM1Uhbec7blJBn1GhDmcI6Hfc1QtZBSW9qnpjAE4xAe6RXksXyA72DnxOAJJj0bv5zBCIJSPGUWuHpgkV8JUsezumRV52ejgqkJn6Pa5MGFN3tNGp99meMJlNJTFZ0q0mRrDH/pQQTg40qHjMHUSM/8ilqpkOJ5fkP7DwOCCrPgMj3GvCUXWnW1joI54lKMyaFdiO53QsyqbOjuTB2xBlc/oO8eKKIEP2Woo/WzGyModa7DePdYklWHUYF1AI70dd3SrntzB6UR8itkBsXn+oUWWwixNsbUX1Ud1UtkpNLn34zFBQ6IiFgEO6LinycgYpVJ7yeavt0ti74E6ACuYTHrKVSKm4cGwiqFlxg+gGgrtlDG0n8530XVmtEYcb8m0T/MFf0QW52ZAp6JXqkrDKrJzSfIMSQ85bPOu3ZJ9T8Q56TgdEqMzhIZzpQGrXygfMBA/NpvuAs8mzL9lqYgmDxUj5FSHO7kg3gWgJ9gmtH1yjxxDjezhaJvWiQ2cNnyTSdjM1l7PyeZ1TU08ZefcJ12z63qYwAKL2gfEwsi6gZKqWp3b9i0axyvN3zeQA5AnUujHboeWE47Xy/8OWTcMfhU95/nunc+KSH449HaYNpR22vEtkJRKhoopanlCu1CfyCQV9W/97OqZBHBLlhC8FOdSf1Jg0Yg8aPG77s7XVbfRBC5JTCUCck3Ym/zzcVCmc+4mn8hA+zCzEYNpkfptHvND4oZ9CCkQZuI/YuAqPVqjhmOcYpgTvwVefSVTAy5HqKPkYwoX/EmZwV+jZhSprEJdEg1uinTJxKvVcvHkvNsi/0z+EvOalkGdl+oYKA04rNfq9FGE19iHHa7RwIQxnIc905CBTzH9zBUqWivU11v/sdPklx86oanavt5W7Yaq7Ksirh4GpeVMGS1i51Otml2JihmGeRpuzn+ERpYodRCMopCGkJHZqDjbB6K884EH4GJ3CQWi0OD/1rd84GQZKg++CvJdeO2rzqdYeEJLU/CpQSz7xo8mzGQCa4Pl26df2W/RA/wCnmcOz//dALG30rFHYBt+MEIACXdBz+QQBRQf0ycOjjrFfWMRqFVv9ACEZ16faXiB6t+bLzhvFWgRA+fC/3wa9qmjgF2zISnZ4hsbnQDmfcuJs1WqeYpluYzgGng3MBxEG7L5cz2xwU98XSVEn' >gzsigkey.pub
@


1.24
log
@infrastructure for using multiple keys
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.23 2006/03/19 21:23:15 tg Exp $
d179 1
@


1.23
log
@change website (yes, again...)

this time: www.mirbsd.org (not yet working)
ports are using mirbsd.mirsolutions.de (working again) for now
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.22 2006/02/07 21:36:35 tg Exp $
d307 1
a307 1
test $sum = bad || if gzsig verify -q $T/signkey $f_dist 2>/dev/null; then
@


1.22
log
@add localbase/sbin always to path (on 'normal' systems)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.21 2006/01/13 03:49:23 tg Exp $
d51 1
a51 1
	mirror=http://www.66h.42h.de/MirOS/dist/
@


1.21
log
@* mirbsd.bsdadvocacy.org -> www.66h.42h.de
* mirbsd.mirsolutions.de -> www.66h.42h.de (loses SSL)
* http*/cvs.cgi/ -> cvs.mirbsd.de
* mirsolutions.de -> mirbsd.org

No complete transition yet, but this helps a lot with
the recent and upcoming(!) domain issues.

Please use only http://mirbsd.de/ as mirror redirector
and only http://cvs.mirbsd.de/ as CVSweb redirector.
Please do not use mirbsd.de for anything else save eMail.
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.20 2005/12/18 16:36:25 tg Exp $
d66 1
a66 1
	    /usr/sbin /sbin $localbase/sbin; do
d72 1
a72 1
	PATH=$p; export PATH
@


1.20
log
@Part 2 of the big commit:
* www/vbegin.php: don't output the UTF-8 BOM for now
* ports/Setup.sh: change order in which path is divined [1]
* ports/books/mirex: convert to CVS_DISTF
* ports/comms/ssfe: increase line length limit and history buffer size
* ports/infrastructure/install/setup.sh: sync path order with Setup.sh [1]
* ports/infrastructure/mk/bsd.port.mk: (_PORTPATH) sync default PATH [1]
* ports/infrastructure/mk/bsd.port.mk: (_UPGRADE_FLAGS) new, default to -a
* ports/infrastructure/mk/bsd.port.mk: (_upgrade) use it
* ports/infrastructure/mk/bsd.port.mk: (reupgrade) new target, set to -a -f
* ports/infrastructure/scripts/mkmcz: don't use $LOCALBASE, trust in PATH
* ports/infrastructure/mk/bsd.port.mk: (_CVS_FETCH) use _PORTPATH
* ports/infrastructure/pkgtools/create: treat /usr/info same as /usr/man
* ports/infrastructure/pkgtools/upgrade: fix path to temp +REQUIRED_BY
* ports/www/firesomething: break, suggest Opera-Linux/K-Meleon/Safari
* src/Makefile, src/gcc/Makefile.lang: if build GCJ, check if X11 installed
* src/Makefile, src/gnu/usr.bin/perl/Makefile.bsd-wrapper: defer h2ph
  execution to end of build
* src/distrib/lists: sync with pre-h2ph change
* src/etc/services: add openvpn, from IANA
* src/gcc/Makefile.inc, Makefile.lang: fragment out NO_*= stuff
* src/gcc/libjava/Makefile.bsd-wrapper: DEBUGPROGS is gone
* src/gnu/usr.bin/perl/Makefile.bsd-wrapper: flesh out h2ph, fix perms
* src/lib/libc/time/localtime.c: fix undefined extern
* ports/net/sirc/Makefile: automatically insert version into CTCP VERSION
* ports/net/sirc/dist/PROGRAMMING: document capab hooks
* ports/net/sirc/dist/dsircp: several hours of perl hacking with Club-Mate
  - publish $msgchannel, $talkserver [2]
  - support for CAPAB: publish $has_capab, $capab_cmd, $capab_response;
    add "capab" hook in reply
  - support for CAPAB IDENTIFY-MSG: publish $has_identifymsg; new
    $unverified, $unverified_m; enable automatically if present;
    change <...> [...] -...- to «...» [[...]] ¬...¬
  - /describe nick now looks [*] (or [[*]]) instead of *, /me now looks
    # instead of * if identified, to facilitate this conversion
  - fix abuse of U+0060
  - sort /names [2]
  - fix ^B ^_ ^V [2]
  - remove trailing whitespace on outgoing msgs [2]
  - remove trailing whitespace on incoming msgs
  - fix indentation
  - auto-split overlong lines (partially [2])
  - in NOTICE make nick bold too [2]
  - disable DCC since it crashes
  - beautify CTCP TIME replies
  - add ACCEPT command (for ratbox-ircd, e.g. Freeforge)
* ports/net/sirc/pkg/DESCR: summarise new features

[1] all for the sake of bsiegert@@ wanting to not have to souce a
    SetEnv.sh or SetEnv.csh before building in "default MirPorts"
    (i.e. LOCALBASE=/usr/mpkg SYSCONFDIR=/etc BINOWN=root SUDO=sudo)
[2] adapted from http://co.ordinate.org/sirc/
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.19 2005/12/17 05:46:17 tg Exp $
d51 1
a51 1
	mirror=http://mirbsd.mirsolutions.de/MirOS/dist/
@


1.19
log
@big fat licence update (I left some which are bsiegert@@'s alone though)
also, remove licence boilerplate from some .h files who don't deserve it
and remove and add some advertising clauses because I say so
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.18 2005/12/03 22:01:22 tg Exp $
d65 2
a66 8
	for a in /usr/local/bin $xfbase/bin /usr/X11R6/bin /usr/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin; do
d77 2
a78 8
	for a in /usr/local/bin /opt/gcc.3.3/bin /usr/contrib/bin /bin; do
		case :$p: in
		*:$a:*)	continue ;;
		esac
		test -d $a && p=$p:$a
	done
	p=$p:$localbase/sbin
	for a in /usr/local/sbin /usr/sbin /sbin $xfbase/bin /usr/X11R6/bin; do
@


1.18
log
@update to mksh and mirmake
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.17 2005/11/16 15:29:04 tg Exp $
d18 8
a25 7
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
@


1.17
log
@export DISTDIR is needed...
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.16 2005/11/15 16:46:35 tg Exp $
d40 2
a41 2
mksh_ver=24
mksh_date=2005/08/21
d213 2
a214 2
	# This is from MirMake; it ensures mksh R24 or higher
	t=`$s -c 'let a=1; (( a + 1 )) 2>/dev/null && if [[ $KSH_VERSION = @@(\@@\(#\)MIRBSD KSH R)@@(2[4-9]|[3-9][0-9]|[1-9][0-9][0-9])\ +([0-9])/+([0-9])/+([0-9]) ]]; then echo yes; else echo no; fi' 2>/dev/null`
d274 1
a274 1
	echo 'Ask your system operator to install a recent mksh (R25),' >&2
@


1.16
log
@* honour DISTDIR set in environment prior to /bin/sh Setup.sh
* propagate DISTDIR to SetEnv.make (should be in make.cfg, but
  that file is never overwritten by Setup.sh)
* honour fetch set in environment prior to /bin/sh Setup.sh
* commit first part of a manual page for Setup.sh/setup.ksh
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.15 2005/11/10 20:38:09 tg Exp $
d121 1
@


1.15
log
@* locate wget/fetch/ftp and nrcon in $localbase/bin too
* prefer installed MirPorts wget on Interix over Weihenstephan's
* Build.sh -d is auto-recognised in mksh R25
* redirect mksh man page installation errors to /dev/null
* need MirCpio on Interix too (I think)
* add glue for GNU wget, GNU m4 on Interix
* fix build of MirCksum package
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.14 2005/11/10 13:11:31 tg Exp $
d117 4
a120 1
mkdir -p $ourpath/Distfiles
d123 2
a124 2
fetch=false
if test $isinterix = yes; then
d285 1
a285 1
cd $ourpath/Distfiles
@


1.14
log
@better comment about mksh version
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.13 2005/11/10 13:07:55 tg Exp $
d125 2
d130 1
a130 1
	for dir in /usr/mpkg/bin /usr/local/bin /bin /usr/bin; do
d162 2
d349 1
a349 7
if test -f /usr/lib/libc.dylib; then
	# Darwin
	d=-d
else
	d=
fi
$SHELL ./Build.sh $d || rm -f mksh
d365 1
a365 1
# Install some kind of man page
d368 2
a369 1
	install -c -m 444 mksh.cat1 /usr/share/man/cat1/mksh.0 && s=1
d371 1
a371 1
test $s = 0 && install -c -m 444 mksh.1 /usr/share/man/man1/mksh.1
@


1.13
log
@remove INCLUDE and LIB environment variables on Interix
(these are usually added by command line MS cc versions)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.12 2005/11/08 12:04:42 tg Exp $
d39 1
d266 3
a268 1
	echo 'Ask your system operator to install a recent mksh (R24b)' >&2
@


1.12
log
@commit initial support for Interix, fix some of the other stuff
for the non-root case

I'm testing this ATM, but my univ lectures continue in a few mins
(blame my economy prof! she's a ... <censored />)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.11 2005/10/08 19:44:12 tg Exp $
d186 4
@


1.11
log
@allow also newer mksh versions than the one we install
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.10 2005/09/18 19:42:29 tg Exp $
d156 8
d185 1
a185 1
	# We know /bin/ksh is sufficient
d187 1
a187 1
	test -f /usr/bin/nroff || \
d190 1
a190 1
	if test ! -f /usr/bin/nroff; then
d194 1
@


1.10
log
@* use $RANDOM too, not only $$
* clean up code
* warn less; assume on Interix we can always mv from /bin to / if not /tmp
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.9 2005/09/18 19:36:43 tg Exp $
d39 2
a40 2
#mksh_ver=24 # unused
mksh_date="24 2005/08/21"
d202 10
a211 6
#	t=`$ms -c 'x=${KSH_VERSION#*KSH?R}; print ${x%% *}'`
#	# first check version, then date
#	test $t -lt $mksh_ver && old=yes
	# check if date matches
	t=`$ms -c 'print ${KSH_VERSION#*KSH?R}'`
	test x"$t" != x"$mksh_date" && old=yes
@


1.9
log
@some really cool (I mean it!) shell logic which fixes bsiegert@@s
problem - he didn't have an existing /bin/mksh to begin with, so
the first mv failed due to "set -e", and thus the && mv mksh.tmp
mksh was never executed - there are other ways to fix, but this,
devised almost after I saw the problem (but was too ill to check
for the problem), is a cool one-liner which fits into the system
and the way "we" write Makefiles, too.
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.8 2005/09/13 10:52:35 tg Exp $
d161 1
a161 1
	T=/tmp/mirports.$$.$RANDOM
d232 2
a233 1
rm -rf $MKSH.$$.1
d235 1
a235 1
if test -d $MKSH.$$.1; then
d238 6
a243 6
	mkdir $MKSH.$$.1 2>/dev/null
	test -d $MKSH.$$.1 || badp=1
	rmdir $MKSH.$$.1 2>/dev/null
	test -d $MKSH.$$.1 && badp=1
	(echo test >$MKSH.$$.1) 2>/dev/null
	test -r $MKSH.$$.1 || badp=1
d245 1
a245 1
rm -f $MKSH.$$.1
d341 2
a342 2
install -c -s -m 555 mksh $MKSH.$$.1
test ! -s $MKSH || mv $MKSH $MKSH.$$.2 && mv $MKSH.$$.1 $MKSH
d344 2
a345 6
rm -f $MKSH.$$.2
test -f $MKSH.$$.2 && if mv $MKSH.$$.2 /tmp/deleteme.$$.$RANDOM; then
	echo Do not forget to clean up /tmp/deleteme.$$.\* >&2
else
	echo Warning: remove $MKSH.$$.2 later >&2
fi
@


1.8
log
@add user-definable $MKSH (probably still breaks in some places tho)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.7 2005/09/12 23:25:55 tg Exp $
d341 1
a341 1
mv $MKSH $MKSH.$$.2 && mv $MKSH.$$.1 $MKSH
@


1.7
log
@really sync these two files
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.6 2005/09/12 23:23:49 tg Exp $
d180 1
a180 1
	    OVERRIDE_MKSH=/bin/ksh SHELL=/bin/ksh \
d190 1
a190 1
for s in $SHELL /bin/mksh; do
d210 1
a210 1
	test $old = yes && if test x"$UPGRADE" != "no"; then
d222 1
d230 1
d232 1
a232 1
rm -rf /bin/mksh.$$.1
d234 1
a234 1
if test -d /bin/mksh.$$.1; then
d237 6
a242 6
	mkdir /bin/mksh.$$.1 2>/dev/null
	test -d /bin/mksh.$$.1 || badp=1
	rmdir /bin/mksh.$$.1 2>/dev/null
	test -d /bin/mksh.$$.1 && badp=1
	(echo test >/bin/mksh.$$.1) 2>/dev/null
	test -r /bin/mksh.$$.1 || badp=1
d244 1
a244 1
rm -f /bin/mksh.$$.1
d340 2
a341 2
install -c -s -m 555 mksh /bin/mksh.$$.1
mv /bin/mksh /bin/mksh.$$.2 && mv /bin/mksh.$$.1 /bin/mksh
d343 2
a344 2
rm -f /bin/mksh.$$.2
test -f /bin/mksh.$$.2 && if mv /bin/mksh.$$.2 /tmp/deleteme.$$.$RANDOM; then
d347 1
a347 1
	echo Warning: remove /bin/mksh.$$.2 later >&2
d362 1
a362 1
SHELL=/bin/mksh; export SHELL
d364 2
a365 2
0)	exec /bin/mksh $ourpath/infrastructure/install/setup.ksh ;;
*)	exec /bin/mksh $ourpath/infrastructure/install/setup.ksh "$@@" ;;
@


1.6
log
@* sanitise comments
* remove "mirbsd or exit 1" test marker
* add BEGIN/END markers for code copied between these two files
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.5 2005/09/12 22:17:14 tg Exp $
d253 1
a253 1
#%%BEGIN sync Setup.sh with setup.ksh %% getfile
d308 1
a308 1
# Extract and build mksh
d319 1
@


1.5
log
@* Setup.sh, setup.ksh: be more verbose if gzsig(1) succeeds
* distinfo.sh: Use working mirmake
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.4 2005/09/12 21:46:43 tg Exp $
d60 1
d110 1
d253 1
d317 1
@


1.4
log
@* divine the C compiler (mgcc, gcc, cc)
  XXX should I consider looking into egcc? well, just setenv manually.
* fix the date used for mirmake currentness checks
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.3 2005/09/12 20:41:15 tg Exp $
d285 1
a285 1
	echo Note: cryptographically strong checksum verified successfully >&2
@


1.3
log
@* change wording a bit
* copy "fetch and extract distfile" part to setup.ksh, as function dependdist
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.2 2005/09/12 20:36:31 tg Exp $
d142 12
@


1.2
log
@* Setup.sh: use TZ=UTC for ls
* distinfo.sh: add sums for all other new distfiles of today
  (gzsig'd as all stuff in /MirOS/dist/{jupp,mir}/ except joe-2.8 and mirex-6)
@
text
@d2 1
a2 1
# $MirOS: ports/Setup.sh,v 1.1 2005/09/12 20:15:47 tg Exp $
d281 1
a281 1
	echo Press RETURN to continue >&2
@


1.1
log
@move user-visible part of new installer to PORTSDIR/. where it will
reside later, and outside of development branch in subdirectory;
remove Setup.sh from infrastructure/install. Only change:
| ourpath=`(cd $ourpath/../.. && pwd)`
gets the ../../ removed.

DO NOT USE (yet).
@
text
@d2 1
a2 1
# $MirOS: ports/infrastructure/install/Setup.sh,v 1.14.2.21 2005/09/12 20:13:23 tg Exp $
d280 1
a280 1
	echo ": `/bin/ls -l $f_dist`" >&2
@

