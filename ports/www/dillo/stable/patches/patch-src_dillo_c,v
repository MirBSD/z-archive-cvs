head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2006.06.25.11.12.29;	author bsiegert;	state Exp;
branches;
next	1.3;
commitid	100449E6F112D957FC1;

1.3
date	2006.06.24.18.05.03;	author bsiegert;	state Exp;
branches;
next	1.2;
commitid	100449D7EDE7E6DF2C6;

1.2
date	2005.06.19.17.20.20;	author bsiegert;	state Exp;
branches;
next	1.1;
commitid	652d42b5a94e702a;

1.1
date	2005.03.18.15.59.33;	author tg;	state Exp;
branches
	1.1.7.1;
next	;

1.1.7.1
date	2005.03.18.15.59.33;	author tg;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Do the equivalent of s/mkdir/mkdir -p/ in the check for the dillo home dir.
As we use ".etc/dillo", it can happen on other OSes that the user does not
even have .etc. This causes dillo to segfault.

Copy the code for mkpath() from MirOS' src/bin/mkdir/mkdir.c here and use it.

Found by Thomas "kimnotyze" Roth on FROSCON.
@
text
@$MirOS: ports/www/dillo/stable/patches/patch-src_dillo_c,v 1.3 2006/06/24 18:05:03 bsiegert Exp $
$OpenBSD: patch-src_dillo_c,v 1.5 2004/02/21 01:37:19 couderc Exp $
--- src/dillo.c.orig	Mon Jan  2 19:19:45 2006
+++ src/dillo.c	Sun Jun 25 12:57:41 2006
@@@@ -49,6 +49,7 @@@@
 #include "interface.h"
 #include "dw.h"
 #include "cookies.h"
+#include "debug.h"
 
 
 /*
@@@@ -273,8 +274,8 @@@@ gint main(int argc, char *argv[])
    signal(SIGCHLD, Dillo_sigchld_handler);
 
 
-   /* check that ~/.dillo exists, create it if it doesn't */
-   dir = a_Misc_prepend_user_home(".dillo");
+   /* check that ~/.etc/dillo exists, create it if it doesn't */
+   dir = a_Misc_prepend_user_home(".etc/dillo");
    Dillo_check_home_dir(dir);
    g_free(dir);
 
@@@@ -349,15 +350,58 @@@@ gint main(int argc, char *argv[])
 }
 
 /*
- * Check if '~/.dillo' directory exists.
+ * This is from MirOS src/bin/mkdir/mkdir.c.
+ * mkpath -- create directories.
+ *	path     - path
+ *	mode     - file mode of terminal directory
+ *	dir_mode - file mode of intermediate directories
+ */
+int
+mkpath(char *path, mode_t mode, mode_t dir_mode)
+{
+	struct stat sb;
+	char *slash;
+	int done = 0;
+
+	slash = path;
+
+	while (!done) {
+		slash += strspn(slash, "/");
+		slash += strcspn(slash, "/");
+
+		done = (*slash == '\0');
+		*slash = '\0';
+
+		if (stat(path, &sb)) {
+			if (errno != ENOENT ||
+			    (mkdir(path, done ? mode : dir_mode) &&
+			    errno != EEXIST)) {
+				MSG("%s: %s", path, strerror(errno));
+				return (-1);
+			}
+		} else if (!S_ISDIR(sb.st_mode)) {
+			MSG("%s: %s", path, strerror(ENOTDIR));
+			return (-1);
+		}
+
+		*slash = '/';
+	}
+
+	return (0);
+}
+
+/*
+ * Check if '~/.etc/dillo' directory exists.
  * If not, try to create it.
  */
 static void Dillo_check_home_dir(char *dir)
 {
    struct stat st;
+   mode_t mode;
 
+   mode = (0777 & ~umask(0)) | S_IWUSR | S_IXUSR;
    if ( stat(dir, &st) == -1 ) {
-      if ( errno == ENOENT && mkdir(dir, 0700) < 0 ) {
+      if ( errno == ENOENT && mkpath(dir, 0700, mode) < 0 ) {
          MSG("Dillo: error creating directory %s: %s\n",
              dir, g_strerror(errno));
       } else
@


1.3
log
@Somehow I had these still lying around in my tree. Add the required patches
and bump patchlevel.
@
text
@d1 1
a1 1
$MirOS: ports/www/dillo/stable/patches/patch-src_dillo_c,v 1.2 2005/06/19 17:20:20 bsiegert Exp $
d3 2
a4 2
--- src/dillo.c.orig	Mon Jan  2 18:19:45 2006
+++ src/dillo.c	Mon May 15 17:49:33 2006
d24 1
a24 1
@@@@ -349,7 +350,7 @@@@ gint main(int argc, char *argv[])
d29 41
d74 11
@


1.2
log
@Update dillo to 0.8.5, some bugfixes etc.
@
text
@d1 1
a1 1
$MirOS$
d3 2
a4 2
--- src/dillo.c.orig	2005-05-14 11:16:06.000000000 +0200
+++ src/dillo.c	2005-06-19 18:41:14.000000000 +0200
d13 1
a13 1
@@@@ -271,8 +272,8 @@@@ gint main(int argc, char *argv[])
d24 1
a24 1
@@@@ -347,7 +348,7 @@@@ gint main(int argc, char *argv[])
@


1.1
log
@Initial revision
@
text
@d3 3
a5 3
--- src/dillo.c.orig	2004-06-11 01:22:33.000000000 +0200
+++ src/dillo.c	2004-07-26 17:55:02.000000000 +0200
@@@@ -48,6 +48,7 @@@@
d13 1
a13 1
@@@@ -268,8 +269,8 @@@@ gint main(int argc, char *argv[])
d24 1
a24 1
@@@@ -344,7 +345,7 @@@@ gint main(int argc, char *argv[])
@


1.1.7.1
log
@Import the MirPorts Framework, many files moved or renamed though, no KDE/QT
@
text
@@
