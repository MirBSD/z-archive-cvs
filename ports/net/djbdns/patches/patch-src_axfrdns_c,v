head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2016.08.11.20.19.08;	author tg;	state Exp;
branches;
next	1.3;
commitid	10057ACDDC90C549100;

1.3
date	2016.03.26.17.29.20;	author tg;	state Exp;
branches;
next	1.2;
commitid	10056F6C535787D61F0;

1.2
date	2006.07.27.00.58.16;	author tg;	state Exp;
branches;
next	1.1;
commitid	10044C80EE124197593;

1.1
date	2005.05.14.23.21.02;	author tg;	state Exp;
branches
	1.1.201.1;
next	;
commitid	1e94428687d39445;

1.1.201.1
date	2005.05.14.23.21.02;	author tg;	state Exp;
branches;
next	;
commitid	1e94428687d39445;


desc
@@


1.4
log
@completely re-do Fefe’s find_client_loc refactoring, but do it right instead
@
text
@$MirOS: ports/net/djbdns/patches/patch-src_axfrdns_c,v 1.3 2016/03/26 17:29:20 tg Exp $
--- src/axfrdns.c.orig	Sun Feb 11 21:11:23 2001
+++ src/axfrdns.c	Thu Aug 11 19:43:58 2016
@@@@ -5,6 +5,7 @@@@
 #include "uint32.h"
 #include "uint16.h"
 #include "ip4.h"
+#include "ip6.h"
 #include "tai.h"
 #include "buffer.h"
 #include "timeoutread.h"
@@@@ -21,6 +22,7 @@@@
 #include "scan.h"
 #include "qlog.h"
 #include "response.h"
+#include "clientloc.h"
 
 extern int respond(char *,char *,char *);
 
@@@@ -123,9 +125,8 @@@@ void get(char *buf,unsigned int len)
   }
 }
 
-char ip[4];
+char ip[16];
 unsigned long port;
-char clientloc[2];
 
 struct tai now;
 char data[32767];
@@@@ -234,18 +235,7 @@@@ void doaxfr(char id[2])
   tai_now(&now);
   cdb_init(&c,fdcdb);
 
-  byte_zero(clientloc,2);
-  key[0] = 0;
-  key[1] = '%';
-  byte_copy(key + 2,4,ip);
-  r = cdb_find(&c,key,6);
-  if (!r) r = cdb_find(&c,key,5);
-  if (!r) r = cdb_find(&c,key,4);
-  if (!r) r = cdb_find(&c,key,3);
-  if (!r) r = cdb_find(&c,key,2);
-  if (r == -1) die_cdbread();
-  if (r && (cdb_datalen(&c) == 2))
-    if (cdb_read(&c,clientloc,2,cdb_datapos(&c)) == -1) die_cdbread();
+  if (find_client_loc(ip, &c)) die_cdbread();
 
   cdb_findstart(&c);
   for (;;) {
@@@@ -328,10 +318,10 @@@@ int main()
   axfr = env_get("AXFR");
   
   x = env_get("TCPREMOTEIP");
-  if (x && ip4_scan(x,ip))
+  if (x && ip6_scan(x,ip))
     ;
   else
-    byte_zero(ip,4);
+    byte_zero(ip,16);
 
   x = env_get("TCPREMOTEPORT");
   if (!x) x = "0";
@@@@ -357,7 +347,7 @@@@ int main()
 
     qlog(ip,port,header,zone,qtype," ");
 
-    if (byte_equal(qtype,2,DNS_T_AXFR)) {
+    if (byte_equal(qtype,2,DNS_T_AXFR) || byte_equal(qtype,2,DNS_T_IXFR)) {
       case_lowerb(zone,zonelen);
       fdcdb = open_read("data.cdb");
       if (fdcdb == -1) die_cdbread();
@


1.3
log
@complete overhaul of djbdns port:

• merge t4/t6 flavours back into one binary
  ‣ greatly simplify IPv6 handling, too; drop code for v6-less OSes
• merge v4/v6 dnsroots back into one, update all of them
• improve documentation a bit
• apply two patches from http://www.your.org/dnscache/ (SECURITY):
  ‣ merge identical outgoing requests
  ‣ allow caching SOA responses
• update to Fefe’s djbdns-1.05-test27.diff.bz2
  ‣ fixes recursively resolving hosts behind IPv6-only nameservers;
    spotted by Natureshadow (for Teckids’ Lunatics network) and via
    http://serverfault.com/q/627912/189656 (which I’ll answer RSN)
  ⚠ fix with “one second” CDB validity patch
  ⚠ adapt for OpenBSD-style IPv6
• drop ip6.int. reverse v6 DNS for good
• improve dealing with mixing v4/v6 transport
  ⇒ TODO add IP4SEND/IP6SEND support; currently; if IPSEND is v6
    but we send to a v4 server, we use INADDR_ANY for outgoing,
    as automatic fallback address
@
text
@d1 1
a1 1
$MirOS: ports/net/djbdns/patches/patch-src_axfrdns_c,v 1.2 2006/07/27 00:58:16 tg Exp $
d3 1
a3 1
+++ src/axfrdns.c	Sat Mar 26 17:05:48 2016
d20 1
a20 1
@@@@ -123,7 +125,7 @@@@ void get(char *buf,unsigned int len)
d27 1
a27 1
 char clientloc[2];
d29 3
a31 1
@@@@ -234,18 +236,7 @@@@ void doaxfr(char id[2])
d47 1
a47 1
+  find_client_loc(clientloc, ip, &c);
d51 1
a51 1
@@@@ -328,10 +319,10 @@@@ int main()
d64 1
a64 1
@@@@ -357,7 +348,7 @@@@ int main()
@


1.2
log
@* make zonenotify connect to IPv6 (DNS or numeric) too
* make zonenotify connect to all IPs of the hostname given
* make axfrdns log IPv6 addresses (have to move it though)
  XXX pending making DJB_V6ONLY the default and only case
* put fromhex into common file while here
* centralise licence info for my diffs while here
* bump patchlevel

new zonenotify loosely tested, new axfrdns log format seems okay
thanks gecko2 for providing bind9 backup NS on ipv6
@
text
@d1 1
a1 1
$MirOS: ports/net/djbdns/patches/patch-src_axfrdns_c,v 1.1.201.1 2005/05/14 23:21:02 tg Exp $
d3 2
a4 2
+++ src/axfrdns.c	Wed Jul 26 23:30:05 2006
@@@@ -5,6 +5,9 @@@@
a7 1
+#ifdef DJB_V6ONLY
a8 1
+#endif /* DJB_V6ONLY */
d12 9
a20 1
@@@@ -123,7 +126,11 @@@@ void get(char *buf,unsigned int len)
d24 1
a24 3
+#ifndef DJB_V6ONLY
 char ip[4];
+#else
a25 1
+#endif /* DJB_V6ONLY */
d29 17
a45 25
@@@@ -237,6 +244,7 @@@@ void doaxfr(char id[2])
   byte_zero(clientloc,2);
   key[0] = 0;
   key[1] = '%';
+#ifndef DJB_V6ONLY
   byte_copy(key + 2,4,ip);
   r = cdb_find(&c,key,6);
   if (!r) r = cdb_find(&c,key,5);
@@@@ -246,6 +254,19 @@@@ void doaxfr(char id[2])
   if (r == -1) die_cdbread();
   if (r && (cdb_datalen(&c) == 2))
     if (cdb_read(&c,clientloc,2,cdb_datapos(&c)) == -1) die_cdbread();
+#else
+  if (byte_equal(ip,12,V4mappedprefix)) {
+    byte_copy(key + 2,4,ip+12);
+    r = cdb_find(&c,key,6);
+    if (!r) r = cdb_find(&c,key,5);
+    if (!r) r = cdb_find(&c,key,4);
+    if (!r) r = cdb_find(&c,key,3);
+    if (!r) r = cdb_find(&c,key,2);
+    if (r == -1) die_cdbread();
+    if (r && (cdb_datalen(&c) == 2))
+      if (cdb_read(&c,clientloc,2,cdb_datapos(&c)) == -1) die_cdbread();
+  }
+#endif /* DJB_V6ONLY */
d49 1
a49 1
@@@@ -328,10 +349,17 @@@@ int main()
d53 1
a53 1
+#ifdef DJB_V6ONLY
a54 5
+    ;
+  else
+    byte_zero(ip,16);
+#else
   if (x && ip4_scan(x,ip))
d57 2
a58 2
     byte_zero(ip,4);
+#endif /* DJB_V6ONLY */
d62 1
a62 1
@@@@ -357,7 +385,7 @@@@ int main()
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$MirOS$
d3 70
a72 2
+++ src/axfrdns.c	Sat May 14 22:27:17 2005
@@@@ -357,7 +357,7 @@@@ int main()
@


1.1.201.1
log
@New djbdns port, #ifdef'd, "original" and "no_ipv6" flavours removed
"no_ipv4" non-functional at the moment, will follow later after
redesign using crunchgen(1) and crunchide(1)
@
text
@@
