head	1.3;
access;
symbols;
locks; strict;
comment	@# @;


1.3
date	2016.03.26.17.29.20;	author tg;	state Exp;
branches;
next	1.2;
commitid	10056F6C535787D61F0;

1.2
date	2005.12.14.23.28.31;	author tg;	state Exp;
branches;
next	1.1;
commitid	10043A0AA0E5A220A51;

1.1
date	2005.05.14.23.21.02;	author tg;	state Exp;
branches
	1.1.201.1;
next	;
commitid	1e94428687d39445;

1.1.201.1
date	2005.05.14.23.21.02;	author tg;	state Exp;
branches;
next	;
commitid	1e94428687d39445;


desc
@@


1.3
log
@complete overhaul of djbdns port:

• merge t4/t6 flavours back into one binary
  ‣ greatly simplify IPv6 handling, too; drop code for v6-less OSes
• merge v4/v6 dnsroots back into one, update all of them
• improve documentation a bit
• apply two patches from http://www.your.org/dnscache/ (SECURITY):
  ‣ merge identical outgoing requests
  ‣ allow caching SOA responses
• update to Fefe’s djbdns-1.05-test27.diff.bz2
  ‣ fixes recursively resolving hosts behind IPv6-only nameservers;
    spotted by Natureshadow (for Teckids’ Lunatics network) and via
    http://serverfault.com/q/627912/189656 (which I’ll answer RSN)
  ⚠ fix with “one second” CDB validity patch
  ⚠ adapt for OpenBSD-style IPv6
• drop ip6.int. reverse v6 DNS for good
• improve dealing with mixing v4/v6 transport
  ⇒ TODO add IP4SEND/IP6SEND support; currently; if IPSEND is v6
    but we send to a v4 server, we use INADDR_ANY for outgoing,
    as automatic fallback address
@
text
@$MirOS: ports/net/djbdns/patches/patch-src_dns_rcip_c,v 1.2 2005/12/14 23:28:31 tg Exp $
--- src/dns_rcip.c.orig	Sun Feb 11 21:11:23 2001
+++ src/dns_rcip.c	Sat Mar 26 14:45:36 2016
@@@@ -2,12 +2,13 @@@@
 #include "openreadclose.h"
 #include "byte.h"
 #include "ip4.h"
+#include "ip6.h"
 #include "env.h"
 #include "dns.h"
 
 static stralloc data = {0};
 
-static int init(char ip[64])
+static int init(char ip[256])
 {
   int i;
   int j;
@@@@ -17,13 +18,13 @@@@ static int init(char ip[64])
   x = env_get("DNSCACHEIP");
   if (x)
     while (iplen <= 60) {
-      if (*x == '.')
+      if (*x == ' ' || *x == '\t' || *x == '\n')
 	++x;
       else {
-        i = ip4_scan(x,ip + iplen);
+        i = ip6_scan(x,ip + iplen);
 	if (!i) break;
 	x += i;
-	iplen += 4;
+	iplen += 16;
       }
     }
 
@@@@ -40,10 +41,8 @@@@ static int init(char ip[64])
             while ((data.s[i] == ' ') || (data.s[i] == '\t'))
               ++i;
             if (iplen <= 60)
-              if (ip4_scan(data.s + i,ip + iplen)) {
-		if (byte_equal(ip + iplen,4,"\0\0\0\0"))
-		  byte_copy(ip + iplen,4,"\177\0\0\1");
-                iplen += 4;
+              if (ip6_scan(data.s + i,ip + iplen)) {
+                iplen += 16;
 	      }
           }
           i = j + 1;
@@@@ -52,19 +51,19 @@@@ static int init(char ip[64])
   }
 
   if (!iplen) {
-    byte_copy(ip,4,"\177\0\0\1");
-    iplen = 4;
+    byte_copy(ip,16,"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1");
+    iplen = 16;
   }
-  byte_zero(ip + iplen,64 - iplen);
+  byte_zero(ip + iplen,256 - iplen);
   return 0;
 }
 
 static int ok = 0;
 static unsigned int uses;
 static struct taia deadline;
-static char ip[64]; /* defined if ok */
+static char ip[256]; /* defined if ok */
 
-int dns_resolvconfip(char s[64])
+int dns_resolvconfip(char s[256])
 {
   struct taia now;
 
@@@@ -81,6 +80,6 @@@@ int dns_resolvconfip(char s[64])
   }
 
   --uses;
-  byte_copy(s,64,ip);
+  byte_copy(s,256,ip);
   return 0;
 }
@


1.2
log
@* update to fefe's djbdns-1.05-test23.diff
  with djbdns-1.05-ixfr.diff
* slightly change naming of v6-transport binaries
* consolidate all added source files in a central directory
  so it can be reused by the v6-transport stuff
* integrate the v6 transport binaries
* fix spacing
* sync descriptive texts with reality
* sync European ORSN (v4 and v6) to their root.hint
* sync OpenNIC too
* Open-RSC seeminly ceased to exist recently
* Apply compiler-temporary-filename.patch
  from http://homepages.tesco.net/~J.deBoynePollard/FGA/djbdns-problems.html
* apply dnscache-cname-handling.patch
* apply dnscache-strict-forwardonly.patch w/ IPv6 tweak
* apply dnscacheip-space-separator.patch
* apply tinydns-alias-chain-truncation.patch
* apply tinydns-data-semantic-error.patch
  appropriately for 6 and 3, too
* fix shell code and path to includes
* fix relative paths
* fix names of library and programmes; NOMAN=yes here (t6)
* Add support for the IPv6 transport module to communicate,
  as a client, with IPv4 transport name servers as well.

  WFM
* build it with -Wall -Werror
* honour ${SYSCONFDIR} throughout the port
@
text
@d1 1
a1 1
$MirOS: ports/net/djbdns/patches/patch-src_dns_rcip_c,v 1.1.201.1 2005/05/14 23:21:02 tg Exp $
d3 2
a4 2
+++ src/dns_rcip.c	Tue Dec 13 23:15:33 2005
@@@@ -2,12 +2,19 @@@@
a7 1
+#ifdef DJB_V6ONLY
a8 1
+#endif /* DJB_V6ONLY */
d14 1
a14 3
+#ifndef DJB_V6ONLY
 static int init(char ip[64])
+#else
a15 1
+#endif /* DJB_V6ONLY */
d19 1
a19 1
@@@@ -17,13 +24,21 @@@@ static int init(char ip[64])
d27 1
a27 3
+#ifndef DJB_V6ONLY
         i = ip4_scan(x,ip + iplen);
+#else
a28 1
+#endif /* DJB_V6ONLY */
d31 1
a31 3
+#ifndef DJB_V6ONLY
 	iplen += 4;
+#else
a32 1
+#endif /* DJB_V6ONLY */
d36 1
a36 1
@@@@ -40,10 +55,15 @@@@ static int init(char ip[64])
d40 4
a43 6
+#ifndef DJB_V6ONLY
               if (ip4_scan(data.s + i,ip + iplen)) {
 		if (byte_equal(ip + iplen,4,"\0\0\0\0"))
 		  byte_copy(ip + iplen,4,"\177\0\0\1");
                 iplen += 4;
+#else
a45 1
+#endif /* DJB_V6ONLY */
d49 1
a49 1
@@@@ -52,19 +72,36 @@@@ static int init(char ip[64])
d53 2
a54 4
+#ifndef DJB_V6ONLY
     byte_copy(ip,4,"\177\0\0\1");
     iplen = 4;
+#else
a56 1
+#endif /* DJB_V6ONLY */
d58 1
a58 3
+#ifndef DJB_V6ONLY
   byte_zero(ip + iplen,64 - iplen);
+#else
a59 1
+#endif /* DJB_V6ONLY */
d66 1
a66 3
+#ifndef DJB_V6ONLY
 static char ip[64]; /* defined if ok */
+#else
a67 1
+#endif /* DJB_V6ONLY */
d69 1
a69 3
+#ifndef DJB_V6ONLY
 int dns_resolvconfip(char s[64])
+#else
a70 1
+#endif /* DJB_V6ONLY */
d74 1
a74 1
@@@@ -81,6 +118,10 @@@@ int dns_resolvconfip(char s[64])
d78 1
a78 3
+#ifndef DJB_V6ONLY
   byte_copy(s,64,ip);
+#else
a79 1
+#endif /* DJB_V6ONLY */
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$MirOS$
d3 1
a3 1
+++ src/dns_rcip.c	Sat May 14 22:27:17 2005
d24 6
a29 2
@@@@ -20,10 +27,18 @@@@ static int init(char ip[64])
       if (*x == '.')
@


1.1.201.1
log
@New djbdns port, #ifdef'd, "original" and "no_ipv6" flavours removed
"no_ipv4" non-functional at the moment, will follow later after
redesign using crunchgen(1) and crunchide(1)
@
text
@@
